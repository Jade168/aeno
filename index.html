<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
<title>AENO V3 - Cartoon Empire (Vertical)</title>
<style>
  :root{
    --bg:#eaf7ff;
    --panel:#ffffffee;
    --panel2:#f8fbff;
    --border:#cfe8ff;
    --text:#0f172a;
    --muted:#64748b;
    --accent:#3b82f6;
    --accent2:#22c55e;
    --danger:#ef4444;
    --gold:#f59e0b;
    --aeno:#8b5cf6;
  }
  *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans HK","PingFang HK","Microsoft JhengHei",sans-serif;}
  body{
    margin:0;
    background:linear-gradient(#eaf7ff,#f8fbff);
    overflow:hidden;
    touch-action:none;
  }
  #wrap{
    width:100vw;height:100vh;
    display:flex;justify-content:center;align-items:center;
  }
  #game{
    position:relative;
    width:min(460,100vw);
    height:100vh;
    max-height:980px;
    background:linear-gradient(#eaf7ff,#f7fbff);
    border-left:1px solid #dbeafe;
    border-right:1px solid #dbeafe;
    overflow:hidden;
  }

  canvas{
    width:100%;
    height:100%;
    display:block;
    background:linear-gradient(#eaf7ff,#f7fbff);
  }

  /* TOP BAR */
  #topbar{
    position:absolute;top:0;left:0;right:0;
    padding:10px 10px 8px 10px;
    display:flex;gap:8px;align-items:center;
    z-index:50;
    background:linear-gradient(#ffffffdd,#ffffff00);
    backdrop-filter: blur(6px);
  }
  .chip{
    padding:8px 10px;
    border-radius:14px;
    background:#ffffffdd;
    border:1px solid var(--border);
    font-size:12px;
    color:var(--text);
    box-shadow:0 6px 14px rgba(0,0,0,0.06);
    display:flex;align-items:center;gap:6px;
    user-select:none;
    cursor:pointer;
  }
  .chip b{font-size:12px;}
  .chip .dot{
    width:8px;height:8px;border-radius:999px;background:var(--accent);
  }

  /* MAIN PANEL */
  #panel{
    position:absolute;
    left:10px; right:10px;
    bottom:10px;
    height:52%;
    border-radius:22px;
    background:var(--panel);
    border:1px solid var(--border);
    box-shadow:0 18px 50px rgba(0,0,0,0.12);
    z-index:80;
    overflow:hidden;
    transition: transform .25s ease;
  }
  #panel.min{
    transform: translateY(calc(100% - 64px));
  }

  #panelHeader{
    height:64px;
    padding:10px 12px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    background:linear-gradient(#ffffff,#f1f8ff);
    border-bottom:1px solid #dbeafe;
  }
  #panelTitle{
    display:flex;flex-direction:column;
    gap:2px;
  }
  #panelTitle .t{
    font-weight:900;
    font-size:14px;
    color:var(--text);
    letter-spacing:0.3px;
  }
  #panelTitle .s{
    font-size:11px;color:var(--muted);
  }

  #panelTabs{
    display:flex;gap:6px;flex-wrap:wrap;
    justify-content:flex-end;
  }
  .tab{
    font-size:11px;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid #dbeafe;
    background:#fff;
    color:#0f172a;
    cursor:pointer;
    user-select:none;
  }
  .tab.active{
    background:var(--accent);
    border-color:var(--accent);
    color:white;
    font-weight:700;
  }

  #panelBody{
    height:calc(100% - 64px);
    overflow:auto;
    padding:10px;
    background:linear-gradient(#ffffff,#f8fbff);
  }

  .card{
    background:#ffffff;
    border:1px solid #e2f0ff;
    border-radius:18px;
    padding:12px;
    box-shadow:0 10px 24px rgba(0,0,0,0.06);
    margin-bottom:10px;
  }
  .row{display:flex;gap:8px;flex-wrap:wrap;}
  .btn{
    border:none;
    padding:10px 12px;
    border-radius:14px;
    background:var(--accent);
    color:white;
    font-weight:800;
    cursor:pointer;
    user-select:none;
    box-shadow:0 10px 20px rgba(59,130,246,0.25);
    font-size:12px;
  }
  .btn.gray{
    background:#e2e8f0;color:#0f172a;
    box-shadow:none;
    border:1px solid #cbd5e1;
  }
  .btn.green{
    background:var(--accent2);
    box-shadow:0 10px 20px rgba(34,197,94,0.25);
  }
  .btn.gold{
    background:var(--gold);
    box-shadow:0 10px 20px rgba(245,158,11,0.25);
  }
  .btn.purple{
    background:var(--aeno);
    box-shadow:0 10px 20px rgba(139,92,246,0.25);
  }
  .btn.red{
    background:var(--danger);
    box-shadow:0 10px 20px rgba(239,68,68,0.25);
  }
  .label{
    font-size:12px;color:var(--muted);
    margin-bottom:6px;
  }
  .big{
    font-size:14px;font-weight:900;color:var(--text);
  }
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace;}
  input,select{
    width:100%;
    padding:10px;
    border-radius:14px;
    border:1px solid #dbeafe;
    background:#f8fbff;
    font-size:13px;
  }

  /* AI CHAT FLOAT */
  #chatFloat{
    position:absolute;
    right:12px;
    top:86px;
    width:220px;
    border-radius:18px;
    border:1px solid #dbeafe;
    background:#ffffffdd;
    backdrop-filter: blur(6px);
    box-shadow:0 12px 26px rgba(0,0,0,0.12);
    z-index:70;
    overflow:hidden;
    transition: transform .25s ease;
  }
  #chatFloat.min{
    transform: translateX(170px);
  }
  #chatHeader{
    padding:8px 10px;
    background:linear-gradient(#ffffff,#f1f8ff);
    border-bottom:1px solid #dbeafe;
    display:flex;align-items:center;justify-content:space-between;
    font-weight:900;font-size:12px;color:var(--text);
  }
  #chatBody{
    height:150px;
    overflow:auto;
    padding:8px;
    font-size:12px;
    color:#0f172a;
  }
  .msg{margin-bottom:8px;line-height:1.35;}
  .msg .who{font-weight:900;}
  .msg.ai .who{color:#2563eb;}
  .msg.me .who{color:#16a34a;}
  #chatInputWrap{
    display:flex;gap:6px;padding:8px;border-top:1px solid #dbeafe;
    background:#ffffff;
  }
  #chatInputWrap input{
    flex:1;
    padding:9px;
    border-radius:12px;
    font-size:12px;
  }
  #chatInputWrap button{
    padding:9px 10px;border-radius:12px;border:none;
    background:#2563eb;color:white;font-weight:900;font-size:12px;
  }

  /* SMALL INFO */
  #toast{
    position:absolute;
    left:50%;
    transform:translateX(-50%);
    top:62px;
    background:#0f172acc;
    color:white;
    font-size:12px;
    padding:8px 12px;
    border-radius:999px;
    z-index:200;
    display:none;
  }
</style>
</head>
<body>
<div id="wrap">
  <div id="game">
    <div id="topbar">
      <div class="chip" id="btnTogglePanel"><span class="dot"></span><b>å¸åœ‹é¢æ¿</b></div>
      <div class="chip" id="btnSave"><b>å­˜æª”</b></div>
      <div class="chip" id="btnReset"><b>é‡ç½®</b></div>
    </div>

    <div id="toast"></div>

    <canvas id="cv"></canvas>

    <!-- AI Chat -->
    <div id="chatFloat">
      <div id="chatHeader">
        <span>ğŸ¾ AIåŠ©æ‰‹ - Aenko</span>
        <span style="cursor:pointer;" id="btnChatMin">â–¸</span>
      </div>
      <div id="chatBody"></div>
      <div id="chatInputWrap">
        <input id="chatInput" placeholder="è¼¸å…¥ï¼šå·¡é‚ / æ”¶é›† / å»ºé€  è¾²ç”° / æ›è¡« / è³£å»£å‘Š..." />
        <button id="chatSend">é€å‡º</button>
      </div>
    </div>

    <!-- BIG PANEL -->
    <div id="panel" class="min">
      <div id="panelHeader">
        <div id="panelTitle">
          <div class="t">AENO å¸åœ‹æ§åˆ¶ä¸­å¿ƒ</div>
          <div class="s">è³‡æºãƒ»å»ºè¨­ãƒ»äº¤æ˜“æ‰€ãƒ»ç§‘æŠ€æ¨¹ãƒ»ç¸æ½®ãƒ»å»£å‘Šæ­Œãƒ»æ©Ÿå™¨äººäº‹ä»¶</div>
        </div>
        <div id="panelTabs">
          <div class="tab active" data-tab="home">ç¸½è¦½</div>
          <div class="tab" data-tab="build">å»ºè¨­</div>
          <div class="tab" data-tab="market">äº¤æ˜“æ‰€</div>
          <div class="tab" data-tab="stock">è‚¡å¸‚</div>
          <div class="tab" data-tab="tech">ç§‘æŠ€æ¨¹</div>
          <div class="tab" data-tab="event">äº‹ä»¶</div>
          <div class="tab" data-tab="ads">å»£å‘Š/æ­Œæ›²</div>
          <div class="tab" data-tab="ai">AIæ›è¡«</div>
        </div>
      </div>
      <div id="panelBody"></div>
    </div>
  </div>
</div>

<script>
/* ===========================
   AENO V3 æœ€çµ‚å®Œç¾ç‰ˆ
   âœ… æœ¨å» ç”Ÿç”¢æœ¨æï¼ˆè§£æ±ºæ­»å¾ªç’°ï¼‰
   âœ… AI ä¿‚å¡é€šå°å‹•ç‰©ï¼ˆè²“å’ªï¼‰ï¼Œå””ä¿‚åœ“é»
   âœ… æ›è¡« + è³£å»£å‘Šå‹•ç•«
   =========================== */

/* ---------- Helpers ---------- */
function clamp(v,a,b){return Math.max(a,Math.min(b,v));}
function rand(a,b){return a+Math.random()*(b-a);}
function irand(a,b){return Math.floor(rand(a,b+1));}
function now(){return Date.now();}
function fmt(n){
  if(n>=1e9) return (n/1e9).toFixed(2)+"B";
  if(n>=1e6) return (n/1e6).toFixed(2)+"M";
  if(n>=1e3) return (n/1e3).toFixed(2)+"K";
  return Math.floor(n).toString();
}
function roundRectPath(ctx,x,y,w,h,r){
  r=Math.min(r,w/2,h/2);
  ctx.beginPath();
  ctx.moveTo(x+r,y);
  ctx.lineTo(x+w-r,y);
  ctx.quadraticCurveTo(x+w,y,x+w,y+r);
  ctx.lineTo(x+w,y+h-r);
  ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);
  ctx.lineTo(x+r,y+h);
  ctx.quadraticCurveTo(x,y+h,x,y+h-r);
  ctx.lineTo(x,y+r);
  ctx.quadraticCurveTo(x,y,x+r,y);
  ctx.closePath();
}

/* ---------- Canvas Setup ---------- */
const cv=document.getElementById("cv");
const ctx=cv.getContext("2d");
function resize(){
  const rect=cv.getBoundingClientRect();
  cv.width=Math.floor(rect.width*devicePixelRatio);
  cv.height=Math.floor(rect.height*devicePixelRatio);
  ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
}
window.addEventListener("resize",resize);

/* ---------- ç­‰è§’ç«‹é«”åœ°åœ– ---------- */
const ISO_W=48, ISO_H=24, GRID_W=22, GRID_H=22;
const terrainColor={
  grass:"#b9fbc0", forest:"#4ade80", mountain:"#94a3b8",
  river:"#60a5fa", ore:"#fbbf24", plain:"#dcfce7"
};

// âœ…ã€é‡è¦ã€‘åŠ å›æœ¨å» (lumber)ï¼Œç”Ÿç”¢æœ¨æï¼Œè§£æ±ºæ­»å¾ªç’°
const buildingMeta={
  none:{name:"ç©ºåœ°"},
  farm:{name:"è¾²ç”°",cost:{wood:30,stone:10,gold:60},prod:{food:4}},
  mine:{name:"ç¤¦å ´",cost:{wood:25,stone:35,gold:90},prod:{stone:2,iron:2}},
  lumber:{name:"æœ¨å» ",cost:{wood:10,gold:40},prod:{wood:6}}, // ğŸ‘‰ æœ¨å» ç”¢æœ¨
  factory:{name:"å·¥å» ",cost:{wood:60,stone:60,iron:40,gold:200},prod:{gold:5}},
  wall:{name:"åŸç‰†",cost:{stone:80,gold:120},def:2},
  tower:{name:"å®ˆè¡›å¡”",cost:{wood:40,stone:80,iron:30,gold:160},def:5},
  town:{name:"åŸé®",cost:{wood:120,stone:120,iron:80,gold:600},prod:{gold:12},def:3}
};

/* ---------- Save / Load ---------- */
const SAVE_KEY="AENO_V3_SAVE_1";
function defaultState(){
  const map=[];
  for(let y=0;y<GRID_H;y++){
    const row=[];
    for(let x=0;x<GRID_W;x++){
      const t=genTerrain(x,y);
      row.push({terrain:t,building:"none",level:0});
    }
    map.push(row);
  }
  map[11][11].building="town"; map[11][11].level=1;

  return {
    ver:3, lastTick:now(), camera:{x:0,y:0,zoom:1}, selected:{x:11,y:11},
    resources:{gold:500,aeno:50,wood:120,stone:80,iron:40,food:120},
    territoryRadius:4, map,
    ai:{
      name:"Aenko", x:11,y:11, mood:"ğŸ™‚", mode:"idle", adText:"AENO MUSIC",
      outfit:"default", adMode:false
    },
    robot:{active:false,x:0,y:0,stealTimer:0,adText:"AD"},
    beast:{timer:90,wave:0,active:false},
    market:{prices:{wood:2,stone:3,iron:6,food:1}},
    stock:{planetIndex:0,lines:[]},
    tech:{points:0,unlocked:{farm:true,lumber:true,mine:true,factory:false,wall:false,tower:false}},
    ads:{cooldown:0,playing:false,lastReward:0},
    log:[]
  };
}

function saveGame(){localStorage.setItem(SAVE_KEY, JSON.stringify(state));toast("âœ… å·²å­˜æª”");}
function loadGame(){try{const r=localStorage.getItem(SAVE_KEY);return r?JSON.parse(r):null;}catch(e){return null;}}
function resetGame(){localStorage.removeItem(SAVE_KEY);state=defaultState();toast("âš ï¸ å·²é‡ç½®ä¸–ç•Œ");}

/* ---------- Terrain ---------- */
function genTerrain(x,y){
  const dx=x-11,dy=y-11,d=Math.hypot(dx,dy);
  if(Math.abs(x*0.8+y*0.3-14)<1.2)return"river";
  if(d>9&&Math.random()<0.55)return"mountain";
  if(d>5&&d<9&&Math.random()<0.45)return"forest";
  if(Math.random()<0.08)return"ore";
  if(Math.random()<0.25)return"plain";
  return"grass";
}

let state=loadGame()||defaultState();

/* ---------- UI ---------- */
const panel=document.getElementById("panel");
const panelBody=document.getElementById("panelBody");
const btnTogglePanel=document.getElementById("btnTogglePanel");
const btnSave=document.getElementById("btnSave");
const btnReset=document.getElementById("btnReset");
const chatFloat=document.getElementById("chatFloat");
const chatBody=document.getElementById("chatBody");
const chatInput=document.getElementById("chatInput");
const chatSend=document.getElementById("chatSend");
const btnChatMin=document.getElementById("btnChatMin");
const toastBox=document.getElementById("toast");

function toast(t){
  toastBox.innerText=t;toastBox.style.display="block";
  clearTimeout(toastBox._t);toastBox._t=setTimeout(()=>toastBox.style.display="none",1200);
}

btnTogglePanel.onclick=()=>panel.classList.toggle("min");
btnSave.onclick=saveGame;
btnReset.onclick=()=>confirm("ç¢ºå®šé‡ç½®ï¼Ÿ")&&resetGame();
btnChatMin.onclick=()=>{chatFloat.classList.toggle("min");btnChatMin.innerText=chatFloat.classList.contains("min")?"â—‚":"â–¸";};

function pushLog(m){state.log.unshift({t:now(),msg:m});state.log=state.log.slice(0,50);}
function isInsideTerritory(x,y){const dx=x-11,dy=y-11;return dx*dx+dy*dy<=state.territoryRadius**2;}

/* ---------- ç¶“æ¿Ÿ & å»ºè¨­ ---------- */
function canAfford(c){if(!c)return 1;for(let k in c)if((state.resources[k]||0)<c[k])return 0;return 1;}
function pay(c){for(let k in c){state.resources[k]-=c[k];if(state.resources[k]<0)state.resources[k]=0;}}
function tryPayWithGoldOrAeno(n){
  if(state.resources.gold>=n){state.resources.gold-=n;return 1;}
  const a=Math.ceil((n-state.resources.gold)/100);
  if(state.resources.aeno>=a){state.resources.gold=0;state.resources.aeno-=a;return 1;}
  return 0;
}

function placeBuilding(t){
  const {x,y}=state.selected;
  if(!isInsideTerritory(x,y))return toast("âš ï¸ å””ä¿‚é ˜åœŸ");
  if(state.map[y][x].building!=="none")return toast("âš ï¸ æœ‰å»ºç¯‰");
  const m=buildingMeta[t];
  if(!m||!canAfford(m.cost))return toast("âš ï¸ è³‡æºä¸è¶³");
  pay(m.cost);state.map[y][x].building=t;state.map[y][x].level=1;
  pushLog(`èµ·å’— ${m.name}`);toast("ğŸ— èµ·å¥½å’—");
}

function upgradeBuilding(){
  const {x,y}=state.selected;const t=state.map[y][x];
  if(t.building==="none"||t.level>=5)return toast(t.level>=5?"æ»¿ç´š":"å†‡å»ºç¯‰");
  const m=buildingMeta[t.building];const c={};
  for(let k in m.cost)c[k]=Math.ceil(m.cost[k]*(0.65+t.level*0.45));
  if(!canAfford(c))return toast("è³‡æºä¸è¶³");
  pay(c);t.level++;toast("â¬†ï¸ å‡ç´šå’—");
}

function demolishBuilding(){const {x,y}=state.selected;state.map[y][x].building="none";state.map[y][x].level=0;toast("ğŸ§¹ æ‹†å’—");}
function expandTerritory(){const r=state.territoryRadius;if(tryPayWithGoldOrAeno(Math.floor(200+r*r*120))){state.territoryRadius++;toast("ğŸŒ æ“´å¼µå’—");}}

/* ---------- äº¤æ˜“æ‰€ & è‚¡å¸‚ ---------- */
function marketBuy(r,n){n=Math.max(1,~~n);const p=state.market.prices[r]||1;if(state.resources.gold>=n*p){state.resources.gold-=n*p;state.resources[r]+=n;toast("ğŸ›’ è²·å’—");}}
function marketSell(r,n){n=Math.max(1,~~n);if(state.resources[r]>=n){state.resources[r]-=n;state.resources.gold+=Math.floor(n*state.market.prices[r]*0.85);toast("ğŸ’° è³£å’—");}}
function tickStock(){
  if(!state.stock.lines.length)for(let i=0;i<30;i++)state.stock.lines.push({...state.market.prices});
  const l=state.stock.lines.at(-1);const n={...l};
  for(let k of["wood","stone","iron","food"]){n[k]=clamp(n[k]+rand(-0.6,0.6),0.5,30);state.market.prices[k]=n[k];}
  state.stock.lines.push(n);state.stock.lines=state.stock.lines.slice(-60);
}

/* ---------- ç§‘æŠ€ ---------- */
function gainTechPoints(n){state.tech.points+=n;}
function unlockTech(n,c){if(state.tech.points>=c){state.tech.points-=c;state.tech.unlocked[n]=true;toast("ğŸ§  è§£é–å’—");}}

/* ---------- å»£å‘Š ---------- */
function playAdSong(){
  if(state.ads.cooldown>0)return toast("å†·å»ä¸­");
  state.ads.playing=1;state.ads.cooldown=45;toast("ğŸµ æ’­ç·Šæ­Œ");
  setTimeout(()=>{state.ads.playing=0;const r=irand(60,140);state.resources.gold+=r;toast(`ğŸ +${r}é‡‘`);},2500);
}

/* ---------- æ©Ÿå™¨äºº ---------- */
function spawnRobot(){state.robot.active=1;state.robot.x=irand(0,GRID_W-1);state.robot.y=irand(0,GRID_H-1);state.robot.stealTimer=15;toast("ğŸ¤– æ©Ÿå™¨äººï¼");}
function robotSteal(){
  let def=0;state.map.forEach(r=>r.forEach(t=>{def+=t.building==="wall"?0.3*t.level:t.building==="tower"?0.6*t.level:0;}));
  const s=clamp(0.2-def*0.01,0.05,0.2);
  ["wood","stone","iron","food","gold"].forEach(k=>state.resources[k]*=1-s);
  toast(`ğŸ’€ å·å’—${~~(s*100)}%`);state.robot.active=0;
}

/* ---------- ç¸æ½® ---------- */
function spawnBeastWave(){state.beast.active=1;state.beast.wave++;toast("ğŸº ç¸æ½®ï¼");}
function resolveBeast(){
  let def=0;
  state.map.forEach(row=>row.forEach(t=>{
    if(t.building==="wall")def+=0.5*t.level;
    if(t.building==="tower")def+=1.0*t.level;
    if(t.building==="town")def+=2.0*t.level;
  }));
  const pow=state.beast.wave*8;
  if(def>=pow){gainTechPoints(irand(1,3));toast("ğŸ›¡ æ“‹ä½å’—ï¼");}
  else{["wood","stone","iron","food","gold"].forEach(k=>state.resources[k]*=0.8);toast("âš ï¸ æå¤±è³‡æº");}
  state.beast.active=0;state.beast.timer=60+state.beast.wave*12;
}

/* ---------- âœ… è³‡æºç”Ÿç”¢ï¼ˆæœ¨å» çœŸä¿‚æœƒç”¢æœ¨ï¼‰---------- */
function produceResources(){
  state.map.forEach(r=>r.forEach(t=>{
    const m=buildingMeta[t.building];
    if(m.prod)for(let k in m.prod){
      state.resources[k] += m.prod[k] * (1 + (t.level-1)*0.4);
    }
  }));
}

/* ---------- ç«‹é«”ç¹ªåœ– ---------- */
function drawIsoTile(sx,sy,col){
  ctx.fillStyle=col;ctx.beginPath();
  ctx.moveTo(sx,sy);ctx.lineTo(sx+ISO_W,sy+ISO_H/2);
  ctx.lineTo(sx,sy+ISO_H);ctx.lineTo(sx-ISO_W,sy+ISO_H/2);
  ctx.closePath();ctx.fill();
}

function draw3DTree(sx,sy){
  ctx.fillStyle="#78350f";ctx.fillRect(sx-2,sy-12,4,16);
  ctx.fillStyle="#22c55e";ctx.beginPath();ctx.arc(sx,sy-18,10,0,Math.PI*2);ctx.fill();
  ctx.beginPath();ctx.arc(sx-6,sy-8,8,0,Math.PI*2);ctx.fill();
  ctx.beginPath();ctx.arc(sx+6,sy-8,8,0,Math.PI*2);ctx.fill();
}

// âœ… æœ¨å» ç«‹é«”åœ–
function draw3DLumber(sx,sy,lv){
  ctx.fillStyle="#92400e";ctx.fillRect(sx-10,sy-6-lv*3,20,10+lv*3);
  ctx.fillStyle="#ffffff";ctx.font="8px sans-serif";ctx.textAlign="center";ctx.fillText("æœ¨å» ",sx,sy);
}

// âœ… è¾²ç”°ç«‹é«”åœ–
function draw3DFarm(sx,sy,lv){
  ctx.fillStyle="#d9f99d";ctx.fillRect(sx-10,sy-4,20,8);
  ctx.fillStyle="#16a34a";for(let i=0;i<4;i++)ctx.fillRect(sx-8+i*4,sy-2,2,4);
  ctx.fillStyle="#fff";ctx.font="8px sans-serif";ctx.textAlign="center";ctx.fillText("è¾²ç”°",sx,sy);
}

// âœ…ã€AI ä¿‚å°å‹•ç‰©Â·è²“å’ªÂ·ç«‹é«”åœ–ã€‘å””ä¿‚åœ“é»ï¼
function drawAiko(sx,sy){
  const outfit=state.ai.outfit;
  // é ­
  ctx.fillStyle="#f9d5d1";ctx.beginPath();ctx.arc(sx,sy-16,12,0,Math.PI*2);ctx.fill();
  // è€³ä»”
  ctx.fillStyle=outfit==="default"?"#d1b0a8":outfit==="cute"?"#ffc0d5":outfit==="maid"?"#ffffff":"#82c3ff";
  ctx.beginPath();ctx.moveTo(sx-6,sy-22);ctx.lineTo(sx-4,sy-28);ctx.lineTo(sx-2,sy-22);ctx.fill();
  ctx.beginPath();ctx.moveTo(sx+6,sy-22);ctx.lineTo(sx+4,sy-28);ctx.lineTo(sx+2,sy-22);ctx.fill();
  // çœ¼
  ctx.fillStyle="#000";ctx.beginPath();ctx.arc(sx-3,sy-16,1,0,Math.PI*2);ctx.fill();
  ctx.beginPath();ctx.arc(sx+3,sy-16,1,0,Math.PI*2);ctx.fill();
  // èº«é«”
  ctx.fillStyle=outfit==="default"?"#e2c8c0":outfit==="cute"?"#ffd1e0":outfit==="maid"?"#f8f8f8":"#73b3ff";
  roundRectPath(ctx,sx-6,sy-4,12,16,4);ctx.fill();
  // è³£å»£å‘Šå‹•ä½œ
  if(state.ai.adMode){
    ctx.fillStyle="#ffdd57";ctx.font="7px bold";ctx.textAlign="center";
    ctx.fillText("å»£å‘Š",sx,sy+10);
  }
}

function draw(){
  const w=cv.width/devicePixelRatio,h=cv.height/devicePixelRatio;
  ctx.clearRect(0,0,w,h);
  const ox=w/2,oy=h*0.3;

  for(let y=0;y<GRID_H;y++){
    for(let x=0;x<GRID_W;x++){
      const tile=state.map[y][x];
      const sx=ox+(x-y)*ISO_W;
      const sy=oy+(x+y)*ISO_H/2;
      drawIsoTile(sx,sy,terrainColor[tile.terrain]);
      if(!isInsideTerritory(x,y)){ctx.fillStyle="rgba(0,0,0,0.2)";drawIsoTile(sx,sy,"rgba(0,0,0,0.1)");}
      if(tile.terrain==="forest")draw3DTree(sx,sy-4);

      // ğŸ‘‰ å„ç¨®ç«‹é«”å»ºç¯‰
      if(tile.building==="lumber") draw3DLumber(sx,sy,tile.level);
      if(tile.building==="farm") draw3DFarm(sx,sy,tile.level);
      if(tile.building==="town"){ctx.fillStyle="#94a3b8";ctx.fillRect(sx-14,sy-12,28,12);ctx.fillStyle="#fff";ctx.textAlign="center";ctx.fillText("åŸé®",sx,sy-2);}

      if(x===state.selected.x&&y===state.selected.y){ctx.strokeStyle="#ef4444";ctx.lineWidth=2;drawIsoTile(sx,sy,"#0000");ctx.stroke();}
    }
  }

  // âœ… ç•«å‡ºAIå°å‹•ç‰©
  const asx=ox+(state.ai.x-state.ai.y)*ISO_W;
  const asy=oy+(state.ai.x+state.ai.y)*ISO_H/2 - 16;
  drawAiko(asx,asy);
}

/* ---------- ğŸ€ AI æ›è¡« + è³£å»£å‘Š ---------- */
function changeAIOutfit(o){
  state.ai.outfit=o;
  toast(`ğŸ€ AI æ›å’—ã€${o}ã€‘è¡«ï¼`);
  addMsg("ai",`(æ›å’—è¡«ï½å¯æ„›å—ï¼Ÿ)`);
}

function aiDoAd(){
  state.ai.adMode=true;
  setTimeout(()=>{state.ai.adMode=false;},3000);
  const gain=irand(100,200);
  state.resources.gold+=gain;
  addMsg("ai",`ğŸ§§ æˆ‘å¹«ä½ è³£å»£å‘Šå•¦ï¼è³ºå’— ${gain} é‡‘å¹£ï½`);
  toast(`ğŸ§§ AI è³£å»£å‘Š +${gain} é‡‘å¹£`);
}

/* ---------- AI å°è©± ---------- */
function sendChat(){
  const t=chatInput.value.trim().toLowerCase();
  if(!t)return;addMsg("me",t);chatInput.value="";
  setTimeout(()=>{
    if(t.includes("å·¡é‚")){state.ai.mode="patrol";addMsg("ai","ğŸš¶ æˆ‘å»å·¡å ´å•¦ï½");}
    else if(t.includes("æ”¶é›†")){produceResources();addMsg("ai","âœ… å¹«ä½ æ”¶æ›¬è³‡æºï¼");}
    else if(t.includes("æœ¨å» ")){placeBuilding("lumber");addMsg("ai","ğŸªµ èµ·å’—æœ¨å» ï¼Œæœƒè‡ªå‹•æ•´æœ¨å•¦ï¼");}
    else if(t.includes("è¾²ç”°")){placeBuilding("farm");addMsg("ai","ğŸŒ¾ èµ·å’—è¾²ç”°å•¦ï¼");}
    else if(t.includes("å‡ç´š")){upgradeBuilding();addMsg("ai","â¬†ï¸ å‡ç´šå®Œæˆï½");}
    else if(t.includes("æ›è¡«")){changeAIOutfit(["cute","maid","sport"][irand(0,2)]);}
    else if(t.includes("è³£å»£å‘Š")){aiDoAd();}
    else addMsg("ai","ğŸ¥º æˆ‘è­˜ï¼šå·¡é‚ã€æ”¶é›†ã€èµ·æœ¨å» /è¾²ç”°ã€æ›è¡«ã€è³£å»£å‘Šã—ï¼");
  },500);
}

function addMsg(who,text){
  const d=document.createElement("div");d.className="msg "+who;
  d.innerHTML=`<span class="who">${who==="ai"?"Aenko":"ä¸»äºº"}:</span> ${text}`;
  chatBody.appendChild(d);chatBody.scrollTop=chatBody.scrollHeight;
}

chatSend.onclick=sendChat;
chatInput.onkeydown=e=>e.key==="Enter"&&sendChat();

/* ---------- é»æ“Šåœ°åœ– ---------- */
cv.onclick=e=>{
  const r=cv.getBoundingClientRect();
  const mx=(e.clientX-r.left)/devicePixelRatio;
  const my=(e.clientY-r.top)/devicePixelRatio;
  const ox=cv.width/devicePixelRatio/2;
  const oy=cv.height/devicePixelRatio*0.3;
  const x=Math.round((mx-ox)/ISO_W + (my-oy)/ISO_H);
  const y=Math.round((my-oy)/ISO_H - (mx-ox)/ISO_W);
  if(x>=0&&x<GRID_W&&y>=0&&y<GRID_H){state.selected.x=x;state.selected.y=y;}
};

/* ---------- ä¸»å¾ªç’° ---------- */
let sec=0;
function loop(){
  resize();draw();
  sec+=(now()-state.lastTick)/1000;state.lastTick=now();
  if(sec>=1){sec=0;
    produceResources();tickStock();
    if(state.ads.cooldown>0)state.ads.cooldown--;
    if(!state.beast.active&&--state.beast.timer<=0)spawnBeastWave();
    if(state.robot.active&&--state.robot.stealTimer<=0)robotSteal();
    if(Math.random()<0.005)spawnRobot();
    if(state.ai.mode==="patrol"){state.ai.x=clamp(state.ai.x+irand(-1,1),0,GRID_W-1);state.ai.y=clamp(state.ai.y+irand(-1,1),0,GRID_H-1);}
  }
  requestAnimationFrame(loop);
}

/* ---------- æ¨™ç±¤é  ---------- */
document.querySelectorAll(".tab").forEach(t=>{
  t.onclick=()=>{
    document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
    t.classList.add("active");
    const k=t.dataset.tab;
    if(k==="home")panelBody.innerHTML=`
<div class="card"><div class="label">è³‡æº</div><div class="big">é‡‘${fmt(state.resources.gold)} AENO${fmt(state.resources.aeno)}</div><div class="big">æœ¨${fmt(state.resources.wood)} çŸ³${fmt(state.resources.stone)} éµ${fmt(state.resources.iron)} ç³§${fmt(state.resources.food)}</div></div>
<div class="card"><button class="btn gold" onclick="expandTerritory()">æ“´å¼µé ˜åœŸ</button></div>
<div class="card">${state.beast.active?'<button class="btn red" onclick="resolveBeast()">æ“‹ç¸æ½®</button>':`ç¸æ½®å€’æ•¸ï¼š${state.beast.timer}s`}</div>`;

    else if(k==="build")panelBody.innerHTML=`
<div class="card"><div class="label">èµ·å»ºç¯‰</div>
<button class="btn green" onclick="placeBuilding('lumber')">ğŸªµ æœ¨å» (ç”¢æœ¨)</button>
<button class="btn green" onclick="placeBuilding('farm')">ğŸŒ¾ è¾²ç”°</button>
<button class="btn gray" onclick="placeBuilding('mine')">â›ï¸ ç¤¦å ´</button>
<button class="btn purple" onclick="placeBuilding('factory')">ğŸ­ å·¥å» </button>
<button class="btn" onclick="placeBuilding('wall')">ğŸ§± åŸç‰†</button>
<button class="btn gold" onclick="placeBuilding('tower')">ğŸ—¼ å®ˆè¡›å¡”</button></div>
<div class="card"><button class="btn green" onclick="upgradeBuilding()">å‡ç´š</button><button class="btn red" onclick="demolishBuilding()">æ‹†</button></div>`;

    else if(k==="ai")panelBody.innerHTML=`
<div class="card"><div class="label">AI æ›è¡«</div>
<button class="btn green" onclick="changeAIOutfit('cute')">ç²‰ç´…å¯æ„›è£</button>
<button class="btn purple" onclick="changeAIOutfit('maid')">ç™½è‰²å¥³ä»†è£</button>
<button class="btn gold" onclick="changeAIOutfit('sport')">è—è‰²é‹å‹•è£</button></div>`;

    else panelBody.innerHTML=`<div class="card">é–‹ç™¼ä¸­</div>`;
  };
});

resize();
document.querySelector(".tab.active").onclick();
loop();
</script>
</body>
</html>
