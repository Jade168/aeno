<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

  <title>AENO - Planet Colony</title>

  <!-- å¼·åˆ¶æ›´æ–° (é˜²cache) -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <style>
    :root{
      --bg:#eaf6ff;
      --card:#ffffffcc;
      --stroke:#bfe6ff;
      --shadow:0 14px 30px rgba(0,0,0,.15);
      --round:18px;
      --txt:#0f172a;
      --accent:#38bdf8;
      --accent2:#fbbf24;
      --good:#22c55e;
      --danger:#ef4444;
      --muted:#64748b;
    }

    html,body{
      margin:0;
      padding:0;
      height:100%;
      overflow:hidden;
      background:linear-gradient(#eaf6ff,#f0f9ff);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans TC,Arial;
      color:var(--txt);
      touch-action:none;
    }

    canvas{
      position:absolute;
      left:0;
      top:0;
      width:100vw;
      height:100vh;
      display:block;
      background:linear-gradient(#eaf6ff,#f0f9ff);
    }

    #uiRoot{
      position:absolute;
      inset:0;
      pointer-events:none;
      z-index:50;
    }

    button, input, select{
      pointer-events:auto;
      font-size:14px;
      border:none;
      outline:none;
    }

    .hidden{ display:none !important; }

    /* Boot */
    #bootScreen{
      position:absolute;
      inset:0;
      z-index:9999;
      display:flex;
      justify-content:center;
      align-items:center;
      background:linear-gradient(#dbeafe,#f0f9ff);
    }

    .bootCard{
      width:320px;
      background:var(--card);
      border:2px solid var(--stroke);
      border-radius:26px;
      padding:18px;
      box-shadow:var(--shadow);
      text-align:center;
    }

    .logo{
      font-size:40px;
      font-weight:1000;
      letter-spacing:3px;
      color:#0284c7;
    }

    .bootText{
      margin-top:8px;
      font-size:15px;
      font-weight:900;
    }

    .bootHint{
      margin-top:10px;
      font-size:12px;
      opacity:.75;
    }

    /* Login Screen */
    #loginScreen{
      position:absolute;
      inset:0;
      z-index:9000;
      display:flex;
      justify-content:center;
      align-items:center;
      background:linear-gradient(#dbeafe,#f0f9ff);
    }

    .loginCard{
      width:340px;
      background:var(--card);
      border:2px solid var(--stroke);
      border-radius:26px;
      padding:18px;
      box-shadow:var(--shadow);
      text-align:center;
    }

    .loginTitle{
      font-size:20px;
      font-weight:1000;
      margin-bottom:10px;
      color:#0284c7;
    }

    .loginRow{
      display:flex;
      gap:8px;
      margin-top:10px;
    }

    .loginRow input{
      flex:1;
      padding:12px 12px;
      border-radius:16px;
      border:2px solid var(--stroke);
      background:#fff;
      font-weight:800;
    }

    .loginBtns{
      display:flex;
      gap:10px;
      margin-top:12px;
    }

    .loginBtns button{
      flex:1;
      border-radius:18px;
      padding:12px;
      font-weight:1000;
      cursor:pointer;
      box-shadow:0 8px 16px rgba(0,0,0,.08);
    }

    #btnLogin{ background:var(--accent); color:#fff; }
    #btnGuest{ background:var(--good); color:#fff; }

    .smallHint{
      margin-top:10px;
      font-size:12px;
      opacity:.75;
      line-height:1.4;
    }

    /* Planet select */
    #planetScreen{
      position:absolute;
      inset:0;
      z-index:8500;
      display:flex;
      justify-content:center;
      align-items:center;
      background:linear-gradient(#dbeafe,#f0f9ff);
    }

    .planetCard{
      width:360px;
      max-height:78vh;
      overflow:auto;
      background:var(--card);
      border:2px solid var(--stroke);
      border-radius:26px;
      padding:16px;
      box-shadow:var(--shadow);
    }

    .planetHeader{
      font-weight:1000;
      font-size:16px;
      color:#0284c7;
      margin-bottom:10px;
      text-align:center;
    }

    .planetGrid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:8px;
    }

    .planetBtn{
      border-radius:18px;
      padding:12px 10px;
      font-weight:1000;
      cursor:pointer;
      background:#fff;
      border:2px solid var(--stroke);
    }

    .planetBtn.locked{
      opacity:.45;
      cursor:not-allowed;
    }

    .planetBtn.blackhole{
      background:#0f172a;
      color:#fff;
      border:2px solid #334155;
    }

    /* HUD Top */
    #hudTop{
      position:absolute;
      left:10px;
      top:10px;
      right:10px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      pointer-events:none;
      z-index:70;
    }

    .hudBox{
      pointer-events:auto;
      background:var(--card);
      border:2px solid var(--stroke);
      border-radius:18px;
      padding:8px 10px;
      box-shadow:var(--shadow);
      display:flex;
      flex-direction:column;
      gap:4px;
      max-width:49%;
    }

    .hudRow{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }

    .pill{
      background:#ffffffaa;
      border:1px solid var(--stroke);
      border-radius:999px;
      padding:4px 8px;
      font-weight:900;
      font-size:12px;
      white-space:nowrap;
    }

    /* Assistant (Animal) */
    #assistant{
      position:absolute;
      left:10px;
      bottom:160px;
      width:140px;
      height:170px;
      z-index:80;
      pointer-events:auto;
      user-select:none;
    }

    #assistant .adFlag{
      position:absolute;
      right:-10px;
      top:-10px;
      background:var(--accent2);
      border-radius:14px;
      padding:5px 8px;
      font-weight:1000;
      font-size:12px;
      border:2px solid #fff;
      box-shadow:0 8px 16px rgba(0,0,0,.12);
    }

    #assistantCanvas{
      width:140px;
      height:170px;
      border-radius:20px;
      background:transparent;
    }

    #assistantName{
      position:absolute;
      left:0;
      right:0;
      bottom:-22px;
      text-align:center;
      font-weight:1000;
      font-size:12px;
      color:#0f172a;
      text-shadow:0 1px 0 rgba(255,255,255,.8);
    }

    /* Chat */
    #chatBox{
      position:absolute;
      left:10px;
      bottom:10px;
      width:320px;
      height:230px;
      background:var(--card);
      border:2px solid var(--stroke);
      border-radius:22px;
      box-shadow:var(--shadow);
      display:flex;
      flex-direction:column;
      overflow:hidden;
      z-index:90;
      pointer-events:auto;
    }

    .chatHeader{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:10px 12px;
      background:#dbeafe;
      font-weight:1000;
    }

    #chatClose{
      border-radius:12px;
      padding:6px 10px;
      background:var(--danger);
      color:#fff;
      font-weight:1000;
      cursor:pointer;
    }

    #chatLog{
      flex:1;
      padding:10px;
      overflow:auto;
      font-size:12px;
      line-height:1.5;
      background:#ffffffaa;
    }

    .chatInputRow{
      display:flex;
      gap:6px;
      padding:10px;
      border-top:2px solid var(--stroke);
      background:#ffffffcc;
    }

    #chatInput{
      flex:1;
      border-radius:14px;
      border:2px solid var(--stroke);
      padding:8px 10px;
      font-weight:800;
    }

    #chatSend{
      border-radius:14px;
      padding:8px 12px;
      background:var(--good);
      color:#fff;
      font-weight:1000;
      cursor:pointer;
    }

    /* Main Panel */
    #mainPanel{
      position:absolute;
      right:10px;
      top:90px;
      width:320px;
      height:420px;
      background:var(--card);
      border:2px solid var(--stroke);
      border-radius:22px;
      box-shadow:var(--shadow);
      z-index:85;
      display:flex;
      flex-direction:column;
      overflow:hidden;
      pointer-events:auto;
      touch-action:none;
    }

    #panelHeader{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:10px 12px;
      background:#dbeafe;
      font-weight:1000;
      cursor:grab;
    }

    #panelHeader:active{
      cursor:grabbing;
    }

    .panelBtns{
      display:flex;
      gap:6px;
    }

    #panelMinBtn,#panelHideBtn{
      border-radius:12px;
      padding:6px 10px;
      font-weight:1000;
      cursor:pointer;
    }

    #panelMinBtn{ background:var(--accent); color:#fff; }
    #panelHideBtn{ background:#64748b; color:#fff; }

    #panelBody{
      flex:1;
      overflow:auto;
      padding:10px;
    }

    .grid2{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:8px;
    }

    .statCard{
      background:#ffffffaa;
      border:2px solid var(--stroke);
      border-radius:16px;
      padding:8px 10px;
    }

    .statCard .k{
      font-size:12px;
      font-weight:1000;
      opacity:.75;
    }

    .statCard .v{
      margin-top:3px;
      font-size:15px;
      font-weight:1000;
      color:#0284c7;
    }

    .btnRow{
      display:flex;
      gap:8px;
      margin-top:8px;
    }

    .btnRow button{
      flex:1;
      border-radius:16px;
      padding:10px 8px;
      font-weight:1000;
      cursor:pointer;
      background:var(--accent);
      color:#fff;
    }

    .btnRow button:nth-child(2){
      background:var(--good);
    }

    .buildList{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:8px;
      margin-top:8px;
    }

    .buildBtn{
      border-radius:16px;
      padding:10px 8px;
      font-weight:1000;
      background:var(--accent2);
      cursor:pointer;
    }

    .hint{
      margin-top:8px;
      background:#ffffffaa;
      border:2px dashed #93c5fd;
      border-radius:16px;
      padding:10px;
      font-size:12px;
      line-height:1.4;
    }

    #sysLog{
      margin-top:8px;
      background:#ffffffaa;
      border:2px solid var(--stroke);
      border-radius:16px;
      padding:10px;
      height:120px;
      overflow:auto;
      font-size:11px;
      line-height:1.4;
    }

    #panelRestoreBtn{
      position:absolute;
      right:12px;
      top:90px;
      z-index:86;
      border-radius:18px;
      padding:12px 14px;
      font-weight:1000;
      background:var(--accent);
      color:#fff;
      box-shadow:var(--shadow);
      pointer-events:auto;
      display:none;
    }

    /* Mobile adjustments */
    @media(max-width:420px){
      #mainPanel{
        width:300px;
        height:380px;
      }
      #chatBox{
        width:290px;
      }
    }
  </style>
</head>

<body>
  <canvas id="game"></canvas>

  <!-- Boot -->
  <div id="bootScreen">
    <div class="bootCard">
      <div class="logo">AENO</div>
      <div class="bootText">Loading World Engine...</div>
      <div class="bootHint">é›¢ç·šè¨ˆç®— / æ˜Ÿçƒç”Ÿæˆ / äº¤æ˜“ç³»çµ±æº–å‚™ä¸­</div>
    </div>
  </div>

  <!-- Login -->
  <div id="loginScreen" class="hidden">
    <div class="loginCard">
      <div class="loginTitle">ğŸŒ AENO æ˜Ÿéš›æ®–æ°‘ç³»çµ±</div>
      <div class="smallHint">
        è¨»å†Šå¾Œç©å®¶åªèƒ½é¸æ“‡ä¸€æ¬¡æ˜Ÿçƒã€‚<br>
        ä¹‹å¾Œæ°¸ä¹…é–å®šï¼ˆé»‘æ´å­¤å³¶åªæœ‰ä½ å¯é€²ï¼‰ã€‚
      </div>

      <div class="loginRow">
        <input id="userNameInput" placeholder="è¼¸å…¥ç©å®¶åç¨±" maxlength="18">
      </div>

      <div class="loginBtns">
        <button id="btnLogin">ç™»å…¥ / è¨»å†Š</button>
        <button id="btnGuest">æ¸¸å®¢æ¨¡å¼</button>
      </div>

      <div class="smallHint">
        AENO æŒ–ç¤¦ = æ³¨æ„åŠ› + èªè¨€å­¸ç¿’ + å»£å‘Šæ­Œæ›²ã€‚<br>
        ï¼ˆä¸æ˜¯ç”¨é›»åŠ›ï¼‰
      </div>
    </div>
  </div>

  <!-- Planet Select -->
  <div id="planetScreen" class="hidden">
    <div class="planetCard">
      <div class="planetHeader">ğŸª é¸æ“‡ä½ çš„æ˜Ÿçƒï¼ˆåªèƒ½ä¸€æ¬¡ï¼‰</div>
      <div id="planetGrid" class="planetGrid"></div>
      <div class="smallHint" style="text-align:center;margin-top:10px;">
        ğŸ¤– æ©Ÿå™¨äººå¯éš¨æ©Ÿå» 20 æ˜Ÿçƒæ¢ç´¢è³‡æºã€‚<br>
        ç©å®¶æœ¬äººåªå¯æ°¸ä¹…é§å®ˆä¸€é¡†æ˜Ÿçƒã€‚
      </div>
    </div>
  </div>

  <div id="uiRoot">
    <!-- HUD -->
    <div id="hudTop" class="hidden">
      <div class="hudBox">
        <div class="hudRow">
          <span class="pill">ğŸŒ <span id="planetName">?</span></span>
          <span class="pill">â±ï¸ <span id="gameYear">0</span> å¹´</span>
          <span class="pill">ğŸ‘¥ <span id="popCount">0</span></span>
        </div>
        <div class="hudRow">
          <span class="pill">ğŸª™ é‡‘å¹£: <span id="coins">0</span></span>
          <span class="pill">ğŸŸ¡ AENO: <span id="aeno">0.0000</span></span>
        </div>
      </div>

      <div class="hudBox">
        <div class="hudRow">
          <span class="pill">ğŸªµ æœ¨: <span id="wood">0</span></span>
          <span class="pill">ğŸª¨ çŸ³: <span id="stone">0</span></span>
          <span class="pill">â›ï¸ éµ: <span id="iron">0</span></span>
          <span class="pill">ğŸŒ¾ ç³§: <span id="food">0</span></span>
        </div>
        <div class="hudRow">
          <span class="pill">ğŸ  æˆ¿å±‹: <span id="houseCount">0</span></span>
          <span class="pill">ğŸ¤– æ©Ÿå™¨äºº: <span id="robotCount">0</span></span>
        </div>
      </div>
    </div>

    <!-- Assistant -->
    <div id="assistant" class="hidden">
      <div class="adFlag">AD</div>
      <canvas id="assistantCanvas" width="140" height="170"></canvas>
      <div id="assistantName">AENOåŠ©æ‰‹</div>
    </div>

    <!-- Chat -->
    <div id="chatBox" class="hidden">
      <div class="chatHeader">
        <span>ğŸ¾ AIåŠ©æ‰‹</span>
        <button id="chatClose">æ”¶èµ·</button>
      </div>
      <div id="chatLog"></div>
      <div class="chatInputRow">
        <input id="chatInput" placeholder="è¼¸å…¥æŒ‡ä»¤ï¼šå·¡é‚ / æ”¶é›† / å»ºé€  / å‡ç´š">
        <button id="chatSend">é€å‡º</button>
      </div>
    </div>

    <!-- Panel -->
    <button id="panelRestoreBtn">ğŸ“Œ é¢æ¿</button>

    <div id="mainPanel" class="hidden">
      <div id="panelHeader">
        <span>ğŸ“Œ æ§åˆ¶ä¸­å¿ƒ</span>
        <div class="panelBtns">
          <button id="panelMinBtn">ç¸®å°</button>
          <button id="panelHideBtn">æ”¶èµ·</button>
        </div>
      </div>

      <div id="panelBody">
        <div class="grid2">
          <div class="statCard">
            <div class="k">è‡ªå‹•å»ºé€ </div>
            <div class="v" id="autoState">ON</div>
          </div>
          <div class="statCard">
            <div class="k">é›¢ç·šä¸Šé™</div>
            <div class="v">24h</div>
          </div>
        </div>

        <div class="btnRow">
          <button id="btnAuto">ğŸ¤– è‡ªå‹•</button>
          <button id="btnSave">ğŸ’¾ ä¿å­˜</button>
        </div>

        <div class="btnRow">
          <button id="btnZoomIn">â• Zoom</button>
          <button id="btnZoomOut">â– Zoom</button>
        </div>

        <div class="btnRow">
          <button id="btnAdSong">ğŸµ å»£å‘Šæ­Œ</button>
          <button id="btnLoopSong">ğŸ” Loop: ON</button>
        </div>

        <div class="btnRow">
          <button id="btnPronounce">ğŸ—£ï¸ å­¸å¤–èª</button>
          <button id="btnRobotSend">ğŸš€ æ´¾æ©Ÿå™¨äºº</button>
        </div>

        <div class="hint">
          ğŸ“Œ å»ºç¯‰æ–¹æ³•ï¼šé»ä½ é ˜åœŸå…§ç©ºåœ°ï¼Œæœƒå½ˆå‡ºå»ºç¯‰é¸å–®ã€‚<br>
          ğŸ“Œ å‡ç´šæ–¹æ³•ï¼šé»å»ºç¯‰ç‰©æœ¬èº«ã€‚<br>
          ğŸ“Œ éé ˜åœŸæœƒæœ‰é»‘å½±è¦†è“‹ã€‚<br>
        </div>

        <div style="margin-top:10px;font-weight:1000;">ğŸ—ï¸ å»ºç¯‰</div>
        <div class="buildList">
          <button class="buildBtn" data-build="house">ğŸ  æˆ¿å±‹</button>
          <button class="buildBtn" data-build="lumber">ğŸª“ ä¼æœ¨å ´</button>
          <button class="buildBtn" data-build="farm">ğŸŒ¾ è¾²ç”°</button>
          <button class="buildBtn" data-build="mine">â›ï¸ ç¤¦å ´</button>
        </div>

        <div style="margin-top:10px;font-weight:1000;">âš™ï¸ ç³»çµ±è¨˜éŒ„</div>
        <div id="sysLog"></div>
      </div>
    </div>
  </div>

<script>
(() => {
"use strict";

/* ============================
   ç‰ˆæœ¬è™Ÿï¼ˆæ¯æ¬¡æ›´æ–°æ”¹å‘¢å€‹ï¼‰
============================ */
const GAME_VERSION = "AENO_2026_02_18_V1";

/* ============================
   Canvas Setup
============================ */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

let dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));

function resizeCanvas(){
  canvas.width = Math.floor(window.innerWidth * dpr);
  canvas.height = Math.floor(window.innerHeight * dpr);
  canvas.style.width = window.innerWidth + "px";
  canvas.style.height = window.innerHeight + "px";

  ctx.setTransform(1,0,0,1,0,0);
  ctx.scale(dpr, dpr);
}
window.addEventListener("resize", resizeCanvas);

/* ============================
   UI Elements
============================ */
const bootScreen = document.getElementById("bootScreen");
const loginScreen = document.getElementById("loginScreen");
const planetScreen = document.getElementById("planetScreen");
const planetGrid = document.getElementById("planetGrid");

const hudTop = document.getElementById("hudTop");
const mainPanel = document.getElementById("mainPanel");
const panelRestoreBtn = document.getElementById("panelRestoreBtn");

const panelHeader = document.getElementById("panelHeader");
const panelBody = document.getElementById("panelBody");
const panelMinBtn = document.getElementById("panelMinBtn");
const panelHideBtn = document.getElementById("panelHideBtn");

const assistant = document.getElementById("assistant");
const assistantCanvas = document.getElementById("assistantCanvas");
const petCtx = assistantCanvas.getContext("2d");
const assistantName = document.getElementById("assistantName");

const chatBox = document.getElementById("chatBox");
const chatLog = document.getElementById("chatLog");
const chatClose = document.getElementById("chatClose");
const chatInput = document.getElementById("chatInput");
const chatSend = document.getElementById("chatSend");

const userNameInput = document.getElementById("userNameInput");
const btnLogin = document.getElementById("btnLogin");
const btnGuest = document.getElementById("btnGuest");

const ui = {
  planetName: document.getElementById("planetName"),
  gameYear: document.getElementById("gameYear"),
  popCount: document.getElementById("popCount"),
  coins: document.getElementById("coins"),
  aeno: document.getElementById("aeno"),
  wood: document.getElementById("wood"),
  stone: document.getElementById("stone"),
  iron: document.getElementById("iron"),
  food: document.getElementById("food"),
  houseCount: document.getElementById("houseCount"),
  robotCount: document.getElementById("robotCount"),
  autoState: document.getElementById("autoState"),
  sysLog: document.getElementById("sysLog")
};

const btnAuto = document.getElementById("btnAuto");
const btnSave = document.getElementById("btnSave");
const btnZoomIn = document.getElementById("btnZoomIn");
const btnZoomOut = document.getElementById("btnZoomOut");
const btnAdSong = document.getElementById("btnAdSong");
const btnLoopSong = document.getElementById("btnLoopSong");
const btnPronounce = document.getElementById("btnPronounce");
const btnRobotSend = document.getElementById("btnRobotSend");

/* ============================
   Audio (Ad Songs)
============================ */
let audioUnlocked = false;
let loopSong = true;

const audio = new Audio();
audio.loop = true;
audio.volume = 0.8;

// ä½ å¯ä»¥æ›æˆä½  repo è£¡é¢æ­Œæ›²æª”æ¡ˆ
const AD_SONG_LIST = [
  "assets/music/ad_song_1.mp3",
  "assets/music/ad_song_2.mp3",
  "assets/music/ad_song_3.mp3"
];

function unlockAudio(){
  if(audioUnlocked) return;
  audioUnlocked = true;
  audio.play().then(()=>audio.pause()).catch(()=>{});
}

function playAdSong(){
  unlockAudio();
  const pick = AD_SONG_LIST[Math.floor(Math.random()*AD_SONG_LIST.length)];
  audio.src = pick;
  audio.loop = loopSong;
  audio.play().then(()=>{
    log("ğŸµ æ’­æ”¾å»£å‘Šæ­Œ: " + pick);
    // è½æ­Œæœƒå¢åŠ å°‘é‡AENOæ©Ÿç‡
    rewardAttentionMining(0.02);
  }).catch(()=>{
    log("âš ï¸ ç„¡æ³•æ’­æ”¾éŸ³æ¨‚ï¼ˆæ‰‹æ©Ÿéœ€ç”¨æˆ¶é»æ“Šè§£é–éŸ³è¨Šï¼‰");
  });
}

/* ============================
   Logging
============================ */
function log(msg){
  const t = new Date().toLocaleTimeString();
  ui.sysLog.innerHTML = `<div>â±ï¸ ${t} - ${msg}</div>` + ui.sysLog.innerHTML;
}

/* ============================
   World Config
============================ */
const MAP_W = 90;
const MAP_H = 70;
const TILE = 32;

const PLANETS = [];
for(let i=1;i<=20;i++){
  PLANETS.push({
    id:"P"+i,
    name:"æ˜Ÿçƒ "+i,
    biome:["æ£®æ—","æ²™æ¼ ","é›ªåŸ","ç«å±±","æµ·æ´‹","è‰åŸ"][i%6],
    seed: 10000 + i*999
  });
}
PLANETS.push({
  id:"BH",
  name:"é»‘æ´ Â· å­¤å³¶",
  biome:"é»‘æ´",
  seed: 99999999,
  blackhole:true
});

/* ============================
   Save System
============================ */
const SAVE_KEY_USER = "AENO_USER_V3";
const SAVE_KEY_GAME = "AENO_GAME_V3";

let USER = null;
let GAME = null;

function saveUser(){
  localStorage.setItem(SAVE_KEY_USER, JSON.stringify(USER));
}

function loadUser(){
  try{
    const x = localStorage.getItem(SAVE_KEY_USER);
    if(!x) return null;
    return JSON.parse(x);
  }catch(e){ return null; }
}

function saveGame(){
  if(!GAME) return;
  GAME.lastSave = Date.now();
  localStorage.setItem(SAVE_KEY_GAME, JSON.stringify(GAME));
  log("ğŸ’¾ å·²ä¿å­˜ä¸–ç•Œ");
}

function loadGame(){
  try{
    const x = localStorage.getItem(SAVE_KEY_GAME);
    if(!x) return null;
    return JSON.parse(x);
  }catch(e){ return null; }
}

/* ============================
   Default New Game
============================ */
function createNewGame(){
  return {
    version: GAME_VERSION,
    createdAt: Date.now(),
    lastSave: Date.now(),
    lastTick: Date.now(),

    // time speed: 1 day = 10 years
    // => 1 real second = 10 years / 86400 = 0.00011574 years
    // but for gameplay, we scale faster:
    yearsPerRealSecond: (10 / 86400) * 5,

    planetId: null,
    territoryChosen: false,
    territoryCenter: {x:45,y:35},
    territoryRadius: 7,

    year: 0,

    coins: 2000,
    aeno: 0,

    wood: 800,
    stone: 800,
    iron: 800,
    food: 800,

    population: 4,
    robots: 0,

    autoBuild: true,
    autoPriority: "house",

    buildings: [],

    // map generated after planet selection
    mapSeed: 0,
    map: null,

    // offline system
    offlineAccumulatedSeconds: 0,
    offlineMaxSeconds: 24 * 3600
  };
}

/* ============================
   Offline Progress
============================ */
function applyOfflineProgress(){
  const now = Date.now();
  const last = GAME.lastTick || now;
  let dt = (now - last) / 1000;
  if(dt <= 0) return;

  const allowed = Math.max(0, GAME.offlineMaxSeconds - GAME.offlineAccumulatedSeconds);
  const used = Math.min(dt, allowed);

  if(used > 0){
    simulateTicks(used, false);
    GAME.offlineAccumulatedSeconds += used;
    log("ğŸ•’ é›¢ç·šè¨ˆç®—: +" + Math.floor(used/60) + " åˆ†é˜");
  }

  GAME.lastTick = now;
}

/* ============================
   Map Generation
============================ */
function mulberry32(seed){
  return function(){
    let t = seed += 0x6D2B79F5;
    t = Math.imul(t ^ t >>> 15, t | 1);
    t ^= t + Math.imul(t ^ t >>> 7, t | 61);
    return ((t ^ t >>> 14) >>> 0) / 4294967296;
  };
}

function generateMap(){
  const planet = PLANETS.find(p=>p.id===GAME.planetId);
  const rand = mulberry32(planet.seed + GAME.mapSeed);

  const map = [];
  for(let y=0;y<MAP_H;y++){
    const row = [];
    for(let x=0;x<MAP_W;x++){
      const r = rand();

      let t="grass";
      if(r < 0.08) t="water";
      else if(r < 0.18) t="forest";
      else if(r < 0.23) t="mountain";
      else if(r < 0.27) t="stone";
      else if(r < 0.30) t="iron";
      else if(r < 0.33) t="animal";
      else t="grass";

      if(planet.blackhole){
        // é»‘æ´å­¤å³¶æ›´è’æ¶¼
        if(r < 0.12) t="void";
        else if(r < 0.20) t="water";
        else if(r < 0.28) t="mountain";
        else if(r < 0.34) t="iron";
        else if(r < 0.40) t="stone";
        else t="grass";
      }

      row.push(t);
    }
    map.push(row);
  }
  GAME.map = map;
}

/* ============================
   Territory Check
============================ */
function isInTerritory(x,y){
  const dx = x - GAME.territoryCenter.x;
  const dy = y - GAME.territoryCenter.y;
  const dist = Math.sqrt(dx*dx + dy*dy);
  return dist <= GAME.territoryRadius;
}

/* ============================
   Buildings
============================ */
const BUILD_COST = {
  house: { wood:80, stone:40, coins:200 },
  lumber: { wood:60, stone:30, coins:180 },
  farm: { wood:50, stone:30, coins:150 },
  mine: { wood:80, stone:80, coins:300 }
};

function countBuildings(type){
  return GAME.buildings.filter(b=>b.type===type).length;
}

function placeBuilding(type, tx, ty){
  if(!isInTerritory(tx,ty)){
    log("ğŸš« ä¸æ˜¯é ˜åœŸï¼Œä¸èƒ½å»ºç¯‰");
    return false;
  }

  if(GAME.buildings.some(b=>b.x===tx && b.y===ty)){
    log("ğŸš« æ­¤åœ°å·²æœ‰å»ºç¯‰");
    return false;
  }

  const cost = BUILD_COST[type];
  if(!cost){
    log("ğŸš« æœªçŸ¥å»ºç¯‰");
    return false;
  }

  if(GAME.wood < cost.wood || GAME.stone < cost.stone || GAME.coins < cost.coins){
    log("ğŸš« è³‡æºä¸è¶³ï¼ˆæœ¨/çŸ³/é‡‘å¹£ï¼‰");
    return false;
  }

  GAME.wood -= cost.wood;
  GAME.stone -= cost.stone;
  GAME.coins -= cost.coins;

  GAME.buildings.push({
    id: "B_" + Date.now() + "_" + Math.floor(Math.random()*99999),
    type,
    level: 1,
    x: tx,
    y: ty
  });

  log("ğŸ—ï¸ å»ºé€ å®Œæˆ: " + type + " Lv1");
  return true;
}

function upgradeBuilding(building){
  if(!building) return false;
  const maxLevel = 10;

  if(building.level >= maxLevel){
    log("â¬†ï¸ å·²é”æœ€é«˜ç­‰ç´š Lv" + maxLevel);
    return false;
  }

  // å‡ç´šæˆæœ¬ï¼ˆè¶Šé«˜è¶Šè²´ï¼‰
  const base = BUILD_COST[building.type];
  const mul = 1 + building.level * 0.65;

  const needWood = Math.floor(base.wood * mul);
  const needStone = Math.floor(base.stone * mul);
  const needCoins = Math.floor(base.coins * mul);

  if(GAME.wood < needWood || GAME.stone < needStone || GAME.coins < needCoins){
    log("ğŸš« å‡ç´šè³‡æºä¸è¶³");
    return false;
  }

  GAME.wood -= needWood;
  GAME.stone -= needStone;
  GAME.coins -= needCoins;

  building.level += 1;
  log("â¬†ï¸ å‡ç´šæˆåŠŸ: " + building.type + " Lv" + building.level);
  return true;
}

/* ============================
   Economy / Production
============================ */
function simulateTicks(seconds, online){
  // time flow
  GAME.year += seconds * GAME.yearsPerRealSecond;

  // base production
  let house = countBuildings("house");
  let lumber = countBuildings("lumber");
  let farm = countBuildings("farm");
  let mine = countBuildings("mine");

  // population growth from houses
  if(house > 0){
    const popGrow = (house * 0.002) * seconds;
    GAME.population += popGrow;
  }

  // resources
  GAME.wood += lumber * seconds * 0.6;
  GAME.food += farm * seconds * 0.5;

  // mine produces stone + iron
  GAME.stone += mine * seconds * 0.25;
  GAME.iron += mine * seconds * 0.12;

  // coins from population economy
  GAME.coins += (GAME.population * 0.03) * seconds;

  // small passive aeno (very slow)
  GAME.aeno += (GAME.population * 0.0000003) * seconds;

  // auto build assistant (only if online OR offline allowed)
  if(GAME.autoBuild){
    assistantAutoBuild(seconds);
  }

  // clamp
  GAME.population = Math.max(0, GAME.population);
}

function assistantAutoBuild(seconds){
  // æ¯ 10 ç§’æª¢æŸ¥ä¸€æ¬¡
  if(!assistantAutoBuild._t) assistantAutoBuild._t = 0;
  assistantAutoBuild._t += seconds;
  if(assistantAutoBuild._t < 10) return;
  assistantAutoBuild._t = 0;

  // ä¸æœƒäº‚èµ·ï¼šä¿ç•™é‡‘å¹£æœ€ä½500
  if(GAME.coins < 500) return;

  // é è¨­ç­–ç•¥ï¼šå…ˆç¢ºä¿æœ‰æˆ¿å±‹2é–“
  const houseCount = countBuildings("house");

  let target = GAME.autoPriority || "house";
  if(houseCount < 2) target = "house";

  // æ‰¾é ˜åœŸå…§ç©ºåœ°
  for(let i=0;i<40;i++){
    const tx = GAME.territoryCenter.x + Math.floor((Math.random()*2-1)*GAME.territoryRadius);
    const ty = GAME.territoryCenter.y + Math.floor((Math.random()*2-1)*GAME.territoryRadius);

    if(tx<0||ty<0||tx>=MAP_W||ty>=MAP_H) continue;
    if(!isInTerritory(tx,ty)) continue;
    if(GAME.buildings.some(b=>b.x===tx && b.y===ty)) continue;

    if(placeBuilding(target, tx, ty)){
      break;
    }
  }
}

/* ============================
   Pronunciation Mining
============================ */
const WORDS = [
  { type:"è³‡æº", word:"Wood", zh:"æœ¨æ" },
  { type:"è³‡æº", word:"Stone", zh:"çŸ³é ­" },
  { type:"è³‡æº", word:"Iron", zh:"éµ" },
  { type:"æ¤ç‰©", word:"Oak", zh:"æ©¡æ¨¹" },
  { type:"æ¤ç‰©", word:"Pine", zh:"æ¾æ¨¹" },
  { type:"é‡ç¸", word:"Wolf", zh:"ç‹¼" },
  { type:"é‡ç¸", word:"Bear", zh:"ç†Š" }
];

// ä¿å¯†ç®—æ³•ï¼šä¸ç›´æ¥é¡¯ç¤ºAENOå…¬å¼
function rewardAttentionMining(base){
  // é€™è£¡ç”¨éš±è—æ¬Šé‡ï¼Œä¸æ˜é¡¯é¡¯ç¤º
  const k1 = 0.017;
  const k2 = 0.004;
  const noise = (Math.sin(Date.now()*0.0001)+1)*0.5;

  const reward = base * (k1 + noise*k2);
  GAME.aeno += reward;
}

function doPronunciationMiniGame(){
  const pick = WORDS[Math.floor(Math.random()*WORDS.length)];
  const score = Math.floor(20 + Math.random()*80); // æ¨¡æ“¬è©•åˆ† 20-100

  log("ğŸ—£ï¸ è«‹è·Ÿè®€: " + pick.word + " ("+pick.zh+")");
  log("ğŸ“Š è©•åˆ†: " + score + "%");

  if(score < 40){
    log("âŒ æœªåˆæ ¼ï¼ˆéœ€ â‰¥40%ï¼‰");
    return;
  }

  // ç¢ç‰‡
  const shards = Math.floor(1 + score/20);
  GAME.iron += shards;
  GAME.stone += shards;

  // AENO æ©Ÿç‡æ‰è½
  const chance = score / 100;
  if(Math.random() < chance * 0.18){
    rewardAttentionMining(0.25 + chance*0.3);
    log("ğŸŸ¡ AENO æ‰è½æˆåŠŸï¼ï¼ˆæ³¨æ„åŠ›æŒ–ç¤¦ï¼‰");
  }else{
    log("âœ¨ å¾—åˆ°ç¢ç‰‡ï¼Œä½†æœªæ‰è½ AENO");
  }
}

/* ============================
   Robot Explore
============================ */
function sendRobotExplore(){
  if(GAME.robots <= 0){
    log("ğŸš« ä½ æœªæœ‰æ©Ÿå™¨äºº");
    return;
  }

  const planet = PLANETS[Math.floor(Math.random()*20)];
  const rewardWood = Math.floor(30 + Math.random()*90);
  const rewardStone = Math.floor(20 + Math.random()*80);
  const rewardIron = Math.floor(10 + Math.random()*60);

  GAME.wood += rewardWood;
  GAME.stone += rewardStone;
  GAME.iron += rewardIron;

  log("ğŸš€ æ©Ÿå™¨äººæ¢ç´¢: " + planet.name);
  log("ğŸ“¦ å¸¶å›è³‡æº: æœ¨+"+rewardWood+" çŸ³+"rewardStone+" éµ+"rewardIron);
}

/* ============================
   Drawing (Map)
============================ */
let cameraX = 0;
let cameraY = 0;
let zoom = 0.55;

function worldToScreen(wx, wy){
  return {
    x: wx*zoom + cameraX,
    y: wy*zoom + cameraY
  };
}

function screenToWorld(sx, sy){
  return {
    x: (sx - cameraX) / zoom,
    y: (sy - cameraY) / zoom
  };
}

function drawTile(x,y,type){
  const px = x*TILE;
  const py = y*TILE;

  let color = "#86efac"; // grass
  if(type==="water") color="#60a5fa";
  if(type==="forest") color="#16a34a";
  if(type==="mountain") color="#94a3b8";
  if(type==="stone") color="#cbd5e1";
  if(type==="iron") color="#f97316";
  if(type==="animal") color="#fca5a5";
  if(type==="void") color="#0b1220";

  ctx.fillStyle = color;
  ctx.fillRect(px, py, TILE, TILE);

  // grid border subtle
  ctx.strokeStyle = "rgba(0,0,0,0.06)";
  ctx.strokeRect(px, py, TILE, TILE);

  // non-territory shadow
  if(!isInTerritory(x,y)){
    ctx.fillStyle = "rgba(0,0,0,0.35)";
    ctx.fillRect(px, py, TILE, TILE);
  }
}

function drawBuilding(b){
  const px = b.x*TILE;
  const py = b.y*TILE;

  let c="#fbbf24";
  if(b.type==="house") c="#fde047";
  if(b.type==="lumber") c="#fb7185";
  if(b.type==="farm") c="#4ade80";
  if(b.type==="mine") c="#a78bfa";

  ctx.fillStyle = c;
  ctx.fillRect(px+4, py+4, TILE-8, TILE-8);

  ctx.strokeStyle = "rgba(0,0,0,0.25)";
  ctx.strokeRect(px+4, py+4, TILE-8, TILE-8);

  ctx.fillStyle = "#0f172a";
  ctx.font = "bold 12px system-ui";
  ctx.fillText("Lv"+b.level, px+6, py+16);
}

function drawWorld(){
  if(!GAME || !GAME.map) return;

  ctx.setTransform(1,0,0,1,0,0);
  ctx.scale(dpr, dpr);

  ctx.clearRect(0,0,window.innerWidth,window.innerHeight);

  ctx.save();
  ctx.translate(cameraX, cameraY);
  ctx.scale(zoom, zoom);

  for(let y=0;y<MAP_H;y++){
    for(let x=0;x<MAP_W;x++){
      drawTile(x,y,GAME.map[y][x]);
    }
  }

  GAME.buildings.forEach(drawBuilding);

  ctx.restore();
}

/* ============================
   Assistant Animal Drawing
============================ */
function drawAiPet(){
  petCtx.setTransform(1,0,0,1,0,0);
  petCtx.clearRect(0,0,assistantCanvas.width,assistantCanvas.height);

  // body
  petCtx.fillStyle = "#fbbf24";
  petCtx.beginPath();
  petCtx.ellipse(70, 100, 40, 55, 0, 0, Math.PI*2);
  petCtx.fill();

  // head
  petCtx.fillStyle = "#fde68a";
  petCtx.beginPath();
  petCtx.ellipse(70, 55, 35, 32, 0, 0, Math.PI*2);
  petCtx.fill();

  // ears
  petCtx.fillStyle = "#f59e0b";
  petCtx.beginPath();
  petCtx.moveTo(45, 35);
  petCtx.lineTo(35, 10);
  petCtx.lineTo(55, 25);
  petCtx.fill();

  petCtx.beginPath();
  petCtx.moveTo(95, 35);
  petCtx.lineTo(105, 10);
  petCtx.lineTo(85, 25);
  petCtx.fill();

  // eyes
  petCtx.fillStyle = "#0f172a";
  petCtx.beginPath();
  petCtx.arc(58, 55, 4, 0, Math.PI*2);
  petCtx.arc(82, 55, 4, 0, Math.PI*2);
  petCtx.fill();

  // mouth
  petCtx.strokeStyle = "#0f172a";
  petCtx.lineWidth = 2;
  petCtx.beginPath();
  petCtx.arc(70, 65, 8, 0, Math.PI);
  petCtx.stroke();

  // arms
  petCtx.strokeStyle = "#f59e0b";
  petCtx.lineWidth = 6;
  petCtx.beginPath();
  petCtx.moveTo(40, 100);
  petCtx.lineTo(20, 120);
  petCtx.stroke();

  petCtx.beginPath();
  petCtx.moveTo(100, 100);
  petCtx.lineTo(120, 120);
  petCtx.stroke();

  // legs
  petCtx.strokeStyle = "#f59e0b";
  petCtx.lineWidth = 7;
  petCtx.beginPath();
  petCtx.moveTo(55, 150);
  petCtx.lineTo(50, 168);
  petCtx.stroke();

  petCtx.beginPath();
  petCtx.moveTo(85, 150);
  petCtx.lineTo(90, 168);
  petCtx.stroke();
}

/* ============================
   UI Update
============================ */
function updateUI(){
  if(!GAME) return;
  const planet = PLANETS.find(p=>p.id===GAME.planetId);

  ui.planetName.textContent = planet ? planet.name : "?";
  ui.gameYear.textContent = Math.floor(GAME.year);
  ui.popCount.textContent = Math.floor(GAME.population);

  ui.coins.textContent = Math.floor(GAME.coins);
  ui.aeno.textContent = GAME.aeno.toFixed(4);

  ui.wood.textContent = Math.floor(GAME.wood);
  ui.stone.textContent = Math.floor(GAME.stone);
  ui.iron.textContent = Math.floor(GAME.iron);
  ui.food.textContent = Math.floor(GAME.food);

  ui.houseCount.textContent = countBuildings("house");
  ui.robotCount.textContent = GAME.robots;

  ui.autoState.textContent = GAME.autoBuild ? "ON" : "OFF";
}

/* ============================
   Game Loop
============================ */
let lastTime = performance.now();
function loop(now){
  if(!GAME) return;
  const dt = Math.min(0.05, (now - lastTime)/1000);
  lastTime = now;

  simulateTicks(dt, true);
  drawWorld();
  updateUI();

  requestAnimationFrame(loop);
}

/* ============================
   Input (Map Drag / Zoom)
============================ */
let dragging = false;
let lastTouch = null;

canvas.addEventListener("pointerdown", (e)=>{
  unlockAudio();
  dragging = true;
  lastTouch = {x:e.clientX, y:e.clientY};
});

canvas.addEventListener("pointermove", (e)=>{
  if(!dragging || !lastTouch) return;
  const dx = e.clientX - lastTouch.x;
  const dy = e.clientY - lastTouch.y;
  lastTouch = {x:e.clientX, y:e.clientY};
  cameraX += dx;
  cameraY += dy;
});

canvas.addEventListener("pointerup", (e)=>{
  dragging = false;
  lastTouch = null;
});

canvas.addEventListener("click", (e)=>{
  if(!GAME || !GAME.map) return;

  // é»åœ°åœ–å»ºç¯‰/å‡ç´š
  const w = screenToWorld(e.clientX, e.clientY);
  const tx = Math.floor(w.x / TILE);
  const ty = Math.floor(w.y / TILE);

  if(tx<0||ty<0||tx>=MAP_W||ty>=MAP_H) return;

  // é»å»ºç¯‰ -> å‡ç´š
  const b = GAME.buildings.find(bb=>bb.x===tx && bb.y===ty);
  if(b){
    upgradeBuilding(b);
    return;
  }

  // é»ç©ºåœ° -> å½ˆå‡ºé¸æ“‡ï¼ˆç°¡åŒ–ç‰ˆï¼‰
  if(!isInTerritory(tx,ty)){
    log("ğŸš« ä¸æ˜¯é ˜åœŸï¼Œä¸èƒ½å»ºç¯‰");
    return;
  }

  const type = prompt("å»ºç¯‰é¡å‹: house / lumber / farm / mine");
  if(!type) return;
  placeBuilding(type.trim(), tx, ty);
});

/* ============================
   Panel Drag
============================ */
let panelDrag = false;
let panelStart = null;
panelHeader.addEventListener("pointerdown", (e)=>{
  panelDrag = true;
  panelStart = {
    x: e.clientX,
    y: e.clientY,
    left: mainPanel.offsetLeft,
    top: mainPanel.offsetTop
  };
});

window.addEventListener("pointermove", (e)=>{
  if(!panelDrag || !panelStart) return;
  const dx = e.clientX - panelStart.x;
  const dy = e.clientY - panelStart.y;
  mainPanel.style.left = (panelStart.left + dx) + "px";
  mainPanel.style.top = (panelStart.top + dy) + "px";
  mainPanel.style.right = "auto";
});

window.addEventListener("pointerup", ()=>{
  panelDrag = false;
  panelStart = null;
});

/* ============================
   Buttons
============================ */
btnAuto.onclick = ()=>{
  GAME.autoBuild = !GAME.autoBuild;
  log("ğŸ¤– è‡ªå‹•å»ºé€ : " + (GAME.autoBuild ? "ON" : "OFF"));
};

btnSave.onclick = ()=>{
  saveGame();
};

btnZoomIn.onclick = ()=>{
  zoom = Math.min(1.2, zoom + 0.08);
};

btnZoomOut.onclick = ()=>{
  zoom = Math.max(0.25, zoom - 0.08);
};

btnAdSong.onclick = ()=>{
  playAdSong();
};

btnLoopSong.onclick = ()=>{
  loopSong = !loopSong;
  audio.loop = loopSong;
  btnLoopSong.textContent = "ğŸ” Loop: " + (loopSong ? "ON" : "OFF");
};

btnPronounce.onclick = ()=>{
  doPronunciationMiniGame();
};

btnRobotSend.onclick = ()=>{
  sendRobotExplore();
};

panelHideBtn.onclick = ()=>{
  mainPanel.classList.add("hidden");
  panelRestoreBtn.style.display = "block";
};

panelRestoreBtn.onclick = ()=>{
  mainPanel.classList.remove("hidden");
  panelRestoreBtn.style.display = "none";
};

panelMinBtn.onclick = ()=>{
  if(panelBody.style.display === "none"){
    panelBody.style.display = "block";
    panelMinBtn.textContent = "ç¸®å°";
  }else{
    panelBody.style.display = "none";
    panelMinBtn.textContent = "å±•é–‹";
  }
};

/* ============================
   Chat Toggle
============================ */
assistant.addEventListener("click", ()=>{
  chatBox.classList.toggle("hidden");
});

chatClose.onclick = ()=>{
  chatBox.classList.add("hidden");
};

chatSend.onclick = ()=>{
  const cmd = (chatInput.value || "").trim();
  if(!cmd) return;

  chatLog.innerHTML = `<div><b>ä½ ï¼š</b> ${cmd}</div>` + chatLog.innerHTML;

  if(cmd.includes("å·¡é‚")){
    chatLog.innerHTML = `<div><b>åŠ©æ‰‹ï¼š</b> å·²æ´¾å·¥äººå·¡é‚é ˜åœŸã€‚</div>` + chatLog.innerHTML;
    log("ğŸ›¡ï¸ å·¥äººå·¡é‚é ˜åœŸ");
  }else if(cmd.includes("æ”¶é›†")){
    GAME.wood += 20;
    GAME.stone += 10;
    log("ğŸªµ è‡ªå‹•æ”¶é›†è³‡æºå®Œæˆ");
    chatLog.innerHTML = `<div><b>åŠ©æ‰‹ï¼š</b> å·²æ”¶é›†æœ¨æ+20 çŸ³+10ã€‚</div>` + chatLog.innerHTML;
  }else if(cmd.includes("å»ºé€ ")){
    GAME.autoPriority = "house";
    log("ğŸ—ï¸ AI å„ªå…ˆå»ºé€ ï¼šæˆ¿å±‹");
    chatLog.innerHTML = `<div><b>åŠ©æ‰‹ï¼š</b> å¥½ï¼æˆ‘æœƒå„ªå…ˆå»ºé€ æˆ¿å±‹ã€‚</div>` + chatLog.innerHTML;
  }else if(cmd.includes("å‡ç´š")){
    log("â¬†ï¸ AI å°‡å„ªå…ˆå‡ç´šå»ºç¯‰");
    chatLog.innerHTML = `<div><b>åŠ©æ‰‹ï¼š</b> å¥½ï¼æˆ‘æœƒç›¡é‡å‡ç´šç¾æœ‰å»ºç¯‰ã€‚</div>` + chatLog.innerHTML;
  }else{
    chatLog.innerHTML = `<div><b>åŠ©æ‰‹ï¼š</b> æˆ‘æ”¶åˆ°æŒ‡ä»¤ï¼Œä½†éœ€è¦æ›´æ˜ç¢ºã€‚ï¼ˆå·¡é‚/æ”¶é›†/å»ºé€ /å‡ç´šï¼‰</div>` + chatLog.innerHTML;
  }

  chatInput.value = "";
};

/* ============================
   Planet Selection UI
============================ */
function buildPlanetUI(){
  planetGrid.innerHTML = "";
  PLANETS.forEach(p=>{
    const btn = document.createElement("button");
    btn.className = "planetBtn";
    if(p.blackhole) btn.classList.add("blackhole");

    btn.textContent = (p.blackhole ? "ğŸ•³ï¸ " : "ğŸª ") + p.name + " ("+p.biome+")";

    // ç©å®¶å·²é–å®šæ˜Ÿçƒï¼Œå…¶ä»–ä¸å¯é¸
    if(USER && USER.lockedPlanet && USER.lockedPlanet !== p.id){
      btn.classList.add("locked");
      btn.disabled = true;
    }

    btn.onclick = ()=>{
      if(USER && USER.lockedPlanet && USER.lockedPlanet !== p.id) return;

      if(!USER.lockedPlanet){
        USER.lockedPlanet = p.id;
        saveUser();
      }

      GAME.planetId = p.id;
      GAME.mapSeed = Math.floor(Math.random()*999999);
      generateMap();

      planetScreen.classList.add("hidden");
      startGameUI();
      log("ğŸª ä½ é¸æ“‡äº†æ˜Ÿçƒ: " + p.name);
    };

    planetGrid.appendChild(btn);
  });
}

/* ============================
   Start UI
============================ */
function startGameUI(){
  hudTop.classList.remove("hidden");
  mainPanel.classList.remove("hidden");
  assistant.classList.remove("hidden");
  chatBox.classList.add("hidden");
  drawAiPet();
}

/* ============================
   Login
============================ */
btnLogin.onclick = ()=>{
  const name = (userNameInput.value || "").trim();
  if(!name){
    alert("è«‹è¼¸å…¥ç©å®¶åç¨±");
    return;
  }

  USER = {
    id: "U_" + name,
    name,
    lockedPlanet: null
  };
  saveUser();

  GAME = loadGame();
  if(!GAME){
    GAME = createNewGame();
    GAME.buildings.push({ id:"H1", type:"house", level:1, x:45, y:35 });
    GAME.buildings.push({ id:"H2", type:"house", level:1, x:46, y:35 });
    saveGame();
  }

  loginScreen.classList.add("hidden");
  planetScreen.classList.remove("hidden");
  buildPlanetUI();
};

btnGuest.onclick = ()=>{
  USER = {
    id: "GUEST",
    name: "æ¸¸å®¢",
    lockedPlanet: "P1"
  };
  saveUser();

  GAME = loadGame();
  if(!GAME){
    GAME = createNewGame();
    GAME.planetId = "P1";
    GAME.mapSeed = Math.floor(Math.random()*999999);
    generateMap();
    GAME.buildings.push({ id:"H1", type:"house", level:1, x:45, y:35 });
    GAME.buildings.push({ id:"H2", type:"house", level:1, x:46, y:35 });
    saveGame();
  }

  loginScreen.classList.add("hidden");
  startGameUI();
  requestAnimationFrame(loop);
};

/* ============================
   Boot / Init
============================ */
function init(){
  resizeCanvas();

  bootScreen.classList.remove("hidden");
  loginScreen.classList.add("hidden");
  planetScreen.classList.add("hidden");

  setTimeout(()=>{
    USER = loadUser();
    GAME = loadGame();

    bootScreen.classList.add("hidden");

    // å¦‚æœå·²æœ‰å­˜æª”
    if(USER && GAME && GAME.version){
      // æ›´æ–°ç‰ˆæœ¬åªæ›´æ–° codeï¼Œä¸åˆªå­˜æª”
      GAME.version = GAME_VERSION;
      applyOfflineProgress();
      saveGame();

      // å¦‚æœå·²æœ‰æ˜Ÿçƒ
      if(GAME.planetId){
        if(!GAME.map) generateMap();
        startGameUI();
        requestAnimationFrame(loop);
        log("âœ… å·²è¼‰å…¥å­˜æª”: " + USER.name);
        return;
      }
    }

    // æ²’æœ‰å­˜æª” -> é¡¯ç¤ºç™»å…¥
    loginScreen.classList.remove("hidden");
    log("ğŸ§  ç³»çµ±å•Ÿå‹•å®Œæˆï¼Œç­‰å¾…ç™»å…¥...");
  }, 900);
}

init();

})();
</script>
</body>
</html>
