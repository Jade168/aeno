<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
<title>AENO V3 - Imperial Command</title>
<style>
  :root{
    --bg:#eaf7ff;
    --panel:#ffffffee;
    --panel2:#f8fbff;
    --border:#cfe8ff;
    --text:#0f172a;
    --muted:#64748b;
    --accent:#3b82f6;
    --accent2:#22c55e;
    --danger:#ef4444;
    --gold:#f59e0b;
    --aeno:#8b5cf6;
  }
  *{box-sizing:border-box;font-family:system-ui,-apple-system,sans-serif;}
  body{
    margin:0;
    background:#eaf7ff;
    overflow:hidden;
    touch-action:none;
  }
  #wrap{ width:100vw; height:100vh; display:flex; justify-content:center; align-items:center; }
  #game{
    position:relative;
    width:min(480px,100vw);
    height:100vh;
    background:linear-gradient(#eaf7ff,#f7fbff);
    border-left:1px solid #dbeafe;
    border-right:1px solid #dbeafe;
    overflow:hidden;
  }

  canvas{ width:100%; height:100%; display:block; }

  /* TOP BAR */
  #topbar{
    position:absolute;top:0;left:0;right:0;
    padding:10px; display:flex; gap:8px; z-index:100;
    background:rgba(255,255,255,0.7); backdrop-filter:blur(10px);
  }
  .chip{
    padding:8px 12px; border-radius:12px; background:#fff;
    border:1px solid var(--border); font-size:12px; font-weight:bold;
    cursor:pointer; display:flex; align-items:center; gap:5px;
  }

  /* FLOATING RECALL BUTTONS */
  #recallPanel, #recallChat {
    position:absolute; right:15px; z-index:90;
    width:50px; height:50px; border-radius:25px;
    background:var(--accent); color:white;
    display:none; align-items:center; justify-content:center;
    box-shadow:0 4px 12px rgba(0,0,0,0.2); cursor:pointer; font-weight:bold;
  }
  #recallPanel { bottom:80px; background:var(--aeno); }
  #recallChat { bottom:140px; }

  /* MAIN PANEL */
  #panel{
    position:absolute; left:10px; right:10px; bottom:10px;
    height:60%; border-radius:22px;
    background:var(--panel); border:1px solid var(--border);
    box-shadow:0 10px 40px rgba(0,0,0,0.15);
    z-index:110; overflow:hidden; display:flex; flex-direction:column;
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  #panel.hidden { transform: translateY(120%); }

  #panelHeader{
    padding:12px; background:#f1f8ff; border-bottom:1px solid #dbeafe;
    display:flex; justify-content:space-between; align-items:center;
  }
  #panelTabs{ display:flex; gap:5px; overflow-x:auto; padding-bottom:5px; }
  .tab{
    padding:6px 12px; border-radius:15px; font-size:11px;
    background:#fff; border:1px solid #dbeafe; cursor:pointer; white-space:nowrap;
  }
  .tab.active{ background:var(--accent); color:white; border-color:var(--accent); }

  #panelBody{ flex:1; overflow-y:auto; padding:15px; -webkit-overflow-scrolling:touch; }

  /* CARDS & UI */
  .card{ background:#fff; border-radius:16px; padding:12px; margin-bottom:12px; border:1px solid #edf2f7; box-shadow:0 4px 6px rgba(0,0,0,0.02); }
  .row{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
  .btn{
    padding:10px 14px; border:none; border-radius:12px;
    background:var(--accent); color:white; font-weight:bold; cursor:pointer; font-size:12px;
  }
  .btn:active{ transform:scale(0.95); }
  .btn.red{ background:var(--danger); }
  .btn.green{ background:var(--accent2); }
  .btn.gold{ background:var(--gold); }
  .btn.purple{ background:var(--aeno); }
  .btn.outline{ background:transparent; border:1px solid #cbd5e1; color:var(--text); }

  /* AI CHAT */
  #chatFloat{
    position:absolute; right:12px; top:80px; width:240px; max-height:300px;
    border-radius:18px; background:rgba(255,255,255,0.9); backdrop-filter:blur(8px);
    border:1px solid var(--border); z-index:105; display:flex; flex-direction:column;
    box-shadow:0 8px 24px rgba(0,0,0,0.1);
    transition: transform 0.3s;
  }
  #chatFloat.hidden { transform: translateX(120%); }
  #chatBody{ flex:1; overflow-y:auto; padding:10px; font-size:12px; }
  #chatInputWrap{ display:flex; padding:8px; gap:5px; border-top:1px solid #eee; }
  #chatInputWrap input{ flex:1; border-radius:10px; border:1px solid #ddd; padding:6px; font-size:12px; }

  /* HUD */
  #hud{
    position:absolute; bottom:20px; left:20px; pointer-events:none;
    z-index:20; font-size:12px; color:var(--text); font-weight:bold;
    background:rgba(255,255,255,0.6); padding:8px; border-radius:10px;
  }

  .number-input { width: 60px; padding: 5px; border-radius: 8px; border: 1px solid #ccc; }
</style>
</head>
<body>
<div id="wrap">
  <div id="game">
    <canvas id="cv"></canvas>

    <div id="topbar">
      <div class="chip" id="btnShowPanel">ğŸ° é¢æ¿</div>
      <div class="chip" id="btnShowChat">ğŸ¾ åŠ©æ‰‹</div>
      <div class="chip" onclick="saveGame()">ğŸ’¾ å­˜æª”</div>
    </div>

    <div id="recallPanel" onclick="togglePanel(true)">ğŸ°</div>
    <div id="recallChat" onclick="toggleChat(true)">ğŸ¾</div>

    <div id="chatFloat">
      <div id="panelHeader">
        <span style="font-weight:900; font-size:13px;">ğŸ¾ Aenko åŠ©æ‰‹</span>
        <button class="btn red" style="padding:2px 8px;" onclick="toggleChat(false)">Ã—</button>
      </div>
      <div id="chatBody"></div>
      <div id="chatInputWrap">
        <input id="chatInput" placeholder="è¼¸å…¥æŒ‡ä»¤... (å¦‚ï¼šå·¡é‚)" />
        <button class="btn" id="chatSend">é€å‡º</button>
      </div>
    </div>

    <div id="panel">
      <div id="panelHeader">
        <div id="panelTabs">
          <div class="tab active" data-tab="home">ç¸½è¦½</div>
          <div class="tab" data-tab="build">å»ºè¨­</div>
          <div class="tab" data-tab="market">äº¤æ˜“æ‰€</div>
          <div class="tab" data-tab="event">æ©Ÿå™¨äºº/äº‹ä»¶</div>
          <div class="tab" data-tab="tech">ç§‘æŠ€</div>
          <div class="tab" data-tab="ads">å»£å‘Š</div>
        </div>
        <button class="btn red" style="padding:2px 10px;" onclick="togglePanel(false)">æ”¶èµ·</button>
      </div>
      <div id="panelBody"></div>
    </div>

    <div id="hud">è³‡æºåŠ è¼‰ä¸­...</div>
  </div>
</div>

<script>
/* ---------- Core Configuration ---------- */
const TILE = 64;
const GRID_W = 22;
const GRID_H = 22;
const SAVE_KEY = "AENO_EMPIRE_V3_REVISED";

function fmt(n){
  if(n>=1e6) return (n/1e6).toFixed(1)+"M";
  if(n>=1e3) return (n/1e3).toFixed(1)+"K";
  return Math.floor(n);
}

/* ---------- State Management ---------- */
let state = JSON.parse(localStorage.getItem(SAVE_KEY)) || {
  resources: { gold: 500, aeno: 50, wood: 100, stone: 100, iron: 50, food: 100 },
  territoryRadius: 4,
  camera: { x: 0, y: 0, zoom: 1 },
  selected: { x: 11, y: 11 },
  beast: { timer: 90, wave: 1, active: false },
  robot: { active: false, x: 0, y: 0, cooldown: 0 },
  market: { wood: 2.5, stone: 3.5, iron: 8.2, food: 1.2 },
  tech: { points: 0, unlocked: { factory: false, wall: false, tower: false } },
  ai: { x: 11, y: 11, px: 0, py: 0, mode: "idle" },
  map: []
};

// Initialize Map if empty
if(!state.map.length){
  for(let y=0; y<GRID_H; y++){
    let row = [];
    for(let x=0; x<GRID_W; x++){
      let type = "grass";
      let dist = Math.hypot(x-11, y-11);
      if(dist > 8 && Math.random() < 0.4) type = "mountain";
      else if(dist > 5 && Math.random() < 0.3) type = "forest";
      else if(Math.random() < 0.05) type = "river";
      row.push({ terrain: type, building: "none", level: 0 });
    }
    state.map.push(row);
  }
  state.map[11][11].building = "town";
  state.map[11][11].level = 1;
}

/* ---------- UI Logic ---------- */
const panel = document.getElementById("panel");
const chat = document.getElementById("chatFloat");
const rPanel = document.getElementById("recallPanel");
const rChat = document.getElementById("recallChat");

function togglePanel(show){
  panel.classList.toggle("hidden", !show);
  rPanel.style.display = show ? "none" : "flex";
  if(show) renderPanel(document.querySelector(".tab.active").dataset.tab);
}
function toggleChat(show){
  chat.classList.toggle("hidden", !show);
  rChat.style.display = show ? "none" : "flex";
}
document.getElementById("btnShowPanel").onclick = () => togglePanel(true);
document.getElementById("btnShowChat").onclick = () => toggleChat(true);

function pushLog(msg) {
  const body = document.getElementById("chatBody");
  const d = document.createElement("div");
  d.innerHTML = `<span style="color:#64748b;">[ç³»çµ±]</span> ${msg}`;
  body.appendChild(d);
  body.scrollTop = body.scrollHeight;
}

/* ---------- Game Actions ---------- */
function collectManual(){
  const tile = state.map[state.selected.y][state.selected.x];
  if(tile.terrain === "forest"){
    state.resources.wood += 10;
    pushLog("ğŸŒ² æ‰‹å‹•ä¼æœ¨ï¼šæœ¨æ +10");
  } else if(tile.terrain === "river"){
    state.resources.food += 5;
    pushLog("ğŸŸ æ•é­šä¸­ï¼šé£Ÿç‰© +5");
  } else {
    pushLog("æ­¤åœ°å¡Šç„¡å¯æ”¶é›†è³‡æºï¼Œè«‹é»æ“Šæ£®æ—ã€‚");
  }
}

function expandLand(){
  let cost = state.territoryRadius * 200;
  if(state.resources.gold >= cost){
    state.resources.gold -= cost;
    state.territoryRadius++;
    pushLog(`ğŸŒ é ˜åœŸæ“´å¼µè‡³åŠå¾‘ ${state.territoryRadius}`);
  } else {
    pushLog("é‡‘å¹£ä¸è¶³ä»¥æ“´å¼µï¼");
  }
}

function buyResource(type){
  let qty = parseInt(document.getElementById(`buy_${type}`).value) || 0;
  let price = state.market[type];
  let cost = qty * price;
  if(state.resources.gold >= cost){
    state.resources.gold -= cost;
    state.resources[type] += qty;
    pushLog(`ğŸ›’ è²·å…¥ ${qty} å–®ä½ ${type}`);
  } else { pushLog("é‡‘å¹£ä¸è¶³ï¼"); }
}

function sellResource(type){
  let qty = parseInt(document.getElementById(`sell_${type}`).value) || 0;
  let price = state.market[type] * 0.8;
  if(state.resources[type] >= qty){
    state.resources[type] -= qty;
    state.resources.gold += qty * price;
    pushLog(`ğŸ’° è³£å‡º ${qty} å–®ä½ ${type}`);
  } else { pushLog("è³‡æºä¸è¶³ï¼"); }
}

function deployRobot(){
  if(state.robot.active) return pushLog("æ©Ÿå™¨äººå·²åœ¨å¤–é¢ï¼");
  state.robot.active = true;
  state.robot.timer = 15;
  pushLog("ğŸ¤– æ©Ÿå™¨äººå·²å‡ºç™¼å‰å¾€éš¨æ©Ÿæ˜Ÿå€æ”¶é›†è³‡æº...");
}

/* ---------- Render Panel Content ---------- */
function renderPanel(tab){
  const body = document.getElementById("panelBody");
  const sel = state.map[state.selected.y][state.selected.x];
  
  let html = "";
  if(tab === "home"){
    html = `
      <div class="card">
        <h3>ğŸ“Š å¸åœ‹è³‡æº</h3>
        <div class="row">
          <span>ğŸ’° é‡‘å¹£: ${fmt(state.resources.gold)}</span>
          <span>ğŸ’ AENO: ${fmt(state.resources.aeno)}</span>
          <span>ğŸªµ æœ¨æ: ${fmt(state.resources.wood)}</span>
          <span>ğŸª¨ çŸ³é ­: ${fmt(state.resources.stone)}</span>
          <span>âš™ï¸ éµ: ${fmt(state.resources.iron)}</span>
          <span>ğŸŒ¾ é£Ÿç‰©: ${fmt(state.resources.food)}</span>
        </div>
      </div>
      <div class="card">
        <h3>ğŸ“ é¸ä¸­åœ°å¡Š (${state.selected.x}, ${state.selected.y})</h3>
        <p>åœ°å½¢: ${sel.terrain} | å»ºç¯‰: ${sel.building} Lv.${sel.level}</p>
        <div class="row">
          <button class="btn green" onclick="collectManual()">æ‰‹å‹•æ”¶é›†è³‡æº</button>
          <button class="btn outline" onclick="expandLand()">æ“´å¼µé ˜åœŸ (${state.territoryRadius*200}é‡‘)</button>
        </div>
      </div>
    `;
  } else if(tab === "market"){
    html = `<h3>ğŸ›’ äº¤æ˜“æ‰€</h3>`;
    ["wood","stone","iron","food"].forEach(res => {
      html += `
        <div class="card">
          <b>${res.toUpperCase()}</b> (å¸‚åƒ¹: ${state.market[res]})
          <div class="row">
            <input type="number" id="buy_${res}" class="number-input" value="10">
            <button class="btn" onclick="buyResource('${res}')">è²·å…¥</button>
            <input type="number" id="sell_${res}" class="number-input" value="10" style="margin-left:10px;">
            <button class="btn gold" onclick="sellResource('${res}')">è³£å‡º</button>
          </div>
        </div>
      `;
    });
  } else if(tab === "build"){
    html = `
      <div class="card">
        <h3>ğŸ— å»ºé€ ä¸­å¿ƒ</h3>
        <p>è«‹å…ˆåœ¨åœ°åœ–é»é¸ç¶ è‰²åœ°å¡Šï¼Œå†é¸æ“‡å»ºç¯‰ã€‚</p>
        <div class="row">
          <button class="btn" onclick="build('farm')">è¾²ç”° (30æœ¨10çŸ³)</button>
          <button class="btn gold" onclick="build('mine')">ç¤¦å ´ (30æœ¨40çŸ³)</button>
          <button class="btn purple" onclick="build('factory')">å·¥å»  (100é‡‘50éµ)</button>
        </div>
      </div>
    `;
  } else if(tab === "event"){
    html = `
      <div class="card">
        <h3>ğŸ¤– æ©Ÿå™¨äººä¸­å¿ƒ</h3>
        <p>ç‹€æ…‹: ${state.robot.active ? "æ¢éšªä¸­..." : "å¾…æ©Ÿä¸­"}</p>
        <button class="btn purple" onclick="deployRobot()">æ‰‹å‹•æ´¾é£éš¨æ©Ÿå‡ºç™¼</button>
      </div>
      <div class="card">
        <h3>ğŸº ç¸æ½®é è­¦</h3>
        <p>ä¸‹ä¸€æ³¢: ${Math.floor(state.beast.timer)}s | ç•¶å‰æ³¢æ¬¡: ${state.beast.wave}</p>
      </div>
    `;
  } else if(tab === "ads"){
    html = `
      <div class="card">
        <h3>ğŸµ å»£å‘Šèˆ‡æ­Œæ›²</h3>
        <p>è§€çœ‹å»£å‘Šè²¼åœ–å¯ç²å¾—çå‹µè³‡æºï¼Œç”¨æ–¼è£œå……ç³»çµ±è³‡é‡‘ã€‚</p>
        <button class="btn gold" style="width:100%" onclick="playAd()">æ’­æ”¾å»£å‘Šæ­Œæ›² (+100é‡‘å¹£)</button>
      </div>
    `;
  }
  body.innerHTML = html;
}

document.querySelectorAll(".tab").forEach(t => {
  t.onclick = () => {
    document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
    t.classList.add("active");
    renderPanel(t.dataset.tab);
  };
});

/* ---------- Canvas & Draw ---------- */
const cv = document.getElementById("cv");
const ctx = cv.getContext("2d");
function resize(){
  cv.width = cv.clientWidth * devicePixelRatio;
  cv.height = cv.clientHeight * devicePixelRatio;
  ctx.scale(devicePixelRatio, devicePixelRatio);
}
window.onresize = resize;
resize();

function draw(){
  ctx.clearRect(0,0,cv.width,cv.height);
  const centerX = cv.clientWidth/2 + state.camera.x;
  const centerY = cv.clientHeight/3 + state.camera.y;

  for(let y=0; y<GRID_H; y++){
    for(let x=0; x<GRID_W; x++){
      const isoX = (x - y) * (TILE/2) + centerX;
      const isoY = (x + y) * (TILE/4) + centerY;
      
      // Draw Tile
      ctx.beginPath();
      ctx.moveTo(isoX, isoY - TILE/4);
      ctx.lineTo(isoX + TILE/2, isoY);
      ctx.lineTo(isoX, isoY + TILE/4);
      ctx.lineTo(isoX - TILE/2, isoY);
      ctx.closePath();
      
      let tile = state.map[y][x];
      ctx.fillStyle = (x===state.selected.x && y===state.selected.y) ? "#3b82f6" : 
                      (tile.terrain==="forest" ? "#22c55e" : 
                       tile.terrain==="mountain" ? "#94a3b8" : 
                       tile.terrain==="river" ? "#60a5fa" : "#dcfce7");
      
      // Territory check
      let dist = Math.hypot(x-11, y-11);
      if(dist > state.territoryRadius) ctx.globalAlpha = 0.5;
      else ctx.globalAlpha = 1;
      
      ctx.fill();
      ctx.strokeStyle = "rgba(255,255,255,0.3)";
      ctx.stroke();

      // Draw Building
      if(tile.building !== "none"){
        ctx.fillStyle = "#1e293b";
        ctx.fillRect(isoX-5, isoY-15, 10, 15);
      }
    }
  }
  
  // HUD Update
  document.getElementById("hud").innerHTML = `
    ğŸ’° ${fmt(state.resources.gold)} | ğŸªµ ${fmt(state.resources.wood)} | ğŸª¨ ${fmt(state.resources.stone)} | âš™ï¸ ${fmt(state.resources.iron)}
  `;
  requestAnimationFrame(draw);
}

/* ---------- Input Handling ---------- */
cv.onpointerdown = (e) => {
  const rect = cv.getBoundingClientRect();
  const mx = e.clientX - rect.left - (cv.clientWidth/2 + state.camera.x);
  const my = e.clientY - rect.top - (cv.clientHeight/3 + state.camera.y);
  
  // Basic Iso Inverse
  let x = Math.round((mx / (TILE/2) + my / (TILE/4)) / 2);
  let y = Math.round((my / (TILE/4) - mx / (TILE/2)) / 2);
  
  if(x>=0 && x<GRID_W && y>=0 && y<GRID_H){
    state.selected = {x, y};
    if(!panel.classList.contains("hidden")) renderPanel(document.querySelector(".tab.active").dataset.tab);
  }
};

/* ---------- Game Loop ---------- */
setInterval(() => {
  // Production
  state.map.forEach((row, y) => row.forEach((tile, x) => {
    if(Math.hypot(x-11, y-11) <= state.territoryRadius){
      if(tile.building === "farm") state.resources.food += 0.1 * tile.level;
      if(tile.building === "town") state.resources.gold += 0.2 * tile.level;
    }
  }));
  
  // Beast Logic
  state.beast.timer--;
  if(state.beast.timer <= 0){
    state.beast.timer = 120;
    state.beast.wave++;
    pushLog(`ğŸº ç¸æ½®ä¾†è¥²ï¼ç¬¬ ${state.beast.wave} æ³¢ï¼`);
    // Simple Reward for surviving
    state.resources.gold += 100 * state.beast.wave;
  }
  
  // Robot Logic
  if(state.robot.active){
    state.robot.timer--;
    if(state.robot.timer <= 0){
      state.robot.active = false;
      let gain = Math.floor(Math.random()*50) + 20;
      state.resources.iron += gain;
      pushLog(`ğŸ¤– æ©Ÿå™¨äººæ¢éšªæ­¸ä¾†ï¼Œå¸¶å› ${gain} å–®ä½éµç¤¦ï¼`);
    }
  }
}, 1000);

function saveGame(){
  localStorage.setItem(SAVE_KEY, JSON.stringify(state));
  pushLog("ğŸ’¾ é€²åº¦å·²å­˜æª”è‡³æœ¬åœ°ã€‚");
}

function playAd(){
  pushLog("ğŸµ æ­£åœ¨æ’­æ”¾è´ŠåŠ©æ­Œæ›²...");
  setTimeout(()=>{
    state.resources.gold += 100;
    pushLog("ğŸ å»£å‘Šæ’­æ”¾å®Œç•¢ï¼ç²å¾— 100 é‡‘å¹£ã€‚");
  }, 2000);
}

/* ---------- Init ---------- */
draw();
togglePanel(true);
pushLog("æ­¡è¿ä¾†åˆ° AENO å¸åœ‹ã€‚é»æ“Šæ£®æ—åœ°å¡Šå¯æ‰‹å‹•æ¡æœ¨ã€‚");

</script>
</body>
</html>
