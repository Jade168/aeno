<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<title>AENO V3 Mobile (Saved Build)</title>
<style>
  *{box-sizing:border-box; -webkit-tap-highlight-color: transparent;}
  html,body{margin:0;padding:0;height:100%;overflow:hidden;font-family:system-ui,Segoe UI,Arial;}
  body{background:#071321;}

  #gameWrap{
    position:fixed; left:0; top:0; right:0; bottom:0;
    display:flex; align-items:center; justify-content:center;
  }

  canvas{
    width:100vw; height:100vh;
    display:block;
    background: radial-gradient(circle at 50% 25%, #0b2a4a 0%, #06111f 55%, #03060c 100%);
  }

  /* Top HUD */
  #hudTop{
    position:fixed; top:10px; left:10px; right:10px;
    display:flex; gap:8px; align-items:center; justify-content:space-between;
    z-index:50;
    pointer-events:none;
  }

  .hudBox{
    pointer-events:auto;
    background:rgba(10,20,35,0.65);
    border:1px solid rgba(255,255,255,0.10);
    border-radius:14px;
    padding:8px 10px;
    color:#d7f1ff;
    backdrop-filter: blur(8px);
    box-shadow:0 10px 30px rgba(0,0,0,0.35);
    font-size:12px;
    line-height:1.2;
    max-width:70vw;
  }

  .hudRow{display:flex; gap:10px; flex-wrap:wrap;}
  .hudVal{font-weight:800; color:#fff;}
  .small{opacity:0.85; font-size:11px;}

  /* Floating Buttons */
  #btnMenu{
    position:fixed;
    right:12px;
    bottom:90px; /* avoid phone navigation bar */
    z-index:60;
    width:56px; height:56px;
    border-radius:18px;
    border:1px solid rgba(255,255,255,0.12);
    background:linear-gradient(180deg, rgba(80,190,255,0.9), rgba(40,120,255,0.9));
    box-shadow:0 18px 40px rgba(0,0,0,0.5);
    display:flex; align-items:center; justify-content:center;
    color:white; font-size:22px; font-weight:900;
    user-select:none;
  }

  #btnPlanet{
    position:fixed;
    left:12px;
    bottom:90px;
    z-index:60;
    width:56px; height:56px;
    border-radius:18px;
    border:1px solid rgba(255,255,255,0.12);
    background:linear-gradient(180deg, rgba(255,210,120,0.95), rgba(255,140,40,0.95));
    box-shadow:0 18px 40px rgba(0,0,0,0.5);
    display:flex; align-items:center; justify-content:center;
    color:#2b1200; font-size:22px; font-weight:900;
    user-select:none;
  }

  /* Panel (draggable) */
  #panel{
    position:fixed;
    left:12px;
    bottom:160px;
    width:min(92vw, 360px);
    max-height:62vh;
    background:rgba(10,18,28,0.88);
    border:1px solid rgba(255,255,255,0.12);
    border-radius:18px;
    color:#e9f7ff;
    z-index:80;
    box-shadow:0 22px 60px rgba(0,0,0,0.65);
    backdrop-filter: blur(10px);
    overflow:hidden;
    display:none;
    touch-action:none;
  }

  #panelHeader{
    padding:10px 12px;
    font-weight:900;
    font-size:13px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    border-bottom:1px solid rgba(255,255,255,0.10);
    background:linear-gradient(180deg, rgba(90,180,255,0.25), rgba(0,0,0,0));
    cursor:grab;
  }

  #panelHeader span{opacity:0.95;}
  #panelHeader .xbtn{
    width:28px; height:28px; border-radius:10px;
    display:flex; align-items:center; justify-content:center;
    background:rgba(255,255,255,0.08);
    border:1px solid rgba(255,255,255,0.10);
    font-weight:900;
    user-select:none;
  }

  #panelBody{
    padding:10px 12px 14px;
    overflow:auto;
    max-height:calc(62vh - 44px);
  }

  .secTitle{
    font-size:12px;
    font-weight:900;
    opacity:0.9;
    margin:8px 0 6px;
  }

  .grid2{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:8px;
  }

  .btn{
    padding:10px 10px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,0.10);
    background:rgba(255,255,255,0.06);
    color:#fff;
    font-weight:800;
    font-size:12px;
    text-align:center;
    user-select:none;
  }

  .btn:active{transform:scale(0.98);}

  .btnBlue{
    background:linear-gradient(180deg, rgba(90,180,255,0.85), rgba(50,110,255,0.85));
    border:1px solid rgba(255,255,255,0.15);
  }

  .btnGold{
    background:linear-gradient(180deg, rgba(255,215,120,0.95), rgba(255,140,40,0.95));
    color:#2b1200;
    border:1px solid rgba(255,255,255,0.15);
  }

  .btnRed{
    background:linear-gradient(180deg, rgba(255,120,120,0.95), rgba(200,60,80,0.95));
    border:1px solid rgba(255,255,255,0.15);
  }

  .line{
    height:1px;
    background:rgba(255,255,255,0.10);
    margin:10px 0;
  }

  .kv{
    display:flex;
    justify-content:space-between;
    font-size:12px;
    padding:4px 0;
    opacity:0.95;
  }
  .kv b{color:#fff;}

  /* Build menu (tap tile) */
  #buildMenu{
    position:fixed;
    left:50%;
    top:50%;
    transform:translate(-50%,-50%);
    width:min(92vw, 380px);
    background:rgba(12,18,28,0.94);
    border:1px solid rgba(255,255,255,0.14);
    border-radius:18px;
    z-index:120;
    box-shadow:0 25px 70px rgba(0,0,0,0.75);
    display:none;
    overflow:hidden;
  }

  #buildHeader{
    padding:12px 12px;
    font-weight:900;
    font-size:13px;
    display:flex;
    justify-content:space-between;
    border-bottom:1px solid rgba(255,255,255,0.10);
    background:linear-gradient(180deg, rgba(255,220,120,0.18), rgba(0,0,0,0));
  }

  #buildBody{padding:10px 12px 14px;}

  .buildItem{
    border:1px solid rgba(255,255,255,0.10);
    background:rgba(255,255,255,0.05);
    border-radius:16px;
    padding:10px 10px;
    margin-bottom:8px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
  }
  .buildItem .name{
    font-weight:900;
    font-size:12px;
  }
  .buildItem .cost{
    font-size:11px;
    opacity:0.85;
  }

  .buildItem .go{
    padding:8px 10px;
    border-radius:12px;
    background:linear-gradient(180deg, rgba(90,180,255,0.9), rgba(50,110,255,0.9));
    font-weight:900;
    font-size:11px;
    border:1px solid rgba(255,255,255,0.15);
    user-select:none;
    white-space:nowrap;
  }

  /* Assistant dialog */
  #assistantDialog{
    position:fixed;
    left:50%;
    bottom:110px;
    transform:translateX(-50%);
    width:min(92vw, 420px);
    background:rgba(12,18,28,0.92);
    border:1px solid rgba(255,255,255,0.14);
    border-radius:18px;
    z-index:110;
    box-shadow:0 25px 70px rgba(0,0,0,0.75);
    display:none;
    overflow:hidden;
  }

  #assistantHeader{
    padding:10px 12px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    font-weight:900;
    border-bottom:1px solid rgba(255,255,255,0.10);
  }

  #assistantBody{
    padding:10px 12px 12px;
    font-size:12px;
    opacity:0.95;
    max-height:30vh;
    overflow:auto;
  }

  #assistantInputRow{
    display:flex;
    gap:8px;
    padding:10px 12px 12px;
    border-top:1px solid rgba(255,255,255,0.10);
  }

  #assistantInput{
    flex:1;
    padding:10px 10px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,0.12);
    background:rgba(255,255,255,0.06);
    color:white;
    outline:none;
    font-size:12px;
  }

  #assistantSend{
    padding:10px 12px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,0.12);
    background:linear-gradient(180deg, rgba(90,180,255,0.9), rgba(50,110,255,0.9));
    font-weight:900;
    color:white;
    user-select:none;
  }

  /* Planet Selector */
  #planetModal{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.65);
    z-index:130;
    display:none;
    align-items:center;
    justify-content:center;
  }
  #planetCard{
    width:min(92vw, 420px);
    background:rgba(12,18,28,0.96);
    border:1px solid rgba(255,255,255,0.14);
    border-radius:18px;
    box-shadow:0 25px 70px rgba(0,0,0,0.75);
    overflow:hidden;
  }
  #planetHead{
    padding:12px 12px;
    font-weight:900;
    display:flex;
    justify-content:space-between;
    border-bottom:1px solid rgba(255,255,255,0.10);
  }
  #planetBody{padding:10px 12px 14px;}
  .planetItem{
    padding:10px 10px;
    border-radius:16px;
    border:1px solid rgba(255,255,255,0.10);
    background:rgba(255,255,255,0.05);
    margin-bottom:8px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    font-size:12px;
    font-weight:900;
  }
  .planetItem span{opacity:0.85; font-weight:700;}
  .planetItem .go{
    padding:8px 10px;
    border-radius:12px;
    background:linear-gradient(180deg, rgba(255,215,120,0.95), rgba(255,140,40,0.95));
    color:#2b1200;
    border:1px solid rgba(255,255,255,0.15);
    font-weight:900;
    user-select:none;
  }

  /* Toast */
  #toast{
    position:fixed;
    left:50%;
    top:72px;
    transform:translateX(-50%);
    background:rgba(0,0,0,0.65);
    border:1px solid rgba(255,255,255,0.12);
    color:#fff;
    padding:10px 12px;
    border-radius:16px;
    font-size:12px;
    font-weight:800;
    z-index:200;
    display:none;
    max-width:92vw;
    text-align:center;
  }

</style>
</head>
<body>
<div id="gameWrap">
  <canvas id="c"></canvas>
</div>

<div id="hudTop">
  <div class="hudBox" id="hudLeft">
    <div style="font-weight:900; font-size:12px;">AENO V3</div>
    <div class="small" id="hudPlanet">Planet: Terra-1</div>
  </div>
  <div class="hudBox" id="hudRight">
    <div class="hudRow">
      <div>ğŸ‘¤ <span class="hudVal" id="hudPop">4</span></div>
      <div>ğŸª™ <span class="hudVal" id="hudCoin">2000</span></div>
      <div>ğŸªµ <span class="hudVal" id="hudWood">800</span></div>
      <div>ğŸª¨ <span class="hudVal" id="hudStone">800</span></div>
      <div>â›“ï¸ <span class="hudVal" id="hudIron">800</span></div>
      <div>ğŸŒ¾ <span class="hudVal" id="hudFood">800</span></div>
      <div>ğŸ’ <span class="hudVal" id="hudAeno">0.0000</span></div>
    </div>
    <div class="small" id="hudMsg">Tap land to build Â· Pinch zoom</div>
  </div>
</div>

<div id="toast"></div>

<div id="btnPlanet">ğŸª</div>
<div id="btnMenu">â˜°</div>

<div id="panel">
  <div id="panelHeader">
    <span>æ§åˆ¶ä¸­å¿ƒ</span>
    <div class="xbtn" id="panelClose">âœ•</div>
  </div>
  <div id="panelBody">
    <div class="secTitle">å¿«é€Ÿæ“ä½œ</div>
    <div class="grid2">
      <div class="btn btnBlue" id="btnAutoToggle">AIè‡ªå‹•ï¼šON</div>
      <div class="btn btnGold" id="btnCollect">æ”¶å–å…¨éƒ¨</div>
      <div class="btn" id="btnPriority">å„ªå…ˆï¼šä¼æœ¨</div>
      <div class="btn" id="btnExpand">æ“´åœŸï¼ˆè‡ªå‹•ï¼‰</div>
    </div>

    <div class="line"></div>

    <div class="secTitle">å»ºç¯‰ï¼ˆé»ç©ºåœ°å»ºé€ ï¼‰</div>
    <div class="grid2">
      <div class="btn" id="btnHintBuild">æç¤ºï¼šé»ç©ºåœ°</div>
      <div class="btn" id="btnHintAssistant">é»AIåŠ©æ‰‹</div>
    </div>

    <div class="line"></div>

    <div class="secTitle">ç¶“æ¿Ÿ / äº¤æ˜“</div>
    <div class="grid2">
      <div class="btn" id="btnExchange">äº¤æ˜“æ‰€</div>
      <div class="btn" id="btnStock">è‚¡å¸‚</div>
      <div class="btn" id="btnTech">ç§‘æŠ€æ¨¹</div>
      <div class="btn" id="btnRobot">æ´¾æ©Ÿå™¨äºº</div>
    </div>

    <div class="line"></div>

    <div class="secTitle">å»£å‘Šæ­Œæ›²ï¼ˆProof of Listenï¼‰</div>
    <div class="grid2">
      <div class="btn btnBlue" id="btnPlayAd">æ’­æ”¾æ­Œæ›²</div>
      <div class="btn btnGold" id="btnClaimAd">é ˜å–çå‹µ</div>
    </div>
    <div class="small" style="margin-top:6px; opacity:0.8;">
      æ’­æ”¾æ»¿20ç§’æ‰å¯é ˜å–ï¼ˆæ¸¬è©¦ç‰ˆï¼‰
    </div>

    <div class="line"></div>

    <div class="secTitle">è³‡æºèˆ‡ç‹€æ…‹</div>
    <div class="kv"><span>é ˜åœŸå¤§å°</span><b id="kvLand">12</b></div>
    <div class="kv"><span>å»ºç¯‰æ•¸é‡</span><b id="kvBuild">2</b></div>
    <div class="kv"><span>é›¢ç·šè£œç®—</span><b id="kvOffline">OK</b></div>
    <div class="kv"><span>æ–‡æ˜å¹´ä»£</span><b id="kvAge">0.0 å¹´</b></div>

    <div class="line"></div>

    <div class="secTitle">é»‘æ´ï¼ˆé–‹ç™¼è€…å­¤å³¶ï¼‰</div>
    <div class="grid2">
      <div class="btn" id="btnBlackhole">é€²å…¥é»‘æ´</div>
      <div class="btn" id="btnReturn">è¿”å›æ˜Ÿçƒ</div>
    </div>

    <div class="line"></div>

    <div class="secTitle">ç³»çµ±</div>
    <div class="grid2">
      <div class="btn btnRed" id="btnReset">é‡ç½®éŠæˆ²</div>
      <div class="btn" id="btnSaveNow">ç«‹å³ä¿å­˜</div>
    </div>

  </div>
</div>

<div id="buildMenu">
  <div id="buildHeader">
    <div>å»ºç¯‰é¸å–®</div>
    <div class="xbtn" id="buildClose">âœ•</div>
  </div>
  <div id="buildBody"></div>
</div>

<div id="assistantDialog">
  <div id="assistantHeader">
    <div>ğŸ¾ AIåŠ©æ‰‹ã€ŒAenoFoxã€</div>
    <div class="xbtn" id="assistantClose">âœ•</div>
  </div>
  <div id="assistantBody"></div>
  <div id="assistantInputRow">
    <input id="assistantInput" placeholder="è¼¸å…¥ï¼šå·¡é‚ / æ”¶é›† / å»ºé€  / å‡ç´š / åœæ­¢è‡ªå‹•" />
    <div id="assistantSend">ç™¼é€</div>
  </div>
</div>

<div id="planetModal">
  <div id="planetCard">
    <div id="planetHead">
      <div>é¸æ“‡æ˜Ÿçƒ</div>
      <div class="xbtn" id="planetClose">âœ•</div>
    </div>
    <div id="planetBody"></div>
  </div>
</div>

<script>
(function(){
  "use strict";

  // =========================
  // SAFETY: prevent crash loop
  // =========================
  window.addEventListener("error", (e) => {
    console.log("JS Error:", e.message);
  });

  // =========================
  // Helpers
  // =========================
  const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));
  const rand = (a,b)=>a+Math.random()*(b-a);
  const randi = (a,b)=>Math.floor(a+Math.random()*(b-a+1));
  const now = ()=>Date.now();

  function toast(msg){
    const t = document.getElementById("toast");
    t.innerText = msg;
    t.style.display="block";
    clearTimeout(toast._tm);
    toast._tm=setTimeout(()=>{t.style.display="none";}, 1800);
  }

  // =========================
  // Canvas setup
  // =========================
  const canvas = document.getElementById("c");
  const ctx = canvas.getContext("2d", {alpha:false});
  function resize(){
    canvas.width = Math.floor(window.innerWidth * devicePixelRatio);
    canvas.height = Math.floor(window.innerHeight * devicePixelRatio);
  }
  window.addEventListener("resize", resize);
  resize();

  // =========================
  // Rounded rect (Chrome-safe)
  // =========================
  function roundRectPath(x,y,w,h,r){
    r = Math.min(r, w*0.5, h*0.5);
    ctx.beginPath();
    ctx.moveTo(x+r, y);
    ctx.arcTo(x+w, y, x+w, y+h, r);
    ctx.arcTo(x+w, y+h, x, y+h, r);
    ctx.arcTo(x, y+h, x, y, r);
    ctx.arcTo(x, y, x+w, y, r);
    ctx.closePath();
  }

  // =========================
  // WORLD DATA
  // =========================
  const SAVE_KEY = "AENO_V3_SAVE__2026_02_14";

  const PLANETS = [
    {id:"terra1", name:"Terra-1", color:"#3aa8ff"},
    {id:"terra2", name:"Terra-2", color:"#53ffbf"},
    {id:"marsX", name:"Mars-X", color:"#ff6a4a"},
    {id:"neoZ", name:"Neo-Zeta", color:"#d96bff"},
    {id:"blackhole", name:"Black Hole (Dev Island)", color:"#000000", isBlackhole:true}
  ];

  const TILE = 70;
  const MAP_W = 48;
  const MAP_H = 48;

  const TERRAIN = {
    WATER:0,
    GRASS:1,
    FOREST:2,
    ROCK:3,
    IRON:4,
    MOUNTAIN:5,
    FARM:6
  };

  const BUILDING = {
    HOUSE:"house",
    LUMBER:"lumber",
    QUARRY:"quarry",
    MINE:"mine",
    FARM:"farm",
    WALL:"wall",
    FACTORY:"factory"
  };

  const BUILD_INFO = {
    house:{name:"æˆ¿å±‹", cost:{coin:120, wood:80, stone:20}, desc:"äººå£ +2"},
    lumber:{name:"ä¼æœ¨å ´", cost:{coin:80, wood:40, stone:10}, desc:"ç”¢æœ¨æ"},
    quarry:{name:"æ¡çŸ³å ´", cost:{coin:90, wood:30, stone:30}, desc:"ç”¢çŸ³é ­"},
    mine:{name:"éµç¤¦å ´", cost:{coin:120, wood:50, stone:50}, desc:"ç”¢éµ"},
    farm:{name:"è¾²ç”°", cost:{coin:70, wood:20, stone:10}, desc:"ç”¢é£Ÿç‰©"},
    factory:{name:"å·¥å» ", cost:{coin:260, wood:140, stone:120, iron:80}, desc:"ç”¢é‡‘å¹£"},
    wall:{name:"åŸç‰†", cost:{coin:200, wood:100, stone:200, iron:60}, desc:"ç¸æ½®æ¢ä»¶"}
  };

  // =========================
  // SAVE / LOAD
  // =========================
  function defaultSave(){
    return {
      version: "AENO_V3_SAVED_BUILD",
      createdAt: now(),
      lastSeen: now(),

      activePlanetId: "terra1",
      planets: {},

      global: {
        totalAeno: 0,
        aenoMintedCap: 20000000,
        dayToYear: 10,
      }
    };
  }

  function makePlanetState(planetId){
    const isBlackhole = planetId === "blackhole";

    // Terrain generation
    const terrain = [];
    for(let y=0;y<MAP_H;y++){
      const row=[];
      for(let x=0;x<MAP_W;x++){
        row.push(TERRAIN.GRASS);
      }
      terrain.push(row);
    }

    // Add rivers
    function carveRiver(){
      let x=randi(5, MAP_W-6);
      for(let y=0;y<MAP_H;y++){
        for(let w=-1;w<=1;w++){
          if(terrain[y] && terrain[y][x+w]!=null) terrain[y][x+w]=TERRAIN.WATER;
        }
        x += randi(-1,1);
        x = clamp(x,3,MAP_W-4);
      }
    }
    carveRiver();
    if(Math.random()<0.6) carveRiver();

    // Forest clusters
    for(let i=0;i<520;i++){
      const x=randi(0,MAP_W-1), y=randi(0,MAP_H-1);
      if(terrain[y][x]===TERRAIN.GRASS && Math.random()<0.55) terrain[y][x]=TERRAIN.FOREST;
    }

    // Rocks
    for(let i=0;i<320;i++){
      const x=randi(0,MAP_W-1), y=randi(0,MAP_H-1);
      if(terrain[y][x]===TERRAIN.GRASS && Math.random()<0.35) terrain[y][x]=TERRAIN.ROCK;
    }

    // Iron veins
    for(let i=0;i<220;i++){
      const x=randi(0,MAP_W-1), y=randi(0,MAP_H-1);
      if(terrain[y][x]===TERRAIN.ROCK && Math.random()<0.45) terrain[y][x]=TERRAIN.IRON;
    }

    // Mountains
    for(let i=0;i<200;i++){
      const x=randi(0,MAP_W-1), y=randi(0,MAP_H-1);
      if(terrain[y][x]===TERRAIN.GRASS && Math.random()<0.25) terrain[y][x]=TERRAIN.MOUNTAIN;
    }

    // Blackhole island terrain
    if(isBlackhole){
      for(let y=0;y<MAP_H;y++){
        for(let x=0;x<MAP_W;x++){
          terrain[y][x]=TERRAIN.WATER;
        }
      }
      // central island
      const cx=Math.floor(MAP_W/2), cy=Math.floor(MAP_H/2);
      for(let y=0;y<MAP_H;y++){
        for(let x=0;x<MAP_W;x++){
          const d=Math.hypot(x-cx,y-cy);
          if(d<12) terrain[y][x]=TERRAIN.GRASS;
          if(d<9 && Math.random()<0.35) terrain[y][x]=TERRAIN.FOREST;
          if(d<7 && Math.random()<0.22) terrain[y][x]=TERRAIN.ROCK;
        }
      }
    }

    // Initial territory center
    const baseX = Math.floor(MAP_W/2);
    const baseY = Math.floor(MAP_H/2);

    const territory = {};
    function claim(x,y){
      territory[`${x},${y}`]=true;
    }
    for(let dy=-2;dy<=2;dy++){
      for(let dx=-2;dx<=2;dx++){
        if(Math.hypot(dx,dy)<=2.4) claim(baseX+dx, baseY+dy);
      }
    }

    // Buildings: 2 houses at start
    const buildings = [];
    buildings.push({type:BUILDING.HOUSE, x:baseX, y:baseY, level:1});
    buildings.push({type:BUILDING.HOUSE, x:baseX+1, y:baseY, level:1});

    return {
      planetId,
      terrain,
      territory,
      buildings,

      resources:{
        coin:2000,
        wood:800,
        stone:800,
        iron:800,
        food:800,
        shards:0,
        aeno:0
      },

      population:4,
      workers:4,

      ai:{
        auto:true,
        priority:"lumber", // lumber/quarry/mine/farm/house
      },

      ad:{
        listenedSeconds:0,
        rewardReady:false,
        totalListenScore:0
      },

      learning:{
        totalLearnScore:0
      },

      world:{
        ageYears:0,
        lastTick: now(),
        offlineMaxHours:24
      },

      defense:{
        wallComplete:false,
        wallProgress:0,
        beastMode:false
      },

      events:{
        lastBeastTime:0,
        lastRobotTime:0
      }
    };
  }

  function loadGame(){
    try{
      const raw = localStorage.getItem(SAVE_KEY);
      if(!raw){
        const save = defaultSave();
        // create planet states
        for(const p of PLANETS){
          save.planets[p.id] = makePlanetState(p.id);
        }
        return save;
      }
      const data = JSON.parse(raw);
      // ensure all planets exist
      if(!data.planets) data.planets = {};
      for(const p of PLANETS){
        if(!data.planets[p.id]) data.planets[p.id] = makePlanetState(p.id);
      }
      if(!data.activePlanetId) data.activePlanetId = "terra1";
      if(!data.global) data.global = {totalAeno:0,aenoMintedCap:20000000,dayToYear:10};
      return data;
    }catch(e){
      console.log("Load failed:", e);
      const save = defaultSave();
      for(const p of PLANETS){
        save.planets[p.id] = makePlanetState(p.id);
      }
      return save;
    }
  }

  function saveGame(){
    try{
      gameSave.lastSeen = now();
      localStorage.setItem(SAVE_KEY, JSON.stringify(gameSave));
    }catch(e){
      console.log("Save failed:", e);
    }
  }

  // =========================
  // Game state
  // =========================
  let gameSave = loadGame();

  function getPlanet(){
    return gameSave.planets[gameSave.activePlanetId];
  }

  function setPlanet(pid){
    gameSave.activePlanetId = pid;
    saveGame();
    toast("å·²åˆ‡æ›æ˜Ÿçƒï¼š" + PLANETS.find(p=>p.id===pid).name);
    document.getElementById("hudPlanet").innerText = "Planet: " + PLANETS.find(p=>p.id===pid).name;
  }

  // =========================
  // AENO Hidden Algorithm (Obfuscated)
  // =========================
  function _mixSeed(s){
    let h=2166136261;
    for(let i=0;i<s.length;i++){
      h ^= s.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return (h>>>0);
  }

  // secret mapping style (NOT readable)
  const _alpha = "QWERTYUIOPASDFGHJKLZXCVBNM";
  function _bitChar(n){
    // hidden mapping: 11..20 -> bit meaning (encoded)
    // DO NOT expose as digits; produce pseudo bits from alpha position
    const idx = (n*7 + 13) % _alpha.length;
    return _alpha[idx];
  }

  function _scoreToBits(score, salt){
    const base = _mixSeed(String(score) + ":" + salt);
    let out="";
    for(let i=0;i<18;i++){
      const v = (base >>> (i%16)) & 1;
      out += v ? _bitChar(11+i%10) : _bitChar(20-i%10);
    }
    return out;
  }

  function mintAenoFromActions(planet, dtSeconds){
    // Proof of Listen + Proof of Learn + Civilization cost score
    const listen = planet.ad.totalListenScore;
    const learn = planet.learning.totalLearnScore;

    const buildCount = planet.buildings.length;
    const eco = (planet.resources.wood + planet.resources.stone + planet.resources.iron + planet.resources.food) * 0.0001;

    const active = Math.min(planet.world.ageYears, 50);

    // Weighted score (real number)
    const score =
      listen*0.40 +
      learn*0.25 +
      buildCount*0.18 +
      eco*0.12 +
      active*0.05;

    // Dynamic salt changes over time
    const salt = gameSave.activePlanetId + ":" + Math.floor(now()/60000);

    // Hidden bits (for internal gating)
    const bits = _scoreToBits(score, salt);
    let hash=0;
    for(let i=0;i<bits.length;i++){
      hash = (hash + bits.charCodeAt(i) * (i+17)) % 100000;
    }

    // AENO minted pool per second (very slow)
    // (time scale: 1 day = 10 years)
    const basePerSec = 0.0000008; // intentionally low
    const intensity = clamp((hash % 1000) / 1000, 0.0, 1.0);

    // Only if player has some listening or learning
    const gate = (listen + learn) > 5 ? 1 : 0.08;

    let gain = basePerSec * dtSeconds * (0.25 + intensity*0.75) * gate;

    // Hard anti-fast mint
    gain = Math.min(gain, 0.0008);

    // add shards bonus conversion (slow)
    if(planet.resources.shards >= 50){
      const conv = Math.floor(planet.resources.shards / 50);
      planet.resources.shards -= conv*50;
      gain += conv * 0.0002;
    }

    // global cap
    if(gameSave.global.totalAeno + gain > gameSave.global.aenoMintedCap){
      gain = Math.max(0, gameSave.global.aenoMintedCap - gameSave.global.totalAeno);
    }

    planet.resources.aeno += gain;
    gameSave.global.totalAeno += gain;
  }

  // =========================
  // Simulation (offline + online)
  // =========================
  function simulatePlanet(planet, dtSeconds){
    if(dtSeconds <= 0) return;

    // time scale: 1 real day = 10 in-game years
    const yearPerSecond = (gameSave.global.dayToYear / 86400);
    planet.world.ageYears += dtSeconds * yearPerSecond;

    // Production base rates (fast enough to feel fun)
    let lumberRate = 0;
    let quarryRate = 0;
    let mineRate = 0;
    let farmRate = 0;
    let coinRate = 0;

    for(const b of planet.buildings){
      if(b.type===BUILDING.LUMBER) lumberRate += 0.55 * b.level;
      if(b.type===BUILDING.QUARRY) quarryRate += 0.40 * b.level;
      if(b.type===BUILDING.MINE) mineRate += 0.25 * b.level;
      if(b.type===BUILDING.FARM) farmRate += 0.50 * b.level;
      if(b.type===BUILDING.FACTORY) coinRate += 0.35 * b.level;
      if(b.type===BUILDING.HOUSE) {
        // passive small coin due to population economy
        coinRate += 0.03 * b.level;
      }
    }

    // Worker factor
    const workerBoost = 1 + (planet.workers * 0.06);

    // Gain resources
    planet.resources.wood += lumberRate * dtSeconds * workerBoost;
    planet.resources.stone += quarryRate * dtSeconds * workerBoost;
    planet.resources.iron += mineRate * dtSeconds * workerBoost;
    planet.resources.food += farmRate * dtSeconds * workerBoost;
    planet.resources.coin += coinRate * dtSeconds * (1 + planet.population*0.02);

    // food consumption
    const foodUse = planet.population * 0.05 * dtSeconds;
    planet.resources.food -= foodUse;
    if(planet.resources.food < 0){
      planet.resources.food = 0;
      // slow penalty if starving
      planet.resources.coin *= 0.9995;
    }

    // Population growth (slow)
    if(planet.resources.food > planet.population * 20){
      const growth = dtSeconds * 0.002;
      if(Math.random() < growth){
        planet.population += 1;
        planet.workers += 1;
      }
    }

    // Auto expand (coin based)
    if(planet.resources.coin > 3000){
      if(Math.random() < dtSeconds * 0.002){
        autoExpandTerritory(planet);
      }
    }

    // AI auto build
    if(planet.ai.auto){
      autoBuildLogic(planet, dtSeconds);
    }

    // Beast system only if wall complete 100%
    if(planet.defense.wallComplete){
      if(now() - planet.events.lastBeastTime > 1000*60*4){
        if(Math.random() < 0.35){
          triggerBeastRaid(planet);
        }
        planet.events.lastBeastTime = now();
      }
    }

    // Random robot salvage event (rare early)
    const landSize = Object.keys(planet.territory).length;
    if(landSize > 40 && now() - planet.events.lastRobotTime > 1000*60*5){
      if(Math.random() < 0.12){
        driftingRobotEvent(planet);
      }
      planet.events.lastRobotTime = now();
    }

    // AENO mint
    mintAenoFromActions(planet, dtSeconds);

    // clamp non-negative
    for(const k of ["coin","wood","stone","iron","food","shards","aeno"]){
      if(planet.resources[k] < 0) planet.resources[k] = 0;
    }
  }

  function autoExpandTerritory(planet){
    // spend coin to expand 1 tile
    const cost = 180 + Object.keys(planet.territory).length * 1.5;
    if(planet.resources.coin < cost) return;

    // find edge tile
    const keys = Object.keys(planet.territory);
    if(keys.length===0) return;
    const pick = keys[randi(0, keys.length-1)];
    const [px,py] = pick.split(",").map(Number);

    const dirs = [[1,0],[-1,0],[0,1],[0,-1]];
    for(let i=0;i<dirs.length;i++){
      const d = dirs[randi(0,dirs.length-1)];
      const nx = px+d[0], ny = py+d[1];
      if(nx<0||ny<0||nx>=MAP_W||ny>=MAP_H) continue;
      const key = `${nx},${ny}`;
      if(!planet.territory[key]){
        planet.territory[key]=true;
        planet.resources.coin -= cost;
        toast("é ˜åœŸæ“´å¼µ +1ï¼ˆèŠ±è²»ğŸª™" + Math.floor(cost) + "ï¼‰");
        return;
      }
    }
  }

  function autoBuildLogic(planet, dtSeconds){
    // avoid spamming build every second
    if(!autoBuildLogic._t) autoBuildLogic._t = 0;
    autoBuildLogic._t += dtSeconds;
    if(autoBuildLogic._t < 3.5) return;
    autoBuildLogic._t = 0;

    const pr = planet.ai.priority;

    // ensure at least 1 lumber, quarry, mine, farm early
    const countType = (t)=>planet.buildings.filter(b=>b.type===t).length;

    let target = pr;

    if(countType(BUILDING.LUMBER)<1) target="lumber";
    else if(countType(BUILDING.FARM)<1) target="farm";
    else if(countType(BUILDING.QUARRY)<1) target="quarry";
    else if(countType(BUILDING.MINE)<1) target="mine";

    // if population high, add house
    if(planet.population > countType(BUILDING.HOUSE)*2) target="house";

    // factory mid-game
    if(Object.keys(planet.territory).length>50 && countType(BUILDING.FACTORY)<1){
      target="factory";
    }

    // choose a tile to build
    const buildPos = findBuildSpot(planet, target);
    if(!buildPos) return;

    tryBuild(planet, target, buildPos.x, buildPos.y, true);
  }

  function findBuildSpot(planet, type){
    const keys = Object.keys(planet.territory);
    if(keys.length===0) return null;

    // prefer correct terrain for certain buildings
    const wants = {
      lumber: [TERRAIN.FOREST],
      quarry: [TERRAIN.ROCK, TERRAIN.MOUNTAIN],
      mine: [TERRAIN.IRON, TERRAIN.ROCK],
      farm: [TERRAIN.GRASS],
      house: [TERRAIN.GRASS],
      factory: [TERRAIN.GRASS, TERRAIN.ROCK],
      wall: [TERRAIN.GRASS, TERRAIN.ROCK]
    };

    // shuffle
    const shuffled = keys.sort(()=>Math.random()-0.5);
    for(const k of shuffled){
      const [x,y] = k.split(",").map(Number);
      if(planet.buildings.some(b=>b.x===x && b.y===y)) continue;
      const t = planet.terrain[y][x];
      if(wants[type] && wants[type].includes(t)) return {x,y};
    }

    // fallback
    for(const k of shuffled){
      const [x,y] = k.split(",").map(Number);
      if(planet.buildings.some(b=>b.x===x && b.y===y)) continue;
      return {x,y};
    }

    return null;
  }

  function canAfford(planet, cost){
    for(const k in cost){
      if(planet.resources[k] == null) return false;
      if(planet.resources[k] < cost[k]) return false;
    }
    return true;
  }

  function payCost(planet, cost){
    for(const k in cost){
      planet.resources[k] -= cost[k];
    }
  }

  function tryBuild(planet, type, x, y, silent){
    const info = BUILD_INFO[type];
    if(!info) return false;

    if(!planet.territory[`${x},${y}`]){
      if(!silent) toast("å””ä¿‚ä½ é ˜åœŸï¼");
      return false;
    }

    if(planet.buildings.some(b=>b.x===x && b.y===y)){
      if(!silent) toast("å·²æœ‰å»ºç¯‰ï¼");
      return false;
    }

    if(!canAfford(planet, info.cost)){
      if(!silent) toast("è³‡æºä¸è¶³ï¼");
      return false;
    }

    payCost(planet, info.cost);

    planet.buildings.push({type, x, y, level:1});

    if(type===BUILDING.HOUSE){
      planet.population += 2;
      planet.workers += 2;
    }

    if(type===BUILDING.WALL){
      planet.defense.wallProgress += 1;
      if(planet.defense.wallProgress >= 8){
        planet.defense.wallComplete = true;
        toast("ğŸ° åŸç‰†å®Œæˆï¼ç¸æ½®å·²è§£é–");
      }
    }

    if(!silent) toast("å»ºé€ æˆåŠŸï¼š" + info.name);
    return true;
  }

  // =========================
  // Beast / Robot Events
  // =========================
  function triggerBeastRaid(planet){
    planet.defense.beastMode = true;
    const loot = randi(15,45);
    planet.resources.shards += loot;
    toast("ğŸº ç¸æ½®ä¾†è¥²ï¼ç²å¾—ç¢ç‰‡ +" + loot);
  }

  function driftingRobotEvent(planet){
    // robot steals 20% (your rule)
    const stealRate = 0.20;
    const stealWood = Math.floor(planet.resources.wood * stealRate);
    const stealStone = Math.floor(planet.resources.stone * stealRate);
    const stealIron = Math.floor(planet.resources.iron * stealRate);
    const stealFood = Math.floor(planet.resources.food * stealRate);

    planet.resources.wood -= stealWood;
    planet.resources.stone -= stealStone;
    planet.resources.iron -= stealIron;
    planet.resources.food -= stealFood;

    toast("ğŸ¤– æ¼‚æµæ©Ÿå™¨äººæ å¥ªä½  20% è³‡æºï¼");
  }

  // =========================
  // UI references
  // =========================
  const hudPop = document.getElementById("hudPop");
  const hudCoin = document.getElementById("hudCoin");
  const hudWood = document.getElementById("hudWood");
  const hudStone = document.getElementById("hudStone");
  const hudIron = document.getElementById("hudIron");
  const hudFood = document.getElementById("hudFood");
  const hudAeno = document.getElementById("hudAeno");

  const kvLand = document.getElementById("kvLand");
  const kvBuild = document.getElementById("kvBuild");
  const kvOffline = document.getElementById("kvOffline");
  const kvAge = document.getElementById("kvAge");

  // =========================
  // Panel draggable
  // =========================
  const panel = document.getElementById("panel");
  const panelHeader = document.getElementById("panelHeader");

  let panelDrag=false, pdx=0, pdy=0;
  panelHeader.addEventListener("pointerdown", (e)=>{
    panelDrag=true;
    pdx = e.clientX - panel.offsetLeft;
    pdy = e.clientY - panel.offsetTop;
    panelHeader.setPointerCapture(e.pointerId);
  });
  panelHeader.addEventListener("pointermove", (e)=>{
    if(!panelDrag) return;
    panel.style.left = clamp(e.clientX - pdx, 6, window.innerWidth - panel.offsetWidth - 6) + "px";
    panel.style.top  = clamp(e.clientY - pdy, 6, window.innerHeight - panel.offsetHeight - 6) + "px";
    panel.style.bottom = "auto";
  });
  panelHeader.addEventListener("pointerup", ()=>{
    panelDrag=false;
  });

  // =========================
  // Menu toggle
  // =========================
  document.getElementById("btnMenu").onclick = ()=>{
    if(panel.style.display==="none" || panel.style.display===""){
      panel.style.display="block";
      // default place safe
      if(!panel.style.top){
        panel.style.left="12px";
        panel.style.bottom="160px";
      }
    }else{
      panel.style.display="none";
    }
  };
  document.getElementById("panelClose").onclick = ()=>panel.style.display="none";

  // =========================
  // Assistant dialog
  // =========================
  const assistantDialog = document.getElementById("assistantDialog");
  const assistantBody = document.getElementById("assistantBody");
  const assistantInput = document.getElementById("assistantInput");

  function assistantSay(msg){
    const t = new Date().toLocaleTimeString().slice(0,5);
    assistantBody.innerHTML += `<div style="margin-bottom:6px;"><b style="color:#7dd3fc;">[${t}]</b> ${msg}</div>`;
    assistantBody.scrollTop = assistantBody.scrollHeight;
  }

  document.getElementById("assistantClose").onclick = ()=>assistantDialog.style.display="none";
  document.getElementById("assistantSend").onclick = ()=>{
    const cmd = assistantInput.value.trim();
    if(!cmd) return;
    assistantInput.value="";
    assistantSay("ä½ ï¼š<span style='opacity:0.85'>" + cmd + "</span>");
    parseAssistantCommand(cmd);
  };

  function parseAssistantCommand(cmd){
    const p = getPlanet();

    if(cmd.includes("åœæ­¢") || cmd.includes("é—œ") || cmd.toLowerCase().includes("off")){
      p.ai.auto = false;
      assistantSay("æ”¶åˆ°ï¼å·²åœæ­¢è‡ªå‹•å»ºè¨­ã€‚");
      return;
    }
    if(cmd.includes("é–‹å§‹") || cmd.includes("é–‹") || cmd.toLowerCase().includes("on")){
      p.ai.auto = true;
      assistantSay("OKï¼å·²å•Ÿå‹•è‡ªå‹•å»ºè¨­ã€‚");
      return;
    }
    if(cmd.includes("ä¼æœ¨")){
      p.ai.priority="lumber";
      assistantSay("å„ªå…ˆç­–ç•¥å·²æ”¹ç‚ºï¼šä¼æœ¨å ´ / æœ¨æã€‚");
      return;
    }
    if(cmd.includes("è¾²") || cmd.includes("é£Ÿ")){
      p.ai.priority="farm";
      assistantSay("å„ªå…ˆç­–ç•¥å·²æ”¹ç‚ºï¼šè¾²ç”° / é£Ÿç‰©ã€‚");
      return;
    }
    if(cmd.includes("çŸ³")){
      p.ai.priority="quarry";
      assistantSay("å„ªå…ˆç­–ç•¥å·²æ”¹ç‚ºï¼šæ¡çŸ³ / çŸ³é ­ã€‚");
      return;
    }
    if(cmd.includes("éµ") || cmd.includes("ç¤¦")){
      p.ai.priority="mine";
      assistantSay("å„ªå…ˆç­–ç•¥å·²æ”¹ç‚ºï¼šéµç¤¦ / ç¤¦ç”¢ã€‚");
      return;
    }
    if(cmd.includes("æˆ¿")){
      p.ai.priority="house";
      assistantSay("å„ªå…ˆç­–ç•¥å·²æ”¹ç‚ºï¼šæˆ¿å±‹ / äººå£ã€‚");
      return;
    }
    if(cmd.includes("æ”¶é›†") || cmd.includes("æ”¶å–")){
      assistantSay("å·²æŒ‡ä»¤æ‰€æœ‰å·¥äººåŠ é€Ÿæ”¶é›†è³‡æºã€‚");
      p.resources.coin += 30;
      p.resources.wood += 20;
      p.resources.stone += 12;
      p.resources.food += 15;
      return;
    }

    assistantSay("æˆ‘æ˜ç™½å””åˆ°æŒ‡ä»¤ã€‚ä½ å¯ä»¥è©¦ï¼šä¼æœ¨ / è¾²ç”° / çŸ³é ­ / éµç¤¦ / é–‹å§‹ / åœæ­¢ / æ”¶é›†");
  }

  // =========================
  // Planet Modal
  // =========================
  const planetModal = document.getElementById("planetModal");
  const planetBody = document.getElementById("planetBody");

  function openPlanetModal(){
    planetBody.innerHTML="";
    for(const p of PLANETS){
      const div = document.createElement("div");
      div.className="planetItem";
      div.innerHTML = `<div>${p.name}<br><span>${p.isBlackhole ? "é»‘æ´å­¤å³¶" : "è³‡æºæ˜Ÿçƒ"}</span></div><div class="go">é€²å…¥</div>`;
      div.querySelector(".go").onclick = ()=>{
        planetModal.style.display="none";
        setPlanet(p.id);
      };
      planetBody.appendChild(div);
    }
    planetModal.style.display="flex";
  }

  document.getElementById("btnPlanet").onclick = openPlanetModal;
  document.getElementById("planetClose").onclick = ()=>planetModal.style.display="none";
  planetModal.addEventListener("click",(e)=>{
    if(e.target===planetModal) planetModal.style.display="none";
  });

  // =========================
  // Panel buttons
  // =========================
  document.getElementById("btnAutoToggle").onclick = ()=>{
    const p = getPlanet();
    p.ai.auto = !p.ai.auto;
    document.getElementById("btnAutoToggle").innerText = "AIè‡ªå‹•ï¼š" + (p.ai.auto ? "ON":"OFF");
    toast("AIè‡ªå‹•ï¼š" + (p.ai.auto ? "ON":"OFF"));
  };

  document.getElementById("btnCollect").onclick = ()=>{
    const p = getPlanet();
    // quick collect bonus
    p.resources.coin += 120;
    p.resources.wood += 90;
    p.resources.stone += 70;
    p.resources.iron += 40;
    p.resources.food += 90;
    toast("å·²æ”¶å–å…¨éƒ¨è³‡æºï¼ˆåŠ©æ‰‹åŠ é€Ÿï¼‰");
  };

  document.getElementById("btnPriority").onclick = ()=>{
    const p = getPlanet();
    const list=["lumber","farm","quarry","mine","house","factory"];
    const idx = list.indexOf(p.ai.priority);
    p.ai.priority = list[(idx+1)%list.length];
    const name = BUILD_INFO[p.ai.priority]?.name || p.ai.priority;
    document.getElementById("btnPriority").innerText = "å„ªå…ˆï¼š" + name;
    toast("AIå„ªå…ˆï¼š" + name);
  };

  document.getElementById("btnExpand").onclick = ()=>{
    const p = getPlanet();
    autoExpandTerritory(p);
  };

  document.getElementById("btnExchange").onclick = ()=>toast("äº¤æ˜“æ‰€ï¼šä¸‹ä¸€ç‰ˆåŠ å…¥è²·è³£UIï¼ˆä¿ç•™å­˜æª”ï¼‰");
  document.getElementById("btnStock").onclick = ()=>toast("è‚¡å¸‚ï¼šä¸‹ä¸€ç‰ˆåŠ å…¥æ³¢å‹•èˆ‡Kç·šï¼ˆä¿ç•™å­˜æª”ï¼‰");
  document.getElementById("btnTech").onclick = ()=>toast("ç§‘æŠ€æ¨¹ï¼šä¸‹ä¸€ç‰ˆåŠ å…¥ç ”ç©¶ï¼ˆä¿ç•™å­˜æª”ï¼‰");

  document.getElementById("btnRobot").onclick = ()=>{
    const p = getPlanet();
    if(p.resources.coin < 200){
      toast("æ´¾æ©Ÿå™¨äººéœ€è¦ ğŸª™200");
      return;
    }
    p.resources.coin -= 200;
    // robot returns random
    const gainWood=randi(40,140);
    const gainStone=randi(30,120);
    const gainIron=randi(10,80);
    const gainFood=randi(30,120);

    p.resources.wood += gainWood;
    p.resources.stone += gainStone;
    p.resources.iron += gainIron;
    p.resources.food += gainFood;

    toast("ğŸš€ æ©Ÿå™¨äººå›æ”¶è³‡æº +æœ¨" + gainWood + " çŸ³" + gainStone + " éµ" + gainIron);
  };

  // =========================
  // Ad song (simple offline audio)
  // =========================
  let audioCtx=null;
  let adPlaying=false;
  let adStart=0;

  function playTestAdSong(){
    if(adPlaying){
      toast("æ­Œæ›²æ’­æ”¾ä¸­â€¦");
      return;
    }
    try{
      audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type="triangle";
      o.frequency.value=440;

      // simple melody
      let t = audioCtx.currentTime;
      const notes=[440,523,587,659,587,523,440,392,440,523,659,784,659,523,440];
      for(let i=0;i<notes.length;i++){
        o.frequency.setValueAtTime(notes[i], t+i*0.35);
      }

      g.gain.value=0.0001;
      g.gain.exponentialRampToValueAtTime(0.12, audioCtx.currentTime+0.2);
      g.gain.exponentialRampToValueAtTime(0.06, audioCtx.currentTime+4.0);
      g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime+6.0);

      o.connect(g);
      g.connect(audioCtx.destination);

      o.start();
      o.stop(audioCtx.currentTime+6.2);

      adPlaying=true;
      adStart=now();
      toast("ğŸµ å»£å‘Šæ­Œæ›²æ’­æ”¾ä¸­ï¼ˆæ¸¬è©¦ï¼‰");

      setTimeout(()=>{
        adPlaying=false;
        const p=getPlanet();
        const listened = Math.min(20, Math.floor((now()-adStart)/1000));
        p.ad.listenedSeconds += listened;
        p.ad.totalListenScore += listened * 1.0;
        if(p.ad.listenedSeconds >= 20){
          p.ad.rewardReady=true;
          toast("âœ… å·²é”20ç§’ï¼Œå¯é ˜å–çå‹µ");
        }else{
          toast("â³ æœªæ»¿20ç§’ï¼ˆ" + p.ad.listenedSeconds + "/20ï¼‰");
        }
      }, 6500);

    }catch(e){
      toast("Audio ç„¡æ³•æ’­æ”¾ï¼ˆç€è¦½å™¨é™åˆ¶ï¼‰");
    }
  }

  document.getElementById("btnPlayAd").onclick = playTestAdSong;

  document.getElementById("btnClaimAd").onclick = ()=>{
    const p=getPlanet();
    if(!p.ad.rewardReady){
      toast("æœªé”20ç§’ï¼Œæœªå¯é ˜å–");
      return;
    }
    p.ad.rewardReady=false;
    p.ad.listenedSeconds=0;

    // reward
    p.resources.coin += 300;
    p.resources.shards += 20;

    toast("ğŸ å»£å‘Šçå‹µï¼šğŸª™+300 +ç¢ç‰‡20");
  };

  // =========================
  // Blackhole buttons
  // =========================
  document.getElementById("btnBlackhole").onclick = ()=>setPlanet("blackhole");
  document.getElementById("btnReturn").onclick = ()=>setPlanet("terra1");

  // =========================
  // Save / Reset
  // =========================
  document.getElementById("btnSaveNow").onclick = ()=>{
    saveGame();
    toast("å·²ä¿å­˜");
  };

  document.getElementById("btnReset").onclick = ()=>{
    if(!confirm("ç¢ºå®šé‡ç½®ï¼Ÿæœƒæ¸…é™¤æ‰€æœ‰å­˜æª”")) return;
    localStorage.removeItem(SAVE_KEY);
    location.reload();
  };

  // =========================
  // Build menu
  // =========================
  const buildMenu = document.getElementById("buildMenu");
  const buildBody = document.getElementById("buildBody");
  let buildTarget = null;

  function openBuildMenu(tileX, tileY){
    buildTarget = {x:tileX,y:tileY};
    buildBody.innerHTML="";

    const p = getPlanet();
    const list = ["house","lumber","quarry","mine","farm","factory","wall"];

    for(const k of list){
      const info = BUILD_INFO[k];
      const costStr = Object.keys(info.cost).map(c=>`${c}:${info.cost[c]}`).join(" ");
      const div = document.createElement("div");
      div.className="buildItem";
      div.innerHTML = `
        <div>
          <div class="name">${info.name}</div>
          <div class="cost">${info.desc} Â· ${costStr}</div>
        </div>
        <div class="go">å»ºé€ </div>
      `;
      div.querySelector(".go").onclick = ()=>{
        const ok = tryBuild(p, k, tileX, tileY, false);
        if(ok){
          buildMenu.style.display="none";
          saveGame();
        }
      };
      buildBody.appendChild(div);
    }

    buildMenu.style.display="block";
  }

  document.getElementById("buildClose").onclick = ()=>buildMenu.style.display="none";

  // =========================
  // Camera / Touch controls
  // =========================
  let camX=MAP_W*TILE*0.5;
  let camY=MAP_H*TILE*0.5;
  let zoom=1.0;

  // more zoom range (your request)
  const ZMIN=0.18;
  const ZMAX=4.0;

  let dragging=false;
  let lastX=0, lastY=0;

  let pinch=false;
  let pinchDist=0;
  let pinchZoom=1;

  function screenToWorld(sx,sy){
    const w = canvas.width/devicePixelRatio;
    const h = canvas.height/devicePixelRatio;
    const wx = (sx - w/2)/zoom + camX;
    const wy = (sy - h/2)/zoom + camY;
    return {x:wx,y:wy};
  }

  function worldToTile(wx,wy){
    return {tx:Math.floor(wx/TILE), ty:Math.floor(wy/TILE)};
  }

  function pointerDist(a,b){
    return Math.hypot(a.clientX-b.clientX, a.clientY-b.clientY);
  }

  const pointers = new Map();

  canvas.addEventListener("pointerdown",(e)=>{
    pointers.set(e.pointerId, e);
    canvas.setPointerCapture(e.pointerId);

    if(pointers.size===1){
      dragging=true;
      lastX=e.clientX;
      lastY=e.clientY;
    }

    if(pointers.size===2){
      pinch=true;
      const arr=[...pointers.values()];
      pinchDist = pointerDist(arr[0], arr[1]);
      pinchZoom = zoom;
    }
  });

  canvas.addEventListener("pointermove",(e)=>{
    if(!pointers.has(e.pointerId)) return;
    pointers.set(e.pointerId, e);

    if(pinch && pointers.size===2){
      const arr=[...pointers.values()];
      const d = pointerDist(arr[0], arr[1]);
      const factor = d / pinchDist;
      zoom = clamp(pinchZoom * factor, ZMIN, ZMAX);
      return;
    }

    if(dragging && pointers.size===1){
      const dx = (e.clientX-lastX)/zoom;
      const dy = (e.clientY-lastY)/zoom;
      camX -= dx;
      camY -= dy;
      lastX=e.clientX;
      lastY=e.clientY;
    }
  });

  canvas.addEventListener("pointerup",(e)=>{
    if(pointers.has(e.pointerId)){
      pointers.delete(e.pointerId);
    }

    if(pointers.size<2){
      pinch=false;
    }
    if(pointers.size===0){
      dragging=false;
    }
  });

  // Tap build detection
  canvas.addEventListener("click",(e)=>{
    // ignore if UI opened
    if(buildMenu.style.display==="block") return;
    if(planetModal.style.display==="flex") return;

    const w = screenToWorld(e.clientX, e.clientY);
    const t = worldToTile(w.x, w.y);

    const p = getPlanet();
    if(t.tx<0||t.ty<0||t.tx>=MAP_W||t.ty>=MAP_H) return;

    // if tap assistant
    if(isTapAssistant(w.x, w.y)){
      assistantDialog.style.display="block";
      assistantSay("æˆ‘å–ºåº¦ï¼ä½ å¯ä»¥å«æˆ‘ï¼šä¼æœ¨ / è¾²ç”° / çŸ³é ­ / éµç¤¦ / æ”¶é›† / åœæ­¢è‡ªå‹•");
      return;
    }

    // allow build only if inside territory
    if(!p.territory[`${t.tx},${t.ty}`]){
      toast("å‘¢åº¦æœªä¿‚ä½ é ˜åœŸ");
      return;
    }

    // open build menu if empty
    if(!p.buildings.some(b=>b.x===t.tx && b.y===t.ty)){
      openBuildMenu(t.tx, t.ty);
    }else{
      toast("å·²æœ‰å»ºç¯‰ï¼ˆä¸‹ä¸€ç‰ˆå¯å‡ç´šï¼‰");
    }
  });

  // =========================
  // Assistant entity (animal body)
  // =========================
  const assistant = {
    x: (MAP_W*TILE)/2 + 60,
    y: (MAP_H*TILE)/2 + 20,
    vx: 0,
    vy: 0,
    t: 0
  };

  function isTapAssistant(wx,wy){
    return Math.hypot(wx-assistant.x, wy-assistant.y) < 35;
  }

  function updateAssistant(dt){
    assistant.t += dt;
    // cute wandering
    if(assistant.t > 2.8){
      assistant.t = 0;
      assistant.vx = rand(-18,18);
      assistant.vy = rand(-18,18);
    }
    assistant.x += assistant.vx * dt;
    assistant.y += assistant.vy * dt;

    // clamp near center of territory
    assistant.x = clamp(assistant.x, TILE*10, TILE*(MAP_W-10));
    assistant.y = clamp(assistant.y, TILE*10, TILE*(MAP_H-10));
  }

  // =========================
  // Workers + animals
  // =========================
  const walkers = [];
  function initWalkers(){
    walkers.length=0;
    const cx = MAP_W*TILE*0.5;
    const cy = MAP_H*TILE*0.5;
    for(let i=0;i<4;i++){
      walkers.push({
        kind:"worker",
        x: cx + rand(-80,80),
        y: cy + rand(-80,80),
        vx: rand(-20,20),
        vy: rand(-20,20),
        t: rand(0,2)
      });
    }
    for(let i=0;i<8;i++){
      walkers.push({
        kind:"animal",
        x: cx + rand(-240,240),
        y: cy + rand(-240,240),
        vx: rand(-18,18),
        vy: rand(-18,18),
        t: rand(0,2)
      });
    }
  }
  initWalkers();

  function updateWalkers(dt){
    for(const w of walkers){
      w.t += dt;
      if(w.t > 2.2){
        w.t=0;
        w.vx = rand(-24,24);
        w.vy = rand(-24,24);
      }
      w.x += w.vx*dt;
      w.y += w.vy*dt;
      w.x = clamp(w.x, TILE*3, TILE*(MAP_W-3));
      w.y = clamp(w.y, TILE*3, TILE*(MAP_H-3));
    }
  }

  // =========================
  // Offline calculation (max 24h)
  // =========================
  function runOfflineCatchup(){
    const p = getPlanet();
    const last = gameSave.lastSeen || now();
    let dt = (now()-last)/1000;

    const max = p.world.offlineMaxHours * 3600;
    if(dt > max){
      dt = max;
      kvOffline.innerText = "å·²åœæ­¢(>24h)";
    }else{
      kvOffline.innerText = "OK";
    }

    // do not run if dt is tiny
    if(dt > 1){
      // simulate for active planet only (fast)
      simulatePlanet(p, dt);
      toast("é›¢ç·šè£œç®—ï¼š" + Math.floor(dt/60) + " åˆ†é˜");
    }
  }

  runOfflineCatchup();

  // =========================
  // Render
  // =========================
  function drawTile(x,y,t){
    const px = x*TILE;
    const py = y*TILE;

    if(t===TERRAIN.WATER){
      ctx.fillStyle="#0b3a63";
      ctx.fillRect(px,py,TILE,TILE);
      ctx.fillStyle="rgba(255,255,255,0.05)";
      ctx.fillRect(px,py+TILE*0.25,TILE,TILE*0.1);
      return;
    }

    if(t===TERRAIN.GRASS){
      ctx.fillStyle="#1c6f3f";
      ctx.fillRect(px,py,TILE,TILE);
      ctx.fillStyle="rgba(255,255,255,0.04)";
      ctx.fillRect(px+8,py+10,TILE-16,TILE-20);
      return;
    }

    if(t===TERRAIN.FOREST){
      ctx.fillStyle="#145a33";
      ctx.fillRect(px,py,TILE,TILE);

      // trees
      ctx.fillStyle="#0f3d22";
      for(let i=0;i<3;i++){
        const tx=px+18+i*18;
        const ty=py+20+Math.sin((x+y+i)*0.7)*4;
        ctx.beginPath();
        ctx.arc(tx,ty,10,0,Math.PI*2);
        ctx.fill();
      }
      return;
    }

    if(t===TERRAIN.ROCK){
      ctx.fillStyle="#4b5563";
      ctx.fillRect(px,py,TILE,TILE);
      ctx.fillStyle="rgba(255,255,255,0.12)";
      ctx.beginPath();
      ctx.arc(px+24,py+34,14,0,Math.PI*2);
      ctx.arc(px+46,py+44,12,0,Math.PI*2);
      ctx.fill();
      return;
    }

    if(t===TERRAIN.IRON){
      ctx.fillStyle="#374151";
      ctx.fillRect(px,py,TILE,TILE);
      ctx.fillStyle="#7dd3fc";
      ctx.beginPath();
      ctx.arc(px+24,py+36,8,0,Math.PI*2);
      ctx.arc(px+46,py+46,7,0,Math.PI*2);
      ctx.fill();
      return;
    }

    if(t===TERRAIN.MOUNTAIN){
      ctx.fillStyle="#2b3440";
      ctx.fillRect(px,py,TILE,TILE);
      ctx.fillStyle="rgba(255,255,255,0.10)";
      ctx.beginPath();
      ctx.moveTo(px+12,py+56);
      ctx.lineTo(px+34,py+16);
      ctx.lineTo(px+56,py+56);
      ctx.closePath();
      ctx.fill();
      return;
    }
  }

  function drawBuilding(b){
    const px=b.x*TILE, py=b.y*TILE;

    // shadow
    ctx.fillStyle="rgba(0,0,0,0.25)";
    ctx.beginPath();
    ctx.ellipse(px+TILE/2, py+TILE*0.72, TILE*0.32, TILE*0.14, 0,0,Math.PI*2);
    ctx.fill();

    if(b.type===BUILDING.HOUSE){
      // cute house
      ctx.fillStyle="#fef3c7";
      roundRectPath(px+14,py+22,TILE-28,TILE-28,10);
      ctx.fill();

      ctx.fillStyle="#fbbf24";
      ctx.beginPath();
      ctx.moveTo(px+12,py+24);
      ctx.lineTo(px+TILE/2,py+8);
      ctx.lineTo(px+TILE-12,py+24);
      ctx.closePath();
      ctx.fill();

      ctx.fillStyle="#92400e";
      roundRectPath(px+TILE/2-7,py+38,14,20,5);
      ctx.fill();

      ctx.fillStyle="#93c5fd";
      ctx.beginPath();
      ctx.arc(px+24,py+40,6,0,Math.PI*2);
      ctx.arc(px+TILE-24,py+40,6,0,Math.PI*2);
      ctx.fill();
    }

    if(b.type===BUILDING.LUMBER){
      // lumber saw
      ctx.fillStyle="#a16207";
      roundRectPath(px+12,py+26,TILE-24,TILE-30,12);
      ctx.fill();

      ctx.fillStyle="#f59e0b";
      roundRectPath(px+18,py+18,TILE-36,16,10);
      ctx.fill();

      ctx.fillStyle="#052e16";
      ctx.beginPath();
      ctx.arc(px+TILE/2,py+48,10,0,Math.PI*2);
      ctx.fill();
    }

    if(b.type===BUILDING.QUARRY){
      ctx.fillStyle="#6b7280";
      roundRectPath(px+14,py+26,TILE-28,TILE-30,12);
      ctx.fill();
      ctx.fillStyle="#d1d5db";
      ctx.beginPath();
      ctx.arc(px+30,py+44,8,0,Math.PI*2);
      ctx.arc(px+44,py+52,7,0,Math.PI*2);
      ctx.fill();
    }

    if(b.type===BUILDING.MINE){
      ctx.fillStyle="#111827";
      roundRectPath(px+14,py+26,TILE-28,TILE-30,12);
      ctx.fill();
      ctx.fillStyle="#7dd3fc";
      ctx.beginPath();
      ctx.arc(px+TILE/2,py+46,8,0,Math.PI*2);
      ctx.fill();
    }

    if(b.type===BUILDING.FARM){
      ctx.fillStyle="#14532d";
      roundRectPath(px+12,py+30,TILE-24,TILE-36,12);
      ctx.fill();
      ctx.fillStyle="#86efac";
      for(let i=0;i<4;i++){
        ctx.fillRect(px+18+i*12,py+38,6,20);
      }
    }

    if(b.type===BUILDING.FACTORY){
      ctx.fillStyle="#1f2937";
      roundRectPath(px+12,py+24,TILE-24,TILE-28,12);
      ctx.fill();
      ctx.fillStyle="#60a5fa";
      ctx.fillRect(px+18,py+30,TILE-36,10);
      ctx.fillStyle="#9ca3af";
      ctx.fillRect(px+TILE-26,py+16,10,22);
    }

    if(b.type===BUILDING.WALL){
      ctx.fillStyle="#374151";
      roundRectPath(px+10,py+34,TILE-20,TILE-40,12);
      ctx.fill();
      ctx.fillStyle="#9ca3af";
      ctx.fillRect(px+16,py+38,TILE-32,6);
    }
  }

  function drawTerritoryOverlay(p){
    ctx.strokeStyle="rgba(255,255,255,0.10)";
    ctx.lineWidth=2;
    for(const k in p.territory){
      const [x,y]=k.split(",").map(Number);
      ctx.strokeRect(x*TILE+1, y*TILE+1, TILE-2, TILE-2);
    }
  }

  function drawWorker(w){
    // cartoony
    ctx.fillStyle="rgba(0,0,0,0.25)";
    ctx.beginPath();
    ctx.ellipse(w.x, w.y+12, 10, 5, 0,0,Math.PI*2);
    ctx.fill();

    ctx.fillStyle="#fde68a";
    ctx.beginPath();
    ctx.arc(w.x, w.y, 10, 0, Math.PI*2);
    ctx.fill();

    ctx.fillStyle="#60a5fa";
    ctx.beginPath();
    ctx.arc(w.x-4, w.y-2, 2.5, 0, Math.PI*2);
    ctx.arc(w.x+4, w.y-2, 2.5, 0, Math.PI*2);
    ctx.fill();

    ctx.strokeStyle="#111827";
    ctx.lineWidth=2;
    ctx.beginPath();
    ctx.arc(w.x, w.y+3, 4, 0, Math.PI);
    ctx.stroke();
  }

  function drawAnimal(w){
    ctx.fillStyle="rgba(0,0,0,0.22)";
    ctx.beginPath();
    ctx.ellipse(w.x, w.y+12, 10, 5, 0,0,Math.PI*2);
    ctx.fill();

    ctx.fillStyle="#fca5a5";
    ctx.beginPath();
    ctx.arc(w.x, w.y, 10, 0, Math.PI*2);
    ctx.fill();

    // ears
    ctx.beginPath();
    ctx.moveTo(w.x-8,w.y-6);
    ctx.lineTo(w.x-14,w.y-16);
    ctx.lineTo(w.x-4,w.y-12);
    ctx.closePath();
    ctx.fill();

    ctx.beginPath();
    ctx.moveTo(w.x+8,w.y-6);
    ctx.lineTo(w.x+14,w.y-16);
    ctx.lineTo(w.x+4,w.y-12);
    ctx.closePath();
    ctx.fill();

    ctx.fillStyle="#111827";
    ctx.beginPath();
    ctx.arc(w.x-4, w.y-2, 2.2, 0, Math.PI*2);
    ctx.arc(w.x+4, w.y-2, 2.2, 0, Math.PI*2);
    ctx.fill();
  }

  function drawAssistant(){
    // shadow
    ctx.fillStyle="rgba(0,0,0,0.25)";
    ctx.beginPath();
    ctx.ellipse(assistant.x, assistant.y+16, 16, 7, 0,0,Math.PI*2);
    ctx.fill();

    // body
    ctx.fillStyle="#fbbf24";
    ctx.beginPath();
    ctx.arc(assistant.x, assistant.y, 16, 0, Math.PI*2);
    ctx.fill();

    // belly
    ctx.fillStyle="#fde68a";
    ctx.beginPath();
    ctx.arc(assistant.x, assistant.y+5, 10, 0, Math.PI*2);
    ctx.fill();

    // ears
    ctx.fillStyle="#f59e0b";
    ctx.beginPath();
    ctx.moveTo(assistant.x-12,assistant.y-6);
    ctx.lineTo(assistant.x-22,assistant.y-22);
    ctx.lineTo(assistant.x-6,assistant.y-16);
    ctx.closePath();
    ctx.fill();

    ctx.beginPath();
    ctx.moveTo(assistant.x+12,assistant.y-6);
    ctx.lineTo(assistant.x+22,assistant.y-22);
    ctx.lineTo(assistant.x+6,assistant.y-16);
    ctx.closePath();
    ctx.fill();

    // eyes
    ctx.fillStyle="#111827";
    ctx.beginPath();
    ctx.arc(assistant.x-5, assistant.y-2, 2.4, 0, Math.PI*2);
    ctx.arc(assistant.x+5, assistant.y-2, 2.4, 0, Math.PI*2);
    ctx.fill();

    // mouth
    ctx.strokeStyle="#111827";
    ctx.lineWidth=2;
    ctx.beginPath();
    ctx.arc(assistant.x, assistant.y+4, 5, 0, Math.PI);
    ctx.stroke();

    // Ad flag slot
    ctx.strokeStyle="#ffffff";
    ctx.lineWidth=2;
    ctx.beginPath();
    ctx.moveTo(assistant.x+18, assistant.y-10);
    ctx.lineTo(assistant.x+18, assistant.y-32);
    ctx.stroke();

    ctx.fillStyle="rgba(80,190,255,0.9)";
    ctx.beginPath();
    ctx.moveTo(assistant.x+18, assistant.y-32);
    ctx.lineTo(assistant.x+36, assistant.y-26);
    ctx.lineTo(assistant.x+18, assistant.y-20);
    ctx.closePath();
    ctx.fill();

    ctx.fillStyle="#ffffff";
    ctx.font = "900 10px system-ui";
    ctx.fillText("AD", assistant.x+22, assistant.y-24);
  }

  function render(){
    const w = canvas.width;
    const h = canvas.height;

    // clear
    ctx.setTransform(1,0,0,1,0,0);
    ctx.fillStyle="#071321";
    ctx.fillRect(0,0,w,h);

    // camera
    ctx.setTransform(zoom*devicePixelRatio,0,0,zoom*devicePixelRatio, w/2 - camX*zoom*devicePixelRatio, h/2 - camY*zoom*devicePixelRatio);

    const p = getPlanet();

    // draw terrain
    for(let y=0;y<MAP_H;y++){
      for(let x=0;x<MAP_W;x++){
        drawTile(x,y,p.terrain[y][x]);
      }
    }

    // territory border
    drawTerritoryOverlay(p);

    // buildings
    for(const b of p.buildings){
      drawBuilding(b);
    }

    // walkers
    for(const ww of walkers){
      if(ww.kind==="worker") drawWorker(ww);
      else drawAnimal(ww);
    }

    // assistant
    drawAssistant();

    // world labels
    ctx.setTransform(1,0,0,1,0,0);
  }

  // =========================
  // HUD update
  // =========================
  function updateHUD(){
    const p = getPlanet();
    hudPop.innerText = p.population;
    hudCoin.innerText = Math.floor(p.resources.coin);
    hudWood.innerText = Math.floor(p.resources.wood);
    hudStone.innerText = Math.floor(p.resources.stone);
    hudIron.innerText = Math.floor(p.resources.iron);
    hudFood.innerText = Math.floor(p.resources.food);
    hudAeno.innerText = (p.resources.aeno || 0).toFixed(6);

    kvLand.innerText = Object.keys(p.territory).length;
    kvBuild.innerText = p.buildings.length;
    kvAge.innerText = p.world.ageYears.toFixed(1) + " å¹´";

    document.getElementById("btnAutoToggle").innerText = "AIè‡ªå‹•ï¼š" + (p.ai.auto ? "ON":"OFF");
    const prName = BUILD_INFO[p.ai.priority]?.name || p.ai.priority;
    document.getElementById("btnPriority").innerText = "å„ªå…ˆï¼š" + prName;

    document.getElementById("hudPlanet").innerText = "Planet: " + PLANETS.find(pp=>pp.id===gameSave.activePlanetId).name;
  }

  // =========================
  // Main loop
  // =========================
  let last = performance.now();

  function loop(t){
    const dt = Math.min(0.05, (t-last)/1000);
    last=t;

    try{
      const p = getPlanet();
      // online simulate (smooth)
      simulatePlanet(p, dt);

      updateAssistant(dt);
      updateWalkers(dt);

      render();
      updateHUD();

      // autosave every 25 sec
      loop._sv = (loop._sv||0) + dt;
      if(loop._sv > 25){
        loop._sv = 0;
        saveGame();
      }

    }catch(e){
      console.log("Loop crash:", e);
    }

    requestAnimationFrame(loop);
  }

  requestAnimationFrame(loop);

  // =========================
  // Important: ensure panel not under phone nav bar
  // =========================
  setTimeout(()=>{
    panel.style.bottom="160px";
  }, 200);

  // =========================
  // Initial assistant message
  // =========================
  setTimeout(()=>{
    assistantSay("ä½ å¥½ï¼æˆ‘æœƒè‡ªå‹•å¹«ä½ æ”¶é›†è³‡æºã€èµ·å»ºç¯‰ã€å‡ç´šæ–‡æ˜ã€‚");
    assistantSay("æç¤ºï¼šé»ç©ºåœ°å°±å¯ä»¥å»ºé€ ã€‚é»æˆ‘å°±å¯ä»¥æ‰“æŒ‡ä»¤ã€‚");
  }, 500);

  // =========================
  // Force save on exit
  // =========================
  window.addEventListener("beforeunload", saveGame);

})();
</script>

</body>
</html>
