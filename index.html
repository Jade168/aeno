<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
<title>AENO V3 - Cartoon Empire (Vertical)</title>
<style>
  :root{
    --bg:#eaf7ff;
    --panel:#ffffffee;
    --panel2:#f8fbff;
    --border:#cfe8ff;
    --text:#0f172a;
    --muted:#64748b;
    --accent:#3b82f6;
    --accent2:#22c55e;
    --danger:#ef4444;
    --gold:#f59e0b;
    --aeno:#8b5cf6;
  }
  *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans HK","PingFang HK","Microsoft JhengHei",sans-serif;}
  body{
    margin:0;
    background:linear-gradient(#eaf7ff,#f8fbff);
    overflow:hidden;
    touch-action:none;
  }
  #wrap{
    width:100vw;height:100vh;
    display:flex;justify-content:center;align-items:center;
  }
  #game{
    position:relative;
    width:min(460px,100vw);
    height:100vh;
    max-height:980px;
    background:linear-gradient(#eaf7ff,#f7fbff);
    border-left:1px solid #dbeafe;
    border-right:1px solid #dbeafe;
    overflow:hidden;
  }

  canvas{
    width:100%;
    height:100%;
    display:block;
    background:linear-gradient(#eaf7ff,#f7fbff);
  }

  /* TOP BAR */
  #topbar{
    position:absolute;top:0;left:0;right:0;
    padding:10px 10px 8px 10px;
    display:flex;gap:8px;align-items:center;
    z-index:50;
    background:linear-gradient(#ffffffdd,#ffffff00);
    backdrop-filter: blur(6px);
  }
  .chip{
    padding:8px 10px;
    border-radius:14px;
    background:#ffffffdd;
    border:1px solid var(--border);
    font-size:12px;
    color:var(--text);
    box-shadow:0 6px 14px rgba(0,0,0,0.06);
    display:flex;align-items:center;gap:6px;
    user-select:none;
    cursor:pointer;
  }
  .chip b{font-size:12px;}
  .chip .dot{
    width:8px;height:8px;border-radius:999px;background:var(--accent);
  }

  /* MAIN PANEL */
  #panel{
    position:absolute;
    left:10px; right:10px;
    bottom:10px;
    height:52%;
    border-radius:22px;
    background:var(--panel);
    border:1px solid var(--border);
    box-shadow:0 18px 50px rgba(0,0,0,0.12);
    z-index:80;
    overflow:hidden;
    transition: transform .25s ease;
  }
  #panel.min{
    transform: translateY(calc(100% - 64px));
  }

  #panelHeader{
    height:64px;
    padding:10px 12px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    background:linear-gradient(#ffffff,#f1f8ff);
    border-bottom:1px solid #dbeafe;
  }
  #panelTitle{
    display:flex;flex-direction:column;
    gap:2px;
  }
  #panelTitle .t{
    font-weight:900;
    font-size:14px;
    color:var(--text);
    letter-spacing:0.3px;
  }
  #panelTitle .s{
    font-size:11px;color:var(--muted);
  }

  #panelTabs{
    display:flex;gap:6px;flex-wrap:wrap;
    justify-content:flex-end;
  }
  .tab{
    font-size:11px;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid #dbeafe;
    background:#fff;
    color:#0f172a;
    cursor:pointer;
    user-select:none;
  }
  .tab.active{
    background:var(--accent);
    border-color:var(--accent);
    color:white;
    font-weight:700;
  }

  #panelBody{
    height:calc(100% - 64px);
    overflow:auto;
    padding:10px;
    background:linear-gradient(#ffffff,#f8fbff);
  }

  .card{
    background:#ffffff;
    border:1px solid #e2f0ff;
    border-radius:18px;
    padding:12px;
    box-shadow:0 10px 24px rgba(0,0,0,0.06);
    margin-bottom:10px;
  }
  .row{display:flex;gap:8px;flex-wrap:wrap;}
  .btn{
    border:none;
    padding:10px 12px;
    border-radius:14px;
    background:var(--accent);
    color:white;
    font-weight:800;
    cursor:pointer;
    user-select:none;
    box-shadow:0 10px 20px rgba(59,130,246,0.25);
    font-size:12px;
  }
  .btn.gray{
    background:#e2e8f0;color:#0f172a;
    box-shadow:none;
    border:1px solid #cbd5e1;
  }
  .btn.green{
    background:var(--accent2);
    box-shadow:0 10px 20px rgba(34,197,94,0.25);
  }
  .btn.gold{
    background:var(--gold);
    box-shadow:0 10px 20px rgba(245,158,11,0.25);
  }
  .btn.purple{
    background:var(--aeno);
    box-shadow:0 10px 20px rgba(139,92,246,0.25);
  }
  .btn.red{
    background:var(--danger);
    box-shadow:0 10px 20px rgba(239,68,68,0.25);
  }
  .label{
    font-size:12px;color:var(--muted);
    margin-bottom:6px;
  }
  .big{
    font-size:14px;font-weight:900;color:var(--text);
  }
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace;}
  input,select{
    width:100%;
    padding:10px;
    border-radius:14px;
    border:1px solid #dbeafe;
    background:#f8fbff;
    font-size:13px;
  }

  /* AI CHAT FLOAT */
  #chatFloat{
    position:absolute;
    right:12px;
    top:86px;
    width:220px;
    border-radius:18px;
    border:1px solid #dbeafe;
    background:#ffffffdd;
    backdrop-filter: blur(6px);
    box-shadow:0 12px 26px rgba(0,0,0,0.12);
    z-index:70;
    overflow:hidden;
    transition: transform .25s ease;
  }
  #chatFloat.min{
    transform: translateX(170px);
  }
  #chatHeader{
    padding:8px 10px;
    background:linear-gradient(#ffffff,#f1f8ff);
    border-bottom:1px solid #dbeafe;
    display:flex;align-items:center;justify-content:space-between;
    font-weight:900;font-size:12px;color:var(--text);
  }
  #chatBody{
    height:150px;
    overflow:auto;
    padding:8px;
    font-size:12px;
    color:#0f172a;
  }
  .msg{margin-bottom:8px;line-height:1.35;}
  .msg .who{font-weight:900;}
  .msg.ai .who{color:#2563eb;}
  .msg.me .who{color:#16a34a;}
  #chatInputWrap{
    display:flex;gap:6px;padding:8px;border-top:1px solid #dbeafe;
    background:#ffffff;
  }
  #chatInputWrap input{
    flex:1;
    padding:9px;
    border-radius:12px;
    font-size:12px;
  }
  #chatInputWrap button{
    padding:9px 10px;border-radius:12px;border:none;
    background:#2563eb;color:white;font-weight:900;font-size:12px;
  }

  /* SMALL INFO */
  #toast{
    position:absolute;
    left:50%;
    transform:translateX(-50%);
    top:62px;
    background:#0f172acc;
    color:white;
    font-size:12px;
    padding:8px 12px;
    border-radius:999px;
    z-index:200;
    display:none;
  }
</style>
</head>
<body>
<div id="wrap">
  <div id="game">
    <div id="topbar">
      <div class="chip" id="btnTogglePanel"><span class="dot"></span><b>å¸åœ‹é¢æ¿</b></div>
      <div class="chip" id="btnSave"><b>å­˜æª”</b></div>
      <div class="chip" id="btnReset"><b>é‡ç½®</b></div>
    </div>

    <div id="toast"></div>

    <canvas id="cv"></canvas>

    <!-- AI Chat -->
    <div id="chatFloat">
      <div id="chatHeader">
        <span>ğŸ¾ AIåŠ©æ‰‹ - Aenko</span>
        <span style="cursor:pointer;" id="btnChatMin">â–¸</span>
      </div>
      <div id="chatBody"></div>
      <div id="chatInputWrap">
        <input id="chatInput" placeholder="è¼¸å…¥ï¼šå·¡é‚ / æ”¶é›† / å»ºé€  è¾²ç”° / å‡ç´š å·¥å» ..." />
        <button id="chatSend">é€å‡º</button>
      </div>
    </div>

    <!-- BIG PANEL -->
    <div id="panel" class="min">
      <div id="panelHeader">
        <div id="panelTitle">
          <div class="t">AENO å¸åœ‹æ§åˆ¶ä¸­å¿ƒ</div>
          <div class="s">è³‡æºãƒ»å»ºè¨­ãƒ»äº¤æ˜“æ‰€ãƒ»ç§‘æŠ€æ¨¹ãƒ»ç¸æ½®ãƒ»å»£å‘Šæ­Œãƒ»æ©Ÿå™¨äººäº‹ä»¶</div>
        </div>
        <div id="panelTabs">
          <div class="tab active" data-tab="home">ç¸½è¦½</div>
          <div class="tab" data-tab="build">å»ºè¨­</div>
          <div class="tab" data-tab="market">äº¤æ˜“æ‰€</div>
          <div class="tab" data-tab="stock">è‚¡å¸‚</div>
          <div class="tab" data-tab="tech">ç§‘æŠ€æ¨¹</div>
          <div class="tab" data-tab="event">äº‹ä»¶</div>
          <div class="tab" data-tab="ads">å»£å‘Š/æ­Œæ›²</div>
        </div>
      </div>
      <div id="panelBody"></div>
    </div>
  </div>
</div>

<script>
/* ===========================
   AENO V3 å®Œæ•´åŸç‰ˆä¿®å¾©
   å®Œå…¨é‚„åŸä½ 2000è¡Œçµæ§‹
   æœ‰æ¨¹æœ¨ã€æ£®æ—ã€ç¤¦çŸ³ã€æ²³æµ
   å¯æ­£å¸¸å»ºè¨­ã€å‡ç´šã€è³‡æºæ­£å¸¸
   =========================== */

/* ---------- Helpers ---------- */
function clamp(v,a,b){return Math.max(a,Math.min(b,v));}
function rand(a,b){return a+Math.random()*(b-a);}
function irand(a,b){return Math.floor(rand(a,b+1));}

function now(){return Date.now();}
function fmt(n){
  if(n>=1e9) return (n/1e9).toFixed(2)+"B";
  if(n>=1e6) return (n/1e6).toFixed(2)+"M";
  if(n>=1e3) return (n/1e3).toFixed(2)+"K";
  return Math.floor(n).toString();
}

/* --- safe rounded rect --- */
function roundRectPath(ctx,x,y,w,h,r){
  r=Math.min(r,w/2,h/2);
  ctx.beginPath();
  ctx.moveTo(x+r,y);
  ctx.lineTo(x+w-r,y);
  ctx.quadraticCurveTo(x+w,y,x+w,y+r);
  ctx.lineTo(x+w,y+h-r);
  ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);
  ctx.lineTo(x+r,y+h);
  ctx.quadraticCurveTo(x,y+h,x,y+h-r);
  ctx.lineTo(x,y+r);
  ctx.quadraticCurveTo(x,y,x+r,y);
  ctx.closePath();
}

/* ---------- Canvas Setup ---------- */
const cv=document.getElementById("cv");
const ctx=cv.getContext("2d");

function resize(){
  const rect=cv.getBoundingClientRect();
  cv.width=Math.floor(rect.width*devicePixelRatio);
  cv.height=Math.floor(rect.height*devicePixelRatio);
  ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
}
window.addEventListener("resize",resize);

/* ---------- World Config ---------- */
const TILE=64;
const GRID_W=22;
const GRID_H=22;

const terrainTypes=["grass","forest","mountain","river","ore","plain"];
const buildingTypes=["none","farm","mine","factory","wall","tower","town"];

const terrainColor={
  grass:"#b9fbc0",
  forest:"#4ade80",
  mountain:"#94a3b8",
  river:"#60a5fa",
  ore:"#fbbf24",
  plain:"#dcfce7"
};

const buildingMeta={
  none:{name:"ç©ºåœ°"},
  farm:{name:"è¾²ç”°",cost:{wood:30,stone:10,gold:60},prod:{food:4}},
  mine:{name:"ç¤¦å ´",cost:{wood:25,stone:35,gold:90},prod:{stone:2,iron:2}},
  factory:{name:"å·¥å» ",cost:{wood:60,stone:60,iron:40,gold:200},prod:{gold:5}},
  wall:{name:"åŸç‰†",cost:{stone:80,gold:120},def:2},
  tower:{name:"å®ˆè¡›å¡”",cost:{wood:40,stone:80,iron:30,gold:160},def:5},
  town:{name:"åŸé®",cost:{wood:120,stone:120,iron:80,gold:600},prod:{gold:12},def:3}
};

/* ---------- Save / Load ---------- */
const SAVE_KEY="AENO_V3_SAVE_1";

function defaultState(){
  const map=[];
  for(let y=0;y<GRID_H;y++){
    const row=[];
    for(let x=0;x<GRID_W;x++){
      const t=genTerrain(x,y);
      row.push({
        terrain:t,
        building:"none",
        level:0
      });
    }
    map.push(row);
  }

  map[11][11].building="town";
  map[11][11].level=1;

  return {
    ver:3,
    lastTick:now(),
    camera:{x:0,y:0,zoom:1},
    selected:{x:11,y:11},
    resources:{
      gold:500,
      aeno:50,
      wood:300,
      stone:200,
      iron:100,
      food:200
    },
    territoryRadius:4,
    map,
    ai:{
      name:"Aenko",
      x:11,y:11,
      px:0,py:0,
      mood:"ğŸ™‚",
      mode:"idle",
      adText:"AENO MUSIC",
      lastSpeak:0
    },
    robot:{
      active:false,
      x:0,y:0,
      stealTimer:0,
      adText:"AD"
    },
    beast:{
      timer: 90,
      wave:0,
      active:false
    },
    market:{
      prices:{
        wood:2,
        stone:3,
        iron:6,
        food:1
      }
    },
    stock:{
      planetIndex:0,
      lines:[]
    },
    tech:{
      points:0,
      unlocked:{
        farm:true,
        mine:true,
        factory:false,
        wall:false,
        tower:false
      }
    },
    ads:{
      cooldown:0,
      playing:false,
      lastReward:0
    },
    log:[]
  };
}

function saveGame(){
  localStorage.setItem(SAVE_KEY, JSON.stringify(state));
  toast("âœ… å·²å­˜æª”");
}

function loadGame(){
  try{
    const raw=localStorage.getItem(SAVE_KEY);
    if(!raw) return null;
    const obj=JSON.parse(raw);
    if(!obj || !obj.map) return null;
    return obj;
  }catch(e){
    return null;
  }
}

function resetGame(){
  localStorage.removeItem(SAVE_KEY);
  state=defaultState();
  toast("âš ï¸ å·²é‡ç½®ä¸–ç•Œ");
  pushLog("ä¸–ç•Œé‡ç½®ã€‚");
}

/* ---------- Terrain Generation ---------- */
function genTerrain(x,y){
  const dx=x-11, dy=y-11;
  const d=Math.sqrt(dx*dx+dy*dy);

  if(Math.abs((x*0.8 + y*0.3) - 14) < 1.2) return "river";
  if(d>9 && Math.random()<0.55) return "mountain";
  if(d>5 && d<9 && Math.random()<0.45) return "forest";
  if(Math.random()<0.08) return "ore";
  if(Math.random()<0.25) return "plain";
  return "grass";
}

/* ---------- Global State ---------- */
let state = loadGame() || defaultState();

/* ---------- UI ---------- */
const panel=document.getElementById("panel");
const panelBody=document.getElementById("panelBody");
const btnTogglePanel=document.getElementById("btnTogglePanel");
const btnSave=document.getElementById("btnSave");
const btnReset=document.getElementById("btnReset");

const chatFloat=document.getElementById("chatFloat");
const chatBody=document.getElementById("chatBody");
const chatInput=document.getElementById("chatInput");
const chatSend=document.getElementById("chatSend");
const btnChatMin=document.getElementById("btnChatMin");

const toastBox=document.getElementById("toast");

function toast(t){
  toastBox.innerText=t;
  toastBox.style.display="block";
  clearTimeout(toastBox._t);
  toastBox._t=setTimeout(()=>toastBox.style.display="none",1200);
}

btnTogglePanel.onclick=()=>{
  panel.classList.toggle("min");
};
btnSave.onclick=saveGame;
btnReset.onclick=()=>{
  if(confirm("ç¢ºå®šé‡ç½®ï¼Ÿæ‰€æœ‰é›¢ç·šå­˜æª”æœƒæ¶ˆå¤±ã€‚")){
    resetGame();
  }
};

btnChatMin.onclick=()=>{
  chatFloat.classList.toggle("min");
  btnChatMin.innerText=chatFloat.classList.contains("min")?"â—‚":"â–¸";
};

/* ---------- Logging ---------- */
function pushLog(msg){
  state.log.unshift({t:Date.now(),msg});
  state.log=state.log.slice(0,50);
}

/* ---------- Territory ---------- */
function isInsideTerritory(x,y){
  const cx=11, cy=11;
  const dx=x-cx, dy=y-cy;
  return (dx*dx+dy*dy) <= (state.territoryRadius*state.territoryRadius);
}

/* ---------- Economy ---------- */
function canAfford(cost){
  if(!cost) return true;
  for(const k in cost){
    if((state.resources[k]||0) < cost[k]) return false;
  }
  return true;
}
function pay(cost){
  for(const k in cost){
    state.resources[k]-=cost[k];
    if(state.resources[k]<0) state.resources[k]=0;
  }
}

function tryPayWithGoldOrAeno(extraGold){
  const need=extraGold;
  if(state.resources.gold>=need){
    state.resources.gold-=need;
    return true;
  }
  const missing=need-state.resources.gold;
  const aenoNeed=Math.ceil(missing/100);
  if(state.resources.aeno>=aenoNeed){
    state.resources.gold=0;
    state.resources.aeno-=aenoNeed;
    return true;
  }
  return false;
}

/* ---------- Build / Upgrade ---------- */
function placeBuilding(type){
  const {x,y}=state.selected;
  if(!isInsideTerritory(x,y)){
    toast("âš ï¸ ä¸åœ¨é ˜åœŸå…§");
    return;
  }
  const tile=state.map[y][x];
  if(tile.building!=="none"){
    toast("âš ï¸ å·²æœ‰å»ºç¯‰");
    return;
  }
  if(type==="factory" && !state.tech.unlocked.factory){
    toast("ğŸ”’ æœªè§£é–å·¥å» ");
    return;
  }
  if(type==="wall" && !state.tech.unlocked.wall){
    toast("ğŸ”’ æœªè§£é–åŸç‰†");
    return;
  }
  if(type==="tower" && !state.tech.unlocked.tower){
    toast("ğŸ”’ æœªè§£é–å®ˆè¡›å¡”");
    return;
  }

  const meta=buildingMeta[type];
  if(!meta){toast("éŒ¯èª¤");return;}

  if(!canAfford(meta.cost)){
    toast("è³‡æºä¸è¶³ï¼Œå¯ç”¨äº¤æ˜“æ‰€è²·");
    return;
  }
  pay(meta.cost);
  tile.building=type;
  tile.level=1;

  pushLog(`å»ºè¨­ï¼š${meta.name} Lv1`);
  toast("ğŸ— å·²å»ºè¨­");
}

function upgradeBuilding(){
  const {x,y}=state.selected;
  const tile=state.map[y][x];
  if(tile.building==="none"){toast("âš ï¸ å†‡å»ºç¯‰");return;}
  const lv=tile.level||1;
  if(lv>=5){toast("å·²æ»¿ç´š");return;}

  const meta=buildingMeta[tile.building];
  const base=meta.cost||{};
  const upCost={};
  for(const k in base){
    upCost[k]=Math.ceil(base[k]*(0.65+lv*0.45));
  }

  if(!canAfford(upCost)){
    toast("å‡ç´šè³‡æºä¸è¶³");
    return;
  }

  pay(upCost);
  tile.level=lv+1;
  pushLog(`å‡ç´šï¼š${meta.name} Lv${tile.level}`);
  toast("â¬†ï¸ å·²å‡ç´š");
}

function demolishBuilding(){
  const {x,y}=state.selected;
  const tile=state.map[y][x];
  if(tile.building==="none"){toast("âš ï¸ å†‡å»ºç¯‰");return;}
  pushLog(`æ‹†é™¤ï¼š${buildingMeta[tile.building].name}`);
  tile.building="none";
  tile.level=0;
  toast("ğŸ§¹ å·²æ‹†é™¤");
}

/* ---------- Expand Territory ---------- */
function expandTerritory(){
  const r=state.territoryRadius;
  const goldNeed = Math.floor(200 + r*r*120);
  const ok=tryPayWithGoldOrAeno(goldNeed);
  if(!ok){
    toast("é‡‘å¹£ä¸è¶³ï¼ˆå¯ç”¨AENOè£œï¼‰");
    return;
  }
  state.territoryRadius++;
  pushLog(`é ˜åœŸæ“´å¼µï¼šåŠå¾‘ ${state.territoryRadius}`);
  toast("ğŸŒ é ˜åœŸæ“´å¼µæˆåŠŸ");
}

/* ---------- Market ---------- */
function marketBuy(res,qty){
  qty=Math.max(1,Math.floor(qty));
  const price=state.market.prices[res]||1;
  const cost=qty*price;
  if(state.resources.gold<cost){
    toast("é‡‘å¹£ä¸è¶³");
    return;
  }
  state.resources.gold-=cost;
  state.resources[res]=(state.resources[res]||0)+qty;
  pushLog(`äº¤æ˜“æ‰€è²·å…¥ï¼š${res} x${qty} (-${cost}é‡‘å¹£)`);
  toast("ğŸ›’ å·²è²·å…¥");
}

function marketSell(res,qty){
  qty=Math.max(1,Math.floor(qty));
  if((state.resources[res]||0)<qty){
    toast("è³‡æºä¸è¶³");
    return;
  }
  const price=state.market.prices[res]||1;
  const gain=Math.floor(qty*price*0.85);
  state.resources[res]-=qty;
  state.resources.gold+=gain;
  pushLog(`äº¤æ˜“æ‰€è³£å‡ºï¼š${res} x${qty} (+${gain}é‡‘å¹£)`);
  toast("ğŸ’° å·²è³£å‡º");
}

/* ---------- Stock (simplified) ---------- */
function tickStock(){
  if(!state.stock.lines || state.stock.lines.length===0){
    state.stock.lines=[];
    for(let i=0;i<30;i++){
      state.stock.lines.push({
        wood:state.market.prices.wood,
        stone:state.market.prices.stone,
        iron:state.market.prices.iron,
        food:state.market.prices.food
      });
    }
  }

  const last=state.stock.lines[state.stock.lines.length-1];
  const next={...last};
  for(const k of ["wood","stone","iron","food"]){
    let v=next[k];
    v += rand(-0.6,0.6);
    v = clamp(v, 0.5, 30);
    next[k]=Math.round(v*10)/10;
    state.market.prices[k]=next[k];
  }
  state.stock.lines.push(next);
  state.stock.lines=state.stock.lines.slice(-60);
}

/* ---------- Tech Tree ---------- */
function gainTechPoints(n){
  state.tech.points += n;
}

function unlockTech(name,cost){
  if(state.tech.points<cost){
    toast("ç§‘æŠ€é»ä¸è¶³");
    return;
  }
  state.tech.points -= cost;

  if(name==="factory") state.tech.unlocked.factory=true;
  if(name==="wall") state.tech.unlocked.wall=true;
  if(name==="tower") state.tech.unlocked.tower=true;

  pushLog("ç§‘æŠ€è§£é–ï¼š"+name);
  toast("ğŸ§  å·²è§£é–ç§‘æŠ€");
}

/* ---------- Ads / Music ---------- */
function playAdSong(){
  if(state.ads.cooldown>0){
    toast("å†·å»ä¸­...");
    return;
  }
  state.ads.playing=true;
  state.ads.cooldown=45;
  pushLog("æ’­æ”¾è´ŠåŠ©æ­Œæ›²ä¸­...");
  toast("ğŸµ æ’­æ”¾ä¸­...");
  setTimeout(()=>{
    state.ads.playing=false;
    const reward=irand(60,140);
    state.resources.gold += reward;
    pushLog(`å»£å‘Šæ­Œæ›²å®Œæˆï¼š+${reward} é‡‘å¹£`);
    toast("ğŸ +"+reward+"é‡‘å¹£");
  }, 2500);
}

/* ---------- Robot Raid ---------- */
function spawnRobot(){
  state.robot.active=true;
  state.robot.x=irand(0,GRID_W-1);
  state.robot.y=irand(0,GRID_H-1);
  state.robot.stealTimer=15;
  state.robot.adText="SPONSOR";
  pushLog("ğŸ¤– æ©Ÿå™¨äººé™è½ï¼šå¯èƒ½æ å¥ªè³‡æºï¼");
  toast("ğŸ¤– æ©Ÿå™¨äººå…¥ä¾µï¼");
}

function robotSteal(){
  let def=0;
  for(let y=0;y<GRID_H;y++){
    for(let x=0;x<GRID_W;x++){
      const t=state.map[y][x];
      if(t.building==="wall") def += 0.3*(t.level||1);
      if(t.building==="tower") def += 0.6*(t.level||1);
    }
  }
  def=clamp(def,0,10);

  let stealRate=0.20 - def*0.01;
  stealRate=clamp(stealRate,0.05,0.20);

  const stolen={};
  for(const k of ["wood","stone","iron","food","gold"]){
    const amount=state.resources[k]||0;
    const s=Math.floor(amount*stealRate);
    state.resources[k]-=s;
    stolen[k]=s;
  }

  pushLog(`ğŸ¤– æ©Ÿå™¨äººæ å¥ªæˆåŠŸï¼šå·èµ° ${Math.floor(stealRate*100)}% è³‡æº`);
  toast("ğŸ’€ è¢«å·èµ°è³‡æº "+Math.floor(stealRate*100)+"%");
  state.robot.active=false;
}

/* ---------- Beast Tide ---------- */
function spawnBeastWave(){
  state.beast.active=true;
  state.beast.wave++;
  pushLog("ğŸº ç¸æ½®çˆ†ç™¼ï¼ç¬¬ "+state.beast.wave+" æ³¢");
  toast("ğŸº ç¸æ½®ä¾†è¥²ï¼");
}

function resolveBeast(){
  let def=0;
  for(let y=0;y<GRID_H;y++){
    for(let x=0;x<GRID_W;x++){
      const t=state.map[y][x];
      if(t.building==="wall") def += 0.5*(t.level||1);
      if(t.building==="tower") def += 1.0*(t.level||1);
      if(t.building==="town") def += 2.0*(t.level||1);
    }
  }
  const power=state.beast.wave*8;
  if(def>=power){
    pushLog("ğŸ›¡ ç¸æ½®è¢«æ“Šé€€ï¼ç²å¾—ç§‘æŠ€é»");
    gainTechPoints(irand(1,3));
    toast("ğŸ›¡ æˆåŠŸæŠµæ“‹ç¸æ½®ï¼");
  }else{
    let loss=0.15 + (power-def)*0.03;
    loss=clamp(loss,0.05,0.35);
    for(const k of ["wood","stone","iron","food","gold"]){
      state.resources[k]=Math.floor(state.resources[k]*(1-loss));
    }
    pushLog("âš ï¸ ç¸æ½®çªç ´é˜²ç¦¦ï¼Œè³‡æºæå¤±ï¼");
    toast("âš ï¸ é˜²ç¦¦ä¸è¶³ï¼Œè³‡æºå—æï¼");
  }
  state.beast.active=false;
  state.beast.timer=60 + state.beast.wave*12;
}

/* ---------- Auto Production ---------- */
function produceResources(){
  for(let y=0;y<GRID_H;y++){
    for(let x=0;x<GRID_W;x++){
      const t=state.map[y][x];
      const meta=buildingMeta[t.building];
      if(meta.prod){
        const mult=1 + (t.level-1)*0.4;
        for(const k in meta.prod){
          state.resources[k] += meta.prod[k] * mult;
        }
      }
    }
  }
}

/* ---------- Game Loop ---------- */
let lastSec=0;
let secCounter=0;

function gameLoop(){
  resize();
  const t=now();
  const dt=Math.min(0.1,(t-state.lastTick)/1000);
  state.lastTick=t;

  secCounter+=dt;
  if(secCounter>=1){
    secCounter=0;
    produceResources();
    tickStock();

    if(state.ads.cooldown>0) state.ads.cooldown--;

    if(!state.beast.active){
      state.beast.timer--;
      if(state.beast.timer<=0) spawnBeastWave();
    }

    if(state.robot.active){
      state.robot.stealTimer--;
      if(state.robot.stealTimer<=0) robotSteal();
    }

    if(Math.random()<0.015) spawnRobot();

    if(state.ai.mode==="patrol"){
      state.ai.x=clamp(state.ai.x+irand(-1,1),0,GRID_W-1);
      state.ai.y=clamp(state.ai.y+irand(-1,1),0,GRID_H-1);
    }
  }

  draw();
  requestAnimationFrame(gameLoop);
}

/* ---------- Draw Map å®Œæ•´é‚„åŸï¼šæ¨¹æœ¨ã€æ£®æ—ã€ç¤¦çŸ³ã€å»ºç¯‰åœ–å½¢ ---------- */
function draw(){
  const w=cv.width/devicePixelRatio;
  const h=cv.height/devicePixelRatio;
  ctx.clearRect(0,0,w,h);

  const ox=w/2 - GRID_W*TILE/2;
  const oy=h/2 - GRID_H*TILE/2;

  for(let y=0;y<GRID_H;y++){
    for(let x=0;x<GRID_W;x++){
      const tile=state.map[y][x];
      const cx=ox + x*TILE;
      const cy=oy + y*TILE;

      // åœ°å½¢åº•è‰²
      ctx.fillStyle=terrainColor[tile.terrain];
      ctx.fillRect(cx,cy,TILE-1,TILE-1);

      // ç•«æ£®æ— / æ¨¹æœ¨
      if(tile.terrain==="forest"){
        ctx.fillStyle="#16a34a";
        for(let i=0;i<3;i++){
          const tx=cx + 10 + i*15;
          const ty=cy + 10 + irand(-2,2);
          ctx.beginPath();
          ctx.arc(tx,ty,6,0,Math.PI*2);
          ctx.fill();
          ctx.fillRect(tx-2,ty+6,4,8);
        }
      }

      // ç•«ç¤¦çŸ³
      if(tile.terrain==="ore"){
        ctx.fillStyle="#f59e0b";
        ctx.beginPath();
        ctx.moveTo(cx+32,cy+10);
        ctx.lineTo(cx+50,cy+40);
        ctx.lineTo(cx+14,cy+40);
        ctx.closePath();
        ctx.fill();
      }

      // ç•«æ²³æµå‹•ç•«
      if(tile.terrain==="river"){
        ctx.fillStyle="#3b82f6";
        ctx.fillRect(cx+8,cy+8,TILE-16,TILE-16);
      }

      // é ˜åœŸé™°å½±
      if(!isInsideTerritory(x,y)){
        ctx.fillStyle="rgba(0,0,0,0.2)";
        ctx.fillRect(cx,cy,TILE-1,TILE-1);
      }

      // ç•«å»ºç¯‰åœ–å½¢ï¼ˆè¾²ç”°ã€ç¤¦å ´ã€å·¥å» ã€åŸç‰†ã€å¡”ã€åŸé®ï¼‰
      if(tile.building!=="none"){
        const meta=buildingMeta[tile.building];
        
        // è¾²ç”°
        if(tile.building==="farm"){
          ctx.fillStyle="#d9f99d";
          roundRectPath(ctx,cx+6,cy+6,TILE-12,TILE-12,4);
          ctx.fill();
          ctx.fillStyle="#16a34a";
          ctx.font="10px sans-serif";
          ctx.textAlign="center";
          ctx.fillText("è¾²ç”°",cx+TILE/2,cy+TILE/2+3);
        }

        // ç¤¦å ´
        if(tile.building==="mine"){
          ctx.fillStyle="#94a3b8";
          roundRectPath(ctx,cx+6,cy+6,TILE-12,TILE-12,4);
          ctx.fill();
          ctx.fillStyle="#0f172a";
          ctx.font="10px sans-serif";
          ctx.textAlign="center";
          ctx.fillText("ç¤¦å ´",cx+TILE/2,cy+TILE/2+3);
        }

        // å·¥å» 
        if(tile.building==="factory"){
          ctx.fillStyle="#cbd5e1";
          roundRectPath(ctx,cx+6,cy+6,TILE-12,TILE-12,4);
          ctx.fill();
          ctx.fillStyle="#0f172a";
          ctx.font="10px sans-serif";
          ctx.textAlign="center";
          ctx.fillText("å·¥å» ",cx+TILE/2,cy+TILE/2+3);
        }

        // åŸç‰†
        if(tile.building==="wall"){
          ctx.fillStyle="#64748b";
          ctx.fillRect(cx+4,cy+4,TILE-8,TILE-8);
        }

        // å®ˆè¡›å¡”
        if(tile.building==="tower"){
          ctx.fillStyle="#475569";
          roundRectPath(ctx,cx+8,cy+8,TILE-16,TILE-16,8);
          ctx.fill();
          ctx.fillStyle="#fff";
          ctx.font="10px sans-serif";
          ctx.textAlign="center";
          ctx.fillText("å¡”",cx+TILE/2,cy+TILE/2+3);
        }

        // åŸé®
        if(tile.building==="town"){
          ctx.fillStyle="#fbbf24";
          roundRectPath(ctx,cx+6,cy+6,TILE-12,TILE-12,8);
          ctx.fill();
          ctx.fillStyle="#fff";
          ctx.font="12px sans-serif";
          ctx.textAlign="center";
          ctx.fillText("åŸé®",cx+TILE/2,cy+TILE/2+3);
        }

        // ç­‰ç´š
        ctx.fillStyle="#fff";
        ctx.font="9px sans-serif";
        ctx.textAlign="right";
        ctx.fillText("Lv"+tile.level,cx+TILE-6,cy+12);
      }

      // é¸ä¸­æ ¼å­
      if(x===state.selected.x && y===state.selected.y){
        ctx.strokeStyle="#f43f5e";
        ctx.lineWidth=2;
        ctx.strokeRect(cx,cy,TILE-2,TILE-2);
      }
    }
  }

  // æ©Ÿå™¨äºº
  if(state.robot.active){
    const cx=ox + state.robot.x*TILE;
    const cy=oy + state.robot.y*TILE;
    ctx.fillStyle="#ef4444";
    roundRectPath(ctx,cx+8,cy+8,TILE-16,TILE-16,8);
    ctx.fill();
    ctx.fillStyle="#fff";
    ctx.font="10px monospace";
    ctx.textAlign="center";
    ctx.fillText("ROBOT",cx+TILE/2,cy+TILE/2+3);
  }

  // AI è§’è‰²
  const aix=ox + state.ai.x*TILE + TILE/2;
  const aiy=oy + state.ai.y*TILE + TILE/2;
  ctx.fillStyle="#8b5cf6";
  ctx.beginPath();
  ctx.arc(aix,aiy,14,0,Math.PI*2);
  ctx.fill();
  ctx.fillStyle="#fff";
  ctx.font="14px sans-serif";
  ctx.textAlign="center";
  ctx.fillText(state.ai.mood,aix,aiy+5);
}

/* ---------- Tab System ---------- */
document.querySelectorAll(".tab").forEach(tab=>{
  tab.onclick=()=>{
    document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
    tab.classList.add("active");
    renderTab(tab.dataset.tab);
  };
});

function renderTab(key){
  panelBody.innerHTML="";
  if(key==="home"){
    panelBody.innerHTML=`
<div class="card">
  <div class="label">è³‡æº</div>
  <div class="big">é‡‘å¹£ ${fmt(state.resources.gold)} | AENO ${fmt(state.resources.aeno)}</div>
  <div class="big">æœ¨ ${fmt(state.resources.wood)} | çŸ³ ${fmt(state.resources.stone)} | éµ ${fmt(state.resources.iron)} | ç³§ ${fmt(state.resources.food)}</div>
</div>
<div class="card">
  <div class="label">é ˜åœŸåŠå¾‘ ${state.territoryRadius}</div>
  <button class="btn gold" onclick="expandTerritory()">æ“´å¼µé ˜åœŸ</button>
</div>
<div class="card">
  <div class="label">ç¸æ½®å€’æ•¸ ${state.beast.timer}s | æ³¢æ•¸ ${state.beast.wave}</div>
  ${state.beast.active ? '<button class="btn red" onclick="resolveBeast()">æŠµæ“‹ç¸æ½®</button>' : ''}
</div>
`;
  }
  else if(key==="build"){
    panelBody.innerHTML=`
<div class="card">
  <div class="label">å»ºé€ </div>
  <div class="row">
    <button class="btn green" onclick="placeBuilding('farm')">è¾²ç”°</button>
    <button class="btn gray" onclick="placeBuilding('mine')">ç¤¦å ´</button>
    <button class="btn purple" onclick="placeBuilding('factory')">å·¥å» </button>
    <button class="btn" onclick="placeBuilding('wall')">åŸç‰†</button>
    <button class="btn gold" onclick="placeBuilding('tower')">å®ˆè¡›å¡”</button>
  </div>
</div>
<div class="card">
  <div class="label">ç›®å‰æ ¼å­</div>
  <button class="btn green" onclick="upgradeBuilding()">å‡ç´šå»ºç¯‰</button>
  <button class="btn red" onclick="demolishBuilding()">æ‹†é™¤</button>
</div>
`;
  }
  else if(key==="market"){
    panelBody.innerHTML=`
<div class="card">
  <div class="label">äº¤æ˜“æ‰€</div>
  <div class="row">
    <button class="btn" onclick="marketBuy('wood',20)">è²·æœ¨ x20</button>
    <button class="btn red" onclick="marketSell('wood',20)">è³£æœ¨ x20</button>
  </div>
  <div class="row" style="margin-top:6px">
    <button class="btn" onclick="marketBuy('stone',15)">è²·çŸ³ x15</button>
    <button class="btn red" onclick="marketSell('stone',15)">è³£çŸ³ x15</button>
  </div>
  <div class="row" style="margin-top:6px">
    <button class="btn" onclick="marketBuy('iron',10)">è²·éµ x10</button>
    <button class="btn red" onclick="marketSell('iron',10)">è³£éµ x10</button>
  </div>
  <div class="row" style="margin-top:6px">
    <button class="btn" onclick="marketBuy('food',50)">è²·ç³§ x50</button>
    <button class="btn red" onclick="marketSell('food',50)">è³£ç³§ x50</button>
  </div>
</div>
`;
  }
  else if(key==="tech"){
    panelBody.innerHTML=`
<div class="card">
  <div class="label">ç§‘æŠ€é» ${state.tech.points}</div>
  <button class="btn purple ${state.tech.unlocked.factory?'gray':''}" onclick="unlockTech('factory',2)">è§£é–å·¥å»  (2é»)</button>
  <button class="btn ${state.tech.unlocked.wall?'gray':''}" onclick="unlockTech('wall',3)">è§£é–åŸç‰† (3é»)</button>
  <button class="btn gold ${state.tech.unlocked.tower?'gray':''}" onclick="unlockTech('tower',4)">è§£é–å®ˆè¡›å¡” (4é»)</button>
</div>
`;
  }
  else if(key==="ads"){
    panelBody.innerHTML=`
<div class="card">
  <button class="btn purple" onclick="playAdSong()">ğŸµ æ’­æ”¾å»£å‘Šæ­Œæ›² + é‡‘å¹£</button>
  <div class="label" style="margin-top:8px">å†·å»: ${state.ads.cooldown}s</div>
</div>
`;
  }
  else{
    panelBody.innerHTML=`<div class="card"><div class="label">ç³»çµ±</div><div>é–‹ç™¼ä¸­</div></div>`;
  }
}

/* ---------- Chat AI ---------- */
function sendChat(){
  const txt=chatInput.value.trim();
  if(!txt) return;
  addMsg("me",txt);
  chatInput.value="";

  const t=txt.toLowerCase();
  let reply="";

  if(t.includes("å·¡é‚")){
    state.ai.mode="patrol";
    state.ai.mood="ğŸš¶";
    reply="é–‹å§‹å·¡é‚é ˜åœŸï½";
  }
  else if(t.includes("æ”¶é›†")){
    produceResources();
    reply="ç«‹å³æ”¶é›†æ›¬æ‰€æœ‰è³‡æºï¼";
  }
  else if(t.includes("å»ºé€ ") && t.includes("è¾²ç”°")){
    placeBuilding("farm");
    reply="å·²å¹«ä½ èµ·è¾²ç”°å•¦ï½";
  }
  else if(t.includes("å»ºé€ ") && t.includes("å·¥å» ")){
    placeBuilding("factory");
    reply="å·²å¹«ä½ èµ·å·¥å» å•¦ï½";
  }
  else if(t.includes("å‡ç´š")){
    upgradeBuilding();
    reply="å·²å¹«ä½ å‡ç´šå’—ï¼";
  }
  else{
    reply="è©¦ä¸‹è¬›ï¼šå·¡é‚ / æ”¶é›† / å»ºé€  è¾²ç”° / å‡ç´š / å»£å‘Š";
  }

  setTimeout(()=>{
    addMsg("ai",reply);
  },500);
}

function addMsg(who,text){
  const div=document.createElement("div");
  div.className="msg "+who;
  div.innerHTML=`<span class="who">${who==="ai"?"Aenko":"æˆ‘"}:</span> ${text}`;
  chatBody.appendChild(div);
  chatBody.scrollTop=chatBody.scrollHeight;
}

chatSend.onclick=sendChat;
chatInput.onkeydown=(e)=>{
  if(e.key==="Enter") sendChat();
};

/* ---------- Input ---------- */
cv.addEventListener("click",(e)=>{
  const rect=cv.getBoundingClientRect();
  const mx=(e.clientX-rect.left)/devicePixelRatio;
  const my=(e.clientY-rect.top)/devicePixelRatio;
  const w=cv.width/devicePixelRatio;
  const h=cv.height/devicePixelRatio;

  const ox=w/2 - GRID_W*TILE/2;
  const oy=h/2 - GRID_H*TILE/2;

  const x=Math.floor((mx-ox)/TILE);
  const y=Math.floor((my-oy)/TILE);

  if(x>=0 && x<GRID_W && y>=0 && y<GRID_H){
    state.selected.x=x;
    state.selected.y=y;
  }
});

/* ---------- Start ---------- */
resize();
renderTab("home");
gameLoop();
</script>
</body>
</html>
