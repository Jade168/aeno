<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>AENO V3ï¼ˆç›´å±ãƒ»å¡é€šæ–‡æ˜ï¼‰</title>

  <style>
    :root{
      --bg:#eaf6ff;
      --panel:#ffffffee;
      --panel2:#f8fbffef;
      --line:#cfe7ff;
      --text:#0b1220;
      --muted:#5b6b84;
      --good:#16a34a;
      --warn:#f59e0b;
      --bad:#ef4444;
      --blue:#2563eb;
      --shadow: 0 10px 30px rgba(0,0,0,0.12);
      --r:18px;
      --r2:24px;
    }

    html,body{
      margin:0;
      padding:0;
      background:var(--bg);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans HK", "PingFang HK", "Heiti TC", Arial;
      overflow:hidden;
      touch-action:none;
      user-select:none;
    }

    #wrap{
      position:fixed;
      inset:0;
      display:flex;
      justify-content:center;
      align-items:center;
    }

    #game{
      width:min(100vw, 520px);
      height:100vh;
      max-height:980px;
      background:linear-gradient(#cfeeff, #eaf6ff 35%, #eaf6ff);
      border-left: 1px solid rgba(0,0,0,0.06);
      border-right: 1px solid rgba(0,0,0,0.06);
      position:relative;
      overflow:hidden;
    }

    canvas{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
    }

    /* Top HUD */
    #topHUD{
      position:absolute;
      left:10px;
      right:10px;
      top:10px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      z-index:30;
      pointer-events:none;
    }

    .pill{
      pointer-events:auto;
      background:rgba(255,255,255,0.92);
      border:1px solid var(--line);
      border-radius:999px;
      padding:8px 12px;
      box-shadow: 0 8px 18px rgba(0,0,0,0.10);
      font-weight:800;
      font-size:12px;
      display:flex;
      align-items:center;
      gap:8px;
      color:var(--text);
      backdrop-filter: blur(8px);
    }

    .pill span{
      font-weight:700;
      color:var(--muted);
    }

    .pill b{
      font-size:12px;
      color:var(--text);
    }

    /* Floating Buttons */
    #floatBtns{
      position:absolute;
      right:10px;
      bottom:16px;
      z-index:40;
      display:flex;
      flex-direction:column;
      gap:10px;
      pointer-events:none;
    }

    .fab{
      pointer-events:auto;
      width:52px;
      height:52px;
      border-radius:16px;
      background:rgba(255,255,255,0.92);
      border:1px solid var(--line);
      box-shadow: var(--shadow);
      display:flex;
      justify-content:center;
      align-items:center;
      font-size:22px;
      font-weight:900;
      cursor:pointer;
      backdrop-filter: blur(8px);
    }

    .fab:active{
      transform: scale(0.97);
    }

    /* Panel */
    #panel{
      position:absolute;
      left:10px;
      right:10px;
      bottom:10px;
      z-index:50;
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:var(--r2);
      box-shadow: var(--shadow);
      overflow:hidden;
      transform-origin: bottom center;
      backdrop-filter: blur(10px);
    }

    #panelHead{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:10px 12px;
      border-bottom:1px solid rgba(0,0,0,0.06);
      background:linear-gradient(#ffffff, #f6fbff);
    }

    #panelHead .title{
      font-weight:900;
      font-size:13px;
      color:var(--text);
      display:flex;
      align-items:center;
      gap:8px;
    }

    #panelHead .title small{
      font-weight:800;
      color:var(--muted);
      font-size:11px;
    }

    #panelHead .btns{
      display:flex;
      gap:8px;
    }

    .btn{
      background:#fff;
      border:1px solid var(--line);
      border-radius:14px;
      padding:7px 10px;
      font-weight:900;
      font-size:12px;
      cursor:pointer;
      color:var(--text);
    }

    .btn:active{ transform:scale(0.98); }

    #panelBody{
      padding:10px 12px 12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      max-height:38vh;
      overflow:auto;
    }

    .row{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }

    .card{
      background:var(--panel2);
      border:1px solid rgba(0,0,0,0.06);
      border-radius:16px;
      padding:10px;
      flex:1;
      min-width:140px;
    }

    .card h4{
      margin:0 0 6px;
      font-size:12px;
      font-weight:900;
      color:var(--text);
    }

    .card p{
      margin:0;
      font-size:12px;
      color:var(--muted);
      font-weight:800;
      line-height:1.4;
    }

    .gridBtns{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:8px;
    }

    .gbtn{
      border-radius:14px;
      border:1px solid rgba(0,0,0,0.08);
      background:#fff;
      padding:10px 6px;
      font-weight:900;
      font-size:12px;
      cursor:pointer;
      box-shadow: 0 6px 14px rgba(0,0,0,0.06);
      text-align:center;
    }
    .gbtn:active{ transform:scale(0.98); }

    .hint{
      font-size:11px;
      font-weight:800;
      color:var(--muted);
      line-height:1.4;
    }

    /* Build Popup */
    #buildPopup{
      position:absolute;
      inset:0;
      z-index:70;
      display:none;
      justify-content:center;
      align-items:flex-end;
      padding:14px;
      background:rgba(0,0,0,0.25);
      backdrop-filter: blur(2px);
    }

    #buildPopup .box{
      width:100%;
      background:rgba(255,255,255,0.96);
      border:1px solid var(--line);
      border-radius:22px;
      box-shadow: var(--shadow);
      padding:12px;
      max-width:520px;
    }

    #buildPopup .box h3{
      margin:0 0 8px;
      font-size:14px;
      font-weight:1000;
      color:var(--text);
    }

    #buildPopup .box .desc{
      font-size:12px;
      color:var(--muted);
      font-weight:800;
      margin-bottom:10px;
      line-height:1.35;
    }

    #buildPopup .bgrid{
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap:10px;
    }

    .bitem{
      background:#fff;
      border:1px solid rgba(0,0,0,0.10);
      border-radius:18px;
      padding:10px;
      cursor:pointer;
      box-shadow: 0 6px 14px rgba(0,0,0,0.06);
    }

    .bitem:active{ transform:scale(0.99); }

    .bitem .name{
      font-weight:1000;
      font-size:13px;
      margin-bottom:4px;
    }

    .bitem .cost{
      font-size:11px;
      color:var(--muted);
      font-weight:900;
    }

    .bitem .tip{
      font-size:11px;
      color:#2563eb;
      font-weight:900;
      margin-top:6px;
    }

    #buildPopup .closeRow{
      display:flex;
      justify-content:space-between;
      margin-top:10px;
      gap:10px;
    }

    .closeBtn{
      flex:1;
      border-radius:16px;
      padding:10px;
      border:1px solid rgba(0,0,0,0.10);
      background:#fff;
      font-weight:1000;
      cursor:pointer;
    }

    /* Assistant Chat */
    #chat{
      position:absolute;
      left:10px;
      right:10px;
      bottom:120px;
      z-index:60;
      display:none;
    }

    #chatBox{
      background:rgba(255,255,255,0.96);
      border:1px solid var(--line);
      border-radius:22px;
      box-shadow: var(--shadow);
      padding:10px;
    }

    #chatBox .head{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:6px;
    }

    #chatBox .head b{
      font-size:13px;
      font-weight:1000;
      color:var(--text);
    }

    #chatBox .log{
      height:120px;
      overflow:auto;
      border-radius:16px;
      background:#f7fbff;
      border:1px solid rgba(0,0,0,0.06);
      padding:8px;
      font-size:12px;
      color:var(--text);
      font-weight:800;
      line-height:1.4;
    }

    #chatBox .inputRow{
      display:flex;
      gap:8px;
      margin-top:8px;
    }

    #chatInput{
      flex:1;
      border-radius:16px;
      border:1px solid rgba(0,0,0,0.10);
      padding:10px;
      font-weight:900;
      font-size:12px;
      outline:none;
    }

    #sendBtn{
      border-radius:16px;
      border:1px solid rgba(0,0,0,0.10);
      background:#fff;
      padding:10px 14px;
      font-weight:1000;
      cursor:pointer;
    }

    /* Toast */
    #toast{
      position:absolute;
      left:50%;
      transform:translateX(-50%);
      top:64px;
      z-index:80;
      background:rgba(0,0,0,0.78);
      color:#fff;
      padding:10px 14px;
      border-radius:999px;
      font-weight:900;
      font-size:12px;
      display:none;
      max-width:90%;
      text-align:center;
    }
  </style>
</head>

<body>
<div id="wrap">
  <div id="game">
    <canvas id="cv"></canvas>

    <div id="toast"></div>

    <div id="topHUD">
      <div class="pill" id="pillRes">ğŸŒ² <b>æœ¨</b> <span id="wood">0</span>ã€€ğŸª¨ <b>çŸ³</b> <span id="stone">0</span>ã€€â›“ï¸ <b>éµ</b> <span id="iron">0</span></div>
      <div class="pill" id="pillMoney">ğŸª™ <b>é‡‘å¹£</b> <span id="gold">0</span>ã€€ğŸ’ <b>AENO</b> <span id="aeno">0.000</span></div>
    </div>

    <div id="floatBtns">
      <div class="fab" id="btnZoomIn">ï¼‹</div>
      <div class="fab" id="btnZoomOut">ï¼</div>
      <div class="fab" id="btnPanel">â‰¡</div>
    </div>

    <div id="chat">
      <div id="chatBox">
        <div class="head">
          <b>ğŸ¾ AENO åŠ©æ‰‹</b>
          <button class="btn" id="chatClose">æ”¶èµ·</button>
        </div>
        <div class="log" id="chatLog"></div>
        <div class="inputRow">
          <input id="chatInput" placeholder="è¼¸å…¥æŒ‡ä»¤ï¼šå»ºé€ ã€å·¡é‚ã€æ”¶é›†ã€å‡ç´šã€åœæ­¢è‡ªå‹•..." />
          <button id="sendBtn">é€å‡º</button>
        </div>
      </div>
    </div>

    <div id="panel">
      <div id="panelHead">
        <div class="title">ğŸ§  AENO æ§åˆ¶é¢æ¿ <small>ï¼ˆå¯æ”¶èµ·ï¼‰</small></div>
        <div class="btns">
          <button class="btn" id="btnAuto">è‡ªå‹•ï¼šON</button>
          <button class="btn" id="btnAd">æ’­æ”¾æ­Œ</button>
          <button class="btn" id="btnHide">æ”¶èµ·</button>
        </div>
      </div>

      <div id="panelBody">
        <div class="row">
          <div class="card">
            <h4>ğŸ‘¥ äººå£ / å·¥äºº</h4>
            <p>äººå£ï¼š<b id="pop">4</b>ã€€å·¥äººï¼š<b id="workers">4</b></p>
            <p>é ˜åœŸï¼š<b id="land">16</b> æ ¼</p>
          </div>
          <div class="card">
            <h4>ğŸ¦– ä¸–ç•Œç‹€æ…‹</h4>
            <p>å¹´ä»£ï¼š<b id="year">-500000000</b></p>
            <p>ç¸æ½®ï¼š<b id="beast">æœªè§¸ç™¼</b></p>
          </div>
        </div>

        <div class="card">
          <h4>ğŸ—ï¸ å»ºé€  / æŒ‡ä»¤</h4>
          <div class="gridBtns">
            <button class="gbtn" id="gHouse">æˆ¿å±‹</button>
            <button class="gbtn" id="gLumber">ä¼æœ¨å ´</button>
            <button class="gbtn" id="gMine">ç¤¦å ´</button>
            <button class="gbtn" id="gFarm">è¾²ç”°</button>
            <button class="gbtn" id="gFactory">å·¥å» </button>
            <button class="gbtn" id="gMarket">äº¤æ˜“æ‰€</button>
            <button class="gbtn" id="gRobot">æ´¾æ©Ÿå™¨äºº</button>
            <button class="gbtn" id="gTech">ç§‘æŠ€æ¨¹</button>
          </div>
          <div class="hint" style="margin-top:8px;">
            æç¤ºï¼šä½ å¯ä»¥ã€Œç›´æ¥é»åœ°åœ–ç©ºåœ°ã€å½ˆå‡ºå»ºç¯‰æ¸…å–®ã€‚
          </div>
        </div>

        <div class="card">
          <h4>ğŸ’¡ ç³»çµ±æç¤º</h4>
          <p id="sysMsg">ä¸–ç•Œåˆå§‹åŒ–å®Œæˆã€‚é»ç©ºåœ°å¯ä»¥å»ºé€ ã€‚</p>
        </div>

        <div class="card">
          <h4>ğŸ”’ é›¢ç·šå¤–æ›è¦å‰‡</h4>
          <p>é›¢ç·šæœ€å¤šè£œç®— <b>24å°æ™‚</b>ï¼Œè¶…éæœƒåœæ­¢ã€‚</p>
        </div>
      </div>
    </div>

    <div id="buildPopup">
      <div class="box">
        <h3>ğŸ—ï¸ å»ºé€ é¸å–®</h3>
        <div class="desc" id="buildDesc">è«‹é¸æ“‡è¦å»ºé€ çš„è¨­æ–½ã€‚</div>

        <div class="bgrid" id="bgrid"></div>

        <div class="closeRow">
          <button class="closeBtn" id="cancelBuild">å–æ¶ˆ</button>
          <button class="closeBtn" id="confirmBuild">ç¢ºèªå»ºé€ </button>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
(() => {
  "use strict";

  const cv = document.getElementById("cv");
  const ctx = cv.getContext("2d");

  const ui = {
    wood: document.getElementById("wood"),
    stone: document.getElementById("stone"),
    iron: document.getElementById("iron"),
    gold: document.getElementById("gold"),
    aeno: document.getElementById("aeno"),
    pop: document.getElementById("pop"),
    workers: document.getElementById("workers"),
    land: document.getElementById("land"),
    year: document.getElementById("year"),
    beast: document.getElementById("beast"),
    sysMsg: document.getElementById("sysMsg"),
    toast: document.getElementById("toast"),
    panel: document.getElementById("panel"),
    btnPanel: document.getElementById("btnPanel"),
    btnHide: document.getElementById("btnHide"),
    btnZoomIn: document.getElementById("btnZoomIn"),
    btnZoomOut: document.getElementById("btnZoomOut"),
    btnAuto: document.getElementById("btnAuto"),
    btnAd: document.getElementById("btnAd"),
    chat: document.getElementById("chat"),
    chatLog: document.getElementById("chatLog"),
    chatInput: document.getElementById("chatInput"),
    sendBtn: document.getElementById("sendBtn"),
    chatClose: document.getElementById("chatClose"),
    buildPopup: document.getElementById("buildPopup"),
    bgrid: document.getElementById("bgrid"),
    cancelBuild: document.getElementById("cancelBuild"),
    confirmBuild: document.getElementById("confirmBuild"),
    buildDesc: document.getElementById("buildDesc"),
  };

  const TILE = 64;
  const GRID = 26;

  function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }

  function rand(a,b){ return a + Math.random()*(b-a); }
  function randi(a,b){ return Math.floor(rand(a,b+1)); }

  function now(){ return Date.now(); }

  function showToast(msg){
    ui.toast.style.display = "block";
    ui.toast.textContent = msg;
    clearTimeout(showToast._t);
    showToast._t = setTimeout(()=> ui.toast.style.display="none", 1600);
  }

  function drawRoundedRect(x,y,w,h,r){
    r = Math.min(r, w/2, h/2);
    ctx.beginPath();
    ctx.moveTo(x+r, y);
    ctx.arcTo(x+w, y, x+w, y+h, r);
    ctx.arcTo(x+w, y+h, x, y+h, r);
    ctx.arcTo(x, y+h, x, y, r);
    ctx.arcTo(x, y, x+w, y, r);
    ctx.closePath();
  }

  function saveState(){
    localStorage.setItem("AENO_V3_SAVE", JSON.stringify(state));
    localStorage.setItem("AENO_V3_SAVE_TIME", String(now()));
  }

  function loadState(){
    try{
      const raw = localStorage.getItem("AENO_V3_SAVE");
      if(!raw) return false;
      const data = JSON.parse(raw);
      if(!data) return false;
      Object.assign(state, data);
      return true;
    }catch(e){
      return false;
    }
  }

  function applyOfflineProgress(){
    const t = Number(localStorage.getItem("AENO_V3_SAVE_TIME") || 0);
    if(!t) return;

    const dt = now() - t;
    const max = 24 * 3600 * 1000;

    if(dt <= 3000) return;

    if(dt > max){
      ui.sysMsg.textContent = "é›¢ç·šè¶…é24å°æ™‚ï¼Œå¤–æ›å·²åœæ­¢ï¼Œéœ€è¦é‡æ–°å•Ÿå‹•ã€‚";
      showToast("é›¢ç·šå¤ªä¹…ï¼šå¤–æ›åœæ­¢");
      return;
    }

    const sec = dt / 1000;

    if(state.autoOn){
      const woodGain = Math.floor(sec * 0.35);
      const stoneGain = Math.floor(sec * 0.18);
      const ironGain = Math.floor(sec * 0.08);
      const goldGain = Math.floor(sec * 0.25);

      state.res.wood += woodGain;
      state.res.stone += stoneGain;
      state.res.iron += ironGain;
      state.gold += goldGain;

      ui.sysMsg.textContent = `é›¢ç·šè£œç®—ï¼šæœ¨+${woodGain} çŸ³+${stoneGain} éµ+${ironGain} é‡‘+${goldGain}`;
      showToast("å·²è£œç®—é›¢ç·šæ”¶ç›Š");
    }
  }

  const BUILDINGS = {
    house: { name:"æˆ¿å±‹", icon:"ğŸ ", cost:{wood:25, stone:10, iron:0, gold:30}, desc:"å¢åŠ äººå£ä¸Šé™ï¼Œæ–‡æ˜åŸºç¤ã€‚" },
    lumber: { name:"ä¼æœ¨å ´", icon:"ğŸª“", cost:{wood:10, stone:5, iron:0, gold:20}, desc:"è‡ªå‹•ç”¢æœ¨ï¼Œå¿…é ˆé è¿‘æ£®æ—æ›´å¿«ã€‚" },
    mine: { name:"ç¤¦å ´", icon:"â›ï¸", cost:{wood:15, stone:20, iron:0, gold:40}, desc:"ç”¢å‡ºçŸ³é ­èˆ‡éµç¤¦ã€‚" },
    farm: { name:"è¾²ç”°", icon:"ğŸŒ¾", cost:{wood:20, stone:5, iron:0, gold:20}, desc:"ç”¢ç³§é£Ÿï¼Œæé«˜äººå£æˆé•·ã€‚" },
    factory: { name:"å·¥å» ", icon:"ğŸ­", cost:{wood:40, stone:40, iron:20, gold:80}, desc:"ä¸­å¾ŒæœŸå»ºç¯‰ï¼Œè£½é€ æ©Ÿå™¨äººã€‚" },
    market: { name:"äº¤æ˜“æ‰€", icon:"ğŸ¦", cost:{wood:35, stone:25, iron:10, gold:90}, desc:"é–‹å•Ÿè³‡æºè²·è³£åŠŸèƒ½ã€‚" }
  };

  const state = {
    ver: 3,
    camera: { x: GRID/2, y: GRID/2, zoom: 1.15 },
    autoOn: true,

    world: {
      seed: randi(100000,999999),
      year: -500000000,
      beastReady: false,
      beastTimer: 0,
    },

    res: { wood: 120, stone: 80, iron: 30 },
    gold: 200,
    aeno: 0.0,

    pop: 4,
    workers: 4,

    tiles: [],
    buildings: [],
    entities: [],
    fragments: 0,

    adScore: 0,
    learnScore: 0,
    buildScore: 0,
    ecoScore: 0,
    activeScore: 0,

    lastTick: now(),
    lastSave: now(),
  };

  function makeWorld(){
    state.tiles = [];
    for(let y=0;y<GRID;y++){
      for(let x=0;x<GRID;x++){
        let t = "grass";
        const edge = (x<2 || y<2 || x>GRID-3 || y>GRID-3);

        if(edge && Math.random()<0.5) t="water";
        else{
          const r = Math.random();
          if(r < 0.08) t="forest";
          else if(r < 0.12) t="rock";
          else if(r < 0.14) t="iron";
          else if(r < 0.18) t="hill";
          else t="grass";
        }

        state.tiles.push({x,y,type:t});
      }
    }

    const cx = Math.floor(GRID/2);
    const cy = Math.floor(GRID/2);

    // Make sure near center have forest + rock + iron
    setTile(cx+2, cy-1, "forest");
    setTile(cx-2, cy+1, "forest");
    setTile(cx+1, cy+2, "rock");
    setTile(cx-1, cy+2, "rock");
    setTile(cx, cy-2, "iron");

    // Clear player base zone
    for(let dy=-2; dy<=2; dy++){
      for(let dx=-2; dx<=2; dx++){
        setTile(cx+dx, cy+dy, "grass");
      }
    }

    // initial buildings
    addBuilding("house", cx, cy);
    addBuilding("house", cx+1, cy);
  }

  function getTile(x,y){
    if(x<0||y<0||x>=GRID||y>=GRID) return null;
    return state.tiles[y*GRID + x];
  }

  function setTile(x,y,type){
    const t = getTile(x,y);
    if(t) t.type = type;
  }

  function isOccupied(x,y){
    return state.buildings.some(b => b.x===x && b.y===y);
  }

  function addBuilding(type,x,y){
    state.buildings.push({
      id: "B"+Math.random().toString(16).slice(2),
      type,
      x,y,
      lv:1,
      hp:100
    });
    state.buildScore += 5;
  }

  function spawnEntities(){
    state.entities = [];

    const cx = Math.floor(GRID/2);
    const cy = Math.floor(GRID/2);

    // Workers
    for(let i=0;i<state.workers;i++){
      state.entities.push({
        kind:"worker",
        x: cx + rand(-1.2,1.2),
        y: cy + rand(-1.2,1.2),
        vx:0, vy:0,
        t:0
      });
    }

    // Assistant animal (ad slot on head)
    state.entities.push({
      kind:"assistant",
      x: cx + 0.3,
      y: cy - 0.6,
      vx:0, vy:0,
      t:0,
      mood: "ğŸ™‚"
    });

    // Animals
    for(let i=0;i<5;i++){
      state.entities.push({
        kind:"animal",
        x: cx + rand(-5,5),
        y: cy + rand(-5,5),
        vx:0, vy:0,
        t:0
      });
    }

    // Beasts
    for(let i=0;i<3;i++){
      state.entities.push({
        kind:"beast",
        x: cx + rand(-8,8),
        y: cy + rand(-8,8),
        vx:0, vy:0,
        t:0
      });
    }
  }

  function screenSize(){
    const rect = cv.getBoundingClientRect();
    return {w: rect.width, h: rect.height};
  }

  function resize(){
    const rect = cv.getBoundingClientRect();
    const dpr = Math.min(2, window.devicePixelRatio || 1);
    cv.width = Math.floor(rect.width * dpr);
    cv.height = Math.floor(rect.height * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }

  function tileToScreen(tx,ty){
    const {w,h} = screenSize();
    const zoom = state.camera.zoom;

    const px = (tx - state.camera.x) * TILE * zoom + w/2;
    const py = (ty - state.camera.y) * TILE * zoom + h/2;

    return {x:px, y:py};
  }

  function screenToTile(px,py){
    const {w,h} = screenSize();
    const zoom = state.camera.zoom;

    const tx = (px - w/2)/(TILE*zoom) + state.camera.x;
    const ty = (py - h/2)/(TILE*zoom) + state.camera.y;

    return {x:tx, y:ty};
  }

  function drawTile(t){
    const p = tileToScreen(t.x,t.y);
    const z = state.camera.zoom;

    const size = TILE * z;
    const x = p.x - size/2;
    const y = p.y - size/2;

    let col = "#d7fbe3";
    if(t.type==="forest") col = "#b7f7c9";
    if(t.type==="rock") col = "#e5e7eb";
    if(t.type==="iron") col = "#d1d5db";
    if(t.type==="hill") col = "#c7f9cc";
    if(t.type==="water") col = "#bde4ff";

    ctx.fillStyle = col;
    drawRoundedRect(x,y,size,size, 14*z);
    ctx.fill();

    ctx.strokeStyle = "rgba(0,0,0,0.06)";
    ctx.lineWidth = 2;
    ctx.stroke();

    if(t.type==="forest"){
      ctx.fillStyle = "rgba(16,185,129,0.65)";
      ctx.beginPath();
      ctx.arc(p.x - 10*z, p.y + 6*z, 10*z, 0, Math.PI*2);
      ctx.arc(p.x + 10*z, p.y - 4*z, 12*z, 0, Math.PI*2);
      ctx.fill();
    }

    if(t.type==="rock"){
      ctx.fillStyle = "rgba(100,116,139,0.55)";
      ctx.beginPath();
      ctx.arc(p.x, p.y, 10*z, 0, Math.PI*2);
      ctx.fill();
    }

    if(t.type==="iron"){
      ctx.fillStyle = "rgba(75,85,99,0.55)";
      ctx.beginPath();
      ctx.arc(p.x, p.y, 11*z, 0, Math.PI*2);
      ctx.fill();
      ctx.fillStyle = "rgba(239,68,68,0.35)";
      ctx.beginPath();
      ctx.arc(p.x+5*z, p.y-3*z, 4*z, 0, Math.PI*2);
      ctx.fill();
    }

    if(t.type==="water"){
      ctx.fillStyle = "rgba(59,130,246,0.25)";
      ctx.beginPath();
      ctx.arc(p.x, p.y, 16*z, 0, Math.PI*2);
      ctx.fill();
    }
  }

  function drawBuilding(b){
    const p = tileToScreen(b.x,b.y);
    const z = state.camera.zoom;

    let w = 44*z;
    let h = 44*z;

    ctx.save();
    ctx.translate(p.x, p.y);

    // shadow
    ctx.fillStyle = "rgba(0,0,0,0.18)";
    ctx.beginPath();
    ctx.ellipse(0, 18*z, 22*z, 10*z, 0, 0, Math.PI*2);
    ctx.fill();

    if(b.type==="house"){
      // body
      ctx.fillStyle = "#fff3c4";
      drawRoundedRect(-w/2, -h/2+4*z, w, h, 14*z);
      ctx.fill();

      // roof
      ctx.fillStyle = "#ffd87a";
      ctx.beginPath();
      ctx.moveTo(-w/2-6*z, -h/2+10*z);
      ctx.quadraticCurveTo(0, -h/2-18*z, w/2+6*z, -h/2+10*z);
      ctx.lineTo(w/2, -h/2+18*z);
      ctx.quadraticCurveTo(0, -h/2-8*z, -w/2, -h/2+18*z);
      ctx.closePath();
      ctx.fill();

      // door
      ctx.fillStyle = "#d97706";
      drawRoundedRect(-7*z, 6*z, 14*z, 18*z, 6*z);
      ctx.fill();

      // windows
      ctx.fillStyle = "#bde4ff";
      ctx.beginPath();
      ctx.arc(-14*z, 0, 6*z, 0, Math.PI*2);
      ctx.arc(14*z, 0, 6*z, 0, Math.PI*2);
      ctx.fill();
    }

    if(b.type==="lumber"){
      ctx.fillStyle = "#fff3c4";
      drawRoundedRect(-w/2, -h/2+6*z, w, h, 14*z);
      ctx.fill();

      ctx.fillStyle = "#16a34a";
      ctx.beginPath();
      ctx.arc(0, -h/2+4*z, 16*z, 0, Math.PI*2);
      ctx.fill();

      ctx.fillStyle = "#92400e";
      drawRoundedRect(-6*z, 0, 12*z, 18*z, 6*z);
      ctx.fill();

      ctx.fillStyle = "#111827";
      ctx.font = `${12*z}px system-ui`;
      ctx.fillText("ğŸª“", -6*z, 14*z);
    }

    if(b.type==="mine"){
      ctx.fillStyle = "#f1f5f9";
      drawRoundedRect(-w/2, -h/2+6*z, w, h, 14*z);
      ctx.fill();

      ctx.fillStyle = "#94a3b8";
      ctx.beginPath();
      ctx.arc(0, -8*z, 18*z, 0, Math.PI*2);
      ctx.fill();

      ctx.fillStyle = "#111827";
      ctx.font = `${12*z}px system-ui`;
      ctx.fillText("â›ï¸", -8*z, 16*z);
    }

    if(b.type==="farm"){
      ctx.fillStyle = "#fff3c4";
      drawRoundedRect(-w/2, -h/2+6*z, w, h, 14*z);
      ctx.fill();

      ctx.fillStyle = "#22c55e";
      drawRoundedRect(-18*z, -4*z, 36*z, 16*z, 10*z);
      ctx.fill();

      ctx.fillStyle = "#111827";
      ctx.font = `${12*z}px system-ui`;
      ctx.fillText("ğŸŒ¾", -7*z, 14*z);
    }

    if(b.type==="factory"){
      ctx.fillStyle = "#e0f2fe";
      drawRoundedRect(-w/2, -h/2+6*z, w, h, 14*z);
      ctx.fill();

      ctx.fillStyle = "#93c5fd";
      drawRoundedRect(-18*z, -16*z, 36*z, 14*z, 10*z);
      ctx.fill();

      ctx.fillStyle = "#111827";
      ctx.font = `${12*z}px system-ui`;
      ctx.fillText("ğŸ­", -8*z, 16*z);
    }

    if(b.type==="market"){
      ctx.fillStyle = "#fff3c4";
      drawRoundedRect(-w/2, -h/2+6*z, w, h, 14*z);
      ctx.fill();

      ctx.fillStyle = "#60a5fa";
      drawRoundedRect(-20*z, -14*z, 40*z, 12*z, 10*z);
      ctx.fill();

      ctx.fillStyle = "#111827";
      ctx.font = `${12*z}px system-ui`;
      ctx.fillText("ğŸ¦", -8*z, 16*z);
    }

    ctx.restore();
  }

  function drawEntity(e){
    const p = tileToScreen(e.x, e.y);
    const z = state.camera.zoom;

    ctx.save();
    ctx.translate(p.x, p.y);

    // shadow
    ctx.fillStyle = "rgba(0,0,0,0.16)";
    ctx.beginPath();
    ctx.ellipse(0, 12*z, 14*z, 7*z, 0, 0, Math.PI*2);
    ctx.fill();

    if(e.kind==="worker"){
      // body
      ctx.fillStyle = "#fde68a";
      ctx.beginPath();
      ctx.arc(0, 0, 10*z, 0, Math.PI*2);
      ctx.fill();

      // head
      ctx.fillStyle = "#fff";
      ctx.beginPath();
      ctx.arc(0, -12*z, 9*z, 0, Math.PI*2);
      ctx.fill();

      ctx.fillStyle = "#111827";
      ctx.beginPath();
      ctx.arc(-3*z, -13*z, 1.5*z, 0, Math.PI*2);
      ctx.arc(3*z, -13*z, 1.5*z, 0, Math.PI*2);
      ctx.fill();
    }

    if(e.kind==="animal"){
      ctx.fillStyle = "#bbf7d0";
      ctx.beginPath();
      ctx.arc(0, 0, 10*z, 0, Math.PI*2);
      ctx.fill();
      ctx.fillStyle = "#111827";
      ctx.font = `${10*z}px system-ui`;
      ctx.fillText("ğŸ¿ï¸", -7*z, 4*z);
    }

    if(e.kind==="beast"){
      ctx.fillStyle = "#fecaca";
      ctx.beginPath();
      ctx.arc(0, 0, 12*z, 0, Math.PI*2);
      ctx.fill();
      ctx.fillStyle = "#111827";
      ctx.font = `${11*z}px system-ui`;
      ctx.fillText("ğŸ¦–", -8*z, 4*z);
    }

    if(e.kind==="assistant"){
      // assistant animal body
      ctx.fillStyle = "#bfdbfe";
      ctx.beginPath();
      ctx.arc(0, 0, 13*z, 0, Math.PI*2);
      ctx.fill();

      // face
      ctx.fillStyle = "#111827";
      ctx.font = `${12*z}px system-ui`;
      ctx.fillText("ğŸ¾", -8*z, 5*z);

      // ad flag
      ctx.fillStyle = "#ffffff";
      drawRoundedRect(-16*z, -30*z, 32*z, 12*z, 8*z);
      ctx.fill();
      ctx.strokeStyle = "rgba(0,0,0,0.10)";
      ctx.stroke();

      ctx.fillStyle = "#2563eb";
      ctx.font = `${8*z}px system-ui`;
      ctx.fillText("AD", -8*z, -21*z);
    }

    ctx.restore();
  }

  function updateUI(){
    ui.wood.textContent = Math.floor(state.res.wood);
    ui.stone.textContent = Math.floor(state.res.stone);
    ui.iron.textContent = Math.floor(state.res.iron);
    ui.gold.textContent = Math.floor(state.gold);
    ui.aeno.textContent = state.aeno.toFixed(3);

    ui.pop.textContent = state.pop;
    ui.workers.textContent = state.workers;
    ui.land.textContent = 16 + Math.floor(state.buildings.length * 2);
    ui.year.textContent = state.world.year;
  }

  function assistantSay(text){
    ui.chatLog.innerHTML += `<div>ğŸ¾ ${text}</div>`;
    ui.chatLog.scrollTop = ui.chatLog.scrollHeight;
  }

  function handleChatCommand(cmd){
    cmd = (cmd||"").trim().toLowerCase();
    if(!cmd) return;

    ui.chatLog.innerHTML += `<div style="color:#2563eb;">ä½ ï¼š${cmd}</div>`;

    if(cmd.includes("åœæ­¢")){
      state.autoOn = false;
      ui.btnAuto.textContent = "è‡ªå‹•ï¼šOFF";
      assistantSay("æ”¶åˆ°ï¼å·²åœæ­¢è‡ªå‹•å»ºè¨­ï¼Œä½†æ”¶è³‡æºä»æœƒè‡ªå‹•ã€‚");
      return;
    }

    if(cmd.includes("è‡ªå‹•") || cmd.includes("é–‹å§‹")){
      state.autoOn = true;
      ui.btnAuto.textContent = "è‡ªå‹•ï¼šON";
      assistantSay("æ˜ç™½ï¼æˆ‘æœƒå¹«ä½ è‡ªå‹•å»ºé€ èˆ‡å‡ç´šã€‚");
      return;
    }

    if(cmd.includes("æ”¶é›†")){
      assistantSay("æˆ‘å·²æ´¾å·¥äººå·¡é‚é™„è¿‘æ£®æ—ã€ç¤¦è„ˆèˆ‡é‡ç¸ã€‚");
      state.ecoScore += 2;
      return;
    }

    if(cmd.includes("å»ºé€ ") || cmd.includes("èµ·")){
      assistantSay("ä½ å¯ä»¥ç›´æ¥é»ç©ºåœ°å»ºé€ ï¼Œæˆ‘æœƒå„ªå…ˆèµ·æˆ¿å±‹èˆ‡ä¼æœ¨å ´ã€‚");
      return;
    }

    if(cmd.includes("å·¡é‚")){
      assistantSay("å·¡é‚é–‹å§‹ã€‚é‡ç¸ç¢ç‰‡æ‰è½ç‡æå‡ã€‚");
      state.activeScore += 2;
      return;
    }

    assistantSay("æˆ‘è½å””æ˜ï¼Œä½ å¯ä»¥è©¦ï¼šå»ºé€ ã€æ”¶é›†ã€å·¡é‚ã€åœæ­¢è‡ªå‹•ã€‚");
  }

  function canPay(cost){
    if(state.res.wood < cost.wood) return false;
    if(state.res.stone < cost.stone) return false;
    if(state.res.iron < cost.iron) return false;
    if(state.gold < cost.gold) return false;
    return true;
  }

  function pay(cost){
    state.res.wood -= cost.wood;
    state.res.stone -= cost.stone;
    state.res.iron -= cost.iron;
    state.gold -= cost.gold;
  }

  let buildTarget = null;
  let buildChoice = null;

  function openBuildPopup(tx,ty){
    buildTarget = {x:tx,y:ty};
    buildChoice = null;

    ui.bgrid.innerHTML = "";

    const list = ["house","lumber","mine","farm","factory","market"];
    list.forEach(k=>{
      const b = BUILDINGS[k];
      const div = document.createElement("div");
      div.className = "bitem";

      div.innerHTML = `
        <div class="name">${b.icon} ${b.name}</div>
        <div class="cost">æˆæœ¬ï¼šæœ¨${b.cost.wood} çŸ³${b.cost.stone} éµ${b.cost.iron} é‡‘${b.cost.gold}</div>
        <div class="tip">${b.desc}</div>
      `;

      div.onclick = ()=>{
        buildChoice = k;
        ui.buildDesc.textContent = `å·²é¸æ“‡ï¼š${b.name}ï¼ˆé»ã€Œç¢ºèªå»ºé€ ã€å®Œæˆï¼‰`;
        showToast(`å·²é¸ï¼š${b.name}`);
      };

      ui.bgrid.appendChild(div);
    });

    ui.buildPopup.style.display = "flex";
  }

  function closeBuildPopup(){
    ui.buildPopup.style.display = "none";
    buildTarget = null;
    buildChoice = null;
  }

  function confirmBuild(){
    if(!buildTarget || !buildChoice){
      showToast("è«‹å…ˆé¸æ“‡å»ºç¯‰");
      return;
    }

    const {x,y} = buildTarget;
    const t = getTile(x,y);

    if(!t){
      showToast("ä½ç½®ç„¡æ•ˆ");
      return;
    }

    if(t.type==="water"){
      showToast("æ°´é¢ä¸å¯å»ºé€ ");
      return;
    }

    if(isOccupied(x,y)){
      showToast("æ­¤æ ¼å·²æœ‰å»ºç¯‰");
      return;
    }

    const info = BUILDINGS[buildChoice];
    if(!canPay(info.cost)){
      ui.sysMsg.textContent = "è³‡æºä¸è¶³ï¼Œå…ˆæ´¾å·¥äººæ”¶é›†æœ¨çŸ³éµã€‚";
      showToast("è³‡æºä¸è¶³");
      closeBuildPopup();
      return;
    }

    pay(info.cost);
    addBuilding(buildChoice, x, y);
    state.ecoScore += 3;

    ui.sysMsg.textContent = `å»ºé€ å®Œæˆï¼š${info.name}`;
    showToast(`å»ºé€ ï¼š${info.name}`);
    closeBuildPopup();
  }

  function doAdPlay(){
    state.adScore += 10;
    state.gold += 30;
    state.fragments += 1;

    ui.sysMsg.textContent = "ä½ æ’­æ”¾å’—å»£å‘Šæ­Œï¼ˆæ¸¬è©¦ç‰ˆï¼‰ï¼Œç²å¾—é‡‘å¹£èˆ‡AENOç¢ç‰‡ã€‚";
    showToast("æ’­æ”¾å®Œæˆ +é‡‘å¹£ +ç¢ç‰‡");

    assistantSay("å»£å‘Šä½å·²è¨˜éŒ„ã€‚æœªä¾†å»£å‘Šå•†å¯ä¸Šå‚³æ­Œæ›²/éŸ³è¨Šï¼Œä¸éœ€æ›´æ–°ç¨‹å¼ã€‚");
  }

  function secretAenoMint(){
    // Hidden-style mapping (not readable)
    const s = String(state.world.seed) + String(state.adScore) + String(state.learnScore) + String(state.buildScore);
    let h = 0;
    for(let i=0;i<s.length;i++){
      h = (h * 33 + s.charCodeAt(i) + 7) % 1000000;
    }

    // fragments => aeno (slow)
    if(state.fragments >= 20){
      state.fragments -= 20;

      const base = (h % 37) / 1000; // 0.000~0.036
      const extra = clamp(state.adScore/5000, 0, 0.08);

      // final small mint
      const gain = clamp(base + extra, 0.002, 0.09);

      state.aeno += gain;
      ui.sysMsg.textContent = `AENO åˆæˆæˆåŠŸ +${gain.toFixed(3)}ï¼ˆç¢ç‰‡-20ï¼‰`;
      showToast(`AENO +${gain.toFixed(3)}`);
    }
  }

  function updateEconomy(dt){
    const sec = dt / 1000;

    // Time speed: 1 day real = 10 years game
    const yearsPerSec = (10 / 86400);
    state.world.year += Math.floor(sec * yearsPerSec);

    let woodRate = 0.10;
    let stoneRate = 0.05;
    let ironRate = 0.02;
    let goldRate = 0.06;

    // building effects
    state.buildings.forEach(b=>{
      if(b.type==="house"){
        goldRate += 0.01;
      }
      if(b.type==="lumber"){
        woodRate += 0.20;
      }
      if(b.type==="mine"){
        stoneRate += 0.14;
        ironRate += 0.06;
      }
      if(b.type==="farm"){
        goldRate += 0.04;
      }
      if(b.type==="factory"){
        goldRate += 0.07;
        ironRate += 0.02;
      }
      if(b.type==="market"){
        goldRate += 0.10;
      }
    });

    // workers boost
    woodRate += state.workers * 0.03;
    stoneRate += state.workers * 0.015;
    ironRate += state.workers * 0.006;

    // apply
    state.res.wood += sec * woodRate;
    state.res.stone += sec * stoneRate;
    state.res.iron += sec * ironRate;
    state.gold += sec * goldRate;

    // active score small
    state.activeScore += sec * 0.2;

    // auto build (slow, controlled)
    if(state.autoOn){
      autoBuildLogic();
    }

    // Beast fragments chance
    state.world.beastTimer += sec;
    if(state.world.beastTimer > 45){
      state.world.beastTimer = 0;
      if(state.buildings.length >= 10){
        ui.beast.textContent = "âš”ï¸ ç¸æ½®ä¾†è¥²ï¼";
        state.fragments += 3;
        state.gold += 15;
        ui.sysMsg.textContent = "ç¸æ½®æˆ°åˆ©å“ï¼šç¢ç‰‡+3 é‡‘å¹£+15";
        showToast("ç¸æ½®ï¼šç¢ç‰‡+3");
      }else{
        ui.beast.textContent = "æœªé”æˆï¼ˆåŸé®æœªå®Œæ•´ï¼‰";
      }
    }

    secretAenoMint();
  }

  function autoBuildLogic(){
    // ensure early game works: prioritize lumber + mine + house
    const hasLumber = state.buildings.some(b=>b.type==="lumber");
    const hasMine = state.buildings.some(b=>b.type==="mine");

    if(!hasLumber){
      tryAutoBuild("lumber");
      return;
    }
    if(!hasMine){
      tryAutoBuild("mine");
      return;
    }

    // expand housing if gold enough
    if(state.pop < 10){
      tryAutoBuild("house");
      return;
    }

    // add farm then market
    if(!state.buildings.some(b=>b.type==="farm")){
      tryAutoBuild("farm");
      return;
    }

    if(!state.buildings.some(b=>b.type==="market")){
      tryAutoBuild("market");
      return;
    }
  }

  function tryAutoBuild(type){
    const info = BUILDINGS[type];
    if(!canPay(info.cost)) return;

    const cx = Math.floor(state.camera.x);
    const cy = Math.floor(state.camera.y);

    for(let r=1;r<8;r++){
      for(let dy=-r;dy<=r;dy++){
        for(let dx=-r;dx<=r;dx++){
          const x = cx + dx;
          const y = cy + dy;
          const t = getTile(x,y);
          if(!t) continue;
          if(t.type==="water") continue;
          if(isOccupied(x,y)) continue;

          pay(info.cost);
          addBuilding(type,x,y);

          ui.sysMsg.textContent = `åŠ©æ‰‹è‡ªå‹•å»ºé€ ï¼š${info.name}`;
          return;
        }
      }
    }
  }

  function updateEntities(dt){
    const sec = dt/1000;

    state.entities.forEach(e=>{
      e.t += sec;

      if(e.t > 2.0){
        e.t = 0;
        e.vx = rand(-0.8,0.8);
        e.vy = rand(-0.8,0.8);
      }

      let spd = 0.35;
      if(e.kind==="assistant") spd = 0.22;
      if(e.kind==="animal") spd = 0.28;
      if(e.kind==="beast") spd = 0.18;

      e.x += e.vx * sec * spd;
      e.y += e.vy * sec * spd;

      e.x = clamp(e.x, 2, GRID-3);
      e.y = clamp(e.y, 2, GRID-3);
    });
  }

  function render(){
    const {w,h} = screenSize();

    ctx.clearRect(0,0,w,h);

    // background
    ctx.fillStyle = "#eaf6ff";
    ctx.fillRect(0,0,w,h);

    // visible tiles
    const zoom = state.camera.zoom;
    const rangeX = Math.ceil(w/(TILE*zoom)) + 3;
    const rangeY = Math.ceil(h/(TILE*zoom)) + 3;

    const cx = Math.floor(state.camera.x);
    const cy = Math.floor(state.camera.y);

    for(let y=cy-rangeY; y<=cy+rangeY; y++){
      for(let x=cx-rangeX; x<=cx+rangeX; x++){
        const t = getTile(x,y);
        if(t) drawTile(t);
      }
    }

    // buildings
    state.buildings.forEach(drawBuilding);

    // entities
    state.entities.forEach(drawEntity);

    // border
    ctx.strokeStyle = "rgba(0,0,0,0.06)";
    ctx.lineWidth = 3;
    drawRoundedRect(6,6,w-12,h-12, 22);
    ctx.stroke();
  }

  function tick(){
    try{
      const t = now();
      const dt = clamp(t - state.lastTick, 0, 80);
      state.lastTick = t;

      updateEconomy(dt);
      updateEntities(dt);

      updateUI();
      render();

      if(t - state.lastSave > 2500){
        saveState();
        state.lastSave = t;
      }

    }catch(e){
      ui.sysMsg.textContent = "ç³»çµ±éŒ¯èª¤ï¼šrender loop å·²ä¿è­·ï¼Œè«‹åˆ·æ–°ã€‚";
    }

    requestAnimationFrame(tick);
  }

  // input / camera
  let isDown = false;
  let last = {x:0,y:0};

  cv.addEventListener("pointerdown", (ev)=>{
    isDown = true;
    last.x = ev.clientX;
    last.y = ev.clientY;
  });

  cv.addEventListener("pointermove", (ev)=>{
    if(!isDown) return;
    const dx = ev.clientX - last.x;
    const dy = ev.clientY - last.y;

    last.x = ev.clientX;
    last.y = ev.clientY;

    state.camera.x -= dx / (TILE * state.camera.zoom);
    state.camera.y -= dy / (TILE * state.camera.zoom);

    state.camera.x = clamp(state.camera.x, 2, GRID-3);
    state.camera.y = clamp(state.camera.y, 2, GRID-3);
  });

  cv.addEventListener("pointerup", ()=>{
    isDown = false;
  });

  cv.addEventListener("pointercancel", ()=>{
    isDown = false;
  });

  cv.addEventListener("click", (ev)=>{
    const rect = cv.getBoundingClientRect();
    const x = ev.clientX - rect.left;
    const y = ev.clientY - rect.top;

    const t = screenToTile(x,y);
    const tx = Math.floor(t.x);
    const ty = Math.floor(t.y);

    const assistant = state.entities.find(e=>e.kind==="assistant");
    if(assistant){
      const ap = tileToScreen(assistant.x, assistant.y);
      const dist = Math.hypot(ap.x - x, ap.y - y);
      if(dist < 45){
        ui.chat.style.display = "block";
        assistantSay("ä½ å¥½ï¼Œæˆ‘ä¿‚ä½ å˜…æ–‡æ˜åŠ©æ‰‹ã€‚ä½ å¯ä»¥è¼¸å…¥ï¼šå»ºé€ ã€æ”¶é›†ã€å·¡é‚ã€åœæ­¢è‡ªå‹•ã€‚");
        return;
      }
    }

    const tile = getTile(tx,ty);
    if(!tile) return;

    if(tile.type==="water"){
      showToast("æ°´é¢ä¸å¯å»ºé€ ");
      return;
    }

    if(isOccupied(tx,ty)){
      showToast("æ­¤æ ¼å·²æœ‰å»ºç¯‰");
      return;
    }

    openBuildPopup(tx,ty);
  });

  // UI buttons
  ui.btnZoomIn.onclick = ()=>{
    state.camera.zoom = clamp(state.camera.zoom + 0.15, 0.6, 2.4);
    showToast("æ”¾å¤§");
  };
  ui.btnZoomOut.onclick = ()=>{
    state.camera.zoom = clamp(state.camera.zoom - 0.15, 0.6, 2.4);
    showToast("ç¸®å°");
  };

  ui.btnPanel.onclick = ()=>{
    ui.panel.style.display = (ui.panel.style.display==="none") ? "block" : "none";
  };

  ui.btnHide.onclick = ()=>{
    ui.panel.style.display = "none";
    showToast("é¢æ¿å·²æ”¶èµ·ï¼ˆå³ä¸‹â‰¡å¯é–‹ï¼‰");
  };

  ui.btnAuto.onclick = ()=>{
    state.autoOn = !state.autoOn;
    ui.btnAuto.textContent = state.autoOn ? "è‡ªå‹•ï¼šON" : "è‡ªå‹•ï¼šOFF";
    showToast(state.autoOn ? "åŠ©æ‰‹è‡ªå‹•å»ºè¨­å·²é–‹" : "åŠ©æ‰‹è‡ªå‹•å»ºè¨­å·²é—œ");
  };

  ui.btnAd.onclick = ()=>{
    doAdPlay();
  };

  ui.chatClose.onclick = ()=>{
    ui.chat.style.display = "none";
  };

  ui.sendBtn.onclick = ()=>{
    const v = ui.chatInput.value;
    ui.chatInput.value = "";
    handleChatCommand(v);
  };

  ui.chatInput.addEventListener("keydown", (e)=>{
    if(e.key==="Enter"){
      ui.sendBtn.click();
    }
  });

  ui.cancelBuild.onclick = closeBuildPopup;
  ui.confirmBuild.onclick = confirmBuild;

  // quick build buttons
  document.getElementById("gHouse").onclick = ()=> showToast("è«‹é»ç©ºåœ°å»ºé€ æˆ¿å±‹");
  document.getElementById("gLumber").onclick = ()=> showToast("è«‹é»ç©ºåœ°å»ºé€ ä¼æœ¨å ´");
  document.getElementById("gMine").onclick = ()=> showToast("è«‹é»ç©ºåœ°å»ºé€ ç¤¦å ´");
  document.getElementById("gFarm").onclick = ()=> showToast("è«‹é»ç©ºåœ°å»ºé€ è¾²ç”°");
  document.getElementById("gFactory").onclick = ()=> showToast("è«‹é»ç©ºåœ°å»ºé€ å·¥å» ");
  document.getElementById("gMarket").onclick = ()=> showToast("è«‹é»ç©ºåœ°å»ºé€ äº¤æ˜“æ‰€");

  document.getElementById("gRobot").onclick = ()=>{
    if(state.gold < 50){
      showToast("é‡‘å¹£ä¸è¶³ï¼ˆéœ€è¦50ï¼‰");
      return;
    }
    state.gold -= 50;
    state.ecoScore += 5;
    state.fragments += 2;
    ui.sysMsg.textContent = "ä½ æ´¾å‡ºæ©Ÿå™¨äººå» 20 æ˜Ÿçƒéš¨æ©Ÿæ¢ç´¢ï¼ˆæ¸¬è©¦ç‰ˆï¼‰ï¼Œå¸¶å›ç¢ç‰‡+2";
    showToast("æ©Ÿå™¨äººå‡ºç™¼ï¼");
  };

  document.getElementById("gTech").onclick = ()=>{
    showToast("ç§‘æŠ€æ¨¹ï¼ˆæ¸¬è©¦ç‰ˆï¼‰");
    state.buildScore += 2;
  };

  document.getElementById("gMarket").onclick = ()=>{
    showToast("äº¤æ˜“æ‰€ï¼ˆæ¸¬è©¦ç‰ˆï¼‰");
    state.ecoScore += 2;
  };

  // init
  function init(){
    resize();
    window.addEventListener("resize", resize);

    const loaded = loadState();

    if(!loaded){
      makeWorld();
      spawnEntities();
      saveState();
      ui.sysMsg.textContent = "æ–°ä¸–ç•Œå·²ç”Ÿæˆï¼š2æˆ¿å±‹+4å·¥äººã€‚é»ç©ºåœ°å»ºé€ ã€‚";
      showToast("AENO V3 å·²é–‹å§‹");
    }else{
      // if missing tiles (older save)
      if(!state.tiles || state.tiles.length < GRID*GRID){
        makeWorld();
      }
      if(!state.entities || state.entities.length < 1){
        spawnEntities();
      }

      applyOfflineProgress();
      ui.sysMsg.textContent = "å·²è®€å–å­˜æª”ï¼ˆå¯é›¢ç·šè£œç®—24å°æ™‚ï¼‰ã€‚";
      showToast("å­˜æª”å·²è¼‰å…¥");
    }

    updateUI();
    requestAnimationFrame(tick);
  }

  init();

})();
</script>
</body>
</html>
