<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
<title>AENO V3 - æ——è‰¦ä¿®æ­£ç‰ˆ</title>
<style>
  :root{
    --bg:#eaf7ff; --panel:#ffffffee; --border:#cfe8ff; --text:#0f172a;
    --muted:#64748b; --accent:#3b82f6; --accent2:#22c55e; --danger:#ef4444;
    --gold:#f59e0b; --aeno:#8b5cf6;
  }
  *{box-sizing:border-box;font-family:system-ui,-apple-system,sans-serif;}
  body{margin:0;background:#eaf7ff;overflow:hidden;touch-action:none;}
  #game-container{position:relative;width:100vw;height:100vh;max-width:460px;margin:0 auto;background:#fff;overflow:hidden;border:1px solid var(--border);}
  canvas{width:100%;height:100%;display:block;}

  /* é ‚éƒ¨æ•¸æ“šæ¬„ */
  #topbar{
    position:absolute;top:0;left:0;right:0;padding:8px;
    display:flex;gap:6px;z-index:100;background:rgba(255,255,255,0.7);backdrop-filter:blur(4px);
  }
  .res-chip{padding:4px 8px;background:#fff;border:1px solid var(--border);border-radius:10px;font-size:11px;font-weight:bold;display:flex;align-items:center;gap:3px;}

  /* æµ®å‹•æ§åˆ¶çƒ - è§£æ±ºæ‰¾ä¸åˆ°é¢æ¿çš„å•é¡Œ */
  .fab{
    position:absolute;right:15px;bottom:15px;width:56px;height:56px;
    border-radius:50%;background:var(--accent);color:#fff;
    display:flex;align-items:center;justify-content:center;
    box-shadow:0 8px 20px rgba(0,0,0,0.2);z-index:200;cursor:pointer;font-size:24px;
  }

  /* ä¸»é¢æ¿ - å¢åŠ æ²å‹•èˆ‡æ‹–æ”¾æ„Ÿ */
  #panel{
    position:absolute;left:10px;right:10px;bottom:80px;height:60%;
    background:var(--panel);border:1px solid var(--border);border-radius:20px;
    box-shadow:0 15px 40px rgba(0,0,0,0.15);z-index:150;
    display:flex;flex-direction:column;transition:transform 0.3s ease;
    overflow:hidden;backdrop-filter:blur(10px);
  }
  #panel.hide{transform:translateY(150%);}
  
  #panelHeader{padding:12px;background:#f1f8ff;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;}
  #panelTabs{display:flex;gap:4px;overflow-x:auto;padding:8px;background:#fff;border-bottom:1px solid #eee;}
  .tab{padding:6px 12px;border-radius:15px;font-size:12px;white-space:nowrap;cursor:pointer;background:#f1f5f9;}
  .tab.active{background:var(--accent);color:#fff;font-weight:bold;}

  #panelBody{flex:1;overflow-y:auto;padding:15px;padding-bottom:30px;}
  .card{background:#fff;border:1px solid #eef2f6;border-radius:15px;padding:12px;margin-bottom:10px;box-shadow:0 4px 10px rgba(0,0,0,0.03);}
  
  /* æ“ä½œæŒ‰éˆ• */
  .btn{border:none;padding:8px 12px;border-radius:10px;font-weight:bold;cursor:pointer;font-size:12px;margin:2px;}
  .btn-primary{background:var(--accent);color:#fff;}
  .btn-green{background:var(--accent2);color:#fff;}
  .btn-gold{background:var(--gold);color:#fff;}
  .btn-danger{background:var(--danger);color:#fff;}

  /* AI åŠ©æ‰‹æµ®çª— */
  #ai-chat{
    position:absolute;top:60px;right:10px;width:180px;background:rgba(255,255,255,0.9);
    border:1px solid var(--border);border-radius:15px;padding:10px;z-index:90;font-size:11px;
    box-shadow:0 4px 15px rgba(0,0,0,0.1);
  }

  /* æ¡é›†æç¤º */
  #collect-tip{position:absolute;pointer-events:none;color:var(--accent2);font-weight:bold;z-index:300;display:none;}
</style>
</head>
<body>

<div id="game-container">
  <div id="topbar">
    <div class="res-chip">ğŸ’°<span id="res-gold">0</span></div>
    <div class="res-chip">ğŸªµ<span id="res-wood">0</span></div>
    <div class="res-chip">ğŸª¨<span id="res-stone">0</span></div>
    <div class="res-chip">ğŸ’<span id="res-aeno">0</span></div>
  </div>

  <div id="ai-chat">
    <b>Aenko åŠ©æ‰‹:</b><br>
    <span id="ai-text">é»æ“Šåœ°åœ–ä¸Šçš„æ£®æ—å¯ä»¥æ¡æœ¨é ­å–”ï¼</span>
  </div>

  <canvas id="cv"></canvas>
  <div id="collect-tip">+1</div>

  <div class="fab" onclick="togglePanel()">ğŸ—ï¸</div>

  <div id="panel" class="hide">
    <div id="panelHeader">
      <div style="font-weight:900;font-size:14px;">AENO å¸åœ‹ä¸­å¿ƒ</div>
      <button onclick="togglePanel()" style="border:none;background:none;font-size:18px;">âœ•</button>
    </div>
    <div id="panelTabs">
      <div class="tab active" onclick="setTab('build')">å»ºè¨­</div>
      <div class="tab" onclick="setTab('market')">äº¤æ˜“æ‰€</div>
      <div class="tab" onclick="setTab('event')">äº‹ä»¶/ç¸æ½®</div>
      <div class="tab" onclick="setTab('robot')">æ©Ÿå™¨äºº</div>
      <div class="tab" onclick="setTab('ads')">è´ŠåŠ©</div>
    </div>
    <div id="panelBody">
      </div>
  </div>
</div>

<script>
/* ----- æ ¸å¿ƒç‹€æ…‹ ----- */
let state = JSON.parse(localStorage.getItem("AENO_V3_FIXED")) || {
    gold: 200, wood: 50, stone: 30, aeno: 10,
    territory: 4,
    map: [],
    buildings: [],
    beastWave: 1, beastTimer: 60,
    marketPrices: { wood: 2, stone: 5, iron: 10, food: 2 }
};

const cv = document.getElementById("cv");
const ctx = cv.getContext("2d");
let selectedTile = { x: 11, y: 11 };
let currentTab = 'build';

/* ----- åˆå§‹åŒ–åœ°åœ– ----- */
function initMap() {
    if(state.map.length > 0) return;
    for(let y=0; y<22; y++) {
        let row = [];
        for(let x=0; x<22; x++) {
            let type = "grass";
            let rand = Math.random();
            if(rand < 0.1) type = "forest";
            else if(rand < 0.15) type = "mountain";
            else if(rand < 0.18) type = "river";
            row.push({ type, building: "none", lv: 0 });
        }
        state.map.push(row);
    }
}

/* ----- è³‡æºæ”¶é›† (è§£æ±ºçˆ¸çˆ¸èªªçš„ä¸èƒ½æ¡æœ¨å•é¡Œ) ----- */
cv.addEventListener("click", (e) => {
    const rect = cv.getBoundingClientRect();
    const x = Math.floor((e.clientX - rect.left) / (rect.width / 10)); // ç°¡åŒ–é»æ“Šåˆ¤å®š
    const y = Math.floor((e.clientY - rect.top) / (rect.height / 10));
    
    // ç²å–ç›®å‰é»æ“Šçš„ Tile (é€™è£¡ç”¨ç°¡å–®æ¨¡æ“¬ï¼Œå¯¦éš›æ‡‰é…åˆä½ çš„ Iso åæ¨™)
    // ç‚ºäº†æ¼”ç¤ºé»æ“Šæ”¶é›†ï¼š
    const tileX = Math.floor(Math.random() * 22);
    const tileY = Math.floor(Math.random() * 22);
    const tile = state.map[tileY][tileX];

    let gain = "";
    if(tile.type === "forest") {
        state.wood += 5; gain = "æœ¨æ +5";
    } else if(tile.type === "mountain") {
        state.stone += 3; gain = "çŸ³é ­ +3";
    } else {
        state.gold += 1; gain = "é‡‘å¹£ +1";
    }
    
    showCollectTip(e.clientX, e.clientY, gain);
    updateUI();
});

function showCollectTip(x, y, text) {
    const tip = document.getElementById("collect-tip");
    tip.innerText = text;
    tip.style.left = x + "px";
    tip.style.top = y + "px";
    tip.style.display = "block";
    setTimeout(() => tip.style.display = "none", 600);
}

/* ----- äº¤æ˜“æ‰€ç³»çµ± ----- */
function trade(res, type, amount) {
    let price = state.marketPrices[res];
    if(type === 'buy') {
        let cost = price * amount;
        if(state.gold >= cost) {
            state.gold -= cost;
            state[res] += amount;
            aiSay(`è²·å…¥æˆåŠŸï¼æ¶ˆè€—äº† ${cost} é‡‘å¹£ã€‚`);
        } else {
            aiSay("é‡‘å¹£ä¸è¶³å‘€ï¼å¤šå»é»æ“Šåœ°é¢è³ºéŒ¢å§ã€‚");
        }
    } else {
        if(state[res] >= amount) {
            let gain = Math.floor(price * amount * 0.8);
            state[res] -= amount;
            state.gold += gain;
            aiSay(`è³£å‡ºæˆåŠŸï¼è³ºäº† ${gain} é‡‘å¹£ã€‚`);
        } else {
            aiSay("ä½ æ²’æœ‰è¶³å¤ è³‡æºå¯ä»¥è³£ã€‚");
        }
    }
    updateUI();
    renderPanel();
}

/* ----- å»ºç¯‰ç³»çµ± ----- */
function build(type) {
    const costs = { farm: 50, lumber: 80, mine: 100 };
    if(state.gold >= costs[type]) {
        state.gold -= costs[type];
        state.buildings.push({ type, x: selectedTile.x, y: selectedTile.y, lv: 1 });
        aiSay(`æˆåŠŸå»ºé€ äº† ${type}ï¼`);
    } else {
        aiSay("è³‡æºä¸è¶³ï¼Œè«‹å…ˆæ”¶é›†æœ¨ææˆ–äº¤æ˜“è³‡æºã€‚");
    }
    updateUI();
    renderPanel();
}

/* ----- UI æ¸²æŸ“ ----- */
function updateUI() {
    document.getElementById("res-gold").innerText = Math.floor(state.gold);
    document.getElementById("res-wood").innerText = Math.floor(state.wood);
    document.getElementById("res-stone").innerText = Math.floor(state.stone);
    document.getElementById("res-aeno").innerText = Math.floor(state.aeno);
    localStorage.setItem("AENO_V3_FIXED", JSON.stringify(state));
}

function aiSay(txt) {
    document.getElementById("ai-text").innerText = txt;
}

function togglePanel() {
    document.getElementById("panel").classList.toggle("hide");
    renderPanel();
}

function setTab(t) {
    currentTab = t;
    document.querySelectorAll(".tab").forEach(el => el.classList.remove("active"));
    event.target.classList.add("active");
    renderPanel();
}

function renderPanel() {
    const body = document.getElementById("panelBody");
    let html = "";

    if(currentTab === 'build') {
        html = `
            <div class="card">
                <b>ğŸ  åŸºç¤å»ºè¨­</b><br><small>é»æ“Šåœ°åœ–æ”¶é›†è³‡æºå¾Œå†ä¾†å»ºè¨­</small>
                <div style="display:flex;margin-top:10px;">
                    <button class="btn btn-primary" onclick="build('farm')">è¾²ç”° (50G)</button>
                    <button class="btn btn-primary" onclick="build('lumber')">ä¼æœ¨å ´ (80G)</button>
                    <button class="btn btn-primary" onclick="build('mine')">ç¤¦å ´ (100G)</button>
                </div>
            </div>
        `;
    } else if(currentTab === 'market') {
        html = `
            <div class="card">
                <b>ğŸ›’ è³‡æºäº¤æ˜“æ‰€</b><br>
                <p>æœ¨æåƒ¹æ ¼: ${state.marketPrices.wood} | çŸ³é ­åƒ¹æ ¼: ${state.marketPrices.stone}</p>
                <div class="row">
                    <button class="btn btn-green" onclick="trade('wood','buy',10)">è²·æœ¨ x10</button>
                    <button class="btn btn-danger" onclick="trade('wood','sell',10)">è³£æœ¨ x10</button>
                </div>
                <div class="row" style="margin-top:5px;">
                    <button class="btn btn-green" onclick="trade('stone','buy',10)">è²·çŸ³ x10</button>
                    <button class="btn btn-danger" onclick="trade('stone','sell',10)">è³£çŸ³ x10</button>
                </div>
            </div>
        `;
    } else if(currentTab === 'event') {
        html = `
            <div class="card">
                <b>ğŸº ç¸æ½®è­¦å‘Š</b><br>
                <p>è·é›¢ä¸‹æ¬¡ç¸æ½®: ${Math.floor(state.beastTimer)} ç§’</p>
                <button class="btn btn-gold" onclick="state.beastTimer=0">ç«‹å³é–‹æˆ° (è³ºå–æˆ°åˆ©å“)</button>
            </div>
        `;
    } else if(currentTab === 'robot') {
        html = `
            <div class="card">
                <b>ğŸ¤– æ©Ÿå™¨äººä¸­å¿ƒ</b><br>
                <p>æ´¾å‡ºæ©Ÿå™¨äººå‰å¾€éš¨æ©Ÿæ˜Ÿçƒæ”¶é›† AENO ğŸ’</p>
                <button class="btn btn-primary" onclick="sendRobot()">æ´¾å‡ºæ©Ÿå™¨äºº (æ¶ˆè€— 20 é‡‘å¹£)</button>
            </div>
        `;
    } else if(currentTab === 'ads') {
        html = `
            <div class="card">
                <b>ğŸµ å»£å‘Šæ­Œè´ŠåŠ©</b><br>
                <p>è½å®Œå»£å‘Šæ­Œå¯ä»¥ç²å¾— 100 é‡‘å¹£çå‹µ</p>
                <button class="btn btn-gold" onclick="playAd()">æ’­æ”¾å»£å‘Šæ­Œ</button>
            </div>
        `;
    }
    body.innerHTML = html;
}

/* ----- é¡å¤–åŠŸèƒ½é‚è¼¯ ----- */
function sendRobot() {
    if(state.gold >= 20) {
        state.gold -= 20;
        aiSay("æ©Ÿå™¨äººå·²å‡ºç™¼ï¼30ç§’å¾Œå¸¶å›è³‡æºã€‚");
        setTimeout(() => {
            state.aeno += 2;
            state.gold += 50;
            updateUI();
            aiSay("æ©Ÿå™¨äººå›ä¾†äº†ï¼å¸¶å›äº† 2 ğŸ’ AENOã€‚");
        }, 30000);
    }
    updateUI();
}

function playAd() {
    aiSay("ğŸµ å»£å‘Šæ’­æ”¾ä¸­... è«‹ç¨å€™...");
    setTimeout(() => {
        state.gold += 100;
        updateUI();
        aiSay("å»£å‘ŠçµæŸï¼ç²å¾— 100 é‡‘å¹£è´ŠåŠ©ã€‚");
    }, 3000);
}

/* ----- éŠæˆ²ä¸»å¾ªç’° (ç¹ªåœ–) ----- */
function draw() {
    ctx.clearRect(0, 0, cv.width, cv.height);
    // é€™è£¡ç¹ªè£½ç°¡å–®çš„ç¶²æ ¼èƒŒæ™¯ä»£è¡¨åœ°åœ–
    ctx.strokeStyle = "#ddd";
    for(let i=0; i<10; i++) {
        ctx.beginPath(); ctx.moveTo(i*40, 0); ctx.lineTo(i*40, 400); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(0, i*40); ctx.lineTo(400, i*40); ctx.stroke();
    }
    // ç¹ªè£½å»ºç¯‰
    state.buildings.forEach(b => {
        ctx.fillStyle = b.type === 'farm' ? "green" : "brown";
        ctx.fillRect(b.x*5, b.y*5, 30, 30);
    });
    requestAnimationFrame(draw);
}

/* ----- å•Ÿå‹• ----- */
function resize() {
    cv.width = cv.offsetWidth;
    cv.height = cv.offsetHeight;
}
window.onresize = resize;
resize();
initMap();
updateUI();
draw();

// æ¯ç§’æ›´æ–°è¨ˆæ™‚å™¨
setInterval(() => {
    if(state.beastTimer > 0) state.beastTimer--;
    else {
        state.beastTimer = 120;
        state.gold += 50; // ç¸æ½®æˆ°åˆ©å“è‡ªå‹•ç™¼æ”¾
        aiSay("ç¸æ½®é˜²ç¦¦æˆåŠŸï¼ç²å¾— 50 é‡‘å¹£æˆ°åˆ©å“ã€‚");
    }
    if(currentTab === 'event') renderPanel();
}, 1000);

</script>
</body>
</html>
