<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AENO V3 æ–‡æ˜å¸åœ‹</title>
<style>
* { margin:0; padding:0; box-sizing:border-box; font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans HK", sans-serif; }
body { background:#111; color:#fff; overflow:hidden; user-select:none; }
#bootScreen { position:fixed; inset:0; background:#000; color:#0f0; display:flex; align-items:center; justify-content:center; font-size:22px; z-index:9999; }
#gameCanvas { display:block; width:100vw; height:100vh; }
#mainPanel { position:fixed; top:10px; left:10px; width:360px; height:560px; background:rgba(0,0,0,0.7); border:1px solid #444; border-radius:10px; padding:10px; overflow:hidden; display:flex; flex-direction:column; }
#panelHeader { padding:8px; background:#222; border-radius:6px; cursor:move; margin-bottom:8px; }
.tabBar { display:flex; gap:6px; margin-bottom:8px; flex-wrap:wrap; }
.tabBtn { padding:6px 10px; background:#333; border:none; border-radius:6px; color:#fff; font-size:12px; cursor:pointer; }
.tabBtn.active { background:#0070ff; }
.tabPage { display:none; flex:1; overflow:auto; padding-right:6px; }
.tabPage.active { display:block; }
.row { display:flex; justify-content:space-between; padding:4px 0; font-size:14px; }
.btn { padding:8px 10px; background:#0070ff; border:none; border-radius:6px; color:#fff; cursor:pointer; margin-top:4px; }
.btn.danger { background:#c43; }
.btn.gray { background:#444; }
.hidden { display:none !important; }
#chatBox { position:fixed; bottom:10px; right:10px; width:320px; height:400px; background:rgba(0,0,0,0.8); border:1px solid #555; border-radius:10px; display:flex; flex-direction:column; }
#chatLog { flex:1; padding:8px; font-size:12px; overflow-y:auto; }
#chatInput { width:100%; padding:8px; background:#222; border:none; color:#fff; }
#panelMinBtn, #panelHideBtn, #panelRestoreBtn { padding:4px 8px; background:#444; border:none; color:#fff; border-radius:4px; cursor:pointer; }
#panelRestoreBtn { position:fixed; bottom:10px; left:10px; z-index:10; }
.marketLine { display:flex; gap:8px; margin:6px 0; align-items:center; }
.marketLine select, .marketLine input { padding:6px; width:80px; background:#222; border:1px solid #444; color:#fff; border-radius:6px; }
#sysLog { height:80px; overflow-y:auto; font-size:12px; color:#ccc; background:#111; padding:4px; margin-top:6px; border-radius:6px; }
</style>
</head>
<body>

<div id="bootScreen">è¼‰å…¥ AENO V3 æ–‡æ˜å¸åœ‹...</div>
<canvas id="gameCanvas"></canvas>

<div id="mainPanel">
  <div id="panelHeader">
    <div style="display:flex; justify-content:space-between;">
      <b>AENO æ§åˆ¶é¢æ¿</b>
      <div>
        <button id="panelMinBtn">ç¸®</button>
        <button id="panelHideBtn">éš±</button>
      </div>
    </div>
  </div>

  <div class="tabBar">
    <button class="tabBtn active" data-tab="tabMain">ä¸»é </button>
    <button class="tabBtn" data-tab="tabBuild">å»ºé€ </button>
    <button class="tabBtn" data-tab="tabMarket">äº¤æ˜“æ‰€</button>
    <button class="tabBtn" data-tab="tabTech">ç§‘æŠ€</button>
    <button class="tabBtn" data-tab="tabChat">åŠ©æ‰‹</button>
  </div>

  <div id="tabMain" class="tabPage active">
    <div class="row"><span>é‡‘å¹£</span><span id="statGold">0</span></div>
    <div class="row"><span>AENO</span><span id="statAeno">0.000000</span></div>
    <div class="row"><span>æœ¨æ</span><span id="statWood">0</span></div>
    <div class="row"><span>çŸ³é ­</span><span id="statStone">0</span></div>
    <div class="row"><span>éµç¤¦</span><span id="statIron">0</span></div>
    <div class="row"><span>ç³§é£Ÿ</span><span id="statFood">0</span></div>
    <div class="row"><span>äººå£</span><span id="statPop">0</span></div>
    <div class="row"><span>é ˜åœŸ</span><span id="statTerritory">0</span></div>
    <div class="row"><span>æ–‡æ˜åº¦</span><span id="statCivil">0%</span></div>
    <div class="row"><span>ç¸æ½®</span><span id="statBeast">æœªå•Ÿå‹•</span></div>
    <button class="btn" id="btnExpand">æ“´å¼µé ˜åœŸ</button>
    <button class="btn" id="btnZoomReset">é‡ç½®è¦–è§’</button>
    <div style="display:flex; gap:6px; margin-top:6px;">
      <button class="btn gray" id="btnAutoOn">è‡ªå‹•ON</button>
      <button class="btn gray" id="btnAutoOff">è‡ªå‹•OFF</button>
    </div>
    <button class="btn" id="btnSaveNow">ç«‹å³ä¿å­˜</button>
    <button class="btn danger" id="btnReset">æ¸…é™¤å­˜æª”</button>
    <div id="sysLog"></div>
  </div>

  <div id="tabBuild" class="tabPage">
    <button class="btn buildBtn" data-build="house">æˆ¿å±‹</button>
    <button class="btn buildBtn" data-build="farm">è¾²ç”°</button>
    <button class="btn buildBtn" data-build="lumber">ä¼æœ¨å ´</button>
    <button class="btn buildBtn" data-build="quarry">çŸ³å ´</button>
    <button class="btn buildBtn" data-build="mine">ç¤¦å ´</button>
    <button class="btn buildBtn" data-build="factory">å·¥å» </button>
    <button class="btn buildBtn" data-build="wall">åŸç‰†</button>
    <button class="btn buildBtn" data-build="robot">æ©Ÿå™¨äººä¸­å¿ƒ</button>
    <!-- æ–°å¢ï¼šç„¡ä¸Šé™å‡ç´šæŒ‰éˆ• -->
    <button class="btn" style="background:#0a0; margin-top:10px;" id="btnUpgradeAll">ä¸€éµå‡ç´šæ‰€æœ‰å»ºç¯‰ï¼ˆç„¡ä¸Šé™ï¼‰</button>
  </div>

  <div id="tabMarket" class="tabPage">
    <div class="marketLine">
      <select id="marketItem">
        <option value="wood">æœ¨æ</option>
        <option value="stone">çŸ³é ­</option>
        <option value="iron">éµç¤¦</option>
        <option value="food">ç³§é£Ÿ</option>
      </select>
      <input id="marketQty" type="number" value="100" min="1">
      <button class="btn" id="btnBuy">è²·å…¥</button>
      <button class="btn" id="btnSell">è³£å‡º</button>
    </div>
    <div id="marketPriceHint" style="font-size:12px; color:#ccc;"></div>
    <div style="margin-top:10px;">
      <button class="btn gray" id="btnPlayAd">æ’­æ”¾å»£å‘Šæ­Œæ›²</button>
      <button class="btn gray" id="btnStopAd">åœæ­¢</button>
    </div>
    <audio id="adAudio" loop>
  </div>

  <div id="tabTech" class="tabPage">
    <button class="btn techBtn" data-tech="tools">å·¥å…·ç§‘æŠ€</button>
    <button class="btn techBtn" data-tech="agri">è¾²æ¥­ç§‘æŠ€</button>
    <button class="btn techBtn" data-tech="mining">æ¡ç¤¦ç§‘æŠ€</button>
    <button class="btn techBtn" data-tech="robotics">æ©Ÿå™¨äººç§‘æŠ€</button>
    <button class="btn techBtn" data-tech="economy">ç¶“æ¿Ÿç§‘æŠ€</button>
  </div>

  <div id="tabChat" class="tabPage">
    <button class="btn" id="assistantTalkBtn">é–‹å•ŸAIåŠ©æ‰‹</button>
  </div>
</div>

<button id="panelRestoreBtn" class="btn hidden">é¡¯ç¤ºé¢æ¿</button>

<div id="chatBox" class="hidden">
  <div id="chatLog"></div>
  <div style="display:flex;">
    <input id="chatInput" placeholder="è¼¸å…¥æŒ‡ä»¤ï¼šå»ºé€  / å‡ç´š / è‡ªå‹• / åœæ­¢">
    <button class="btn" id="chatSend">é€å‡º</button>
    <button class="btn gray" id="chatClose">é—œé–‰</button>
  </div>
</div>

<script>
(() => {
"use strict";

// =========================
// åŸºæœ¬è¨­å®š
// =========================
const VERSION = "3.0.0";
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
const bootScreen = document.getElementById("bootScreen");
const statGold = document.getElementById("statGold");
const statAeno = document.getElementById("statAeno");
const statWood = document.getElementById("statWood");
const statStone = document.getElementById("statStone");
const statIron = document.getElementById("statIron");
const statFood = document.getElementById("statFood");
const statPop = document.getElementById("statPop");
const statTerritory = document.getElementById("statTerritory");
const statCivil = document.getElementById("statCivil");
const statBeast = document.getElementById("statBeast");
const sysLog = document.getElementById("sysLog");
const assistantTalkBtn = document.getElementById("assistantTalkBtn");
const chatBox = document.getElementById("chatBox");
const chatClose = document.getElementById("chatClose");
const chatSend = document.getElementById("chatSend");
const chatInput = document.getElementById("chatInput");
const chatLog = document.getElementById("chatLog");
const btnSaveNow = document.getElementById("btnSaveNow");
const btnReset = document.getElementById("btnReset");
const btnExpand = document.getElementById("btnExpand");
const btnZoomReset = document.getElementById("btnZoomReset");
const btnAutoOn = document.getElementById("btnAutoOn");
const btnAutoOff = document.getElementById("btnAutoOff");
const btnPlayAd = document.getElementById("btnPlayAd");
const btnStopAd = document.getElementById("btnStopAd");
const adAudio = document.getElementById("adAudio");
const marketItem = document.getElementById("marketItem");
const marketQty = document.getElementById("marketQty");
const btnBuy = document.getElementById("btnBuy");
const btnSell = document.getElementById("btnSell");
const marketPriceHint = document.getElementById("marketPriceHint");
const panel = document.getElementById("mainPanel");
const panelHeader = document.getElementById("panelHeader");
const panelMinBtn = document.getElementById("panelMinBtn");
const panelHideBtn = document.getElementById("panelHideBtn");
const panelRestoreBtn = document.getElementById("panelRestoreBtn");
// æ–°å¢ç„¡ä¸Šé™å‡ç´šæŒ‰éˆ•
const btnUpgradeAll = document.getElementById("btnUpgradeAll");

// =========================
// Canvas Resize
// =========================
function resize() {
canvas.width = Math.floor(window.innerWidth * devicePixelRatio);
canvas.height = Math.floor(window.innerHeight * devicePixelRatio);
}
window.addEventListener("resize", resize);
resize();

// =========================
// éš¨æ©Ÿå·¥å…·ï¼ˆä¿å¯†ç”¨ï¼‰
// =========================
function xmur3(str) {
let h = 1779033703 ^ str.length;
for (let i = 0; i < str.length; i++) {
h = Math.imul(h ^ charCodeAt(i), 3432918353);
h = (h << 13) | (h >>> 19);
}
return function () {
h = Math.imul(h ^ (h >>> 16), 2246822507);
h = Math.imul(h ^ (h >>> 13), 3266489909);
return (h ^= h >>> 16) >>> 0;
};
}
function mulberry32(a) {
return function () {
let t = (a += 0x6D2B79F5);
t = Math.imul(t ^ (t >>> 15), t | 1);
t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
};
}
function clamp(v, a, b) {
return Math.max(a, Math.min(b, v));
}

// =========================
// åœ°åœ–è¨­å®š
// =========================
const MAP_W = 50;
const MAP_H = 50;
const TILE = 64;
const ISO_ANGLE = Math.PI / 6;
const COS = Math.cos(ISO_ANGLE);
const SIN = Math.sin(ISO_ANGLE);
let cameraX = 0;
let cameraY = 0;
let zoom = 1.0;
const ZOOM_MIN = 0.35;
const ZOOM_MAX = 2.2;

// =========================
// éŠæˆ²è³‡æ–™
// =========================
const STORAGE_KEY = "AENO_V3_SAVE";
let game = null;

// ========== ã€ä¿®æ”¹1ï¼šåˆå§‹è³‡æºæ”¹ç‚ºä½ è¦æ±‚ï¼šé‡‘å¹£2000ï¼Œæœ¨/çŸ³/éµ/ç³§800ã€‘ ==========
const DEFAULT_SAVE = () => ({
version: VERSION,
seed: "AENO-" + Math.floor(Math.random() * 99999999),
lastTick: Date.now(),
autoMode: true,
resources: {
gold: 2000,
aeno: 0,
wood: 800,
stone: 800,
iron: 800,
food: 800
},
stats: {
population: 4,
territory: 9,
civil: 15,
wall: 0
},
buildings: {
house: 2,
farm: 1,
lumber: 1,
quarry: 0,
mine: 0,
factory: 0,
wall: 0,
robot: 0
},
// æ–°å¢ï¼šå»ºç¯‰ç­‰ç´šï¼ˆç„¡ä¸Šé™ï¼‰
buildingLevels: {
house:1, farm:1, lumber:1, quarry:1, mine:1, factory:1, wall:1, robot:1
},
tech: {
tools: 0,
agri: 0,
mining: 0,
robotics: 0,
economy: 0
},
ad: {
listeningSeconds: 0,
todayScore: 0
},
world: {
explored: [],
beastsKilled: 0,
lootPending: 0
},
market: {
wood: 5,
stone: 7,
iron: 15,
food: 4,
lastUpdate: Date.now()
},
buildQueue: []
});

function log(msg) {
const time = new Date().toLocaleTimeString();
sysLog.innerHTML = `<div>ğŸ•’ ${time} - ${msg}</div>` + sysLog.innerHTML;
}

// =========================
// ä¿å­˜/è®€å–
// =========================
function saveGame() {
game.lastTick = Date.now();
localStorage.setItem(STORAGE_KEY, JSON.stringify(game));
log("å·²ä¿å­˜éŠæˆ²");
}
function loadGame() {
const raw = localStorage.getItem(STORAGE_KEY);
if (!raw) return DEFAULT_SAVE();
try {
const data = JSON.parse(raw);
if (!data.resources || !data.stats) return DEFAULT_SAVE();
// å…¼å®¹èˆŠå­˜æª”ï¼Œè£œä¸ŠbuildingLevels
if(!data.buildingLevels) data.buildingLevels = DEFAULT_SAVE().buildingLevels;
return data;
} catch {
return DEFAULT_SAVE();
}
}

// =========================
// é›¢ç·šè£œç®—
// =========================
function offlineProgress() {
const now = Date.now();
const dt = Math.max(0, now - game.lastTick);
const seconds = Math.floor(dt / 1000);
if (seconds <= 2) return;
const maxSeconds = 3600 * 8;
const safeSec = Math.min(seconds, maxSeconds);
for (let i = 0; i < safeSec; i++) {
tickLogic(1, true);
}
log(`é›¢ç·šè£œç®—å®Œæˆï¼š${safeSec} ç§’`);
}

// =========================
// åœ°åœ– tile
// =========================
const TILE_TYPES = {
grass: 0,
forest: 1,
mountain: 2,
river: 3
};
let map = [];
function generateMap() {
const seedFn = xmur3(game.seed);
const rand = mulberry32(seedFn());
map = [];
for (let y = 0; y < MAP_H; y++) {
const row = [];
for (let x = 0; x < MAP_W; x++) {
let t = TILE_TYPES.grass;
const r = rand();
if (r < 0.18) t = TILE_TYPES.forest;
else if (r < 0.26) t = TILE_TYPES.mountain;
else if (r < 0.30) t = TILE_TYPES.river;
row.push(t);
}
map.push(row);
}
for (let y = 20; y < 28; y++) {
for (let x = 20; x < 28; x++) {
if (Math.random() < 0.45) map[y][x] = TILE_TYPES.forest;
}
}
for (let y = 22; y < 26; y++) {
for (let x = 22; x < 26; x++) {
map[y][x] = TILE_TYPES.grass;
}
}
log("ä¸–ç•Œç”Ÿæˆå®Œæˆï¼ˆæ£®æ—/å±±è„ˆ/æ²³æµå·²å­˜åœ¨ï¼‰");
}

// =========================
// å»ºç¯‰ä½ç½®
// =========================
const townCenter = { x: 24, y: 24 };
const placedBuildings = [];
function rebuildPlacedBuildings() {
placedBuildings.length = 0;
const add = (type, count) => {
for (let i = 0; i < count; i++) {
placedBuildings.push({
type,
x: townCenter.x + ((i % 3) - 1),
y: townCenter.y + (Math.floor(i / 3) - 1),
level: game.buildingLevels[type]
});
}
};
add("house", game.buildings.house);
add("farm", game.buildings.farm);
add("lumber", game.buildings.lumber);
add("quarry", game.buildings.quarry);
add("mine", game.buildings.mine);
add("factory", game.buildings.factory);
add("wall", game.buildings.wall);
add("robot", game.buildings.robot);
}

// =========================
// ISOåº§æ¨™
// =========================
function gridToScreen(gx, gy) {
const x = (gx - gy) * (TILE * COS);
const y = (gx + gy) * (TILE * SIN);
return {
x: x * zoom + cameraX,
y: y * zoom + cameraY
};
}

// =========================
// ç¹ªåœ–ï¼štile
// =========================
function drawTile(gx, gy, type) {
const p = gridToScreen(gx, gy);
const cx = p.x;
const cy = p.y;
const w = TILE * COS * zoom;
const h = TILE * SIN * zoom;
let fill = "#dcfce7";
let stroke = "#bbf7d0";
if (type === TILE_TYPES.forest) {
fill = "#bbf7d0";
stroke = "#86efac";
}
if (type === TILE_TYPES.mountain) {
fill = "#e2e8f0";
stroke = "#cbd5e1";
}
if (type === TILE_TYPES.river) {
fill = "#bfdbfe";
stroke = "#93c5fd";
}
ctx.fillStyle = fill;
ctx.strokeStyle = stroke;
ctx.lineWidth = 2 * zoom;
ctx.beginPath();
ctx.moveTo(cx, cy);
ctx.lineTo(cx + w, cy + h);
ctx.lineTo(cx, cy + 2 * h);
ctx.lineTo(cx - w, cy + h);
ctx.closePath();
ctx.fill();
ctx.stroke();
if (type === TILE_TYPES.forest) {
drawTree(cx, cy + h);
} else if (type === TILE_TYPES.mountain) {
drawMountain(cx, cy + h);
} else if (type === TILE_TYPES.river) {
drawWater(cx, cy + h);
}
}
function drawTree(x, y) {
const size = 10 * zoom;
ctx.fillStyle = "#92400e";
ctx.fillRect(x - size / 2, y + 10 * zoom, size, 18 * zoom);
ctx.fillStyle = "#22c55e";
ctx.beginPath();
ctx.arc(x, y, 18 * zoom, 0, Math.PI * 2);
ctx.fill();
ctx.fillStyle = "rgba(255,255,255,0.3)";
ctx.beginPath();
ctx.arc(x - 6 * zoom, y - 8 * zoom, 8 * zoom, 0, Math.PI * 2);
ctx.fill();
}
function drawMountain(x, y) {
ctx.fillStyle = "#94a3b8";
ctx.beginPath();
ctx.moveTo(x, y - 18 * zoom);
ctx.lineTo(x - 22 * zoom, y + 18 * zoom);
ctx.lineTo(x + 22 * zoom, y + 18 * zoom);
ctx.closePath();
ctx.fill();
}
function drawWater(x, y) {
ctx.fillStyle = "rgba(59,130,246,0.6)";
ctx.beginPath();
ctx.ellipse(x, y + 6 * zoom, 18 * zoom, 10 * zoom, 0, 0, Math.PI * 2);
ctx.fill();
}

// =========================
// å»ºç¯‰ç¹ªåœ–
// =========================
function drawBuilding(b) {
const p = gridToScreen(b.x, b.y);
const x = p.x;
const y = p.y + 10 * zoom;
if (b.type === "house") drawHouse(x, y);
if (b.type === "farm") drawFarm(x, y);
if (b.type === "lumber") drawLumber(x, y);
if (b.type === "quarry") drawQuarry(x, y);
if (b.type === "mine") drawMine(x, y);
if (b.type === "factory") drawFactory(x, y);
if (b.type === "wall") drawWall(x, y);
if (b.type === "robot") drawRobotCenter(x, y);
// é¡¯ç¤ºç­‰ç´šï¼ˆç„¡ä¸Šé™ï¼‰
ctx.fillStyle = "#fff";
ctx.font = `${14*zoom}px bold`;
ctx.fillText(`Lv${b.level}`,x-15*zoom,y-10*zoom);
}
function shadow(x, y, w, h) {
ctx.fillStyle = "rgba(0,0,0,0.18)";
ctx.beginPath();
ctx.ellipse(x, y, w * zoom, h * zoom, 0, 0, Math.PI * 2);
ctx.fill();
}
function drawHouse(x, y) {
shadow(x, y + 42 * zoom, 42, 16);
const bodyGrad = ctx.createLinearGradient(x, y, x, y + 60 * zoom);
bodyGrad.addColorStop(0, "#fef3c7");
bodyGrad.addColorStop(1, "#fde68a");
ctx.fillStyle = bodyGrad;
ctx.beginPath();
ctx.roundRect(x - 38 * zoom, y, 76 * zoom, 50 * zoom, 10 * zoom);
ctx.fill();
const roofGrad = ctx.createLinearGradient(x, y - 40 * zoom, x, y);
roofGrad.addColorStop(0, "#fbbf24");
roofGrad.addColorStop(1, "#f59e0b");
ctx.fillStyle = roofGrad;
ctx.beginPath();
ctx.moveTo(x - 46 * zoom, y);
ctx.quadraticCurveTo(x, y - 46 * zoom, x + 46 * zoom, y);
ctx.closePath();
ctx.fill();
ctx.fillStyle = "#92400e";
ctx.beginPath();
ctx.roundRect(x - 10 * zoom, y + 24 * zoom, 20 * zoom, 26 * zoom, 6 * zoom);
ctx.fill();
ctx.fillStyle = "#bfdbfe";
ctx.beginPath();
ctx.arc(x - 18 * zoom, y + 18 * zoom, 8 * zoom, 0, Math.PI * 2);
ctx.arc(x + 18 * zoom, y + 18 * zoom, 8 * zoom, 0, Math.PI * 2);
ctx.fill();
}
function drawFarm(x, y) {
shadow(x, y + 42 * zoom, 45, 16);
ctx.fillStyle = "#fef9c3";
ctx.beginPath();
ctx.roundRect(x - 44 * zoom, y + 18 * zoom, 88 * zoom, 38 * zoom, 12 * zoom);
ctx.fill();
ctx.fillStyle = "#a16207";
for (let i = -3; i <= 3; i++) {
ctx.fillRect(x + i * 12 * zoom, y + 22 * zoom, 4 * zoom, 32 * zoom);
}
ctx.fillStyle = "#22c55e";
ctx.beginPath();
ctx.arc(x - 28 * zoom, y + 12 * zoom, 12 * zoom, 0, Math.PI * 2);
ctx.arc(x + 28 * zoom, y + 12 * zoom, 12 * zoom, 0, Math.PI * 2);
ctx.fill();
}
function drawLumber(x, y) {
shadow(x, y + 42 * zoom, 45, 16);
ctx.fillStyle = "#fde68a";
ctx.beginPath();
ctx.roundRect(x - 40 * zoom, y + 10 * zoom, 80 * zoom, 46 * zoom, 14 * zoom);
ctx.fill();
ctx.fillStyle = "#92400e";
ctx.fillRect(x - 30 * zoom, y + 30 * zoom, 60 * zoom, 10 * zoom);
ctx.fillStyle = "#22c55e";
ctx.beginPath();
ctx.arc(x + 28 * zoom, y + 10 * zoom, 14 * zoom, 0, Math.PI * 2);
ctx.fill();
ctx.fillStyle = "#0f172a";
ctx.font = `${14 * zoom}px system-ui`;
ctx.fillText("ğŸª“", x - 10 * zoom, y + 34 * zoom);
}
function drawQuarry(x, y) {
shadow(x, y + 42 * zoom, 45, 16);
ctx.fillStyle = "#e2e8f0";
ctx.beginPath();
ctx.roundRect(x - 42 * zoom, y + 10 * zoom, 84 * zoom, 46 * zoom, 14 * zoom);
ctx.fill();
ctx.fillStyle = "#94a3b8";
ctx.beginPath();
ctx.arc(x - 18 * zoom, y + 30 * zoom, 12 * zoom, 0, Math.PI * 2);
ctx.arc(x + 18 * zoom, y + 28 * zoom, 10 * zoom, 0, Math.PI * 2);
ctx.fill();
}
function drawMine(x, y) {
shadow(x, y + 42 * zoom, 45, 16);
ctx.fillStyle = "#cbd5e1";
ctx.beginPath();
ctx.roundRect(x - 42 * zoom, y + 12 * zoom, 84 * zoom, 44 * zoom, 14 * zoom);
ctx.fill();
ctx.fillStyle = "#475569";
ctx.beginPath();
ctx.arc(x, y + 34 * zoom, 16 * zoom, 0, Math.PI * 2);
ctx.fill();
ctx.fillStyle = "#fbbf24";
ctx.beginPath();
ctx.arc(x + 18 * zoom, y + 20 * zoom, 6 * zoom, 0, Math.PI * 2);
ctx.fill();
}
function drawFactory(x, y) {
shadow(x, y + 42 * zoom, 45, 16);
ctx.fillStyle = "#dbeafe";
ctx.beginPath();
ctx.roundRect(x - 44 * zoom, y + 10 * zoom, 88 * zoom, 46 * zoom, 14 * zoom);
ctx.fill();
ctx.fillStyle = "#60a5fa";
ctx.fillRect(x - 34 * zoom, y + 18 * zoom, 18 * zoom, 38 * zoom);
ctx.fillRect(x - 10 * zoom, y + 26 * zoom, 18 * zoom, 30 * zoom);
ctx.fillRect(x + 14 * zoom, y + 20 * zoom, 18 * zoom, 36 * zoom);
ctx.fillStyle = "#fbbf24";
ctx.font = `${14 * zoom}px system-ui`;
ctx.fillText("AD", x + 22 * zoom, y + 20 * zoom);
}
function drawWall(x, y) {
shadow(x, y + 42 * zoom, 50, 16);
ctx.fillStyle = "#cbd5e1";
ctx.beginPath();
ctx.roundRect(x - 50 * zoom, y + 20 * zoom, 100 * zoom, 30 * zoom, 12 * zoom);
ctx.fill();
ctx.fillStyle = "#94a3b8";
for (let i = -4; i <= 4; i++) {
ctx.fillRect(x + i * 12 * zoom, y + 20 * zoom, 4 * zoom, 30 * zoom);
}
}
function drawRobotCenter(x, y) {
shadow(x, y + 42 * zoom, 45, 16);
ctx.fillStyle = "#fef3c7";
ctx.beginPath();
ctx.roundRect(x - 42 * zoom, y + 10 * zoom, 84 * zoom, 46 * zoom, 14 * zoom);
ctx.fill();
ctx.fillStyle = "#0ea5e9";
ctx.beginPath();
ctx.arc(x, y + 30 * zoom, 18 * zoom, 0, Math.PI * 2);
ctx.fill();
ctx.fillStyle = "white";
ctx.beginPath();
ctx.arc(x - 8 * zoom, y + 26 * zoom, 4 * zoom, 0, Math.PI * 2);
ctx.arc(x + 8 * zoom, y + 26 * zoom, 4 * zoom, 0, Math.PI * 2);
ctx.fill();
ctx.fillStyle = "#fbbf24";
ctx.font = `${14 * zoom}px system-ui`;
ctx.fillText("ğŸ¤–", x - 10 * zoom, y + 50 * zoom);
}

// =========================
// UI Tabs
// =========================
const tabBtns = document.querySelectorAll(".tabBtn");
tabBtns.forEach((btn) => {
btn.addEventListener("click", () => {
tabBtns.forEach((b) => b.classList.remove("active"));
btn.classList.add("active");
document.querySelectorAll(".tabPage").forEach((p) => p.classList.remove("active"));
document.getElementById(btn.dataset.tab).classList.add("active");
});
});

// =========================
// Panel Drag
// =========================
let dragPanel = false;
let dragOffsetX = 0;
let dragOffsetY = 0;
panelHeader.addEventListener("pointerdown", (e) => {
dragPanel = true;
dragOffsetX = e.clientX - panel.offsetLeft;
dragOffsetY = e.clientY - panel.offsetTop;
panelHeader.setPointerCapture(e.pointerId);
});
panelHeader.addEventListener("pointermove", (e) => {
if (!dragPanel) return;
const nx = e.clientX - dragOffsetX;
const ny = e.clientY - dragOffsetY;
panel.style.left = clamp(nx, 5, window.innerWidth - panel.offsetWidth - 5) + "px";
panel.style.top = clamp(ny, 5, window.innerHeight - panel.offsetHeight - 5) + "px";
panel.style.right = "auto";
});
panelHeader.addEventListener("pointerup", () => {
dragPanel = false;
});
panelMinBtn.addEventListener("click", () => {
panel.style.height = "120px";
});
panelHideBtn.addEventListener("click", () => {
panel.classList.add("hidden");
panelRestoreBtn.classList.remove("hidden");
});
panelRestoreBtn.addEventListener("click", () => {
panel.classList.remove("hidden");
panelRestoreBtn.classList.add("hidden");
panel.style.height = "560px";
});

// =========================
// Chat UI
// =========================
function addChat(who, msg) {
const div = document.createElement("div");
div.innerHTML = `<b>${who}ï¼š</b>${msg}`;
chatLog.appendChild(div);
chatLog.scrollTop = chatLog.scrollHeight;
}
assistantTalkBtn.addEventListener("click", () => {
chatBox.classList.toggle("hidden");
if (!chatBox.classList.contains("hidden")) {
addChat("åŠ©æ‰‹", "æˆ‘å·²ç¶“æº–å‚™å¥½å¹«ä½ è‡ªå‹•æ”¶è³‡æºã€èµ·å»ºç¯‰ã€ç„¡ä¸Šé™å‡ç´šã€‚");
}
});
chatClose.addEventListener("click", () => {
chatBox.classList.add("hidden");
});
chatSend.addEventListener("click", () => {
const text = chatInput.value.trim();
if (!text) return;
chatInput.value = "";
addChat("ç©å®¶", text);
handleCommand(text);
});
chatInput.addEventListener("keydown", (e) => {
if (e.key === "Enter") {
chatSend.click();
}
});
function handleCommand(text) {
const t = text.toLowerCase();
if (t.includes("åœæ­¢") || t.includes("off")) {
game.autoMode = false;
addChat("åŠ©æ‰‹", "æ”¶åˆ°ï¼å·²åœæ­¢è‡ªå‹•å»ºç¯‰/å‡ç´š");
return;
}
if (t.includes("è‡ªå‹•") || t.includes("on")) {
game.autoMode = true;
addChat("åŠ©æ‰‹", "å·²å•Ÿå‹•è‡ªå‹•æ¨¡å¼ï¼šå»ºé€ +å‡ç´šå¹³è¡¡é‹è¡Œ");
return;
}
if (t.includes("å‡ç´š")) {
upgradeAllBuildings();
addChat("åŠ©æ‰‹", "å·²åŸ·è¡Œä¸€éµç„¡ä¸Šé™å‡ç´šï¼");
return;
}
if (t.includes("å»ºé€ ")) {
game.buildQueue.push({ type: "house", t: Date.now() });
addChat("åŠ©æ‰‹", "å·²æ’ç¨‹å»ºé€ æˆ¿å±‹");
return;
}
addChat("åŠ©æ‰‹", "æŒ‡ä»¤ï¼šè‡ªå‹• / åœæ­¢ / å‡ç´š / å»ºé€ ");
}

// =========================
// å»ºç¯‰æŒ‰éˆ•
// =========================
document.querySelectorAll(".buildBtn").forEach((btn) => {
btn.addEventListener("click", () => {
const type = btn.dataset.build;
game.buildQueue.push({ type, t: Date.now() });
log(`å·²æ’ç¨‹å»ºç¯‰ï¼š${type}`);
});
});

// ========== ã€ä¿®æ”¹2ï¼šæ–°å¢ç„¡ä¸Šé™å‡ç´šåŠŸèƒ½ã€‘ ==========
function upgradeAllBuildings(){
const types = ["house","farm","lumber","quarry","mine","factory","wall","robot"];
types.forEach(type=>{
if(game.buildings[type]>0){
// ç„¡ä¸Šé™ï¼šç›´æ¥+1ï¼Œç„¡ä»»ä½•é™åˆ¶
game.buildingLevels[type]++;
}
});
rebuildPlacedBuildings();
log("æ‰€æœ‰å»ºç¯‰ç„¡ä¸Šé™å‡ç´š +1 å®Œæˆï¼");
}
btnUpgradeAll.addEventListener("click", upgradeAllBuildings);

// =========================
// Tech Buttons
// =========================
document.querySelectorAll(".techBtn").forEach((btn) => {
btn.addEventListener("click", () => {
const tech = btn.dataset.tech;
const cost = 200 + game.tech[tech] * 250;
if (game.resources.gold < cost) {
log("é‡‘å¹£ä¸è¶³ï¼Œç„¡æ³•ç ”ç©¶ç§‘æŠ€");
return;
}
game.resources.gold -= cost;
game.tech[tech] += 1;
log(`ç§‘æŠ€å‡ç´šæˆåŠŸï¼š${tech} Lv.${game.tech[tech]}`);
});
});

// =========================
// Marketï¼ˆæ•¸é‡è¼¸å…¥æ¡†æ­£å¸¸ä½¿ç”¨ï¼‰
// =========================
function updateMarketPrices() {
const now = Date.now();
if (now - game.market.lastUpdate < 60000) return;
const seedFn = xmur3(game.seed + now);
const rand = mulberry32(seedFn());
["wood", "stone", "iron", "food"].forEach((k) => {
const base = game.market[k];
const delta = (rand() - 0.5) * 2;
game.market[k] = Math.max(1, Math.round(base + delta));
});
game.market.lastUpdate = now;
}
function refreshMarketHint() {
marketPriceHint.textContent =
`æœ¨:${game.market.wood} | çŸ³:${game.market.stone} | éµ:${game.market.iron} | é£Ÿ:${game.market.food}`;
}
btnBuy.addEventListener("click", () => {
const item = marketItem.value;
const qty = Math.max(1, Math.floor(Number(marketQty.value || 1)));
const price = game.market[item] * qty;
if (game.resources.gold < price) {
log("é‡‘å¹£ä¸è¶³ï¼Œè²·å…¥å¤±æ•—");
return;
}
game.resources.gold -= price;
game.resources[item] += qty;
log(`è²·å…¥æˆåŠŸï¼š${item} x${qty}`);
});
btnSell.addEventListener("click", () => {
const item = marketItem.value;
const qty = Math.max(1, Math.floor(Number(marketQty.value || 1)));
if (game.resources[item] < qty) {
log("è³‡æºä¸è¶³ï¼Œè³£å‡ºå¤±æ•—");
return;
}
const price = game.market[item] * qty;
game.resources[item] -= qty;
game.resources.gold += price;
log(`è³£å‡ºæˆåŠŸï¼š${item} x${qty}`);
});

// =========================
// Ad music
// =========================
let adPlaying = false;
let adTimer = null;
function startAd() {
if (adPlaying) return;
adPlaying = true;
adAudio.src = "https://cdn.pixabay.com/download/audio/2022/03/15/audio_7f7b2fbe11.mp3?filename=future-bass-beat-117858.mp3";
adAudio.volume = 0.55;
adAudio.play().catch(() => {
log("ç€è¦½å™¨ç¦æ­¢è‡ªå‹•æ’­æ”¾ï¼Œè«‹å†æŒ‰ä¸€æ¬¡æ’­æ”¾");
});
log("é–‹å§‹æ’­æ”¾å»£å‘Šæ­Œæ›²");
if (adTimer) clearInterval(adTimer);
adTimer = setInterval(() => {
game.ad.listeningSeconds += 1;
}, 1000);
}
function stopAd() {
adPlaying = false;
adAudio.pause();
if (adTimer) clearInterval(adTimer);
adTimer = null;
log("å·²åœæ­¢å»£å‘Šæ­Œæ›²");
}
btnPlayAd.addEventListener("click", startAd);
btnStopAd.addEventListener("click", stopAd);

// =========================
// Zoom & Expand
// =========================
btnZoomReset.addEventListener("click", () => {
zoom = 1.0;
cameraX = canvas.width / 2;
cameraY = 120;
});
btnExpand.addEventListener("click", () => {
const cost = Math.floor(250 + game.stats.territory * 18);
if (game.resources.gold < cost) {
log("é‡‘å¹£ä¸è¶³ï¼Œç„¡æ³•æ“´åœŸ");
return;
}
game.resources.gold -= cost;
game.stats.territory += 2;
game.stats.civil += 1;
log(`é ˜åœŸæ“´å¤§æˆåŠŸ (+2)ï¼ŒèŠ±è²» ${cost} é‡‘`);
});
btnAutoOn.addEventListener("click", () => {
game.autoMode = true;
log("è‡ªå‹•æ¨¡å¼ ON");
});
btnAutoOff.addEventListener("click", () => {
game.autoMode = false;
log("è‡ªå‹•æ¨¡å¼ OFF");
});

// =========================
// Touch Zoom
// =========================
let touchMode = false;
let lastDist = 0;
canvas.addEventListener("touchstart", (e) => {
if (e.touches.length === 2) {
touchMode = true;
lastDist = Math.hypot(
e.touches[0].clientX - e.touches[1].clientX,
e.touches[0].clientY - e.touches[1].clientY
);
}
}, { passive: false });
canvas.addEventListener("touchmove", (e) => {
if (!touchMode) return;
if (e.touches.length !== 2) return;
e.preventDefault();
const dist = Math.hypot(
e.touches[0].clientX - e.touches[1].clientX,
e.touches[0].clientY - e.touches[1].clientY
);
const diff = dist - lastDist;
lastDist = dist;
zoom += diff * 0.002;
zoom = clamp(zoom, ZOOM_MIN, ZOOM_MAX);
}, { passive: false });
canvas.addEventListener("touchend", () => {
touchMode = false;
});

// =========================
// æ»‘å‹•åœ°åœ–
// =========================
let draggingMap = false;
let lastPX = 0;
let lastPY = 0;
canvas.addEventListener("pointerdown", (e) => {
draggingMap = true;
lastPX = e.clientX;
lastPY = e.clientY;
canvas.setPointerCapture(e.pointerId);
});
canvas.addEventListener("pointermove", (e) => {
if (!draggingMap) return;
const dx = e.clientX - lastPX;
const dy = e.clientY - lastPY;
lastPX = e.clientX;
lastPY = e.clientY;
cameraX += dx * devicePixelRatio;
cameraY += dy * devicePixelRatio;
});
canvas.addEventListener("pointerup", () => {
draggingMap = false;
});

// =========================
// AENO ç®—æ³•
// =========================
function secretAenoCore() {
const now = Date.now();
const mix = game.seed + "|" + game.ad.listeningSeconds + "|" + game.stats.population + "|" + game.stats.civil + "|" + now;
const seedFn = xmur3(mix);
const rand = mulberry32(seedFn());
const maintenance = (game.stats.population * 0.00003) + (Object.values(game.buildings).reduce((a,b)=>a+b,0) * 0.00002);
const learning = (game.tech.tools + game.tech.agri + game.tech.mining + game.tech.robotics + game.tech.economy) * 0.00004;
const adFactor = Math.min(1.0, game.ad.listeningSeconds / 120) * (0.00018 + learning);
const beastFactor = (game.world.beastsKilled * 0.000002);
const salt = (rand() * 0.00005);
let aenoDelta = adFactor + beastFactor + salt - maintenance;
if (aenoDelta < 0) aenoDelta = 0;
return aenoDelta;
}

// =========================
// æ¯ç§’é‚è¼¯
// =========================
function tickLogic(dtSec = 1, silent = false) {
updateMarketPrices();
const farmBoost = 1 + game.tech.agri * 0.08;
game.resources.food += game.buildings.farm * 0.12 * farmBoost * dtSec * game.buildingLevels.farm;
const forestBoost = 1.0;
const lumberBoost = 1 + game.tech.tools * 0.06;
game.resources.wood += game.buildings.lumber * 0.14 * forestBoost * lumberBoost * dtSec * game.buildingLevels.lumber;
const quarryBoost = 1 + game.tech.mining * 0.07;
game.resources.stone += game.buildings.quarry * 0.10 * quarryBoost * dtSec * game.buildingLevels.quarry;
game.resources.iron += game.buildings.mine * 0.06 * quarryBoost * dtSec * game.buildingLevels.mine;
const ecoBoost = 1 + game.tech.economy * 0.08;
game.resources.gold += (game.stats.population * 0.04 + game.buildings.factory * 0.18) * ecoBoost * dtSec * game.buildingLevels.factory;
const aenoDelta = secretAenoCore() * dtSec;
game.resources.aeno += aenoDelta;
const civilUp = (game.buildings.house * 0.0008 + game.buildings.factory * 0.0012) * dtSec;
game.stats.civil = clamp(game.stats.civil + civilUp, 0, 100);
if (game.resources.food > game.stats.population * 4) {
if (Math.random() < 0.002 * dtSec) {
game.stats.population += 1;
if (!silent) log("äººå£å¢åŠ  +1");
}
}
// ========== ã€ä¿®æ”¹3ï¼šAI è‡ªå‹•å¹³è¡¡å»ºé€  + ç„¡ä¸Šé™å‡ç´šã€‘ ==========
if (game.autoMode) {
autoAssistantBuild(dtSec, silent);
// è‡ªå‹•éš¨æ©Ÿå‡ç´šï¼ˆç„¡ä¸Šé™ï¼‰
if(Math.random() < 0.3) autoUpgradeRandom();
}
if (game.stats.civil >= 100) {
if (Math.random() < 0.0025 * dtSec) {
const loot = Math.floor(30 + Math.random() * 80);
game.world.beastsKilled += 1;
game.world.lootPending += loot;
if (!silent) log(`âš”ï¸ ç¸æ½®ä¾†è¥²ï¼æ“Šé€€æˆåŠŸ`);
}
}
if (game.world.lootPending > 0) {
const take = Math.min(game.world.lootPending, 4);
game.world.lootPending -= take;
game.resources.gold += take * 0.6;
}
Object.keys(game.resources).forEach((k) => {
if (game.resources[k] < 0) game.resources[k] = 0;
});
}

// ========== ã€ä¿®æ”¹4ï¼šAIè‡ªå‹•éš¨æ©Ÿå‡ç´šï¼ˆç„¡ä¸Šé™ï¼‰ã€‘ ==========
function autoUpgradeRandom(){
const types = ["house","farm","lumber","quarry","mine","factory","wall","robot"];
const avail = types.filter(t=>game.buildings[t]>0);
if(avail.length===0) return;
const pick = avail[Math.floor(Math.random()*avail.length)];
game.buildingLevels[pick]++;
rebuildPlacedBuildings();
}

// ========== AIè‡ªå‹•å»ºé€ ï¼ˆå¹³è¡¡é‚è¼¯ï¼Œå®Œå…¨ä¿ç•™ä½ åŸç‰ˆï¼‰ ==========
function autoAssistantBuild(dtSec, silent) {
if (game.buildings.farm < 1) {
tryBuild("farm", silent);
return;
}
if (game.buildings.lumber < 1) {
tryBuild("lumber", silent);
return;
}
if (game.buildings.house < Math.ceil(game.stats.population / 2)) {
tryBuild("house", silent);
return;
}
if (game.buildings.quarry < 1 && game.stats.territory >= 9) {
tryBuild("quarry", silent);
return;
}
if (game.buildings.mine < 1 && game.buildings.quarry >= 1) {
tryBuild("mine", silent);
return;
}
if (game.buildings.factory < 1 && game.buildings.mine >= 1) {
tryBuild("factory", silent);
return;
}
if (game.buildings.wall < 1 && game.stats.civil > 60) {
tryBuild("wall", silent);
return;
}
if (game.buildings.robot < 1 && game.tech.robotics >= 1) {
tryBuild("robot", silent);
return;
}
if (game.resources.gold > 1000 && Math.random() < 0.002 * dtSec) {
game.resources.gold -= 250;
game.stats.territory += 1;
if (!silent) log("ğŸï¸ åŠ©æ‰‹è‡ªå‹•æ“´å¤§é ˜åœŸ +1");
}
if (game.buildQueue.length > 0) {
const job = game.buildQueue.shift();
tryBuild(job.type, silent);
}
}

function tryBuild(type, silent) {
const cost = getBuildCost(type);
if (
game.resources.gold < cost.gold ||
game.resources.wood < cost.wood ||
game.resources.stone < cost.stone ||
game.resources.iron < cost.iron ||
game.resources.food < cost.food
) {
if (!silent) log(`è³‡æºä¸è¶³ï¼šç„¡æ³•å»ºé€  ${type}`);
return false;
}
game.resources.gold -= cost.gold;
game.resources.wood -= cost.wood;
game.resources.stone -= cost.stone;
game.resources.iron -= cost.iron;
game.resources.food -= cost.food;
game.buildings[type] += 1;
game.stats.civil += 0.8;
rebuildPlacedBuildings();
if (!silent) log(`ğŸ—ï¸ å»ºé€ æˆåŠŸï¼š${type} +1`);
return true;
}

function getBuildCost(type) {
const base = {
house: { gold: 120, wood: 35, stone: 10, iron: 0, food: 10 },
farm: { gold: 100, wood: 20, stone: 0, iron: 0, food: 0 },
lumber: { gold: 120, wood: 10, stone: 10, iron: 0, food: 0 },
quarry: { gold: 180, wood: 10, stone: 20, iron: 0, food: 0 },
mine: { gold: 240, wood: 20, stone: 30, iron: 0, food: 0 },
factory: { gold: 350, wood: 40, stone: 50, iron: 10, food: 0 },
wall: { gold: 300, wood: 10, stone: 80, iron: 10, food: 0 },
robot: { gold: 600, wood: 50, stone: 80, iron: 40, food: 0 }
};
const lv = game.buildings[type] || 0;
const scale = 1 + lv * 0.18;
return {
gold: Math.floor(base[type].gold * scale),
wood: Math.floor(base[type].wood * scale),
stone: Math.floor(base[type].stone * scale),
iron: Math.floor(base[type].iron * scale),
food: Math.floor(base[type].food * scale)
};
}

// =========================
// UI æ›´æ–°
// =========================
function updateUI() {
statGold.textContent = Math.floor(game.resources.gold);
statAeno.textContent = game.resources.aeno.toFixed(6);
statWood.textContent = Math.floor(game.resources.wood);
statStone.textContent = Math.floor(game.resources.stone);
statIron.textContent = Math.floor(game.resources.iron);
statFood.textContent = Math.floor(game.resources.food);
statPop.textContent = game.stats.population;
statTerritory.textContent = game.stats.territory;
statCivil.textContent = Math.floor(game.stats.civil) + "%";
if (game.stats.civil >= 100) {
statBeast.textContent = `âš”ï¸ é€²è¡Œä¸­ï¼ˆæ“Šæ®º:${game.world.beastsKilled}ï¼‰`;
} else {
statBeast.textContent = `æœªå•Ÿå‹•ï¼ˆéœ€100%æ–‡æ˜ï¼‰`;
}
refreshMarketHint();
}

// =========================
// ç¹ªåœ–ä¸»å¾ªç’°
// =========================
function draw() {
ctx.setTransform(1, 0, 0, 1, 0, 0);
ctx.clearRect(0, 0, canvas.width, canvas.height);
ctx.fillStyle = "#eaf6ff";
ctx.fillRect(0, 0, canvas.width, canvas.height);
for (let y = 0; y < MAP_H; y++) {
for (let x = 0; x < MAP_W; x++) {
drawTile(x, y, map[y][x]);
}
}
placedBuildings.forEach(drawBuilding);
const p = gridToScreen(townCenter.x, townCenter.y);
ctx.fillStyle = "rgba(0,0,0,0.5)";
ctx.font = `${16 * zoom}px system-ui`;
ctx.fillText("ğŸ›ï¸ ä¸­å¤®åŸé®", p.x - 40 * zoom, p.y - 20 * zoom);
requestAnimationFrame(draw);
}

// =========================
// ä¸»å¾ªç’°
// =========================
function gameLoop() {
tickLogic(1, false);
updateUI();
}

// =========================
// ä¿å­˜æŒ‰éˆ•
// =========================
btnSaveNow.addEventListener("click", () => saveGame());
btnReset.addEventListener("click", () => {
if (!confirm("ç¢ºå®šæ¸…é™¤å­˜æª”ï¼Ÿ")) return;
localStorage.removeItem(STORAGE_KEY);
location.reload();
});

// =========================
// è‡ªå‹•ä¿å­˜
// =========================
setInterval(saveGame, 30000);

// =========================
// åˆå§‹åŒ–
// =========================
function init() {
game = loadGame();
cameraX = canvas.width / 2;
cameraY = 140;
generateMap();
rebuildPlacedBuildings();
offlineProgress();
updateUI();
setInterval(gameLoop, 1000);
requestAnimationFrame(draw);
setTimeout(() => {
bootScreen.style.display = "none";
log("éŠæˆ²è¼‰å…¥å®Œæˆ");
addChat("åŠ©æ‰‹", "å·²å•Ÿå‹•ç„¡ä¸Šé™å‡ç´š+AIå¹³è¡¡å»ºé€ ");
}, 600);
}

init();

})();
</script>
</body>
</html>
