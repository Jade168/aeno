<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>AENO V3</title>
<style>
html,body{margin:0;padding:0;height:100%;overflow:hidden;background:#eef5ff;font-family:sans-serif}
#game{position:absolute;inset:0}
canvas{background:#cfe8ff;touch-action:none}
.panel{
 position:absolute; top:10px; left:10px; width:340px; max-height:80%;
 background:#fff; border-radius:14px; box-shadow:0 10px 30px rgba(0,0,0,.15);
 display:flex; flex-direction:column; resize:both; overflow:hidden
}
.panel header{
 padding:10px; font-weight:bold; background:#f3f6ff; cursor:move
}
.panel .body{padding:10px; overflow:auto}
.btn{padding:8px 12px;border-radius:10px;border:none;margin:4px;background:#4f8cff;color:#fff}
.float-btn{
 position:absolute; right:12px; bottom:12px;
 width:56px;height:56px;border-radius:50%;
 background:#ffb703;color:#000;font-size:24px;border:none
}
.ai{
 position:absolute; width:48px;height:48px;border-radius:50%;
 background:#ffe066; display:flex;align-items:center;justify-content:center
}
.ai .ad{position:absolute;top:-18px;font-size:10px;background:#ff6b6b;color:#fff;padding:2px 6px;border-radius:8px}
.robot{
 position:absolute;width:40px;height:40px;background:#adb5bd;border-radius:8px;
}
.robot .ad{position:absolute;bottom:-14px;font-size:10px;background:#51cf66;padding:2px 6px;border-radius:6px}
</style>
</head>
<body>
<div id="game">
<canvas id="c"></canvas>

<div id="panel" class="panel">
<header>å¸åœ‹æ§åˆ¶ä¸­å¿ƒ</header>
<div class="body" id="panelBody">
<div><b>è³‡æº</b><br>
æœ¨æ:<span id="wood"></span> |
çŸ³é ­:<span id="stone"></span> |
é‡‘å¹£:<span id="coin"></span> |
AENO:<span id="aeno"></span></div>

<hr>
<b>å»ºè¨­</b><br>
<button class="btn" onclick="build('farm')">è¾²ç”°</button>
<button class="btn" onclick="build('lumber')">ä¼æœ¨å ´</button>
<button class="btn" onclick="build('mine')">ç¤¦å ´</button>

<hr>
<b>äº¤æ˜“æ‰€</b><br>
<input id="tradeAmt" type="number" value="10">
<button class="btn" onclick="buy()">è²·æœ¨</button>
<button class="btn" onclick="sell()">è³£æœ¨</button>

<hr>
<b>å»£å‘Š / æ­Œæ›²</b><br>
<button class="btn" onclick="unlockAudio()">è§£é–éŸ³è¨Š</button>
<button class="btn" onclick="playAd()">æ’­æ”¾å»£å‘Šæ­Œ</button>

<hr>
<b>æ©Ÿå™¨äºº</b><br>
<button class="btn" onclick="sendRobot()">æ´¾å‡ºæ©Ÿå™¨äºº</button>

<hr>
<b>ç¸æ½®</b><br>
<button class="btn" onclick="collectLoot()">æ”¶å–æˆ°åˆ©å“</button>
</div>
</div>

<button class="float-btn" onclick="togglePanel()">â˜°</button>

<div id="ai" class="ai" style="left:60%;top:60%">
<div class="ad">AD</div>ğŸ¦Š
</div>

<div id="robot" class="robot" style="left:30%;top:50%">
<div class="ad">AD</div>
</div>

<audio id="audio">
</div>

<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("./sw.js?v=" + Date.now()).then((reg) => {
    reg.update();
  });

  navigator.serviceWorker.getRegistrations().then((regs) => {
    regs.forEach((r) => r.update());
  });
}
</script>

<script>
/* ===== å­˜æª”ç³»çµ±ï¼ˆæ›´æ–°ä¸æ¸…æª”ï¼‰ ===== */
const SAVE_KEY="AENO_V3_SAVE";
const VERSION=3;
let state={
 version:VERSION,
 wood:50, stone:20, coin:100, aeno:1,
 loot:0
};
function load(){
 const s=localStorage.getItem(SAVE_KEY);
 if(s){
  const old=JSON.parse(s);
  state={...state,...old,version:VERSION};
 }
}
function save(){localStorage.setItem(SAVE_KEY,JSON.stringify(state));}

/* ===== UI ===== */
function refresh(){
 wood.textContent=state.wood;
 stone.textContent=state.stone;
 coin.textContent=state.coin;
 aeno.textContent=state.aeno;
}
function togglePanel(){
 panel.style.display=panel.style.display==="none"?"block":"none";
}

/* ===== å»ºç¯‰ / è³‡æº ===== */
function build(t){
 if(t==="lumber" && state.coin>=20){
  state.coin-=20; state.wood+=20;
 }
 save(); refresh();
}

/* ===== äº¤æ˜“æ‰€ ===== */
function buy(){
 let n=+tradeAmt.value;
 if(state.coin>=n*2){state.coin-=n*2;state.wood+=n;}
 save();refresh();
}
function sell(){
 let n=+tradeAmt.value;
 if(state.wood>=n){state.wood-=n;state.coin+=n;}
 save();refresh();
}

/* ===== å»£å‘Š ===== */
let ads=[],audioUnlocked=false;
fetch("ads.json").then(r=>r.json()).then(j=>ads=j);
function unlockAudio(){
 audio.play().catch(()=>{}); audioUnlocked=true;
}
function playAd(){
 if(!audioUnlocked||!ads.length)return;
 audio.src=ads[0].url;
 audio.play();
 state.coin+=ads[0].reward;
 save();refresh();
}

/* ===== æ©Ÿå™¨äºº ===== */
function sendRobot(){
 state.coin+=10;
 save();refresh();
}

/* ===== ç¸æ½® ===== */
function collectLoot(){
 state.coin+=state.loot; state.loot=0;
 save();refresh();
}

/* ===== INIT ===== */
load(); refresh();
</script>
</body>
</html>
