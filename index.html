<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />

  <title>AENO - 星球文明育成</title>

  <!-- 防 cache (GitHub Pages 特別易卡舊版) -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0ea5e9">

  <link rel="stylesheet" href="style.css" />

</head>

<body>

  <!-- CANVAS -->
  <canvas id="gameCanvas"></canvas>

  <!-- BOOT SCREEN -->
  <div id="bootScreen">
    <div class="bootCard">
      <div class="logo">AENO</div>
      <div class="bootText">文明育成 · 星球殖民</div>
      <div class="bootHint">Loading...</div>
    </div>
  </div>

  <!-- UI ROOT -->
  <div id="uiRoot">

    <!-- LOGIN SCREEN -->
    <div id="loginScreen" class="hidden" style="
      position:absolute; inset:0;
      display:flex; justify-content:center; align-items:center;
      z-index:9998;
      background:linear-gradient(#dbeafe,#f0f9ff);
      pointer-events:auto;
    ">
      <div style="
        width:320px;
        background:rgba(255,255,255,.85);
        border:2px solid #bfe6ff;
        border-radius:26px;
        padding:18px;
        box-shadow:0 14px 30px rgba(0,0,0,.15);
        text-align:center;
      ">
        <div style="font-size:34px;font-weight:900;color:#0284c7;letter-spacing:3px;">AENO</div>
        <div style="margin-top:8px;font-weight:800;">登入 / 註冊</div>
        <div style="margin-top:12px;opacity:.8;font-size:12px;">
          首次登入會自動註冊。<br>
          未來會加入「四組金鑰 + 指紋」系統。
        </div>

        <div style="margin-top:14px;text-align:left;font-weight:900;font-size:13px;">玩家名字</div>
        <input id="loginName" type="text" placeholder="例如：Peter" style="
          width:100%;
          box-sizing:border-box;
          margin-top:6px;
          padding:12px 12px;
          border-radius:16px;
          border:2px solid #bfe6ff;
          outline:none;
          font-size:14px;
        ">

        <div style="margin-top:12px;text-align:left;font-weight:900;font-size:13px;">密碼</div>
        <input id="loginPass" type="password" placeholder="最少 4 字" style="
          width:100%;
          box-sizing:border-box;
          margin-top:6px;
          padding:12px 12px;
          border-radius:16px;
          border:2px solid #bfe6ff;
          outline:none;
          font-size:14px;
        ">

        <button id="btnLogin" style="
          margin-top:14px;
          width:100%;
          border:none;
          border-radius:16px;
          padding:12px 12px;
          background:#0ea5e9;
          color:white;
          font-weight:900;
          cursor:pointer;
          font-size:15px;
        ">進入宇宙</button>

        <button id="btnGuest" style="
          margin-top:10px;
          width:100%;
          border:none;
          border-radius:16px;
          padding:12px 12px;
          background:#22c55e;
          color:white;
          font-weight:900;
          cursor:pointer;
          font-size:15px;
        ">訪客模式（測試）</button>

        <div id="loginMsg" style="margin-top:12px;font-size:12px;font-weight:900;color:#ef4444;"></div>
      </div>
    </div>


    <!-- PLANET SELECT SCREEN -->
    <div id="planetScreen" class="hidden" style="
      position:absolute; inset:0;
      display:flex; justify-content:center; align-items:center;
      z-index:9997;
      background:linear-gradient(#0b1220,#020617);
      pointer-events:auto;
      color:white;
    ">
      <div style="
        width:360px;
        background:rgba(255,255,255,.08);
        border:2px solid rgba(255,255,255,.15);
        border-radius:26px;
        padding:18px;
        box-shadow:0 14px 30px rgba(0,0,0,.35);
        text-align:center;
        backdrop-filter: blur(10px);
      ">
        <div style="font-size:20px;font-weight:900;">🌍 選擇你的星球</div>
        <div style="margin-top:8px;font-size:12px;opacity:.8;">
          玩家只能永久選 1 個星球。<br>
          機器人可隨機探索 20 個星球。
        </div>

        <div id="planetList" style="
          margin-top:12px;
          display:grid;
          grid-template-columns:1fr 1fr;
          gap:10px;
        "></div>

        <div style="margin-top:12px;font-size:12px;opacity:.8;">
          黑洞孤島：只限開發者進入（你）。
        </div>
      </div>
    </div>


    <!-- ASSISTANT -->
    <div id="assistant" class="hidden">
      <div class="assistantAdFlag">AD</div>
      <div class="assistantFace">🐾</div>
      <div class="assistantName">AENO<br>助手</div>
      <button id="assistantTalkBtn">對話</button>
    </div>


    <!-- CHAT BOX -->
    <div id="chatBox" class="hidden">
      <div class="chatHeader">
        <span>🧠 AI助手</span>
        <button id="chatClose">X</button>
      </div>
      <div id="chatLog"></div>
      <div class="chatInputRow">
        <input id="chatInput" type="text" placeholder="例如：我想起房屋" />
        <button id="chatSend">送出</button>
      </div>
    </div>


    <!-- MAIN PANEL -->
    <div id="mainPanel" class="hidden">

      <div id="panelHeader">
        <div class="panelTitle">📌 控制中心</div>
        <div class="panelBtns">
          <button id="panelMinBtn">收起</button>
          <button id="panelHideBtn">隱藏</button>
        </div>
      </div>

      <div id="panelTabs">
        <button class="tabBtn active" data-tab="tabStatus">狀態</button>
        <button class="tabBtn" data-tab="tabBuild">建築</button>
        <button class="tabBtn" data-tab="tabTech">科技</button>
        <button class="tabBtn" data-tab="tabRobot">機器人</button>
        <button class="tabBtn" data-tab="tabAds">廣告</button>
      </div>

      <div id="panelBody">

        <!-- STATUS TAB -->
        <div class="tabPage active" id="tabStatus">

          <div class="grid2">
            <div class="statCard">
              <div class="k">星球</div>
              <div class="v" id="uiPlanetName">?</div>
            </div>
            <div class="statCard">
              <div class="k">年份</div>
              <div class="v"><span id="uiYear">0</span></div>
            </div>
            <div class="statCard">
              <div class="k">人口</div>
              <div class="v"><span id="uiPop">0</span></div>
            </div>
            <div class="statCard">
              <div class="k">工人</div>
              <div class="v"><span id="uiWorkers">0</span></div>
            </div>
          </div>

          <div class="grid2 mt10">
            <div class="statCard">
              <div class="k">金幣</div>
              <div class="v">🪙 <span id="uiCoins">0</span></div>
            </div>
            <div class="statCard">
              <div class="k">AENO</div>
              <div class="v">🟡 <span id="uiAeno">0.0000</span></div>
            </div>
          </div>

          <div class="grid2 mt10">
            <div class="statCard">
              <div class="k">木</div>
              <div class="v">🪵 <span id="uiWood">0</span></div>
            </div>
            <div class="statCard">
              <div class="k">石</div>
              <div class="v">🪨 <span id="uiStone">0</span></div>
            </div>
          </div>

          <div class="grid2 mt10">
            <div class="statCard">
              <div class="k">鐵</div>
              <div class="v">⛏️ <span id="uiIron">0</span></div>
            </div>
            <div class="statCard">
              <div class="k">糧食</div>
              <div class="v">🌾 <span id="uiFood">0</span></div>
            </div>
          </div>

          <div class="hint mt10">
            ✅ 點擊你領土空地即可建築。<br>
            📌 面板可拖動。<br>
            🔍 手機雙指縮放 / 桌面滾輪縮放。<br>
            ⚠️ 玩家離線資源最多只計 24 小時。
          </div>

          <div class="btnRow mt10">
            <button id="btnSaveGame">保存</button>
            <button id="btnLoadGame">讀取</button>
          </div>

          <div id="sysLog"></div>
        </div>


        <!-- BUILD TAB -->
        <div class="tabPage" id="tabBuild">
          <div class="hint">
            🏗️ 建築模式：點領土空地建造。<br>
            ⬆️ 升級模式：點建築升級（無上限）。
          </div>

          <div class="btnRow mt10">
            <button id="btnBuildMode">建築模式</button>
            <button id="btnUpgradeMode">升級模式</button>
          </div>

          <div class="buildList mt10">
            <button class="buildBtn" data-build="house">🏠 房屋</button>
            <button class="buildBtn" data-build="farm">🌾 農田</button>
            <button class="buildBtn" data-build="lumber">🪵 伐木場</button>
            <button class="buildBtn" data-build="quarry">🪨 採石場</button>
            <button class="buildBtn" data-build="mine">⛏️ 鐵礦</button>
            <button class="buildBtn" data-build="market">🏦 市場</button>
          </div>

          <div class="btnRow mt10">
            <button id="btnAutoBuild">🤖 AI自動建造</button>
            <button id="btnStopAuto">🛑 停止</button>
          </div>

          <div class="hint mt10">
            AI助手會按「優先順序」建造，唔會亂用晒資源。
          </div>
        </div>


        <!-- TECH TAB -->
        <div class="tabPage" id="tabTech">
          <div class="hint">
            🧬 科技樹（簡化版）<br>
            未來會加入 DNA / 野獸潮 / 黑洞移民。
          </div>

          <div class="techList mt10">
            <button class="techBtn" data-tech="tool">🔧 工具</button>
            <button class="techBtn" data-tech="agri">🌾 農業</button>
            <button class="techBtn" data-tech="metal">⛏️ 冶金</button>
            <button class="techBtn" data-tech="robot">🤖 機器人</button>
          </div>

          <div class="hint mt10">
            科技提升產量、解鎖新建築、提高 AENO 掉落率。
          </div>
        </div>


        <!-- ROBOT TAB -->
        <div class="tabPage" id="tabRobot">
          <div class="hint">
            🚀 機器人探索 20 個星球。<br>
            玩家不能自由轉星球（只可永久 1 個）。<br>
            離線最多只計 24 小時。
          </div>

          <div class="btnRow mt10">
            <button id="btnSendRobot">派機器人</button>
            <button id="btnRobotReport">報告</button>
          </div>

          <div class="hint mt10">
            探索有機率帶回資源、碎片、AENO。
          </div>
        </div>


        <!-- ADS TAB -->
        <div class="tabPage" id="tabAds">
          <div class="hint">
            🎵 廣告歌曲：可循環播放。<br>
            播放會獲得少量金幣 / AENO 機率。<br>
            未來可加入 AdMob。
          </div>

          <div class="btnRow mt10">
            <button id="btnPlaySong">播放</button>
            <button id="btnLoopSong">Loop ON</button>
          </div>

          <div class="hint mt10">
            你已放入 3 首免版稅歌，game.js 會讀取並播放。
          </div>

          <div class="hint mt10">
            📌 廣告商 ID：未來先加，現階段唔需要你提供。
          </div>
        </div>

      </div>
    </div>


    <!-- PANEL RESTORE BUTTON -->
    <button id="panelRestoreBtn" class="hidden">📌</button>

  </div>


  <!-- SCRIPTS -->
  <script>
    // 防止 boot 永遠卡死：如果 game.js 有 error，至少顯示登入畫面
    window.addEventListener("error", (e) => {
      console.error("Global Error:", e.error || e.message);
      const boot = document.getElementById("bootScreen");
      const login = document.getElementById("loginScreen");
      if (boot) boot.classList.add("hidden");
      if (login) login.classList.remove("hidden");
      const msg = document.getElementById("loginMsg");
      if (msg) msg.innerText = "⚠️ 系統載入錯誤，已切換到安全登入模式。";
    });

    // 初始化 boot -> login
    function showLogin(){
      document.getElementById("bootScreen").classList.add("hidden");
      document.getElementById("loginScreen").classList.remove("hidden");
    }

    // 1.2 秒後必定顯示登入，避免卡死
    setTimeout(showLogin, 1200);

  </script>

  <!-- game.js 最後載入 -->
  <script src="characters.js"></script>
  <script src="game.js"></script>
<script>
  // 強制保證登入按鈕有反應（即使 game.js 壞咗）
  (function(){
    const msg = document.getElementById("loginMsg");
    const btnLogin = document.getElementById("btnLogin");
    const btnGuest = document.getElementById("btnGuest");
    const inputName = document.getElementById("loginName");
    const inputPass = document.getElementById("loginPass");

    function safeStart(playerName){
      // 保存玩家
      localStorage.setItem("AENO_PLAYER_NAME", playerName);
      localStorage.setItem("AENO_SESSION", "ok");

      // 隱藏登入頁
      document.getElementById("loginScreen").classList.add("hidden");

      // 顯示主UI
      document.getElementById("mainPanel").classList.remove("hidden");
      document.getElementById("assistant").classList.remove("hidden");

      // 如果 game.js 有 startGame，就叫佢
      if (window.startGame) {
        window.startGame(playerName);
      } else {
        console.warn("startGame() not found, fallback mode.");
        if(msg) msg.innerText = "⚠️ game.js 未初始化，已進入安全模式（只顯示UI）。";
      }
    }

    if(btnLogin){
      btnLogin.onclick = ()=>{
        const name = (inputName?.value || "").trim();
        const pass = (inputPass?.value || "").trim();
        if(!name || name.length < 2){
          msg.innerText = "⚠️ 請輸入玩家名字（最少2字）";
          return;
        }
        if(!pass || pass.length < 4){
          msg.innerText = "⚠️ 密碼最少4字";
          return;
        }
        msg.innerText = "";
        safeStart(name);
      };
    }

    if(btnGuest){
      btnGuest.onclick = ()=>{
        msg.innerText = "";
        safeStart("訪客玩家");
      };
    }

  })();
</script>

</body>
</html>
