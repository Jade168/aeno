<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
<title>AENO V3 - 3D æ——è‰¦ä¿®å¾©ç‰ˆ</title>
<style>
  :root{
    --bg:#eaf7ff; --panel:#ffffffee; --border:#cfe8ff; --text:#0f172a;
    --muted:#64748b; --accent:#3b82f6; --accent2:#22c55e; --danger:#ef4444;
    --gold:#f59e0b; --aeno:#8b5cf6;
  }
  *{box-sizing:border-box;font-family:system-ui,-apple-system,sans-serif;}
  body{margin:0;background:#eaf7ff;overflow:hidden;touch-action:none;}
  #game-container{position:relative;width:100vw;height:100vh;max-width:460px;margin:0 auto;background:#fff;overflow:hidden;border:1px solid var(--border);}
  canvas{width:100%;height:100%;display:block;}

  /* é ‚éƒ¨æ•¸æ“šæ¬„ - ä¿æŒ scannable */
  #topbar{
    position:absolute;top:0;left:0;right:0;padding:8px;
    display:flex;gap:4px;z-index:100;background:rgba(255,255,255,0.7);backdrop-filter:blur(6px);
  }
  .res-chip{padding:6px 10px;background:#fff;border:1px solid var(--border);border-radius:12px;font-size:12px;font-weight:900;display:flex;align-items:center;gap:4px;box-shadow:0 2px 5px rgba(0,0,0,0.05);}

  /* AI åŠ©æ‰‹æ°£æ³¡ */
  #ai-chat{
    position:absolute;top:65px;right:10px;width:200px;background:rgba(255,255,255,0.95);
    border:1px solid var(--border);border-radius:18px;padding:12px;z-index:90;font-size:12px;
    box-shadow:0 8px 20px rgba(0,0,0,0.1); border-left: 4px solid var(--accent);
  }

  /* æµ®å‹•æ§åˆ¶çƒ */
  .fab{
    position:absolute;right:20px;bottom:20px;width:60px;height:60px;
    border-radius:50%;background:var(--accent);color:#fff;
    display:flex;align-items:center;justify-content:center;
    box-shadow:0 10px 25px rgba(59,130,246,0.4);z-index:200;cursor:pointer;font-size:28px;
  }

  /* ä¸»é¢æ¿ - æ”¹é€²æ»¾å‹•é«”é©— */
  #panel{
    position:absolute;left:10px;right:10px;bottom:90px;height:55%;
    background:var(--panel);border:1px solid var(--border);border-radius:24px;
    box-shadow:0 20px 50px rgba(0,0,0,0.2);z-index:150;
    display:flex;flex-direction:column;transition:transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    overflow:hidden;backdrop-filter:blur(12px);
  }
  #panel.hide{transform:translateY(120%);}
  
  #panelHeader{padding:15px;background:linear-gradient(to bottom, #fff, #f1f8ff);border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;}
  #panelTabs{display:flex;gap:6px;overflow-x:auto;padding:10px;background:#fff;border-bottom:1px solid #eee; scrollbar-width: none;}
  .tab{padding:8px 16px;border-radius:20px;font-size:13px;white-space:nowrap;cursor:pointer;background:#f1f5f9;font-weight:bold;color:var(--muted);}
  .tab.active{background:var(--accent);color:#fff;box-shadow:0 4px 10px rgba(59,130,246,0.3);}

  #panelBody{flex:1;overflow-y:auto;padding:15px;background:linear-gradient(to bottom, #fff, #f8fbff);}
  .card{background:#fff;border:1px solid #eef2f6;border-radius:18px;padding:14px;margin-bottom:12px;box-shadow:0 4px 12px rgba(0,0,0,0.04);}
  
  .btn{border:none;padding:10px 16px;border-radius:14px;font-weight:800;cursor:pointer;font-size:12px;margin:4px 2px;transition: transform 0.1s;}
  .btn:active{transform: scale(0.95);}
  .btn-primary{background:var(--accent);color:#fff;}
  .btn-green{background:var(--accent2);color:#fff;}
  .btn-gold{background:var(--gold);color:#fff;}

  #toast{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.7);color:#fff;padding:10px 20px;border-radius:20px;z-index:1000;display:none;font-weight:bold;}
</style>
</head>
<body>

<div id="game-container">
  <div id="topbar">
    <div class="res-chip">ğŸ’° <span id="res-gold">0</span></div>
    <div class="res-chip">ğŸªµ <span id="res-wood">0</span></div>
    <div class="res-chip">ğŸª¨ <span id="res-stone">0</span></div>
    <div class="res-chip">ğŸ’ <span id="res-aeno">0</span></div>
  </div>

  <div id="ai-chat">
    <b>ğŸ¾ Aenko åŠ©æ‰‹:</b><br>
    <span id="ai-text">æ­£åœ¨åˆå§‹åŒ–é‡å­ 3D å¼•æ“...</span>
  </div>

  <div id="toast"></div>

  <canvas id="cv"></canvas>

  <div class="fab" onclick="togglePanel()">ğŸ—ï¸</div>

  <div id="panel" class="hide">
    <div id="panelHeader">
      <div style="font-weight:900;font-size:16px;color:var(--text);">å¸åœ‹æŒ‡æ®éƒ¨</div>
      <button onclick="togglePanel()" style="border:none;background:none;font-size:24px;color:var(--muted);">Ã—</button>
    </div>
    <div id="panelTabs">
      <div class="tab active" onclick="setTab('build', event)">å»ºè¨­</div>
      <div class="tab" onclick="setTab('market', event)">äº¤æ˜“æ‰€</div>
      <div class="tab" onclick="setTab('event', event)">æˆ°äº‹/ç¸æ½®</div>
      <div class="tab" onclick="setTab('tech', event)">ç§‘æŠ€</div>
    </div>
    <div id="panelBody"></div>
  </div>
</div>

<script>
/* ----- 1. åˆå§‹åŒ– 3D åœ°åœ–èˆ‡è³‡æº ----- */
const TILE = 64;
const GRID_SIZE = 22;
let state = JSON.parse(localStorage.getItem("AENO_V3_FINAL")) || {
    gold: 500, wood: 150, stone: 100, aeno: 50,
    territoryRadius: 5,
    map: [],
    buildings: [], // æ ¼å¼: {x, y, type, lv}
    beastTimer: 90,
    beastWave: 1,
    marketPrices: { wood: 2.5, stone: 4, iron: 8, food: 1.5 }
};

const cv = document.getElementById("cv");
const ctx = cv.getContext("2d");
let camX = 0, camY = 0;
let selectedTile = { x: 11, y: 11 };

function initMap() {
    if(state.map.length > 0) return;
    for(let y=0; y<GRID_SIZE; y++){
        let row = [];
        for(let x=0; x<GRID_SIZE; x++){
            let type = "grass";
            let d = Math.sqrt(Math.pow(x-11,2)+Math.pow(y-11,2));
            if(d > 8 && Math.random() < 0.4) type = "mountain";
            else if(Math.random() < 0.15) type = "forest";
            else if(Math.random() < 0.05) type = "river";
            row.push({ type });
        }
        state.map.push(row);
    }
}

/* ----- 2. Isometric 3D å¼•æ“é‚„åŸ ----- */
function tileToWorld(x, y) {
    const isoX = (x - y) * (TILE * 0.5);
    const isoY = (x + y) * (TILE * 0.28);
    return { x: isoX, y: isoY };
}

function draw() {
    ctx.clearRect(0, 0, cv.width, cv.height);
    ctx.save();
    ctx.translate(cv.width/2 + camX, cv.height/3 + camY);

    // ç•«åœ°å¡Š
    for(let y=0; y<GRID_SIZE; y++){
        for(let x=0; x<GRID_SIZE; x++){
            const pos = tileToWorld(x, y);
            const tile = state.map[y][x];
            
            // åœ°å¡Šé™°å½±èˆ‡é¸ä¸­æ•ˆæœ
            const isSelected = (x === selectedTile.x && y === selectedTile.y);
            drawIsoDiamond(pos.x, pos.y, TILE, getTileColor(tile.type, isSelected));

            // ç•«åœ°å½¢è£é£¾ (é‚„åŸæ£®æ—/å±±è„ˆå‹•ç•«æ„Ÿ)
            if(tile.type === "forest") drawTree(pos.x, pos.y);
            if(tile.type === "mountain") drawMountain(pos.x, pos.y);
            
            // ç•«å»ºç¯‰ç‰©
            const b = state.buildings.find(b => b.x === x && b.y === y);
            if(b) drawBuilding(pos.x, pos.y, b.type);
        }
    }
    ctx.restore();
    requestAnimationFrame(draw);
}

function drawIsoDiamond(x, y, size, color) {
    ctx.beginPath();
    ctx.moveTo(x, y - size * 0.28);
    ctx.lineTo(x + size * 0.5, y);
    ctx.lineTo(x, y + size * 0.28);
    ctx.lineTo(x - size * 0.5, y);
    ctx.closePath();
    ctx.fillStyle = color;
    ctx.fill();
    ctx.strokeStyle = "rgba(255,255,255,0.2)";
    ctx.stroke();
}

function getTileColor(type, selected) {
    if(selected) return "#3b82f6";
    if(type === "forest") return "#4ade80";
    if(type === "mountain") return "#94a3b8";
    if(type === "river") return "#60a5fa";
    return "#b9fbc0"; // grass
}

function drawTree(x, y) {
    ctx.fillStyle = "#166534";
    ctx.beginPath(); ctx.arc(x, y-5, 8, 0, Math.PI*2); ctx.fill();
    ctx.fillStyle = "#78350f";
    ctx.fillRect(x-2, y, 4, 6);
}

function drawMountain(x, y) {
    ctx.fillStyle = "#64748b";
    ctx.beginPath();
    ctx.moveTo(x-15, y+5); ctx.lineTo(x, y-20); ctx.lineTo(x+15, y+5);
    ctx.closePath(); ctx.fill();
}

function drawBuilding(x, y, type) {
    ctx.fillStyle = (type === 'farm') ? "#f59e0b" : "#8b5cf6";
    ctx.fillRect(x-10, y-20, 20, 20); // ç°¡å–®ç«‹é«”å¡Š
    ctx.strokeStyle = "#fff";
    ctx.strokeRect(x-10, y-20, 20, 20);
}

/* ----- 3. æ ¸å¿ƒåŠŸèƒ½: å»ºè¨­èˆ‡è³‡æº ----- */
function build(type) {
    const cost = { farm: {g:100, w:50}, factory: {g:200, w:100, s:50} }[type];
    
    // æª¢æŸ¥è³‡æº
    if(state.gold < cost.g || state.wood < cost.w || (cost.s && state.stone < cost.s)) {
        toast("è³‡æºä¸è¶³ï¼è«‹å…ˆé»æ“Šæ£®æ—æ¡é›†ã€‚");
        aiSay("çˆ¸çˆ¸ï¼Œè³‡æºå””å¤ å‘€ï¼Œå»æ£®æ—é»å¹¾ä¸‹å•¦ï¼");
        return;
    }
    
    // æª¢æŸ¥åœ°å¡Šæ˜¯å¦å·²æœ‰å»ºç¯‰
    if(state.buildings.some(b => b.x === selectedTile.x && b.y === selectedTile.y)) {
        toast("é€™è£¡å·²ç¶“æœ‰å»ºç¯‰äº†ï¼");
        return;
    }

    // æ‰£é™¤è³‡æºä¸¦å»ºé€ 
    state.gold -= cost.g; state.wood -= cost.w;
    if(cost.s) state.stone -= cost.s;
    
    state.buildings.push({ x: selectedTile.x, y: selectedTile.y, type, lv: 1 });
    toast("å»ºé€ æˆåŠŸï¼");
    updateUI();
    renderPanel();
}

/* ----- 4. è‡ªå‹•æ”¶è³‡æºé‚è¼¯ (çˆ¸çˆ¸æœ€é—œå¿ƒçš„) ----- */
setInterval(() => {
    state.buildings.forEach(b => {
        if(b.type === 'farm') { state.gold += 1; state.wood += 0.5; }
        if(b.type === 'factory') { state.gold += 5; }
    });
    
    // ç¸æ½®å€’æ•¸
    if(state.beastTimer > 0) state.beastTimer--;
    else {
        state.beastTimer = 90;
        state.gold += 50; 
        aiSay("é˜²ç¦¦æˆåŠŸï¼æˆ°åˆ©å“ +50 é‡‘å¹£å·²å…¥è³¬ã€‚");
    }
    updateUI();
}, 1000);

/* ----- 5. æ‰‹å‹•æ¡é›† (è§£æ±ºé–‹å±€è³‡æºå•é¡Œ) ----- */
cv.addEventListener("touchstart", (e) => {
    // é€™è£¡ç°¡åŒ–é»æ“Šåˆ¤å®šï¼Œå¯¦éš›é–‹ç™¼ä¸­æ‡‰è½‰æ› Iso åæ¨™
    // ç‚ºäº†æ¼”ç¤ºï¼šé»æ“Šå°±ç•¶ä½œé¸ä¸­åœ°å¡Šä¸¦æ¡é›†
    const tile = state.map[selectedTile.y][selectedTile.x];
    if(tile.type === "forest") { state.wood += 5; aiSay("æ¡é›†æœ¨æ +5"); }
    else { state.gold += 2; aiSay("æ¡é›†é‡‘å¹£ +2"); }
    updateUI();
});

/* ----- ä»‹é¢æ§åˆ¶ ----- */
function updateUI() {
    document.getElementById("res-gold").innerText = Math.floor(state.gold);
    document.getElementById("res-wood").innerText = Math.floor(state.wood);
    document.getElementById("res-stone").innerText = Math.floor(state.stone);
    document.getElementById("res-aeno").innerText = Math.floor(state.aeno);
    localStorage.setItem("AENO_V3_FINAL", JSON.stringify(state));
}

function aiSay(txt) { document.getElementById("ai-text").innerText = txt; }
function toast(msg) {
    const t = document.getElementById("toast");
    t.innerText = msg; t.style.display = "block";
    setTimeout(()=> t.style.display="none", 2000);
}

function togglePanel() { document.getElementById("panel").classList.toggle("hide"); renderPanel(); }
function setTab(t, e) {
    currentTab = t;
    document.querySelectorAll(".tab").forEach(el => el.classList.remove("active"));
    e.target.classList.add("active");
    renderPanel();
}

let currentTab = 'build';
function renderPanel() {
    const body = document.getElementById("panelBody");
    if(currentTab === 'build') {
        body.innerHTML = `
            <div class="card">
                <b>ğŸ—ï¸ é¸ä¸­åœ°å¡Š: (${selectedTile.x}, ${selectedTile.y})</b><br>
                <small>åœ°å½¢: ${state.map[selectedTile.y][selectedTile.x].type}</small>
            </div>
            <div class="card">
                <b>è¾²ç”°</b> (ç”¢å‡ºé‡‘å¹£èˆ‡æœ¨æ)<br>
                <button class="btn btn-primary" onclick="build('farm')">å»ºé€  (ğŸ’°100, ğŸªµ50)</button>
            </div>
            <div class="card">
                <b>é‡å­å·¥å» </b> (å¤§é‡ç”¢å‡ºé‡‘å¹£)<br>
                <button class="btn btn-gold" onclick="build('factory')">å»ºé€  (ğŸ’°200, ğŸªµ100, ğŸª¨50)</button>
            </div>
        `;
    } else if(currentTab === 'market') {
        body.innerHTML = `<div class="card"><b>ğŸ’¹ äº¤æ˜“æ‰€</b><br><p>è‡ªå‹•åŒæ­¥ AENO è‚¡å¸‚åƒ¹æ ¼...</p><button class="btn btn-green">è²·å…¥æœ¨æ</button></div>`;
    } else {
        body.innerHTML = `<div class="card"><b>ğŸ“¡ ç›£æ§ä¸­</b><br><p>ç›®å‰å¸åœ‹ä¸€åˆ‡æ­£å¸¸ã€‚</p></div>`;
    }
}

/* ----- å•Ÿå‹• ----- */
cv.width = cv.offsetWidth; cv.height = cv.offsetHeight;
initMap();
updateUI();
draw();
aiSay("çˆ¸çˆ¸ï¼Œ3D å¼•æ“é‚„åŸå®Œæˆï¼é»æ“Šæ£®æ—è©¦è©¦æ¡é›†ã€‚");

</script>
</body>
</html>
