<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
<title>AENO V3 æ–‡æ˜å¸åœ‹ï¼ˆå®Œæ•´ç‰ˆï¼‰</title>

<style>
:root{
  --bg:#dff1ff;
  --card:#ffffff;
  --shadow:0 14px 40px rgba(0,0,0,.18);
  --line:#e6eefc;
  --blue:#3b82f6;
  --green:#22c55e;
  --orange:#f59e0b;
  --red:#ef4444;
  --pink:#ec4899;
  --purple:#8b5cf6;
  --text:#0f172a;
}

html,body{
  margin:0;padding:0;height:100%;
  background:linear-gradient(#e9f7ff,#dceeff);
  overflow:hidden;
  font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans HK", sans-serif;
  color:var(--text);
}

#root{position:absolute; inset:0; overflow:hidden;}
canvas{
  position:absolute; inset:0;
  background:linear-gradient(#bfe8ff,#dff1ff);
  touch-action:none;
}

.floatBar{
  position:absolute;
  top:10px; left:10px; right:10px;
  display:flex; gap:10px;
  z-index:20;
  align-items:center;
  justify-content:space-between;
}

.titleBox{
  flex:1;
  background:rgba(255,255,255,.82);
  border:1px solid rgba(255,255,255,.6);
  border-radius:20px;
  padding:10px 14px;
  box-shadow:0 10px 30px rgba(0,0,0,.12);
  backdrop-filter: blur(10px);
  display:flex;
  align-items:center;
  gap:12px;
}

.logo{
  width:44px;height:44px;
  border-radius:50%;
  background:linear-gradient(#34d399,#22c55e);
  display:flex;align-items:center;justify-content:center;
  font-weight:900;color:#fff;
  box-shadow:0 8px 20px rgba(0,0,0,.18);
}

.titleText{
  line-height:1.05;
}
.titleText b{font-size:16px;}
.titleText span{font-size:12px; opacity:.7}

.topBtns{
  display:flex;
  gap:8px;
}
.circleBtn{
  width:54px;height:54px;border-radius:50%;
  border:none;
  box-shadow:0 10px 25px rgba(0,0,0,.18);
  font-size:20px;
  font-weight:900;
  cursor:pointer;
}
.btnBlue{background:linear-gradient(#60a5fa,#3b82f6); color:#fff;}
.btnGreen{background:linear-gradient(#4ade80,#22c55e); color:#fff;}
.btnOrange{background:linear-gradient(#fdba74,#f97316); color:#fff;}
.btnPurple{background:linear-gradient(#c4b5fd,#8b5cf6); color:#fff;}

/* åš´æ ¼é™åˆ¶ï¼šé¢æ¿ â‰¤ è¢å¹•1/4 */
.panel{
  position:absolute;
  top:88px; left:10px;
  width:24vw;
  max-width:24vw;
  height:24vh;
  max-height:24vh;
  background:rgba(255,255,255,.92);
  border:1px solid rgba(255,255,255,.6);
  border-radius:22px;
  box-shadow:var(--shadow);
  backdrop-filter: blur(12px);
  z-index:30;
  overflow:hidden;
  display:flex;
  flex-direction:column;
  resize:both;
}

.panel.hidden{display:none;}

.panel header{
  padding:10px 12px;
  background:linear-gradient(#ffffff,#f3f7ff);
  border-bottom:1px solid var(--line);
  display:flex;
  align-items:center;
  justify-content:space-between;
  cursor:move;
  user-select:none;
}

.panel header b{font-size:14px;}
.panel header small{opacity:.65}

.panelBody{
  padding:10px;
  overflow:auto;
  flex:1;
}

.tabs{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  margin-bottom:10px;
}

.tabBtn{
  border:none;
  padding:8px 12px;
  border-radius:16px;
  background:#f1f5ff;
  cursor:pointer;
  font-weight:700;
  font-size:12px;
}
.tabBtn.active{
  background:linear-gradient(#60a5fa,#3b82f6);
  color:#fff;
}

.card{
  background:rgba(255,255,255,.95);
  border:1px solid var(--line);
  border-radius:18px;
  padding:10px;
  margin-bottom:10px;
  box-shadow:0 10px 25px rgba(0,0,0,.08);
}

.row{
  display:flex;
  justify-content:space-between;
  gap:8px;
  align-items:center;
  flex-wrap:wrap;
}

.small{font-size:12px; opacity:.72}

.bigStat{
  font-size:14px;
  font-weight:900;
}

.btn{
  border:none;
  padding:10px 12px;
  border-radius:16px;
  cursor:pointer;
  font-weight:900;
  font-size:13px;
  box-shadow:0 10px 20px rgba(0,0,0,.12);
}
.btn.full{width:100%}
.bBlue{background:linear-gradient(#60a5fa,#3b82f6);color:#fff}
.bGreen{background:linear-gradient(#4ade80,#22c55e);color:#fff}
.bOrange{background:linear-gradient(#fdba74,#f97316);color:#fff}
.bRed{background:linear-gradient(#fb7185,#ef4444);color:#fff}
.bPurple{background:linear-gradient(#c4b5fd,#8b5cf6);color:#fff}
.bGray{background:linear-gradient(#e2e8f0,#cbd5e1);color:#111}

.input{
  width:100%;
  border-radius:14px;
  border:1px solid #dbeafe;
  padding:10px;
  font-weight:800;
  font-size:13px;
  outline:none;
}

/* AIé¢æ¿ åš´æ ¼ â‰¤ è¢å¹•1/4 + æ‹‰æ”¾ */
.aiPanel{
  position:absolute;
  right:10px;
  top:120px;
  width:24vw;
  max-width:24vw;
  height:24vh;
  max-height:24vh;
  background:rgba(255,255,255,.92);
  border-radius:22px;
  border:1px solid rgba(255,255,255,.6);
  box-shadow:var(--shadow);
  z-index:35;
  overflow:hidden;
  display:flex;
  flex-direction:column;
  resize:both;
}

.aiPanel.hidden{display:none;}

.aiPanel header{
  padding:10px 12px;
  background:linear-gradient(#ffffff,#f3f7ff);
  border-bottom:1px solid var(--line);
  cursor:move;
  user-select:none;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.chat{
  flex:1;
  padding:10px;
  overflow:auto;
  font-size:13px;
}

.msg{
  margin-bottom:8px;
  padding:10px 12px;
  border-radius:16px;
  background:#f3f7ff;
  border:1px solid #dbeafe;
}

.msg.ai{background:#fff7ed;border:1px solid #fed7aa}
.msg.sys{background:#f1f5f9;border:1px solid #e2e8f0}
.msg b{color:#2563eb}

.chatInput{
  display:flex;
  gap:8px;
  padding:10px;
  border-top:1px solid var(--line);
  background:rgba(255,255,255,.9);
}

.chatInput input{
  flex:1;
  border-radius:16px;
  border:1px solid #dbeafe;
  padding:10px;
  font-weight:900;
  outline:none;
}

.chatInput button{
  width:90px;
  border:none;
  border-radius:16px;
  font-weight:900;
  cursor:pointer;
  background:linear-gradient(#4ade80,#22c55e);
  color:#fff;
}

.floatingMini{
  position:absolute;
  right:12px;
  bottom:12px;
  z-index:60;
  display:flex;
  flex-direction:column;
  gap:10px;
}

.miniBtn{
  width:56px;height:56px;border-radius:50%;
  border:none;
  cursor:pointer;
  box-shadow:0 12px 28px rgba(0,0,0,.18);
  font-size:22px;
  font-weight:900;
}

.miniA{background:linear-gradient(#fde68a,#f59e0b); color:#000;}
.miniP{background:linear-gradient(#c4b5fd,#8b5cf6); color:#fff;}
.miniS{background:linear-gradient(#93c5fd,#3b82f6); color:#fff;}

.toast{
  position:absolute;
  left:50%;
  transform:translateX(-50%);
  bottom:18px;
  background:rgba(0,0,0,.75);
  color:#fff;
  padding:10px 14px;
  border-radius:16px;
  font-weight:900;
  z-index:100;
  display:none;
}

/* ç™»éŒ„å½ˆçª— */
#loginModal{
  position:fixed;
  top:0;left:0;right:0;bottom:0;
  background:rgba(0,0,0,0.5);
  z-index:9999;
  display:flex;
  align-items:center;
  justify-content:center;
}
.loginBox{
  background:#fff;
  padding:25px 30px;
  border-radius:20px;
  width:90%;
  max-width:380px;
  box-shadow:0 10px 30px rgba(0,0,0,0.2);
}
.loginBox h3{
  margin:0 0 15px;
  text-align:center;
}
.loginBox input{
  width:100%;
  padding:12px;
  margin-bottom:12px;
  border-radius:12px;
  border:1px solid #ddd;
  box-sizing:border-box;
  font-size:15px;
}
.loginBox button{
  width:100%;
  padding:12px;
  border-radius:12px;
  border:none;
  background:linear-gradient(90deg,#3b82f6,#8b5cf6);
  color:#fff;
  font-weight:bold;
  font-size:16px;
  cursor:pointer;
}

/* æ˜Ÿçƒé¸æ“‡å½ˆçª— */
#planetModal{
  position:fixed;
  top:0;left:0;right:0;bottom:0;
  background:rgba(0,0,0,0.5);
  z-index:9998;
  display:none;
  align-items:center;
  justify-content:center;
}
.planetBox{
  background:#fff;
  padding:25px 30px;
  border-radius:20px;
  width:90%;
  max-width:380px;
  box-shadow:0 10px 30px rgba(0,0,0,0.2);
}
.planetBox h3{
  margin:0 0 15px;
  text-align:center;
}
.planetBox select{
  width:100%;
  padding:12px;
  margin-bottom:12px;
  border-radius:12px;
  border:1px solid #ddd;
  font-size:15px;
}
.planetBox button{
  width:100%;
  padding:12px;
  border-radius:12px;
  border:none;
  background:linear-gradient(90deg,#22c55e,#3b82f6);
  color:#fff;
  font-weight:bold;
  font-size:16px;
  cursor:pointer;
}
</style>
</head>
<body>

<!-- ç™»éŒ„å½ˆçª—ï¼šIDå¿…å¡«ï¼Œå¯†ç¢¼ä»»æ„éƒ½å¯ä»¥é -->
<div id="loginModal">
  <div class="loginBox">
    <h3>AENO æœƒå“¡ç™»éŒ„</h3>
    <input id="loginId" type="text" placeholder="è«‹è¼¸å…¥ç©å®¶IDï¼ˆå¿…å¡«ï¼‰">
    <input id="loginPwd" type="password" placeholder="å¯†ç¢¼ï¼ˆä»»æ„è¼¸å…¥å³å¯ï¼‰">
    <button onclick="doLogin()">ç™»éŒ„</button>
  </div>
</div>

<!-- æ˜Ÿçƒé¸æ“‡å½ˆçª— -->
<div id="planetModal">
  <div class="planetBox">
    <h3>é¸æ“‡ä½ çš„æ˜Ÿçƒ</h3>
    <select id="planetSelect">
      <option value="earth">ç¶ åŸæ˜Ÿ - å¹³è¡¡å‹</option>
      <option value="mars">èµ¤éµæ˜Ÿ - ç¤¦ç”¢åŠ æˆ</option>
    </select>
    <button onclick="startGameAfterSelect()">é€²å…¥å¸åœ‹</button>
  </div>
</div>

<div id="root">
  <canvas id="cv"></canvas>

  <div class="floatBar">
    <div class="titleBox">
      <div class="logo">A</div>
      <div class="titleText">
        <b>AENO V3 æ–‡æ˜å¸åœ‹</b><br>
        <span id="statusText">è¼‰å…¥ä¸­...</span>
      </div>
    </div>

    <div class="topBtns">
      <button class="circleBtn btnBlue" onclick="centerView()">ä¸­</button>
      <button class="circleBtn btnGreen" onclick="zoomIn()">+</button>
      <button class="circleBtn btnOrange" onclick="zoomOut()">-</button>
      <button class="circleBtn btnPurple" onclick="manualSave()">å­˜</button>
    </div>
  </div>

  <!-- ä¸»é¢æ¿ -->
  <div id="panel" class="panel">
    <header>
      <div>
        <b>å¸åœ‹å¤§é¢æ¿</b><br>
        <small id="panelSub">æ‰€æœ‰ç³»çµ±æ•´åˆ</small>
      </div>
      <button class="btn bGray" onclick="togglePanel()">æ”¶èµ·</button>
    </header>

    <div class="panelBody">
      <div class="tabs">
        <button class="tabBtn active" data-tab="res" onclick="switchTab('res')">è³‡æº</button>
        <button class="tabBtn" data-tab="build" onclick="switchTab('build')">å»ºè¨­</button>
        <button class="tabBtn" data-tab="market" onclick="switchTab('market')">äº¤æ˜“æ‰€</button>
        <button class="tabBtn" data-tab="stock" onclick="switchTab('stock')">è‚¡å¸‚</button>
        <button class="tabBtn" data-tab="tech" onclick="switchTab('tech')">ç§‘æŠ€æ¨¹</button>
        <button class="tabBtn" data-tab="events" onclick="switchTab('events')">äº‹ä»¶</button>
        <button class="tabBtn" data-tab="ads" onclick="switchTab('ads')">å»£å‘Š/æ­Œæ›²</button>
        <button class="tabBtn" data-tab="robot" onclick="switchTab('robot')">æ©Ÿå™¨äºº</button>
      </div>

      <!-- è³‡æº -->
      <div class="tab" id="tab_res">
        <div class="card">
          <div class="row">
            <div class="bigStat">ğŸŒ² æœ¨æ: <span id="r_wood">0</span></div>
            <div class="bigStat">ğŸª¨ çŸ³é ­: <span id="r_stone">0</span></div>
          </div>
          <div class="row">
            <div class="bigStat">â›ï¸ éµç¤¦: <span id="r_iron">0</span></div>
            <div class="bigStat">ğŸŒ¾ ç³§é£Ÿ: <span id="r_food">0</span></div>
          </div>
          <div class="row">
            <div class="bigStat">ğŸª™ é‡‘å¹£: <span id="r_coin">0</span></div>
            <div class="bigStat">ğŸ’ AENO: <span id="r_aeno">0</span></div>
          </div>
          <div class="row small">
            <div>ğŸ‘¥ äººå£: <span id="r_pop">0</span>/<span id="r_popcap">0</span></div>
            <div>ğŸ§‘â€ğŸ”§ å·¥äºº: <span id="r_workers">0</span></div>
          </div>
          <div class="row small">
            <div>é ˜åœŸåŠå¾‘: <span id="r_radius">0</span></div>
            <div>é›¢ç·šæ”¶ç›Š: <span id="r_offline">0</span> ç§’</div>
          </div>
        </div>

        <div class="card">
          <div class="row">
            <button class="btn bPurple" onclick="toggleAutoBuild()">AIè‡ªå‹•å»ºè¨­: <span id="autoTxt">ON</span></button>
            <button class="btn bOrange" onclick="toggleAutoExpand()">è‡ªå‹•æ“´åœŸ: <span id="expandTxt">ON</span></button>
          </div>
          <div class="row">
            <button class="btn bBlue full" onclick="centerView()">ğŸ“ å›åˆ°ä¸­å¿ƒ</button>
          </div>
        </div>
      </div>

      <!-- å»ºè¨­ -->
      <div class="tab" id="tab_build" style="display:none">
        <div class="card">
          <div class="small">é»åœ°åœ–æ ¼ä»”å¾Œï¼Œå¯å»ºé€ ï¼ˆé ˜åœŸå…§æ‰å¯ï¼‰ã€‚AIäº¦æœƒè‡ªå‹•èµ·å±‹/è¾²ç”°/ä¼æœ¨ã€‚</div>
        </div>

        <div class="card">
          <div class="row"><b>å»ºç¯‰åˆ—è¡¨</b></div>
          <div class="row">
            <button class="btn bGreen" onclick="setBuildMode('house')">ğŸ  æˆ¿å±‹</button>
            <button class="btn bBlue" onclick="setBuildMode('farm')">ğŸŒ¾ è¾²ç”°</button>
          </div>
          <div class="row">
            <button class="btn bOrange" onclick="setBuildMode('lumber')">ğŸª“ ä¼æœ¨å ´</button>
            <button class="btn bPurple" onclick="setBuildMode('mine')">â›ï¸ ç¤¦å ´</button>
          </div>
          <div class="row">
            <button class="btn bRed" onclick="setBuildMode('wall')">ğŸ§± åŸç‰†</button>
            <button class="btn bGray" onclick="setBuildMode(null)">å–æ¶ˆ</button>
          </div>
          <div class="small" id="buildModeText">å»ºé€ æ¨¡å¼ï¼šç„¡</div>
        </div>

        <div class="card">
          <b>å‡ç´šä¸­å¿ƒ</b>
          <div class="small">é¸ä¸­å»ºç¯‰å¾Œå¯å‡ç´šï¼ˆAIäº¦æœƒåŠè‡ªå‹•å‡ç´šï¼‰ã€‚</div>
          <button class="btn bBlue full" onclick="upgradeSelected()">â¬†ï¸ å‡ç´šé¸ä¸­å»ºç¯‰</button>
        </div>

        <div class="card">
          <b>æ“´å¼µé ˜åœŸï¼ˆæ‰‹å‹•ï¼‰</b>
          <div class="small">ä¸»è¦ç”±ç³»çµ±è‡ªå‹•æ“´å¼µï¼Œä½†ä½ å¯æ‰‹å‹•æ¨é€²ã€‚</div>
          <button class="btn bOrange full" onclick="expandTerritoryManual()">ğŸ—ºï¸ ç«‹å³æ“´å¼µ</button>
        </div>
      </div>

      <!-- äº¤æ˜“æ‰€ -->
      <div class="tab" id="tab_market" style="display:none">
        <div class="card">
          <b>äº¤æ˜“æ‰€ï¼ˆè³‡æºæ›é‡‘å¹£ï¼‰</b>
          <div class="small">åƒ¹æ ¼æœƒæ³¢å‹•ï¼ˆæ¯3åˆ†é˜æ›´æ–°ï¼‰ã€‚</div>
        </div>

        <div class="card">
          <div class="row">
            <div>æœ¨æåƒ¹æ ¼: <b id="p_wood">0</b></div>
            <div>çŸ³é ­åƒ¹æ ¼: <b id="p_stone">0</b></div>
          </div>
          <div class="row">
            <div>éµç¤¦åƒ¹æ ¼: <b id="p_iron">0</b></div>
            <div>ç³§é£Ÿåƒ¹æ ¼: <b id="p_food">0</b></div>
          </div>
          <hr>
          <input id="tradeAmt" class="input" type="number" value="20" min="1">
          <div class="row">
            <button class="btn bGreen" onclick="trade('buy','wood')">è²·æœ¨</button>
            <button class="btn bOrange" onclick="trade('sell','wood')">è³£æœ¨</button>
          </div>
          <div class="row">
            <button class="btn bGreen" onclick="trade('buy','stone')">è²·çŸ³</button>
            <button class="btn bOrange" onclick="trade('sell','stone')">è³£çŸ³</button>
          </div>
          <div class="row">
            <button class="btn bGreen" onclick="trade('buy','iron')">è²·éµ</button>
            <button class="btn bOrange" onclick="trade('sell','iron')">è³£éµ</button>
          </div>
          <div class="row">
            <button class="btn bGreen" onclick="trade('buy','food')">è²·ç³§</button>
            <button class="btn bOrange" onclick="trade('sell','food')">è³£ç³§</button>
          </div>
        </div>
      </div>

      <!-- è‚¡å¸‚ -->
      <div class="tab" id="tab_stock" style="display:none">
        <div class="card">
          <b>è‚¡å¸‚ï¼ˆç°¡åŒ–ç‰ˆï¼‰</b>
          <div class="small">ç©å®¶å¯æŠ•è³‡æ˜Ÿçƒå…¬å¸ã€‚æ¯180ç§’æ³¢å‹•ã€‚</div>
        </div>

        <div class="card">
          <div class="row">
            <div>ğŸ­ å·¥æ¥­è‚¡: <b id="s_ind">0</b></div>
            <button class="btn bGreen" onclick="stock('buy','ind')">è²·</button>
            <button class="btn bOrange" onclick="stock('sell','ind')">è³£</button>
          </div>
          <div class="row">
            <div>ğŸš€ å¤ªç©ºè‚¡: <b id="s_space">0</b></div>
            <button class="btn bGreen" onclick="stock('buy','space')">è²·</button>
            <button class="btn bOrange" onclick="stock('sell','space')">è³£</button>
          </div>
          <div class="row">
            <div>ğŸŒ¿ è¾²æ¥­è‚¡: <b id="s_farm">0</b></div>
            <button class="btn bGreen" onclick="stock('buy','farm')">è²·</button>
            <button class="btn bOrange" onclick="stock('sell','farm')">è³£</button>
          </div>
          <div class="small">ï¼ˆè‚¡å¸‚æ”¶ç›Šæœƒè½‰æˆé‡‘å¹£ï¼Œæ­£å¼ç‰ˆå¯é€£æ¥ Firebaseã€‚ï¼‰</div>
        </div>
      </div>

      <!-- ç§‘æŠ€æ¨¹ -->
      <div class="tab" id="tab_tech" style="display:none">
        <div class="card">
          <b>ç§‘æŠ€æ¨¹ï¼ˆéª¨æ¶ï¼‰</b>
          <div class="small">ç§‘æŠ€æœƒå½±éŸ¿æ•ˆç‡ã€è§£é–å»ºç¯‰ã€æ©Ÿå™¨äººã€‚</div>
        </div>

        <div class="card">
          <div class="row">
            <div>ğŸ”§ å·¥æ¥­Lv: <b id="t_ind">0</b></div>
            <button class="btn bBlue" onclick="research('ind')">ç ”ç©¶</button>
          </div>
          <div class="row">
            <div>ğŸ›¡ï¸ é˜²ç¦¦Lv: <b id="t_def">0</b></div>
            <button class="btn bBlue" onclick="research('def')">ç ”ç©¶</button>
          </div>
          <div class="row">
            <div>ğŸ¤– æ©Ÿå™¨äººLv: <b id="t_robot">0</b></div>
            <button class="btn bBlue" onclick="research('robot')">ç ”ç©¶</button>
          </div>
        </div>
      </div>

      <!-- äº‹ä»¶ -->
      <div class="tab" id="tab_events" style="display:none">
        <div class="card">
          <b>äº‹ä»¶ä¸­å¿ƒ</b>
          <div class="small">ç¸æ½® / æ å¥ª / æ¢ç´¢äº‹ä»¶éƒ½æœƒè¨˜éŒ„ã€‚</div>
        </div>

        <div class="card">
          <div class="row">
            <div>ç¸æ½®å€’æ•¸: <b id="beastTimer">0</b>s</div>
            <button class="btn bRed" onclick="forceBeast()">å¼·åˆ¶ç¸æ½®(æ¸¬è©¦)</button>
          </div>
          <div class="row">
            <div>é‡è »ç¢ç‰‡: <b id="shards">0</b></div>
            <button class="btn bOrange" onclick="collectLoot()">æ”¶å–æˆ°åˆ©å“</button>
          </div>
          <div class="small">ç¢ç‰‡æ¯”ä¾‹æœƒå½±éŸ¿ AENO å¢é•·ã€‚</div>
        </div>
      </div>

      <!-- å»£å‘Š -->
      <div class="tab" id="tab_ads" style="display:none">
        <div class="card">
          <b>å»£å‘Š / æ­Œæ›²</b>
          <div class="small">
            å»£å‘Šå•†æœªä¾†åªè¦æ”¹ ads.jsonï¼Œå°±å¯ä»¥æ›æ­Œ/æ›å»£å‘Šï¼Œä¸ç”¨æ›´æ–°ç¨‹å¼ã€‚
          </div>
        </div>

        <div class="card">
          <div class="row">
            <button class="btn bPurple" onclick="unlockAudio()">ğŸ”Š è§£é–éŸ³è¨Š</button>
            <button class="btn bGreen" onclick="playAdSong()">ğŸµ æ’­æ”¾å»£å‘Šæ­Œ</button>
          </div>
          <div class="row small">
            <div>ä»Šæ—¥è½æ­Œæ¯”ä¾‹: <b id="adRatio">0%</b></div>
            <div>å†·å»: <b id="adCd">0</b>s</div>
          </div>
          <div class="small" id="adNow">æœªæ’­æ”¾</div>
        </div>
      </div>

      <!-- æ©Ÿå™¨äºº -->
      <div class="tab" id="tab_robot" style="display:none">
        <div class="card">
          <b>æ©Ÿå™¨äººä¸­å¿ƒ</b>
          <div class="small">æ©Ÿå™¨äººæœƒå¤–å‡ºå¸¶å›è³‡æºï¼Œä¹Ÿå¯èƒ½éš¨æ©Ÿå·ä½  20%ã€‚</div>
        </div>

        <div class="card">
          <div class="row">
            <div>ç‹€æ…‹: <b id="robotStatus">å¾…å‘½</b></div>
            <button class="btn bBlue" onclick="sendRobot()">æ´¾å‡ºæ©Ÿå™¨äºº</button>
          </div>
          <div class="row small">
            <div>å›ä¾†å€’æ•¸: <b id="robotTimer">0</b>s</div>
            <div>æ å¥ªå€’æ•¸: <b id="stealTimer">0</b>s</div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- AI åŠ©æ‰‹é¢æ¿ -->
  <div id="aiPanel" class="aiPanel">
    <header>
      <div>
        <b>ğŸ¾ AIåŠ©æ‰‹ - Aenko</b><br>
        <small>å·¡é‚ä¸­ãƒ»å¤–æ›å¼æ–‡æ˜ç®¡ç†</small>
      </div>
      <button class="btn bGray" onclick="toggleAI()">æ”¶èµ·</button>
    </header>

    <div class="chat" id="chat"></div>

    <div class="chatInput">
      <input id="cmd" placeholder="è¼¸å…¥ï¼šå·¡é‚ / æ”¶é›† / å»ºé€  æˆ¿å±‹ / å‡ç´š / åœæ­¢è‡ªå‹•..." />
      <button onclick="sendCmd()">é€å‡º</button>
    </div>
  </div>

  <div class="floatingMini">
    <button class="miniBtn miniP" onclick="togglePanel()">â˜°</button>
    <button class="miniBtn miniA" onclick="toggleAI()">ğŸ¾</button>
    <button class="miniBtn miniS" onclick="manualSave()">ğŸ’¾</button>
  </div>

  <div class="toast" id="toast"></div>

  <audio id="audio">
</div>

<script>
/* =========================================================
   AENO V3 å„ªåŒ–ç‰ˆ
   - ä¿ç•™IDç™»éŒ„ + å¯†ç¢¼ä»»æ„æ”¾å¯¬
   - é¢æ¿åš´æ ¼1/4 + æ‹‰æ”¾
   - åŸç‰†æ»¿ç´šå…ˆå‡ºç¸æ½®
   - æ©Ÿå™¨äººæ¶20% / å®ˆè­·5%
========================================================= */

const SAVE_KEY="AENO_V3_SAVE_FULL";
const VERSION=9;

const GRID_W=26, GRID_H=26;
const TILE=64;

const cv=document.getElementById("cv");
const ctx=cv.getContext("2d");

let W=0,H=0;

const statusText=document.getElementById("statusText");
const toast=document.getElementById("toast");

const r_wood=document.getElementById("r_wood");
const r_stone=document.getElementById("r_stone");
const r_iron=document.getElementById("r_iron");
const r_food=document.getElementById("r_food");
const r_coin=document.getElementById("r_coin");
const r_aeno=document.getElementById("r_aeno");
const r_pop=document.getElementById("r_pop");
const r_popcap=document.getElementById("r_popcap");
const r_workers=document.getElementById("r_workers");
const r_radius=document.getElementById("r_radius");
const r_offline=document.getElementById("r_offline");

const autoTxt=document.getElementById("autoTxt");
const expandTxt=document.getElementById("expandTxt");

const p_wood=document.getElementById("p_wood");
const p_stone=document.getElementById("p_stone");
const p_iron=document.getElementById("p_iron");
const p_food=document.getElementById("p_food");

const s_ind=document.getElementById("s_ind");
const s_space=document.getElementById("s_space");
const s_farm=document.getElementById("s_farm");

const t_ind=document.getElementById("t_ind");
const t_def=document.getElementById("t_def");
const t_robot=document.getElementById("t_robot");

const beastTimer=document.getElementById("beastTimer");
const shards=document.getElementById("shards");

const adRatio=document.getElementById("adRatio");
const adCd=document.getElementById("adCd");
const adNow=document.getElementById("adNow");

const robotStatus=document.getElementById("robotStatus");
const robotTimer=document.getElementById("robotTimer");
const stealTimer=document.getElementById("stealTimer");

const chat=document.getElementById("chat");
const cmd=document.getElementById("cmd");

const audio=document.getElementById("audio");
let audioUnlocked=false;

let state={
  version:VERSION,
  lastSeen:Date.now(),
  resources:{wood:80,stone:50,iron:10,food:120,coin:200,aeno:1.0},
  pop:{population:6,cap:10},
  territory:{radius:3},
  settings:{autoBuild:true,autoExpand:true},
  prices:{wood:2,stone:3,iron:8,food:2},
  stock:{ind:100,space:120,farm:90,holding:{ind:0,space:0,farm:0}},
  tech:{ind:0,def:0,robot:0},
  ads:{cooldown:0,listenedToday:0,totalToday:10},
  beast:{timer:420,active:false,lootCoin:0,shards:0},
  robot:{active:false,timer:0,stealTimer:240,status:"å¾…å‘½",guard:false},
  map:{tiles:[],buildings:[]},
  ai:{x:12,y:12,mode:"patrol"},
  buildMode:null,selected:null
};

// ç™»éŒ„é‚è¼¯ï¼šIDå¿…å¡«ï¼Œå¯†ç¢¼ä»»æ„
function doLogin(){
  const id=document.getElementById("loginId").value.trim();
  if(!id){
    alert("è«‹è¼¸å…¥ç©å®¶IDï¼");
    return;
  }
  document.getElementById("loginModal").style.display="none";
  document.getElementById("planetModal").style.display="flex";
}

// æ˜Ÿçƒé¸æ“‡å¾Œå•Ÿå‹•éŠæˆ²
function startGameAfterSelect(){
  const p=document.getElementById("planetSelect").value;
  if(p==="mars"){
    state.resources.stone=80;
    state.resources.iron=40;
  }
  document.getElementById("planetModal").style.display="none";
  initGame();
}

function genMap(){
  state.map.tiles=[];
  for(let y=0;y<GRID_H;y++){
    let row=[];
    for(let x=0;x<GRID_W;x++){
      let t="grass";
      if(y===13||y===14){if(x>2&&x<23)t="river";}
      if(Math.random()<0.12&&t==="grass")t="mountain";
      if(Math.random()<0.18&&t==="grass")t="forest";
      if(Math.random()<0.07&&(t==="grass"||t==="mountain"))t="ore";
      row.push({t,level:0});
    }
    state.map.tiles.push(row);
  }
  state.map.tiles[12][12].t="grass";
  state.map.tiles[12][13].t="grass";
  state.map.tiles[13][12].t="grass";
  state.map.buildings=[{x:12,y:12,type:"base",level:1}];
}

function saveGame(){
  state.lastSeen=Date.now();
  localStorage.setItem(SAVE_KEY,JSON.stringify(state));
}
function loadGame(){
  const s=localStorage.getItem(SAVE_KEY);
  if(!s){genMap();saveGame();return;}
  try{
    const old=JSON.parse(s);
    state={...state,...old};
    if(!state.version)state.version=1;
    if(!state.resources)state.resources={wood:50,stone:20,iron:0,food:50,coin:50,aeno:0};
    if(!state.pop)state.pop={population:5,cap:10};
    if(!state.territory)state.territory={radius:3};
    if(!state.settings)state.settings={autoBuild:true,autoExpand:true};
    if(!state.ads)state.ads={cooldown:0,listenedToday:0,totalToday:10};
    if(!state.stock)state.stock={ind:100,space:120,farm:90,holding:{ind:0,space:0,farm:0}};
    if(!state.tech)state.tech={ind:0,def:0,robot:0};
    if(!state.beast)state.beast={timer:420,active:false,lootCoin:0,shards:0};
    if(!state.robot)state.robot={active:false,timer:0,stealTimer:240,status:"å¾…å‘½",guard:false};
    if(!state.ai)state.ai={x:12,y:12,mode:"patrol"};
    if(!state.map||!state.map.tiles||state.map.tiles.length===0)genMap();
    state.version=VERSION;
  }catch(e){genMap();}
}

let toastTimer=null;
function showToast(txt){
  toast.style.display="block";
  toast.textContent=txt;
  clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>toast.style.display="none",1600);
}

function switchTab(tab){
  document.querySelectorAll(".tabBtn").forEach(b=>{
    b.classList.toggle("active",b.dataset.tab===tab);
  });
  document.querySelectorAll(".tab").forEach(t=>t.style.display="none");
  document.getElementById("tab_"+tab).style.display="block";
}

function togglePanel(){document.getElementById("panel").classList.toggle("hidden");}
function toggleAI(){document.getElementById("aiPanel").classList.toggle("hidden");}

function makeDraggable(box){
  const header=box.querySelector("header");
  let dragging=false,sx=0,sy=0,ox=0,oy=0;
  header.addEventListener("pointerdown",(e)=>{
    dragging=true;sx=e.clientX;sy=e.clientY;
    const rect=box.getBoundingClientRect();
    ox=rect.left;oy=rect.top;
    header.setPointerCapture(e.pointerId);
  });
  header.addEventListener("pointermove",(e)=>{
    if(!dragging)return;
    const dx=e.clientX-sx;const dy=e.clientY-sy;
    box.style.left=(ox+dx)+"px";
    box.style.top=(oy+dy)+"px";
  });
  header.addEventListener("pointerup",()=>{dragging=false;});
}

function setBuildMode(t){
  state.buildMode=t;
  document.getElementById("buildModeText").textContent="å»ºé€ æ¨¡å¼ï¼š"+(t||"ç„¡");
  if(t)addChatMsg("ai","ğŸ› ï¸ å»ºé€ æ¨¡å¼ï¼š"+t);
}

function addChatMsg(type,text){
  const div=document.createElement("div");
  div.className="msg "+type;
  div.innerHTML=type==="ai"?"<b>Aenkoï¼š</b> "+text:type==="sys"?"<b>ç³»çµ±ï¼š</b> "+text:text;
  chat.appendChild(div);
  chat.scrollTop=chat.scrollHeight;
}

function sendCmd(){
  const t=cmd.value.trim();
  if(!t)return;cmd.value="";
  addChatMsg("sys","ä½ ï¼š"+t);
  parseCmd(t);
}

function parseCmd(t){
  const low=t.toLowerCase();
  if(t.includes("åœæ­¢è‡ªå‹•")){state.settings.autoBuild=false;state.settings.autoExpand=false;addChatMsg("ai","â›” å·²åœæ­¢è‡ªå‹•");return;}
  if(t.includes("é–‹å§‹è‡ªå‹•")||t.includes("å•Ÿå‹•è‡ªå‹•")){state.settings.autoBuild=true;state.settings.autoExpand=true;addChatMsg("ai","ğŸ¤– è‡ªå‹•é–‹å•Ÿ");return;}
  if(t.includes("å·¡é‚")){state.ai.mode="patrol";addChatMsg("ai","ğŸ¾ é–‹å§‹å·¡é‚");return;}
  if(t.includes("æ”¶é›†")){addChatMsg("ai","ğŸŒ² å·²æ´¾å·¥äººæ”¶é›†");return;}
  if(t.includes("å»ºé€ ")){
    if(t.includes("æˆ¿å±‹")){setBuildMode("house");addChatMsg("ai","ğŸ  è«‹é»åœ°åœ–");return;}
    if(t.includes("è¾²ç”°")){setBuildMode("farm");addChatMsg("ai","ğŸŒ¾ è«‹é»åœ°åœ–");return;}
    if(t.includes("ä¼æœ¨")){setBuildMode("lumber");addChatMsg("ai","ğŸª“ è«‹é»åœ°åœ–");return;}
    if(t.includes("ç¤¦")){setBuildMode("mine");addChatMsg("ai","â›ï¸ è«‹é»åœ°åœ–");return;}
  }
  if(t.includes("å‡ç´š")){upgradeSelected();return;}
  if(t.includes("æ’­æ”¾")&&t.includes("å»£å‘Š")){playAdSong();return;}
  if(t.includes("å®ˆè­·")){state.robot.guard=true;addChatMsg("ai","ğŸ›¡ï¸ æ©Ÿå™¨äººå®ˆè­·ä¸­");return;}
  addChatMsg("ai","ğŸ¤” è©¦ä¸‹ï¼šå·¡é‚/æ”¶é›†/å»ºé€ æˆ¿å±‹/å‡ç´š/å®ˆè­·");
}

function toggleAutoBuild(){state.settings.autoBuild=!state.settings.autoBuild;addChatMsg("ai",state.settings.autoBuild?"ğŸ¤– è‡ªå‹•å»ºè¨­ON":"â›” OFF");}
function toggleAutoExpand(){state.settings.autoExpand=!state.settings.autoExpand;addChatMsg("ai",state.settings.autoExpand?"ğŸ—ºï¸ è‡ªå‹•æ“´åœŸON":"â›” OFF");}

function clamp(v,a,b){return Math.max(a,Math.min(b,v));}

let cam={x:0,y:0,scale:1};
function centerView(){cam.x=-(12*TILE)+W/2;cam.y=-(12*TILE)+H/2;}
function zoomIn(){cam.scale=clamp(cam.scale*1.15,0.6,2.4);}
function zoomOut(){cam.scale=clamp(cam.scale/1.15,0.6,2.4);}

let dragging=false,lastX=0,lastY=0,selectedTile=null;
cv.addEventListener("pointerdown",(e)=>{dragging=true;lastX=e.clientX;lastY=e.clientY;cv.setPointerCapture(e.pointerId);});
cv.addEventListener("pointermove",(e)=>{if(!dragging)return;const dx=e.clientX-lastX;const dy=e.clientY-lastY;lastX=e.clientX;lastY=e.clientY;cam.x+=dx;cam.y+=dy;});
cv.addEventListener("pointerup",(e)=>{
  dragging=false;
  const p=screenToWorld(e.clientX,e.clientY);
  const tx=Math.floor(p.x/TILE);const ty=Math.floor(p.y/TILE);
  if(tx>=0&&ty>=0&&tx<GRID_W&&ty<GRID_H){selectedTile={x:tx,y:ty};tryBuild(tx,ty);}
});

function screenToWorld(sx,sy){return {x:(sx-cam.x)/cam.scale,y:(sy-cam.y)/cam.scale};}
function inTerritory(x,y){const cx=12,cy=12;const dx=x-cx,dy=y-cy;return (dx*dx+dy*dy)<=(state.territory.radius*state.territory.radius);}
function buildingAt(x,y){return state.map.buildings.find(b=>b.x===x&&b.y===y);}

function costOf(type){
  const lvl=1;
  if(type==="house")return {wood:25,stone:10,coin:20};
  if(type==="farm")return {wood:15,stone:5,coin:10};
  if(type==="lumber")return {wood:10,stone:5,coin:10};
  if(type==="mine")return {wood:20,stone:15,coin:20};
  if(type==="wall")return {wood:15,stone:25,coin:30};
  return {wood:0,stone:0,coin:0};
}
function canPay(c){return state.resources.wood>=c.wood&&state.resources.stone>=c.stone&&state.resources.coin>=c.coin;}
function pay(c){state.resources.wood-=c.wood;state.resources.stone-=c.stone;state.resources.coin-=c.coin;}

function tryBuild(x,y){
  if(!state.buildMode)return;
  if(!inTerritory(x,y)){addChatMsg("ai","âŒ é ˜åœŸå¤–");showToast("é ˜åœŸå¤–ä¸å¯å»º");return;}
  if(buildingAt(x,y)){addChatMsg("ai","âŒ å·²æœ‰å»ºç¯‰");return;}
  const tile=state.map.tiles[y][x];
  if(tile.t==="river"){addChatMsg("ai","âŒ æ²³æµä¸Šä¸å¯å»º");return;}
  const c=costOf(state.buildMode);
  if(!canPay(c)){addChatMsg("ai","âŒ è³‡æºä¸è¶³");showToast("è³‡æºä¸è¶³");return;}
  pay(c);
  state.map.buildings.push({x,y,type:state.buildMode,level:1});
  addChatMsg("ai","âœ… å»ºé€ å®Œæˆï¼š"+state.buildMode);
  showToast("å»ºç¯‰å®Œæˆ");
  state.buildMode=null;document.getElementById("buildModeText").textContent="å»ºé€ æ¨¡å¼ï¼šç„¡";
}

function upgradeSelected(){
  if(!selectedTile){addChatMsg("ai","âŒ è«‹å…ˆé»é¸");return;}
  const b=buildingAt(selectedTile.x,selectedTile.y);
  if(!b){addChatMsg("ai","âŒ ç„¡å»ºç¯‰");return;}
  const cost={wood:20*b.level,stone:15*b.level,coin:30*b.level};
  if(!canPay(cost)){addChatMsg("ai","âŒ å‡ç´šè³‡æºä¸è¶³");return;}
  pay(cost);b.level++;
  addChatMsg("ai","â¬†ï¸ å‡ç´šæˆåŠŸï¼š"+b.type+" Lv"+b.level);showToast("å‡ç´šæˆåŠŸ");
}

function expandTerritoryManual(){
  const r=state.territory.radius;
  const costWood=40+r*15,costCoin=80+r*25;
  if(state.resources.wood>=costWood&&state.resources.coin>=costCoin){
    state.resources.wood-=costWood;state.resources.coin-=costCoin;state.territory.radius++;
    addChatMsg("ai","ğŸ—ºï¸ æ‰‹å‹•æ“´å¼µï¼š"+state.territory.radius);
  }else{addChatMsg("ai","âŒ è³‡æºä¸è¶³");}
}

function prodRate(){
  let w=0,s=0,i=0,f=0,c=0;
  const workers=Math.max(1,Math.floor(state.pop.population*0.6));
  w+=workers*0.6;s+=workers*0.25;
  for(const b of state.map.buildings){
    if(b.type==="farm"){f+=1.8*b.level;c+=0.25*b.level;}
    if(b.type==="lumber"){w+=2.2*b.level;c+=0.2*b.level;}
    if(b.type==="mine"){i+=1.1*b.level;s+=0.6*b.level;c+=0.35*b.level;}
    if(b.type==="base"){c+=0.5*b.level;}
  }
  f-=state.pop.population*0.22;
  return {w,s,i,f,c,workers};
}

function calcAenoGain(seconds){
  const ratio=clamp(state.ads.listenedToday/Math.max(1,state.ads.totalToday),0,1);
  const shardRatio=clamp(state.beast.shards/500,0,1);
  const base=0.0000015*seconds;
  return base+(0.000018*seconds*ratio)+(0.00002*seconds*shardRatio);
}

// ç¸æ½®ï¼šåŸç‰†ç¸½ç­‰ç´š >=10 å…ˆè§¸ç™¼
function spawnBeastWave(){
  let wallTotal=0;
  for(const b of state.map.buildings){if(b.type==="wall")wallTotal+=b.level;}
  if(wallTotal<10){addChatMsg("ai","ğŸ›¡ï¸ åŸç‰†æœªæ»¿ç´šï¼Œå””æœƒå‡ºç¸æ½®");return;}
  state.beast.active=true;
  addChatMsg("ai","âš”ï¸ ç¸æ½®çˆ†ç™¼ï¼");showToast("ç¸æ½®çˆ†ç™¼ï¼");
}

function resolveBeastWave(){
  let wall=0;for(const b of state.map.buildings){if(b.type==="wall")wall+=b.level;}
  const defPower=wall+state.tech.def*3;
  const atk=10+Math.random()*20;
  if(defPower>=atk){
    const loot=Math.floor(50+Math.random()*120);
    const shard=Math.floor(10+Math.random()*30);
    state.beast.lootCoin+=loot;state.beast.shards+=shard;
    addChatMsg("ai","âœ… æ“Šé€€ç¸æ½®ï¼é‡‘å¹£+"+loot+" ç¢ç‰‡+"+shard);
  }else{
    const stolen=Math.floor(state.resources.coin*0.08);
    state.resources.coin-=stolen;
    addChatMsg("ai","âŒ è¢«æ å¥ªé‡‘å¹£-"+stolen);
  }
  state.beast.active=false;state.beast.timer=360+Math.floor(Math.random()*300);
}

function forceBeast(){state.beast.timer=0;}
function collectLoot(){
  if(state.beast.lootCoin<=0){addChatMsg("ai","ç„¡æˆ°åˆ©å“");return;}
  state.resources.coin+=state.beast.lootCoin;
  addChatMsg("ai","ğŸª™ æ”¶å–é‡‘å¹£+"+state.beast.lootCoin);
  state.beast.lootCoin=0;
}

function spawnRobot(){state.robot.active=true;state.robot.timer=180+Math.floor(Math.random()*120);state.robot.status="æ¢ç´¢ä¸­";addChatMsg("ai","ğŸ¤– æ©Ÿå™¨äººå·²å‡ºç™¼");}
function sendRobot(){if(state.robot.active){addChatMsg("ai","ä»»å‹™ä¸­");return;}spawnRobot();}
function robotReturn(){
  const w=Math.floor(20+Math.random()*60),s=Math.floor(10+Math.random()*35),i=Math.floor(5+Math.random()*20);
  state.resources.wood+=w;state.resources.stone+=s;state.resources.iron+=i;
  addChatMsg("ai","ğŸ¤– å¸¶å›ï¼šæœ¨+"+w+" çŸ³+"+s);
  state.robot.active=false;state.robot.status="å¾…å‘½";state.robot.guard=false;
}

// æ©Ÿå™¨äººæ å¥ªï¼š20% / å®ˆè­·5%
function robotSteal(){
  const ratio=state.robot.guard?0.05:0.20;
  const steal=(v)=>Math.floor(v*ratio);
  const sw=steal(state.resources.wood),ss=steal(state.resources.stone),si=steal(state.resources.iron),sf=steal(state.resources.food),sc=steal(state.resources.coin);
  state.resources.wood-=sw;state.resources.stone-=ss;state.resources.iron-=si;state.resources.food-=sf;state.resources.coin-=sc;
  addChatMsg("ai",`ğŸš¨ è¢«æ¶${Math.round(ratio*100)}%ï¼šæœ¨-${sw} é‡‘-${sc}`);
  showToast(`è¢«æ¶${Math.round(ratio*100)}%`);
  state.robot.stealTimer=240+Math.floor(Math.random()*240);
}

function tickPrices(){const d=(p)=>Math.max(1,Math.floor(p*(0.9+Math.random()*0.25)));state.prices.wood=d(state.prices.wood);state.prices.stone=d(state.prices.stone);state.prices.iron=d(state.prices.iron);state.prices.food=d(state.prices.food);}
function tickStock(){const d=(v)=>Math.max(10,Math.floor(v*(0.92+Math.random()*0.2)));state.stock.ind=d(state.stock.ind);state.stock.space=d(state.stock.space);state.stock.farm=d(state.stock.farm);}

function trade(type,res){
  const amt=Math.max(1,parseInt(document.getElementById("tradeAmt").value||"1"));
  const price=state.prices[res];
  if(type==="buy"){
    const cost=amt*price;
    if(state.resources.coin>=cost){state.resources.coin-=cost;state.resources[res]+=amt;addChatMsg("ai","ğŸ’± è²·å…¥"+res);}else addChatMsg("ai","âŒ é‡‘å¹£ä¸è¶³");
  }else{
    if(state.resources[res]>=amt){const g=amt*price;state.resources[res]-=amt;state.resources.coin+=g;addChatMsg("ai","ğŸ’± è³£å‡º"+res);}else addChatMsg("ai","âŒ è³‡æºä¸è¶³");
  }
}

function stock(a,k){
  const p=state.stock[k];const u=1;
  if(a==="buy"){if(state.resources.coin>=p){state.resources.coin-=p;state.stock.holding[k]+=u;addChatMsg("ai","ğŸ“ˆ è²·å…¥");}else addChatMsg("ai","âŒ é‡‘å¹£ä¸è¶³");}
  else{if(state.stock.holding[k]>=u){state.stock.holding[k]-=u;state.resources.coin+=p;addChatMsg("ai","ğŸ“‰ è³£å‡º");}else addChatMsg("ai","âŒ ç„¡æŒè‚¡");}
}

function research(k){
  const c=100+state.tech[k]*80,i=20+state.tech[k]*10;
  if(state.resources.coin>=c&&state.resources.iron>=i){state.resources.coin-=c;state.resources.iron-=i;state.tech[k]++;addChatMsg("ai","ğŸ”¬ ç ”ç©¶æˆåŠŸï¼š"+k);}else addChatMsg("ai","âŒ è³‡æºä¸è¶³");
}

let adsList=[];async function loadAds(){try{const r=await fetch("./ads.json?ts="+Date.now(),{cache:"no-store"});adsList=await r.json();}catch(e){adsList=[{name:"AENO Demo",url:"",rewardCoin:10,rewardAeno:0}];}}
function unlockAudio(){audio.play().catch(()=>{});audioUnlocked=true;addChatMsg("ai","ğŸ”Š éŸ³è¨Šè§£é–");showToast("éŸ³è¨Šè§£é–");}
function playAdSong(){
  if(state.ads.cooldown>0){addChatMsg("ai","â³ å†·å»ä¸­");return;}
  if(!audioUnlocked){addChatMsg("ai","âŒ è«‹å…ˆè§£é–éŸ³è¨Š");return;}
  const ad=adsList[Math.floor(Math.random()*adsList.length)];
  adNow.textContent="æ’­æ”¾ï¼š"+ad.name;
  if(ad.url){audio.src=ad.url;audio.play().catch(()=>{});}
  state.ads.listenedToday++;state.ads.cooldown=45;
  state.resources.coin+=(ad.rewardCoin||20);
  addChatMsg("ai","ğŸµ è½æ­Œå®Œæˆï¼Œé‡‘å¹£+"+(ad.rewardCoin||20));showToast("+é‡‘å¹£");
}

function simulate(sec){
  sec=Math.floor(sec);if(sec<=0)return;
  const p=prodRate();
  state.resources.wood+=p.w*sec;state.resources.stone+=p.s*sec;state.resources.iron+=p.i*sec;state.resources.food+=p.f*sec;state.resources.coin+=p.c*sec;
  state.resources.food=Math.max(0,state.resources.food);
  for(let i=0;i<sec;i++){if(state.resources.food>state.pop.population*0.5&&state.pop.population<state.pop.cap&&Math.random()<0.012)state.pop.population++;}
  if(sec>=60){const t=Math.floor(sec/180);for(let i=0;i<t;i++){tickPrices();tickStock();}}
  state.resources.aeno+=calcAenoGain(sec);
  state.beast.timer-=sec;if(state.beast.timer<=0&&!state.beast.active){spawnBeastWave();resolveBeastWave();}
  if(state.robot.active){state.robot.timer-=sec;if(state.robot.timer<=0)robotReturn();}
  state.robot.stealTimer-=sec;if(state.robot.stealTimer<=0)robotSteal();
  state.ads.cooldown-=sec;if(state.ads.cooldown<0)state.ads.cooldown=0;
  if(state.settings.autoBuild)autoBuildLogic(sec);
  if(state.settings.autoExpand)autoExpandLogic(sec);
  state.resources.wood=Math.floor(state.resources.wood);state.resources.stone=Math.floor(state.resources.stone);state.resources.iron=Math.floor(state.resources.iron);state.resources.food=Math.floor(state.resources.food);state.resources.coin=Math.floor(state.resources.coin);state.resources.aeno=Math.max(0,state.resources.aeno);
}

function autoBuildLogic(sec){
  const have=(t)=>state.map.buildings.filter(b=>b.type===t).length;
  if(state.pop.cap<state.pop.population+4)tryAutoBuild("house");
  if(state.resources.food<state.pop.population*40)tryAutoBuild("farm");
  if(state.resources.wood<120)tryAutoBuild("lumber");
  if(state.resources.iron<50)tryAutoBuild("mine");
  if(have("wall")<Math.floor(state.territory.radius/2))tryAutoBuild("wall");
  if(Math.random()<0.25)autoUpgrade();
}
function tryAutoBuild(t){const c=costOf(t);if(!canPay(c))return;for(let y=0;y<GRID_H;y++){for(let x=0;x<GRID_W;x++){if(!inTerritory(x,y))continue;if(buildingAt(x,y))continue;const tile=state.map.tiles[y][x];if(tile.t==="river")continue;pay(c);state.map.buildings.push({x,y,type:t,level:1});addChatMsg("ai","ğŸ¤– è‡ªå‹•å»ºé€ ï¼š"+t);return;}}}
function autoUpgrade(){
  const p=["farm","lumber","mine","wall","base","house"];
  for(const t of p){const b=state.map.buildings.find(bb=>bb.type===t);if(!b)continue;const c={wood:20*b.level,stone:15*b.level,coin:30*b.level};if(canPay(c)){pay(c);b.level++;addChatMsg("ai","â¬†ï¸ è‡ªå‹•å‡ç´šï¼š"+t);return;}}}
function autoExpandLogic(sec){
  const r=state.territory.radius;const w=50+r*18,c=120+r*35;
  if(state.resources.wood>w*1.2&&state.resources.coin>c*1.2){state.resources.wood-=w;state.resources.coin-=c;state.territory.radius++;addChatMsg("ai","ğŸ—ºï¸ è‡ªå‹•æ“´å¼µï¼š"+state.territory.radius);showToast("é ˜åœŸæ“´å¼µ");}
}

function drawTile(x,y,t){
  const px=x*TILE,py=y*TILE;
  let col="#b7f7d1";
  if(t==="forest")col="#5ddf74";if(t==="mountain")col="#94a3b8";if(t==="ore")col="#64748b";if(t==="river")col="#60a5fa";
  ctx.fillStyle=col;ctx.fillRect(px,py,TILE,TILE);
  ctx.strokeStyle="rgba(255,255,255,.45)";ctx.lineWidth=2;ctx.strokeRect(px,py,TILE,TILE);
  if(t==="forest"){ctx.fillStyle="#16a34a";ctx.beginPath();ctx.arc(px+18,py+24,10,0,Math.PI*2);ctx.arc(px+34,py+18,12,0,Math.PI*2);ctx.arc(px+44,py+30,10,0,Math.PI*2);ctx.fill();ctx.fillStyle="#92400e";ctx.fillRect(px+30,py+32,6,14);}
  if(t==="mountain"){ctx.fillStyle="#475569";ctx.beginPath();ctx.moveTo(px+10,py+50);ctx.lineTo(px+30,py+18);ctx.lineTo(px+52,py+50);ctx.closePath();ctx.fill();}
  if(t==="ore"){ctx.fillStyle="#111827";ctx.beginPath();ctx.arc(px+28,py+34,8,0,Math.PI*2);ctx.fill();ctx.fillStyle="#fbbf24";ctx.beginPath();ctx.arc(px+34,py+30,4,0,Math.PI*2);ctx.fill();}
  if(t==="river"){ctx.fillStyle="rgba(255,255,255,.25)";ctx.beginPath();ctx.arc(px+18,py+20,5,0,Math.PI*2);ctx.arc(px+40,py+44,6,0,Math.PI*2);ctx.fill();}
  if(!inTerritory(x,y)){ctx.fillStyle="rgba(0,0,0,.20)";ctx.fillRect(px,py,TILE,TILE);}
}

function drawBuilding(b){
  const px=b.x*TILE,py=b.y*TILE;
  ctx.fillStyle="rgba(0,0,0,.18)";ctx.beginPath();ctx.ellipse(px+32,py+50,22,10,0,0,Math.PI*2);ctx.fill();
  if(b.type==="base"){ctx.fillStyle="#fff";ctx.fillRect(px+14,py+22,36,26);ctx.fillStyle="#3b82f6";ctx.fillRect(px+14,py+18,36,10);ctx.fillStyle="#111827";ctx.fillText("HQ",px+22,py+40);}
  if(b.type==="house"){ctx.fillStyle="#fef3c7";ctx.fillRect(px+14,py+24,36,26);ctx.fillStyle="#fb7185";ctx.beginPath();ctx.moveTo(px+12,py+26);ctx.lineTo(px+32,py+10);ctx.lineTo(px+52,py+26);ctx.closePath();ctx.fill();}
  if(b.type==="farm"){ctx.fillStyle="#fde68a";ctx.fillRect(px+12,py+26,40,22);ctx.fillStyle="#16a34a";ctx.fillRect(px+16,py+30,32,4);ctx.fillRect(px+16,py+38,32,4);}
  if(b.type==="lumber"){ctx.fillStyle="#fef3c7";ctx.fillRect(px+14,py+26,36,22);ctx.fillStyle="#92400e";ctx.fillRect(px+28,py+20,8,30);ctx.fillStyle="#22c55e";ctx.beginPath();ctx.arc(px+32,py+18,10,0,Math.PI*2);ctx.fill();}
  if(b.type==="mine"){ctx.fillStyle="#cbd5e1";ctx.fillRect(px+14,py+28,36,20);ctx.fillStyle="#64748b";ctx.beginPath();ctx.moveTo(px+12,py+30);ctx.lineTo(px+32,py+12);ctx.lineTo(px+52,py+30);ctx.closePath();ctx.fill();}
  if(b.type==="wall"){ctx.fillStyle="#94a3b8";ctx.fillRect(px+10,py+28,44,22);ctx.fillStyle="#64748b";for(let i=0;i<4;i++){ctx.fillRect(px+12+i*11,py+22,8,10);}}
  // level label
  ctx.fillStyle="rgba(0,0,0,.65)";
  ctx.font="bold 12px sans-serif";
  ctx.fillText("Lv"+b.level, px+6, py+14);
}

function drawAI(){
  const px=state.ai.x*TILE + TILE/2;
  const py=state.ai.y*TILE + TILE/2;

  // body
  ctx.fillStyle="#fde68a";
  ctx.beginPath();
  ctx.arc(px,py,18,0,Math.PI*2);
  ctx.fill();

  // face
  ctx.fillStyle="#111827";
  ctx.beginPath();
  ctx.arc(px-6,py-4,2.5,0,Math.PI*2);
  ctx.arc(px+6,py-4,2.5,0,Math.PI*2);
  ctx.fill();

  ctx.strokeStyle="#111827";
  ctx.lineWidth=2;
  ctx.beginPath();
  ctx.arc(px,py+4,6,0,Math.PI);
  ctx.stroke();

  // ad flag
  ctx.fillStyle="#ef4444";
  ctx.fillRect(px-10,py-34,20,12);
  ctx.fillStyle="#fff";
  ctx.font="bold 10px sans-serif";
  ctx.fillText("AD",px-7,py-24);
  ctx.strokeStyle="#92400e";
  ctx.beginPath();
  ctx.moveTo(px-10,py-34);
  ctx.lineTo(px-10,py-12);
  ctx.stroke();
}

function render(){
  ctx.setTransform(1,0,0,1,0,0);
  ctx.clearRect(0,0,W,H);

  ctx.setTransform(cam.scale,0,0,cam.scale,cam.x,cam.y);

  for(let y=0;y<GRID_H;y++){
    for(let x=0;x<GRID_W;x++){
      drawTile(x,y,state.map.tiles[y][x].t);
    }
  }

  // buildings
  for(const b of state.map.buildings){
    drawBuilding(b);
  }

  // AI
  drawAI();

  // selected highlight
  if(selectedTile){
    ctx.strokeStyle="#3b82f6";
    ctx.lineWidth=4;
    ctx.strokeRect(selectedTile.x*TILE+2, selectedTile.y*TILE+2, TILE-4, TILE-4);
  }
}

/* ===== main loop ===== */
let lastTick=Date.now();
let gameTick=0;

function gameLoop(){
  const now=Date.now();
  const dt=(now-lastTick)/1000;
  lastTick=now;

  // æ¯ç§’simulateä¸€æ¬¡ï¼ˆåœ¨ç·šæ¨¡å¼ï¼‰
  simulate(dt);

  // AIå·¡é‚ç§»å‹•ï¼ˆç´”å‹•ç•«ï¼‰
  if(state.ai.mode==="patrol"){
    if(Math.random()<0.03){
      state.ai.x=clamp(state.ai.x+(Math.random()>0.5?1:-1),0,GRID_W-1);
      state.ai.y=clamp(state.ai.y+(Math.random()>0.5?1:-1),0,GRID_H-1);
    }
  }

  // å€’æ•¸
  if(state.beast.timer>0) state.beast.timer--;
  if(state.ads.cooldown>0) state.ads.cooldown--;
  if(state.robot.active && state.robot.timer>0) state.robot.timer--;
  if(state.robot.stealTimer>0) state.robot.stealTimer--;

  // æ¯3åˆ†é˜æ›´æ–°åƒ¹æ ¼
  if(gameTick%180===0) tickPrices();
  if(gameTick%180===0) tickStock();

  // äº‹ä»¶è§¸ç™¼
  if(state.beast.timer<=0 && !state.beast.active){
    spawnBeastWave();
    resolveBeastWave();
  }

  if(state.robot.active && state.robot.timer<=0){
    robotReturn();
  }

  if(!state.robot.active && gameTick%750===0){
    // éš¨æ©Ÿå‡ºç¾æ©Ÿå™¨äººæ¢ç´¢
    if(Math.random()<0.35) spawnRobot();
  }

  if(state.robot.stealTimer<=0){
    robotSteal();
  }

  refreshUI();
  render();

  gameTick++;
  requestAnimationFrame(gameLoop);
}

/* ===== refresh UI ===== */
function refreshUI(){
  statusText.textContent="é‹ä½œä¸­ãƒ»V"+VERSION;

  r_wood.textContent=Math.floor(state.resources.wood);
  r_stone.textContent=Math.floor(state.resources.stone);
  r_iron.textContent=Math.floor(state.resources.iron);
  r_food.textContent=Math.floor(state.resources.food);
  r_coin.textContent=Math.floor(state.resources.coin);
  r_aeno.textContent=state.resources.aeno.toFixed(6);

  r_pop.textContent=state.pop.population;
  r_popcap.textContent=state.pop.cap;
  r_workers.textContent=Math.max(1,Math.floor(state.pop.population*0.6));

  r_radius.textContent=state.territory.radius;

  autoTxt.textContent=state.settings.autoBuild?"ON":"OFF";
  expandTxt.textContent=state.settings.autoExpand?"ON":"OFF";

  p_wood.textContent=state.prices.wood;
  p_stone.textContent=state.prices.stone;
  p_iron.textContent=state.prices.iron;
  p_food.textContent=state.prices.food;

  s_ind.textContent=state.stock.ind+" (æŒè‚¡:"+state.stock.holding.ind+")";
  s_space.textContent=state.stock.space+" (æŒè‚¡:"+state.stock.holding.space+")";
  s_farm.textContent=state.stock.farm+" (æŒè‚¡:"+state.stock.holding.farm+")";

  t_ind.textContent=state.tech.ind;
  t_def.textContent=state.tech.def;
  t_robot.textContent=state.tech.robot;

  beastTimer.textContent=Math.max(0,state.beast.timer);
  shards.textContent=state.beast.shards;

  const ratio=Math.floor(100*clamp(state.ads.listenedToday/Math.max(1,state.ads.totalToday),0,1));
  adRatio.textContent=ratio+"%";
  adCd.textContent=state.ads.cooldown;

  robotStatus.textContent=state.robot.status;
  robotTimer.textContent=Math.max(0,state.robot.timer);
  stealTimer.textContent=Math.max(0,state.stealTimer);
}

/* ===== manual save ===== */
function manualSave(){
  saveGame();
  showToast("å·²å­˜æª”");
}

/* ===== resize ===== */
function resize(){
  W=window.innerWidth;
  H=window.innerHeight;
  cv.width=W;
  cv.height=H;
}
window.addEventListener("resize",resize);

/* ===== init ===== */
async function initGame(){
  resize();

  makeDraggable(document.getElementById("panel"));
  makeDraggable(document.getElementById("aiPanel"));

  loadGame();
  await loadAds();

  centerView();

  // é›¢ç·šè£œç®—
  const now=Date.now();
  const offlineSec=Math.floor((now-(state.lastSeen||now))/1000);
  r_offline.textContent=offlineSec;

  if(offlineSec>2){
    simulate(offlineSec);
    addChatMsg("ai","ğŸ•’ ä½ é›¢ç·š "+offlineSec+" ç§’ï¼Œå·²è£œç®—è³‡æºèˆ‡æ–‡æ˜é€²åº¦ã€‚");
    showToast("é›¢ç·šè£œç®—å®Œæˆ");
  }

  addChatMsg("ai","AENO V3 å®Œæ•´ç‰ˆå·²å•Ÿå‹•ã€‚åœ°å½¢æœ‰æ²³æµæ£®æ—ç¤¦è„ˆï¼Œç¸æ½®æœƒå‘¨æœŸçˆ†ç™¼ã€‚ä½ å¯æ‹–æ‹‰/ç¸®æ”¾åœ°åœ–ã€‚");
  addChatMsg("ai","æç¤ºï¼šå…ˆè½å»£å‘Šæ­Œæå‡æ¯”ä¾‹ï¼Œç¢ç‰‡æ¯”ä¾‹äº¦æœƒå½±éŸ¿ AENO å¢é•·ã€‚");

  // è‡ªå‹•å­˜æª”
  setInterval(saveGame, 25000);

  gameLoop();
}

/* ===== SW å¼·åˆ¶æ›´æ–° ===== */
if("serviceWorker" in navigator){
  navigator.serviceWorker.register("./sw.js?v="+Date.now()).then(reg=>reg.update());
  navigator.serviceWorker.getRegistrations().then(regs=>regs.forEach(r=>r.update()));
}

// é é¢åŠ è¼‰å®Œæˆå¾Œï¼Œé¡¯ç¤ºç™»éŒ„é é¢
window.addEventListener('load', function() {
  // ç™»éŒ„é é¢å·²ç¶“é»˜èªé¡¯ç¤ºï¼Œç„¡éœ€é¡å¤–æ“ä½œ
});
</script>
</body>
</html>
