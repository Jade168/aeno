<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>AENO V3 Mobile Cartoon</title>
<style>
  html,body{margin:0;padding:0;height:100%;overflow:hidden;background:#bfe8ff;font-family:system-ui,-apple-system,Segoe UI,Roboto,"PingFang HK","Noto Sans TC",sans-serif;}
  #wrap{position:fixed;inset:0;overflow:hidden;background:linear-gradient(#bfe8ff,#e9fbff);}
  canvas{position:absolute;inset:0;touch-action:none;}
  /* bottom safe space */
  :root{ --safeB: env(safe-area-inset-bottom, 0px); --safeT: env(safe-area-inset-top, 0px); }

  /* small floating buttons */
  .fab{
    position:absolute; right:12px; width:52px;height:52px;border-radius:18px;
    border:none;background:#ffffffcc;backdrop-filter: blur(8px);
    box-shadow:0 10px 20px rgba(0,0,0,.15);
    font-size:22px; display:flex;align-items:center;justify-content:center;
    user-select:none;
  }
  #btnPanel{bottom:calc(12px + var(--safeB));}
  #btnPlanet{bottom:calc(72px + var(--safeB));}
  #btnZoom{bottom:calc(132px + var(--safeB));}

  /* draggable panel */
  #panel{
    position:absolute; left:10px; top:calc(10px + var(--safeT));
    width:320px; max-width:92vw; max-height:62vh;
    border-radius:18px; overflow:hidden;
    background:#ffffffdd; backdrop-filter: blur(10px);
    box-shadow:0 14px 30px rgba(0,0,0,.18);
    display:none;
  }
  #panelHeader{
    padding:10px 12px;
    font-weight:800;
    font-size:14px;
    background:linear-gradient(90deg,#ffe8a3,#ffd6ff);
    cursor:grab;
    display:flex;align-items:center;justify-content:space-between;
  }
  #panelHeader small{font-weight:700;opacity:.8}
  #panelBody{padding:10px 12px;overflow:auto;max-height:52vh;font-size:12px;line-height:1.2;}
  .row{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0;}
  .pill{
    padding:6px 10px;border-radius:999px;background:#f1f5ff;border:1px solid #dbe7ff;
    font-weight:700;font-size:12px;
  }
  .btn{
    border:none;border-radius:12px;
    padding:8px 10px;font-weight:800;font-size:12px;
    background:#4f8cff;color:white;
    box-shadow:0 8px 16px rgba(79,140,255,.25);
  }
  .btn.gray{background:#64748b;box-shadow:none;}
  .btn.green{background:#22c55e;}
  .btn.orange{background:#fb8500;}
  .btn.pink{background:#ff4d8d;}
  .btn.red{background:#ef4444;}
  .btn:active{transform:scale(.98)}
  .sep{height:1px;background:#e7eefc;margin:10px 0;}
  input,select{
    font-size:12px;padding:8px 10px;border-radius:12px;border:1px solid #dbe7ff;
    outline:none;background:#fff;
  }
  #toast{
    position:absolute;left:50%;transform:translateX(-50%);
    bottom:calc(80px + var(--safeB));
    background:#111827dd;color:white;
    padding:10px 14px;border-radius:999px;
    font-size:12px;font-weight:700;
    display:none;white-space:nowrap;
  }

  /* AI dialog bubble */
  #aiDialog{
    position:absolute;
    min-width:220px; max-width:78vw;
    background:#ffffffee;
    border-radius:16px;
    padding:10px 12px;
    box-shadow:0 14px 30px rgba(0,0,0,.18);
    display:none;
    font-size:12px;
  }
  #aiDialog b{font-size:12px}
  #aiDialog input{width:100%;margin-top:8px;}
  #aiDialog .miniRow{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;}
  #aiDialog .miniBtn{
    padding:7px 10px;border-radius:12px;border:none;font-weight:900;font-size:12px;
    background:#4f8cff;color:white;
  }

  /* build menu */
  #buildMenu{
    position:absolute;
    background:#ffffffee;
    border-radius:18px;
    padding:10px;
    box-shadow:0 14px 30px rgba(0,0,0,.18);
    display:none;
    width:240px;
    font-size:12px;
  }
  #buildMenu .title{font-weight:900;margin-bottom:8px}
  #buildMenu .grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  #buildMenu .bbtn{
    border:none;border-radius:14px;
    padding:10px 10px;font-weight:900;
    background:#f1f5ff;border:1px solid #dbe7ff;
  }
  #buildMenu .bbtn:active{transform:scale(.98)}
  #buildMenu .foot{display:flex;gap:8px;margin-top:8px}
  #buildMenu .confirm{background:#22c55e;color:white;border:none;border-radius:14px;padding:10px;font-weight:900;flex:1}
  #buildMenu .cancel{background:#ef4444;color:white;border:none;border-radius:14px;padding:10px;font-weight:900;flex:1}

  /* planet modal */
  #planetModal{
    position:absolute; inset:0;
    background:rgba(0,0,0,.45);
    display:none;
    align-items:center; justify-content:center;
  }
  #planetCard{
    width:min(92vw,360px);
    background:#ffffffee;
    border-radius:18px;
    padding:12px;
    box-shadow:0 18px 40px rgba(0,0,0,.25);
  }
  #planetCard h3{margin:0 0 8px 0;font-size:14px}
  #planetList{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .planetBtn{
    border:none;border-radius:14px;
    padding:10px;font-weight:900;font-size:12px;
    background:#f1f5ff;border:1px solid #dbe7ff;
  }
  .planetBtn:active{transform:scale(.98)}
  #closePlanet{margin-top:10px;width:100%;padding:10px;border:none;border-radius:14px;background:#64748b;color:white;font-weight:900;}
</style>
</head>

<body>
<div id="wrap">
  <canvas id="cv"></canvas>

  <div id="toast"></div>

  <button id="btnPanel" class="fab">â˜°</button>
  <button id="btnPlanet" class="fab">ğŸª</button>
  <button id="btnZoom" class="fab">ğŸ”</button>

  <div id="panel">
    <div id="panelHeader">
      <div>å¸åœ‹æ§åˆ¶ä¸­å¿ƒ <small id="planetName">Planet</small></div>
      <div style="font-size:12px;font-weight:900;opacity:.8" id="panelHint">æ‹–å‹•</div>
    </div>
    <div id="panelBody">
      <div class="row">
        <div class="pill">æœ¨ <span id="uiWood">0</span></div>
        <div class="pill">çŸ³ <span id="uiStone">0</span></div>
        <div class="pill">éµ <span id="uiIron">0</span></div>
        <div class="pill">é£Ÿ <span id="uiFood">0</span></div>
      </div>
      <div class="row">
        <div class="pill">é‡‘å¹£ <span id="uiCoin">0</span></div>
        <div class="pill">AENO <span id="uiAeno">0</span></div>
        <div class="pill">äººå£ <span id="uiPop">0</span>/<span id="uiCap">0</span></div>
      </div>

      <div class="sep"></div>

      <div style="font-weight:900;margin-bottom:6px;">AI è‡ªå‹•ç­–ç•¥</div>
      <div class="row">
        <button class="btn" id="btnAuto">è‡ªå‹•: ON</button>
        <select id="autoMode">
          <option value="balanced">å¹³è¡¡</option>
          <option value="growth">å„ªå…ˆäººå£</option>
          <option value="eco">å„ªå…ˆè³‡æº</option>
          <option value="military">å„ªå…ˆåŸç‰†</option>
        </select>
      </div>

      <div class="sep"></div>

      <div style="font-weight:900;margin-bottom:6px;">å»ºç¯‰ / å‡ç´š</div>
      <div class="row">
        <button class="btn green" onclick="setBuildBrush('house')">æˆ¿å±‹</button>
        <button class="btn green" onclick="setBuildBrush('farm')">è¾²ç”°</button>
        <button class="btn green" onclick="setBuildBrush('lumber')">ä¼æœ¨å ´</button>
        <button class="btn green" onclick="setBuildBrush('mine')">ç¤¦å ´</button>
        <button class="btn orange" onclick="setBuildBrush('market')">å¸‚å ´</button>
        <button class="btn orange" onclick="setBuildBrush('mint')">é‘„å¹£å» </button>
        <button class="btn pink" onclick="setBuildBrush('wall')">åŸç‰†</button>
      </div>

      <div class="row">
        <button class="btn" onclick="upgradeSelected()">å‡ç´šé¸ä¸­å»ºç¯‰</button>
        <button class="btn gray" onclick="cancelBrush()">å–æ¶ˆå»ºé€ </button>
      </div>

      <div class="sep"></div>

      <div style="font-weight:900;margin-bottom:6px;">äº¤æ˜“æ‰€ï¼ˆæ¸¬è©¦ç‰ˆï¼‰</div>
      <div class="row">
        <input id="tradeAmt" type="number" value="50" min="1"/>
        <button class="btn" onclick="buyWood()">è²·æœ¨</button>
        <button class="btn" onclick="sellWood()">è³£æœ¨</button>
      </div>

      <div class="sep"></div>

      <div style="font-weight:900;margin-bottom:6px;">å»£å‘Šæ­Œæ›²ï¼ˆAENO æ ¸å¿ƒï¼‰</div>
      <div class="row">
        <button class="btn" onclick="unlockAudio()">è§£é–éŸ³è¨Š</button>
        <button class="btn orange" onclick="toggleMusic()">æ’­æ”¾/æš«åœ</button>
      </div>
      <div class="row">
        <button class="btn" onclick="prevSong()">ä¸Šä¸€é¦–</button>
        <button class="btn" onclick="nextSong()">ä¸‹ä¸€é¦–</button>
        <button class="btn pink" onclick="toggleLoop()">å¾ªç’°: <span id="loopTxt">ON</span></button>
      </div>

      <div class="sep"></div>

      <div style="font-weight:900;margin-bottom:6px;">ç¸æ½®ï¼ˆéœ€åŸç‰†100%ï¼‰</div>
      <div class="row">
        <div class="pill">ç¢ç‰‡ <span id="uiShard">0</span></div>
        <div class="pill">æˆ°åˆ©å“ <span id="uiLoot">0</span></div>
      </div>
      <div class="row">
        <button class="btn red" onclick="collectLoot()">æ”¶å–æˆ°åˆ©å“</button>
        <button class="btn" onclick="collectShard()">åˆæˆ AENO</button>
      </div>

      <div class="sep"></div>

      <div style="font-weight:900;margin-bottom:6px;">é›¢ç·šå¤–æ›</div>
      <div class="row">
        <div class="pill">æœ€å¤§è£œç®—: 24h</div>
        <div class="pill">æœ€å¾Œåœ¨ç·š: <span id="uiLast">-</span></div>
      </div>
    </div>
  </div>

  <div id="aiDialog">
    <b>ğŸ¦Š AENO åŠ©æ‰‹</b>
    <div id="aiMsg" style="margin-top:6px;font-weight:700;opacity:.9;">æ­¡è¿è¿”åšŸï¼ŒæŒ‡æ®å®˜ã€‚</div>
    <input id="aiInput" placeholder="è¼¸å…¥æŒ‡ä»¤ï¼šå·¡é‚/æ”¶é›†/å»ºé€ /å‡ç´š/æ“´å¼µ..."/>
    <div class="miniRow">
      <button class="miniBtn" onclick="aiCommand()">é€å‡º</button>
      <button class="miniBtn" onclick="aiClose()" style="background:#64748b;">æ”¶èµ·</button>
    </div>
  </div>

  <div id="buildMenu">
    <div class="title" id="bmTitle">å»ºé€ </div>
    <div class="grid" id="bmGrid"></div>
    <div class="foot">
      <button class="confirm" onclick="confirmBuild()">ç¢ºèª</button>
      <button class="cancel" onclick="closeBuildMenu()">å–æ¶ˆ</button>
    </div>
  </div>

  <div id="planetModal">
    <div id="planetCard">
      <h3>é¸æ“‡æ˜Ÿçƒ</h3>
      <div id="planetList"></div>
      <button id="closePlanet">é—œé–‰</button>
    </div>
  </div>

  <audio id="music"></audio>
</div>

<script>
/* =========================
   AENO V3 - FULL GAME CORE
   (No comments above DOCTYPE)
========================= */

const SAVE_KEY = "AENO_V3_SAVE_FULL";
const GAME_VERSION = 33;

const cv = document.getElementById("cv");
const ctx = cv.getContext("2d");

function resize(){
  cv.width = window.innerWidth * devicePixelRatio;
  cv.height = window.innerHeight * devicePixelRatio;
  ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
}
window.addEventListener("resize", resize);
resize();

/* ========= WORLD ========= */
const TILE = 64;
const MAP_W = 60;
const MAP_H = 60;

const TILETYPE = {
  GRASS: 0,
  FOREST: 1,
  ROCK: 2,
  IRON: 3,
  RIVER: 4,
  MOUNTAIN: 5,
  BLACKHOLE: 6
};

const BUILDING = {
  NONE: "none",
  HOUSE: "house",
  FARM: "farm",
  LUMBER: "lumber",
  MINE: "mine",
  MARKET: "market",
  MINT: "mint",
  WALL: "wall"
};

const BUILD_INFO = {
  house: {name:"æˆ¿å±‹", cost:{wood:120,stone:40,coin:0}, cap:+2, prod:{}},
  farm: {name:"è¾²ç”°", cost:{wood:80,stone:0,coin:0}, cap:0, prod:{food:2}},
  lumber:{name:"ä¼æœ¨å ´", cost:{wood:60,stone:20,coin:0}, cap:0, prod:{wood:3}},
  mine: {name:"ç¤¦å ´", cost:{wood:80,stone:40,coin:0}, cap:0, prod:{stone:2,iron:1}},
  market:{name:"å¸‚å ´", cost:{wood:100,stone:60,coin:200}, cap:0, prod:{coin:5}},
  mint: {name:"é‘„å¹£å» ", cost:{wood:140,stone:90,coin:500}, cap:0, prod:{coin:10}},
  wall: {name:"åŸç‰†", cost:{wood:80,stone:120,coin:200}, cap:0, prod:{}}
};

const PLANETS = [
  {id:"planet_01", name:"ğŸŒ Gaia-01", theme:"green"},
  {id:"planet_02", name:"ğŸŸ¦ Azure-02", theme:"blue"},
  {id:"planet_03", name:"ğŸŸ¨ Dune-03", theme:"sand"},
  {id:"planet_04", name:"ğŸŸ¥ Ember-04", theme:"lava"},
  {id:"planet_05", name:"ğŸŸª Nebula-05", theme:"purple"},
  {id:"planet_06", name:"âš« é»‘æ´å­¤å³¶", theme:"blackhole", blackhole:true}
];

/* ========= STATE ========= */
let state = {
  version: GAME_VERSION,
  planetId: "planet_01",

  resources: {wood:800, stone:800, iron:800, food:800, coin:2000},
  aeno: 0,
  shard: 0,
  loot: 0,

  pop: 4,
  cap: 6,

  auto: true,
  autoMode: "balanced",

  timeScale: 10, // 1 real day = 10 game years (symbolic)
  lastSeen: Date.now(),

  territoryRadius: 5,

  buildings: [], // {x,y,type,level}
  animals: [],   // roaming
  workers: [],   // roaming
  ai: {x: 0, y: 0, talkOpen:false},

  cam: {x: MAP_W*TILE/2, y: MAP_H*TILE/2, zoom: 0.9},

  music: {songIndex:0, loop:true, listenedSeconds:0, lastTickListen:0},

  pendingBuild: null, // {x,y,type}
};

function deepCopy(obj){ return JSON.parse(JSON.stringify(obj)); }

/* ========= SAVE / LOAD ========= */
function saveGame(){
  state.lastSeen = Date.now();
  localStorage.setItem(SAVE_KEY, JSON.stringify(state));
}
function loadGame(){
  const raw = localStorage.getItem(SAVE_KEY);
  if(raw){
    try{
      const s = JSON.parse(raw);
      if(s && s.version){
        state = {...state, ...s};
        if(!state.resources) state.resources = {wood:800,stone:800,iron:800,food:800,coin:2000};
        if(!state.cam) state.cam = {x: MAP_W*TILE/2, y: MAP_H*TILE/2, zoom: 0.9};
        if(!state.music) state.music = {songIndex:0, loop:true, listenedSeconds:0, lastTickListen:0};
        if(!state.ai) state.ai = {x:0,y:0,talkOpen:false};
        if(!state.buildings) state.buildings = [];
        if(!state.animals) state.animals = [];
        if(!state.workers) state.workers = [];
        if(!state.territoryRadius) state.territoryRadius = 5;
      }
    }catch(e){}
  }
}

/* ========= MAP GEN ========= */
let map = [];
function genMap(seed=1){
  map = new Array(MAP_H).fill(0).map(()=>new Array(MAP_W).fill(TILETYPE.GRASS));
  function rnd(x,y){
    const n = Math.sin((x*9999+y*7777+seed)*0.0007)*10000;
    return n - Math.floor(n);
  }

  // base biomes
  for(let y=0;y<MAP_H;y++){
    for(let x=0;x<MAP_W;x++){
      const r = rnd(x,y);
      if(r<0.08) map[y][x]=TILETYPE.RIVER;
      else if(r<0.18) map[y][x]=TILETYPE.FOREST;
      else if(r<0.24) map[y][x]=TILETYPE.ROCK;
      else if(r<0.28) map[y][x]=TILETYPE.IRON;
      else if(r<0.32) map[y][x]=TILETYPE.MOUNTAIN;
      else map[y][x]=TILETYPE.GRASS;
    }
  }

  // make river smoother
  for(let i=0;i<2;i++){
    for(let y=1;y<MAP_H-1;y++){
      for(let x=1;x<MAP_W-1;x++){
        let river=0;
        for(let yy=-1;yy<=1;yy++) for(let xx=-1;xx<=1;xx++){
          if(map[y+yy][x+xx]===TILETYPE.RIVER) river++;
        }
        if(river>=5) map[y][x]=TILETYPE.RIVER;
      }
    }
  }

  // blackhole island zone (top-right corner)
  for(let y=0;y<12;y++){
    for(let x=MAP_W-12;x<MAP_W;x++){
      if(Math.hypot(x-(MAP_W-6),y-6)<5){
        map[y][x]=TILETYPE.BLACKHOLE;
      }
    }
  }
}

/* ========= BUILDING INIT ========= */
function initDefaultBase(){
  if(state.buildings.length>0) return;

  const cx = Math.floor(MAP_W/2);
  const cy = Math.floor(MAP_H/2);

  state.buildings.push({x:cx-1,y:cy,type:BUILDING.HOUSE,level:1});
  state.buildings.push({x:cx+1,y:cy,type:BUILDING.HOUSE,level:1});
  state.buildings.push({x:cx,y:cy+1,type:BUILDING.FARM,level:1});
  state.buildings.push({x:cx,y:cy-1,type:BUILDING.LUMBER,level:1});

  state.ai.x = (cx+0.5)*TILE;
  state.ai.y = (cy+0.5)*TILE;

  // workers
  for(let i=0;i<4;i++){
    state.workers.push({
      x:(cx+Math.random()*2-1)*TILE,
      y:(cy+Math.random()*2-1)*TILE,
      vx:(Math.random()*2-1)*0.6,
      vy:(Math.random()*2-1)*0.6
    });
  }

  // animals
  for(let i=0;i<12;i++){
    state.animals.push({
      x:(cx+Math.random()*10-5)*TILE,
      y:(cy+Math.random()*10-5)*TILE,
      vx:(Math.random()*2-1)*0.4,
      vy:(Math.random()*2-1)*0.4,
      kind: ["ğŸ—","ğŸ¦Œ","ğŸº","ğŸ°","ğŸ¦Š"][Math.floor(Math.random()*5)]
    });
  }

  state.cam.x = (cx+0.5)*TILE;
  state.cam.y = (cy+0.5)*TILE;
  state.cam.zoom = 0.9;
}

/* ========= UI ========= */
const panel = document.getElementById("panel");
const btnPanel = document.getElementById("btnPanel");
const btnPlanet = document.getElementById("btnPlanet");
const btnZoom = document.getElementById("btnZoom");
const toast = document.getElementById("toast");

const uiWood = document.getElementById("uiWood");
const uiStone = document.getElementById("uiStone");
const uiIron = document.getElementById("uiIron");
const uiFood = document.getElementById("uiFood");
const uiCoin = document.getElementById("uiCoin");
const uiAeno = document.getElementById("uiAeno");
const uiPop = document.getElementById("uiPop");
const uiCap = document.getElementById("uiCap");
const uiShard = document.getElementById("uiShard");
const uiLoot = document.getElementById("uiLoot");
const uiLast = document.getElementById("uiLast");
const planetName = document.getElementById("planetName");
const btnAuto = document.getElementById("btnAuto");
const autoMode = document.getElementById("autoMode");
const loopTxt = document.getElementById("loopTxt");

function showToast(msg){
  toast.textContent = msg;
  toast.style.display = "block";
  clearTimeout(showToast._t);
  showToast._t = setTimeout(()=>toast.style.display="none",1800);
}

btnPanel.onclick = ()=>{
  panel.style.display = (panel.style.display==="none"||!panel.style.display) ? "block":"none";
};

btnZoom.onclick = ()=>{
  state.cam.zoom = Math.min(4, state.cam.zoom + 0.25);
  showToast("Zoom: "+state.cam.zoom.toFixed(2));
};

btnPlanet.onclick = ()=>openPlanetModal();

btnAuto.onclick = ()=>{
  state.auto = !state.auto;
  btnAuto.textContent = "è‡ªå‹•: " + (state.auto ? "ON":"OFF");
  showToast(state.auto ? "AI è‡ªå‹•å·²å•Ÿå‹•":"AI è‡ªå‹•å·²åœæ­¢");
};

autoMode.onchange = ()=>{
  state.autoMode = autoMode.value;
  showToast("ç­–ç•¥: "+autoMode.value);
};

function refreshUI(){
  uiWood.textContent = Math.floor(state.resources.wood);
  uiStone.textContent = Math.floor(state.resources.stone);
  uiIron.textContent = Math.floor(state.resources.iron);
  uiFood.textContent = Math.floor(state.resources.food);
  uiCoin.textContent = Math.floor(state.resources.coin);
  uiAeno.textContent = state.aeno.toFixed(6);
  uiPop.textContent = state.pop;
  uiCap.textContent = state.cap;
  uiShard.textContent = state.shard;
  uiLoot.textContent = state.loot;

  const d = new Date(state.lastSeen);
  uiLast.textContent = d.toLocaleString();

  const p = PLANETS.find(p=>p.id===state.planetId);
  planetName.textContent = p ? p.name : "";
  btnAuto.textContent = "è‡ªå‹•: " + (state.auto ? "ON":"OFF");
  autoMode.value = state.autoMode || "balanced";
  loopTxt.textContent = state.music.loop ? "ON":"OFF";
}

/* ========= PANEL DRAG ========= */
const panelHeader = document.getElementById("panelHeader");
let draggingPanel=false, pOffX=0, pOffY=0;

panelHeader.addEventListener("pointerdown",(e)=>{
  draggingPanel=true;
  pOffX = e.clientX - panel.offsetLeft;
  pOffY = e.clientY - panel.offsetTop;
  panelHeader.setPointerCapture(e.pointerId);
});
panelHeader.addEventListener("pointermove",(e)=>{
  if(!draggingPanel) return;
  panel.style.left = Math.max(4, Math.min(window.innerWidth-panel.offsetWidth-4, e.clientX-pOffX))+"px";
  panel.style.top  = Math.max(4, Math.min(window.innerHeight-panel.offsetHeight-4, e.clientY-pOffY))+"px";
});
panelHeader.addEventListener("pointerup",(e)=>draggingPanel=false);

/* ========= BUILD BRUSH ========= */
let buildBrush = null;
function setBuildBrush(type){
  buildBrush = type;
  showToast("é»æ“Šé ˜åœŸç©ºåœ°æ”¾ç½®ï¼š"+BUILD_INFO[type].name);
}
function cancelBrush(){
  buildBrush=null;
  showToast("å–æ¶ˆå»ºé€ ");
}

/* ========= TRADE ========= */
function buyWood(){
  const amt = Math.max(1, +document.getElementById("tradeAmt").value||0);
  const price = 2;
  const cost = amt*price;
  if(state.resources.coin>=cost){
    state.resources.coin-=cost;
    state.resources.wood+=amt;
    showToast("è²·æœ¨ +"+amt);
  }else showToast("é‡‘å¹£ä¸è¶³");
}
function sellWood(){
  const amt = Math.max(1, +document.getElementById("tradeAmt").value||0);
  if(state.resources.wood>=amt){
    state.resources.wood-=amt;
    state.resources.coin+=amt;
    showToast("è³£æœ¨ +"+amt+"é‡‘å¹£");
  }else showToast("æœ¨æä¸è¶³");
}

/* ========= MUSIC / ADS ========= */
const music = document.getElementById("music");
const SONGS = [
  // public domain / demo - replace later by ads.json system
  {name:"Demo Loop 1", url:"https://cdn.pixabay.com/download/audio/2022/03/15/audio_7c79c8e3d2.mp3?filename=happy-day-113985.mp3"},
  {name:"Demo Loop 2", url:"https://cdn.pixabay.com/download/audio/2022/08/04/audio_2f2d3f0d55.mp3?filename=relaxing-music-117176.mp3"},
  {name:"Demo Loop 3", url:"https://cdn.pixabay.com/download/audio/2022/01/18/audio_7c7e59b6db.mp3?filename=lofi-study-112191.mp3"}
];

function loadSong(){
  const s = SONGS[state.music.songIndex % SONGS.length];
  music.src = s.url;
  music.loop = state.music.loop;
}
function unlockAudio(){
  loadSong();
  music.play().then(()=>{
    showToast("éŸ³è¨Šå·²è§£é–");
  }).catch(()=>{
    showToast("è«‹å†æŒ‰ä¸€æ¬¡æ’­æ”¾");
  });
}
function toggleMusic(){
  if(!music.src) loadSong();
  if(music.paused){
    music.play().catch(()=>{});
    showToast("æ’­æ”¾ä¸­");
  }else{
    music.pause();
    showToast("å·²æš«åœ");
  }
}
function nextSong(){
  state.music.songIndex = (state.music.songIndex+1)%SONGS.length;
  loadSong();
  music.play().catch(()=>{});
  showToast("ä¸‹ä¸€é¦–");
}
function prevSong(){
  state.music.songIndex = (state.music.songIndex-1+SONGS.length)%SONGS.length;
  loadSong();
  music.play().catch(()=>{});
  showToast("ä¸Šä¸€é¦–");
}
function toggleLoop(){
  state.music.loop = !state.music.loop;
  music.loop = state.music.loop;
  loopTxt.textContent = state.music.loop ? "ON":"OFF";
  showToast("å¾ªç’°: "+(state.music.loop?"ON":"OFF"));
}

/* ========= AI DIALOG ========= */
const aiDialog = document.getElementById("aiDialog");
const aiMsg = document.getElementById("aiMsg");
const aiInput = document.getElementById("aiInput");

function aiOpen(px,py){
  aiDialog.style.left = Math.max(8, Math.min(window.innerWidth-260, px-120))+"px";
  aiDialog.style.top = Math.max(8, Math.min(window.innerHeight-180, py-140))+"px";
  aiDialog.style.display="block";
  state.ai.talkOpen=true;
}
function aiClose(){
  aiDialog.style.display="none";
  state.ai.talkOpen=false;
}
function aiCommand(){
  const t = aiInput.value.trim();
  if(!t) return;
  aiInput.value="";
  if(t.includes("å·¡é‚")){
    aiMsg.textContent="ğŸ¦Š æ”¶åˆ°ï¼æˆ‘æœƒå·¡é‚é ˜åœ°ã€‚";
    state.auto=true;
  }else if(t.includes("æ”¶é›†")){
    aiMsg.textContent="ğŸ¦Š æ”¶é›†æ¨¡å¼å•Ÿå‹•ï¼Œå·¥äººæ•ˆç‡æå‡ã€‚";
    state.autoMode="eco";
  }else if(t.includes("å»ºé€ ")){
    aiMsg.textContent="ğŸ¦Š å»ºé€ æ¨¡å¼å•Ÿå‹•ï¼Œå„ªå…ˆæˆ¿å±‹èˆ‡å¸‚å ´ã€‚";
    state.autoMode="growth";
  }else if(t.includes("å‡ç´š")){
    aiMsg.textContent="ğŸ¦Š å‡ç´šæ¨¡å¼å•Ÿå‹•ï¼Œé›†ä¸­æå‡ç¶“æ¿Ÿã€‚";
    state.autoMode="balanced";
  }else if(t.includes("æ“´å¼µ")){
    aiMsg.textContent="ğŸ¦Š æ“´å¼µé ˜åœŸä¸­ï¼ˆä½¿ç”¨é‡‘å¹£ï¼‰ã€‚";
    state.territoryRadius = Math.min(30, state.territoryRadius+1);
  }else{
    aiMsg.textContent="ğŸ¦Š æˆ‘è½åˆ°ä½ è¬›ï¼šã€Œ"+t+"ã€æˆ‘æœƒè¨˜ä½ä¸¦åŸ·è¡Œã€‚";
  }
  refreshUI();
}

/* ========= BUILD MENU (tap empty tile) ========= */
const buildMenu = document.getElementById("buildMenu");
const bmGrid = document.getElementById("bmGrid");
const bmTitle = document.getElementById("bmTitle");
let bmX=0,bmY=0,bmChoice=null;

function openBuildMenu(screenX,screenY, tx,ty){
  bmX=tx; bmY=ty;
  bmChoice=null;
  bmTitle.textContent = "å»ºé€  (X:"+tx+" Y:"+ty+")";
  bmGrid.innerHTML="";

  const list = ["house","farm","lumber","mine","market","mint","wall"];
  for(const k of list){
    const info = BUILD_INFO[k];
    const b = document.createElement("button");
    b.className="bbtn";
    b.innerHTML = info.name + "<br><span style='opacity:.7;font-size:11px;'>æœ¨"+(info.cost.wood||0)+" çŸ³"+(info.cost.stone||0)+" é‡‘"+(info.cost.coin||0)+"</span>";
    b.onclick = ()=>{
      bmChoice=k;
      showToast("å·²é¸ï¼š"+info.name);
    };
    bmGrid.appendChild(b);
  }

  buildMenu.style.left = Math.max(8, Math.min(window.innerWidth-260, screenX-120))+"px";
  buildMenu.style.top = Math.max(8, Math.min(window.innerHeight-220, screenY-120))+"px";
  buildMenu.style.display="block";
}
function closeBuildMenu(){
  buildMenu.style.display="none";
}
function confirmBuild(){
  if(!bmChoice){ showToast("è«‹å…ˆé¸å»ºç¯‰"); return; }
  const ok = placeBuilding(bmX,bmY,bmChoice,true);
  if(ok){
    closeBuildMenu();
  }
}

/* ========= BUILD / UPGRADE ========= */
function tileHasBuilding(x,y){
  return state.buildings.find(b=>b.x===x && b.y===y);
}

function isInTerritory(tx,ty){
  const cx = Math.floor(MAP_W/2);
  const cy = Math.floor(MAP_H/2);
  return Math.hypot(tx-cx, ty-cy) <= state.territoryRadius;
}

function placeBuilding(tx,ty,type,charge=true){
  if(!isInTerritory(tx,ty)){
    showToast("å””ä¿‚é ˜åœŸç¯„åœ");
    return false;
  }
  if(tileHasBuilding(tx,ty)){
    showToast("æ­¤åœ°å·²æœ‰å»ºç¯‰");
    return false;
  }
  const tile = map[ty]?.[tx];
  if(tile===undefined) return false;
  if(tile===TILETYPE.RIVER || tile===TILETYPE.MOUNTAIN || tile===TILETYPE.BLACKHOLE){
    showToast("æ­¤åœ°ä¸èƒ½å»ºé€ ");
    return false;
  }

  const info = BUILD_INFO[type];
  if(!info){ showToast("å»ºç¯‰ä¸å­˜åœ¨"); return false; }

  if(charge){
    const c = info.cost;
    if(state.resources.wood < (c.wood||0) ||
       state.resources.stone < (c.stone||0) ||
       state.resources.coin < (c.coin||0)){
      showToast("è³‡æºä¸è¶³");
      return false;
    }
    state.resources.wood -= (c.wood||0);
    state.resources.stone -= (c.stone||0);
    state.resources.coin -= (c.coin||0);
  }

  state.buildings.push({x:tx,y:ty,type:type,level:1,progress:100});
  if(info.cap) state.cap += info.cap;

  showToast("å»ºæˆï¼š"+info.name);
  refreshUI();
  return true;
}

let selectedBuilding = null;

function upgradeSelected(){
  if(!selectedBuilding){
    showToast("æœªé¸å»ºç¯‰");
    return;
  }
  const b = selectedBuilding;
  const info = BUILD_INFO[b.type];
  const costWood = Math.floor((info.cost.wood||50) * (0.8 + b.level*0.6));
  const costStone= Math.floor((info.cost.stone||30)* (0.8 + b.level*0.6));
  const costCoin = Math.floor((info.cost.coin||100)* (0.6 + b.level*0.7));

  if(state.resources.wood>=costWood && state.resources.stone>=costStone && state.resources.coin>=costCoin){
    state.resources.wood-=costWood;
    state.resources.stone-=costStone;
    state.resources.coin-=costCoin;
    b.level++;
    showToast("å‡ç´šæˆåŠŸ Lv."+b.level);
  }else{
    showToast("å‡ç´šè³‡æºä¸è¶³");
  }
  refreshUI();
}

/* ========= ECONOMY / COIN ========= */
function buildingIncomePerSec(){
  let prod = {wood:0,stone:0,iron:0,food:0,coin:0};
  for(const b of state.buildings){
    const info = BUILD_INFO[b.type];
    if(!info || !info.prod) continue;
    const mul = 1 + (b.level-1)*0.75;

    for(const k in info.prod){
      prod[k] += info.prod[k]*mul;
    }
  }
  return prod;
}

/* ========= AENO HIDDEN ALGO (OBFUSCATED) ========= */
function _mix(n){
  n = (n ^ (n << 13)) >>> 0;
  n = (n ^ (n >>> 17)) >>> 0;
  n = (n ^ (n << 5)) >>> 0;
  return n >>> 0;
}
function _secretBits(seed){
  const alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
  const mapBits = [];
  // hidden: 11..20 mapping by shifting
  for(let i=0;i<alphabet.length;i++){
    const v = ((i+seed)%20)+1;
    mapBits.push(v>=11 && v<=20 ? 1:0);
  }
  return mapBits;
}
function calcAenoGain(seconds){
  // AENO mint is slow: fragments only
  const now = Date.now();
  const seed = (now ^ state.resources.coin ^ (state.pop<<7) ^ (state.shard<<3)) >>> 0;
  const bits = _secretBits(seed & 31);

  // ad listened bonus
  let listenScore = 0;
  if(!music.paused){
    listenScore = Math.min(1, seconds/20);
  }

  // civilization cost score (buildings + upgrades)
  let civ = state.buildings.length*0.02 + (state.cap*0.01);

  // shards score
  let shardScore = Math.min(1, state.shard/500);

  let raw = (listenScore*0.6 + civ*0.25 + shardScore*0.15);

  // apply bit mask noise
  let idx = _mix(seed) % bits.length;
  raw *= (bits[idx] ? 1.05 : 0.95);

  // global slow mint rate
  const perSec = 0.0000025; // VERY slow
  return raw * perSec * seconds;
}

/* ========= BEAST TIDE ========= */
function wallComplete(){
  const walls = state.buildings.filter(b=>b.type==="wall");
  if(walls.length<8) return false;
  // simple: if enough walls exist -> treat as completed
  return true;
}

function beastTick(seconds){
  if(!wallComplete()) return;

  // rare tide
  if(Math.random() < seconds*0.00008){
    const loot = Math.floor(30 + Math.random()*120);
    const shard = Math.floor(5 + Math.random()*25);
    state.loot += loot;
    state.shard += shard;
    showToast("âš”ï¸ ç¸æ½®ä¾†è¥²ï¼æ‰è½æˆ°åˆ©å“+"+loot+" ç¢ç‰‡+"+shard);
  }
}

function collectLoot(){
  if(state.loot<=0){ showToast("ç„¡æˆ°åˆ©å“"); return; }
  state.resources.coin += state.loot;
  showToast("æ”¶å–æˆ°åˆ©å“ï¼šé‡‘å¹£+"+state.loot);
  state.loot = 0;
  refreshUI();
}

function collectShard(){
  // shard -> AENO (slow)
  if(state.shard<200){ showToast("ç¢ç‰‡ä¸è¶³ (éœ€è¦200)"); return; }
  state.shard -= 200;
  state.aeno += 0.05;
  showToast("åˆæˆæˆåŠŸï¼šAENO +0.05");
  refreshUI();
}

/* ========= WORKERS & AI ========= */
function workerTick(seconds){
  // workers gather resources
  const gatherRate = state.pop * 0.15;
  state.resources.wood += gatherRate*seconds*0.6;
  state.resources.stone += gatherRate*seconds*0.3;
  state.resources.iron += gatherRate*seconds*0.15;
  state.resources.food += gatherRate*seconds*0.8;

  // coin base income to fix early game
  state.resources.coin += (1.2 + state.pop*0.15) * seconds;

  // population growth
  if(state.pop < state.cap){
    if(Math.random() < seconds*0.03){
      state.pop++;
      showToast("ğŸ‘¥ äººå£å¢åŠ  +1");
    }
  }
}

function aiAutoBuild(seconds){
  if(!state.auto) return;

  // AI uses coin/wood/stone to expand
  const mode = state.autoMode || "balanced";

  const needHouse = state.pop >= state.cap-1;
  const haveMarket = state.buildings.some(b=>b.type==="market");
  const haveMint = state.buildings.some(b=>b.type==="mint");

  // auto expand territory using coin
  const expandCost = 300 + state.territoryRadius*80;
  if(state.resources.coin > expandCost && Math.random() < seconds*0.04){
    state.resources.coin -= expandCost;
    state.territoryRadius = Math.min(30, state.territoryRadius+1);
    showToast("ğŸ—ºï¸ é ˜åœŸè‡ªå‹•æ“´å¼µ +1");
  }

  // pick random empty tile near base
  const cx = Math.floor(MAP_W/2);
  const cy = Math.floor(MAP_H/2);

  function tryBuild(type){
    for(let i=0;i<40;i++){
      const tx = cx + Math.floor(Math.random()*state.territoryRadius*2 - state.territoryRadius);
      const ty = cy + Math.floor(Math.random()*state.territoryRadius*2 - state.territoryRadius);
      if(tx<1||ty<1||tx>=MAP_W-1||ty>=MAP_H-1) continue;
      if(!isInTerritory(tx,ty)) continue;
      if(tileHasBuilding(tx,ty)) continue;
      if(map[ty][tx]===TILETYPE.RIVER || map[ty][tx]===TILETYPE.MOUNTAIN) continue;
      return placeBuilding(tx,ty,type,true);
    }
    return false;
  }

  if(needHouse){
    tryBuild("house");
    return;
  }

  if(mode==="growth"){
    if(Math.random()<0.5) tryBuild("farm");
    else tryBuild("house");
    if(!haveMarket) tryBuild("market");
  }
  else if(mode==="eco"){
    if(Math.random()<0.5) tryBuild("lumber");
    else tryBuild("mine");
    if(!haveMarket) tryBuild("market");
  }
  else if(mode==="military"){
    if(Math.random()<0.4) tryBuild("wall");
    else tryBuild("mine");
  }
  else{
    // balanced
    if(!haveMarket) tryBuild("market");
    else if(!haveMint && state.resources.coin>1200) tryBuild("mint");
    else if(Math.random()<0.35) tryBuild("farm");
    else if(Math.random()<0.5) tryBuild("lumber");
    else tryBuild("mine");
  }
}

/* ========= CAMERA / INPUT ========= */
let dragging=false;
let lastX=0,lastY=0;
let pinchDist=0;

function screenToWorld(sx,sy){
  const z = state.cam.zoom;
  const wx = (sx - window.innerWidth/2)/z + state.cam.x;
  const wy = (sy - window.innerHeight/2)/z + state.cam.y;
  return {x:wx,y:wy};
}
function worldToTile(wx,wy){
  return {tx:Math.floor(wx/TILE), ty:Math.floor(wy/TILE)};
}

cv.addEventListener("pointerdown",(e)=>{
  dragging=true;
  lastX=e.clientX;
  lastY=e.clientY;
  cv.setPointerCapture(e.pointerId);
});

cv.addEventListener("pointermove",(e)=>{
  if(!dragging) return;
  const dx = e.clientX-lastX;
  const dy = e.clientY-lastY;
  lastX=e.clientX; lastY=e.clientY;
  state.cam.x -= dx/state.cam.zoom;
  state.cam.y -= dy/state.cam.zoom;
});

cv.addEventListener("pointerup",(e)=>{
  dragging=false;

  // tap to build/select
  const w = screenToWorld(e.clientX,e.clientY);
  const {tx,ty} = worldToTile(w.x,w.y);

  if(tx<0||ty<0||tx>=MAP_W||ty>=MAP_H) return;

  // AI click area
  const ax = state.ai.x, ay = state.ai.y;
  if(Math.hypot(w.x-ax,w.y-ay) < 40){
    aiOpen(e.clientX,e.clientY);
    return;
  }

  const b = tileHasBuilding(tx,ty);
  if(b){
    selectedBuilding = b;
    showToast("é¸ä¸­ï¼š"+BUILD_INFO[b.type].name+" Lv."+b.level);
    return;
  }

  if(buildBrush){
    placeBuilding(tx,ty,buildBrush,true);
    return;
  }

  // open build menu on empty territory tile
  if(isInTerritory(tx,ty)){
    openBuildMenu(e.clientX,e.clientY,tx,ty);
  }else{
    showToast("é»é ˜åœŸå…§ç©ºåœ°å…ˆå¯å»ºé€ ");
  }
});

cv.addEventListener("wheel",(e)=>{
  e.preventDefault();
  const dz = e.deltaY>0 ? -0.08 : 0.08;
  state.cam.zoom = Math.max(0.2, Math.min(4, state.cam.zoom + dz));
},{passive:false});

/* mobile pinch */
let touches = [];
cv.addEventListener("touchstart",(e)=>{
  touches = [...e.touches];
  if(touches.length===2){
    const dx = touches[0].clientX-touches[1].clientX;
    const dy = touches[0].clientY-touches[1].clientY;
    pinchDist = Math.hypot(dx,dy);
  }
},{passive:true});

cv.addEventListener("touchmove",(e)=>{
  if(e.touches.length===2){
    const t0=e.touches[0], t1=e.touches[1];
    const dx=t0.clientX-t1.clientX;
    const dy=t0.clientY-t1.clientY;
    const d=Math.hypot(dx,dy);
    const diff=d-pinchDist;
    pinchDist=d;
    state.cam.zoom = Math.max(0.2, Math.min(4, state.cam.zoom + diff*0.003));
  }
},{passive:true});

/* ========= DRAW HELPERS ========= */
function roundedRect(x,y,w,h,r){
  ctx.beginPath();
  ctx.moveTo(x+r,y);
  ctx.arcTo(x+w,y,x+w,y+h,r);
  ctx.arcTo(x+w,y+h,x,y+h,r);
  ctx.arcTo(x,y+h,x,y,r);
  ctx.arcTo(x,y,x+w,y,r);
  ctx.closePath();
}

function drawTile(x,y,type){
  const px=x*TILE, py=y*TILE;

  if(type===TILETYPE.GRASS){
    ctx.fillStyle="#c7f9cc";
    ctx.fillRect(px,py,TILE,TILE);
  }else if(type===TILETYPE.FOREST){
    ctx.fillStyle="#b7f7c2";
    ctx.fillRect(px,py,TILE,TILE);
    ctx.fillStyle="#2f9e44";
    for(let i=0;i<3;i++){
      ctx.beginPath();
      ctx.arc(px+16+i*16,py+20,10,0,Math.PI*2);
      ctx.fill();
    }
  }else if(type===TILETYPE.ROCK){
    ctx.fillStyle="#d0ebff";
    ctx.fillRect(px,py,TILE,TILE);
    ctx.fillStyle="#94a3b8";
    ctx.beginPath();
    ctx.arc(px+34,py+36,16,0,Math.PI*2);
    ctx.fill();
  }else if(type===TILETYPE.IRON){
    ctx.fillStyle="#e5e7eb";
    ctx.fillRect(px,py,TILE,TILE);
    ctx.fillStyle="#64748b";
    ctx.beginPath();
    ctx.arc(px+34,py+34,16,0,Math.PI*2);
    ctx.fill();
    ctx.fillStyle="#ef4444";
    ctx.beginPath();
    ctx.arc(px+40,py+28,5,0,Math.PI*2);
    ctx.fill();
  }else if(type===TILETYPE.RIVER){
    ctx.fillStyle="#74c0fc";
    ctx.fillRect(px,py,TILE,TILE);
    ctx.fillStyle="rgba(255,255,255,.35)";
    ctx.fillRect(px+8,py+10,TILE-16,6);
  }else if(type===TILETYPE.MOUNTAIN){
    ctx.fillStyle="#dbeafe";
    ctx.fillRect(px,py,TILE,TILE);
    ctx.fillStyle="#94a3b8";
    ctx.beginPath();
    ctx.moveTo(px+10,py+54);
    ctx.lineTo(px+30,py+18);
    ctx.lineTo(px+54,py+54);
    ctx.closePath();
    ctx.fill();
  }else if(type===TILETYPE.BLACKHOLE){
    ctx.fillStyle="#0b0f1a";
    ctx.fillRect(px,py,TILE,TILE);
    ctx.fillStyle="#7c3aed";
    ctx.beginPath();
    ctx.arc(px+32,py+32,18,0,Math.PI*2);
    ctx.fill();
  }

  // subtle grid
  ctx.strokeStyle="rgba(0,0,0,.06)";
  ctx.strokeRect(px,py,TILE,TILE);
}

function drawBuilding(b){
  const px=b.x*TILE, py=b.y*TILE;
  const lv=b.level;

  // shadow
  ctx.fillStyle="rgba(0,0,0,.18)";
  ctx.beginPath();
  ctx.ellipse(px+32,py+52,22,8,0,0,Math.PI*2);
  ctx.fill();

  if(b.type==="house"){
    ctx.fillStyle="#fff1c7";
    roundedRect(px+10,py+18,44,34,10); ctx.fill();
    ctx.fillStyle="#ffb703";
    ctx.beginPath();
    ctx.moveTo(px+8,py+22);
    ctx.quadraticCurveTo(px+32,py-4,px+56,py+22);
    ctx.closePath(); ctx.fill();

    // door
    ctx.fillStyle="#d97706";
    roundedRect(px+28,py+36,10,16,4); ctx.fill();

    // window
    ctx.fillStyle="#93c5fd";
    ctx.beginPath(); ctx.arc(px+22,py+36,6,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(px+44,py+36,6,0,Math.PI*2); ctx.fill();
  }
  else if(b.type==="farm"){
    ctx.fillStyle="#ffd6a5";
    roundedRect(px+8,py+24,48,30,10); ctx.fill();
    ctx.fillStyle="#a7f3d0";
    for(let i=0;i<4;i++){
      ctx.fillRect(px+14+i*10,py+28,6,22);
    }
  }
  else if(b.type==="lumber"){
    ctx.fillStyle="#fde68a";
    roundedRect(px+10,py+20,44,34,10); ctx.fill();
    ctx.fillStyle="#92400e";
    ctx.fillRect(px+18,py+34,6,20);
    ctx.fillRect(px+40,py+34,6,20);
    ctx.fillStyle="#16a34a";
    ctx.beginPath(); ctx.arc(px+20,py+30,10,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(px+44,py+30,10,0,Math.PI*2); ctx.fill();
  }
  else if(b.type==="mine"){
    ctx.fillStyle="#cbd5e1";
    roundedRect(px+8,py+22,48,32,12); ctx.fill();
    ctx.fillStyle="#64748b";
    ctx.beginPath();
    ctx.moveTo(px+14,py+50);
    ctx.lineTo(px+32,py+26);
    ctx.lineTo(px+50,py+50);
    ctx.closePath(); ctx.fill();
    ctx.fillStyle="#ef4444";
    ctx.beginPath(); ctx.arc(px+38,py+38,5,0,Math.PI*2); ctx.fill();
  }
  else if(b.type==="market"){
    ctx.fillStyle="#e0f2fe";
    roundedRect(px+8,py+22,48,32,12); ctx.fill();
    ctx.fillStyle="#ff4d8d";
    roundedRect(px+8,py+18,48,12,8); ctx.fill();
    ctx.fillStyle="#0f172a";
    ctx.font="900 10px system-ui";
    ctx.fillText("$",px+28,py+40);
  }
  else if(b.type==="mint"){
    ctx.fillStyle="#dcfce7";
    roundedRect(px+8,py+20,48,34,12); ctx.fill();
    ctx.fillStyle="#22c55e";
    ctx.beginPath(); ctx.arc(px+32,py+36,12,0,Math.PI*2); ctx.fill();
    ctx.fillStyle="#0f172a";
    ctx.font="900 10px system-ui";
    ctx.fillText("A",px+28,py+40);
  }
  else if(b.type==="wall"){
    ctx.fillStyle="#94a3b8";
    roundedRect(px+6,py+30,52,22,8); ctx.fill();
    ctx.fillStyle="#64748b";
    for(let i=0;i<4;i++){
      ctx.fillRect(px+10+i*12,py+26,8,8);
    }
  }

  // level tag
  ctx.fillStyle="rgba(0,0,0,.55)";
  ctx.font="900 10px system-ui";
  ctx.fillText("Lv"+lv, px+6, py+14);
}

function drawWorker(w){
  // cartoon human
  ctx.save();
  ctx.translate(w.x,w.y);

  // shadow
  ctx.fillStyle="rgba(0,0,0,.15)";
  ctx.beginPath(); ctx.ellipse(0,18,12,5,0,0,Math.PI*2); ctx.fill();

  // body
  ctx.fillStyle="#60a5fa";
  roundedRect(-8,-2,16,18,6); ctx.fill();

  // head
  ctx.fillStyle="#ffd6a5";
  ctx.beginPath(); ctx.arc(0,-10,8,0,Math.PI*2); ctx.fill();

  // legs
  ctx.strokeStyle="#1e293b";
  ctx.lineWidth=3;
  ctx.beginPath();
  ctx.moveTo(-4,16); ctx.lineTo(-6,24);
  ctx.moveTo(4,16); ctx.lineTo(6,24);
  ctx.stroke();

  // hands
  ctx.beginPath();
  ctx.moveTo(-8,4); ctx.lineTo(-14,8);
  ctx.moveTo(8,4); ctx.lineTo(14,8);
  ctx.stroke();

  ctx.restore();
}

function drawAnimal(a){
  ctx.save();
  ctx.translate(a.x,a.y);

  // shadow
  ctx.fillStyle="rgba(0,0,0,.12)";
  ctx.beginPath(); ctx.ellipse(0,16,14,5,0,0,Math.PI*2); ctx.fill();

  // body
  ctx.fillStyle="#fff";
  roundedRect(-12,-2,24,18,10); ctx.fill();

  // head
  ctx.fillStyle="#fff";
  ctx.beginPath(); ctx.arc(0,-10,10,0,Math.PI*2); ctx.fill();

  // ears
  ctx.fillStyle="#ffd6a5";
  ctx.beginPath(); ctx.arc(-6,-18,4,0,Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.arc(6,-18,4,0,Math.PI*2); ctx.fill();

  // face icon
  ctx.font="16px system-ui";
  ctx.fillStyle="#111827";
  ctx.fillText(a.kind, -8, -6);

  ctx.restore();
}

function drawAI(){
  const x=state.ai.x, y=state.ai.y;
  ctx.save();
  ctx.translate(x,y);

  // shadow
  ctx.fillStyle="rgba(0,0,0,.15)";
  ctx.beginPath(); ctx.ellipse(0,22,16,6,0,0,Math.PI*2); ctx.fill();

  // body (cartoon animal full body)
  ctx.fillStyle="#ffe066";
  roundedRect(-16,-2,32,26,14); ctx.fill();

  // head
  ctx.fillStyle="#ffd43b";
  ctx.beginPath(); ctx.arc(0,-18,16,0,Math.PI*2); ctx.fill();

  // ears
  ctx.fillStyle="#fab005";
  ctx.beginPath(); ctx.arc(-10,-32,6,0,Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.arc(10,-32,6,0,Math.PI*2); ctx.fill();

  // face
  ctx.fillStyle="#111827";
  ctx.beginPath(); ctx.arc(-6,-20,2.5,0,Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.arc(6,-20,2.5,0,Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.arc(0,-14,3,0,Math.PI*2); ctx.fill();

  // legs
  ctx.strokeStyle="#111827";
  ctx.lineWidth=4;
  ctx.beginPath();
  ctx.moveTo(-8,20); ctx.lineTo(-10,30);
  ctx.moveTo(8,20); ctx.lineTo(10,30);
  ctx.stroke();

  // ad flag slot
  ctx.fillStyle="#ff4d8d";
  roundedRect(-12,-52,24,12,6); ctx.fill();
  ctx.fillStyle="#fff";
  ctx.font="900 9px system-ui";
  ctx.fillText("AD", -8, -43);

  ctx.restore();
}

/* ========= PLANET SELECT ========= */
const planetModal = document.getElementById("planetModal");
const planetList = document.getElementById("planetList");
const closePlanet = document.getElementById("closePlanet");

function openPlanetModal(){
  planetList.innerHTML="";
  for(const p of PLANETS){
    const b=document.createElement("button");
    b.className="planetBtn";
    b.textContent=p.name;
    b.onclick=()=>{
      state.planetId=p.id;
      showToast("å·²åˆ‡æ›ï¼š"+p.name);
      planetModal.style.display="none";
      saveGame();
      refreshUI();
    };
    planetList.appendChild(b);
  }
  planetModal.style.display="flex";
}
closePlanet.onclick=()=>planetModal.style.display="none";

/* ========= SIMULATION (OFFLINE UP TO 24H) ========= */
function simulate(seconds){
  seconds = Math.max(0, seconds);

  // 24h cap
  const max = 24*3600;
  if(seconds>max){
    seconds=max;
    showToast("â³ é›¢ç·šè£œç®—æœ€å¤š24å°æ™‚");
  }

  // economy
  workerTick(seconds);

  // building production
  const prod = buildingIncomePerSec();
  state.resources.wood += prod.wood*seconds;
  state.resources.stone+= prod.stone*seconds;
  state.resources.iron += prod.iron*seconds;
  state.resources.food += prod.food*seconds;
  state.resources.coin += prod.coin*seconds;

  // beast tide
  beastTick(seconds);

  // AI automation
  aiAutoBuild(seconds);

  // AENO mint (hidden)
  const gain = calcAenoGain(seconds);
  state.aeno += gain;
}

/* ========= GAME LOOP ========= */
let lastFrame = performance.now();

function update(dt){
  // move animals/workers
  for(const w of state.workers){
    w.x += w.vx*dt*0.06;
    w.y += w.vy*dt*0.06;
    if(Math.random()<0.02){ w.vx=(Math.random()*2-1)*0.7; w.vy=(Math.random()*2-1)*0.7; }
  }
  for(const a of state.animals){
    a.x += a.vx*dt*0.04;
    a.y += a.vy*dt*0.04;
    if(Math.random()<0.02){ a.vx=(Math.random()*2-1)*0.5; a.vy=(Math.random()*2-1)*0.5; }
  }

  // AI idle movement
  state.ai.x += (Math.sin(performance.now()*0.001)*0.2);
  state.ai.y += (Math.cos(performance.now()*0.0012)*0.2);

  // music listened time
  if(!music.paused){
    state.music.listenedSeconds += dt/1000;
    if(state.music.listenedSeconds - state.music.lastTickListen > 20){
      state.music.lastTickListen = state.music.listenedSeconds;
      state.resources.coin += 30;
      state.shard += 8;
      showToast("ğŸµ è½æ­Œçå‹µï¼šé‡‘å¹£+30 ç¢ç‰‡+8");
    }
  }
}

function draw(){
  ctx.clearRect(0,0,window.innerWidth,window.innerHeight);

  ctx.save();
  ctx.translate(window.innerWidth/2, window.innerHeight/2);
  ctx.scale(state.cam.zoom, state.cam.zoom);
  ctx.translate(-state.cam.x, -state.cam.y);

  // visible tile range
  const startX = Math.max(0, Math.floor((state.cam.x - (window.innerWidth/state.cam.zoom)/2)/TILE)-2);
  const startY = Math.max(0, Math.floor((state.cam.y - (window.innerHeight/state.cam.zoom)/2)/TILE)-2);
  const endX = Math.min(MAP_W-1, Math.floor((state.cam.x + (window.innerWidth/state.cam.zoom)/2)/TILE)+2);
  const endY = Math.min(MAP_H-1, Math.floor((state.cam.y + (window.innerHeight/state.cam.zoom)/2)/TILE)+2);

  for(let y=startY;y<=endY;y++){
    for(let x=startX;x<=endX;x++){
      drawTile(x,y,map[y][x]);
    }
  }

  // territory ring
  const cx = Math.floor(MAP_W/2)*TILE + TILE/2;
  const cy = Math.floor(MAP_H/2)*TILE + TILE/2;
  ctx.strokeStyle="rgba(0,0,0,.15)";
  ctx.lineWidth=4;
  ctx.beginPath();
  ctx.arc(cx,cy,state.territoryRadius*TILE,0,Math.PI*2);
  ctx.stroke();

  // buildings
  for(const b of state.buildings){
    drawBuilding(b);
  }

  // animals & workers
  for(const a of state.animals) drawAnimal(a);
  for(const w of state.workers) drawWorker(w);

  // AI
  drawAI();

  ctx.restore();
}

function loop(t){
  const dt = Math.min(60, t-lastFrame);
  lastFrame = t;

  try{
    // simulate realtime
    simulate(dt/1000);

    update(dt);
    draw();
    refreshUI();
  }catch(e){
    // prevent Chrome black screen crash
    console.error(e);
  }

  requestAnimationFrame(loop);
}

/* ========= INIT ========= */
loadGame();
genMap(1234);
initDefaultBase();

// offline simulate
const now = Date.now();
const offline = (now - state.lastSeen)/1000;
if(offline>2){
  simulate(offline);
}

refreshUI();
setInterval(saveGame, 20000);

requestAnimationFrame(loop);

/* ========= SW FORCE UPDATE ========= */
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("./sw.js?v=" + Date.now()).then((reg) => reg.update());
  navigator.serviceWorker.getRegistrations().then((regs) => regs.forEach((r) => r.update()));
}
</script>

</body>
</html>
