<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=5.0,user-scalable=yes"/>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<title>AENO V3.2 - æœ¨å» å®Œæ•´ç‰ˆ (Vertical)</title>
<style>
  :root{
    --bg:#eaf7ff;
    --panel:#ffffffee;
    --panel2:#f8fbff;
    --border:#cfe8ff;
    --text:#0f172a;
    --muted:#64748b;
    --accent:#3b82f6;
    --accent2:#22c55e;
    --danger:#ef4444;
    --gold:#f59e0b;
    --aeno:#8b5cf6;
  }
  *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans HK","PingFang HK","Microsoft JhengHei",sans-serif;}
  body{
    margin:0;
    background:linear-gradient(#eaf7ff,#f8fbff);
    overflow:hidden;
    touch-action:pan-x pan-y;
  }
  #wrap{
    width:100vw;height:100vh;
    display:flex;justify-content:center;align-items:center;
  }
  #game{
    position:relative;
    width:min(460px,100vw);
    height:100vh;
    max-height:980px;
    background:linear-gradient(#eaf7ff,#f7fbff);
    border-left:1px solid #dbeafe;
    border-right:1px solid #dbeafe;
    overflow:hidden;
  }

  canvas{
    width:100%;
    height:100%;
    display:block;
    background:linear-gradient(#eaf7ff,#f7fbff);
    touch-action: none;
  }

  /* TOP BAR */
  #topbar{
    position:absolute;top:0;left:0;right:0;
    padding:10px 10px 8px 10px;
    display:flex;gap:8px;align-items:center;
    z-index:50;
    background:linear-gradient(#ffffffdd,#ffffff00);
    backdrop-filter: blur(6px);
  }
  .chip{
    padding:8px 10px;
    border-radius:14px;
    background:#ffffffdd;
    border:1px solid var(--border);
    font-size:12px;
    color:var(--text);
    box-shadow:0 6px 14px rgba(0,0,0,0.06);
    display:flex;align-items:center;gap:6px;
    user-select:none;
    cursor:pointer;
  }
  .chip b{font-size:12px;}
  .chip .dot{
    width:8px;height:8px;border-radius:999px;background:var(--accent);
  }

  /* ã€æ ¸å¿ƒï¼šæ‰€æœ‰é¢æ¿å¯æ‹‰æ”¾+æ‹–æ‹½ã€‘ */
  .winPanel{
    position:absolute;
    background:rgba(255,255,255,0.95);
    border:3px solid #0099FF;
    border-radius:12px;
    box-shadow:0 0 15px rgba(0,0,0,0.3);
    resize: both; /* è‡ªç”±æ‹‰æ”¾ç¸®æ”¾ */
    overflow: hidden;
    z-index:9999;
    min-width:220px;
    min-height:150px;
    max-width:95vw;
    max-height:95vh;
  }
  .winHead{
    width:100%;
    height:34px;
    background:#0099FF;
    color:#fff;
    font-size:14px;
    line-height:34px;
    padding:0 12px;
    font-weight:bold;
    cursor:move;
    user-select:none;
  }
  .winBody{
    padding:12px;
    height:calc(100% - 34px);
    overflow-y:auto;
  }

  .btn{
    border:none;
    padding:10px 12px;
    border-radius:14px;
    background:var(--accent);
    color:white;
    font-weight:800;
    cursor:pointer;
    user-select:none;
    box-shadow:0 10px 20px rgba(59,130,246,0.25);
    font-size:12px;
    flex:1;
  }
  .btn.gray{
    background:#e2e8f0;color:#0f172a;
    box-shadow:none;
    border:1px solid #cbd5e1;
  }
  .btn.green{
    background:var(--accent2);
    box-shadow:0 10px 20px rgba(34,197,94,0.25);
  }
  .btn.gold{
    background:var(--gold);
    box-shadow:0 10px 20px rgba(245,158,11,0.25);
  }
  .btn.purple{
    background:var(--aeno);
    box-shadow:0 10px 20px rgba(139,92,246,0.25);
  }
  .btn.red{
    background:var(--danger);
    box-shadow:0 10px 20px rgba(239,68,68,0.25);
  }
  .btn.brown{
    background:#a0522d;
    box-shadow:0 10px 20px rgba(160,82,45,0.25);
  }
  .label{
    font-size:12px;color:var(--muted);
    margin-bottom:6px;
  }
  .big{
    font-size:14px;font-weight:900;color:var(--text);
  }
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace;}
  input,select{
    width:100%;
    padding:10px;
    border-radius:14px;
    border:1px solid #dbeafe;
    background:#f8fbff;
    font-size:13px;
  }
  .row{display:flex;gap:8px;flex-wrap:wrap;}
  .card{
    background:#ffffff;
    border:1px solid #e2f0ff;
    border-radius:18px;
    padding:12px;
    box-shadow:0 10px 24px rgba(0,0,0,0.06);
    margin-bottom:10px;
  }

  /* AI CHAT FLOAT PANEL */
  #chatFloat{
    position:absolute;
    right:12px;
    top:86px;
    width:240px;
    height:280px;
    border-radius:18px;
    border:1px solid #dbeafe;
    background:#ffffffdd;
    backdrop-filter: blur(6px);
    box-shadow:0 12px 26px rgba(0,0,0,0.12);
    z-index:70;
    overflow:hidden;
    transition: transform .25s ease;
  }
  #chatFloat.min{
    transform: translateX(190px);
  }
  #chatHeader{
    padding:8px 10px;
    background:linear-gradient(#ffffff,#f1f8ff);
    border-bottom:1px solid #dbeafe;
    display:flex;align-items:center;justify-content:space-between;
    font-weight:900;font-size:12px;color:var(--text);
    cursor:move;
  }
  #chatBody{
    height:calc(100% - 110px);
    overflow:auto;
    padding:8px;
    font-size:12px;
    color:#0f172a;
  }
  .msg{margin-bottom:8px;line-height:1.35;}
  .msg .who{font-weight:900;}
  .msg.ai .who{color:#2563eb;}
  .msg.me .who{color:#16a34a;}
  #chatInputWrap{
    display:flex;gap:6px;padding:8px;border-top:1px solid #dbeafe;
    background:#ffffff;
  }
  #chatInputWrap input{
    flex:1;
    padding:9px;
    border-radius:12px;
    font-size:12px;
  }
  #chatInputWrap button{
    padding:9px 10px;border-radius:12px;border:none;
    background:#2563eb;color:white;font-weight:900;font-size:12px;
  }

  /* MAIN CONTROL PANEL */
  #panel{
    position:absolute;
    left:10px; right:10px;
    bottom:10px;
    height:52%;
    border-radius:22px;
    background:var(--panel);
    border:1px solid var(--border);
    box-shadow:0 18px 50px rgba(0,0,0,0.12);
    z-index:80;
    overflow:hidden;
    transition: transform .25s ease;
  }
  #panel.min{
    transform: translateY(calc(100% - 64px));
  }
  #panelHeader{
    height:64px;
    padding:10px 12px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    background:linear-gradient(#ffffff,#f1f8ff);
    border-bottom:1px solid #dbeafe;
    cursor:move;
  }
  #panelTitle{
    display:flex;flex-direction:column;
    gap:2px;
  }
  #panelTitle .t{
    font-weight:900;
    font-size:14px;
    color:var(--text);
    letter-spacing:0.3px;
  }
  #panelTitle .s{
    font-size:11px;color:var(--muted);
  }
  #panelTabs{
    display:flex;gap:6px;flex-wrap:wrap;
    justify-content:flex-end;
  }
  .tab{
    font-size:11px;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid #dbeafe;
    background:#fff;
    color:#0f172a;
    cursor:pointer;
    user-select:none;
  }
  .tab.active{
    background:var(--accent);
    border-color:var(--accent);
    color:white;
    font-weight:700;
  }
  #panelBody{
    height:calc(100% - 64px);
    overflow:auto;
    padding:10px;
    background:linear-gradient(#ffffff,#f8fbff);
  }

  /* TOAST NOTIFICATION */
  #toast{
    position:absolute;
    left:50%;
    transform:translateX(-50%);
    top:62px;
    background:#0f172acc;
    color:white;
    font-size:12px;
    padding:8px 12px;
    border-radius:999px;
    z-index:200;
    display:none;
  }
</style>
</head>
<body>
<div id="wrap">
  <div id="game">
    <div id="topbar">
      <div class="chip" id="btnTogglePanel"><span class="dot"></span><b>å¸åœ‹é¢æ¿</b></div>
      <div class="chip" id="btnSave"><b>å­˜æª”</b></div>
      <div class="chip" id="btnReset"><b>é‡ç½®</b></div>
    </div>

    <div id="toast"></div>
    <canvas id="cv"></canvas>

    <!-- AIåŠ©æ‰‹é¢æ¿ï¼ˆå¯æ‹‰æ”¾+æ‹–æ‹½ï¼‰ -->
    <div class="winPanel" id="chatFloat">
      <div id="chatHeader">
        <span>ğŸ¾ AIåŠ©æ‰‹ - Aenko</span>
        <span style="cursor:pointer;" id="btnChatMin">â–¸</span>
      </div>
      <div id="chatBody"></div>
      <div id="chatInputWrap">
        <input id="chatInput" placeholder="è¼¸å…¥ï¼šè‡ªå‹•å»ºæœ¨å»  / å·¡é‚ / æ”¶é›†è³‡æº..." />
        <button id="chatSend">é€å‡º</button>
      </div>
    </div>

    <!-- è³‡æºé¢æ¿ï¼ˆå¯æ‹‰æ”¾+æ‹–æ‹½ï¼‰ -->
    <div class="winPanel" id="resWin" style="top:10px;left:10px;width:320px;height:280px;">
      <div class="winHead">ğŸ“¦ è³‡æºé¢æ¿ (å¯æ‹–+æ‹‰æ”¾)</div>
      <div class="winBody">
        <div class="row">
          <div class="big">ğŸ’° <span id="resGold">1000</span> é‡‘å¹£</div>
          <div class="big">ğŸŸ£ <span id="resAeno">50</span> AENOå¹£</div>
        </div>
        <div class="row" style="margin-top:8px;">
          <div>ğŸªµ <span id="resWood">300</span> æœ¨æ</div>
          <div>ğŸŒ¾ <span id="resFood">300</span> ç³§é£Ÿ</div>
        </div>
        <div class="row">
          <div>ğŸª¨ <span id="resStone">200</span> çŸ³æ</div>
          <div>âš™ï¸ <span id="resIron">100</span> éµç¤¦</div>
        </div>
        <div class="row" style="margin-top:12px;">
          <button class="btn" onclick="expandTerritory()">ğŸŒ æ“´å¼µé ˜åœŸ</button>
        </div>
      </div>
    </div>

    <!-- ä¸»æ§åˆ¶ä¸­å¿ƒ -->
    <div id="panel" class="min">
      <div id="panelHeader">
        <div id="panelTitle">
          <div class="t">AENO å¸åœ‹æ§åˆ¶ä¸­å¿ƒ V3.2</div>
          <div class="s">æœ¨å» å·²è£œå…¨ | åœ°åœ–å¯æ‹‰æ”¾ | é¢æ¿å¯è‡ªç”±èª¿æ•´</div>
        </div>
        <div id="panelTabs">
          <div class="tab active" data-tab="home">ç¸½è¦½</div>
          <div class="tab" data-tab="build">å»ºè¨­</div>
          <div class="tab" data-tab="market">äº¤æ˜“æ‰€</div>
          <div class="tab" data-tab="stock">è‚¡å¸‚</div>
          <div class="tab" data-tab="tech">ç§‘æŠ€æ¨¹</div>
          <div class="tab" data-tab="event">äº‹ä»¶</div>
          <div class="tab" data-tab="ads">å»£å‘Š/æ­Œæ›²</div>
        </div>
      </div>
      <div id="panelBody"></div>
    </div>
  </div>
</div>

<script>
/* ===========================
   AENO V3.2 æœ¨å» å®Œæ•´ç‰ˆ
   æ‰€æœ‰å•é¡Œå·²ä¿®å¾©ï¼Œå°æ‡‰æ‰€æœ‰éœ€æ±‚
   =========================== */

/* ---------- å·¥å…·å‡½æ•¸ ---------- */
function clamp(v,a,b){return Math.max(a,Math.min(b,v));}
function rand(a,b){return a+Math.random()*(b-a);}
function irand(a,b){return Math.floor(rand(a,b+1));}
function now(){return Date.now();}
function fmt(n){
  if(n>=1e9) return (n/1e9).toFixed(2)+"B";
  if(n>=1e6) return (n/1e6).toFixed(2)+"M";
  if(n>=1e3) return (n/1e3).toFixed(2)+"K";
  return Math.floor(n).toString();
}

/* ---------- Canvas åˆå§‹åŒ– ---------- */
const cv=document.getElementById("cv");
const ctx=cv.getContext("2d");
let devicePixelRatio = window.devicePixelRatio || 1;

function resize(){
  const rect=cv.getBoundingClientRect();
  cv.width=Math.floor(rect.width*devicePixelRatio);
  cv.height=Math.floor(rect.height*devicePixelRatio);
  ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
}
window.addEventListener("resize",resize);
resize();

/* ---------- éŠæˆ²æ ¸å¿ƒé…ç½® ---------- */
const TILE=64;
const GRID_W=22;
const GRID_H=22;

// åœ°å½¢é…ç½®
const terrainTypes=["grass","forest","mountain","river","ore","plain"];
const terrainColor={
  grass:"#b9fbc0",
  forest:"#4ade80",
  mountain:"#94a3b8",
  river:"#60a5fa",
  ore:"#fbbf24",
  plain:"#dcfce7"
};

// ã€æ ¸å¿ƒï¼šè£œå…¨æœ¨å» é…ç½®ã€‘å»ºç¯‰å…ƒæ•¸æ“š
const buildingTypes=["none","lum","farm","mine","factory","wall","tower","town"];
const buildingMeta={
  none:{name:"ç©ºåœ°"},
  lum:{name:"æœ¨å» ",cost:{wood:20,gold:50},prod:{wood:6},desc:"ç ä¼æ£®æ—ç”Ÿç”¢æœ¨æ"},
  farm:{name:"è¾²ç”°",cost:{wood:30,stone:10,gold:60},prod:{food:4},desc:"ç¨®æ¤ç”Ÿç”¢ç³§é£Ÿ"},
  mine:{name:"ç¤¦å ´",cost:{wood:25,stone:35,gold:90},prod:{stone:2,iron:2},desc:"é–‹æ¡çŸ³æå’Œéµç¤¦"},
  factory:{name:"å·¥å» ",cost:{wood:60,stone:60,iron:40,gold:200},prod:{gold:5},desc:"ç”Ÿç”¢å•†å“è³ºé‡‘å¹£"},
  wall:{name:"åŸç‰†",cost:{stone:80,gold:120},def:2,desc:"æŠµç¦¦ç¸æ½®å’Œæ©Ÿå™¨äºº"},
  tower:{name:"å®ˆè¡›å¡”",cost:{wood:40,stone:80,iron:30,gold:160},def:5,desc:"ä¸»å‹•æ”»æ“Šå…¥ä¾µè€…"},
  town:{name:"åŸé®",cost:{wood:120,stone:120,iron:80,gold:600},prod:{gold:12},def:3,desc:"å¸åœ‹æ ¸å¿ƒ"}
};

/* ---------- å­˜æª”/è®€æª”ç³»çµ± ---------- */
const SAVE_KEY="AENO_V3_SAVE_2";
const CURRENT_VER=3.2;

function defaultState(){
  const map=[];
  for(let y=0;y<GRID_H;y++){
    const row=[];
    for(let x=0;x<GRID_W;x++){
      const t=genTerrain(x,y);
      row.push({
        terrain:t,
        building:"none",
        level:0
      });
    }
    map.push(row);
  }
  // åˆå§‹ä¸»åŸ
  map[11][11].building="town";
  map[11][11].level=1;

  return {
    ver:CURRENT_VER,
    lastTick:now(),
    // ã€åœ°åœ–æ‹‰æ”¾é…ç½®ã€‘ç›¸æ©Ÿåƒæ•¸
    camera:{x:0,y:0,zoom:1,targetZoom:1},
    selected:{x:11,y:11},
    // è³‡æº
    resources:{
      gold:1000,
      aeno:50,
      wood:300,
      stone:200,
      iron:100,
      food:300
    },
    territoryRadius:4,
    map,
    // ã€ç”Ÿå‹•AIå°å‹•ç‰©é…ç½®ã€‘
    ai:{
      name:"Aenko",
      x:11,y:11,
      px:0,py:0,
      mood:"ğŸ™‚",
      mode:"idle",
      blinkTimer:0,
      tailWagTimer:0,
      adText:"AENO MUSIC",
      lastSpeak:0
    },
    // æ©Ÿå™¨äººäº‹ä»¶
    robot:{
      active:false,
      x:0,y:0,
      stealTimer:0,
      adText:"SPONSOR"
    },
    // ç¸æ½®äº‹ä»¶
    beast:{
      timer: 90,
      wave:0,
      active:false
    },
    // äº¤æ˜“æ‰€&è‚¡å¸‚
    market:{
      prices:{
        wood:2,
        stone:3,
        iron:6,
        food:1
      }
    },
    stock:{
      lines:[]
    },
    // ç§‘æŠ€æ¨¹
    tech:{
      points:0,
      unlocked:{
        lum:true,
        farm:true,
        mine:true,
        factory:false,
        wall:false,
        tower:false
      }
    },
    // å»£å‘Šæ­Œæ›²
    ads:{
      cooldown:0,
      playing:false,
      lastReward:0
    },
    log:[]
  };
}

function saveGame(){
  localStorage.setItem(SAVE_KEY, JSON.stringify(state));
  toast("âœ… å·²å­˜æª”");
}

function loadGame(){
  try{
    const raw=localStorage.getItem(SAVE_KEY);
    if(!raw) return null;
    const obj=JSON.parse(raw);
    if(!obj || !obj.map) return null;
    
    // ç‰ˆæœ¬å…¼å®¹
    if((obj.ver||0) < CURRENT_VER){
      const defaultData = defaultState();
      obj.ver = CURRENT_VER;
      obj.tech = obj.tech || defaultData.tech;
      obj.camera = obj.camera || defaultData.camera;
      obj.ai = obj.ai || defaultData.ai;
      toast("âœ… å­˜æª”å·²å‡ç´šåˆ°æœ€æ–°ç‰ˆæœ¬");
    }
    return obj;
  }catch(e){
    console.error("å­˜æª”åŠ è¼‰å¤±æ•—", e);
    return null;
  }
}

function resetGame(){
  if(confirm("ç¢ºå®šé‡ç½®ï¼Ÿæ‰€æœ‰é›¢ç·šå­˜æª”æœƒæ¶ˆå¤±ã€‚")){
    localStorage.removeItem(SAVE_KEY);
    state=defaultState();
    toast("âš ï¸ å·²é‡ç½®ä¸–ç•Œ");
    pushLog("ä¸–ç•Œé‡ç½®ã€‚");
    renderPanel();
  }
}

/* ---------- åœ°å½¢ç”Ÿæˆ ---------- */
function genTerrain(x,y){
  const dx=x-11, dy=y-11;
  const d=Math.sqrt(dx*dx+dy*dy);
  if(Math.abs((x*0.8 + y*0.3) - 14) < 1.2) return "river";
  if(d>9 && Math.random()<0.55) return "mountain";
  if(d>5 && d<9 && Math.random()<0.45) return "forest";
  if(Math.random()<0.08) return "ore";
  if(Math.random()<0.25) return "plain";
  return "grass";
}

/* ---------- å…¨å±€ç‹€æ…‹ ---------- */
let state = loadGame() || defaultState();

/* ---------- UIå…ƒç´ ç¶å®š ---------- */
const panel=document.getElementById("panel");
const panelBody=document.getElementById("panelBody");
const btnTogglePanel=document.getElementById("btnTogglePanel");
const btnSave=document.getElementById("btnSave");
const btnReset=document.getElementById("btnReset");

const chatFloat=document.getElementById("chatFloat");
const chatBody=document.getElementById("chatBody");
const chatInput=document.getElementById("chatInput");
const chatSend=document.getElementById("chatSend");
const btnChatMin=document.getElementById("btnChatMin");

const toastBox=document.getElementById("toast");
const tabs = document.querySelectorAll(".tab");
let currentTab = "home";

/* ---------- UIå·¥å…·å‡½æ•¸ ---------- */
function toast(t){
  toastBox.innerText=t;
  toastBox.style.display="block";
  clearTimeout(toastBox._t);
  toastBox._t=setTimeout(()=>toastBox.style.display="none",1500);
}

function pushLog(msg){
  state.log.unshift({t:Date.now(),msg});
  state.log=state.log.slice(0,50);
}

function updateResUI(){
  document.getElementById("resGold").innerText=fmt(state.resources.gold);
  document.getElementById("resWood").innerText=fmt(state.resources.wood);
  document.getElementById("resStone").innerText=fmt(state.resources.stone);
  document.getElementById("resIron").innerText=fmt(state.resources.iron);
  document.getElementById("resFood").innerText=fmt(state.resources.food);
  document.getElementById("resAeno").innerText=fmt(state.resources.aeno);
}

/* ---------- ã€æ ¸å¿ƒï¼šæ‰€æœ‰é¢æ¿æ‹–æ‹½é‚è¼¯ã€‘ ---------- */
let dragTarget = null;
let dragOffsetX = 0, dragOffsetY = 0;
document.querySelectorAll(".winHead, #panelHeader, #chatHeader").forEach(header => {
  header.onmousedown = (e) => {
    dragTarget = header.closest(".winPanel, #panel, #chatFloat");
    const rect = dragTarget.getBoundingClientRect();
    dragOffsetX = e.clientX - rect.left;
    dragOffsetY = e.clientY - rect.top;
  };
});
// æ‰‹æ©Ÿè§¸æ‘¸æ‹–æ‹½
document.querySelectorAll(".winHead, #panelHeader, #chatHeader").forEach(header => {
  header.ontouchstart = (e) => {
    dragTarget = header.closest(".winPanel, #panel, #chatFloat");
    const rect = dragTarget.getBoundingClientRect();
    dragOffsetX = e.touches[0].clientX - rect.left;
    dragOffsetY = e.touches[0].clientY - rect.top;
  };
});

document.onmousemove = (e) => {
  if(!dragTarget) return;
  dragTarget.style.left = (e.clientX - dragOffsetX) + "px";
  dragTarget.style.top = (e.clientY - dragOffsetY) + "px";
  dragTarget.style.right = "auto";
  dragTarget.style.bottom = "auto";
};
document.ontouchmove = (e) => {
  if(!dragTarget || e.touches.length !== 1) return;
  e.preventDefault();
  dragTarget.style.left = (e.touches[0].clientX - dragOffsetX) + "px";
  dragTarget.style.top = (e.touches[0].clientY - dragOffsetY) + "px";
  dragTarget.style.right = "auto";
  dragTarget.style.bottom = "auto";
};
document.onmouseup = document.ontouchend = () => { dragTarget = null; };

/* ---------- UIæŒ‰éˆ•ç¶å®š ---------- */
btnTogglePanel.onclick=()=>{ panel.classList.toggle("min"); };
btnSave.onclick=saveGame;
btnReset.onclick=resetGame;
btnChatMin.onclick=()=>{
  chatFloat.classList.toggle("min");
  btnChatMin.innerText=chatFloat.classList.contains("min")?"â—‚":"â–¸";
};

// Tabåˆ‡æ›
tabs.forEach(tab => {
  tab.onclick = () => {
    tabs.forEach(t => t.classList.remove("active"));
    tab.classList.add("active");
    currentTab = tab.dataset.tab;
    renderPanel();
  };
});

/* ---------- é ˜åœŸæª¢æŸ¥ ---------- */
function isInsideTerritory(x,y){
  const cx=11, cy=11;
  const dx=x-cx, dy=y-cy;
  return (dx*dx+dy*dy) <= (state.territoryRadius*state.territoryRadius);
}

/* ---------- ç¶“æ¿Ÿç³»çµ± ---------- */
function canAfford(cost){
  if(!cost) return true;
  for(const k in cost){
    if((state.resources[k]||0) < cost[k]) return false;
  }
  return true;
}

function pay(cost){
  for(const k in cost){
    state.resources[k]-=cost[k];
    if(state.resources[k]<0) state.resources[k]=0;
  }
  updateResUI();
}

function tryPayWithGoldOrAeno(extraGold){
  const need=extraGold;
  if(state.resources.gold>=need){
    state.resources.gold-=need;
    updateResUI();
    return true;
  }
  const missing=need-state.resources.gold;
  const aenoNeed=Math.ceil(missing/100);
  if(state.resources.aeno>=aenoNeed){
    state.resources.gold=0;
    state.resources.aeno-=aenoNeed;
    updateResUI();
    return true;
  }
  return false;
}

/* ---------- ã€æ ¸å¿ƒï¼šå»ºç¯‰ç³»çµ±ï¼ˆè£œå…¨æœ¨å» ï¼‰ã€‘ ---------- */
function placeBuilding(type){
  const {x,y}=state.selected;
  if(!isInsideTerritory(x,y)){
    toast("âš ï¸ ä¸åœ¨é ˜åœŸå…§");
    return;
  }
  const tile=state.map[y][x];
  if(tile.building!=="none"){
    toast("âš ï¸ å·²æœ‰å»ºç¯‰");
    return;
  }
  if(!state.tech.unlocked[type]){
    toast("ğŸ”’ æœªè§£é–è©²å»ºç¯‰");
    return;
  }

  const meta=buildingMeta[type];
  if(!meta){toast("å»ºç¯‰æ•¸æ“šéŒ¯èª¤");return;}

  if(!canAfford(meta.cost)){
    toast("è³‡æºä¸è¶³ï¼Œå¯åˆ°äº¤æ˜“æ‰€è³¼è²·");
    return;
  }
  pay(meta.cost);
  tile.building=type;
  tile.level=1;

  pushLog(`å»ºè¨­ï¼š${meta.name} Lv1`);
  toast(`ğŸ— å·²å»ºè¨­${meta.name}`);
  renderPanel();
}

function upgradeBuilding(){
  const {x,y}=state.selected;
  const tile=state.map[y][x];
  if(tile.building==="none"){toast("âš ï¸ å†‡å»ºç¯‰å¯å‡ç´š");return;}
  const lv=tile.level||1;
  if(lv>=5){toast("å·²é”æœ€å¤§ç­‰ç´š");return;}

  const meta=buildingMeta[tile.building];
  const base=meta.cost||{};
  const upCost={};
  for(const k in base){
    upCost[k]=Math.ceil(base[k]*(0.65+lv*0.45));
  }

  if(!canAfford(upCost)){
    toast("å‡ç´šè³‡æºä¸è¶³");
    return;
  }

  pay(upCost);
  tile.level=lv+1;
  pushLog(`å‡ç´šï¼š${meta.name} Lv${tile.level}`);
  toast("â¬†ï¸ å·²å‡ç´š");
  renderPanel();
}

function demolishBuilding(){
  const {x,y}=state.selected;
  const tile=state.map[y][x];
  if(tile.building==="none"){toast("âš ï¸ å†‡å»ºç¯‰å¯æ‹†é™¤");return;}
  pushLog(`æ‹†é™¤ï¼š${buildingMeta[tile.building].name}`);
  tile.building="none";
  tile.level=0;
  toast("ğŸ§¹ å·²æ‹†é™¤");
  renderPanel();
}

function expandTerritory(){
  const r=state.territoryRadius;
  const goldNeed = Math.floor(200 + r*r*120);
  const ok=tryPayWithGoldOrAeno(goldNeed);
  if(!ok){
    toast("é‡‘å¹£ä¸è¶³ï¼ˆå¯ç”¨AENOè£œï¼‰");
    return;
  }
  state.territoryRadius++;
  pushLog(`é ˜åœŸæ“´å¼µï¼šåŠå¾‘ ${state.territoryRadius}`);
  toast("ğŸŒ é ˜åœŸæ“´å¼µæˆåŠŸ");
  renderPanel();
}

/* ---------- äº¤æ˜“æ‰€ç³»çµ± ---------- */
function marketBuy(res,qty){
  qty=Math.max(1,Math.floor(qty));
  const price=state.market.prices[res]||1;
  const cost=qty*price;
  if(state.resources.gold<cost){
    toast("é‡‘å¹£ä¸è¶³");
    return;
  }
  state.resources.gold-=cost;
  state.resources[res]=(state.resources[res]||0)+qty;
  pushLog(`äº¤æ˜“æ‰€è²·å…¥ï¼š${res} x${qty} (-${cost}é‡‘å¹£)`);
  toast("ğŸ›’ å·²è²·å…¥");
  updateResUI();
  renderPanel();
}

function marketSell(res,qty){
  qty=Math.max(1,Math.floor(qty));
  if((state.resources[res]||0)<qty){
    toast("è³‡æºä¸è¶³");
    return;
  }
  const price=state.market.prices[res]||1;
  const gain=Math.floor(qty*price*0.85);
  state.resources[res]-=qty;
  state.resources.gold+=gain;
  pushLog(`äº¤æ˜“æ‰€è³£å‡ºï¼š${res} x${qty} (+${gain}é‡‘å¹£)`);
  toast("ğŸ’° å·²è³£å‡º");
  updateResUI();
  renderPanel();
}

/* ---------- è‚¡å¸‚ç³»çµ± ---------- */
function tickStock(){
  if(!state.stock.lines || state.stock.lines.length===0){
    state.stock.lines=[];
    for(let i=0;i<30;i++){
      state.stock.lines.push({
        wood:state.market.prices.wood,
        stone:state.market.prices.stone,
        iron:state.market.prices.iron,
        food:state.market.prices.food
      });
    }
  }

  const last=state.stock.lines[state.stock.lines.length-1];
  const next={...last};
  for(const k of ["wood","stone","iron","food"]){
    let v=next[k];
    v += rand(-0.6,0.6);
    v = clamp(v, 0.5, 30);
    next[k]=Math.round(v*10)/10;
    state.market.prices[k]=next[k];
  }
  state.stock.lines.push(next);
  state.stock.lines=state.stock.lines.slice(-60);
}

function drawStockChart(){
  const w=panelBody.clientWidth*devicePixelRatio;
  const h=200*devicePixelRatio;
  const canvas=document.createElement("canvas");
  canvas.width=w;
  canvas.height=h;
  canvas.style.width="100%";
  canvas.style.height="200px";
  const sCtx=canvas.getContext("2d");

  if(state.stock.lines.length<2) return canvas;

  const maxPrice=Math.max(...state.stock.lines.map(p=>Math.max(p.wood,p.stone,p.iron,p.food)));
  const minPrice=Math.min(...state.stock.lines.map(p=>Math.min(p.wood,p.stone,p.iron,p.food)));
  const range=maxPrice-minPrice||1;

  const colors={wood:"#3b82f6",food:"#22c55e",stone:"#f59e0b",iron:"#8b5cf6"};
  for(const k in colors){
    sCtx.beginPath();
    sCtx.strokeStyle=colors[k];
    sCtx.lineWidth=2*devicePixelRatio;
    state.stock.lines.forEach((p,i)=>{
      const x=(i/(state.stock.lines.length-1))*w;
      const y=h-((p[k]-minPrice)/range)*(h-30)-15;
      if(i===0) sCtx.moveTo(x,y);
      else sCtx.lineTo(x,y);
    });
    sCtx.stroke();
  }
  return canvas;
}

/* ---------- ç§‘æŠ€æ¨¹ç³»çµ± ---------- */
function gainTechPoints(n){
  state.tech.points += n;
}

function unlockTech(name,cost){
  if(state.tech.points<cost){
    toast("ç§‘æŠ€é»ä¸è¶³");
    return;
  }
  state.tech.points -= cost;
  state.tech.unlocked[name]=true;
  pushLog("ç§‘æŠ€è§£é–ï¼š"+buildingMeta[name].name);
  toast("ğŸ§  å·²è§£é–ç§‘æŠ€");
  renderPanel();
}

/* ---------- å»£å‘Šæ­Œæ›²ç³»çµ± ---------- */
function playAdSong(){
  if(state.ads.cooldown>0){
    toast("å†·å»ä¸­...");
    return;
  }
  state.ads.playing=true;
  state.ads.cooldown=45;
  pushLog("æ’­æ”¾è´ŠåŠ©æ­Œæ›²ä¸­...");
  toast("ğŸµ æ’­æ”¾ä¸­...");
  setTimeout(()=>{
    state.ads.playing=false;
    const reward=irand(60,140);
    state.resources.gold += reward;
    pushLog(`å»£å‘Šæ­Œæ›²å®Œæˆï¼š+${reward} é‡‘å¹£`);
    toast("ğŸ +"+reward+"é‡‘å¹£");
    updateResUI();
    renderPanel();
  }, 2500);
}

/* ---------- æ©Ÿå™¨äººäº‹ä»¶ç³»çµ± ---------- */
function spawnRobot(){
  state.robot.active=true;
  state.robot.x=irand(0,GRID_W-1);
  state.robot.y=irand(0,GRID_H-1);
  state.robot.stealTimer=15;
  pushLog("ğŸ¤– æ©Ÿå™¨äººé™è½ï¼å³å°‡æ å¥ªè³‡æº");
  toast("ğŸ¤– æ©Ÿå™¨äººå…¥ä¾µï¼");
}

function robotSteal(){
  let def=0;
  for(let y=0;y<GRID_H;y++){
    for(let x=0;x<GRID_W;x++){
      const t=state.map[y][x];
      if(t.building==="wall") def += 0.3*(t.level||1);
      if(t.building==="tower") def += 0.6*(t.level||1);
    }
  }
  def=clamp(def,0,10);
  let stealRate=0.20 - def*0.01;
  stealRate=clamp(stealRate,0.05,0.20);

  for(const k of ["wood","stone","iron","food","gold"]){
    const amount=state.resources[k]||0;
    const s=Math.floor(amount*stealRate);
    state.resources[k]-=s;
  }

  pushLog(`ğŸ¤– æ©Ÿå™¨äººæ å¥ªæˆåŠŸï¼šå·èµ° ${Math.floor(stealRate*100)}% è³‡æº`);
  toast("ğŸ’€ è¢«å·èµ°è³‡æº "+Math.floor(stealRate*100)+"%");
  state.robot.active=false;
  updateResUI();
  renderPanel();
}

/* ---------- ç¸æ½®äº‹ä»¶ç³»çµ± ---------- */
function spawnBeastWave(){
  state.beast.active=true;
  state.beast.wave++;
  pushLog("ğŸº ç¸æ½®çˆ†ç™¼ï¼ç¬¬ "+state.beast.wave+" æ³¢");
  toast("ğŸº ç¸æ½®ä¾†è¥²ï¼");
  renderPanel();
}

function resolveBeast(win){
  if(!state.beast.active) return;
  if(win){
    const rewardGold = 200 + state.beast.wave * 100;
    state.resources.gold += rewardGold;
    state.tech.points += 1;
    pushLog(`ğŸº æˆåŠŸæŠµç¦¦ç¬¬ ${state.beast.wave} æ³¢ç¸æ½®ï¼çå‹µ ${rewardGold} é‡‘å¹£ +1 ç§‘æŠ€é»`);
    toast("ğŸ›¡ï¸ æŠµç¦¦æˆåŠŸï¼");
  } else {
    const lossRate = 0.2;
    for(const k of ["wood","stone","iron","food","gold"]){
      state.resources[k] = Math.floor(state.resources[k] * (1 - lossRate));
    }
    pushLog(`âš ï¸ ç¬¬ ${state.beast.wave} æ³¢ç¸æ½®çªç ´é˜²ç·šï¼æå¤± ${lossRate*100}% è³‡æº`);
    toast("ğŸ’€ é˜²ç·šè¢«çªç ´ï¼");
  }
  state.beast.active = false;
  state.beast.timer = 90 + state.beast.wave * 10;
  updateResUI();
  renderPanel();
}

/* ---------- ã€AIåŠ©æ‰‹ç³»çµ±ï¼ˆè‡ªå‹•å»ºæœ¨å» +ç”Ÿå‹•å‹•ç•«ï¼‰ã€‘ ---------- */
chatSend.onclick = () => {
  const text = chatInput.value.trim();
  if(!text) return;
  addChatMsg("me", text);
  chatInput.value = "";
  processAiCommand(text);
};
chatInput.onkeydown = (e) => { if(e.key === "Enter") chatSend.click(); };

function addChatMsg(who, text){
  const div = document.createElement("div");
  div.className = `msg ${who}`;
  div.innerHTML = `<span class="who">${who === "ai" ? "Aenko" : "ä½ "}ï¼š</span>${text}`;
  chatBody.appendChild(div);
  chatBody.scrollTop = chatBody.scrollHeight;
}

function processAiCommand(text){
  const lower = text.toLowerCase();
  let reply = "æˆ‘å””è­˜å‘¢å€‹æŒ‡ä»¤ã—ï¼Œä½ å¯ä»¥è©¦ä¸‹ï¼šè‡ªå‹•å»ºæœ¨å» ã€æ”¶é›†è³‡æºã€å»ºé€ è¾²ç”°ã€å‡ç´šæœ¨å» ã€æ“´å¼µé ˜åœŸ";

  if(lower.includes("è‡ªå‹•å»ºæœ¨å» ") || lower.includes("è‡ªå‹•èµ·æœ¨å» ")){
    let built = false;
    for(let y=0;y<GRID_H;y++){
      for(let x=0;x<GRID_W;x++){
        if(isInsideTerritory(x,y) && state.map[y][x].building === "none" && state.map[y][x].terrain === "forest"){
          state.selected.x = x;
          state.selected.y = y;
          placeBuilding("lum");
          built = true;
          break;
        }
      }
      if(built) break;
    }
    reply = built ? "å·²å¹«ä½ å–ºæ£®æ—æ—é‚Šèµ·å’—æœ¨å» å•¦ï¼Œè€Œå®¶æœƒè‡ªå‹•ç”¢æœ¨æã—ï½" : "å†‡åˆé©å˜…ç©ºåœ°å»ºæœ¨å» ï¼Œè¦å…ˆæ“´å¼µé ˜åœŸï¼Ÿ";
  } else if(lower.includes("å·¡é‚")){
    state.ai.mode = "patrol";
    reply = "æ”¶åˆ°ï¼æˆ‘è€Œå®¶é–‹å§‹å·¡é‚é ˜åœŸï½";
  } else if(lower.includes("æ”¶é›†") || lower.includes("æ”¶è³‡æº")){
    for(let y=0;y<GRID_H;y++){
      for(let x=0;x<GRID_W;x++){
        const tile = state.map[y][x];
        if(tile.building === "none" || tile.level < 1) continue;
        const meta = buildingMeta[tile.building];
        if(!meta.prod) continue;
        for(const k in meta.prod){
          state.resources[k] += meta.prod[k] * tile.level * 10;
        }
      }
    }
    updateResUI();
    reply = "å·²å¹«ä½ æ”¶é›†æ‰€æœ‰å»ºç¯‰å˜…è³‡æºå•¦ï½";
  } else if(lower.includes("å»ºé€ ")){
    const type = lower.replace("å»ºé€ ","").trim();
    const buildMap = {"æœ¨å» ":"lum","è¾²ç”°":"farm","ç¤¦å ´":"mine","å·¥å» ":"factory","åŸç‰†":"wall","å®ˆè¡›å¡”":"tower"};
    const buildType = buildMap[type];
    if(buildType){
      let built = false;
      for(let y=0;y<GRID_H;y++){
        for(let x=0;x<GRID_W;x++){
          if(isInsideTerritory(x,y) && state.map[y][x].building === "none"){
            state.selected.x = x;
            state.selected.y = y;
            placeBuilding(buildType);
            built = true;
            break;
          }
        }
        if(built) break;
      }
      reply = built ? `å·²å¹«ä½ å»ºé€ ${type}å•¦ï½` : "å†‡åˆé©å˜…ç©ºåœ°å»ºé€ ã—ï¼Œè¦å…ˆæ“´å¼µé ˜åœŸï¼Ÿ";
    }
  } else if(lower.includes("å‡ç´š")){
    const type = lower.replace("å‡ç´š","").trim();
    const buildMap = {"æœ¨å» ":"lum","è¾²ç”°":"farm","ç¤¦å ´":"mine","å·¥å» ":"factory","åŸç‰†":"wall","å®ˆè¡›å¡”":"tower"};
    const buildType = buildMap[type];
    if(buildType){
      let upgraded = false;
      for(let y=0;y<GRID_H;y++){
        for(let x=0;x<GRID_W;x++){
          if(state.map[y][x].building === buildType && state.map[y][x].level < 5){
            state.selected.x = x;
            state.selected.y = y;
            upgradeBuilding();
            upgraded = true;
            break;
          }
        }
        if(upgraded) break;
      }
      reply = upgraded ? `å·²å¹«ä½ å‡ç´š${type}å•¦ï½` : "å†‡å¯ä»¥å‡ç´šå˜…å»ºç¯‰ã—ï¼Œè¦å…ˆå»ºé€ ï¼Ÿ";
    }
  } else if(lower.includes("æ“´å¼µ") || lower.includes("é ˜åœŸ")){
    expandTerritory();
    reply = "å·²å¹«ä½ æ“´å¼µé ˜åœŸå•¦ï½";
  }

  setTimeout(() => {
    addChatMsg("ai", reply);
    state.ai.mood = "ğŸ˜Š";
  }, 500);
}

/* ---------- ã€åœ°åœ–æ‹‰æ”¾+æ‹–å‹•ç³»çµ±ã€‘ ---------- */
// åœ°åœ–æ‹–å‹•
let isMapDragging = false;
let mapDragStart = {x:0,y:0};
let cameraStart = {x:0,y:0};

// é›»è…¦æ»‘é¼ æ“ä½œ
cv.onmousedown = (e) => {
  isMapDragging = true;
  mapDragStart.x = e.clientX;
  mapDragStart.y = e.clientY;
  cameraStart.x = state.camera.x;
  cameraStart.y = state.camera.y;
};
cv.onmousemove = (e) => {
  if(!isMapDragging) return;
  const dx = e.clientX - mapDragStart.x;
  const dy = e.clientY - mapDragStart.y;
  state.camera.x = cameraStart.x - dx;
  state.camera.y = cameraStart.y - dy;
};
cv.onmouseup = () => { isMapDragging = false; };
cv.onwheel = (e) => {
  e.preventDefault();
  const delta = e.deltaY > 0 ? 0.9 : 1.1;
  state.camera.targetZoom = clamp(state.camera.targetZoom * delta, 0.3, 3);
};

// æ‰‹æ©Ÿè§¸æ‘¸æ“ä½œï¼ˆå–®æŒ‡æ‹–å‹•ï¼Œé›™æŒ‡ç¸®æ”¾ï¼‰
let lastTouchDistance = 0;
cv.ontouchstart = (e) => {
  if(e.touches.length === 1){
    isMapDragging = true;
    mapDragStart.x = e.touches[0].clientX;
    mapDragStart.y = e.touches[0].clientY;
    cameraStart.x = state.camera.x;
    cameraStart.y = state.camera.y;
    lastTouchDistance = 0;
  } else if(e.touches.length === 2){
    const dx = e.touches[0].clientX - e.touches[1].clientX;
    const dy = e.touches[0].clientY - e.touches[1].clientY;
    lastTouchDistance = Math.sqrt(dx*dx + dy*dy);
  }
};
cv.ontouchmove = (e) => {
  e.preventDefault();
  if(e.touches.length === 1 && isMapDragging){
    const dx = e.touches[0].clientX - mapDragStart.x;
    const dy = e.touches[0].clientY - mapDragStart.y;
    state.camera.x = cameraStart.x - dx;
    state.camera.y = cameraStart.y - dy;
  } else if(e.touches.length === 2){
    const dx = e.touches[0].clientX - e.touches[1].clientX;
    const dy = e.touches[0].clientY - e.touches[1].clientY;
    const distance = Math.sqrt(dx*dx + dy*dy);
    if(lastTouchDistance > 0){
      const delta = distance / lastTouchDistance;
      state.camera.targetZoom = clamp(state.camera.targetZoom * delta, 0.3, 3);
    }
    lastTouchDistance = distance;
  }
};
cv.ontouchend = (e) => {
  if(e.touches.length === 0){
    isMapDragging = false;
    lastTouchDistance = 0;
  }
};

// åœ°åœ–é»æ“Šé¸ä¸­åœ°å¡Š
cv.onclick = (e) => {
  if(isMapDragging) return;
  const rect = cv.getBoundingClientRect();
  const mx = e.clientX - rect.left;
  const my = e.clientY - rect.top;
  const zoom = state.camera.zoom;
  const ox = (mx - cv.width/2/devicePixelRatio)/zoom + state.camera.x/zoom;
  const oy = (my - cv.height/2/devicePixelRatio)/zoom + state.camera.y/zoom;
  const gx = Math.floor((ox / TILE + oy / (TILE/2)) / 2);
  const gy = Math.floor((oy / (TILE/2) - ox / TILE) / 2);
  if(gx >=0 && gx < GRID_W && gy >=0 && gy < GRID_H){
    state.selected.x = gx;
    state.selected.y = gy;
    renderPanel();
  }
};

/* ---------- ã€åœ°åœ–æ¸²æŸ“ï¼ˆ3Dç­‰è§’+AIå°å‹•ç‰©ï¼‰ã€‘ ---------- */
function renderMap(){
  const w=cv.width/devicePixelRatio;
  const h=cv.height/devicePixelRatio;
  ctx.clearRect(0,0,w,h);

  // ç›¸æ©Ÿç¸®æ”¾å¹³æ»‘éæ¸¡
  state.camera.zoom += (state.camera.targetZoom - state.camera.zoom) * 0.1;
  const zoom = state.camera.zoom;
  ctx.save();
  ctx.translate(w/2, h/2);
  ctx.scale(zoom, zoom);
  ctx.translate(-state.camera.x, -state.camera.y);

  const centerX=0;
  const centerY=0;

  // ç¹ªè£½åœ°åœ–
  for(let y=0;y<GRID_H;y++){
    for(let x=0;x<GRID_W;x++){
      const tile = state.map[y][x];
      const sx = centerX + (x * TILE + y * TILE/2);
      const sy = centerY + (y * TILE/2);

      // ç¹ªè£½åœ°å½¢
      ctx.fillStyle = terrainColor[tile.terrain];
      ctx.beginPath();
      ctx.moveTo(sx, sy);
      ctx.lineTo(sx + TILE/2, sy - TILE/4);
      ctx.lineTo(sx + TILE, sy);
      ctx.lineTo(sx + TILE/2, sy + TILE/4);
      ctx.closePath();
      ctx.fill();

      // é ˜åœŸé‚Šç•Œæ¨™è¨˜
      if(isInsideTerritory(x,y)){
        ctx.strokeStyle = "#3b82f6";
        ctx.lineWidth = 1;
        ctx.stroke();
      }

      // ç¹ªè£½å»ºç¯‰ï¼ˆ3Dç«‹é«”ï¼‰
      const bType = tile.building;
      const bLv = tile.level || 1;
      if(bType !== "none"){
        const height = bLv * 12;
        // å»ºç¯‰é ‚é¢
        ctx.fillStyle = bType === "town" ? "#3b82f6" : bType === "lum" ? "#a0522d" : bType === "farm" ? "#22c55e" : bType === "mine" ? "#94a3b8" : bType === "factory" ? "#8b5cf6" : bType === "wall" ? "#64748b" : "#f59e0b";
        ctx.beginPath();
        ctx.moveTo(sx, sy - height);
        ctx.lineTo(sx + TILE/2, sy - TILE/4 - height);
        ctx.lineTo(sx + TILE, sy - height);
        ctx.lineTo(sx + TILE/2, sy + TILE/4 - height);
        ctx.closePath();
        ctx.fill();
        // å»ºç¯‰å´é¢é™°å½±
        ctx.fillStyle = "rgba(0,0,0,0.25)";
        ctx.beginPath();
        ctx.moveTo(sx + TILE, sy - height);
        ctx.lineTo(sx + TILE/2, sy + TILE/4 - height);
        ctx.lineTo(sx + TILE/2, sy + TILE/4);
        ctx.lineTo(sx + TILE, sy);
        ctx.closePath();
        ctx.fill();
      }
    }
  }

  // ç¹ªè£½é¸ä¸­æ¡†
  const {x:selX,y:selY} = state.selected;
  const selSx = centerX + (selX * TILE + selY * TILE/2);
  const selSy = centerY + (selY * TILE/2);
  ctx.strokeStyle = "#ef4444";
  ctx.lineWidth = 3;
  ctx.beginPath();
  ctx.moveTo(selSx, selSy);
  ctx.lineTo(selSx + TILE/2, selSy - TILE/4);
  ctx.lineTo(selSx + TILE, selSy);
  ctx.lineTo(selSx + TILE/2, selSy + TILE/4);
  ctx.closePath();
  ctx.stroke();

  // ã€ç”Ÿå‹•AIå°å‹•ç‰©ï¼šå°æŸ´çŠ¬ã€‘
  const ai = state.ai;
  const aiSx = centerX + (ai.x * TILE + ai.y * TILE/2) + TILE/2;
  const aiSy = centerY + (ai.y * TILE/2);
  // å¹³æ»‘ç§»å‹•
  ai.px += (aiSx - ai.px) * 0.1;
  ai.py += (aiSy - ai.py) * 0.1;

  // å‹•ç•«è¨ˆæ™‚å™¨
  ai.blinkTimer++;
  ai.tailWagTimer++;
  const blink = ai.blinkTimer % 60 < 5;
  const tailWag = Math.sin(ai.tailWagTimer * 0.2) * 8;

  // èº«é«”
  ctx.fillStyle = "#f59e0b";
  ctx.beginPath();
  ctx.ellipse(ai.px, ai.py - 10, 15, 12, 0, 0, Math.PI*2);
  ctx.fill();
  // é ­
  ctx.fillStyle = "#f59e0b";
  ctx.beginPath();
  ctx.arc(ai.px, ai.py - 28, 14, 0, Math.PI*2);
  ctx.fill();
  // è€³æœµ
  ctx.fillStyle = "#d97706";
  ctx.beginPath();
  ctx.moveTo(ai.px - 10, ai.py - 38);
  ctx.lineTo(ai.px - 14, ai.py - 28);
  ctx.lineTo(ai.px - 6, ai.py - 30);
  ctx.closePath();
  ctx.fill();
  ctx.beginPath();
  ctx.moveTo(ai.px + 10, ai.py - 38);
  ctx.lineTo(ai.px + 14, ai.py - 28);
  ctx.lineTo(ai.px + 6, ai.py - 30);
  ctx.closePath();
  ctx.fill();
  // çœ¼ç›
  ctx.fillStyle = "#000";
  if(blink){
    ctx.fillRect(ai.px - 5, ai.py - 30, 4, 1);
    ctx.fillRect(ai.px + 1, ai.py - 30, 4, 1);
  } else {
    ctx.beginPath();
    ctx.arc(ai.px - 3, ai.py - 30, 2, 0, Math.PI*2);
    ctx.arc(ai.px + 3, ai.py - 30, 2, 0, Math.PI*2);
    ctx.fill();
  }
  // é¼»å­
  ctx.fillStyle = "#000";
  ctx.beginPath();
  ctx.arc(ai.px, ai.py - 25, 2, 0, Math.PI*2);
  ctx.fill();
  // å°¾å·´
  ctx.fillStyle = "#d97706";
  ctx.beginPath();
  ctx.moveTo(ai.px + 12, ai.py - 10);
  ctx.quadraticCurveTo(ai.px + 20 + tailWag, ai.py - 15, ai.px + 18 + tailWag, ai.py - 5);
  ctx.quadraticCurveTo(ai.px + 15 + tailWag, ai.py - 2, ai.px + 12, ai.py - 10);
  ctx.closePath();
  ctx.fill();

  ctx.restore();
}

/* ---------- é¢æ¿æ¸²æŸ“ ---------- */
function renderPanel(){
  panelBody.innerHTML = "";
  const tile = state.map[state.selected.y][state.selected.x];
  const bMeta = buildingMeta[tile.building];

  switch(currentTab){
    case "home":
      panelBody.innerHTML = `
        <div class="card">
          <div class="label">ç•¶å‰è³‡æº</div>
          <div class="row">
            <div class="big">ğŸ’° ${fmt(state.resources.gold)} é‡‘å¹£</div>
            <div class="big">ğŸŸ£ ${fmt(state.resources.aeno)} AENOå¹£</div>
          </div>
          <div class="row">
            <div>ğŸªµ ${fmt(state.resources.wood)} æœ¨æ</div>
            <div>ğŸª¨ ${fmt(state.resources.stone)} çŸ³æ</div>
            <div>âš™ï¸ ${fmt(state.resources.iron)} éµç¤¦</div>
            <div>ğŸŒ¾ ${fmt(state.resources.food)} ç³§é£Ÿ</div>
          </div>
        </div>
        <div class="card">
          <div class="label">å¸åœ‹ç‹€æ…‹</div>
          <div class="row">
            <div>é ˜åœŸåŠå¾‘ï¼š${state.territoryRadius}</div>
            <div>ç¸æ½®æ³¢æ•¸ï¼š${state.beast.wave}</div>
          </div>
          <div class="row">
            <div>ç§‘æŠ€é»ï¼š${state.tech.points}</div>
            <div>ä¸‹ä¸€æ³¢ç¸æ½®ï¼š${state.beast.timer}s</div>
          </div>
          <button class="btn" onclick="expandTerritory()">ğŸŒ æ“´å¼µé ˜åœŸ</button>
        </div>
        <div class="card">
          <div class="label">æœ€è¿‘æ—¥èªŒ</div>
          <div style="font-size:11px;color:var(--muted);max-height:120px;overflow:auto;">
            ${state.log.map(l=>`<div>â€¢ ${l.msg}</div>`).join("")}
          </div>
        </div>
      `;
      break;
    case "build":
      panelBody.innerHTML = `
        <div class="card">
          <div class="label">é¸ä¸­åœ°å¡Š</div>
          <div>åœ°å½¢ï¼š${tile.terrain}</div>
          <div>å»ºç¯‰ï¼š${bMeta.name} ${tile.level>0?`Lv.${tile.level}`:""}</div>
          <div>æ˜¯å¦åœ¨é ˜åœŸå…§ï¼š${isInsideTerritory(state.selected.x,state.selected.y)?"âœ… æ˜¯":"âŒ å¦"}</div>
        </div>
        <div class="card">
          <div class="label">å»ºé€ å»ºç¯‰</div>
          <div class="row">
            <button class="btn brown" onclick="placeBuilding('lum')">ğŸªµ æœ¨å» </button>
            <button class="btn green" onclick="placeBuilding('farm')">ğŸŒ¾ è¾²ç”°</button>
          </div>
          <div class="row">
            <button class="btn" onclick="placeBuilding('mine')">â›ï¸ ç¤¦å ´</button>
            <button class="btn purple" onclick="placeBuilding('factory')" ${!state.tech.unlocked.factory?"disabled":""}>ğŸ­ å·¥å»  ${!state.tech.unlocked.factory?"ğŸ”’":""}</button>
          </div>
          <div class="row">
            <button class="btn gray" onclick="placeBuilding('wall')" ${!state.tech.unlocked.wall?"disabled":""}>ğŸ§± åŸç‰† ${!state.tech.unlocked.wall?"ğŸ”’":""}</button>
            <button class="btn gold" onclick="placeBuilding('tower')" ${!state.tech.unlocked.tower?"disabled":""}>ğŸ—¼ å®ˆè¡›å¡” ${!state.tech.unlocked.tower?"ğŸ”’":""}</button>
          </div>
        </div>
        <div class="card">
          <div class="label">å»ºç¯‰æ“ä½œ</div>
          <div class="row">
            <button class="btn green" onclick="upgradeBuilding()" ${tile.building==="none"?"disabled":""}>â¬†ï¸ å‡ç´šå»ºç¯‰</button>
            <button class="btn red" onclick="demolishBuilding()" ${tile.building==="none"?"disabled":""}>ğŸ§¨ æ‹†é™¤å»ºç¯‰</button>
          </div>
        </div>
      `;
      break;
    case "market":
      panelBody.innerHTML = `
        <div class="card">
          <div class="label">ç•¶å‰åƒ¹æ ¼</div>
          <div class="row">
            <div>ğŸªµ æœ¨æï¼š${state.market.prices.wood} é‡‘å¹£</div>
            <div>ğŸŒ¾ ç³§é£Ÿï¼š${state.market.prices.food} é‡‘å¹£</div>
          </div>
          <div class="row">
            <div>ğŸª¨ çŸ³æï¼š${state.market.prices.stone} é‡‘å¹£</div>
            <div>âš™ï¸ éµç¤¦ï¼š${state.market.prices.iron} é‡‘å¹£</div>
          </div>
        </div>
        <div class="card">
          <div class="label">æœ¨æäº¤æ˜“</div>
          <div class="row">
            <button class="btn" onclick="marketBuy('wood',10)">è²·å…¥ Ã—10</button>
            <button class="btn gray" onclick="marketSell('wood',10)">è³£å‡º Ã—10</button>
          </div>
        </div>
        <div class="card">
          <div class="label">ç³§é£Ÿäº¤æ˜“</div>
          <div class="row">
            <button class="btn" onclick="marketBuy('food',10)">è²·å…¥ Ã—10</button>
            <button class="btn gray" onclick="marketSell('food',10)">è³£å‡º Ã—10</button>
          </div>
        </div>
        <div class="card">
          <div class="label">çŸ³æäº¤æ˜“</div>
          <div class="row">
            <button class="btn" onclick="marketBuy('stone',10)">è²·å…¥ Ã—10</button>
            <button class="btn gray" onclick="marketSell('stone',10)">è³£å‡º Ã—10</button>
          </div>
        </div>
        <div class="card">
          <div class="label">éµç¤¦äº¤æ˜“</div>
          <div class="row">
            <button class="btn" onclick="marketBuy('iron',10)">è²·å…¥ Ã—10</button>
            <button class="btn gray" onclick="marketSell('iron',10)">è³£å‡º Ã—10</button>
          </div>
        </div>
      `;
      break;
    case "stock":
      panelBody.innerHTML = `
        <div class="card">
          <div class="label">è³‡æºåƒ¹æ ¼èµ°å‹¢</div>
          <div id="stockChartWrap"></div>
          <div style="font-size:11px;color:var(--muted);margin-top:8px;">
            <span style="color:#3b82f6;">â–  æœ¨æ</span>
            <span style="color:#22c55e;margin-left:10px;">â–  ç³§é£Ÿ</span>
            <span style="color:#f59e0b;margin-left:10px;">â–  çŸ³æ</span>
            <span style="color:#8b5cf6;margin-left:10px;">â–  éµç¤¦</span>
          </div>
        </div>
      `;
      const chart=drawStockChart();
      if(chart) document.getElementById("stockChartWrap").appendChild(chart);
      break;
    case "tech":
      panelBody.innerHTML = `
        <div class="card">
          <div class="label">ç§‘æŠ€é»æ•¸ï¼š${state.tech.points}</div>
        </div>
        <div class="card">
          <div class="label">å¯è§£é–ç§‘æŠ€</div>
          <div class="row">
            <button class="btn purple" onclick="unlockTech('factory',3)" ${state.tech.unlocked.factory?"disabled":""}>ğŸ­ å·¥å» ç§‘æŠ€ ${state.tech.unlocked.factory?"âœ… å·²è§£é–":"(3é»)"}</button>
          </div>
          <div class="row">
            <button class="btn gray" onclick="unlockTech('wall',2)" ${state.tech.unlocked.wall?"disabled":""}>ğŸ§± åŸç‰†ç§‘æŠ€ ${state.tech.unlocked.wall?"âœ… å·²è§£é–":"(2é»)"}</button>
            <button class="btn gold" onclick="unlockTech('tower',4)" ${state.tech.unlocked.tower?"disabled":""}>ğŸ—¼ å®ˆè¡›å¡”ç§‘æŠ€ ${state.tech.unlocked.tower?"âœ… å·²è§£é–":"(4é»)"}</button>
          </div>
        </div>
      `;
      break;
    case "event":
      panelBody.innerHTML = `
        <div class="card">
          <div class="label">ç•¶å‰äº‹ä»¶</div>
          ${state.beast.active?`
            <div style="color:var(--danger);font-weight:bold;">ğŸº ç¸æ½®ä¾†è¥²ï¼</div>
            <div class="row">
              <button class="btn green" onclick="resolveBeast(true)">ğŸ›¡ï¸ æŠµç¦¦</button>
              <button class="btn red" onclick="resolveBeast(false)">ğŸƒ æ”¾æ£„</button>
            </div>
          `:`<div>æš«ç„¡ç·Šæ€¥äº‹ä»¶</div>`}
          ${state.robot.active?`
            <div style="color:var(--danger);font-weight:bold;margin-top:10px;">ğŸ¤– æ©Ÿå™¨äººå…¥ä¾µï¼</div>
            <div>å°‡åœ¨${state.robot.stealTimer}ç§’å¾Œå·å–è³‡æº</div>
            <button class="btn red" onclick="robotSteal()">ğŸ’¥ ç«‹å³è™•ç†</button>
          `:""}
        </div>
        <div class="card">
          <div class="label">äº‹ä»¶è¨ˆæ™‚</div>
          <div>ä¸‹ä¸€æ³¢ç¸æ½®ï¼š${state.beast.timer} ç§’</div>
          <div>å»£å‘Šå†·å»ï¼š${state.ads.cooldown} ç§’</div>
        </div>
      `;
      break;
    case "ads":
      panelBody.innerHTML = `
        <div class="card">
          <div class="label">å»£å‘Šæ­Œæ›²</div>
          <div>æ’­æ”¾å»£å‘Šæ­Œæ›²ç²å¾—é‡‘å¹£çå‹µ</div>
          <div>å†·å»æ™‚é–“ï¼š${state.ads.cooldown} ç§’</div>
          <button class="btn gold" onclick="playAdSong()" ${state.ads.cooldown>0?"disabled":""}>ğŸµ æ’­æ”¾å»£å‘Šæ­Œæ›²</button>
        </div>
        <div class="card">
          <div class="label">AIå»£å‘Šè¨­ç½®</div>
          <div>ç•¶å‰å»£å‘Šèªï¼š${state.ai.adText}</div>
          <input type="text" id="adTextInput" placeholder="è¼¸å…¥æ–°çš„å»£å‘Šèª" value="${state.ai.adText}" />
          <button class="btn" style="margin-top:8px;" onclick="state.ai.adText=document.getElementById('adTextInput').value;toast('âœ… å·²æ›´æ–°')">æ›´æ–°å»£å‘Šèª</button>
        </div>
      `;
      break;
  }
}

/* ---------- é›¢ç·šæ”¶ç›Šè¨ˆç®— ---------- */
function calculateOfflineGain(){
  const nowTime = now();
  const delta = (nowTime - state.lastTick) / 1000;
  if(delta < 1) return;
  const maxDelta = 8 * 3600;
  const realDelta = Math.min(delta, maxDelta);

  let totalGain = {gold:0, wood:0, stone:0, iron:0, food:0};
  for(let y=0;y<GRID_H;y++){
    for(let x=0;x<GRID_W;x++){
      const tile = state.map[y][x];
      if(tile.building === "none" || tile.level < 1) continue;
      const meta = buildingMeta[tile.building];
      if(!meta.prod) continue;
      for(const k in meta.prod){
        totalGain[k] += meta.prod[k] * tile.level * (realDelta / 60);
      }
    }
  }

  for(const k in totalGain){
    state.resources[k] += Math.floor(totalGain[k]);
  }

  pushLog(`ğŸ“´ é›¢ç·š ${Math.floor(realDelta/60)} åˆ†é˜ï¼Œç²å¾—é›¢ç·šæ”¶ç›Š`);
  state.lastTick = nowTime;
  updateResUI();
}

/* ---------- éŠæˆ²ä¸»å¾ªç’° ---------- */
let gameTick=0;
function gameLoop(){
  gameTick++;
  state.lastTick = now();

  // æ¯ç§’åŸ·è¡Œ
  if(gameTick % 60 === 0){
    // ã€æ ¸å¿ƒï¼šæœ¨å» è‡ªå‹•ç”¢æœ¨æã€‘å»ºç¯‰è³‡æºç”Ÿç”¢
    for(let y=0;y<GRID_H;y++){
      for(let x=0;x<GRID_W;x++){
        const tile = state.map[y][x];
        if(tile.building === "none" || tile.level < 1) continue;
        const meta = buildingMeta[tile.building];
        if(!meta.prod) continue;
        for(const k in meta.prod){
          state.resources[k] += meta.prod[k] * tile.level;
        }
      }
    }
    // è¨ˆæ™‚å™¨éæ¸›
    if(state.beast.timer > 0) state.beast.timer--;
    if(state.ads.cooldown > 0) state.ads.cooldown--;
    if(state.robot.active && state.robot.stealTimer > 0) state.robot.stealTimer--;

    // AIå·¡é‚
    if(state.ai.mode === "patrol"){
      state.ai.x = clamp(state.ai.x + (Math.random()>0.5?1:-1), 0, GRID_W-1);
      state.ai.y = clamp(state.ai.y + (Math.random()>0.5?1:-1), 0, GRID_H-1);
    }

    updateResUI();
  }

  // æ¯3ç§’æ›´æ–°è‚¡å¸‚
  if(gameTick % 180 === 0) tickStock();

  // äº‹ä»¶è§¸ç™¼
  if(state.beast.timer <= 0 && !state.beast.active) spawnBeastWave();
  if(gameTick % 750 === 0 && !state.robot.active) spawnRobot();
  if(state.robot.active && state.robot.stealTimer <= 0) robotSteal();

  // ç•«é¢æ¸²æŸ“
  renderMap();
  requestAnimationFrame(gameLoop);
}

/* ---------- éŠæˆ²åˆå§‹åŒ– ---------- */
window.addEventListener("load",()=>{
  calculateOfflineGain();
  renderPanel();
  addChatMsg("ai", "ä½ å¥½å‘€ï¼æˆ‘ä¿‚Aenkoï¼Œæœ‰å’©å¯ä»¥å¹«ä½ ï¼Ÿè¼¸å…¥ã€Œè‡ªå‹•å»ºæœ¨å» ã€å°±å¯ä»¥è‡ªå‹•èµ·æœ¨å» å•¦ï½");
  gameLoop();
});

// è‡ªå‹•å­˜æª”
setInterval(saveGame, 30000);
</script>
</body>
</html>
