<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
<title>AENO V3 - Cartoon Empire (Vertical)</title>
<style>
  :root{
    --bg:#eaf7ff;
    --panel:#ffffffee;
    --panel2:#f8fbff;
    --border:#cfe8ff;
    --text:#0f172a;
    --muted:#64748b;
    --accent:#3b82f6;
    --accent2:#22c55e;
    --danger:#ef4444;
    --gold:#f59e0b;
    --aeno:#8b5cf6;
  }
  *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans HK","PingFang HK","Microsoft JhengHei",sans-serif;}
  body{
    margin:0;
    background:linear-gradient(#eaf7ff,#f8fbff);
    overflow:hidden;
    touch-action:none;
  }
  #wrap{
    width:100vw;height:100vh;
    display:flex;justify-content:center;align-items:center;
  }
  #game{
    position:relative;
    width:min(460px,100vw);
    height:100vh;
    max-height:980px;
    background:linear-gradient(#eaf7ff,#f7fbff);
    border-left:1px solid #dbeafe;
    border-right:1px solid #dbeafe;
    overflow:hidden;
  }

  canvas{
    width:100%;
    height:100%;
    display:block;
    background:linear-gradient(#eaf7ff,#f7fbff);
  }

  /* TOP BAR */
  #topbar{
    position:absolute;top:0;left:0;right:0;
    padding:10px 10px 8px 10px;
    display:flex;gap:8px;align-items:center;
    z-index:50;
    background:linear-gradient(#ffffffdd,#ffffff00);
    backdrop-filter: blur(6px);
  }
  .chip{
    padding:8px 10px;
    border-radius:14px;
    background:#ffffffdd;
    border:1px solid var(--border);
    font-size:12px;
    color:var(--text);
    box-shadow:0 6px 14px rgba(0,0,0,0.06);
    display:flex;align-items:center;gap:6px;
    user-select:none;
    cursor:pointer;
  }
  .chip b{font-size:12px;}
  .chip .dot{
    width:8px;height:8px;border-radius:999px;background:var(--accent);
  }

  /* MAIN PANEL */
  #panel{
    position:absolute;
    left:10px; right:10px;
    bottom:10px;
    height:52%;
    border-radius:22px;
    background:var(--panel);
    border:1px solid var(--border);
    box-shadow:0 18px 50px rgba(0,0,0,0.12);
    z-index:80;
    overflow:hidden;
    transition: transform .25s ease;
  }
  #panel.min{
    transform: translateY(calc(100% - 64px));
  }

  #panelHeader{
    height:64px;
    padding:10px 12px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    background:linear-gradient(#ffffff,#f1f8ff);
    border-bottom:1px solid #dbeafe;
  }
  #panelTitle{
    display:flex;flex-direction:column;
    gap:2px;
  }
  #panelTitle .t{
    font-weight:900;
    font-size:14px;
    color:var(--text);
    letter-spacing:0.3px;
  }
  #panelTitle .s{
    font-size:11px;color:var(--muted);
  }

  #panelTabs{
    display:flex;gap:6px;flex-wrap:wrap;
    justify-content:flex-end;
  }
  .tab{
    font-size:11px;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid #dbeafe;
    background:#fff;
    color:#0f172a;
    cursor:pointer;
    user-select:none;
  }
  .tab.active{
    background:var(--accent);
    border-color:var(--accent);
    color:white;
    font-weight:700;
  }

  #panelBody{
    height:calc(100% - 64px);
    overflow:auto;
    padding:10px;
    background:linear-gradient(#ffffff,#f8fbff);
  }

  .card{
    background:#ffffff;
    border:1px solid #e2f0ff;
    border-radius:18px;
    padding:12px;
    box-shadow:0 10px 24px rgba(0,0,0,0.06);
    margin-bottom:10px;
  }
  .row{display:flex;gap:8px;flex-wrap:wrap;}
  .btn{
    border:none;
    padding:10px 12px;
    border-radius:14px;
    background:var(--accent);
    color:white;
    font-weight:800;
    cursor:pointer;
    user-select:none;
    box-shadow:0 10px 20px rgba(59,130,246,0.25);
    font-size:12px;
  }
  .btn.gray{
    background:#e2e8f0;color:#0f172a;
    box-shadow:none;
    border:1px solid #cbd5e1;
  }
  .btn.green{
    background:var(--accent2);
    box-shadow:0 10px 20px rgba(34,197,94,0.25);
  }
  .btn.gold{
    background:var(--gold);
    box-shadow:0 10px 20px rgba(245,158,11,0.25);
  }
  .btn.purple{
    background:var(--aeno);
    box-shadow:0 10px 20px rgba(139,92,246,0.25);
  }
  .btn.red{
    background:var(--danger);
    box-shadow:0 10px 20px rgba(239,68,68,0.25);
  }
  .label{
    font-size:12px;color:var(--muted);
    margin-bottom:6px;
  }
  .big{
    font-size:14px;font-weight:900;color:var(--text);
  }
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace;}
  input,select{
    width:100%;
    padding:10px;
    border-radius:14px;
    border:1px solid #dbeafe;
    background:#f8fbff;
    font-size:13px;
  }

  /* AI CHAT FLOAT */
  #chatFloat{
    position:absolute;
    right:12px;
    top:86px;
    width:220px;
    border-radius:18px;
    border:1px solid #dbeafe;
    background:#ffffffdd;
    backdrop-filter: blur(6px);
    box-shadow:0 12px 26px rgba(0,0,0,0.12);
    z-index:70;
    overflow:hidden;
    transition: transform .25s ease;
  }
  #chatFloat.min{
    transform: translateX(170px);
  }
  #chatHeader{
    padding:8px 10px;
    background:linear-gradient(#ffffff,#f1f8ff);
    border-bottom:1px solid #dbeafe;
    display:flex;align-items:center;justify-content:space-between;
    font-weight:900;font-size:12px;color:var(--text);
  }
  #chatBody{
    height:150px;
    overflow:auto;
    padding:8px;
    font-size:12px;
    color:#0f172a;
  }
  .msg{margin-bottom:8px;line-height:1.35;}
  .msg .who{font-weight:900;}
  .msg.ai .who{color:#2563eb;}
  .msg.me .who{color:#16a34a;}
  #chatInputWrap{
    display:flex;gap:6px;padding:8px;border-top:1px solid #dbeafe;
    background:#ffffff;
  }
  #chatInputWrap input{
    flex:1;
    padding:9px;
    border-radius:12px;
    font-size:12px;
  }
  #chatInputWrap button{
    padding:9px 10px;border-radius:12px;border:none;
    background:#2563eb;color:white;font-weight:900;font-size:12px;
  }

  /* SMALL INFO */
  #toast{
    position:absolute;
    left:50%;
    transform:translateX(-50%);
    top:62px;
    background:#0f172acc;
    color:white;
    font-size:12px;
    padding:8px 12px;
    border-radius:999px;
    z-index:200;
    display:none;
  }
</style>
</head>
<body>
<div id="wrap">
  <div id="game">
    <div id="topbar">
      <div class="chip" id="btnTogglePanel"><span class="dot"></span><b>å¸åœ‹é¢æ¿</b></div>
      <div class="chip" id="btnSave"><b>å­˜æª”</b></div>
      <div class="chip" id="btnReset"><b>é‡ç½®</b></div>
    </div>

    <div id="toast"></div>

    <canvas id="cv"></canvas>

    <!-- AI Chat -->
    <div id="chatFloat">
      <div id="chatHeader">
        <span>ğŸ¾ AIåŠ©æ‰‹ - Aenko</span>
        <span style="cursor:pointer;" id="btnChatMin">â–¸</span>
      </div>
      <div id="chatBody"></div>
      <div id="chatInputWrap">
        <input id="chatInput" placeholder="è¼¸å…¥ï¼šå·¡é‚ / æ”¶é›† / å»ºé€  è¾²ç”° / å‡ç´š å·¥å» ..." />
        <button id="chatSend">é€å‡º</button>
      </div>
    </div>

    <!-- BIG PANEL -->
    <div id="panel" class="min">
      <div id="panelHeader">
        <div id="panelTitle">
          <div class="t">AENO å¸åœ‹æ§åˆ¶ä¸­å¿ƒ</div>
          <div class="s">è³‡æºãƒ»å»ºè¨­ãƒ»äº¤æ˜“æ‰€ãƒ»ç§‘æŠ€æ¨¹ãƒ»ç¸æ½®ãƒ»å»£å‘Šæ­Œãƒ»æ©Ÿå™¨äººäº‹ä»¶</div>
        </div>
        <div id="panelTabs">
          <div class="tab active" data-tab="home">ç¸½è¦½</div>
          <div class="tab" data-tab="build">å»ºè¨­</div>
          <div class="tab" data-tab="market">äº¤æ˜“æ‰€</div>
          <div class="tab" data-tab="stock">è‚¡å¸‚</div>
          <div class="tab" data-tab="tech">ç§‘æŠ€æ¨¹</div>
          <div class="tab" data-tab="event">äº‹ä»¶</div>
          <div class="tab" data-tab="ads">å»£å‘Š/æ­Œæ›²</div>
        </div>
      </div>
      <div id="panelBody"></div>
    </div>
  </div>
</div>

<script>
/* ===========================
   AENO V3 (Single File Demo)
   =========================== */

/* ---------- Helpers ---------- */
function clamp(v,a,b){return Math.max(a,Math.min(b,v));}
function rand(a,b){return a+Math.random()*(b-a);}
function irand(a,b){return Math.floor(rand(a,b+1));}

function now(){return Date.now();}
function fmt(n){
  if(n>=1e9) return (n/1e9).toFixed(2)+"B";
  if(n>=1e6) return (n/1e6).toFixed(2)+"M";
  if(n>=1e3) return (n/1e3).toFixed(2)+"K";
  return Math.floor(n).toString();
}

/* --- safe rounded rect --- */
function roundRectPath(ctx,x,y,w,h,r){
  r=Math.min(r,w/2,h/2);
  ctx.beginPath();
  ctx.moveTo(x+r,y);
  ctx.lineTo(x+w-r,y);
  ctx.quadraticCurveTo(x+w,y,x+w,y+r);
  ctx.lineTo(x+w,y+h-r);
  ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);
  ctx.lineTo(x+r,y+h);
  ctx.quadraticCurveTo(x,y+h,x,y+h-r);
  ctx.lineTo(x,y+r);
  ctx.quadraticCurveTo(x,y,x+r,y);
  ctx.closePath();
}

/* ---------- Canvas Setup ---------- */
const cv=document.getElementById("cv");
const ctx=cv.getContext("2d");

function resize(){
  const rect=cv.getBoundingClientRect();
  cv.width=Math.floor(rect.width*devicePixelRatio);
  cv.height=Math.floor(rect.height*devicePixelRatio);
  ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
}
window.addEventListener("resize",resize);

/* ---------- World Config ---------- */
const TILE=64;
const GRID_W=22;
const GRID_H=22;

const terrainTypes=["grass","forest","mountain","river","ore","plain"];
const buildingTypes=["none","farm","mine","factory","wall","tower","town"];

const terrainColor={
  grass:"#b9fbc0",
  forest:"#4ade80",
  mountain:"#94a3b8",
  river:"#60a5fa",
  ore:"#fbbf24",
  plain:"#dcfce7"
};

const buildingMeta={
  none:{name:"ç©ºåœ°"},
  farm:{name:"è¾²ç”°",cost:{wood:30,stone:10,gold:60},prod:{food:4}},
  mine:{name:"ç¤¦å ´",cost:{wood:25,stone:35,gold:90},prod:{stone:2,iron:2}},
  factory:{name:"å·¥å» ",cost:{wood:60,stone:60,iron:40,gold:200},prod:{gold:5}},
  wall:{name:"åŸç‰†",cost:{stone:80,gold:120},def:2},
  tower:{name:"å®ˆè¡›å¡”",cost:{wood:40,stone:80,iron:30,gold:160},def:5},
  town:{name:"åŸé®",cost:{wood:120,stone:120,iron:80,gold:600},prod:{gold:12},def:3}
};

/* ---------- Save / Load ---------- */
const SAVE_KEY="AENO_V3_SAVE_1";

function defaultState(){
  const map=[];
  for(let y=0;y<GRID_H;y++){
    const row=[];
    for(let x=0;x<GRID_W;x++){
      const t=genTerrain(x,y);
      row.push({
        terrain:t,
        building:"none",
        level:0
      });
    }
    map.push(row);
  }

  // start base
  map[11][11].building="town";
  map[11][11].level=1;

  return {
    ver:3,
    lastTick:now(),
    camera:{x:0,y:0,zoom:1},
    selected:{x:11,y:11},
    resources:{
      gold:500,
      aeno:50,
      wood:120,
      stone:80,
      iron:40,
      food:120
    },
    territoryRadius:4,
    map,
    ai:{
      name:"Aenko",
      x:11,y:11,
      px:0,py:0,
      mood:"ğŸ™‚",
      mode:"idle",
      adText:"AENO MUSIC",
      lastSpeak:0
    },
    robot:{
      active:false,
      x:0,y:0,
      stealTimer:0,
      adText:"AD"
    },
    beast:{
      timer: 90,
      wave:0,
      active:false
    },
    market:{
      prices:{
        wood:2,
        stone:3,
        iron:6,
        food:1
      }
    },
    stock:{
      planetIndex:0,
      lines:[]
    },
    tech:{
      points:0,
      unlocked:{
        farm:true,
        mine:true,
        factory:false,
        wall:false,
        tower:false
      }
    },
    ads:{
      cooldown:0,
      playing:false,
      lastReward:0
    },
    log:[]
  };
}

function saveGame(){
  localStorage.setItem(SAVE_KEY, JSON.stringify(state));
  toast("âœ… å·²å­˜æª”");
}

function loadGame(){
  try{
    const raw=localStorage.getItem(SAVE_KEY);
    if(!raw) return null;
    const obj=JSON.parse(raw);
    if(!obj || !obj.map) return null;
    return obj;
  }catch(e){
    return null;
  }
}

function resetGame(){
  localStorage.removeItem(SAVE_KEY);
  state=defaultState();
  toast("âš ï¸ å·²é‡ç½®ä¸–ç•Œ");
  pushLog("ä¸–ç•Œé‡ç½®ã€‚");
}

/* ---------- Terrain Generation ---------- */
function genTerrain(x,y){
  // handmade terrain zones
  const dx=x-11, dy=y-11;
  const d=Math.sqrt(dx*dx+dy*dy);

  // river line
  if(Math.abs((x*0.8 + y*0.3) - 14) < 1.2) return "river";

  // mountains outer ring
  if(d>9 && Math.random()<0.55) return "mountain";

  // forest belt
  if(d>5 && d<9 && Math.random()<0.45) return "forest";

  // ore pockets
  if(Math.random()<0.08) return "ore";

  // plains
  if(Math.random()<0.25) return "plain";

  return "grass";
}

/* ---------- Global State ---------- */
let state = loadGame() || defaultState();

/* ---------- UI ---------- */
const panel=document.getElementById("panel");
const panelBody=document.getElementById("panelBody");
const btnTogglePanel=document.getElementById("btnTogglePanel");
const btnSave=document.getElementById("btnSave");
const btnReset=document.getElementById("btnReset");

const chatFloat=document.getElementById("chatFloat");
const chatBody=document.getElementById("chatBody");
const chatInput=document.getElementById("chatInput");
const chatSend=document.getElementById("chatSend");
const btnChatMin=document.getElementById("btnChatMin");

const toastBox=document.getElementById("toast");

function toast(t){
  toastBox.innerText=t;
  toastBox.style.display="block";
  clearTimeout(toastBox._t);
  toastBox._t=setTimeout(()=>toastBox.style.display="none",1200);
}

btnTogglePanel.onclick=()=>{
  panel.classList.toggle("min");
};
btnSave.onclick=saveGame;
btnReset.onclick=()=>{
  if(confirm("ç¢ºå®šé‡ç½®ï¼Ÿæ‰€æœ‰é›¢ç·šå­˜æª”æœƒæ¶ˆå¤±ã€‚")){
    resetGame();
    saveGame();
  }
};

btnChatMin.onclick=()=>{
  chatFloat.classList.toggle("min");
  btnChatMin.innerText=chatFloat.classList.contains("min")?"â—‚":"â–¸";
};

/* ---------- Logging ---------- */
function pushLog(msg){
  state.log.unshift({t:Date.now(),msg});
  state.log=state.log.slice(0,50);
}

/* ---------- Territory ---------- */
function isInsideTerritory(x,y){
  const cx=11, cy=11;
  const dx=x-cx, dy=y-cy;
  return (dx*dx+dy*dy) <= (state.territoryRadius*state.territoryRadius);
}

/* ---------- Economy ---------- */
function canAfford(cost){
  if(!cost) return true;
  for(const k in cost){
    if((state.resources[k]||0) < cost[k]) return false;
  }
  return true;
}
function pay(cost){
  for(const k in cost){
    state.resources[k]-=cost[k];
    if(state.resources[k]<0) state.resources[k]=0;
  }
}

function tryPayWithGoldOrAeno(extraGold){
  // allow player to use gold first, then optional aeno
  const need=extraGold;
  if(state.resources.gold>=need){
    state.resources.gold-=need;
    return true;
  }
  const missing=need-state.resources.gold;
  // conversion: 1 AENO = 100 gold (demo)
  const aenoNeed=Math.ceil(missing/100);
  if(state.resources.aeno>=aenoNeed){
    state.resources.gold=0;
    state.resources.aeno-=aenoNeed;
    return true;
  }
  return false;
}

/* ---------- Build / Upgrade ---------- */
function placeBuilding(type){
  const {x,y}=state.selected;
  if(!isInsideTerritory(x,y)){
    toast("âš ï¸ ä¸åœ¨é ˜åœŸå…§");
    return;
  }
  const tile=state.map[y][x];
  if(tile.building!=="none"){
    toast("âš ï¸ å·²æœ‰å»ºç¯‰");
    return;
  }
  if(type==="factory" && !state.tech.unlocked.factory){
    toast("ğŸ”’ æœªè§£é–å·¥å» ");
    return;
  }
  if(type==="wall" && !state.tech.unlocked.wall){
    toast("ğŸ”’ æœªè§£é–åŸç‰†");
    return;
  }
  if(type==="tower" && !state.tech.unlocked.tower){
    toast("ğŸ”’ æœªè§£é–å®ˆè¡›å¡”");
    return;
  }

  const meta=buildingMeta[type];
  if(!meta){toast("éŒ¯èª¤");return;}

  if(!canAfford(meta.cost)){
    toast("è³‡æºä¸è¶³ï¼Œå¯ç”¨äº¤æ˜“æ‰€è²·");
    return;
  }
  pay(meta.cost);
  tile.building=type;
  tile.level=1;

  pushLog(`å»ºè¨­ï¼š${meta.name} Lv1`);
  toast("ğŸ— å·²å»ºè¨­");
}

function upgradeBuilding(){
  const {x,y}=state.selected;
  const tile=state.map[y][x];
  if(tile.building==="none"){toast("âš ï¸ å†‡å»ºç¯‰");return;}
  const lv=tile.level||1;
  if(lv>=5){toast("å·²æ»¿ç´š");return;}

  const meta=buildingMeta[tile.building];
  const base=meta.cost||{};
  const upCost={};
  for(const k in base){
    upCost[k]=Math.ceil(base[k]*(0.65+lv*0.45));
  }

  if(!canAfford(upCost)){
    toast("å‡ç´šè³‡æºä¸è¶³");
    return;
  }

  pay(upCost);
  tile.level=lv+1;
  pushLog(`å‡ç´šï¼š${meta.name} Lv${tile.level}`);
  toast("â¬†ï¸ å·²å‡ç´š");
}

function demolishBuilding(){
  const {x,y}=state.selected;
  const tile=state.map[y][x];
  if(tile.building==="none"){toast("âš ï¸ å†‡å»ºç¯‰");return;}
  pushLog(`æ‹†é™¤ï¼š${buildingMeta[tile.building].name}`);
  tile.building="none";
  tile.level=0;
  toast("ğŸ§¹ å·²æ‹†é™¤");
}

/* ---------- Expand Territory ---------- */
function expandTerritory(){
  // expansion cost increases
  const r=state.territoryRadius;
  const goldNeed = Math.floor(200 + r*r*120);
  const ok=tryPayWithGoldOrAeno(goldNeed);
  if(!ok){
    toast("é‡‘å¹£ä¸è¶³ï¼ˆå¯ç”¨AENOè£œï¼‰");
    return;
  }
  state.territoryRadius++;
  pushLog(`é ˜åœŸæ“´å¼µï¼šåŠå¾‘ ${state.territoryRadius}`);
  toast("ğŸŒ é ˜åœŸæ“´å¼µæˆåŠŸ");
}

/* ---------- Market ---------- */
function marketBuy(res,qty){
  qty=Math.max(1,Math.floor(qty));
  const price=state.market.prices[res]||1;
  const cost=qty*price;
  if(state.resources.gold<cost){
    toast("é‡‘å¹£ä¸è¶³");
    return;
  }
  state.resources.gold-=cost;
  state.resources[res]=(state.resources[res]||0)+qty;
  pushLog(`äº¤æ˜“æ‰€è²·å…¥ï¼š${res} x${qty} (-${cost}é‡‘å¹£)`);
  toast("ğŸ›’ å·²è²·å…¥");
}

function marketSell(res,qty){
  qty=Math.max(1,Math.floor(qty));
  if((state.resources[res]||0)<qty){
    toast("è³‡æºä¸è¶³");
    return;
  }
  const price=state.market.prices[res]||1;
  const gain=Math.floor(qty*price*0.85);
  state.resources[res]-=qty;
  state.resources.gold+=gain;
  pushLog(`äº¤æ˜“æ‰€è³£å‡ºï¼š${res} x${qty} (+${gain}é‡‘å¹£)`);
  toast("ğŸ’° å·²è³£å‡º");
}

/* ---------- Stock (simplified) ---------- */
function tickStock(){
  // update pseudo stock every 5 sec
  if(!state.stock.lines || state.stock.lines.length===0){
    state.stock.lines=[];
    for(let i=0;i<30;i++){
      state.stock.lines.push({
        wood:state.market.prices.wood,
        stone:state.market.prices.stone,
        iron:state.market.prices.iron,
        food:state.market.prices.food
      });
    }
  }

  const last=state.stock.lines[state.stock.lines.length-1];
  const next={...last};
  for(const k of ["wood","stone","iron","food"]){
    let v=next[k];
    v += rand(-0.6,0.6);
    v = clamp(v, 0.5, 30);
    next[k]=Math.round(v*10)/10;
    state.market.prices[k]=next[k];
  }
  state.stock.lines.push(next);
  state.stock.lines=state.stock.lines.slice(-60);
}

/* ---------- Tech Tree ---------- */
function gainTechPoints(n){
  state.tech.points += n;
}

function unlockTech(name,cost){
  if(state.tech.points<cost){
    toast("ç§‘æŠ€é»ä¸è¶³");
    return;
  }
  state.tech.points -= cost;

  if(name==="factory") state.tech.unlocked.factory=true;
  if(name==="wall") state.tech.unlocked.wall=true;
  if(name==="tower") state.tech.unlocked.tower=true;

  pushLog("ç§‘æŠ€è§£é–ï¼š"+name);
  toast("ğŸ§  å·²è§£é–ç§‘æŠ€");
}

/* ---------- Ads / Music ---------- */
function playAdSong(){
  if(state.ads.cooldown>0){
    toast("å†·å»ä¸­...");
    return;
  }
  state.ads.playing=true;
  state.ads.cooldown=45;
  pushLog("æ’­æ”¾è´ŠåŠ©æ­Œæ›²ä¸­...");
  toast("ğŸµ æ’­æ”¾ä¸­...");
  setTimeout(()=>{
    state.ads.playing=false;
    const reward=irand(60,140);
    state.resources.gold += reward;
    pushLog(`å»£å‘Šæ­Œæ›²å®Œæˆï¼š+${reward} é‡‘å¹£`);
    toast("ğŸ +"+reward+"é‡‘å¹£");
  }, 2500);
}

/* ---------- Robot Raid (steal 20%) ---------- */
function spawnRobot(){
  state.robot.active=true;
  state.robot.x=irand(0,GRID_W-1);
  state.robot.y=irand(0,GRID_H-1);
  state.robot.stealTimer=15;
  state.robot.adText="SPONSOR";
  pushLog("ğŸ¤– æ©Ÿå™¨äººé™è½ï¼šå¯èƒ½æ å¥ªè³‡æºï¼");
  toast("ğŸ¤– æ©Ÿå™¨äººå…¥ä¾µï¼");
}

function robotSteal(){
  // defense reduces steal
  let def=0;
  for(let y=0;y<GRID_H;y++){
    for(let x=0;x<GRID_W;x++){
      const t=state.map[y][x];
      if(t.building==="wall") def += 0.3*(t.level||1);
      if(t.building==="tower") def += 0.6*(t.level||1);
    }
  }
  def=clamp(def,0,10);

  let stealRate=0.20 - def*0.01;
  stealRate=clamp(stealRate,0.05,0.20);

  const stolen={};
  for(const k of ["wood","stone","iron","food","gold"]){
    const amount=state.resources[k]||0;
    const s=Math.floor(amount*stealRate);
    state.resources[k]-=s;
    stolen[k]=s;
  }

  pushLog(`ğŸ¤– æ©Ÿå™¨äººæ å¥ªæˆåŠŸï¼šå·èµ° ${Math.floor(stealRate*100)}% è³‡æº`);
  toast("ğŸ’€ è¢«å·èµ°è³‡æº "+Math.floor(stealRate*100)+"%");
  state.robot.active=false;
}

/* ---------- Beast Tide ---------- */
function spawnBeastWave(){
  state.beast.active=true;
  state.beast.wave++;
  pushLog("ğŸº ç¸æ½®çˆ†ç™¼ï¼ç¬¬ "+state.beast.wave+" æ³¢");
  toast("ğŸº ç¸æ½®ä¾†è¥²ï¼");
}

function resolveBeast(){
  // calculate defense power
  let power=0;
  for(let y=0;y<GRID_H;y++){
    for(let x=0;x<GRID_W;x++){
      const t=state.map[y][x];
      if(t.building==="tower") power += 3*(t.level||1);
      if(t.building==="wall") power += 1*(t.level||1);
      if(t.building==="town") power += 2*(t.level||1);
    }
  }

  const difficulty = 10 + state.beast.wave*6;
  if(power>=difficulty){
    const reward=50+state.beast.wave*30;
    state.resources.gold += reward;
    gainTechPoints(2);
    pushLog("ğŸ›¡ é˜²å®ˆæˆåŠŸï¼çå‹µé‡‘å¹£ +"+reward+"ï¼Œç§‘æŠ€é»+2");
    toast("ğŸ›¡ é˜²å®ˆæˆåŠŸï¼");
  }else{
    // lose some food/wood
    const lossFood=Math.min(state.resources.food, 30+state.beast.wave*20);
    const lossWood=Math.min(state.resources.wood, 20+state.beast.wave*15);
    state.resources.food -= lossFood;
    state.resources.wood -= lossWood;
    pushLog("ğŸ”¥ é˜²å®ˆå¤±æ•—ï¼šæå¤± é£Ÿç‰©-"+lossFood+" æœ¨æ-"+lossWood);
    toast("ğŸ”¥ é˜²å®ˆå¤±æ•—");
  }

  state.beast.active=false;
  state.beast.timer= 120 + state.beast.wave*15;
}

/* ---------- AI Assistant ---------- */
function aiSpeak(text){
  addChat("ai", text);
  state.ai.lastSpeak=now();
}

function addChat(who,text){
  const div=document.createElement("div");
  div.className="msg "+(who==="ai"?"ai":"me");
  div.innerHTML=`<span class="who">${who==="ai"?"Aenko":"ä½ "}ï¼š</span> ${text}`;
  chatBody.appendChild(div);
  chatBody.scrollTop=chatBody.scrollHeight;
}

function aiCommand(cmd){
  cmd=cmd.trim();
  if(!cmd) return;

  addChat("me", cmd);

  if(cmd.includes("å·¡é‚")){
    state.ai.mode="patrol";
    aiSpeak("æ”¶åˆ°ï¼æˆ‘é–‹å§‹å·¡é‚é ˜åœ°ï¼Œé †ä¾¿å¹«ä½ ç•™æ„ç¸æ½®åŒæ©Ÿå™¨äººã€‚");
    return;
  }
  if(cmd.includes("æ”¶é›†")){
    state.ai.mode="collect";
    aiSpeak("å¥½å‘€ï¼æˆ‘æœƒè‡ªå‹•æ”¶é›†é™„è¿‘è³‡æºã€‚");
    return;
  }
  if(cmd.startsWith("å»ºé€ ")){
    const parts=cmd.split(" ");
    const target=parts[1]||"";
    if(target.includes("è¾²")) { placeBuilding("farm"); aiSpeak("å·²å˜—è©¦å»ºé€ è¾²ç”°ã€‚"); return; }
    if(target.includes("ç¤¦")) { placeBuilding("mine"); aiSpeak("å·²å˜—è©¦å»ºé€ ç¤¦å ´ã€‚"); return; }
    if(target.includes("å·¥")) { placeBuilding("factory"); aiSpeak("å·²å˜—è©¦å»ºé€ å·¥å» ã€‚"); return; }
    if(target.includes("ç‰†")) { placeBuilding("wall"); aiSpeak("å·²å˜—è©¦å»ºé€ åŸç‰†ã€‚"); return; }
    if(target.includes("å¡”")) { placeBuilding("tower"); aiSpeak("å·²å˜—è©¦å»ºé€ å®ˆè¡›å¡”ã€‚"); return; }
    aiSpeak("ä½ æƒ³å»ºé€ å’©ï¼Ÿä¾‹å¦‚ï¼šå»ºé€  è¾²ç”° / å»ºé€  ç¤¦å ´ / å»ºé€  å·¥å» ");
    return;
  }
  if(cmd.startsWith("å‡ç´š")){
    upgradeBuilding();
    aiSpeak("å·²å˜—è©¦å‡ç´šé¸ä¸­å»ºç¯‰ã€‚");
    return;
  }
  if(cmd.includes("ç¸æ½®")){
    aiSpeak(`ç¸æ½®å€’æ•¸ï¼š${Math.floor(state.beast.timer)} ç§’ã€‚é˜²ç¦¦åŠ›è¶Šé«˜è¶Šå®‰å…¨ã€‚`);
    return;
  }
  if(cmd.includes("æ’­æ”¾") && cmd.includes("å»£å‘Š")){
    playAdSong();
    aiSpeak("æ’­æ”¾ä¸­ï½å®Œæˆå¾Œä½ æœƒæ”¶åˆ°é‡‘å¹£çå‹µï¼");
    return;
  }
  if(cmd.includes("äº¤æ˜“")){
    aiSpeak("äº¤æ˜“åŠŸèƒ½åœ¨ã€äº¤æ˜“æ‰€ã€åˆ†é ï¼Œä½ å¯ä»¥ç›´æ¥è²·è³£æœ¨æçŸ³é ­éµé£Ÿç‰©ã€‚");
    return;
  }

  aiSpeak("æˆ‘è½å””æ˜ï¼Œä½†ä½ å¯ä»¥è©¦ï¼šå·¡é‚ / æ”¶é›† / å»ºé€  è¾²ç”° / å‡ç´š å·¥å»  / æŸ¥çœ‹ ç¸æ½® / æ’­æ”¾ å»£å‘Š");
}

chatSend.onclick=()=>{
  aiCommand(chatInput.value);
  chatInput.value="";
};
chatInput.addEventListener("keydown",(e)=>{
  if(e.key==="Enter"){
    aiCommand(chatInput.value);
    chatInput.value="";
  }
});

/* ---------- Input: Drag + Zoom ---------- */
let dragging=false;
let lastTouch=null;

let pointers=new Map();

cv.addEventListener("pointerdown",(e)=>{
  pointers.set(e.pointerId,{x:e.clientX,y:e.clientY});
  if(pointers.size===1){
    dragging=true;
    lastTouch={x:e.clientX,y:e.clientY};
  }
  cv.setPointerCapture(e.pointerId);
});

cv.addEventListener("pointermove",(e)=>{
  if(!pointers.has(e.pointerId)) return;
  pointers.set(e.pointerId,{x:e.clientX,y:e.clientY});

  if(pointers.size===1 && dragging){
    const dx=e.clientX-lastTouch.x;
    const dy=e.clientY-lastTouch.y;
    state.camera.x += dx;
    state.camera.y += dy;
    lastTouch={x:e.clientX,y:e.clientY};
  }

  if(pointers.size===2){
    const arr=[...pointers.values()];
    const a=arr[0], b=arr[1];
    const dist=Math.hypot(a.x-b.x,a.y-b.y);
    if(!cv._pinchDist) cv._pinchDist=dist;

    const delta=(dist-cv._pinchDist)/220;
    state.camera.zoom = clamp(state.camera.zoom + delta, 0.55, 2.2);
    cv._pinchDist=dist;
  }
});

cv.addEventListener("pointerup",(e)=>{
  pointers.delete(e.pointerId);
  if(pointers.size<2) cv._pinchDist=null;

  if(pointers.size===0){
    dragging=false;

    // click select tile
    const pos=screenToWorld(e.clientX,e.clientY);
    const t=worldToTile(pos.x,pos.y);
    if(t){
      state.selected=t;
      toast(`é¸ä¸­ (${t.x},${t.y})`);
    }
  }
});

cv.addEventListener("pointercancel",(e)=>{
  pointers.delete(e.pointerId);
  dragging=false;
  cv._pinchDist=null;
});

/* ---------- Coordinate Convert ---------- */
function tileToWorld(x,y){
  // isometric projection
  const isoX = (x - y) * (TILE*0.5);
  const isoY = (x + y) * (TILE*0.28);
  return {x:isoX,y:isoY};
}
function worldToTile(wx,wy){
  // inverse approximate
  const a = wx/(TILE*0.5);
  const b = wy/(TILE*0.28);
  let x = (a+b)/2;
  let y = (b-a)/2;
  x=Math.round(x);
  y=Math.round(y);
  if(x<0||y<0||x>=GRID_W||y>=GRID_H) return null;
  return {x,y};
}

function screenToWorld(sx,sy){
  const rect=cv.getBoundingClientRect();
  let x=sx-rect.left;
  let y=sy-rect.top;

  // move origin
  x -= rect.width/2;
  y -= rect.height*0.25;

  // apply camera
  x = (x - state.camera.x)/state.camera.zoom;
  y = (y - state.camera.y)/state.camera.zoom;
  return {x,y};
}

/* ---------- Drawing ---------- */
function draw(){
  const w=cv.getBoundingClientRect().width;
  const h=cv.getBoundingClientRect().height;

  ctx.clearRect(0,0,w,h);

  // sky decor
  drawCloud(80,90,1.2);
  drawCloud(280,130,0.9);
  drawCloud(190,190,1.05);

  ctx.save();
  ctx.translate(w/2, h*0.25);
  ctx.translate(state.camera.x, state.camera.y);
  ctx.scale(state.camera.zoom, state.camera.zoom);

  // draw tiles sorted
  for(let y=0;y<GRID_H;y++){
    for(let x=0;x<GRID_W;x++){
      const pos=tileToWorld(x,y);
      drawTile(x,y,pos.x,pos.y);
    }
  }

  // draw buildings after tiles
  for(let y=0;y<GRID_H;y++){
    for(let x=0;x<GRID_W;x++){
      const pos=tileToWorld(x,y);
      drawBuilding(x,y,pos.x,pos.y);
    }
  }

  // animals
  drawAnimals();

  // robot
  if(state.robot.active){
    const p=tileToWorld(state.robot.x,state.robot.y);
    drawRobot(p.x,p.y);
  }

  // AI assistant
  drawAI();

  // selection highlight
  const sp=tileToWorld(state.selected.x,state.selected.y);
  drawSelect(sp.x,sp.y);

  ctx.restore();

  // mini HUD
  drawMiniHUD(w,h);
}

function drawCloud(x,y,s){
  ctx.save();
  ctx.globalAlpha=0.6;
  ctx.fillStyle="#ffffff";
  ctx.beginPath();
  ctx.ellipse(x,y,40*s,22*s,0,0,Math.PI*2);
  ctx.ellipse(x+32*s,y+4*s,32*s,18*s,0,0,Math.PI*2);
  ctx.ellipse(x-28*s,y+6*s,28*s,16*s,0,0,Math.PI*2);
  ctx.fill();
  ctx.restore();
}

function drawIsoDiamond(x,y,size,fill,stroke){
  ctx.beginPath();
  ctx.moveTo(x, y - size*0.28);
  ctx.lineTo(x + size*0.5, y);
  ctx.lineTo(x, y + size*0.28);
  ctx.lineTo(x - size*0.5, y);
  ctx.closePath();
  ctx.fillStyle=fill;
  ctx.fill();
  if(stroke){
    ctx.strokeStyle=stroke;
    ctx.lineWidth=2;
    ctx.stroke();
  }
}

function drawTile(tx,ty,x,y){
  const tile=state.map[ty][tx];
  let base=terrainColor[tile.terrain]||"#b9fbc0";

  // territory shading
  if(!isInsideTerritory(tx,ty)){
    base = shadeColor(base,-35);
  }

  // water shimmer
  if(tile.terrain==="river"){
    base = "#5bbcff";
  }

  drawIsoDiamond(x,y,TILE, base, "#a7f3d0");

  // terrain decoration
  if(tile.terrain==="forest"){
    drawTree(x-10,y-10,0.7);
    drawTree(x+12,y+6,0.65);
  }
  if(tile.terrain==="mountain"){
    drawMountain(x,y-10);
  }
  if(tile.terrain==="ore"){
    drawOre(x,y);
  }
  if(tile.terrain==="river"){
    drawFish(x+10,y+2);
  }
}

function drawBuilding(tx,ty,x,y){
  const tile=state.map[ty][tx];
  if(tile.building==="none") return;

  if(!isInsideTerritory(tx,ty)) return;

  const lv=tile.level||1;

  if(tile.building==="farm"){
    drawFarm(x,y-18,lv);
  }
  if(tile.building==="mine"){
    drawMine(x,y-18,lv);
  }
  if(tile.building==="factory"){
    drawFactory(x,y-22,lv);
  }
  if(tile.building==="wall"){
    drawWall(x,y-14,lv);
  }
  if(tile.building==="tower"){
    drawTower(x,y-26,lv);
  }
  if(tile.building==="town"){
    drawTown(x,y-30,lv);
  }
}

function drawSelect(x,y){
  ctx.save();
  ctx.globalAlpha=0.9;
  ctx.strokeStyle="#2563eb";
  ctx.lineWidth=3;
  ctx.beginPath();
  ctx.moveTo(x, y - TILE*0.28);
  ctx.lineTo(x + TILE*0.5, y);
  ctx.lineTo(x, y + TILE*0.28);
  ctx.lineTo(x - TILE*0.5, y);
  ctx.closePath();
  ctx.stroke();
  ctx.restore();
}

function drawMiniHUD(w,h){
  ctx.save();
  ctx.fillStyle="#ffffffdd";
  ctx.strokeStyle="#dbeafe";
  ctx.lineWidth=1;
  roundRectPath(ctx, 12, h-80, w-24, 68, 18);
  ctx.fill();
  ctx.stroke();

  ctx.fillStyle="#0f172a";
  ctx.font="900 12px system-ui";
  ctx.fillText("è³‡æº", 26, h-54);

  ctx.font="700 11px system-ui";
  const r=state.resources;
  const text=`é‡‘å¹£ ${fmt(r.gold)}   AENO ${fmt(r.aeno)}   æœ¨ ${fmt(r.wood)}   çŸ³ ${fmt(r.stone)}   éµ ${fmt(r.iron)}   é£Ÿ ${fmt(r.food)}`;
  ctx.fillText(text, 26, h-30);

  ctx.restore();
}

/* ---------- Drawing Entities ---------- */
function drawTree(x,y,s){
  ctx.save();
  ctx.translate(x,y);
  ctx.scale(s,s);

  // trunk
  ctx.fillStyle="#92400e";
  ctx.fillRect(-4,6,8,16);

  // leaves
  ctx.fillStyle="#22c55e";
  ctx.beginPath();
  ctx.arc(0,0,12,0,Math.PI*2);
  ctx.arc(-10,4,10,0,Math.PI*2);
  ctx.arc(10,4,10,0,Math.PI*2);
  ctx.fill();

  // highlight
  ctx.globalAlpha=0.25;
  ctx.fillStyle="#ffffff";
  ctx.beginPath();
  ctx.arc(-5,-5,6,0,Math.PI*2);
  ctx.fill();

  ctx.restore();
}

function drawMountain(x,y){
  ctx.save();
  ctx.translate(x,y);
  ctx.fillStyle="#64748b";
  ctx.beginPath();
  ctx.moveTo(-18,12);
  ctx.lineTo(0,-20);
  ctx.lineTo(18,12);
  ctx.closePath();
  ctx.fill();

  ctx.fillStyle="#94a3b8";
  ctx.beginPath();
  ctx.moveTo(-8,2);
  ctx.lineTo(0,-10);
  ctx.lineTo(8,2);
  ctx.closePath();
  ctx.fill();
  ctx.restore();
}

function drawOre(x,y){
  ctx.save();
  ctx.translate(x,y);
  ctx.fillStyle="#f59e0b";
  ctx.beginPath();
  ctx.arc(-10,6,6,0,Math.PI*2);
  ctx.arc(0,2,7,0,Math.PI*2);
  ctx.arc(10,8,5,0,Math.PI*2);
  ctx.fill();
  ctx.restore();
}

function drawFish(x,y){
  ctx.save();
  ctx.translate(x,y);
  ctx.globalAlpha=0.55;
  ctx.fillStyle="#0ea5e9";
  ctx.beginPath();
  ctx.ellipse(0,0,6,3,0,0,Math.PI*2);
  ctx.fill();
  ctx.restore();
}

function drawFarm(x,y,lv){
  ctx.save();
  ctx.translate(x,y);
  ctx.fillStyle="#a16207";
  roundRectPath(ctx,-18,6,36,16,6);
  ctx.fill();

  ctx.fillStyle="#16a34a";
  for(let i=0;i<lv+1;i++){
    ctx.beginPath();
    ctx.arc(-12+i*8,4,4,0,Math.PI*2);
    ctx.fill();
  }
  ctx.restore();
}

function drawMine(x,y,lv){
  ctx.save();
  ctx.translate(x,y);
  ctx.fillStyle="#475569";
  ctx.beginPath();
  ctx.moveTo(-18,12);
  ctx.lineTo(0,-12);
  ctx.lineTo(18,12);
  ctx.closePath();
  ctx.fill();

  ctx.fillStyle="#fbbf24";
  ctx.beginPath();
  ctx.arc(0,6,4+lv,0,Math.PI*2);
  ctx.fill();
  ctx.restore();
}

function drawFactory(x,y,lv){
  ctx.save();
  ctx.translate(x,y);

  ctx.fillStyle="#cbd5e1";
  roundRectPath(ctx,-20,0,40,22,6);
  ctx.fill();

  ctx.fillStyle="#64748b";
  ctx.fillRect(-14,-18,8,18);
  ctx.fillRect(4,-14,8,14);

  ctx.fillStyle="#0ea5e9";
  for(let i=0;i<lv;i++){
    ctx.fillRect(-16+i*10,6,6,6);
  }
  ctx.restore();
}

function drawWall(x,y,lv){
  ctx.save();
  ctx.translate(x,y);
  ctx.fillStyle="#94a3b8";
  roundRectPath(ctx,-22,6,44,12,6);
  ctx.fill();
  ctx.fillStyle="#64748b";
  for(let i=0;i<lv+1;i++){
    ctx.fillRect(-18+i*10,2,6,6);
  }
  ctx.restore();
}

function drawTower(x,y,lv){
  ctx.save();
  ctx.translate(x,y);

  ctx.fillStyle="#94a3b8";
  roundRectPath(ctx,-10,-10,20,30,6);
  ctx.fill();

  ctx.fillStyle="#64748b";
  ctx.fillRect(-12,-14,24,6);

  ctx.fillStyle="#ef4444";
  ctx.beginPath();
  ctx.arc(0,-16,4+lv,0,Math.PI*2);
  ctx.fill();

  ctx.restore();
}

function drawTown(x,y,lv){
  ctx.save();
  ctx.translate(x,y);

  ctx.fillStyle="#fef3c7";
  roundRectPath(ctx,-22,0,44,26,8);
  ctx.fill();

  ctx.fillStyle="#f59e0b";
  ctx.beginPath();
  ctx.moveTo(-26,0);
  ctx.lineTo(0,-22);
  ctx.lineTo(26,0);
  ctx.closePath();
  ctx.fill();

  ctx.fillStyle="#60a5fa";
  ctx.fillRect(-14,8,10,8);
  ctx.fillRect(4,8,10,8);

  ctx.fillStyle="#92400e";
  ctx.fillRect(-4,12,8,14);

  ctx.restore();
}

function drawRobot(x,y){
  ctx.save();
  ctx.translate(x,y-18);

  // body
  ctx.fillStyle="#e2e8f0";
  roundRectPath(ctx,-14,-10,28,22,8);
  ctx.fill();

  // eyes
  ctx.fillStyle="#0f172a";
  ctx.beginPath();
  ctx.arc(-6,-2,3,0,Math.PI*2);
  ctx.arc(6,-2,3,0,Math.PI*2);
  ctx.fill();

  // legs
  ctx.fillStyle="#94a3b8";
  ctx.fillRect(-10,12,6,10);
  ctx.fillRect(4,12,6,10);

  // AD sticker slot
  ctx.fillStyle="#f59e0b";
  roundRectPath(ctx,-12,-22,24,10,5);
  ctx.fill();
  ctx.fillStyle="#0f172a";
  ctx.font="900 8px system-ui";
  ctx.fillText(state.robot.adText, -11, -14);

  ctx.restore();
}

function drawAI(){
  // AI assistant moves smoothly
  const ax=state.ai.px;
  const ay=state.ai.py;

  ctx.save();
  ctx.translate(ax, ay-26);

  // tail
  ctx.fillStyle="#fbbf24";
  ctx.beginPath();
  ctx.ellipse(-16,10,8,4,0.2,0,Math.PI*2);
  ctx.fill();

  // body
  ctx.fillStyle="#fde68a";
  ctx.beginPath();
  ctx.ellipse(0,10,14,10,0,0,Math.PI*2);
  ctx.fill();

  // head
  ctx.fillStyle="#fef3c7";
  ctx.beginPath();
  ctx.arc(0,-4,14,0,Math.PI*2);
  ctx.fill();

  // ears
  ctx.fillStyle="#f59e0b";
  ctx.beginPath();
  ctx.moveTo(-8,-14); ctx.lineTo(-16,-26); ctx.lineTo(-2,-18); ctx.closePath();
  ctx.moveTo(8,-14); ctx.lineTo(16,-26); ctx.lineTo(2,-18); ctx.closePath();
  ctx.fill();

  // eyes
  ctx.fillStyle="#0f172a";
  ctx.beginPath();
  ctx.arc(-5,-6,2.5,0,Math.PI*2);
  ctx.arc(5,-6,2.5,0,Math.PI*2);
  ctx.fill();

  // mouth
  ctx.strokeStyle="#0f172a";
  ctx.lineWidth=2;
  ctx.beginPath();
  ctx.arc(0,-2,4,0.2,Math.PI-0.2);
  ctx.stroke();

  // clothing ad slot
  ctx.fillStyle="#3b82f6";
  roundRectPath(ctx,-10,4,20,10,5);
  ctx.fill();
  ctx.fillStyle="#fff";
  ctx.font="900 8px system-ui";
  ctx.fillText("AD", -6, 12);

  // flag ad slot (head top)
  const t=Math.sin(Date.now()/250)*2;
  ctx.strokeStyle="#334155";
  ctx.lineWidth=2;
  ctx.beginPath();
  ctx.moveTo(10,-20);
  ctx.lineTo(10,-40);
  ctx.stroke();

  ctx.fillStyle="#ef4444";
  ctx.beginPath();
  ctx.moveTo(10,-40);
  ctx.lineTo(10+t,-30);
  ctx.lineTo(30+t,-35);
  ctx.closePath();
  ctx.fill();

  ctx.fillStyle="#fff";
  ctx.font="900 7px system-ui";
  ctx.fillText(state.ai.adText, 12+t, -34);

  ctx.restore();
}

function drawAnimals(){
  // simple deer / bird dots in forest
  for(let i=0;i<10;i++){
    const x=irand(0,GRID_W-1);
    const y=irand(0,GRID_H-1);
    const tile=state.map[y][x];
    if(tile.terrain!=="forest") continue;
    const p=tileToWorld(x,y);
    ctx.save();
    ctx.translate(p.x+rand(-10,10), p.y+rand(-10,10));
    ctx.globalAlpha=0.35;
    ctx.fillStyle="#0f172a";
    ctx.beginPath();
    ctx.arc(0,0,2.5,0,Math.PI*2);
    ctx.fill();
    ctx.restore();
  }
}

/* ---------- Color Shade ---------- */
function shadeColor(hex,percent){
  const f=parseInt(hex.slice(1),16);
  const t=percent<0?0:255;
  const p=Math.abs(percent)/100;
  const R=f>>16, G=f>>8&0x00FF, B=f&0x0000FF;
  const nR=Math.round((t-R)*p)+R;
  const nG=Math.round((t-G)*p)+G;
  const nB=Math.round((t-B)*p)+B;
  return "#"+(0x1000000+(nR<<16)+(nG<<8)+nB).toString(16).slice(1);
}

/* ---------- Game Tick ---------- */
function tick(dt){
  // production tick
  if(dt>2) dt=2;

  // building production
  for(let y=0;y<GRID_H;y++){
    for(let x=0;x<GRID_W;x++){
      const t=state.map[y][x];
      if(t.building==="none") continue;
      if(!isInsideTerritory(x,y)) continue;
      const lv=t.level||1;

      if(t.building==="farm"){
        state.resources.food += 0.5*lv*dt;
      }
      if(t.building==="mine"){
        state.resources.stone += 0.25*lv*dt;
        state.resources.iron += 0.20*lv*dt;
      }
      if(t.building==="factory"){
        state.resources.gold += 0.35*lv*dt;
      }
      if(t.building==="town"){
        state.resources.gold += 0.25*lv*dt;
        state.resources.wood += 0.12*lv*dt;
      }
    }
  }

  // clamp
  for(const k in state.resources){
    if(state.resources[k]<0) state.resources[k]=0;
  }

  // tech points slowly from empire
  state.tech.points += 0.015*dt;

  // stock tick each 5 seconds
  if(!state._stockTimer) state._stockTimer=0;
  state._stockTimer += dt;
  if(state._stockTimer>5){
    state._stockTimer=0;
    tickStock();
  }

  // beast timer
  state.beast.timer -= dt;
  if(state.beast.timer<=0 && !state.beast.active){
    spawnBeastWave();
  }
  if(state.beast.active){
    // auto resolve after 10 sec
    if(!state.beast._resolve) state.beast._resolve=10;
    state.beast._resolve -= dt;
    if(state.beast._resolve<=0){
      state.beast._resolve=null;
      resolveBeast();
    }
  }

  // robot chance
  if(!state.robot.active && Math.random()<0.0025*dt){
    spawnRobot();
  }
  if(state.robot.active){
    state.robot.stealTimer -= dt;
    if(state.robot.stealTimer<=0){
      // if robot landed inside territory -> steal
      if(isInsideTerritory(state.robot.x,state.robot.y)){
        robotSteal();
      }else{
        pushLog("ğŸ¤– æ©Ÿå™¨äººé›¢é–‹ï¼ˆæœªé€²å…¥é ˜åœŸï¼‰");
        state.robot.active=false;
      }
    }
  }

  // ads cooldown
  if(state.ads.cooldown>0) state.ads.cooldown -= dt;

  // AI movement
  updateAI(dt);

  // autosave every 30 sec
  if(!state._autosave) state._autosave=30;
  state._autosave -= dt;
  if(state._autosave<=0){
    state._autosave=30;
    saveGame();
  }
}

function updateAI(dt){
  // decide movement
  if(state.ai.mode==="patrol"){
    if(!state.ai._moveTimer) state.ai._moveTimer=0;
    state.ai._moveTimer -= dt;
    if(state.ai._moveTimer<=0){
      state.ai._moveTimer=2.5;
      const nx=clamp(state.ai.x+irand(-1,1),0,GRID_W-1);
      const ny=clamp(state.ai.y+irand(-1,1),0,GRID_H-1);
      if(isInsideTerritory(nx,ny)){
        state.ai.x=nx; state.ai.y=ny;
      }
    }
  }

  if(state.ai.mode==="collect"){
    // auto collect random small bonus
    if(!state.ai._collectTimer) state.ai._collectTimer=0;
    state.ai._collectTimer -= dt;
    if(state.ai._collectTimer<=0){
      state.ai._collectTimer=4;
      const gainWood=irand(1,4);
      const gainFood=irand(2,6);
      state.resources.wood += gainWood;
      state.resources.food += gainFood;
      if(Math.random()<0.3) state.resources.stone += 1;
      if(Math.random()<0.2) state.resources.iron += 1;

      if(Math.random()<0.4){
        aiSpeak(`æˆ‘å¹«ä½ æ”¶é›†åˆ°ï¼šæœ¨æ+${gainWood}ã€é£Ÿç‰©+${gainFood}ã€‚`);
      }
    }
  }

  // smooth pixel follow
  const target=tileToWorld(state.ai.x,state.ai.y);
  if(state.ai.px===0 && state.ai.py===0){
    state.ai.px=target.x;
    state.ai.py=target.y;
  }
  state.ai.px += (target.x - state.ai.px) * 0.08;
  state.ai.py += (target.y - state.ai.py) * 0.08;

  // AI talk reminders
  if(now()-state.ai.lastSpeak>25000){
    state.ai.lastSpeak=now();
    const hints=[
      "ä½ å¯ä»¥å»ã€å»ºè¨­ã€åˆ†é èµ·å»ºç¯‰ï¼Œæ“´å¼µé ˜åœŸæœƒæ›´å®‰å…¨ã€‚",
      "äº¤æ˜“æ‰€å¯ä»¥ç”¨é‡‘å¹£è²·çŸ³é ­åŒéµï¼Œå””å¤ è³‡æºå°±å””æœƒå¡æ­»ã€‚",
      "ç¸æ½®æœƒè¶Šä¾†è¶Šå¼·ï¼Œæœ€å¥½èµ·å®ˆè¡›å¡”ã€‚",
      "æ©Ÿå™¨äººæœ‰æ©Ÿæœƒå·èµ°ä½ 20%è³‡æºï¼ŒåŸç‰†åŒå¡”å¯ä»¥æ¸›å°‘æå¤±ã€‚",
      "AENO ä¿‚è³‡ç”¢ï¼Œå””å»ºè­°äº‚ç”¨ï¼›é‡‘å¹£å…ˆä¿‚å¸åœ‹è²¨å¹£ã€‚"
    ];
    aiSpeak(hints[irand(0,hints.length-1)]);
  }
}

/* ---------- Panel Render ---------- */
function setTab(name){
  document.querySelectorAll(".tab").forEach(t=>{
    t.classList.toggle("active", t.dataset.tab===name);
  });
  renderPanel(name);
}

document.querySelectorAll(".tab").forEach(t=>{
  t.onclick=()=>setTab(t.dataset.tab);
});

function renderPanel(tab){
  const r=state.resources;
  const sel=state.map[state.selected.y][state.selected.x];

  if(tab==="home"){
    panelBody.innerHTML=`
      <div class="card">
        <div class="big">ğŸ“¦ è³‡æºç¸½è¦½</div>
        <div class="label">é‡‘å¹£ç‚ºä¸»è²¨å¹£ï¼ŒAENOç‚ºé«˜ç´šè³‡ç”¢ï¼ˆä¸å¼·åˆ¶ç”¨æ–¼æ“´åœŸï¼‰ã€‚</div>
        <div class="row">
          <div class="chip"><b>é‡‘å¹£</b> <span class="mono">${fmt(r.gold)}</span></div>
          <div class="chip"><b>AENO</b> <span class="mono">${fmt(r.aeno)}</span></div>
          <div class="chip"><b>æœ¨</b> <span class="mono">${fmt(r.wood)}</span></div>
          <div class="chip"><b>çŸ³</b> <span class="mono">${fmt(r.stone)}</span></div>
          <div class="chip"><b>éµ</b> <span class="mono">${fmt(r.iron)}</span></div>
          <div class="chip"><b>é£Ÿ</b> <span class="mono">${fmt(r.food)}</span></div>
        </div>
      </div>

      <div class="card">
        <div class="big">ğŸŒ é ˜åœŸæ§åˆ¶</div>
        <div class="label">ç›®å‰é ˜åœŸåŠå¾‘ï¼š<b>${state.territoryRadius}</b>ï¼ˆæ“´å¼µç”¨é‡‘å¹£ï¼Œå¯ç”¨AENOè£œå·®é¡ï¼‰</div>
        <button class="btn green" onclick="expandTerritory()">æ“´å¼µé ˜åœŸ</button>
      </div>

      <div class="card">
        <div class="big">ğŸ¯ é¸ä¸­åœ°å¡Š</div>
        <div class="label">ä½ç½®ï¼š(${state.selected.x},${state.selected.y})</div>
        <div class="label">åœ°å½¢ï¼š<b>${sel.terrain}</b></div>
        <div class="label">å»ºç¯‰ï¼š<b>${buildingMeta[sel.building].name}</b> Lv${sel.level||0}</div>
        <div class="row">
          <button class="btn" onclick="upgradeBuilding()">å‡ç´š</button>
          <button class="btn red" onclick="demolishBuilding()">æ‹†é™¤</button>
        </div>
      </div>

      <div class="card">
        <div class="big">âš”ï¸ ä¸–ç•Œç‹€æ…‹</div>
        <div class="label">ç¸æ½®å€’æ•¸ï¼š<b>${Math.floor(state.beast.timer)}ç§’</b> | æ³¢æ¬¡ï¼š<b>${state.beast.wave}</b></div>
        <div class="label">æ©Ÿå™¨äººï¼š<b>${state.robot.active?"å…¥ä¾µä¸­":"å¹³éœ"}</b></div>
      </div>

      <div class="card">
        <div class="big">ğŸ“° ç³»çµ±ç´€éŒ„</div>
        <div class="label">ï¼ˆæœ€è¿‘10æ¢ï¼‰</div>
        <div style="font-size:12px;color:#0f172a;line-height:1.5;">
          ${state.log.slice(0,10).map(x=>`â€¢ ${x.msg}`).join("<br>")}
        </div>
      </div>
    `;
    return;
  }

  if(tab==="build"){
    panelBody.innerHTML=`
      <div class="card">
        <div class="big">ğŸ— å»ºè¨­ä¸­å¿ƒï¼ˆé»åœ°å¡Šå¾Œå»ºé€ ï¼‰</div>
        <div class="label">é¸ä¸­åœ°å¡Šï¼š(${state.selected.x},${state.selected.y}) | åœ°å½¢ï¼š${sel.terrain}</div>
        <div class="label">å»ºç¯‰ï¼š${buildingMeta[sel.building].name} Lv${sel.level||0}</div>
      </div>

      <div class="card">
        <div class="big">å»ºç¯‰åˆ—è¡¨</div>
        <div class="row">
          <button class="btn green" onclick="placeBuilding('farm')">å»ºé€  è¾²ç”°</button>
          <button class="btn gold" onclick="placeBuilding('mine')">å»ºé€  ç¤¦å ´</button>
          <button class="btn" onclick="placeBuilding('factory')">å»ºé€  å·¥å» </button>
          <button class="btn gray" onclick="placeBuilding('wall')">å»ºé€  åŸç‰†</button>
          <button class="btn red" onclick="placeBuilding('tower')">å»ºé€  å®ˆè¡›å¡”</button>
        </div>
        <div class="label" style="margin-top:8px;">
          âš ï¸ å·¥å» /åŸç‰†/å¡”éœ€è¦ç§‘æŠ€è§£é–ã€‚å‡ç´šå¯å¢åŠ ç”¢é‡/é˜²ç¦¦ã€‚
        </div>
      </div>

      <div class="card">
        <div class="big">â¬†ï¸ å‡ç´š / æ‹†é™¤</div>
        <div class="row">
          <button class="btn" onclick="upgradeBuilding()">å‡ç´šé¸ä¸­å»ºç¯‰</button>
          <button class="btn red" onclick="demolishBuilding()">æ‹†é™¤é¸ä¸­å»ºç¯‰</button>
        </div>
      </div>
    `;
    return;
  }

  if(tab==="market"){
    panelBody.innerHTML=`
      <div class="card">
        <div class="big">ğŸ›’ äº¤æ˜“æ‰€ï¼ˆç”¨é‡‘å¹£è²·è³£è³‡æºï¼‰</div>
        <div class="label">åƒ¹æ ¼æœƒéš¨è‚¡å¸‚æ³¢å‹•ã€‚AENOå±¬è³‡ç”¢ï¼Œä¸å»ºè­°å¤§é‡æ¶ˆè€—ã€‚</div>
      </div>

      <div class="card">
        <div class="big">ä»Šæ—¥åƒ¹æ ¼</div>
        <div class="label">æœ¨æï¼š${state.market.prices.wood} é‡‘/1</div>
        <div class="label">çŸ³é ­ï¼š${state.market.prices.stone} é‡‘/1</div>
        <div class="label">éµï¼š${state.market.prices.iron} é‡‘/1</div>
        <div class="label">é£Ÿç‰©ï¼š${state.market.prices.food} é‡‘/1</div>
      </div>

      <div class="card">
        <div class="big">å¿«é€Ÿäº¤æ˜“</div>
        <div class="row">
          <button class="btn" onclick="marketBuy('wood',50)">è²·æœ¨ x50</button>
          <button class="btn" onclick="marketBuy('stone',50)">è²·çŸ³ x50</button>
          <button class="btn" onclick="marketBuy('iron',20)">è²·éµ x20</button>
          <button class="btn" onclick="marketBuy('food',100)">è²·é£Ÿ x100</button>
        </div>
        <div class="row" style="margin-top:8px;">
          <button class="btn gray" onclick="marketSell('wood',50)">è³£æœ¨ x50</button>
          <button class="btn gray" onclick="marketSell('stone',50)">è³£çŸ³ x50</button>
          <button class="btn gray" onclick="marketSell('iron',20)">è³£éµ x20</button>
          <button class="btn gray" onclick="marketSell('food',100)">è³£é£Ÿ x100</button>
        </div>
      </div>
    `;
    return;
  }

  if(tab==="stock"){
    const last=state.stock.lines[state.stock.lines.length-1] || state.market.prices;
    panelBody.innerHTML=`
      <div class="card">
        <div class="big">ğŸ“ˆ è‚¡å¸‚ï¼ˆç°¡åŒ–ç‰ˆï¼‰</div>
        <div class="label">è³‡æºåƒ¹æ ¼æ¯å¹¾ç§’æ³¢å‹•ä¸€æ¬¡ï¼Œæ¨¡æ“¬æ˜Ÿçƒå¸‚å ´ã€‚</div>
      </div>

      <div class="card">
        <div class="big">æœ€æ–°æŒ‡æ•¸</div>
        <div class="label">æœ¨æï¼š<b>${last.wood}</b></div>
        <div class="label">çŸ³é ­ï¼š<b>${last.stone}</b></div>
        <div class="label">éµï¼š<b>${last.iron}</b></div>
        <div class="label">é£Ÿç‰©ï¼š<b>${last.food}</b></div>
      </div>

      <div class="card">
        <div class="big">æç¤º</div>
        <div class="label">å¦‚æœä½ è¦‹åˆ°éµåƒ¹æ ¼ä¸‹é™ï¼Œå¯ä»¥å¤§é‡è²·å…¥ï¼Œå·¥å» å‡ç´šæœƒå¿«å¥½å¤šã€‚</div>
      </div>
    `;
    return;
  }

  if(tab==="tech"){
    panelBody.innerHTML=`
      <div class="card">
        <div class="big">ğŸ§  ç§‘æŠ€æ¨¹</div>
        <div class="label">ç§‘æŠ€é»ï¼š<b>${state.tech.points.toFixed(2)}</b></div>
      </div>

      <div class="card">
        <div class="big">è§£é–ç§‘æŠ€</div>
        <div class="row">
          <button class="btn ${state.tech.unlocked.factory?"gray":"purple"}" onclick="unlockTech('factory',8)">
            ${state.tech.unlocked.factory?"å·²è§£é–":"è§£é–"} å·¥å»  (8é»)
          </button>
          <button class="btn ${state.tech.unlocked.wall?"gray":"purple"}" onclick="unlockTech('wall',6)">
            ${state.tech.unlocked.wall?"å·²è§£é–":"è§£é–"} åŸç‰† (6é»)
          </button>
          <button class="btn ${state.tech.unlocked.tower?"gray":"purple"}" onclick="unlockTech('tower',10)">
            ${state.tech.unlocked.tower?"å·²è§£é–":"è§£é–"} å®ˆè¡›å¡” (10é»)
          </button>
        </div>
      </div>

      <div class="card">
        <div class="big">ç§‘æŠ€èªªæ˜</div>
        <div class="label">
          å·¥å» ï¼šç”¢ç”Ÿé‡‘å¹£<br>
          åŸç‰†ï¼šæ¸›å°‘æ©Ÿå™¨äººå·ç«Šæ¯”ä¾‹<br>
          å®ˆè¡›å¡”ï¼šæå‡ç¸æ½®é˜²ç¦¦åŠ›
        </div>
      </div>
    `;
    return;
  }

  if(tab==="event"){
    panelBody.innerHTML=`
      <div class="card">
        <div class="big">âš”ï¸ äº‹ä»¶ä¸­å¿ƒ</div>
        <div class="label">ç¸æ½®æ³¢æ¬¡ï¼š${state.beast.wave} | å€’æ•¸ï¼š${Math.floor(state.beast.timer)} ç§’</div>
        <div class="label">æ©Ÿå™¨äººï¼š${state.robot.active?"æ­£åœ¨å…¥ä¾µ":"ç›®å‰ç„¡"}</div>
      </div>

      <div class="card">
        <div class="big">ğŸ¤– æ©Ÿå™¨äººæ å¥ªè¦å‰‡</div>
        <div class="label">
          æ©Ÿå™¨äººæœƒéš¨æ©Ÿé™è½ã€‚<br>
          å¦‚æœè½åœ¨ä½ é ˜åœ°å…§ï¼Œæœƒå·èµ°ä½ è³‡æº <b>20%</b>ã€‚<br>
          åŸç‰†èˆ‡å®ˆè¡›å¡”å¯ä»¥æ¸›å°‘æå¤±ã€‚
        </div>
      </div>

      <div class="card">
        <div class="big">ğŸº ç¸æ½®è¦å‰‡</div>
        <div class="label">
          æ¯éš”ä¸€æ®µæ™‚é–“æœƒçˆ†ç™¼ç¸æ½®ã€‚<br>
          å®ˆè¡›å¡”è¶Šå¤šè¶Šå®¹æ˜“é˜²å®ˆæˆåŠŸã€‚<br>
          æˆåŠŸé˜²å®ˆï¼šçå‹µé‡‘å¹£ + ç§‘æŠ€é»ã€‚<br>
          å¤±æ•—ï¼šæå¤±é£Ÿç‰©èˆ‡æœ¨æã€‚
        </div>
      </div>
    `;
    return;
  }

  if(tab==="ads"){
    panelBody.innerHTML=`
      <div class="card">
        <div class="big">ğŸµ å»£å‘Š / æ­Œæ›²ä¸­å¿ƒ</div>
        <div class="label">æ’­æ”¾ä¸€æ¬¡è´ŠåŠ©æ­Œæ›²ï¼Œç²å¾—é‡‘å¹£çå‹µï¼ˆæœ‰å†·å»ï¼‰ã€‚</div>
      </div>

      <div class="card">
        <div class="big">æ’­æ”¾è´ŠåŠ©æ­Œæ›²</div>
        <div class="label">å†·å»ï¼š${Math.max(0,Math.floor(state.ads.cooldown))} ç§’</div>
        <button class="btn gold" onclick="playAdSong()">æ’­æ”¾å»£å‘Šæ­Œæ›²</button>
      </div>

      <div class="card">
        <div class="big">ğŸ“¢ å»£å‘Šä½è¨­è¨ˆï¼ˆå·²å•Ÿç”¨ï¼‰</div>
        <div class="label">
          âœ… AIåŠ©æ‰‹é ­é ‚æ——å¹Ÿ Ad Slot<br>
          âœ… AIåŠ©æ‰‹è¡£æœ Ad Slot<br>
          âœ… æ©Ÿå™¨äººè²¼ç´™ Ad Slot<br>
          âœ… é¢æ¿å…§æ’­æ”¾å»£å‘Š/æ­Œæ›²çå‹µç³»çµ±
        </div>
      </div>
    `;
    return;
  }

  panelBody.innerHTML="<div class='card'><div class='big'>æœªå®Œæˆ</div></div>";
}

/* ---------- Main Loop ---------- */
let last=performance.now();
function loop(t){
  const dt=(t-last)/1000;
  last=t;
  tick(dt);
  draw();

  // keep panel fresh
  const activeTab=document.querySelector(".tab.active").dataset.tab;
  if(!state._panelTimer) state._panelTimer=0;
  state._panelTimer += dt;
  if(state._panelTimer>1.0){
    state._panelTimer=0;
    renderPanel(activeTab);
  }

  requestAnimationFrame(loop);
}

/* ---------- Init ---------- */
resize();
setTab("home");
aiSpeak("AENO V3 å·²å•Ÿå‹•ï¼ä½ å¯ä»¥æ‹–å‹•åœ°åœ–ã€é›™æŒ‡ç¸®æ”¾ã€é»åœ°å¡Šå»ºè¨­ã€‚");
pushLog("AENO V3 å•Ÿå‹•å®Œæˆï¼ˆé›¢ç·šæ¨¡å¼ï¼‰ã€‚");
requestAnimationFrame(loop);

</script>
</body>
</html>
