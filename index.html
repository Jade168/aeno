<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>AENO V3 (Mobile Cartoon - Canvas)</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: #0b1020;
      overflow: hidden;
      font-family: Arial, "Microsoft JhengHei", "PingFang HK", sans-serif;
      touch-action: none;
      -webkit-user-select: none;
      user-select: none;
    }
    canvas {
      display: block;
      width: 100vw;
      height: 100vh;
      background: linear-gradient(#091224, #081018);
    }

    /* Small HUD top */
    #hudTop {
      position: fixed;
      top: 6px;
      left: 6px;
      right: 6px;
      display: flex;
      gap: 6px;
      justify-content: space-between;
      z-index: 50;
      pointer-events: none;
    }
    .hudBox {
      pointer-events: auto;
      background: rgba(0,0,0,0.55);
      border: 1px solid rgba(255,255,255,0.15);
      color: #fff;
      padding: 6px 8px;
      border-radius: 10px;
      font-size: 11px;
      line-height: 1.25em;
      backdrop-filter: blur(6px);
      max-width: 48vw;
      box-shadow: 0 8px 20px rgba(0,0,0,0.25);
    }
    .hudRow {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }
    .pill {
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.12);
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 11px;
      white-space: nowrap;
    }

    /* Panel */
    #panel {
      position: fixed;
      right: 8px;
      bottom: 80px; /* avoid mobile nav bar */
      width: min(320px, 75vw);
      max-height: 25vh; /* <= 1/4 screen */
      background: rgba(10,14,20,0.85);
      border: 1px solid rgba(255,255,255,0.16);
      border-radius: 14px;
      color: #fff;
      z-index: 100;
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
      backdrop-filter: blur(10px);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      touch-action: none;
    }

    #panelHeader {
      padding: 8px 10px;
      font-size: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(255,255,255,0.06);
      cursor: grab;
    }
    #panelHeader:active { cursor: grabbing; }

    #panelBody {
      padding: 8px 10px;
      overflow: auto;
      font-size: 11px;
    }

    .btnRow {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-top: 6px;
    }
    button {
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.18);
      color: #fff;
      border-radius: 10px;
      padding: 6px 8px;
      font-size: 11px;
      cursor: pointer;
    }
    button:active { transform: scale(0.98); }

    #togglePanelBtn {
      position: fixed;
      right: 8px;
      bottom: 12px;
      z-index: 200;
      border-radius: 999px;
      padding: 10px 12px;
      font-size: 12px;
      background: rgba(0,0,0,0.6);
      border: 1px solid rgba(255,255,255,0.18);
      backdrop-filter: blur(8px);
      color: #fff;
    }

    /* Build Menu popup */
    #buildMenu {
      position: fixed;
      left: 50%;
      top: 55%;
      transform: translate(-50%, -50%);
      width: min(360px, 92vw);
      max-height: 55vh;
      background: rgba(0,0,0,0.82);
      border: 1px solid rgba(255,255,255,0.18);
      border-radius: 16px;
      color: #fff;
      z-index: 300;
      display: none;
      overflow: hidden;
      box-shadow: 0 15px 40px rgba(0,0,0,0.45);
      backdrop-filter: blur(10px);
    }
    #buildMenuHeader {
      padding: 10px;
      font-size: 13px;
      background: rgba(255,255,255,0.06);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #buildMenuBody {
      padding: 10px;
      overflow: auto;
      font-size: 11px;
    }
    .buildItem {
      padding: 8px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.12);
      margin-bottom: 8px;
      background: rgba(255,255,255,0.04);
    }
    .buildItemTitle {
      font-size: 12px;
      font-weight: bold;
      margin-bottom: 4px;
    }
    .buildCost {
      opacity: 0.9;
      margin-bottom: 6px;
    }

    /* Chat bubble */
    #assistantChat {
      position: fixed;
      left: 10px;
      bottom: 85px;
      width: min(320px, 80vw);
      max-height: 22vh;
      background: rgba(0,0,0,0.72);
      border: 1px solid rgba(255,255,255,0.18);
      border-radius: 14px;
      color: #fff;
      z-index: 250;
      overflow: hidden;
      display: none;
      backdrop-filter: blur(10px);
      box-shadow: 0 12px 30px rgba(0,0,0,0.4);
    }
    #assistantChatHeader {
      padding: 8px 10px;
      font-size: 12px;
      background: rgba(255,255,255,0.06);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #assistantChatBody {
      padding: 8px 10px;
      font-size: 11px;
      overflow: auto;
      max-height: 12vh;
    }
    #assistantChatInputRow {
      display: flex;
      gap: 6px;
      padding: 8px 10px;
      border-top: 1px solid rgba(255,255,255,0.12);
    }
    #assistantInput {
      flex: 1;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      color: #fff;
      padding: 6px 8px;
      font-size: 12px;
      outline: none;
    }

    /* Planet select */
    #planetSelect {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.82);
      z-index: 999;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      color: #fff;
      padding: 16px;
      backdrop-filter: blur(10px);
    }
    .planetCard {
      width: min(380px, 92vw);
      padding: 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(255,255,255,0.06);
      margin-bottom: 10px;
    }
    .planetTitle {
      font-size: 14px;
      font-weight: bold;
      margin-bottom: 6px;
    }
    .planetDesc {
      font-size: 11px;
      opacity: 0.9;
      margin-bottom: 8px;
    }

    /* Login Overlay */
    #loginOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.93);
      z-index: 9999;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      color: #fff;
      padding: 20px;
    }
    .loginBox {
      width: min(360px, 90vw);
      background: rgba(20,25,40,0.9);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 16px;
      padding: 24px;
    }
    .loginBox h2 {
      text-align: center;
      margin-bottom: 16px;
      font-size: 16px;
    }
    .loginBox input {
      width: 100%;
      box-sizing: border-box;
      padding: 10px 12px;
      margin-bottom: 10px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.15);
      background: rgba(0,0,0,0.4);
      color: #fff;
      font-size: 14px;
    }
    .loginBox button {
      width: 100%;
      padding: 10px;
      border-radius: 10px;
      background: #4a6cf7;
      color: #fff;
      border: none;
      font-size: 14px;
      font-weight: bold;
    }
    .devNote {
      text-align: center;
      margin-top: 10px;
      font-size: 11px;
      opacity: 0.7;
    }

    /* tiny helper */
    .muted { opacity: 0.85; font-size: 10px; }
    .danger { color: #ff9aa2; }
    .ok { color: #a8ffb8; }
  </style>
</head>

<body>

<!-- ç™»å…¥ç•Œé¢ï¼ˆæˆ‘åŠ å˜…ï¼Œå®Œå…¨å””å½±å“ä½ åŸç‰ˆï¼‰ -->
<div id="loginOverlay">
  <div class="loginBox">
    <h2>ğŸ” AENO ç™»å…¥</h2>
    <input type="text" id="loginID" placeholder="è¼¸å…¥ä½ çš„å¸³è™Ÿ">
    <input type="password" id="loginPwd" placeholder="è¼¸å…¥å¯†ç¢¼">
    <button id="loginBtn">é€²å…¥éŠæˆ²</button>
    <div class="devNote">é–‹ç™¼è€…ï¼šé˜¿å‹’é “</div>
  </div>
</div>

  <canvas id="game"></canvas>

  <div id="hudTop">
    <div class="hudBox" id="hudLeft">
      <div class="hudRow">
        <span class="pill">ğŸŒ <span id="planetName">?</span></span>
        <span class="pill">â±ï¸ <span id="gameYear">0</span> å¹´</span>
        <span class="pill">ğŸ‘¥ <span id="popCount">0</span></span>
      </div>
      <div class="hudRow" style="margin-top:4px;">
        <span class="pill">ğŸª™ é‡‘å¹£: <span id="coins">0</span></span>
        <span class="pill">ğŸŸ¡ AENO: <span id="aeno">0.0000</span></span>
      </div>
    </div>

    <div class="hudBox" id="hudRight">
      <div class="hudRow">
        <span class="pill">ğŸªµ æœ¨: <span id="wood">0</span></span>
        <span class="pill">ğŸª¨ çŸ³: <span id="stone">0</span></span>
        <span class="pill">â›ï¸ éµ: <span id="iron">0</span></span>
        <span class="pill">ğŸŒ¾ ç³§: <span id="food">0</span></span>
      </div>
      <div class="hudRow" style="margin-top:4px;">
        <span class="pill">âš™ï¸ å·¥å» : <span id="factoryCount">0</span></span>
        <span class="pill">ğŸ¤– æ©Ÿå™¨äºº: <span id="robotCount">0</span></span>
      </div>
    </div>
  </div>

  <button id="togglePanelBtn">ğŸ“Œ é¢æ¿</button>

  <div id="panel">
    <div id="panelHeader">
      <span>ğŸ“Œ æ§åˆ¶ä¸­å¿ƒ</span>
      <span>
        <button id="btnSave">ä¿å­˜</button>
        <button id="btnHidePanel">æ”¶èµ·</button>
      </span>
    </div>
    <div id="panelBody">
      <div><b>æç¤ºï¼š</b>é»ä½ é ˜åœŸç©ºåœ°å¯ä»¥å»ºç¯‰ã€‚</div>
      <div class="muted">Zoom: é›™æŒ‡ç¸®æ”¾ / æ»¾è¼ªã€‚æ‹–åœ°åœ–ï¼šä¸€æŒ‡æ‹–ã€‚</div>

      <div class="btnRow">
        <button id="btnBuildMode">ğŸ—ï¸ å»ºç¯‰æ¨¡å¼</button>
        <button id="btnUpgradeMode">â¬†ï¸ å‡ç´šæ¨¡å¼</button>
        <button id="btnAuto">ğŸ¤– è‡ªå‹•å»ºé€ : <span id="autoState">ON</span></button>
      </div>

      <div class="btnRow">
        <button id="btnAdSong">ğŸµ æ’­æ”¾å»£å‘Šæ­Œ</button>
        <button id="btnLoopSong">ğŸ” Loop: <span id="loopState">ON</span></button>
      </div>

      <div class="btnRow">
        <button id="btnRobotSend">ğŸš€ æ´¾æ©Ÿå™¨äººæ¢ç´¢</button>
        <button id="btnExchange">ğŸ¦ äº¤æ˜“æ‰€</button>
        <button id="btnTech">ğŸ§¬ ç§‘æŠ€æ¨¹</button>
      </div>

      <div style="margin-top:10px;">
        <b>AIåŠ©æ‰‹å„ªå…ˆé †åºï¼š</b>
        <div class="btnRow">
          <button class="prioBtn" data-prio="house">ğŸ  æˆ¿å±‹</button>
          <button class="prioBtn" data-prio="lumber">ğŸªµ ä¼æœ¨</button>
          <button class="prioBtn" data-prio="mine">â›ï¸ ç¤¦å ´</button>
          <button class="prioBtn" data-prio="farm">ğŸŒ¾ è¾²ç”°</button>
          <button class="prioBtn" data-prio="market">ğŸª å¸‚å ´</button>
        </div>
        <div class="muted">ç›®å‰å„ªå…ˆï¼š<span id="prioNow">ğŸ  æˆ¿å±‹</span></div>
      </div>

      <div style="margin-top:10px;">
        <b>ç³»çµ±è¨Šæ¯ï¼š</b>
        <div id="logBox" style="margin-top:6px; max-height: 8vh; overflow:auto; font-size: 11px; opacity:0.92;"></div>
      </div>
    </div>
  </div>

  <div id="buildMenu">
    <div id="buildMenuHeader">
      <span>ğŸ—ï¸ å»ºç¯‰é¸å–®</span>
      <button id="closeBuildMenu">é—œé–‰</button>
    </div>
    <div id="buildMenuBody"></div>
  </div>

  <div id="assistantChat">
    <div id="assistantChatHeader">
      <span>ğŸ¾ AENO AI åŠ©æ‰‹</span>
      <button id="closeChat">æ”¶èµ·</button>
    </div>
    <div id="assistantChatBody"></div>
    <div id="assistantChatInputRow">
      <input id="assistantInput" placeholder="è¼¸å…¥æŒ‡ä»¤ï¼šå·¡é‚ / æ”¶é›† / å»ºé€  / å‡ç´š..." />
      <button id="sendAssistant">é€å‡º</button>
    </div>
  </div>

  <div id="planetSelect">
    <div style="font-size:18px; font-weight:bold; margin-bottom:10px;">ğŸŒŒ AENO V3 é¸æ“‡æ˜Ÿçƒ</div>

    <div class="planetCard">
      <div class="planetTitle">ğŸŸ© Planet-01 ç¶ åŸæ˜Ÿ</div>
      <div class="planetDesc">æ£®æ—å¤šï¼Œé©åˆæ–°æ‰‹ã€‚æœ¨æç”¢å‡ºé«˜ã€‚</div>
      <button onclick="startGame('Planet-01', 'forest')">é€²å…¥</button>
    </div>

    <div class="planetCard">
      <div class="planetTitle">ğŸŸ« Planet-02 å²©çŸ³æ˜Ÿ</div>
      <div class="planetDesc">çŸ³é ­å¤šï¼Œå»ºç¯‰æ›´å¿«ï¼Œåœ°å½¢å´å¶‡ã€‚</div>
      <button onclick="startGame('Planet-02', 'rock')">é€²å…¥</button>
    </div>

    <div class="planetCard">
      <div class="planetTitle">âš™ï¸ Planet-03 å·¥æ¥­æ˜Ÿ</div>
      <div class="planetDesc">éµç¤¦å¤šï¼Œé©åˆæ©Ÿå™¨äººèˆ‡å·¥å» æ–‡æ˜ã€‚</div>
      <button onclick="startGame('Planet-03', 'iron')">é€²å…¥</button>
    </div>

    <div class="planetCard">
      <div class="planetTitle">ğŸŒ¾ Planet-04 è¾²ç‰§æ˜Ÿ</div>
      <div class="planetDesc">ç³§é£Ÿè±å¯Œï¼Œäººå£æˆé•·å¿«ã€‚</div>
      <button onclick="startGame('Planet-04', 'farm')">é€²å…¥</button>
    </div>

    <div class="planetCard" id="devBlackHoleCard" style="border-color: rgba(255,255,255,0.3); background: rgba(80,0,120,0.22); display:none;">
      <div class="planetTitle">ğŸ•³ï¸ é»‘æ´å­¤å³¶ï¼ˆDeveloper Islandï¼‰</div>
      <div class="planetDesc">ç‰¹æ®Šæ˜ŸåŸŸã€‚æœªä¾†ç§»æ°‘ç³»çµ±ã€ç”³è«‹åˆ¶åº¦æœƒç”±æ­¤é–‹å§‹ã€‚</div>
      <button onclick="startGame('BlackHole-Island', 'blackhole')">é€²å…¥</button>
    </div>

    <div class="muted" style="margin-top:10px; text-align:center;">
      âš ï¸ éŠæˆ²æœƒè‡ªå‹•ä¿å­˜ã€‚æ›´æ–°ç‰ˆæœ¬å¾Œä»å¯ä¿ç•™é€²åº¦ã€‚<br/>
      éŸ³æ¨‚éœ€æ‰‹å‹•é»æ“Šæ’­æ”¾ï¼ˆæ‰‹æ©Ÿé™åˆ¶ï¼‰ã€‚
    </div>
  </div>

<script>
// ==========================
// æˆ‘åŠ å˜…ï¼šç™»å…¥ & æ¬Šé™é‚è¼¯
// å®Œå…¨å””æ”¹ä½ åŸç‰ˆä»»ä½•åŠŸèƒ½
// ==========================
let isDeveloper = false;
const DEV_NAME = "é˜¿å‹’é “";

document.getElementById("loginBtn").onclick = function(){
  const id = document.getElementById("loginID").value.trim();
  const pwd = document.getElementById("loginPwd").value.trim();

  if(id === ""){
    alert("è«‹è¼¸å…¥å¸³è™Ÿ");
    return;
  }

  // åˆ¤æ–·é–‹ç™¼è€…ï¼šåªç‡å€‹åï¼Œå¯†ç¢¼ä½ å¾Œå°è‡ªå·±è™•ç†
  if(id === DEV_NAME){
    isDeveloper = true;
    document.getElementById("devBlackHoleCard").style.display = "block";
  } else {
    isDeveloper = false;
  }

  // ç™»å…¥æˆåŠŸï¼Œéš±è—ç™»å…¥ç•«é¢
  document.getElementById("loginOverlay").style.display = "none";
};

// ç©å®¶ç¶å®šæ˜Ÿçƒï¼šç¬¬ä¸€æ¬¡é¸å’—å°±æ°¸é ç”¨è¿”å€‹å€‹
let savedPlanet = localStorage.getItem("SAVED_PLANET");
if(savedPlanet){
  // è‡ªå‹•è·³è½‰å»ä½¢æ€å’—å˜…æ˜Ÿçƒ
  document.getElementById("planetSelect").style.display = "none";
  setTimeout(()=>{
    startGame(savedPlanet, "saved");
  }, 100);
}

// è¦†è“‹ä½ å˜… startGameï¼Œè¨˜ä½æ˜Ÿçƒ
const _startGame = window.startGame;
window.startGame = function(planetName, seedType){
  if(planetName !== "BlackHole-Island"){
    localStorage.setItem("SAVED_PLANET", planetName);
  }
  _startGame(planetName, seedType);
};
</script>

<script>
(() => {
  "use strict";

  // ==========================================================
  // SAFE UTILITIES
  // ==========================================================
  const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
  const rand = (a, b) => a + Math.random() * (b - a);
  const irand = (a, b) => Math.floor(rand(a, b + 1));

  function nowMs(){ return Date.now(); }

  function drawRoundedRect(ctx, x, y, w, h, r) {
    r = Math.min(r, w/2, h/2);
    ctx.beginPath();
    ctx.moveTo(x + r, y);
    ctx.arcTo(x + w, y, x + w, y + h, r);
    ctx.arcTo(x + w, y + h, x, y + h, r);
    ctx.arcTo(x, y + h, x, y, r);
    ctx.arcTo(x, y, x + w, y, r);
    ctx.closePath();
  }

  // ==========================================================
  // GAME CONSTANTS
  // ==========================================================
  const STORAGE_KEY = "AENO_V3_SAVE_SINGLEFILE_2026";
  const GAME_SPEED_YEAR_PER_REALDAY = 10;
  const MS_PER_DAY = 24*60*60*1000;

  const OFFLINE_CAP_MS = 24 * 60 * 60 * 1000;

  // ==========================================================
  // CANVAS SETUP
  // ==========================================================
  const canvas = document.getElementById("game");
  const ctx = canvas.getContext("2d");

  let W = 0, H = 0;
  function resize() {
    const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    canvas.width = Math.floor(window.innerWidth * dpr);
    canvas.height = Math.floor(window.innerHeight * dpr);
    canvas.style.width = window.innerWidth + "px";
    canvas.style.height = window.innerHeight + "px";
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    W = window.innerWidth;
    H = window.innerHeight;
  }
  window.addEventListener("resize", resize);
  resize();

  // ==========================================================
  // UI ELEMENTS
  // ==========================================================
  const elPlanetName = document.getElementById("planetName");
  const elGameYear = document.getElementById("gameYear");
  const elPopCount = document.getElementById("popCount");
  const elCoins = document.getElementById("coins");
  const elAeno = document.getElementById("aeno");
  const elWood = document.getElementById("wood");
  const elStone = document.getElementById("stone");
  const elIron = document.getElementById("iron");
  const elFood = document.getElementById("food");
  const elFactoryCount = document.getElementById("factoryCount");
  const elRobotCount = document.getElementById("robotCount");

  const panel = document.getElementById("panel");
  const panelHeader = document.getElementById("panelHeader");
  const panelBody = document.getElementById("panelBody");
  const togglePanelBtn = document.getElementById("togglePanelBtn");

  const btnHidePanel = document.getElementById("btnHidePanel");
  const btnSave = document.getElementById("btnSave");
  const logBox = document.getElementById("logBox");

  const btnBuildMode = document.getElementById("btnBuildMode");
  const btnUpgradeMode = document.getElementById("btnUpgradeMode");
  const btnAuto = document.getElementById("btnAuto");
  const autoState = document.getElementById("autoState");

  const btnAdSong = document.getElementById("btnAdSong");
  const btnLoopSong = document.getElementById("btnLoopSong");
  const loopState = document.getElementById("loopState");

  const btnRobotSend = document.getElementById("btnRobotSend");
  const btnExchange = document.getElementById("btnExchange");
  const btnTech = document.getElementById("btnTech");

  const buildMenu = document.getElementById("buildMenu");
  const buildMenuBody = document.getElementById("buildMenuBody");
  const closeBuildMenu = document.getElementById("closeBuildMenu");

  const assistantChat = document.getElementById("assistantChat");
  const assistantChatBody = document.getElementById("assistantChatBody");
  const closeChat = document.getElementById("closeChat");
  const assistantInput = document.getElementById("assistantInput");
  const sendAssistant = document.getElementById("sendAssistant");

  const prioNow = document.getElementById("prioNow");

  // ==========================================================
  // LOG SYSTEM
  // ==========================================================
  function log(msg, type="") {
    const div = document.createElement("div");
    div.textContent = msg;
    if (type === "danger") div.style.color = "#ff9aa2";
    if (type === "ok") div.style.color = "#a8ffb8";
    logBox.prepend(div);
    while (logBox.children.length > 40) logBox.removeChild(logBox.lastChild);
  }

  // ==========================================================
  // AUDIO (Ad Song)
  // ==========================================================
  let audioCtx = null;
  let isPlayingSong = false;
  let songLoop = true;
  let songTimer = null;

  function ensureAudio() {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }

  function playAdSong() {
    try {
      ensureAudio();
      if (audioCtx.state === "suspended") audioCtx.resume();

      stopAdSong();

      isPlayingSong = true;
      log("ğŸµ å»£å‘Šæ­Œæ’­æ”¾ä¸­ï¼ˆå¯Loopï¼‰", "ok");

      const base = audioCtx.currentTime;
      const notes = [
        261.63, 293.66, 329.63, 392.00,
        392.00, 329.63, 293.66, 261.63,
        293.66, 329.63, 392.00, 523.25,
        440.00, 392.00, 329.63, 293.66
      ];

      const durationPer = 0.25;
      const totalDur = notes.length * durationPer;

      for (let i = 0; i < notes.length; i++) {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();

        osc.type = "triangle";
        osc.frequency.value = notes[i];

        gain.gain.setValueAtTime(0.0001, base + i * durationPer);
        gain.gain.exponentialRampToValueAtTime(0.12, base + i * durationPer + 0.02);
        gain.gain.exponentialRampToValueAtTime(0.0001, base + i * durationPer + durationPer);

        osc.connect(gain);
        gain.connect(audioCtx.destination);

        osc.start(base + i * durationPer);
        osc.stop(base + i * durationPer + durationPer);
      }

      if (songLoop) {
        songTimer = setTimeout(() => {
          if (isPlayingSong) playAdSong();
        }, totalDur * 1000);
      }

    } catch(e) {
      log("âš ï¸ æ’­æ”¾éŸ³æ¨‚å¤±æ•—ï¼ˆæ‰‹æ©ŸChromeéœ€é»æ“Šå…è¨±éŸ³è¨Šï¼‰", "danger");
    }
  }

  function stopAdSong() {
    isPlayingSong = false;
    if (songTimer) clearTimeout(songTimer);
    songTimer = null;
  }

  // ==========================================================
  // GAME STATE
  // ==========================================================
  const defaultState = () => ({
    version: 3,
    planet: "Planet-01",
    seedType: "forest",

    lastSaveAt: nowMs(),
    lastTickAt: nowMs(),

    year: 0,

    coins: 2000,
    aeno: 0.0,

    wood: 800,
    stone: 800,
    iron: 800,
    food: 800,

    population: 4,
    workers: 4,
    robots: 0,

    territoryRadius: 140,
    territoryLevel: 1,

    buildings: [
      { type:"house", x: -40, y: 20, level: 1 },
      { type:"house", x: 40, y: 20, level: 1 },
    ],

    beasts: [],
    animals: [],
    workersUnits: [],
    assistant: { x: 0, y: -40, mood: "happy" },

    camera: { x: 0, y: 0, zoom: 1.0 },

    autoBuild: true,
    buildPriority: "house",

    buildMode: false,
    upgradeMode: false,

    offlineStop: false,

    world: {
      forests: [],
      rocks: [],
      irons: [],
      rivers: [],
      mountains: []
    }
  });

  let state = null;

  function safeLoad() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return null;
      const data = JSON.parse(raw);
      if (!data || typeof data !== "object") return null;
      return data;
    } catch(e) {
      return null;
    }
  }

  function safeSave() {
    try {
      state.lastSaveAt = nowMs();
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      log("ğŸ’¾ å·²ä¿å­˜é€²åº¦", "ok");
    } catch(e) {
      log("âš ï¸ ä¿å­˜å¤±æ•—ï¼ˆlocalStorageè¢«ç¦ç”¨ï¼‰", "danger");
    }
  }

  function deepMerge(target, source) {
    for (const k in source) {
      if (source[k] && typeof source[k] === "object" && !Array.isArray(source[k])) {
        if (!target[k] || typeof target[k] !== "object") target[k] = {};
        deepMerge(target[k], source[k]);
      } else {
        if (target[k] === undefined) target[k] = source[k];
      }
    }
    return target;
  }

  function ensureWorldGenerated() {
    const w = state.world;
    if (!w.forests || w.forests.length < 15) {
      w.forests = [];
      for (let i=0;i<24;i++) {
        w.forests.push({ x: irand(-900,900), y: irand(-900,900), r: irand(30,80) });
      }
    }
    if (!w.rocks || w.rocks.length < 12) {
      w.rocks = [];
      for (let i=0;i<18;i++) {
        w.rocks.push({ x: irand(-900,900), y: irand(-900,900), r: irand(20,60) });
      }
    }
    if (!w.irons || w.irons.length < 10) {
      w.irons = [];
      for (let i=0;i<14;i++) {
        w.irons.push({ x: irand(-900,900), y: irand(-900,900), r: irand(18,50) });
      }
    }
    if (!w.mountains || w.mountains.length < 10) {
      w.mountains = [];
      for (let i=0;i<16;i++) {
        w.mountains.push({ x: irand(-950,950), y: irand(-950,950), r: irand(40,110) });
      }
    }
    if (!w.rivers || w.rivers.length < 2) {
      w.rivers = [];
      for (let i=0;i<3;i++) {
        w.rivers.push({
          x1: irand(-900,900), y1: irand(-900,900),
          x2: irand(-900,900), y2: irand(-900,900)
        });
      }
    }
  }

  function spawnLife() {
    if (!state.animals || state.animals.length < 10) {
      state.animals = [];
      for (let i=0;i<12;i++) {
        state.animals.push({ x: irand(-500,500), y: irand(-500,500), vx: rand(-0.4,0.4), vy: rand(-0.4,0.4), t: 0 });
      }
    }

    if (!state.beasts || state.beasts.length < 6) {
      state.beasts = [];
      for (let i=0;i<8;i++) {
        state.beasts.push({ x: irand(-650,650), y: irand(-650,650), vx: rand(-0.3,0.3), vy: rand(-0.3,0.3), hp: 100 });
      }
    }

    if (!state.workersUnits || state.workersUnits.length < state.workers) {
      state.workersUnits = [];
      for (let i=0;i<state.workers;i++) {
        state.workersUnits.push({ x: irand(-60,60), y: irand(-60,60), tx: irand(-200,200), ty: irand(-200,200), mode:"idle" });
      }
    }
  }

  // ==========================================================
  // BUILDINGS
  // ==========================================================
  const BUILDINGS = {
    house: {
      name: "æˆ¿å±‹",
      desc: "å¢åŠ äººå£ä¸Šé™èˆ‡ç¨…æ”¶ã€‚",
      baseCost: { coins: 200, wood: 120, stone: 80, iron: 0, food: 0 },
      income: { coins: 2, food: 0, wood: 0, stone: 0, iron: 0 },
    },
    lumber: {
      name: "ä¼æœ¨å ´",
      desc: "ç”¢å‡ºæœ¨æã€‚",
      baseCost: { coins: 250, wood: 80, stone: 50, iron: 0, food: 0 },
      income: { wood: 5 }
    },
    mine: {
      name: "ç¤¦å ´",
      desc: "ç”¢å‡ºçŸ³é ­èˆ‡éµã€‚",
      baseCost: { coins: 350, wood: 60, stone: 120, iron: 0, food: 0 },
      income: { stone: 3, iron: 2 }
    },
    farm: {
      name: "è¾²ç”°",
      desc: "ç”¢å‡ºç³§é£Ÿï¼Œæ”¯æŒäººå£æˆé•·ã€‚",
      baseCost: { coins: 220, wood: 70, stone: 40, iron: 0, food: 0 },
      income: { food: 6 }
    },
    factory: {
      name: "å·¥å» ",
      desc: "ç”Ÿç”¢æ©Ÿå™¨äººç¢ç‰‡èˆ‡å·¥æ¥­ç”¢èƒ½ã€‚",
      baseCost: { coins: 800, wood: 120, stone: 200, iron: 120, food: 0 },
      income: { coins: 4, iron: 1 }
    },
    market: {
      name: "å¸‚å ´",
      desc: "æä¾›é‡‘å¹£æ”¶å…¥ï¼Œæ”¯æ´äº¤æ˜“æ‰€ã€‚",
      baseCost: { coins: 500, wood: 120, stone: 100, iron: 20, food: 0 },
      income: { coins: 8 }
    }
  };

  function buildingCost(type, level) {
    const b = BUILDINGS[type];
    const mul = Math.pow(1.55, level-1);
    return {
      coins: Math.floor((b.baseCost.coins||0) * mul),
      wood: Math.floor((b.baseCost.wood||0) * mul),
      stone: Math.floor((b.baseCost.stone||0) * mul),
      iron: Math.floor((b.baseCost.iron||0) * mul),
      food: Math.floor((b.baseCost.food||0) * mul),
    };
  }

  function canAfford(cost) {
    return state.coins >= cost.coins &&
           state.wood >= cost.wood &&
           state.stone >= cost.stone &&
           state.iron >= cost.iron &&
           state.food >= cost.food;
  }

  function pay(cost) {
    state.coins -= cost.coins;
    state.wood -= cost.wood;
    state.stone -= cost.stone;
    state.iron -= cost.iron;
    state.food -= cost.food;
  }

  function addBuilding(type, x, y) {
    const cost = buildingCost(type, 1);
    if (!canAfford(cost)) {
      log("âŒ è³‡æºä¸è¶³ï¼Œç„¡æ³•å»ºé€  " + BUILDINGS[type].name, "danger");
      return false;
    }

    pay(cost);
    state.buildings.push({ type, x, y, level: 1 });
    log("ğŸ—ï¸ å»ºé€ æˆåŠŸï¼š" + BUILDINGS[type].name, "ok");

    if (type === "house") {
      state.population += 2;
      state.workers += 1;
      spawnLife();
    }

    return true;
  }

  function upgradeBuildingAt(x, y) {
    const b = findBuildingNear(x, y, 40);
    if (!b) {
      log("â¬†ï¸ é€™è£¡æ²’æœ‰å¯å‡ç´šå»ºç¯‰", "danger");
      return;
    }
    const nextLevel = b.level + 1;
    const cost = buildingCost(b.type, nextLevel);

    if (!canAfford(cost)) {
      log("âŒ å‡ç´šè³‡æºä¸è¶³ï¼š" + BUILDINGS[b.type].name + " Lv." + nextLevel, "danger");
      return;
    }

    pay(cost);
    b.level = nextLevel;
    log("â¬†ï¸ å‡ç´šæˆåŠŸï¼š" + BUILDINGS[b.type].name + " Lv." + b.level, "ok");
  }

  function findBuildingNear(x, y, dist=40) {
    let best = null;
    let bestD = 1e9;
    for (const b of state.buildings) {
      const dx = b.x - x;
      const dy = b.y - y;
      const d = Math.sqrt(dx*dx+dy*dy);
      if (d < dist && d < bestD) {
        bestD = d;
        best = b;
      }
    }
    return best;
  }

  // ==========================================================
  // TERRITORY
  // ==========================================================
  function isInsideTerritory(wx, wy) {
    const r = state.territoryRadius;
    return (wx*wx + wy*wy) <= r*r;
  }

  function expandTerritoryAuto() {
    const cost = 120 + state.territoryLevel * 80;
    if (state.coins >= cost) {
      state.coins -= cost;
      state.territoryLevel += 1;
      state.territoryRadius += 25;
      log("ğŸ—ºï¸ é ˜åœŸæ“´å¤§ï¼(Lv." + state.territoryLevel + ")", "ok");
    }
  }

  // ==========================================================
  // AI ASSISTANT
  // ==========================================================
  function assistantSay(msg) {
    const div = document.createElement("div");
    div.textContent = "ğŸ¾ " + msg;
    assistantChatBody.appendChild(div);
    assistantChatBody.scrollTop = assistantChatBody.scrollHeight;
  }

  function handleAssistantCommand(text) {
    const t = text.trim().toLowerCase();
    if (!t) return;

    assistantSay("æ”¶åˆ°æŒ‡ä»¤ï¼šã€Œ" + text + "ã€");

    if (t.includes("å·¡é‚")) {
      assistantSay("æˆ‘æœƒå·¡é‚é ˜åœŸé‚Šç•Œï¼Œé©…è¶•é‡ç¸ã€‚");
      state.assistant.mood = "guard";
    } else if (t.includes("æ”¶é›†")) {
      assistantSay("æˆ‘æœƒæŒ‡æ®å·¥äººåŠ é€Ÿæ”¶é›†è³‡æºã€‚");
      state.assistant.mood = "collect";
    } else if (t.includes("å»ºé€ ")) {
      assistantSay("æˆ‘æœƒé–‹å§‹å»ºé€ å„ªå…ˆå»ºç¯‰ã€‚");
      state.autoBuild = true;
    } else if (t.includes("åœæ­¢") || t.includes("åœ")) {
      assistantSay("å·²åœæ­¢è‡ªå‹•å»ºé€ ã€‚");
      state.autoBuild = false;
    } else if (t.includes("å‡ç´š")) {
      assistantSay("æˆ‘æœƒå„ªå…ˆå‡ç´šé‡è¦å»ºç¯‰ã€‚");
      state.buildPriority = "upgrade";
    } else {
      assistantSay("æˆ‘æ˜ç™½ï¼Œä½†éœ€è¦æ›´æ˜ç¢ºæŒ‡ä»¤ï¼Œä¾‹å¦‚ï¼šå»ºé€  æˆ¿å±‹ / åœæ­¢ / å·¡é‚ / æ”¶é›†");
    }
  }

  // ==========================================================
  // AENO PRODUCTION
  // ==========================================================
  const AENO_MAP = "KLMNOPQRST";
  function secretEncodeDigit(d) {
    if (d === 0) return AENO_MAP[9];
    return AENO_MAP[d-1];
  }
  function secretDecodeChar(c) {
    const idx = AENO_MAP.indexOf(c);
    if (idx === 9) return 0;
    if (idx >= 0) return idx+1;
    return 0;
  }

  function hiddenAenoGainFactor() {
    const base = 1 + (state.population * 0.01) + (state.robots * 0.02);
    const t = Math.floor((nowMs() / 1000) % 10);
    const c = secretEncodeDigit(t);
    const n = secretDecodeChar(c);
    return base * (1 + n * 0.003);
  }

  function gainAenoFragments(seconds, adBoost=false) {
    let rate = 0.0000025;
    if (adBoost) rate *= 4.5;
    rate *= hiddenAenoGainFactor();

    const learningBonus = 1 + (Math.min(1, (state.population / 50)) * 0.35);
    rate *= learningBonus;

    state.aeno += rate * seconds;

    if (state.aeno < 0) state.aeno = 0;
  }

  // ==========================================================
  // ECONOMY TICK
  // ==========================================================
  function buildingIncomePerSecond(b) {
    const def = BUILDINGS[b.type];
    const lvlMul = Math.pow(1.35, b.level-1);
    const income = def.income || {};
    return {
      coins: (income.coins || 0) * lvlMul,
      wood: (income.wood || 0) * lvlMul,
      stone: (income.stone || 0) * lvlMul,
      iron: (income.iron || 0) * lvlMul,
      food: (income.food || 0) * lvlMul
    };
  }

  function tickEconomy(dtSec) {
    let c=0,w=0,s=0,i=0,f=0;
    for (const b of state.buildings) {
      const inc = buildingIncomePerSecond(b);
      c += inc.coins;
      w += inc.wood;
      s += inc.stone;
      i += inc.iron;
      f += inc.food;
    }

    c += state.population * 0.08;

    state.coins += c * dtSec;
    state.wood += w * dtSec;
    state.stone += s * dtSec;
    state.iron += i * dtSec;
    state.food += f * dtSec;

    state.coins = Math.floor(state.coins);
    state.wood = Math.floor(state.wood);
    state.stone = Math.floor(state.stone);
    state.iron = Math.floor(state.iron);
    state.food = Math.floor(state.food);

    const yearRate = GAME_SPEED_YEAR_PER_REALDAY / MS_PER_DAY;
    const yearAdd = dtSec * 1000 * yearRate;
    state.year += yearAdd;

    const foodCost = state.population * 0.02 * dtSec;
    state.food = Math.max(0, state.food - foodCost);

    if (isPlayingSong) gainAenoFragments(dtSec, true);
    else gainAenoFragments(dtSec, false);

    if (Math.random() < dtSec * 0.01) expandTerritoryAuto();
  }

  // ==========================================================
  // AUTOBUILD AI
  // ==========================================================
  function autoBuildTick() {
    if (!state.autoBuild) return;

    if (Math.random() > 0.25) return;

    const pr = state.buildPriority;

    const countType = (t) => state.buildings.filter(b=>b.type===t).length;

    let want = pr;

    if (pr === "upgrade") {
      const b = state.buildings.reduce((min, cur) => cur.level < min.level ? cur : min, state.buildings[0]);
      if (b) {
        const cost = buildingCost(b.type, b.level+1);
        if (canAfford(cost)) {
          pay(cost);
          b.level++;
          log("ğŸ¤– åŠ©æ‰‹è‡ªå‹•å‡ç´šï¼š" + BUILDINGS[b.type].name + " Lv." + b.level, "ok");
        }
      }
      return;
    }

    if (state.food < 200) want = "farm";
    if (state.wood < 200) want = "lumber";
    if (state.stone < 200 || state.iron < 200) want = "mine";
    if (state.coins < 300) want = "market";

    if (countType("house") < 2) want = "house";
    if (countType("farm") < 1) want = "farm";
    if (countType("lumber") < 1) want = "lumber";
    if (countType("mine") < 1) want = "mine";

    const tries = 8;
    for (let t=0;t<tries;t++) {
      const x = irand(-state.territoryRadius+40, state.territoryRadius-40);
      const y = irand(-state.territoryRadius+40, state.territoryRadius-40);
      if (!isInsideTerritory(x,y)) continue;
      if (findBuildingNear(x,y,45)) continue;

      const ok = addBuilding(want, x, y);
      if (ok) return;
    }
  }

  // ==========================================================
  // ROBOT EXPLORE
  // ==========================================================
  function sendRobotExplore() {
    if (state.robots <= 0) {
      log("ğŸ¤– ä½ æ²’æœ‰æ©Ÿå™¨äººï¼ˆéœ€è¦å·¥å» å‡ç´šå¾Œç²å¾—ï¼‰", "danger");
      return;
    }
    log("ğŸš€ æ©Ÿå™¨äººå‡ºç™¼æ¢ç´¢æ˜Ÿçƒ...", "ok");

    const gainCoins = irand(60,200);
    const gainRes = irand(30,150);

    state.coins += gainCoins;
    state.wood += gainRes;
    state.st
