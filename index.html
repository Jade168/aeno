<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AENO - ä¸–ç•Œè‚²æˆ Alpha</title>
  <style>
    body {
      margin: 0;
      background: #070a10;
      color: #e7f0ff;
      font-family: Arial, sans-serif;
      overflow-x: hidden;
    }
    header {
      padding: 14px 14px;
      background: #0d1420;
      border-bottom: 1px solid #1c2b3d;
    }
    header h1 {
      margin: 0;
      font-size: 20px;
      letter-spacing: 1px;
    }
    header .sub {
      font-size: 12px;
      opacity: 0.8;
      margin-top: 6px;
    }
    .wrap {
      padding: 12px;
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
      max-width: 1000px;
      margin: auto;
    }
    .card {
      background: #0d1420;
      border: 1px solid #1c2b3d;
      border-radius: 14px;
      padding: 12px;
      box-shadow: 0 0 20px rgba(0,0,0,0.35);
    }
    .row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .btn {
      border: none;
      padding: 10px 12px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: bold;
      background: #2d7dff;
      color: white;
      font-size: 13px;
      transition: 0.2s;
    }
    .btn:hover { transform: scale(1.02); }
    .btn:active { opacity: 0.75; transform: scale(0.98); }
    .btn2 {
      background: #1b2638;
      border: 1px solid #2b3e58;
    }
    .btnDanger {
      background: #ff3b3b;
    }
    .grid2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .grid3 {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
    }
    .stat {
      background: #0a101a;
      border: 1px solid #1c2b3d;
      border-radius: 14px;
      padding: 10px;
      font-size: 13px;
    }
    .stat b {
      font-size: 12px;
      opacity: 0.75;
      display: block;
      margin-bottom: 4px;
    }
    .stat span {
      font-size: 15px;
      font-weight: bold;
    }
    .log {
      background: #070c14;
      border: 1px solid #1c2b3d;
      border-radius: 14px;
      padding: 10px;
      max-height: 250px;
      overflow-y: auto;
      font-size: 12px;
      white-space: pre-line;
    }
    .map {
      background: #070c14;
      border: 1px solid #1c2b3d;
      border-radius: 14px;
      padding: 10px;
      overflow-x: auto;
    }
    .mapGrid {
      display: grid;
      grid-template-columns: repeat(12, 44px);
      grid-template-rows: repeat(12, 44px);
      gap: 4px;
      width: max-content;
    }
    .tile {
      width: 44px;
      height: 44px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.06);
      font-size: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      cursor: pointer;
      transition: 0.15s;
      user-select: none;
      line-height: 1.1;
    }
    .tile:hover {
      transform: scale(1.04);
      border-color: rgba(255,255,255,0.18);
    }
    .small {
      font-size: 12px;
      opacity: 0.85;
      margin-top: 8px;
    }
    .entityList {
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
    }
    .entity {
      background: #070c14;
      border: 1px solid #1c2b3d;
      border-radius: 14px;
      padding: 10px;
      font-size: 13px;
    }
    .entity .top {
      display: flex;
      justify-content: space-between;
      gap: 10px;
    }
    .entity .dna {
      font-size: 11px;
      opacity: 0.8;
      margin-top: 6px;
      word-break: break-all;
    }
    .entity .tags {
      margin-top: 6px;
      font-size: 11px;
      opacity: 0.85;
    }
    .tag {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 8px;
      background: rgba(45,125,255,0.2);
      border: 1px solid rgba(45,125,255,0.25);
      margin-right: 6px;
      margin-top: 4px;
    }
    .tag2 {
      background: rgba(255,210,60,0.14);
      border: 1px solid rgba(255,210,60,0.2);
    }
    .tag3 {
      background: rgba(255,70,70,0.12);
      border: 1px solid rgba(255,70,70,0.2);
    }
    .tag4 {
      background: rgba(70,255,160,0.12);
      border: 1px solid rgba(70,255,160,0.2);
    }
    .footer {
      font-size: 11px;
      opacity: 0.6;
      margin-top: 6px;
      text-align: center;
      padding-bottom: 20px;
    }
    input {
      width: 100%;
      padding: 10px;
      border-radius: 12px;
      border: 1px solid #1c2b3d;
      background: #070c14;
      color: #e7f0ff;
      font-size: 13px;
      outline: none;
      box-sizing: border-box;
    }
    .title {
      font-size: 15px;
      font-weight: bold;
      margin-bottom: 10px;
    }
  </style>
</head>

<body>
<header>
  <h1>ğŸŒ AENO ä¸–ç•Œè‚²æˆ Alpha 0.1</h1>
  <div class="sub" id="status">é€£æ¥ä¸­...</div>
</header>

<div class="wrap">

  <div class="card">
    <div class="title">â³ ä¸–ç•Œæ™‚é–“æµé€Ÿ</div>
    <div class="grid2">
      <div class="stat">
        <b>ç¾å¯¦æ™‚é–“</b>
        <span id="realTime">--</span>
      </div>
      <div class="stat">
        <b>éŠæˆ²ä¸–ç•Œå¹´ä»½</b>
        <span id="gameYear">--</span>
      </div>
    </div>

    <div class="small">
      åˆå§‹æµé€Ÿï¼š<b>1 ç¾å¯¦æ—¥ = 100 éŠæˆ²å¹´</b>ï¼ˆå¯å‹•æ…‹èª¿æ•´ï¼‰
    </div>

    <div class="row">
      <button class="btn btn2" id="speedSlow">ğŸ¢ æ¸›æ…¢æµé€Ÿ</button>
      <button class="btn btn2" id="speedFast">ğŸš€ åŠ å¿«æµé€Ÿ</button>
      <button class="btn" id="saveNow">ğŸ’¾ æ‰‹å‹•å­˜æª”</button>
    </div>
  </div>

  <div class="card">
    <div class="title">ğŸ’° è³‡æºèˆ‡ AENO å¹£ï¼ˆç¸½é‡ 2000 è¬ï¼‰</div>
    <div class="grid3">
      <div class="stat"><b>æœ¨æ</b><span id="resWood">0</span></div>
      <div class="stat"><b>çŸ³</b><span id="resStone">0</span></div>
      <div class="stat"><b>æ°´</b><span id="resWater">0</span></div>
      <div class="stat"><b>é£Ÿç‰©</b><span id="resFood">0</span></div>
      <div class="stat"><b>èƒ½æº</b><span id="resEnergy">0</span></div>
      <div class="stat"><b>AENO å¹£</b><span id="resAeno">0</span></div>
    </div>

    <div class="small">
      AENO å¹£æŒ–æ˜é‡‹æ”¾ï¼šæ¨¡æ“¬æ¯”ç‰¹å¹£æ¸›åŠé‚è¼¯ï¼ˆè¶Šå¾ŒæœŸè¶Šé›£æŒ–ï¼‰ã€‚
    </div>

    <div class="row">
      <button class="btn" id="mineAeno">â› æŒ–æ˜ AENO å¹£</button>
      <button class="btn btn2" id="watchAd">ğŸ“º çœ‹å»£å‘Šè³ºè³‡æº</button>
      <button class="btn btn2" id="listenSong">ğŸµ è½æ­Œè³ºè³‡æº</button>
    </div>
  </div>

  <div class="card">
    <div class="title">ğŸ—º ä¸–ç•Œåœ°åœ–ï¼ˆ12x12ï¼‰</div>
    <div class="map">
      <div class="mapGrid" id="mapGrid"></div>
    </div>
    <div class="small" id="tileInfo">é»æ“Šæ ¼å­æŸ¥çœ‹å…§å®¹</div>
  </div>

  <div class="card">
    <div class="title">ğŸ§¬ ç”Ÿå‘½/åœ°å½¢/æ©Ÿå™¨äººï¼ˆDNA é€²åŒ–ç³»çµ±ï¼‰</div>
    <div class="row">
      <button class="btn" id="createWorld">ğŸŒ å»ºç«‹ä¸–ç•Œ</button>
      <button class="btn btn2" id="triggerEvent">âš¡ è§¸ç™¼äº‹ä»¶ï¼ˆå…¨ä¸–ç•Œè®Šç•°ï¼‰</button>
      <button class="btn btn2" id="refresh">ğŸ”„ åˆ·æ–°</button>
      <button class="btn btnDanger" id="wipe">â˜  æ¸…ç©ºä¸–ç•Œï¼ˆæ…ç”¨ï¼‰</button>
    </div>

    <div class="entityList" id="entityList"></div>
  </div>

  <div class="card">
    <div class="title">ğŸ¤– AI åŠ©æ‰‹å°å‹•ç‰©ï¼ˆæ‹‰ä¸åï¼‰</div>
    <div class="small" id="aiInfo">å°šæœªç”Ÿæˆ AI åŠ©æ‰‹</div>
  </div>

  <div class="card">
    <div class="title">ğŸ“œ ä¸–ç•Œäº‹ä»¶æ—¥èªŒ</div>
    <div class="log" id="logBox"></div>
  </div>

  <div class="footer">
    AENO Alpha 0.1 | Firebase Firestore é›²ç«¯åŒæ­¥ + 24 å°æ™‚é›¢ç·šæ”¶ç›Š<br/>
    ä½ è€Œå®¶å·²ç¶“æœ‰ã€ŒçœŸæ­£å¯ç©éª¨æ¶ã€ï¼Œä¹‹å¾Œåªä¿‚åŠ æ›´å¤šå…§å®¹ã€‚
  </div>

</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import {
    getFirestore,
    collection,
    doc,
    setDoc,
    getDocs,
    getDoc,
    updateDoc,
    deleteDoc,
    increment
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  // =========================
  // Firebase Config
  // =========================
  const firebaseConfig = {
    apiKey: "AIzaSyCaO5K2VXrhK39qCxOiUdafP__yd8K6C8s",
    authDomain: "aeno-9ac3b.firebaseapp.com",
    projectId: "aeno-9ac3b",
    storageBucket: "aeno-9ac3b.firebasestorage.app",
    messagingSenderId: "419553504514",
    appId: "1:419553504514:web:85d14cea41c55a3395261b",
    measurementId: "G-6K7PEQ9FEF"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // =========================
  // UI Elements
  // =========================
  const statusEl = document.getElementById("status");
  const logBox = document.getElementById("logBox");
  const entityList = document.getElementById("entityList");
  const mapGrid = document.getElementById("mapGrid");
  const tileInfo = document.getElementById("tileInfo");

  const realTimeEl = document.getElementById("realTime");
  const gameYearEl = document.getElementById("gameYear");

  const resWoodEl = document.getElementById("resWood");
  const resStoneEl = document.getElementById("resStone");
  const resWaterEl = document.getElementById("resWater");
  const resFoodEl = document.getElementById("resFood");
  const resEnergyEl = document.getElementById("resEnergy");
  const resAenoEl = document.getElementById("resAeno");

  const aiInfo = document.getElementById("aiInfo");

  // =========================
  // Constants
  // =========================
  const WORLD_DOC = "mainWorld";
  const PLAYER_DOC = "player001"; // æš«æ™‚å›ºå®šï¼Œæ—¥å¾Œå†æ¥ Authentication
  const MAX_AENO_SUPPLY = 20000000;

  // åˆå§‹ï¼š1 æ—¥ç¾å¯¦ = 100 å¹´éŠæˆ²
  let speedYearsPerDay = 100;

  // =========================
  // Helpers
  // =========================
  function now() {
    return Date.now();
  }

  function log(msg) {
    const t = new Date().toLocaleTimeString();
    logBox.innerText = `[${t}] ${msg}\n` + logBox.innerText;
  }

  function rand(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
  }

  function pick(arr) {
    return arr[Math.floor(Math.random() * arr.length)];
  }

  function randomDNA(len = 22) {
    const letters = "ATCG";
    let dna = "";
    for (let i = 0; i < len; i++) {
      dna += letters[Math.floor(Math.random() * letters.length)];
    }
    return dna;
  }

  function mutateDNA(dna) {
    const letters = "ATCG";
    let arr = dna.split("");
    const mutations = rand(1, 3);
    for (let i = 0; i < mutations; i++) {
      const pos = rand(0, arr.length - 1);
      arr[pos] = letters[rand(0, letters.length - 1)];
    }
    return arr.join("");
  }

  function dnaPower(dna) {
    // ç°¡åŒ–ï¼šDNA è£¡é¢ C/G è¶Šå¤š = è¶Šå¼·
    let score = 0;
    for (const ch of dna) {
      if (ch === "C" || ch === "G") score++;
    }
    return score;
  }

  function formatNumber(n) {
    return Math.floor(n).toLocaleString();
  }

  // =========================
  // Time System
  // =========================
  function calcGameYear(world) {
    const elapsed = now() - world.createdAt;
    const days = elapsed / (1000 * 60 * 60 * 24);
    const years = days * world.speedYearsPerDay;
    return Math.floor(world.startYear + years);
  }

  function updateTimeUI(world) {
    realTimeEl.innerText = new Date().toLocaleString();
    gameYearEl.innerText = calcGameYear(world);
  }

  // =========================
  // World Generation
  // =========================
  const terrains = [
    { type: "æ°´åŸŸ", icon: "ğŸŒŠ", res: "æ°´" },
    { type: "æ£®æ—", icon: "ğŸŒ²", res: "æœ¨æ" },
    { type: "å±±è„ˆ", icon: "â›°", res: "çŸ³" },
    { type: "è‰åŸ", icon: "ğŸŒ¾", res: "é£Ÿç‰©" },
    { type: "æ²™æ¼ ", icon: "ğŸœ", res: "èƒ½æº" }
  ];

  const plants = [
    { name: "éˆæœ¨", icon: "ğŸŒ±" },
    { name: "å…‰è—¤", icon: "ğŸ€" },
    { name: "èµ¤ç„°è‰", icon: "ğŸŒ¿" },
    { name: "å†°è—èŠ±", icon: "ğŸŒ¸" }
  ];

  const animals = [
    { name: "æ˜Ÿç‹", icon: "ğŸ¦Š" },
    { name: "é›·ç‹¼", icon: "ğŸº" },
    { name: "é›²é·¹", icon: "ğŸ¦…" },
    { name: "çŸ³é¾œ", icon: "ğŸ¢" }
  ];

  const robots = [
    { name: "æ¡é›†æ©Ÿ", icon: "ğŸ¤–" },
    { name: "å·¡é‚æ©Ÿ", icon: "ğŸ›°" },
    { name: "ä¿®å¾©æ©Ÿ", icon: "ğŸ› " }
  ];

  const mines = [
    { name: "Aenoæ™¶ç¤¦è„ˆ", icon: "ğŸ’" },
    { name: "é»‘éµç¤¦", icon: "â›" },
    { name: "èƒ½é‡æ ¸", icon: "âš¡" }
  ];

  const latinAI = [
    "Aurelius", "Silva", "Ferrum", "Lumen", "Natura", "Orbis", "Ignis", "Aqua",
    "Vulpes", "Draco", "Caelum", "Terra", "Nox", "Lux", "Aeternum"
  ];

  function tileColor(type) {
    if (type === "æ°´åŸŸ") return "#083c66";
    if (type === "æ£®æ—") return "#0f4b2a";
    if (type === "å±±è„ˆ") return "#3a3a3a";
    if (type === "è‰åŸ") return "#465c1a";
    if (type === "æ²™æ¼ ") return "#7a5a1d";
    return "#111";
  }

  async function createWorld() {
    const worldRef = doc(db, "world", WORLD_DOC);
    const playerRef = doc(db, "players", PLAYER_DOC);

    const existing = await getDoc(worldRef);
    if (existing.exists()) {
      log("âš  ä¸–ç•Œå·²å­˜åœ¨ï¼Œä¸æœƒé‡è¤‡å»ºç«‹ã€‚");
      return;
    }

    const worldData = {
      createdAt: now(),
      startYear: 2026,
      speedYearsPerDay: speedYearsPerDay,
      lastSavedAt: now(),
      lastTickAt: now(),
      mapSize: 12,
      seed: rand(100000, 999999),
      globalMutationLevel: 0
    };

    await setDoc(worldRef, worldData);

    const playerData = {
      createdAt: now(),
      lastOnlineAt: now(),
      resources: {
        wood: 20,
        stone: 20,
        water: 20,
        food: 20,
        energy: 10,
        aeno: 0
      },
      minedTotal: 0,
      adViews: 0,
      songPlays: 0,
      aiAssistants: [],
      offlineCapHours: 24
    };

    await setDoc(playerRef, playerData);

    // generate tiles
    for (let y = 0; y < 12; y++) {
      for (let x = 0; x < 12; x++) {
        const t = pick(terrains);
        const tileId = `tile_${x}_${y}`;

        await setDoc(doc(db, "tiles", tileId), {
          x, y,
          terrain: t.type,
          icon: t.icon,
          baseResource: t.res,
          dna: randomDNA(),
          mutationCount: 0,
          level: 1,
          createdAt: now()
        });
      }
    }

    // entities
    const entitiesToCreate = [];

    // 8 plants
    for (let i = 0; i < 8; i++) {
      const p = pick(plants);
      entitiesToCreate.push({
        id: `plant_${i}`,
        type: "æ¤ç‰©",
        icon: p.icon,
        name: p.name,
        dna: randomDNA(),
        mutationCount: 0,
        level: 1,
        produces: "é£Ÿç‰©",
        createdAt: now()
      });
    }

    // 6 animals
    for (let i = 0; i < 6; i++) {
      const a = pick(animals);
      entitiesToCreate.push({
        id: `animal_${i}`,
        type: "å‹•ç‰©",
        icon: a.icon,
        name: a.name,
        dna: randomDNA(),
        mutationCount: 0,
        level: 1,
        produces: "çš®æ¯›",
        createdAt: now()
      });
    }

    // 4 robots
    for (let i = 0; i < 4; i++) {
      const r = pick(robots);
      entitiesToCreate.push({
        id: `robot_${i}`,
        type: "æ©Ÿå™¨äºº",
        icon: r.icon,
        name: r.name,
        dna: randomDNA(),
        mutationCount: 0,
        level: 1,
        produces: "èƒ½æº",
        createdAt: now()
      });
    }

    // 5 mines
    for (let i = 0; i < 5; i++) {
      const m = pick(mines);
      entitiesToCreate.push({
        id: `mine_${i}`,
        type: "ç¤¦ç‰©",
        icon: m.icon,
        name: m.name,
        dna: randomDNA(),
        mutationCount: 0,
        level: 1,
        produces: "çŸ³",
        createdAt: now()
      });
    }

    // AI assistant
    const aiName = pick(latinAI);
    const aiEntity = {
      id: `ai_001`,
      type: "AIåŠ©æ‰‹",
      icon: "ğŸ¦",
      name: aiName,
      dna: randomDNA(),
      mutationCount: 0,
      level: 1,
      produces: "ä»»å‹™",
      createdAt: now()
    };

    entitiesToCreate.push(aiEntity);

    for (const e of entitiesToCreate) {
      await setDoc(doc(db, "entities", e.id), e);
    }

    await updateDoc(playerRef, {
      aiAssistants: [aiName]
    });

    log("ğŸŒ ä¸–ç•Œå·²å»ºç«‹ï¼šåœ°åœ–/æ¤ç‰©/å‹•ç‰©/ç¤¦/æ©Ÿå™¨äºº/AIåŠ©æ‰‹ å·²ç”Ÿæˆã€‚");
    await refreshAll();
  }

  // =========================
  // Resource System + Offline
  // =========================
  async function applyOfflineGain(player, world) {
    const playerRef = doc(db, "players", PLAYER_DOC);

    const lastOnline = player.lastOnlineAt || now();
    const diffMs = now() - lastOnline;
    const hours = diffMs / (1000 * 60 * 60);

    const cap = player.offlineCapHours || 24;
    const usedHours = Math.min(hours, cap);

    if (usedHours < 0.02) return;

    // åŸºç¤é›¢ç·šæ”¶ç›Šï¼ˆç°¡åŒ–ï¼‰
    const gainWood = Math.floor(usedHours * 3);
    const gainStone = Math.floor(usedHours * 2);
    const gainWater = Math.floor(usedHours * 2);
    const gainFood = Math.floor(usedHours * 4);
    const gainEnergy = Math.floor(usedHours * 1);

    await updateDoc(playerRef, {
      "resources.wood": increment(gainWood),
      "resources.stone": increment(gainStone),
      "resources.water": increment(gainWater),
      "resources.food": increment(gainFood),
      "resources.energy": increment(gainEnergy),
      lastOnlineAt: now()
    });

    log(`ğŸ•’ é›¢ç·šæ”¶ç›Šçµç®—ï¼š${usedHours.toFixed(1)} å°æ™‚ +æœ¨${gainWood} çŸ³${gainStone} æ°´${gainWater} é£Ÿç‰©${gainFood} èƒ½æº${gainEnergy}`);
  }

  // =========================
  // AENO Mining (Bitcoin-like)
  // =========================
  function calcMiningReward(minedTotal) {
    // æ¯æŒ– 2,000,000 æ¸›åŠä¸€æ¬¡ï¼ˆç°¡åŒ–ï¼‰
    const halvings = Math.floor(minedTotal / 2000000);
    let reward = 50 / Math.pow(2, halvings);
    if (reward < 0.1) reward = 0.1;
    return reward;
  }

  async function mineAeno() {
    const playerRef = doc(db, "players", PLAYER_DOC);
    const playerSnap = await getDoc(playerRef);
    if (!playerSnap.exists()) {
      log("âŒ æœªå»ºç«‹ç©å®¶è³‡æ–™ã€‚è«‹å…ˆå»ºç«‹ä¸–ç•Œã€‚");
      return;
    }

    const player = playerSnap.data();
    const minedTotal = player.minedTotal || 0;

    if (player.resources.energy < 2) {
      log("âš  èƒ½æºä¸è¶³ï¼Œç„¡æ³•æŒ–ç¤¦ã€‚");
      return;
    }

    const reward = calcMiningReward(minedTotal);
    const currentAeno = player.resources.aeno || 0;

    if (currentAeno + minedTotal >= MAX_AENO_SUPPLY) {
      log("âš  AENO å¹£å·²æ¥è¿‘ä¸Šé™ï¼ˆ2000è¬ï¼‰ï¼ŒæŒ–ç¤¦åœæ­¢ã€‚");
      return;
    }

    await updateDoc(playerRef, {
      "resources.energy": increment(-2),
      "resources.aeno": increment(reward),
      minedTotal: increment(reward)
    });

    log(`â› æˆåŠŸæŒ–æ˜ AENO å¹£ +${reward.toFixed(2)}ï¼ˆè¶Šå¾ŒæœŸè¶Šé›£æŒ–ï¼‰`);
    await refreshPlayer();
  }

  // =========================
  // Fake Ads / Songs Rewards
  // =========================
  async function watchAd() {
    const playerRef = doc(db, "players", PLAYER_DOC);
    const playerSnap = await getDoc(playerRef);
    if (!playerSnap.exists()) {
      log("âŒ æœªå»ºç«‹ç©å®¶è³‡æ–™ã€‚è«‹å…ˆå»ºç«‹ä¸–ç•Œã€‚");
      return;
    }

    await updateDoc(playerRef, {
      "resources.food": increment(rand(5, 12)),
      "resources.wood": increment(rand(3, 8)),
      "resources.energy": increment(rand(1, 4)),
      adViews: increment(1)
    });

    log("ğŸ“º ä½ è§€çœ‹å»£å‘Šï¼šç²å¾—é£Ÿç‰©/æœ¨æ/èƒ½æºçå‹µï¼ˆæœªä¾†å¯æ¥çœŸå»£å‘ŠSDKï¼‰ã€‚");
    await refreshPlayer();
  }

  async function listenSong() {
    const playerRef = doc(db, "players", PLAYER_DOC);
    const playerSnap = await getDoc(playerRef);
    if (!playerSnap.exists()) {
      log("âŒ æœªå»ºç«‹ç©å®¶è³‡æ–™ã€‚è«‹å…ˆå»ºç«‹ä¸–ç•Œã€‚");
      return;
    }

    await updateDoc(playerRef, {
      "resources.water": increment(rand(2, 8)),
      "resources.food": increment(rand(2, 6)),
      songPlays: increment(1)
    });

    log("ğŸµ ä½ è½æ­Œï¼šç²å¾—æ°´/é£Ÿç‰©çå‹µï¼ˆæœªä¾†å¯æ¥éŸ³æ¨‚å¹³å°ï¼‰ã€‚");
    await refreshPlayer();
  }

  // =========================
  // Event System + Evolution
  // =========================
  const events = [
    "â˜„ éš•çŸ³æ’æ“Šï¼šç’°å¢ƒåŠ‡è®Šï¼Œç”Ÿç‰©çªè®ŠåŠ é€Ÿ",
    "ğŸŒª è¶…ç´šé¢¨æš´ï¼šæ£®æ—æ¸›å°‘ï¼Œæ°´åŸŸæ“´å¼µ",
    "ğŸ”¥ ç«å±±çˆ†ç™¼ï¼šå±±è„ˆè®Šå¤šï¼Œèƒ½æºæš´å¢",
    "ğŸ¦  ç˜Ÿç–«è”“å»¶ï¼šå‹•ç‰©åŸºå› é‡çµ„",
    "ğŸ¤– AIè¦ºé†’ï¼šæ©Ÿå™¨äººé€²åŒ–é€Ÿåº¦æå‡",
    "ğŸŒŒ é‡å­è£‚ç¸«ï¼šDNA å‡ºç¾æœªçŸ¥åºåˆ—"
  ];

  async function triggerEvent() {
    const worldRef = doc(db, "world", WORLD_DOC);
    const worldSnap = await getDoc(worldRef);

    if (!worldSnap.exists()) {
      log("âŒ ä¸–ç•Œæœªå»ºç«‹ã€‚");
      return;
    }

    const eventText = pick(events);
    log(eventText);

    await updateDoc(worldRef, {
      globalMutationLevel: increment(1)
    });

    // mutate all entities
    const entSnap = await getDocs(collection(db, "entities"));
    for (const d of entSnap.docs) {
      const e = d.data();
      const newDNA = mutateDNA(e.dna);
      await updateDoc(doc(db, "entities", d.id), {
        dna: newDNA,
        mutationCount: increment(1),
        level: increment(1)
      });
    }

    // mutate all tiles slightly
    const tileSnap = await getDocs(collection(db, "tiles"));
    for (const t of tileSnap.docs) {
      const tile = t.data();
      if (Math.random() < 0.10) {
        const newTerrain = pick(terrains);
        await updateDoc(doc(db, "tiles", t.id), {
          terrain: newTerrain.type,
          icon: newTerrain.icon,
          baseResource: newTerrain.res,
          mutationCount: increment(1),
          dna: mutateDNA(tile.dna),
          level: increment(1)
        });
      }
    }

    // reward from event
    const playerRef = doc(db, "players", PLAYER_DOC);
    await updateDoc(playerRef, {
      "resources.energy": increment(rand(3, 10)),
      "resources.food": increment(rand(5, 15))
    });

    log("ğŸ§¬ å…¨ä¸–ç•Œ DNA è®Šç•°å®Œæˆ + ä¸–ç•Œæ ¼å­éƒ¨åˆ†æ”¹è®Šã€‚");
    await refreshAll();
  }

  // =========================
  // Load / Render
  // =========================
  async function refreshWorld() {
    const worldRef = doc(db, "world", WORLD_DOC);
    const snap = await getDoc(worldRef);
    if (!snap.exists()) return null;
    return snap.data();
  }

  async function refreshPlayer() {
    const playerRef = doc(db, "players", PLAYER_DOC);
    const snap = await getDoc(playerRef);
    if (!snap.exists()) return null;

    const p = snap.data();

    resWoodEl.innerText = formatNumber(p.resources.wood || 0);
    resStoneEl.innerText = formatNumber(p.resources.stone || 0);
    resWaterEl.innerText = formatNumber(p.resources.water || 0);
    resFoodEl.innerText = formatNumber(p.resources.food || 0);
    resEnergyEl.innerText = formatNumber(p.resources.energy || 0);
    resAenoEl.innerText = (p.resources.aeno || 0).toFixed(2);

    if (p.aiAssistants && p.aiAssistants.length > 0) {
      aiInfo.innerHTML = `ä½ çš„ AI åŠ©æ‰‹ï¼š<b>${p.aiAssistants.join(", ")}</b><br/>å®ƒå€‘æœƒæ´¾ä»»å‹™ã€å¼•å°ä½ é€²åŒ–ä¸–ç•Œï¼ˆæœªä¾†æ“´å±•ä»»å‹™ç³»çµ±ï¼‰ã€‚`;
    }

    return p;
  }

  async function refreshEntities() {
    entityList.innerHTML = "";
    const snap = await getDocs(collection(db, "entities"));

    if (snap.empty) {
      entityList.innerHTML = `<div class="small">å°šæœªç”Ÿæˆä»»ä½•ç”Ÿå‘½æˆ–æ©Ÿå™¨äººã€‚</div>`;
      return;
    }

    snap.forEach((d) => {
      const e = d.data();
      const power = dnaPower(e.dna);

      const div = document.createElement("div");
      div.className = "entity";
      div.innerHTML = `
        <div class="top">
          <div><b>${e.icon} ${e.type}ï¼š${e.name}</b></div>
          <div style="opacity:0.75;font-size:12px;">Lv.${e.level}</div>
        </div>
        <div class="tags">
          <span class="tag">DNAå¼·åº¦ï¼š${power}</span>
          <span class="tag tag2">ç”¢å‡ºï¼š${e.produces}</span>
          <span class="tag tag4">è®Šç•°ï¼š${e.mutationCount}</span>
        </div>
        <div class="dna">DNAï¼š${e.dna}</div>
      `;
      entityList.appendChild(div);
    });
  }

  async function refreshMap() {
    mapGrid.innerHTML = "";
    const snap = await getDocs(collection(db, "tiles"));

    if (snap.empty) {
      mapGrid.innerHTML = `<div class="small">å°šæœªç”Ÿæˆåœ°åœ–ã€‚</div>`;
      return;
    }

    // store by coordinates
    const tiles = [];
    snap.forEach(d => tiles.push(d.data()));

    tiles.sort((a,b)=> (a.y - b.y) || (a.x - b.x));

    for (const t of tiles) {
      const div = document.createElement("div");
      div.className = "tile";
      div.style.background = tileColor(t.terrain);
      div.innerHTML = `${t.icon}<br>${t.terrain}`;

      div.onclick = () => {
        tileInfo.innerHTML = `
          ğŸ“ ä½ç½®ï¼š(${t.x},${t.y})<br>
          ğŸŒ åœ°å½¢ï¼š<b>${t.terrain}</b><br>
          ğŸ åŸºç¤è³‡æºï¼š<b>${t.baseResource}</b><br>
          ğŸ§¬ DNAï¼š<span style="font-size:11px;opacity:0.85">${t.dna}</span><br>
          ğŸ”¥ ç­‰ç´šï¼š${t.level} | è®Šç•°ï¼š${t.mutationCount}
        `;
      };

      mapGrid.appendChild(div);
    }
  }

  async function refreshAll() {
    const world = await refreshWorld();
    const player = await refreshPlayer();
    await refreshEntities();
    await refreshMap();

    if (world) updateTimeUI(world);
    return { world, player };
  }

  // =========================
  // Save
  // =========================
  async function saveNow() {
    const worldRef = doc(db, "world", WORLD_DOC);
    const snap = await getDoc(worldRef);
    if (!snap.exists()) {
      log("âŒ ä¸–ç•Œæœªå»ºç«‹ï¼Œç„¡æ³•å­˜æª”ã€‚");
      return;
    }

    await updateDoc(worldRef, {
      lastSavedAt: now(),
      speedYearsPerDay: speedYearsPerDay
    });

    log("ğŸ’¾ å·²æ‰‹å‹•å­˜æª”ï¼ˆé›²ç«¯ Firestoreï¼‰ã€‚");
  }

  // =========================
  // Wipe World
  // =========================
  async function wipeWorld() {
    if (!confirm("ç¢ºå®šè¦æ¸…ç©ºä¸–ç•Œï¼Ÿï¼ˆæœƒåˆªé™¤ tiles/entities/world/playerï¼‰")) return;

    const entSnap = await getDocs(collection(db, "entities"));
    for (const d of entSnap.docs) await deleteDoc(doc(db, "entities", d.id));

    const tileSnap = await getDocs(collection(db, "tiles"));
    for (const d of tileSnap.docs) await deleteDoc(doc(db, "tiles", d.id));

    await deleteDoc(doc(db, "world", WORLD_DOC));
    await deleteDoc(doc(db, "players", PLAYER_DOC));

    log("â˜  ä¸–ç•Œå·²æ¸…ç©ºã€‚ä½ å¯ä»¥é‡æ–°å»ºç«‹ä¸–ç•Œã€‚");
    await refreshAll();
  }

  // =========================
  // Speed Control
  // =========================
  async function speedUp() {
    speedYearsPerDay = Math.min(speedYearsPerDay + 50, 2000);
    log(`ğŸš€ æµé€Ÿæå‡ï¼š1æ—¥=${speedYearsPerDay}å¹´`);
    await saveNow();
    await refreshAll();
  }

  async function speedDown() {
    speedYearsPerDay = Math.max(speedYearsPerDay - 50, 10);
    log(`ğŸ¢ æµé€Ÿé™ä½ï¼š1æ—¥=${speedYearsPerDay}å¹´`);
    await saveNow();
    await refreshAll();
  }

  // =========================
  // Init
  // =========================
  statusEl.innerText = "âœ… Firebase Firestore å·²é€£æ¥æˆåŠŸï¼ˆAENO Alpha é‹è¡Œä¸­ï¼‰";
  log("AENO ä¸–ç•Œå¼•æ“ Alpha 0.1 å•Ÿå‹•ã€‚");

  // Buttons
  document.getElementById("createWorld").onclick = createWorld;
  document.getElementById("triggerEvent").onclick = triggerEvent;
  document.getElementById("refresh").onclick = refreshAll;
  document.getElementById("mineAeno").onclick = mineAeno;
  document.getElementById("watchAd").onclick = watchAd;
  document.getElementById("listenSong").onclick = listenSong;
  document.getElementById("wipe").onclick = wipeWorld;
  document.getElementById("saveNow").onclick = saveNow;
  document.getElementById("speedFast").onclick = speedUp;
  document.getElementById("speedSlow").onclick = speedDown;

  // Auto refresh
  let worldCache = await refreshWorld();
  if (worldCache) {
    speedYearsPerDay = worldCache.speedYearsPerDay || speedYearsPerDay;
  }

  const playerRef = doc(db, "players", PLAYER_DOC);
  const playerSnap = await getDoc(playerRef);
  if (playerSnap.exists() && worldCache) {
    await applyOfflineGain(playerSnap.data(), worldCache);
  }

  await refreshAll();

  setInterval(async () => {
    const world = await refreshWorld();
    if (world) updateTimeUI(world);
  }, 1000);

</script>

</body>
</html>
