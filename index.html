<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>AENO V3 - Cartoon Town (Vertical)</title>
<style>
  :root{
    --bg1:#dff6ff;
    --bg2:#f6fbff;
    --panel:#ffffffee;
    --line:#c7e7ff;
    --shadow: rgba(0,0,0,0.18);
    --gold:#fbbf24;
    --blue:#60a5fa;
    --green:#34d399;
    --red:#fb7185;
    --text:#0f172a;
    --muted:#64748b;
  }

  *{box-sizing:border-box; font-family: system-ui, -apple-system, "Segoe UI", Arial;}
  body{
    margin:0;
    background: linear-gradient(180deg,var(--bg1),var(--bg2));
    height:100vh;
    overflow:hidden;
    display:flex;
    justify-content:center;
    align-items:center;
  }

  /* phone frame */
  #app{
    width:min(460px, 100vw);
    height:100vh;
    position:relative;
    overflow:hidden;
    background:linear-gradient(180deg,#dff6ff,#f6fbff);
  }

  canvas{
    position:absolute;
    left:0;
    top:0;
    width:100%;
    height:100%;
  }

  /* Top HUD */
  #topHud{
    position:absolute;
    top:10px;
    left:10px;
    right:10px;
    display:flex;
    gap:10px;
    z-index:20;
  }

  .chip{
    flex:1;
    background: var(--panel);
    border:2px solid var(--line);
    border-radius:18px;
    padding:10px 12px;
    box-shadow: 0 10px 20px var(--shadow);
    display:flex;
    justify-content:space-between;
    align-items:center;
    min-height:54px;
    backdrop-filter: blur(8px);
  }

  .chip .label{
    font-size:12px;
    color:var(--muted);
    font-weight:700;
    letter-spacing:0.3px;
  }
  .chip .value{
    font-size:16px;
    font-weight:900;
    color:var(--text);
  }

  /* Bottom bar */
  #bottomBar{
    position:absolute;
    left:10px;
    right:10px;
    bottom:12px;
    z-index:30;
    display:flex;
    gap:10px;
  }

  .btn{
    flex:1;
    border:none;
    border-radius:20px;
    padding:14px 10px;
    font-size:14px;
    font-weight:900;
    color:#0b1220;
    background: white;
    border:2px solid var(--line);
    box-shadow: 0 12px 24px var(--shadow);
    cursor:pointer;
    transition: transform 0.08s ease;
    user-select:none;
  }
  .btn:active{ transform: scale(0.97); }

  .btn.primary{ background: linear-gradient(180deg,#fff7d6,#ffe08a); border-color:#ffd66a; }
  .btn.blue{ background: linear-gradient(180deg,#dff1ff,#a9d5ff); border-color:#8dc8ff; }
  .btn.green{ background: linear-gradient(180deg,#ddfff2,#a8ffe2); border-color:#7cf0c9; }
  .btn.red{ background: linear-gradient(180deg,#ffe0e7,#ffb5c4); border-color:#ff9bb1; }

  /* Side panels */
  .panel{
    position:absolute;
    left:10px;
    right:10px;
    bottom:86px;
    background: var(--panel);
    border:2px solid var(--line);
    border-radius:22px;
    padding:12px;
    box-shadow: 0 18px 36px var(--shadow);
    z-index:40;
    display:none;
    backdrop-filter: blur(8px);
  }

  .panelHeader{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:10px;
  }

  .panelTitle{
    font-weight:1000;
    font-size:16px;
    color:var(--text);
  }

  .closeBtn{
    background:#fff;
    border:2px solid var(--line);
    border-radius:14px;
    padding:8px 12px;
    font-weight:900;
    cursor:pointer;
  }

  .grid{
    display:grid;
    grid-template-columns: repeat(2, 1fr);
    gap:10px;
  }

  .card{
    background:#ffffff;
    border:2px solid #e6f5ff;
    border-radius:18px;
    padding:12px;
    box-shadow: 0 10px 18px rgba(0,0,0,0.08);
  }

  .card h4{
    margin:0 0 6px 0;
    font-size:14px;
    font-weight:1000;
  }

  .card p{
    margin:0;
    font-size:12px;
    color:var(--muted);
    font-weight:700;
    line-height:1.3;
  }

  .smallBtn{
    margin-top:10px;
    width:100%;
    padding:10px;
    border-radius:14px;
    border:none;
    background: linear-gradient(180deg,#fff7d6,#ffe08a);
    font-weight:1000;
    border:2px solid #ffd66a;
    cursor:pointer;
  }

  /* Assistant */
  #assistant{
    position:absolute;
    left:12px;
    bottom:170px;
    z-index:50;
    display:flex;
    align-items:flex-end;
    gap:10px;
    pointer-events:none;
  }

  #assistantAvatar{
    width:70px;
    height:70px;
    border-radius:22px;
    background: linear-gradient(180deg,#fff,#e8f6ff);
    border:2px solid var(--line);
    box-shadow: 0 14px 24px var(--shadow);
    display:flex;
    justify-content:center;
    align-items:center;
    font-size:34px;
    pointer-events:auto;
    cursor:pointer;
    user-select:none;
  }

  #assistantBubble{
    max-width: 290px;
    background: rgba(255,255,255,0.95);
    border:2px solid var(--line);
    border-radius:22px;
    padding:10px 12px;
    box-shadow: 0 14px 26px var(--shadow);
    font-size:13px;
    font-weight:900;
    color:#0b1220;
    line-height:1.35;
    pointer-events:auto;
    cursor:pointer;
    user-select:none;
  }

  /* Toast */
  #toast{
    position:absolute;
    top:90px;
    left:50%;
    transform:translateX(-50%);
    background: rgba(0,0,0,0.72);
    color:white;
    font-weight:900;
    font-size:13px;
    padding:10px 14px;
    border-radius:999px;
    z-index:60;
    display:none;
  }

  /* Build menu handle */
  #reopenHandle{
    position:absolute;
    right:12px;
    bottom:150px;
    z-index:55;
    background: rgba(255,255,255,0.95);
    border:2px solid var(--line);
    border-radius:18px;
    padding:10px 12px;
    font-weight:1000;
    box-shadow: 0 12px 24px var(--shadow);
    cursor:pointer;
    display:none;
    user-select:none;
  }

  /* dialog */
  #dialogOverlay{
    position:absolute;
    inset:0;
    background: rgba(0,0,0,0.35);
    z-index:100;
    display:none;
    justify-content:center;
    align-items:flex-end;
    padding:16px;
  }

  #dialog{
    width:100%;
    max-width:460px;
    background: rgba(255,255,255,0.96);
    border:2px solid var(--line);
    border-radius:26px;
    padding:14px;
    box-shadow: 0 20px 50px rgba(0,0,0,0.25);
    backdrop-filter: blur(10px);
  }

  #dialogTitle{
    font-size:16px;
    font-weight:1000;
    margin-bottom:8px;
  }
  #dialogText{
    font-size:13px;
    font-weight:800;
    color:#0b1220;
    line-height:1.45;
    margin-bottom:12px;
  }

  #dialogRow{
    display:flex;
    gap:10px;
  }

  .dialogBtn{
    flex:1;
    padding:12px;
    border-radius:18px;
    border:none;
    font-weight:1000;
    cursor:pointer;
    border:2px solid var(--line);
    background:#fff;
  }

  .dialogBtn.primary{
    background: linear-gradient(180deg,#ddfff2,#a8ffe2);
    border-color:#7cf0c9;
  }
</style>
</head>

<body>
<div id="app">
  <canvas id="canvas"></canvas>

  <div id="toast"></div>

  <div id="topHud">
    <div class="chip">
      <div>
        <div class="label">AENO</div>
        <div class="value" id="aenoVal">0</div>
      </div>
      <div style="font-size:22px;">ğŸª™</div>
    </div>

    <div class="chip">
      <div>
        <div class="label">è³‡æº</div>
        <div class="value" id="resVal">0</div>
      </div>
      <div style="font-size:22px;">ğŸ§±</div>
    </div>

    <div class="chip">
      <div>
        <div class="label">èƒ½é‡</div>
        <div class="value" id="energyVal">100</div>
      </div>
      <div style="font-size:22px;">âš¡</div>
    </div>
  </div>

  <div id="assistant">
    <div id="assistantAvatar">ğŸ¦Š</div>
    <div id="assistantBubble">ä½ å¥½ï¼æˆ‘ä¿‚ <b>FENIX</b> ğŸ¦Š<br>é»ã€Œå»ºç¯‰ã€å¯ä»¥èµ·ç¬¬ä¸€é–“å±‹ï¼</div>
  </div>

  <div id="reopenHandle">ğŸ“Œ æ‰“é–‹åŠŸèƒ½</div>

  <div id="bottomBar">
    <button class="btn primary" id="btnBuild">ğŸ— å»ºç¯‰</button>
    <button class="btn blue" id="btnUpgrade">â¬† å‡ç´š</button>
    <button class="btn green" id="btnCollect">ğŸ’° æ”¶é›†</button>
    <button class="btn red" id="btnPlanet">ğŸª è¡Œæ˜Ÿ</button>
  </div>

  <div class="panel" id="panelBuild">
    <div class="panelHeader">
      <div class="panelTitle">ğŸ— å»ºç¯‰æ¸…å–®</div>
      <button class="closeBtn" data-close="panelBuild">æ”¶èµ·</button>
    </div>
    <div class="grid">
      <div class="card">
        <h4>ğŸ  å°å±‹</h4>
        <p>+2 è³‡æº/ç§’<br>æˆæœ¬ï¼š50 è³‡æº</p>
        <button class="smallBtn" onclick="build('house')">å»ºé€ </button>
      </div>
      <div class="card">
        <h4>ğŸŒ³ æ£®æ—æ¨¹</h4>
        <p>+1 èƒ½é‡/ç§’<br>æˆæœ¬ï¼š30 è³‡æº</p>
        <button class="smallBtn" onclick="build('tree')">å»ºé€ </button>
      </div>
      <div class="card">
        <h4>ğŸ› åœ“é ‚å±‹</h4>
        <p>+1 AENO/10ç§’<br>æˆæœ¬ï¼š120 è³‡æº</p>
        <button class="smallBtn" onclick="build('dome')">å»ºé€ </button>
      </div>
      <div class="card">
        <h4>ğŸ¤– æ¡é›†ç«™</h4>
        <p>+5 è³‡æº/ç§’<br>æˆæœ¬ï¼š200 è³‡æº</p>
        <button class="smallBtn" onclick="build('robot')">å»ºé€ </button>
      </div>
    </div>
  </div>

  <div class="panel" id="panelUpgrade">
    <div class="panelHeader">
      <div class="panelTitle">â¬† å‡ç´šä¸­å¿ƒ</div>
      <button class="closeBtn" data-close="panelUpgrade">æ”¶èµ·</button>
    </div>

    <div class="grid">
      <div class="card">
        <h4>ğŸ  å°å±‹å‡ç´š</h4>
        <p>æå‡ç”¢é‡ +50%<br>æˆæœ¬ï¼š80 è³‡æº</p>
        <button class="smallBtn" onclick="upgrade('house')">å‡ç´š</button>
      </div>

      <div class="card">
        <h4>ğŸ› åœ“é ‚å‡ç´š</h4>
        <p>AENO ç”¢é‡æå‡<br>æˆæœ¬ï¼š150 è³‡æº</p>
        <button class="smallBtn" onclick="upgrade('dome')">å‡ç´š</button>
      </div>

      <div class="card">
        <h4>ğŸ¤– æ¡é›†ç«™å‡ç´š</h4>
        <p>è³‡æºç”¢é‡æå‡<br>æˆæœ¬ï¼š220 è³‡æº</p>
        <button class="smallBtn" onclick="upgrade('robot')">å‡ç´š</button>
      </div>

      <div class="card">
        <h4>âš¡ èƒ½é‡ä¸Šé™</h4>
        <p>èƒ½é‡ä¸Šé™ +50<br>æˆæœ¬ï¼š120 è³‡æº</p>
        <button class="smallBtn" onclick="upgrade('energy')">å‡ç´š</button>
      </div>
    </div>
  </div>

  <div id="dialogOverlay">
    <div id="dialog">
      <div id="dialogTitle">å°è©±</div>
      <div id="dialogText"></div>
      <div id="dialogRow">
        <button class="dialogBtn" onclick="closeDialog()">å–æ¶ˆ</button>
        <button class="dialogBtn primary" id="dialogOkBtn">ç¢ºå®š</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ---------------------------
   SAFE HELPERS
---------------------------- */
function clamp(v,min,max){ return Math.max(min, Math.min(max,v)); }
function rnd(a,b){ return a + Math.random()*(b-a); }
function format(n){
  if(n>=1e9) return (n/1e9).toFixed(2)+"B";
  if(n>=1e6) return (n/1e6).toFixed(2)+"M";
  if(n>=1e3) return (n/1e3).toFixed(1)+"K";
  return Math.floor(n).toString();
}

/* ---------------------------
   GAME STATE
---------------------------- */
const state = {
  aeno: 12,
  res: 180,
  energy: 100,
  energyMax: 100,

  planetIndex: 0,
  planets: ["AENO-Prime", "Verdia", "Mizu", "Pyro", "Cryon"],

  buildings: {
    house: {count:0, level:1},
    tree: {count:0, level:1},
    dome: {count:0, level:1},
    robot: {count:0, level:1},
  },

  production: {
    resPerSec: 0,
    energyPerSec: 0,
    aenoPerSec: 0,
  }
};

/* ---------------------------
   UI
---------------------------- */
const aenoVal = document.getElementById("aenoVal");
const resVal = document.getElementById("resVal");
const energyVal = document.getElementById("energyVal");

const panelBuild = document.getElementById("panelBuild");
const panelUpgrade = document.getElementById("panelUpgrade");
const reopenHandle = document.getElementById("reopenHandle");

const toast = document.getElementById("toast");

function showToast(msg){
  toast.innerText = msg;
  toast.style.display = "block";
  clearTimeout(showToast._t);
  showToast._t = setTimeout(()=> toast.style.display="none", 1400);
}

function updateProduction(){
  // base production per building
  const houseP = 2 * state.buildings.house.count * (1 + (state.buildings.house.level-1)*0.5);
  const robotP = 5 * state.buildings.robot.count * (1 + (state.buildings.robot.level-1)*0.5);
  const energyP = 1 * state.buildings.tree.count * (1 + (state.buildings.tree.level-1)*0.5);

  // dome makes AENO slowly
  const domeP = (state.buildings.dome.count * (1 + (state.buildings.dome.level-1)*0.4)) / 10;

  state.production.resPerSec = houseP + robotP;
  state.production.energyPerSec = energyP;
  state.production.aenoPerSec = domeP;
}

function updateHUD(){
  aenoVal.innerText = format(state.aeno);
  resVal.innerText = format(state.res);
  energyVal.innerText = Math.floor(state.energy) + "/" + state.energyMax;
}

/* ---------------------------
   PANELS
---------------------------- */
function hideAllPanels(){
  panelBuild.style.display = "none";
  panelUpgrade.style.display = "none";
  reopenHandle.style.display = "block";
}

function openPanel(panel){
  hideAllPanels();
  panel.style.display = "block";
  reopenHandle.style.display = "none";
}

document.getElementById("btnBuild").onclick = ()=> openPanel(panelBuild);
document.getElementById("btnUpgrade").onclick = ()=> openPanel(panelUpgrade);

document.getElementById("btnCollect").onclick = ()=>{
  const gain = Math.floor(20 + state.production.resPerSec*2);
  state.res += gain;
  popText("+"+gain+" è³‡æº", W*0.5, H*0.7, "#0f172a");
  showToast("æ”¶é›†æˆåŠŸ +"+gain+" è³‡æº");
  assistantSay("ä½ æ”¶é›†å’—è³‡æºï¼ä¸‹ä¸€æ­¥å¯ä»¥èµ·æ›´å¤šå±‹ğŸ ");
  updateHUD();
};

document.getElementById("btnPlanet").onclick = ()=>{
  state.planetIndex = (state.planetIndex + 1) % state.planets.length;
  showToast("åˆ‡æ›è¡Œæ˜Ÿï¼š" + state.planets[state.planetIndex]);
  assistantSay("ä½ è€Œå®¶å–º ğŸª " + state.planets[state.planetIndex] + "ï¼");
};

document.querySelectorAll(".closeBtn").forEach(btn=>{
  btn.onclick = ()=>{
    const id = btn.getAttribute("data-close");
    document.getElementById(id).style.display = "none";
    reopenHandle.style.display = "block";
  };
});

reopenHandle.onclick = ()=>{
  // default reopen build panel
  openPanel(panelBuild);
};

/* ---------------------------
   DIALOG / ASSISTANT
---------------------------- */
const dialogOverlay = document.getElementById("dialogOverlay");
const dialogText = document.getElementById("dialogText");
const dialogTitle = document.getElementById("dialogTitle");
const dialogOkBtn = document.getElementById("dialogOkBtn");

function openDialog(title, text, okText, onOk){
  dialogTitle.innerText = title;
  dialogText.innerHTML = text;
  dialogOkBtn.innerText = okText || "ç¢ºå®š";
  dialogOkBtn.onclick = ()=>{
    closeDialog();
    if(onOk) onOk();
  };
  dialogOverlay.style.display = "flex";
}

function closeDialog(){
  dialogOverlay.style.display = "none";
}

const assistantBubble = document.getElementById("assistantBubble");
const assistantAvatar = document.getElementById("assistantAvatar");

function assistantSay(msg){
  assistantBubble.innerHTML = msg;
}

assistantAvatar.onclick = ()=>{
  openDialog("ğŸ¦Š FENIX åŠ©æ‰‹", `
    <b>æç¤ºï¼š</b><br>
    - é»ã€Œå»ºç¯‰ã€å¯ä»¥èµ·å±‹ã€æ£®æ—ã€åœ“é ‚ã€æ¡é›†ç«™<br>
    - é»ã€Œå‡ç´šã€æå‡ç”¢é‡<br>
    - é»åœ°åœ–å»ºç¯‰æœƒå½ˆä¸€ä¸‹<br><br>
    <b>ä½ æƒ³åšå’©ï¼Ÿ</b>
  `, "æ˜ç™½", ()=>{
    showToast("FENIXï¼šç¥ä½ ç™¼å±•é ˜åœ°ï¼");
  });
};

assistantBubble.onclick = ()=> assistantAvatar.onclick();

/* ---------------------------
   BUILD / UPGRADE
---------------------------- */
function build(type){
  let cost = 0;
  if(type==="house") cost = 50 + state.buildings.house.count*25;
  if(type==="tree") cost = 30 + state.buildings.tree.count*20;
  if(type==="dome") cost = 120 + state.buildings.dome.count*60;
  if(type==="robot") cost = 200 + state.buildings.robot.count*80;

  if(state.res < cost){
    showToast("è³‡æºä¸è¶³ï¼Œéœ€è¦ "+cost);
    assistantSay("è³‡æºå””å¤ ğŸ˜… ä½ å¯ä»¥å…ˆæŒ‰ã€Œæ”¶é›†ã€æˆ–è€…èµ·å¤šå•²å±‹ï¼");
    return;
  }

  state.res -= cost;
  state.buildings[type].count++;

  updateProduction();
  updateHUD();

  spawnBuilding(type);
  showToast("å»ºé€ æˆåŠŸï¼");
  assistantSay("å»ºé€ æˆåŠŸï¼ä½ å˜…é ˜åœ°é–‹å§‹ç¹æ¦®å•¦âœ¨");
}

function upgrade(type){
  let cost = 0;

  if(type==="house") cost = 80 * state.buildings.house.level;
  if(type==="dome") cost = 150 * state.buildings.dome.level;
  if(type==="robot") cost = 220 * state.buildings.robot.level;
  if(type==="energy") cost = 120 + (state.energyMax-100);

  if(state.res < cost){
    showToast("è³‡æºä¸è¶³ï¼Œéœ€è¦ "+cost);
    assistantSay("å‡ç´šè¦æ›´å¤šè³‡æºï¼å…ˆæ”¶é›†/å»ºé€ å†å‡ç´šğŸ”¥");
    return;
  }

  state.res -= cost;

  if(type==="energy"){
    state.energyMax += 50;
    state.energy = Math.min(state.energy, state.energyMax);
    showToast("èƒ½é‡ä¸Šé™æå‡ï¼");
    assistantSay("ä½ å˜…èƒ½é‡ä¸Šé™æå‡å’—âš¡ å¯ä»¥åšæ›´å¤šäº‹ï¼");
  }else{
    state.buildings[type].level++;
    showToast("å‡ç´šæˆåŠŸï¼");
    assistantSay("å‡ç´šå®Œæˆï¼ç”¢é‡æœƒæ›´é«˜ğŸš€");
  }

  updateProduction();
  updateHUD();
}

/* ---------------------------
   CANVAS WORLD (Isometric)
---------------------------- */
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

let W = 0, H = 0;
function resize(){
  const rect = canvas.getBoundingClientRect();
  canvas.width = Math.floor(rect.width * devicePixelRatio);
  canvas.height = Math.floor(rect.height * devicePixelRatio);
  ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
  W = rect.width;
  H = rect.height;
}
window.addEventListener("resize", resize);
resize();

const gridSize = 62;
const isoAngle = Math.PI/6;

function gridToScreen(r,c){
  const x = (c - r) * (gridSize * Math.cos(isoAngle));
  const y = (c + r) * (gridSize * Math.sin(isoAngle));
  return { x: W/2 + x, y: 170 + y };
}

function drawIsoTile(r,c){
  const p = gridToScreen(r,c);
  const w = gridSize * Math.cos(isoAngle);
  const h = gridSize * Math.sin(isoAngle);

  const grad = ctx.createLinearGradient(p.x-w, p.y, p.x+w, p.y+h*2);
  grad.addColorStop(0, "#d9fbe6");
  grad.addColorStop(1, "#b7f7d3");

  ctx.fillStyle = grad;
  ctx.beginPath();
  ctx.moveTo(p.x, p.y);
  ctx.lineTo(p.x+w, p.y+h);
  ctx.lineTo(p.x, p.y+h*2);
  ctx.lineTo(p.x-w, p.y+h);
  ctx.closePath();
  ctx.fill();

  ctx.strokeStyle = "rgba(0,0,0,0.06)";
  ctx.lineWidth = 2;
  ctx.stroke();
}

function shadowEllipse(x,y,rx,ry,a){
  ctx.fillStyle = "rgba(0,0,0,"+a+")";
  ctx.beginPath();
  ctx.ellipse(x,y,rx,ry,0,0,Math.PI*2);
  ctx.fill();
}

/* ---------------------------
   BUILDINGS LIST (clickable)
---------------------------- */
const worldBuildings = [];

function spawnBuilding(type){
  // place on random free tile
  const r = Math.floor(rnd(1,6));
  const c = Math.floor(rnd(1,6));
  const pos = gridToScreen(r,c);

  worldBuildings.push({
    id: Math.random().toString(16).slice(2),
    type,
    r,c,
    x: pos.x,
    y: pos.y,
    bounce: 0,
    sparkle: 0
  });

  popText("+"+typeName(type), pos.x, pos.y-20, "#0f172a");
}

function typeName(type){
  if(type==="house") return "å°å±‹";
  if(type==="tree") return "æ£®æ—";
  if(type==="dome") return "åœ“é ‚";
  if(type==="robot") return "æ¡é›†ç«™";
  return type;
}

/* ---------------------------
   DRAW BUILDINGS (3D CARTOON)
---------------------------- */
function drawHouse(x,y,scale=1){
  shadowEllipse(x, y+50, 42*scale, 16*scale, 0.18);

  // left wall
  ctx.fillStyle = "#fde68a";
  ctx.beginPath();
  ctx.moveTo(x-40*scale, y+10*scale);
  ctx.lineTo(x, y+30*scale);
  ctx.lineTo(x, y+80*scale);
  ctx.lineTo(x-40*scale, y+60*scale);
  ctx.closePath();
  ctx.fill();

  // right wall
  ctx.fillStyle = "#fcd34d";
  ctx.beginPath();
  ctx.moveTo(x, y+30*scale);
  ctx.lineTo(x+40*scale, y+10*scale);
  ctx.lineTo(x+40*scale, y+60*scale);
  ctx.lineTo(x, y+80*scale);
  ctx.closePath();
  ctx.fill();

  // roof
  const roofGrad = ctx.createLinearGradient(x, y-30*scale, x, y+20*scale);
  roofGrad.addColorStop(0,"#fff1b8");
  roofGrad.addColorStop(1,"#fbbf24");
  ctx.fillStyle = roofGrad;
  ctx.beginPath();
  ctx.moveTo(x-50*scale, y+10*scale);
  ctx.lineTo(x, y-30*scale);
  ctx.lineTo(x+50*scale, y+10*scale);
  ctx.lineTo(x, y+35*scale);
  ctx.closePath();
  ctx.fill();

  // door
  ctx.fillStyle="#b45309";
  ctx.beginPath();
  ctx.roundRect(x-10*scale, y+55*scale, 20*scale, 25*scale, 6*scale);
  ctx.fill();

  // windows
  ctx.fillStyle="#dbeafe";
  ctx.beginPath();
  ctx.roundRect(x-28*scale, y+40*scale, 16*scale, 12*scale, 5*scale);
  ctx.roundRect(x+12*scale, y+32*scale, 16*scale, 12*scale, 5*scale);
  ctx.fill();

  ctx.strokeStyle="rgba(0,0,0,0.08)";
  ctx.lineWidth=2;
  ctx.stroke();
}

function drawTree(x,y,scale=1, sway=0){
  shadowEllipse(x+30*scale, y+58*scale, 28*scale, 12*scale, 0.16);

  const sx = Math.sin(sway)*6*scale;

  // trunk
  ctx.fillStyle="#92400e";
  ctx.beginPath();
  ctx.roundRect(x+22*scale+sx, y+35*scale, 14*scale, 30*scale, 6*scale);
  ctx.fill();

  // leaves
  const g = ctx.createRadialGradient(x+30*scale+sx, y+12*scale, 6*scale, x+30*scale+sx, y+12*scale, 40*scale);
  g.addColorStop(0,"#b9ffcf");
  g.addColorStop(1,"#22c55e");
  ctx.fillStyle=g;

  ctx.beginPath();
  ctx.arc(x+30*scale+sx, y+12*scale, 28*scale, 0, Math.PI*2);
  ctx.arc(x+12*scale+sx, y+25*scale, 22*scale, 0, Math.PI*2);
  ctx.arc(x+48*scale+sx, y+25*scale, 22*scale, 0, Math.PI*2);
  ctx.fill();

  // highlight
  ctx.fillStyle="rgba(255,255,255,0.28)";
  ctx.beginPath();
  ctx.arc(x+18*scale+sx, y+5*scale, 10*scale, 0, Math.PI*2);
  ctx.fill();
}

function drawDome(x,y,scale=1, glow=0){
  shadowEllipse(x, y+55*scale, 42*scale, 16*scale, 0.18);

  // base
  const baseGrad = ctx.createRadialGradient(x-10*scale, y+50*scale, 10*scale, x, y+40*scale, 70*scale);
  baseGrad.addColorStop(0,"#fff3c4");
  baseGrad.addColorStop(1,"#fcd34d");

  ctx.fillStyle=baseGrad;
  ctx.beginPath();
  ctx.ellipse(x, y+45*scale, 46*scale, 34*scale, 0, 0, Math.PI*2);
  ctx.fill();

  // dome top
  const topGrad = ctx.createRadialGradient(x-10*scale, y-10*scale, 10*scale, x, y-10*scale, 60*scale);
  topGrad.addColorStop(0,"#dbeafe");
  topGrad.addColorStop(1,"#3b82f6");

  ctx.fillStyle=topGrad;
  ctx.beginPath();
  ctx.arc(x, y+5*scale, 40*scale, Math.PI, 0);
  ctx.lineTo(x+40*scale, y+5*scale);
  ctx.arc(x, y+5*scale, 40*scale, 0, Math.PI);
  ctx.closePath();
  ctx.fill();

  // golden cap
  ctx.fillStyle="#fbbf24";
  ctx.beginPath();
  ctx.arc(x, y-5*scale, 12*scale, 0, Math.PI*2);
  ctx.fill();

  if(glow>0){
    ctx.fillStyle="rgba(255,255,255,"+(0.12*glow)+")";
    ctx.beginPath();
    ctx.arc(x, y+5*scale, 52*scale, 0, Math.PI*2);
    ctx.fill();
  }

  // door
  ctx.fillStyle="#7c2d12";
  ctx.beginPath();
  ctx.roundRect(x-12*scale, y+55*scale, 24*scale, 24*scale, 7*scale);
  ctx.fill();

  // windows
  ctx.fillStyle="#bfdbfe";
  ctx.beginPath();
  ctx.arc(x-22*scale, y+45*scale, 10*scale, 0, Math.PI*2);
  ctx.arc(x+22*scale, y+45*scale, 10*scale, 0, Math.PI*2);
  ctx.fill();
}

function drawRobotStation(x,y,scale=1, spin=0){
  shadowEllipse(x, y+55*scale, 44*scale, 16*scale, 0.18);

  // platform
  ctx.fillStyle="#e2e8f0";
  ctx.beginPath();
  ctx.roundRect(x-46*scale, y+40*scale, 92*scale, 36*scale, 14*scale);
  ctx.fill();

  // machine body
  const g = ctx.createLinearGradient(x-30*scale, y+10*scale, x+30*scale, y+70*scale);
  g.addColorStop(0,"#e0f2fe");
  g.addColorStop(1,"#93c5fd");
  ctx.fillStyle=g;
  ctx.beginPath();
  ctx.roundRect(x-30*scale, y+10*scale, 60*scale, 44*scale, 14*scale);
  ctx.fill();

  // core
  ctx.fillStyle="#0ea5e9";
  ctx.beginPath();
  ctx.arc(x, y+32*scale, 10*scale, 0, Math.PI*2);
  ctx.fill();

  // antenna
  ctx.strokeStyle="#334155";
  ctx.lineWidth=4;
  ctx.beginPath();
  ctx.moveTo(x, y+10*scale);
  ctx.lineTo(x, y-10*scale);
  ctx.stroke();

  ctx.fillStyle="#f43f5e";
  ctx.beginPath();
  ctx.arc(x, y-12*scale, 6*scale, 0, Math.PI*2);
  ctx.fill();

  // drone rotor
  const rx = x + Math.cos(spin)*30*scale;
  const ry = y - 20*scale + Math.sin(spin)*8*scale;
  ctx.fillStyle="rgba(255,255,255,0.9)";
  ctx.beginPath();
  ctx.ellipse(rx, ry, 18*scale, 8*scale, spin, 0, Math.PI*2);
  ctx.fill();

  ctx.fillStyle="rgba(0,0,0,0.12)";
  ctx.beginPath();
  ctx.ellipse(rx, ry+20*scale, 14*scale, 5*scale, 0, 0, Math.PI*2);
  ctx.fill();
}

/* ---------------------------
   POP TEXT FX
---------------------------- */
const popTexts = [];
function popText(text,x,y,color){
  popTexts.push({text,x,y,vy:-0.7,life:1,color});
}

function drawPopTexts(dt){
  for(let i=popTexts.length-1;i>=0;i--){
    const p = popTexts[i];
    p.y += p.vy * dt*60;
    p.life -= dt*0.9;

    ctx.globalAlpha = clamp(p.life,0,1);
    ctx.fillStyle = p.color || "#111";
    ctx.font = "900 14px system-ui";
    ctx.fillText(p.text, p.x-30, p.y);

    if(p.life<=0) popTexts.splice(i,1);
  }
  ctx.globalAlpha = 1;
}

/* ---------------------------
   CLICK DETECTION
---------------------------- */
canvas.addEventListener("click", (e)=>{
  const rect = canvas.getBoundingClientRect();
  const mx = e.clientX - rect.left;
  const my = e.clientY - rect.top;

  // check buildings from top to bottom
  for(let i=worldBuildings.length-1;i>=0;i--){
    const b = worldBuildings[i];
    const dx = mx - b.x;
    const dy = my - (b.y+35);

    // simple hit circle
    if(dx*dx + dy*dy < 55*55){
      b.bounce = 1;
      b.sparkle = 1;

      if(b.type==="house"){
        assistantSay("ğŸ  å°å±‹ï¼šç”¢ç”Ÿè³‡æºï¼ä½ å¯ä»¥å‡ç´šæå‡æ•ˆç‡ã€‚");
      }
      if(b.type==="tree"){
        assistantSay("ğŸŒ³ æ£®æ—ï¼šç”¢ç”Ÿèƒ½é‡âš¡ èƒ½é‡è¶Šé«˜è¶Šå¼·ã€‚");
      }
      if(b.type==="dome"){
        assistantSay("ğŸ› åœ“é ‚ï¼šæ…¢æ…¢ç”¢ç”Ÿ AENOğŸª™ éå¸¸é‡è¦ï¼");
      }
      if(b.type==="robot"){
        assistantSay("ğŸ¤– æ¡é›†ç«™ï¼šé«˜é€Ÿè³‡æºç”Ÿç”¢æ©Ÿå™¨ï¼");
      }

      showToast(typeName(b.type)+" å·²é¸ä¸­");
      return;
    }
  }
});

/* ---------------------------
   BACKGROUND FX
---------------------------- */
const clouds = [];
for(let i=0;i<5;i++){
  clouds.push({
    x:rnd(-200,W+200),
    y:rnd(70,160),
    s:rnd(0.7,1.3),
    sp:rnd(10,22)
  });
}

function drawCloud(c){
  ctx.globalAlpha=0.85;
  ctx.fillStyle="#ffffff";
  ctx.beginPath();
  ctx.arc(c.x, c.y, 24*c.s, 0, Math.PI*2);
  ctx.arc(c.x+22*c.s, c.y+6*c.s, 18*c.s, 0, Math.PI*2);
  ctx.arc(c.x-20*c.s, c.y+8*c.s, 16*c.s, 0, Math.PI*2);
  ctx.arc(c.x+4*c.s, c.y-10*c.s, 18*c.s, 0, Math.PI*2);
  ctx.fill();
  ctx.globalAlpha=1;
}

/* ---------------------------
   GAME LOOP
---------------------------- */
let last = performance.now();

function loop(now){
  const dt = (now-last)/1000;
  last = now;

  // economy tick
  state.res += state.production.resPerSec * dt;
  state.energy += state.production.energyPerSec * dt;
  state.aeno += state.production.aenoPerSec * dt;

  state.energy = clamp(state.energy, 0, state.energyMax);

  // background
  ctx.clearRect(0,0,W,H);

  // sky gradient
  const sky = ctx.createLinearGradient(0,0,0,H);
  sky.addColorStop(0,"#dff6ff");
  sky.addColorStop(1,"#f6fbff");
  ctx.fillStyle=sky;
  ctx.fillRect(0,0,W,H);

  // clouds move
  for(const c of clouds){
    c.x += c.sp * dt;
    if(c.x > W+240) c.x = -240;
    drawCloud(c);
  }

  // island base
  ctx.fillStyle="rgba(0,0,0,0.06)";
  ctx.beginPath();
  ctx.ellipse(W/2, H*0.62, 170, 45, 0, 0, Math.PI*2);
  ctx.fill();

  // tiles
  for(let r=0;r<7;r++){
    for(let c=0;c<7;c++){
      drawIsoTile(r,c);
    }
  }

  // draw buildings
  // sort by y for depth
  worldBuildings.sort((a,b)=> (a.r+a.c)-(b.r+b.c));

  let sway = now*0.0018;

  for(const b of worldBuildings){
    const base = gridToScreen(b.r,b.c);

    // bounce effect
    if(b.bounce>0) b.bounce -= dt*2.6;
    const bounceY = Math.sin(clamp(b.bounce,0,1)*Math.PI) * -18;

    if(b.sparkle>0) b.sparkle -= dt*1.4;

    if(b.type==="house") drawHouse(base.x, base.y + bounceY, 1);
    if(b.type==="tree") drawTree(base.x, base.y + bounceY, 1, sway);
    if(b.type==="dome") drawDome(base.x, base.y + bounceY, 1, b.sparkle);
    if(b.type==="robot") drawRobotStation(base.x, base.y + bounceY, 1, now*0.006);
  }

  drawPopTexts(dt);

  // update HUD 6 times/sec
  loop._t = (loop._t||0) + dt;
  if(loop._t > 0.16){
    loop._t = 0;
    updateHUD();
  }

  requestAnimationFrame(loop);
}

/* ---------------------------
   INIT
---------------------------- */
updateProduction();
updateHUD();

assistantSay("ä½ å¥½ï¼æˆ‘ä¿‚ <b>FENIX</b> ğŸ¦Š<br>ä½ è€Œå®¶å–ºé ˜åœ°ä¸­å¿ƒï¼Œè©¦ä¸‹èµ·ç¬¬ä¸€é–“å°å±‹ğŸ ");

showToast("AENO V3 å·²å•Ÿå‹•");

requestAnimationFrame(loop);
</script>
</body>
</html>
