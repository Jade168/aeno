<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<title>AENO V3 æ–‡æ˜å¸åœ‹ï¼ˆå®Œæ•´ç‰ˆï¼‰</title>
<style>
* { margin:0; padding:0; box-sizing:border-box; font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans HK", sans-serif; }
body { background:#111; color:#fff; overflow:hidden; user-select:none; touch-action: none; }
#loginScreen { position:fixed; inset:0; background:#000; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:20px; z-index:9999; }
#loginScreen input { padding:12px 20px; border-radius:8px; border:none; font-size:16px; width:80%; max-width:300px; background:#222; color:#fff; }
#loginScreen button { padding:12px 30px; border-radius:8px; border:none; font-size:16px; background:#0070ff; color:#fff; cursor:pointer; }
#loginScreen .guestBtn { background:#444; }
#bootScreen { position:fixed; inset:0; background:#000; color:#0f0; display:flex; align-items:center; justify-content:center; font-size:22px; z-index:9998; display:none; }
#gameCanvas { display:block; width:100vw; height:100vh; position:absolute; top:0; left:0; z-index:1; }
#threeCanvas { position: absolute; top: 0; left: 0; z-index: 0; width: 100%; height: 100%; pointer-events: none; }
#mainPanel { position:fixed; top:10px; left:10px; width:360px; max-width:90vw; height:560px; max-height:80vh; background:rgba(0,0,0,0.85); border:1px solid #444; border-radius:10px; padding:10px; overflow:hidden; display:flex; flex-direction:column; z-index:10; }
#panelHeader { padding:8px; background:#222; border-radius:6px; cursor:move; margin-bottom:8px; }
.tabBar { display:flex; gap:6px; margin-bottom:8px; flex-wrap:wrap; }
.tabBtn { padding:6px 10px; background:#333; border:none; border-radius:6px; color:#fff; font-size:12px; cursor:pointer; flex:1; min-width:45px; }
.tabBtn.active { background:#0070ff; }
.tabPage { display:none; flex:1; overflow:auto; padding-right:6px; }
.tabPage.active { display:block; }
.row { display:flex; justify-content:space-between; padding:4px 0; font-size:14px; border-bottom:1px solid #333; }
.btn { padding:8px 10px; background:#0070ff; border:none; border-radius:6px; color:#fff; cursor:pointer; margin-top:4px; width:100%; }
.btn.danger { background:#c43; }
.btn.gray { background:#444; }
.btn.small { width:auto; flex:1; }
.hidden { display:none !important; }
#chatBox { position:fixed; bottom:10px; right:10px; width:320px; max-width:90vw; height:400px; max-height:50vh; background:rgba(0,0,0,0.85); border:1px solid #555; border-radius:10px; display:flex; flex-direction:column; z-index:10; }
#chatLog { flex:1; padding:8px; font-size:12px; overflow-y:auto; }
#chatInput { width:100%; padding:8px; background:#222; border:none; color:#fff; border-radius:6px 0 0 6px; }
#panelMinBtn, #panelHideBtn, #panelRestoreBtn { padding:4px 8px; background:#444; border:none; color:#fff; border-radius:4px; cursor:pointer; }
#panelRestoreBtn { position:fixed; bottom:10px; left:10px; z-index:10; }
.marketLine { display:flex; gap:6px; margin:6px 0; align-items:center; flex-wrap:wrap; }
.marketLine select, .marketLine input { padding:6px; flex:1; min-width:60px; background:#222; border:1px solid #444; color:#fff; border-radius:6px; }
#sysLog { height:80px; overflow-y:auto; font-size:12px; color:#ccc; background:#111; padding:4px; margin-top:6px; border-radius:6px; }
/* AIå°å‹•ç‰©æ¨£å¼ */
#aiPet { position:fixed; top:20px; right:20px; width:120px; height:120px; cursor:pointer; z-index:999; border-radius:50%; }
#petAdHint { position:fixed; top:150px; right:20px; background:rgba(0,0,0,0.8); padding:8px; border-radius:6px; font-size:12px; color:#fff; display:none; z-index:999; }
/* ç¸æ½®å‹•ç•«æ¨£å¼ */
.beastEffect { position:fixed; width:80px; height:80px; border-radius:50%; background:rgba(255,0,0,0.5); display:none; z-index:997; pointer-events: none; animation: beastHit 1s ease-out forwards; }
@keyframes beastHit { 0% { transform: scale(0.5); opacity:1; } 100% { transform: scale(2); opacity:0; } }
/* 3D Logoå®¹å™¨ */
#logoContainer { width:200px; height:200px; margin-bottom:20px; }
</style>
</head>
<body>

<!-- ç™»å…¥ç•Œé¢ -->
<div id="loginScreen">
  <div id="logoContainer"></div>
  <h1>AENO V3 æ–‡æ˜å¸åœ‹</h1>
  <input type="text" id="userName" placeholder="è«‹è¼¸å…¥ç”¨æˆ¶åï¼ˆéš¨æ„å¡«ï¼‰">
  <button id="loginBtn">ç™»å…¥éŠæˆ²</button>
  <button id="guestBtn" class="guestBtn">æ¸¸å®¢ç™»å…¥</button>
</div>

<!-- è¼‰å…¥ç•Œé¢ -->
<div id="bootScreen">è¼‰å…¥ AENO V3 æ–‡æ˜å¸åœ‹...</div>

<!-- éŠæˆ²ç•«å¸ƒ -->
<canvas id="gameCanvas"></canvas>
<canvas id="threeCanvas"></canvas>
  
<!-- AIå°å‹•ç‰© -->
<canvas id="aiPet"></canvas>
<div id="petAdHint">é»æ“Šæ’­æ”¾å»£å‘Šï¼ŒAENOæ”¶ç›ŠÃ—2ï¼</div>

<!-- ç¸æ½®å‹•ç•« -->
<div class="beastEffect" id="beastEffect"></div>

<!-- æ§åˆ¶é¢æ¿ -->
<div id="mainPanel">
  <div id="panelHeader">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <b>AENO æ§åˆ¶é¢æ¿</b>
      <div style="display:flex; gap:4px;">
        <button id="panelMinBtn">ç¸®</button>
        <button id="panelHideBtn">éš±</button>
      </div>
    </div>
  </div>

  <div class="tabBar">
    <button class="tabBtn active" data-tab="tabMain">ä¸»é </button>
    <button class="tabBtn" data-tab="tabBuild">å»ºé€ </button>
    <button class="tabBtn" data-tab="tabMarket">äº¤æ˜“æ‰€</button>
    <button class="tabBtn" data-tab="tabTech">ç§‘æŠ€</button>
    <button class="tabBtn" data-tab="tabChat">åŠ©æ‰‹</button>
  </div>

  <div id="tabMain" class="tabPage active">
    <div class="row"><span>ç”¨æˆ¶å</span><span id="userNameDisplay">æ¸¸å®¢</span></div>
    <div class="row"><span>é‡‘å¹£</span><span id="statGold">0</span></div>
    <div class="row"><span>AENO</span><span id="statAeno">0.000000</span></div>
    <div class="row"><span>æœ¨æ</span><span id="statWood">0</span></div>
    <div class="row"><span>çŸ³é ­</span><span id="statStone">0</span></div>
    <div class="row"><span>éµç¤¦</span><span id="statIron">0</span></div>
    <div class="row"><span>ç³§é£Ÿ</span><span id="statFood">0</span></div>
    <div class="row"><span>äººå£</span><span id="statPop">0</span></div>
    <div class="row"><span>é ˜åœŸ</span><span id="statTerritory">0</span></div>
    <div class="row"><span>æ–‡æ˜åº¦</span><span id="statCivil">0%</span></div>
    <div class="row"><span>ç¸æ½®</span><span id="statBeast">æœªå•Ÿå‹•</span></div>
    <button class="btn" id="btnExpand">æ“´å¼µé ˜åœŸ</button>
    <button class="btn" id="btnZoomReset">é‡ç½®è¦–è§’</button>
    <div style="display:flex; gap:6px; margin-top:6px;">
      <button class="btn gray small" id="btnAutoOn">è‡ªå‹•ON</button>
      <button class="btn gray small" id="btnAutoOff">è‡ªå‹•OFF</button>
    </div>
    <button class="btn" id="btnSaveNow">ç«‹å³ä¿å­˜</button>
    <button class="btn danger" id="btnReset">æ¸…é™¤å­˜æª”</button>
    <div id="sysLog"></div>
  </div>

  <div id="tabBuild" class="tabPage">
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:6px;">
      <button class="btn buildBtn" data-build="house">æˆ¿å±‹</button>
      <button class="btn buildBtn" data-build="farm">è¾²ç”°</button>
      <button class="btn buildBtn" data-build="lumber">ä¼æœ¨å ´</button>
      <button class="btn buildBtn" data-build="quarry">çŸ³å ´</button>
      <button class="btn buildBtn" data-build="mine">ç¤¦å ´</button>
      <button class="btn buildBtn" data-build="factory">å·¥å» </button>
      <button class="btn buildBtn" data-build="wall">åŸç‰†</button>
      <button class="btn buildBtn" data-build="robot">æ©Ÿå™¨äººä¸­å¿ƒ</button>
    </div>
    <button class="btn" style="background:#0a0; margin-top:10px;" id="btnUpgradeAll">ä¸€éµå‡ç´šï¼ˆç„¡ä¸Šé™ï¼‰</button>
  </div>

  <div id="tabMarket" class="tabPage">
    <div class="marketLine">
      <select id="marketItem">
        <option value="wood">æœ¨æ</option>
        <option value="stone">çŸ³é ­</option>
        <option value="iron">éµç¤¦</option>
        <option value="food">ç³§é£Ÿ</option>
      </select>
      <input id="marketQty" type="number" value="100" min="1">
      <button class="btn small" id="btnBuy">è²·å…¥</button>
      <button class="btn small" id="btnSell">è³£å‡º</button>
    </div>
    <div id="marketPriceHint" style="font-size:12px; color:#ccc; margin:8px 0;"></div>
    <div style="display:flex; gap:6px; margin-top:10px;">
      <button class="btn gray small" id="btnPlayAd">æ’­æ”¾å»£å‘Šæ­Œæ›²</button>
      <button class="btn gray small" id="btnStopAd">åœæ­¢</button>
    </div>
    <audio id="adAudio" loop crossorigin="anonymous">
  </div>

  <div id="tabTech" class="tabPage">
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:6px;">
      <button class="btn techBtn" data-tech="tools">å·¥å…·ç§‘æŠ€</button>
      <button class="btn techBtn" data-tech="agri">è¾²æ¥­ç§‘æŠ€</button>
      <button class="btn techBtn" data-tech="mining">æ¡ç¤¦ç§‘æŠ€</button>
      <button class="btn techBtn" data-tech="robotics">æ©Ÿå™¨äººç§‘æŠ€</button>
      <button class="btn techBtn" data-tech="economy">ç¶“æ¿Ÿç§‘æŠ€</button>
    </div>
  </div>

  <div id="tabChat" class="tabPage">
    <button class="btn" id="assistantTalkBtn">é–‹å•ŸAIåŠ©æ‰‹</button>
  </div>
</div>

<button id="panelRestoreBtn" class="btn hidden">é¡¯ç¤ºé¢æ¿</button>

<div id="chatBox" class="hidden">
  <div id="chatLog"></div>
  <div style="display:flex;">
    <input id="chatInput" placeholder="è¼¸å…¥æŒ‡ä»¤ï¼šè‡ªå‹• / åœæ­¢ / å‡ç´š">
    <button class="btn small" id="chatSend">é€å‡º</button>
    <button class="btn gray small" id="chatClose">é—œé–‰</button>
  </div>
</div>

<!-- Three.js CDN -->

  <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
  
<script>
(() => {
"use strict";

// =========================
// å…¨åŸŸè®Šæ•¸
// =========================
let USER_DATA = { id: "", name: "æ¸¸å®¢" };
const STORAGE_USER_KEY = "AENO_V3_USER";
const STORAGE_SAVE_KEY = "AENO_V3_SAVE_";
let game = null;
let aenoMultiplier = 1;
let beastList = [];
let adPlaying = false;
let adTimer = null;
let threeScene, threeCamera, threeRenderer, aenoLogoMesh;

// =========================
// åŸºæœ¬è¨­å®š
// =========================
const VERSION = "3.0.0";
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
const bootScreen = document.getElementById("bootScreen");
const loginScreen = document.getElementById("loginScreen");
const aiPet = document.getElementById("aiPet");
const petCtx = aiPet.getContext("2d");
const beastEffect = document.getElementById("beastEffect");
const petAdHint = document.getElementById("petAdHint");
const dpr = window.devicePixelRatio || 1;

// UIå…ƒç´ ç²å–
const statGold = document.getElementById("statGold");
const statAeno = document.getElementById("statAeno");
const statWood = document.getElementById("statWood");
const statStone = document.getElementById("statStone");
const statIron = document.getElementById("statIron");
const statFood = document.getElementById("statFood");
const statPop = document.getElementById("statPop");
const statTerritory = document.getElementById("statTerritory");
const statCivil = document.getElementById("statCivil");
const statBeast = document.getElementById("statBeast");
const userNameDisplay = document.getElementById("userNameDisplay");
const sysLog = document.getElementById("sysLog");
const assistantTalkBtn = document.getElementById("assistantTalkBtn");
const chatBox = document.getElementById("chatBox");
const chatClose = document.getElementById("chatClose");
const chatSend = document.getElementById("chatSend");
const chatInput = document.getElementById("chatInput");
const chatLog = document.getElementById("chatLog");
const btnSaveNow = document.getElementById("btnSaveNow");
const btnReset = document.getElementById("btnReset");
const btnExpand = document.getElementById("btnExpand");
const btnZoomReset = document.getElementById("btnZoomReset");
const btnAutoOn = document.getElementById("btnAutoOn");
const btnAutoOff = document.getElementById("btnAutoOff");
const btnPlayAd = document.getElementById("btnPlayAd");
const btnStopAd = document.getElementById("btnStopAd");
const adAudio = document.getElementById("adAudio");
const marketItem = document.getElementById("marketItem");
const marketQty = document.getElementById("marketQty");
const btnBuy = document.getElementById("btnBuy");
const btnSell = document.getElementById("btnSell");
const marketPriceHint = document.getElementById("marketPriceHint");
const panel = document.getElementById("mainPanel");
const panelHeader = document.getElementById("panelHeader");
const panelMinBtn = document.getElementById("panelMinBtn");
const panelHideBtn = document.getElementById("panelHideBtn");
const panelRestoreBtn = document.getElementById("panelRestoreBtn");
const btnUpgradeAll = document.getElementById("btnUpgradeAll");
const userNameInput = document.getElementById("userName");
const loginBtn = document.getElementById("loginBtn");
const guestBtn = document.getElementById("guestBtn");
const logoContainer = document.getElementById("logoContainer");
const threeCanvas = document.getElementById("threeCanvas");

// =========================
// Canvas é«˜æ¸…å±é€‚é…
// =========================
function resize() {
  // éŠæˆ²ç•«å¸ƒ
  canvas.width = Math.floor(window.innerWidth * dpr);
  canvas.height = Math.floor(window.innerHeight * dpr);
  canvas.style.width = window.innerWidth + "px";
  canvas.style.height = window.innerHeight + "px";
  ctx.scale(dpr, dpr);

  // AIå°å‹•ç‰©ç•«å¸ƒ
  aiPet.width = 120 * dpr;
  aiPet.height = 120 * dpr;
  aiPet.style.width = "120px";
  aiPet.style.height = "120px";
  petCtx.scale(dpr, dpr);

  // 3Dç•«å¸ƒ
  if (threeRenderer) {
    threeRenderer.setSize(window.innerWidth, window.innerHeight);
    threeCamera.aspect = window.innerWidth / window.innerHeight;
    threeCamera.updateProjectionMatrix();
  }
}
window.addEventListener("resize", resize);

// =========================
// å·¥å…·å‡½æ•¸
// =========================
function xmur3(str) {
  let h = 1779033703 ^ str.length;
  for (let i = 0; i < str.length; i++) {
    h = Math.imul(h ^ str.charCodeAt(i), 3432918353);
    h = (h << 13) | (h >>> 19);
  }
  return function () {
    h = Math.imul(h ^ (h >>> 16), 2246822507);
    h = Math.imul(h ^ (h >>> 13), 3266489909);
    return (h ^= h >>> 16) >>> 0;
  };
}

function mulberry32(a) {
  return function () {
    let t = (a += 0x6D2B79F5);
    t = Math.imul(t ^ (t >>> 15), t | 1);
    t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
    return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
  };
}

function clamp(v, a, b) {
  return Math.max(a, Math.min(b, v));
}

// =========================
// åœ°åœ–è¨­å®š
// =========================
const MAP_W = 80;
const MAP_H = 80;
const TILE = 128;
const ISO_ANGLE = Math.PI / 6;
const COS = Math.cos(ISO_ANGLE);
const SIN = Math.sin(ISO_ANGLE);
let cameraX = 0;
let cameraY = 0;
let zoom = 0.5;
const ZOOM_MIN = 0.2;
const ZOOM_MAX = 1.5;

const TILE_TYPES = {
  grass: 0,
  forest: 1,
  mountain: 2,
  river: 3,
  planet: 4,
  blackHole: 5,
  beast: 6
};

let map = [];

// =========================
// ç™»å…¥ç³»çµ±
// =========================
function loadUser() {
  const raw = localStorage.getItem(STORAGE_USER_KEY);
  if (raw) {
    USER_DATA = JSON.parse(raw);
    userNameDisplay.textContent = USER_DATA.name;
    return true;
  }
  return false;
}

function saveUser() {
  localStorage.setItem(STORAGE_USER_KEY, JSON.stringify(USER_DATA));
}

loginBtn.addEventListener("click", () => {
  const name = userNameInput.value.trim();
  if (!name) {
    alert("è«‹è¼¸å…¥ç”¨æˆ¶åï¼");
    return;
  }
  USER_DATA = {
    id: Date.now().toString(),
    name: name
  };
  saveUser();
  userNameDisplay.textContent = name;
  loginScreen.style.display = "none";
  bootScreen.style.display = "flex";
  initGame();
});

guestBtn.addEventListener("click", () => {
  USER_DATA = {
    id: "guest_" + Date.now().toString(),
    name: "æ¸¸å®¢"
  };
  userNameDisplay.textContent = "æ¸¸å®¢";
  loginScreen.style.display = "none";
  bootScreen.style.display = "flex";
  initGame();
});

// =========================
// éŠæˆ²åˆå§‹æ•¸æ“š
// =========================
const DEFAULT_SAVE = () => ({
  version: VERSION,
  seed: "AENO-" + Math.floor(Math.random() * 99999999),
  lastTick: Date.now(),
  autoMode: true,
  resources: {
    gold: 2000,
    aeno: 0,
    wood: 800,
    stone: 800,
    iron: 800,
    food: 800
  },
  stats: {
    population: 4,
    territory: 9,
    civil: 15,
    wall: 0
  },
  buildings: {
    house: 2,
    farm: 1,
    lumber: 1,
    quarry: 0,
    mine: 0,
    factory: 0,
    wall: 0,
    robot: 0
  },
  buildingLevels: {
    house:1, farm:1, lumber:1, quarry:1, mine:1, factory:1, wall:1, robot:1
  },
  tech: {
    tools: 0,
    agri: 0,
    mining: 0,
    robotics: 0,
    economy: 0
  },
  ad: {
    listeningSeconds: 0,
    todayScore: 0
  },
  world: {
    explored: [],
    beastsKilled: 0,
    lootPending: 0
  },
  market: {
    wood: 5,
    stone: 7,
    iron: 15,
    food: 4,
    lastUpdate: Date.now()
  },
  buildQueue: []
});

function log(msg) {
  const time = new Date().toLocaleTimeString();
  sysLog.innerHTML = `<div>ğŸ•’ ${time} - ${msg}</div>` + sysLog.innerHTML;
  sysLog.scrollTop = 0;
}

// =========================
// å­˜æª”ç³»çµ±
// =========================
function saveGame() {
  game.lastTick = Date.now();
  localStorage.setItem(STORAGE_SAVE_KEY + USER_DATA.id, JSON.stringify(game));
  log("å·²ä¿å­˜éŠæˆ²");
}

function loadGame() {
  const raw = localStorage.getItem(STORAGE_SAVE_KEY + USER_DATA.id);
  if (!raw) return DEFAULT_SAVE();
  try {
    const data = JSON.parse(raw);
    if (!data.resources || !data.stats) return DEFAULT_SAVE();
    if(!data.buildingLevels) data.buildingLevels = DEFAULT_SAVE().buildingLevels;
    return data;
  } catch {
    return DEFAULT_SAVE();
  }
}

// =========================
// é›¢ç·šè£œç®—
// =========================
function offlineProgress() {
  const now = Date.now();
  const dt = Math.max(0, now - game.lastTick);
  const seconds = Math.floor(dt / 1000);
  if (seconds <= 2) return;
  const maxSeconds = 3600 * 8;
  const safeSec = Math.min(seconds, maxSeconds);
  for (let i = 0; i < safeSec; i++) {
    tickLogic(1, true);
  }
  log(`é›¢ç·šè£œç®—å®Œæˆï¼š${safeSec} ç§’`);
}

// =========================
// åœ°åœ–ç”Ÿæˆ
// =========================
function generateMap() {
  const seedFn = xmur3(game.seed);
  const rand = mulberry32(seedFn());
  map = [];

  for (let y = 0; y < MAP_H; y++) {
    const row = [];
    for (let x = 0; x < MAP_W; x++) {
      let t = TILE_TYPES.grass;
      const r = rand();
      if (r < 0.18) t = TILE_TYPES.forest;
      else if (r < 0.26) t = TILE_TYPES.mountain;
      else if (r < 0.30) t = TILE_TYPES.river;
      row.push(t);
    }
    map.push(row);
  }

  // ç”Ÿæˆ20å€‹æ˜Ÿçƒ
  for (let i = 0; i < 20; i++) {
    const x = Math.floor(rand() * (MAP_W - 10)) + 5;
    const y = Math.floor(rand() * (MAP_H - 10)) + 5;
    map[y][x] = TILE_TYPES.planet;
    for (let dy = -2; dy <= 2; dy++) {
      for (let dx = -2; dx <= 2; dx++) {
        if (y + dy >= 0 && y + dy < MAP_H && x + dx >= 0 && x + dx < MAP_W) {
          map[y + dy][x + dx] = TILE_TYPES.grass;
        }
      }
    }
  }

  // ç”Ÿæˆ5å€‹é»‘æ´
  for (let i = 0; i < 5; i++) {
    const x = Math.floor(rand() * (MAP_W - 10)) + 5;
    const y = Math.floor(rand() * (MAP_H - 10)) + 5;
    map[y][x] = TILE_TYPES.blackHole;
    for (let dy = -3; dy <= 3; dy++) {
      for (let dx = -3; dx <= 3; dx++) {
        if (y + dy >= 0 && y + dy < MAP_H && x + dx >= 0 && x + dx < MAP_W) {
          map[y + dy][x + dx] = TILE_TYPES.mountain;
        }
      }
    }
  }

  // èµ·é»è³‡æº
  const townX = 40;
  const townY = 40;
  for (let y = 35; y < 45; y++) {
    for (let x = 35; x < 45; x++) {
      if (Math.random() < 0.45) map[y][x] = TILE_TYPES.forest;
      if (Math.random() < 0.2) map[y][x] = TILE_TYPES.river;
    }
  }

  for (let y = 38; y < 42; y++) {
    for (let x = 38; x < 42; x++) {
      map[y][x] = TILE_TYPES.grass;
    }
  }

  log("å®‡å®™åœ°åœ–ç”Ÿæˆå®Œæˆï¼š20æ˜Ÿçƒ+5é»‘æ´");
}

// =========================
// ç¸æ½®ç³»çµ±
// =========================
function spawnBeast() {
  const rand = mulberry32(xmur3(game.seed + Date.now())());
  const x = Math.floor(rand() * (MAP_W - 20)) + 10;
  const y = Math.floor(rand() * (MAP_H - 20)) + 10;
  if (map[y][x] !== TILE_TYPES.grass) return;
  
  map[y][x] = TILE_TYPES.beast;
  beastList.push({ x, y, hp: 10 });
  log(`âš”ï¸ ç¸æ½®æ€ªç¸å‡ºç¾åœ¨(${x},${y})ï¼é»æ“Šæ“Šæ®ºç²å¾—çå‹µï¼`);
}

function killBeast(x, y) {
  map[y][x] = TILE_TYPES.grass;
  const index = beastList.findIndex(b => b.x === x && b.y === y);
  if (index !== -1) {
    beastList.splice(index, 1);
    game.world.beastsKilled += 1;
    const loot = Math.floor(50 + Math.random() * 100);
    game.world.lootPending += loot;
    showBeastEffect(x, y);
    log(`âš”ï¸ æ“Šæ®ºç¸æ½®æ€ªç¸ï¼Œç²å¾— ${loot} é‡‘å¹£æˆ°åˆ©å“ï¼`);
  }
}

function showBeastEffect(x, y) {
  const p = gridToScreen(x, y);
  beastEffect.style.left = (p.x - 40) + "px";
  beastEffect.style.top = (p.y - 40) + "px";
  beastEffect.style.display = "block";
  setTimeout(() => {
    beastEffect.style.display = "none";
  }, 1000);
}

// ç¸æ½®å®šæ™‚ç”Ÿæˆ
setInterval(() => {
  if (!game || game.stats.civil < 100) return;
  if (beastList.length < 5 && Math.random() < 0.1) {
    spawnBeast();
  }
}, 10000);

// =========================
// å»ºç¯‰ä½ç½®
// =========================
const townCenter = { x: 40, y: 40 };
const placedBuildings = [];

function rebuildPlacedBuildings() {
  placedBuildings.length = 0;
  const add = (type, count) => {
    for (let i = 0; i < count; i++) {
      placedBuildings.push({
        type,
        x: townCenter.x + ((i % 5) - 2),
        y: townCenter.y + (Math.floor(i / 5) - 2),
        level: game.buildingLevels[type]
      });
    }
  };
  add("house", game.buildings.house);
  add("farm", game.buildings.farm);
  add("lumber", game.buildings.lumber);
  add("quarry", game.buildings.quarry);
  add("mine", game.buildings.mine);
  add("factory", game.buildings.factory);
  add("wall", game.buildings.wall);
  add("robot", game.buildings.robot);
}

// =========================
// ISOåº§æ¨™è½‰æ›
// =========================
function gridToScreen(gx, gy) {
  const x = (gx - gy) * (TILE * COS);
  const y = (gx + gy) * (TILE * SIN);
  return {
    x: x * zoom + (window.innerWidth / 2),
    y: y * zoom + (window.innerHeight / 2)
  };
}

function screenToGrid(sx, sy) {
  const x = (sx - window.innerWidth / 2) / zoom;
  const y = (sy - window.innerHeight / 2) / zoom;
  const gx = (x / (TILE * COS) + y / (TILE * SIN)) / 2;
  const gy = (y / (TILE * SIN) - x / (TILE * COS)) / 2;
  return { x: Math.floor(gx), y: Math.floor(gy) };
}

// =========================
// åœ°åœ–ç¹ªè£½
// =========================
function drawTile(gx, gy, type) {
  const p = gridToScreen(gx, gy);
  const cx = p.x;
  const cy = p.y;
  const w = TILE * COS * zoom;
  const h = TILE * SIN * zoom;
  let fill = "#dcfce7";
  let stroke = "#bbf7d0";

  if (type === TILE_TYPES.forest) { fill = "#bbf7d0"; stroke = "#86efac"; }
  if (type === TILE_TYPES.mountain) { fill = "#e2e8f0"; stroke = "#cbd5e1"; }
  if (type === TILE_TYPES.river) { fill = "#bfdbfe"; stroke = "#93c5fd"; }
  if (type === TILE_TYPES.planet) { fill = "#fbbf24"; stroke = "#f59e0b"; }
  if (type === TILE_TYPES.blackHole) { fill = "#000"; stroke = "#333"; }
  if (type === TILE_TYPES.beast) { fill = "#ef4444"; stroke = "#b91c1c"; }

  ctx.fillStyle = fill;
  ctx.strokeStyle = stroke;
  ctx.lineWidth = 2 * zoom;
  ctx.beginPath();
  ctx.moveTo(cx, cy);
  ctx.lineTo(cx + w, cy + h);
  ctx.lineTo(cx, cy + 2 * h);
  ctx.lineTo(cx - w, cy + h);
  ctx.closePath();
  ctx.fill();
  ctx.stroke();

  if (type === TILE_TYPES.forest) drawTree(cx, cy + h);
  else if (type === TILE_TYPES.mountain) drawMountain(cx, cy + h);
  else if (type === TILE_TYPES.river) drawWater(cx, cy + h);
  else if (type === TILE_TYPES.planet) drawPlanet(cx, cy + h);
  else if (type === TILE_TYPES.blackHole) drawBlackHole(cx, cy + h);
  else if (type === TILE_TYPES.beast) drawBeast(cx, cy + h);
}

function drawPlanet(x, y) {
  const size = 30 * zoom;
  const grad = ctx.createRadialGradient(x, y, 0, x, y, size);
  grad.addColorStop(0, "#fef3c7");
  grad.addColorStop(1, "#fbbf24");
  ctx.fillStyle = grad;
  ctx.beginPath();
  ctx.arc(x, y, size, 0, Math.PI * 2);
  ctx.fill();
  ctx.strokeStyle = "#e2e8f0";
  ctx.lineWidth = 3 * zoom;
  ctx.beginPath();
  ctx.ellipse(x, y, size + 10 * zoom, size / 2, Math.PI / 4, 0, Math.PI * 2);
  ctx.stroke();
}

function drawBlackHole(x, y) {
  const size = 25 * zoom;
  ctx.fillStyle = "#000";
  ctx.beginPath();
  ctx.arc(x, y, size, 0, Math.PI * 2);
  ctx.fill();
  const grad = ctx.createRadialGradient(x, y, size, x, y, size + 15 * zoom);
  grad.addColorStop(0, "rgba(255,255,255,0)");
  grad.addColorStop(1, "rgba(255,165,0,0.8)");
  ctx.fillStyle = grad;
  ctx.beginPath();
  ctx.arc(x, y, size + 15 * zoom, 0, Math.PI * 2);
  ctx.fill();
}

function drawBeast(x, y) {
  const size = 20 * zoom;
  ctx.fillStyle = "#ef4444";
  ctx.beginPath();
  ctx.arc(x, y, size, 0, Math.PI * 2);
  ctx.fill();
  ctx.fillStyle = "#fff";
  ctx.beginPath();
  ctx.arc(x - 8 * zoom, y - 6 * zoom, 4 * zoom, 0, Math.PI * 2);
  ctx.arc(x + 8 * zoom, y - 6 * zoom, 4 * zoom, 0, Math.PI * 2);
  ctx.fill();
  ctx.fillStyle = "#000";
  ctx.beginPath();
  ctx.arc(x - 8 * zoom, y - 6 * zoom, 2 * zoom, 0, Math.PI * 2);
  ctx.arc(x + 8 * zoom, y - 6 * zoom, 2 * zoom, 0, Math.PI * 2);
  ctx.fill();
  ctx.fillStyle = "#fff";
  ctx.beginPath();
  ctx.rect(x - 10 * zoom, y + 8 * zoom, 4 * zoom, 6 * zoom);
  ctx.rect(x + 6 * zoom, y + 8 * zoom, 4 * zoom, 6 * zoom);
  ctx.fill();
}

function drawTree(x, y) {
  const size = 20 * zoom;
  ctx.fillStyle = "#92400e";
  ctx.fillRect(x - size / 2, y + 20 * zoom, size, 36 * zoom);
  ctx.fillStyle = "#22c55e";
  ctx.beginPath();
  ctx.arc(x, y, 36 * zoom, 0, Math.PI * 2);
  ctx.fill();
  ctx.fillStyle = "rgba(255,255,255,0.3)";
  ctx.beginPath();
  ctx.arc(x - 12 * zoom, y - 16 * zoom, 16 * zoom, 0, Math.PI * 2);
  ctx.fill();
}

function drawMountain(x, y) {
  ctx.fillStyle = "#94a3b8";
  ctx.beginPath();
  ctx.moveTo(x, y - 36 * zoom);
  ctx.lineTo(x - 44 * zoom, y + 36 * zoom);
  ctx.lineTo(x + 44 * zoom, y + 36 * zoom);
  ctx.closePath();
  ctx.fill();
}

function drawWater(x, y) {
  ctx.fillStyle = "rgba(59,130,246,0.6)";
  ctx.beginPath();
  ctx.ellipse(x, y + 12 * zoom, 36 * zoom, 20 * zoom, 0, 0, Math.PI * 2);
  ctx.fill();
}

// =========================
// å»ºç¯‰ç¹ªè£½
// =========================
function drawBuilding(b) {
  const p = gridToScreen(b.x, b.y);
  const x = p.x;
  const y = p.y + 20 * zoom;
  if (b.type === "house") drawHouse(x, y);
  if (b.type === "farm") drawFarm(x, y);
  if (b.type === "lumber") drawLumber(x, y);
  if (b.type === "quarry") drawQuarry(x, y);
  if (b.type === "mine") drawMine(x, y);
  if (b.type === "factory") drawFactory(x, y);
  if (b.type === "wall") drawWall(x, y);
  if (b.type === "robot") drawRobotCenter(x, y);

  ctx.fillStyle = "#fff";
  ctx.font = `${28 * zoom}px bold`;
  ctx.textAlign = "center";
  ctx.fillText(`Lv${b.level}`, x, y - 20 * zoom);
  ctx.textAlign = "start";
}

function shadow(x, y, w, h) {
  ctx.fillStyle = "rgba(0,0,0,0.18)";
  ctx.beginPath();
  ctx.ellipse(x, y, w * zoom, h * zoom, 0, 0, Math.PI * 2);
  ctx.fill();
}

function drawHouse(x, y) {
  shadow(x, y + 84 * zoom, 84, 32);
  const bodyGrad = ctx.createLinearGradient(x, y, x, y + 120 * zoom);
  bodyGrad.addColorStop(0, "#fef3c7");
  bodyGrad.addColorStop(1, "#fde68a");
  ctx.fillStyle = bodyGrad;
  ctx.beginPath();
  ctx.roundRect(x - 76 * zoom, y, 152 * zoom, 100 * zoom, 20 * zoom);
  ctx.fill();
  const roofGrad = ctx.createLinearGradient(x, y - 80 * zoom, x, y);
  roofGrad.addColorStop(0, "#fbbf24");
  roofGrad.addColorStop(1, "#f59e0b");
  ctx.fillStyle = roofGrad;
  ctx.beginPath();
  ctx.moveTo(x - 92 * zoom, y);
  ctx.quadraticCurveTo(x, y - 92 * zoom, x + 92 * zoom, y);
  ctx.closePath();
  ctx.fill();
  ctx.fillStyle = "#92400e";
  ctx.beginPath();
  ctx.roundRect(x - 20 * zoom, y + 48 * zoom, 40 * zoom, 52 * zoom, 12 * zoom);
  ctx.fill();
  ctx.fillStyle = "#bfdbfe";
  ctx.beginPath();
  ctx.arc(x - 36 * zoom, y + 36 * zoom, 16 * zoom, 0, Math.PI * 2);
  ctx.arc(x + 36 * zoom, y + 36 * zoom, 16 * zoom, 0, Math.PI * 2);
  ctx.fill();
}

function drawFarm(x, y) {
  shadow(x, y + 84 * zoom, 90, 32);
  ctx.fillStyle = "#fef9c3";
  ctx.beginPath();
  ctx.roundRect(x - 88 * zoom, y + 36 * zoom, 176 * zoom, 76 * zoom, 24 * zoom);
  ctx.fill();
  ctx.fillStyle = "#a16207";
  for (let i = -3; i <= 3; i++) {
    ctx.fillRect(x + i * 24 * zoom, y + 44 * zoom, 8 * zoom, 64 * zoom);
  }
  ctx.fillStyle = "#22c55e";
  ctx.beginPath();
  ctx.arc(x - 56 * zoom, y + 24 * zoom, 24 * zoom, 0, Math.PI * 2);
  ctx.arc(x + 56 * zoom, y + 24 * zoom, 24 * zoom, 0, Math.PI * 2);
  ctx.fill();
}

function drawLumber(x, y) {
  shadow(x, y + 84 * zoom, 90, 32);
  ctx.fillStyle = "#fde68a";
  ctx.beginPath();
  ctx.roundRect(x - 80 * zoom, y + 20 * zoom, 160 * zoom, 92 * zoom, 28 * zoom);
  ctx.fill();
  ctx.fillStyle = "#92400e";
  ctx.fillRect(x - 60 * zoom, y + 60 * zoom, 120 * zoom, 20 * zoom);
  ctx.fillStyle = "#22c55e";
  ctx.beginPath();
  ctx.arc(x + 56 * zoom, y + 20 * zoom, 28 * zoom, 0, Math.PI * 2);
  ctx.fill();
  ctx.fillStyle = "#0f172a";
  ctx.font = `${28 * zoom}px system-ui`;
  ctx.fillText("ğŸª“", x - 20 * zoom, y + 68 * zoom);
}

function drawQuarry(x, y) {
  shadow(x, y + 84 * zoom, 90, 32);
  ctx.fillStyle = "#e2e8f0";
  ctx.beginPath();
  ctx.roundRect(x - 84 * zoom, y + 20 * zoom, 168 * zoom, 92 * zoom, 28 * zoom);
  ctx.fill();
  ctx.fillStyle = "#94a3b8";
  ctx.beginPath();
  ctx.arc(x - 36 * zoom, y + 60 * zoom, 24 * zoom, 0, Math.PI * 2);
  ctx.arc(x + 36 * zoom, y + 56 * zoom, 20 * zoom, 0, Math.PI * 2);
  ctx.fill();
}

function drawMine(x, y) {
  shadow(x, y + 84 * zoom, 90, 32);
  ctx.fillStyle = "#cbd5e1";
  ctx.beginPath();
  ctx.roundRect(x - 84 * zoom, y + 24 * zoom, 168 * zoom, 88 * zoom, 28 * zoom);
  ctx.fill();
  ctx.fillStyle = "#475569";
  ctx.beginPath();
  ctx.arc(x, y + 68 * zoom, 32 * zoom, 0, Math.PI * 2);
  ctx.fill();
  ctx.fillStyle = "#fbbf24";
  ctx.beginPath();
  ctx.arc(x + 36 * zoom, y + 40 * zoom, 12 * zoom, 0, Math.PI * 2);
  ctx.fill();
}

function drawFactory(x, y) {
  shadow(x, y + 84 * zoom, 90, 32);
  ctx.fillStyle = "#dbeafe";
  ctx.beginPath();
  ctx.roundRect(x - 88 * zoom, y + 20 * zoom, 176 * zoom, 92 * zoom, 28 * zoom);
  ctx.fill();
  ctx.fillStyle = "#60a5fa";
  ctx.fillRect(x - 68 * zoom, y + 36 * zoom, 36 * zoom, 76 * zoom);
  ctx.fillRect(x - 20 * zoom, y + 52 * zoom, 36 * zoom, 60 * zoom);
  ctx.fillRect(x + 28 * zoom, y + 40 * zoom, 36 * zoom, 72 * zoom);
  ctx.fillStyle = "#fbbf24";
  ctx.font = `${28 * zoom}px system-ui`;
  ctx.fillText("AD", x + 44 * zoom, y + 40 * zoom);
}

function drawWall(x, y) {
  shadow(x, y + 84 * zoom, 100, 32);
  ctx.fillStyle = "#cbd5e1";
  ctx.beginPath();
  ctx.roundRect(x - 100 * zoom, y + 40 * zoom, 200 * zoom, 60 * zoom, 24 * zoom);
  ctx.fill();
  ctx.fillStyle = "#94a3b8";
  for (let i = -4; i <= 4; i++) {
    ctx.fillRect(x + i * 24 * zoom, y + 40 * zoom, 8 * zoom, 60 * zoom);
  }
}

function drawRobotCenter(x, y) {
  shadow(x, y + 84 * zoom, 90, 32);
  ctx.fillStyle = "#fef3c7";
  ctx.beginPath();
  ctx.roundRect(x - 84 * zoom, y + 20 * zoom, 168 * zoom, 92 * zoom, 28 * zoom);
  ctx.fill();
  ctx.fillStyle = "#0ea5e9";
  ctx.beginPath();
  ctx.arc(x, y + 60 * zoom, 36 * zoom, 0, Math.PI * 2);
  ctx.fill();
  ctx.fillStyle = "white";
  ctx.beginPath();
  ctx.arc(x - 16 * zoom, y + 52 * zoom, 8 * zoom, 0, Math.PI * 2);
  ctx.arc(x + 16 * zoom, y + 52 * zoom, 8 * zoom, 0, Math.PI * 2);
  ctx.fill();
  ctx.fillStyle = "#fbbf24";
  ctx.font = `${28 * zoom}px system-ui`;
  ctx.fillText("ğŸ¤–", x - 20 * zoom, y + 100 * zoom);
}

// =========================
// AIå°å‹•ç‰©ç¹ªè£½
// =========================
function drawAiPet() {
  petCtx.clearRect(0, 0, aiPet.width, aiPet.height);
  const x = 60;
  const y = 60;
  const size = 50;

  petCtx.fillStyle = "#fbbf24";
  petCtx.beginPath();
  petCtx.arc(x, y, size, 0, Math.PI * 2);
  petCtx.fill();

  petCtx.fillStyle = "#ef4444";
  petCtx.beginPath();
  petCtx.moveTo(x - 25, y - 40);
  petCtx.lineTo(x - 10, y - 20);
  petCtx.lineTo(x - 40, y - 15);
  petCtx.closePath();
  petCtx.moveTo(x + 25, y - 40);
  petCtx.lineTo(x + 10, y - 20);
  petCtx.lineTo(x + 40, y - 15);
  petCtx.closePath();
  petCtx.fill();

  petCtx.fillStyle = "#fff";
  petCtx.beginPath();
  petCtx.arc(x - 15, y - 10, 8, 0, Math.PI * 2);
  petCtx.arc(x + 15, y - 10, 8, 0, Math.PI * 2);
  petCtx.fill();

  petCtx.fillStyle = "#000";
  petCtx.beginPath();
  petCtx.arc(x - 15, y - 10, 4, 0, Math.PI * 2);
  petCtx.arc(x + 15, y - 10, 4, 0, Math.PI * 2);
  petCtx.fill();

  petCtx.fillStyle = "#ef4444";
  petCtx.beginPath();
  petCtx.arc(x, y + 10, 6, 0, Math.PI * 2);
  petCtx.fill();

  petCtx.strokeStyle = "#000";
  petCtx.lineWidth = 2;
  petCtx.beginPath();
  petCtx.arc(x, y + 15, 10, 0, Math.PI);
  petCtx.stroke();

  petCtx.fillStyle = "#fbbf24";
  petCtx.beginPath();
  petCtx.arc(x + 45, y - 20, 20, 0, Math.PI * 1.5);
  petCtx.fill();

  if (aenoMultiplier > 1) {
    petCtx.fillStyle = "#0f0";
    petCtx.font = "16px bold";
    petCtx.textAlign = "center";
    petCtx.fillText("Ã—2", x, y + 40);
  }
}

// AIå°å‹•ç‰©äº‹ä»¶
aiPet.addEventListener("click", () => {
  if (adPlaying) {
    stopAd();
    aenoMultiplier = 1;
    petAdHint.textContent = "é»æ“Šæ’­æ”¾å»£å‘Šï¼ŒAENOæ”¶ç›ŠÃ—2ï¼";
    drawAiPet();
    return;
  }
  startAd();
  aenoMultiplier = 2;
  petAdHint.textContent = "å»£å‘Šæ’­æ”¾ä¸­ï¼ŒAENOæ”¶ç›ŠÃ—2ï¼";
  drawAiPet();
});

aiPet.addEventListener("mouseenter", () => {
  petAdHint.style.display = "block";
});
aiPet.addEventListener("mouseleave", () => {
  petAdHint.style.display = "none";
});

aiPet.addEventListener("touchstart", () => {
  petAdHint.style.display = "block";
});
aiPet.addEventListener("touchend", () => {
  setTimeout(() => {
    petAdHint.style.display = "none";
  }, 2000);
});

// =========================
// UI Tabåˆ‡æ›
// =========================
const tabBtns = document.querySelectorAll(".tabBtn");
tabBtns.forEach((btn) => {
  btn.addEventListener("click", () => {
    tabBtns.forEach((b) => b.classList.remove("active"));
    btn.classList.add("active");
    document.querySelectorAll(".tabPage").forEach((p) => p.classList.remove("active"));
    document.getElementById(btn.dataset.tab).classList.add("active");
  });
});

// =========================
// é¢æ¿æ‹–å‹•
// =========================
let dragPanel = false;
let dragOffsetX = 0;
let dragOffsetY = 0;
panelHeader.addEventListener("pointerdown", (e) => {
  dragPanel = true;
  dragOffsetX = e.clientX - panel.offsetLeft;
  dragOffsetY = e.clientY - panel.offsetTop;
  panelHeader.setPointerCapture(e.pointerId);
});
panelHeader.addEventListener("pointermove", (e) => {
  if (!dragPanel) return;
  const nx = e.clientX - dragOffsetX;
  const ny = e.clientY - dragOffsetY;
  panel.style.left = clamp(nx, 5, window.innerWidth - panel.offsetWidth - 5) + "px";
  panel.style.top = clamp(ny, 5, window.innerHeight - panel.offsetHeight - 5) + "px";
  panel.style.right = "auto";
});
panelHeader.addEventListener("pointerup", () => {
  dragPanel = false;
});
panelMinBtn.addEventListener("click", () => {
  panel.style.height = panel.style.height === "120px" ? "560px" : "120px";
});
panelHideBtn.addEventListener("click", () => {
  panel.classList.add("hidden");
  panelRestoreBtn.classList.remove("hidden");
});
panelRestoreBtn.addEventListener("click", () => {
  panel.classList.remove("hidden");
  panelRestoreBtn.classList.add("hidden");
  panel.style.height = "560px";
});

// =========================
// èŠå¤©åŠ©æ‰‹
// =========================
function addChat(who, msg) {
  const div = document.createElement("div");
  div.innerHTML = `<b>${who}ï¼š</b>${msg}`;
  chatLog.appendChild(div);
  chatLog.scrollTop = chatLog.scrollHeight;
}
assistantTalkBtn.addEventListener("click", () => {
  chatBox.classList.toggle("hidden");
  if (!chatBox.classList.contains("hidden")) {
    addChat("AIåŠ©æ‰‹", "æˆ‘æ˜¯ä½ çš„å¤–æ›ç´šåŠ©æ‰‹ï¼è‡ªå‹•å»ºé€ ã€è‡ªå‹•å‡ç´šã€è‡ªå‹•æ“´åœŸï¼Œç„¡éœ€æ‰‹å‹•æ“ä½œï¼");
  }
});
chatClose.addEventListener("click", () => {
  chatBox.classList.add("hidden");
});
chatSend.addEventListener("click", () => {
  const text = chatInput.value.trim();
  if (!text) return;
  chatInput.value = "";
  addChat("ç©å®¶", text);
  handleCommand(text);
});
chatInput.addEventListener("keydown", (e) => {
  if (e.key === "Enter") {
    chatSend.click();
  }
});
function handleCommand(text) {
  const t = text.toLowerCase();
  if (t.includes("åœæ­¢") || t.includes("off")) {
    game.autoMode = false;
    addChat("AIåŠ©æ‰‹", "å·²åœæ­¢è‡ªå‹•æ¨¡å¼ï¼Œæ‰‹å‹•æ“ä½œç”Ÿæ•ˆï¼");
    return;
  }
  if (t.includes("è‡ªå‹•") || t.includes("on")) {
    game.autoMode = true;
    addChat("AIåŠ©æ‰‹", "å·²é–‹å•Ÿå¤–æ›ç´šè‡ªå‹•æ¨¡å¼ï¼šè‡ªå‹•å»ºé€ ã€è‡ªå‹•å‡ç´šã€è‡ªå‹•æ“´åœŸï¼");
    return;
  }
  if (t.includes("å‡ç´š")) {
    upgradeAllBuildings();
    addChat("AIåŠ©æ‰‹", "æ‰‹å‹•å‡ç´šæ‰€æœ‰å»ºç¯‰å®Œæˆï¼");
    return;
  }
  if (t.includes("å»£å‘Š")) {
    addChat("AIåŠ©æ‰‹", "é»æ“Šå³ä¸Šè§’å°ç‹ç‹¸æ’­æ”¾å»£å‘Šï¼ŒAENOæ”¶ç›ŠÃ—2ï¼");
    return;
  }
  addChat("AIåŠ©æ‰‹", "æŒ‡ä»¤ï¼šè‡ªå‹• / åœæ­¢ / å‡ç´š / å»£å‘Š");
}

// =========================
// å»ºç¯‰èˆ‡å‡ç´š
// =========================
document.querySelectorAll(".buildBtn").forEach((btn) => {
  btn.addEventListener("click", () => {
    const type = btn.dataset.build;
    game.buildQueue.push({ type, t: Date.now() });
    log(`å·²æ‰‹å‹•æ’ç¨‹å»ºé€ ï¼š${type}`);
  });
});

function upgradeAllBuildings(){
  const types = ["house","farm","lumber","quarry","mine","factory","wall","robot"];
  types.forEach(type=>{
    if(game.buildings[type]>0){
      game.buildingLevels[type]++;
    }
  });
  rebuildPlacedBuildings();
  log("æ‰‹å‹•å‡ç´šæ‰€æœ‰å»ºç¯‰ +1 å®Œæˆï¼");
}
btnUpgradeAll.addEventListener("click", upgradeAllBuildings);

// è‡ªå‹•å‡ç´š
setInterval(() => {
  if (!game || !game.autoMode) return;
  const types = ["house", "farm", "lumber", "quarry", "mine", "factory", "wall", "robot"];
  const avail = types.filter(t=>game.buildings[t]>0);
  if(avail.length===0) return;
  const pick = avail[Math.floor(Math.random()*avail.length)];
  game.buildingLevels[pick]++;
  rebuildPlacedBuildings();
}, 5000);

// =========================
// ç§‘æŠ€æŒ‰éˆ•
// =========================
document.querySelectorAll(".techBtn").forEach((btn) => {
  btn.addEventListener("click", () => {
    const tech = btn.dataset.tech;
    const cost = 200 + game.tech[tech] * 250;
    if (game.resources.gold < cost) {
      log("é‡‘å¹£ä¸è¶³ï¼Œç„¡æ³•ç ”ç©¶ç§‘æŠ€");
      return;
    }
    game.resources.gold -= cost;
    game.tech[tech] += 1;
    log(`ç§‘æŠ€å‡ç´šæˆåŠŸï¼š${tech} Lv.${game.tech[tech]}`);
  });
});

// =========================
// äº¤æ˜“æ‰€
// =========================
function updateMarketPrices() {
  const now = Date.now();
  if (now - game.market.lastUpdate < 60000) return;
  const seedFn = xmur3(game.seed + now);
  const rand = mulberry32(seedFn());
  ["wood", "stone", "iron", "food"].forEach((k) => {
    const base = game.market[k];
    const delta = (rand() - 0.5) * 2;
    game.market[k] = Math.max(1, Math.round(base + delta));
  });
  game.market.lastUpdate = now;
}
function refreshMarketHint() {
  marketPriceHint.textContent =
  `æœ¨:${game.market.wood} | çŸ³:${game.market.stone} | éµ:${game.market.iron} | é£Ÿ:${game.market.food}`;
}
btnBuy.addEventListener("click", () => {
  const item = marketItem.value;
  const qty = Math.max(1, Math.floor(Number(marketQty.value || 1)));
  const price = game.market[item] * qty;
  if (game.resources.gold < price) {
    log("é‡‘å¹£ä¸è¶³ï¼Œè²·å…¥å¤±æ•—");
    return;
  }
  game.resources.gold -= price;
  game.resources[item] += qty;
  log(`è²·å…¥æˆåŠŸï¼š${item} x${qty}`);
});
btnSell.addEventListener("click", () => {
  const item = marketItem.value;
  const qty = Math.max(1, Math.floor(Number(marketQty.value || 1)));
  if (game.resources[item] < qty) {
    log("è³‡æºä¸è¶³ï¼Œè³£å‡ºå¤±æ•—");
    return;
  }
  const price = game.market[item] * qty;
  game.resources[item] -= qty;
  game.resources.gold += price;
  log(`è³£å‡ºæˆåŠŸï¼š${item} x${qty}`);
});

// =========================
// å»£å‘ŠéŸ³æ¨‚
// =========================
function startAd() {
  if (adPlaying) return;
  adPlaying = true;
  adAudio.src = "https://cdn.pixabay.com/download/audio/2022/03/15/audio_7f7b2fbe11.mp3?filename=future-bass-beat-117858.mp3";
  adAudio.volume = 0.55;
  adAudio.play().catch((err) => {
    log("éŸ³é »æ’­æ”¾å¤±æ•—ï¼Œè«‹æ‰‹å‹•å…è¨±é é¢éŸ³é »æ¬Šé™");
    console.error(err);
  });
  log("ğŸµ é–‹å§‹æ’­æ”¾å»£å‘Šï¼ŒAENOæ”¶ç›ŠÃ—2ï¼");
  if (adTimer) clearInterval(adTimer);
  adTimer = setInterval(() => {
    game.ad.listeningSeconds += 1;
  }, 1000);
}
function stopAd() {
  adPlaying = false;
  adAudio.pause();
  if (adTimer) clearInterval(adTimer);
  adTimer = null;
  aenoMultiplier = 1;
  log("ğŸµ å·²åœæ­¢å»£å‘Šï¼ŒAENOæ”¶ç›Šæ¢å¾©æ­£å¸¸ï¼");
}
btnPlayAd.addEventListener("click", startAd);
btnStopAd.addEventListener("click", stopAd);

// =========================
// è¦–è§’èˆ‡æ“´å¼µ
// =========================
btnZoomReset.addEventListener("click", () => {
  zoom = 0.5;
  cameraX = 0;
  cameraY = 0;
});
btnExpand.addEventListener("click", () => {
  const cost = Math.floor(250 + game.stats.territory * 18);
  if (game.resources.gold < cost) {
    log("é‡‘å¹£ä¸è¶³ï¼Œç„¡æ³•æ“´åœŸ");
    return;
  }
  game.resources.gold -= cost;
  game.stats.territory += 2;
  game.stats.civil += 1;
  log(`ğŸï¸ æ‰‹å‹•æ“´å¤§é ˜åœŸ +2ï¼ŒèŠ±è²» ${cost} é‡‘`);
});
btnAutoOn.addEventListener("click", () => {
  game.autoMode = true;
  log("è‡ªå‹•æ¨¡å¼ ONï¼ˆå¤–æ›ç´šï¼‰");
});
btnAutoOff.addEventListener("click", () => {
  game.autoMode = false;
  log("è‡ªå‹•æ¨¡å¼ OFF");
});

// =========================
// è§¸æ§ç¸®æ”¾èˆ‡æ‹–å‹•
// =========================
let touchMode = false;
let lastDist = 0;
canvas.addEventListener("touchstart", (e) => {
  if (e.touches.length === 2) {
    touchMode = true;
    lastDist = Math.hypot(
      e.touches[0].clientX - e.touches[1].clientX,
      e.touches[0].clientY - e.touches[1].clientY
    );
  }
}, { passive: false });

canvas.addEventListener("touchmove", (e) => {
  if (!touchMode) return;
  if (e.touches.length !== 2) return;
  e.preventDefault();
  const dist = Math.hypot(
    e.touches[0].clientX - e.touches[1].clientX,
    e.touches[0].clientY - e.touches[1].clientY
  );
  const diff = dist - lastDist;
  lastDist = dist;
  zoom += diff * 0.002;
  zoom = clamp(zoom, ZOOM_MIN, ZOOM_MAX);
}, { passive: false });

canvas.addEventListener("touchend", () => {
  touchMode = false;
});

let draggingMap = false;
let lastPX = 0;
let lastPY = 0;
canvas.addEventListener("pointerdown", (e) => {
  draggingMap = true;
  lastPX = e.clientX;
  lastPY = e.clientY;
  canvas.setPointerCapture(e.pointerId);

  // é»æ“Šæ“Šæ®ºæ€ªç¸
  const grid = screenToGrid(e.clientX, e.clientY);
  const gx = Math.floor(grid.x);
  const gy = Math.floor(grid.y);
  if (gx >= 0 && gx < MAP_W && gy >= 0 && gy < MAP_H) {
    if (map[gy][gx] === TILE_TYPES.beast) {
      killBeast(gx, gy);
    }
  }
});

canvas.addEventListener("pointermove", (e) => {
  if (!draggingMap) return;
  const dx = e.clientX - lastPX;
  const dy = e.clientY - lastPY;
  lastPX = e.clientX;
  lastPY = e.clientY;
  cameraX += dx;
  cameraY += dy;
});

canvas.addEventListener("pointerup", () => {
  draggingMap = false;
});

// =========================
// AENO æ ¸å¿ƒç®—æ³•
// =========================
function secretAenoCore() {
  const now = Date.now();
  const mix = game.seed + "|" + game.ad.listeningSeconds + "|" + game.stats.population + "|" + game.stats.civil + "|" + now;
  const seedFn = xmur3(mix);
  const rand = mulberry32(seedFn());
  const maintenance = (game.stats.population * 0.0005) + (Object.values(game.buildings).reduce((a,b)=>a+b,0) * 0.0006);
  const learning = (game.tech.tools + game.tech.agri + game.tech.mining + game.tech.robotics + game.tech.economy) * 0.0008;
  const adFactor = Math.min(1.0, game.ad.listeningSeconds / 120) * (0.0018 + learning) * aenoMultiplier;
  const beastFactor = (game.world.beastsKilled * 0.0006);
  const salt = (rand() * 0.00008);
  let aenoDelta = adFactor + beastFactor + salt - maintenance;
  if (aenoDelta < 0) aenoDelta = 0;
  return aenoDelta;
}

// =========================
// æ¯ç§’éŠæˆ²é‚è¼¯
// =========================
function tickLogic(dtSec = 1, silent = false) {
  updateMarketPrices();
  const farmBoost = 1 + game.tech.agri * 0.08;
  game.resources.food += game.buildings.farm * 0.12 * farmBoost * dtSec * game.buildingLevels.farm;
  const forestBoost = 1.0;
  const lumberBoost = 1 + game.tech.tools * 0.06;
  game.resources.wood += game.buildings.lumber * 0.14 * forestBoost * lumberBoost * dtSec * game.buildingLevels.lumber;
  const quarryBoost = 1 + game.tech.mining * 0.07;
  game.resources.stone += game.buildings.quarry * 0.10 * quarryBoost * dtSec * game.buildingLevels.quarry;
  game.resources.iron += game.buildings.mine * 0.06 * quarryBoost * dtSec * game.buildingLevels.mine;
  const ecoBoost = 1 + game.tech.economy * 0.08;
  game.resources.gold += (game.stats.population * 0.04 + game.buildings.factory * 0.18) * ecoBoost * dtSec * game.buildingLevels.factory;
  const aenoDelta = secretAenoCore() * dtSec;
  game.resources.aeno += aenoDelta;
  const civilUp = (game.buildings.house * 0.0008 + game.buildings.factory * 0.0012) * dtSec;
  game.stats.civil = clamp(game.stats.civil + civilUp, 0, 100);
  if (game.resources.food > game.stats.population * 4) {
    if (Math.random() < 0.002 * dtSec) {
      game.stats.population += 1;
      if (!silent) log("äººå£å¢åŠ  +1");
    }
  }
  if (game.autoMode) {
    autoAssistantBuild(dtSec, silent);
  }
  if (game.world.lootPending > 0) {
    const take = Math.min(game.world.lootPending, 4);
    game.world.lootPending -= take;
    game.resources.gold += take * 0.6;
  }
  Object.keys(game.resources).forEach((k) => {
    if (game.resources[k] < 0) game.resources[k] = 0;
  });
}

function autoAssistantBuild(dtSec, silent) {
  if (game.buildings.farm < 1) {
    tryBuild("farm", silent);
    return;
  }
  if (game.buildings.lumber < 1) {
    tryBuild("lumber", silent);
    return;
  }
  if (game.buildings.house < Math.ceil(game.stats.population / 2)) {
    tryBuild("house", silent);
    return;
  }
  if (game.buildings.quarry < 1 && game.stats.territory >= 9) {
    tryBuild("quarry", silent);
    return;
  }
  if (game.buildings.mine < 1 && game.buildings.quarry >= 1) {
    tryBuild("mine", silent);
    return;
  }
  if (game.buildings.factory < 1 && game.buildings.mine >= 1) {
    tryBuild("factory", silent);
    return;
  }
  if (game.buildings.wall < 1 && game.stats.civil > 60) {
    tryBuild("wall", silent);
    return;
  }
  if (game.buildings.robot < 1 && game.tech.robotics >= 1) {
    tryBuild("robot", silent);
    return;
  }
  if (game.resources.gold > 1000 && Math.random() < 0.002 * dtSec) {
    game.resources.gold -= 250;
    game.stats.territory += 1;
    if (!silent) log("ğŸï¸ åŠ©æ‰‹è‡ªå‹•æ“´å¤§é ˜åœŸ +1");
  }
  if (game.buildQueue.length > 0) {
    const job = game.buildQueue.shift();
    tryBuild(job.type, silent);
  }
}

function tryBuild(type, silent) {
  const cost = getBuildCost(type);
  if (
    game.resources.gold < cost.gold ||
    game.resources.wood < cost.wood ||
    game.resources.stone < cost.stone ||
    game.resources.iron < cost.iron ||
    game.resources.food < cost.food
  ) {
    if (!silent) log(`è³‡æºä¸è¶³ï¼šç„¡æ³•å»ºé€  ${type}`);
    return false;
  }
  game.resources.gold -= cost.gold;
  game.resources.wood -= cost.wood;
  game.resources.stone -= cost.stone;
  game.resources.iron -= cost.iron;
  game.resources.food -= cost.food;
  game.buildings[type] += 1;
  game.stats.civil += 0.8;
  rebuildPlacedBuildings();
  if (!silent) log(`ğŸ—ï¸ å»ºé€ æˆåŠŸï¼š${type} +1`);
  return true;
}

function getBuildCost(type) {
  const base = {
    house: { gold: 120, wood: 35, stone: 10, iron: 0, food: 10 },
    farm: { gold: 100, wood: 20, stone: 0, iron: 0, food: 0 },
    lumber: { gold: 120, wood: 10, stone: 10, iron: 0, food: 0 },
    quarry: { gold: 180, wood: 10, stone: 20, iron: 0, food: 0 },
    mine: { gold: 240, wood: 20, stone: 30, iron: 0, food: 0 },
    factory: { gold: 350, wood: 40, stone: 50, iron: 10, food: 0 },
    wall: { gold: 300, wood: 10, stone: 80, iron: 10, food: 0 },
    robot: { gold: 600, wood: 50, stone: 80, iron: 40, food: 0 }
  };
  const lv = game.buildings[type] || 0;
  const scale = 1 + lv * 0.18;
  return {
    gold: Math.floor(base[type].gold * scale),
    wood: Math.floor(base[type].wood * scale),
    stone: Math.floor(base[type].stone * scale),
    iron: Math.floor(base[type].iron * scale),
    food: Math.floor(base[type].food * scale)
  };
}

// =========================
// UI æ›´æ–°
// =========================
function updateUI() {
  statGold.textContent = Math.floor(game.resources.gold);
  statAeno.textContent = game.resources.aeno.toFixed(6);
  statWood.textContent = Math.floor(game.resources.wood);
  statStone.textContent = Math.floor(game.resources.stone);
  statIron.textContent = Math.floor(game.resources.iron);
  statFood.textContent = Math.floor(game.resources.food);
  statPop.textContent = game.stats.population;
  statTerritory.textContent = game.stats.territory;
  statCivil.textContent = Math.floor(game.stats.civil) + "%";
  if (game.stats.civil >= 100) {
    statBeast.textContent = `âš”ï¸ é€²è¡Œä¸­ï¼ˆæ“Šæ®º:${game.world.beastsKilled}ï¼‰`;
  } else {
    statBeast.textContent = `æœªå•Ÿå‹•ï¼ˆéœ€100%æ–‡æ˜ï¼‰`;
  }
  refreshMarketHint();
}

// =========================
// éŠæˆ²ç¹ªè£½ä¸»å¾ªç’°
// =========================
function draw() {
  ctx.setTransform(1, 0, 0, 1, 0, 0);
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.fillStyle = "#eaf6ff";
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  
  ctx.save();
  ctx.translate(cameraX, cameraY);

  for (let y = 0; y < MAP_H; y++) {
    for (let x = 0; x < MAP_W; x++) {
      drawTile(x, y, map[y][x]);
    }
  }
  placedBuildings.forEach(drawBuilding);

  const p = gridToScreen(townCenter.x, townCenter.y);
  ctx.fillStyle = "rgba(0,0,0,0.5)";
  ctx.font = `${16 * zoom}px system-ui`;
  ctx.fillText("ğŸ›ï¸ ä¸­å¤®åŸé®", p.x - 40 * zoom, p.y - 20 * zoom);

  ctx.restore();
  requestAnimationFrame(draw);
}

// =========================
// 3D AENO Logo
// =========================
function initThreeLogo() {
  threeScene = new THREE.Scene();
  threeCamera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
  threeRenderer = new THREE.WebGL
Renderer();
  threeRenderer.setSize(window.innerWidth, window.innerHeight);
  document.getElementById('threejs-container').appendChild(threeRenderer.domElement);
}

// éŠæˆ²åˆå§‹åŒ–
function initGame() {
  game = {
    resources: {
      gold: 500,
      aeno: 0,
      wood: 300,
      stone: 200,
      iron: 100,
      food: 200
    },
    buildings: {},
    stats: {
      population: 10,
      territory: 1,
      civil: 0
    },
    world: {
      beastsKilled: 0
    }
  };
  updateUI();
  draw();
  initThreeLogo();
}

// é é¢åŠ è¼‰å®Œæˆåˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
  // ç™»å…¥æŒ‰éˆ•äº‹ä»¶
  document.getElementById('loginBtn').addEventListener('click', function() {
    const username = document.getElementById('userNameInput').value.trim();
    if (!username) {
      alert('è«‹è¼¸å…¥ç”¨æˆ¶å');
      return;
    }
    USER_DATA = { id: Date.now().toString(), name: username };
    localStorage.setItem(STORAGE_USER_KEY, JSON.stringify(USER_DATA));
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('bootScreen').classList.remove('hidden');
    setTimeout(() => {
      document.getElementById('bootScreen').classList.add('hidden');
      initGame();
    }, 2000);
  });

  // éŠå®¢ç™»å…¥æŒ‰éˆ•äº‹ä»¶
  document.getElementById('guestBtn').addEventListener('click', function() {
    USER_DATA = { id: Date.now().toString(), name: 'éŠå®¢' };
    localStorage.setItem(STORAGE_USER_KEY, JSON.stringify(USER_DATA));
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('bootScreen').classList.remove('hidden');
    setTimeout(() => {
      document.getElementById('bootScreen').classList.add('hidden');
      initGame();
    }, 2000);
  });

  // è®€å–ç”¨æˆ¶æ•¸æ“š
  const savedUser = localStorage.getItem(STORAGE_USER_KEY);
  if (savedUser) {
    USER_DATA = JSON.parse(savedUser);
  }
});

})();
</script>
</body>
</html>
