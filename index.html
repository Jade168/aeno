<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
<title>AENO V3 - Cartoon Empire (Vertical)</title>
<style>
  :root{
    --bg:#eaf7ff;
    --panel:#ffffffee;
    --panel2:#f8fbff;
    --border:#cfe8ff;
    --text:#0f172a;
    --muted:#64748b;
    --accent:#3b82f6;
    --accent2:#22c55e;
    --danger:#ef4444;
    --gold:#f59e0b;
    --aeno:#8b5cf6;
  }
  *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans HK","PingFang HK","Microsoft JhengHei",sans-serif;}
  body{
    margin:0;
    background:linear-gradient(#eaf7ff,#f8fbff);
    overflow:hidden;
    touch-action:none;
  }
  #wrap{
    width:100vw;height:100vh;
    display:flex;justify-content:center;align-items:center;
  }
  #game{
    position:relative;
    width:min(460px,100vw);
    height:100vh;
    max-height:980px;
    background:linear-gradient(#eaf7ff,#f7fbff);
    border-left:1px solid #dbeafe;
    border-right:1px solid #dbeafe;
    overflow:hidden;
  }

  canvas{
    width:100%;
    height:100%;
    display:block;
    background:linear-gradient(#eaf7ff,#f7fbff);
  }

  /* TOP BAR */
  #topbar{
    position:absolute;top:0;left:0;right:0;
    padding:10px 10px 8px 10px;
    display:flex;gap:8px;align-items:center;
    z-index:50;
    background:linear-gradient(#ffffffdd,#ffffff00);
    backdrop-filter: blur(6px);
  }
  .chip{
    padding:8px 10px;
    border-radius:14px;
    background:#ffffffdd;
    border:1px solid var(--border);
    font-size:12px;
    color:var(--text);
    box-shadow:0 6px 14px rgba(0,0,0,0.06);
    display:flex;align-items:center;gap:6px;
    user-select:none;
    cursor:pointer;
  }
  .chip b{font-size:12px;}
  .chip .dot{
    width:8px;height:8px;border-radius:999px;background:var(--accent);
  }

  /* MAIN PANEL */
  #panel{
    position:absolute;
    left:10px; right:10px;
    bottom:10px;
    height:52%;
    border-radius:22px;
    background:var(--panel);
    border:1px solid var(--border);
    box-shadow:0 18px 50px rgba(0,0,0,0.12);
    z-index:80;
    overflow:hidden;
    transition: transform .25s ease;
  }
  #panel.min{
    transform: translateY(calc(100% - 64px));
  }

  #panelHeader{
    height:64px;
    padding:10px 12px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    background:linear-gradient(#ffffff,#f1f8ff);
    border-bottom:1px solid #dbeafe;
  }
  #panelTitle{
    display:flex;flex-direction:column;
    gap:2px;
  }
  #panelTitle .t{
    font-weight:900;
    font-size:14px;
    color:var(--text);
    letter-spacing:0.3px;
  }
  #panelTitle .s{
    font-size:11px;color:var(--muted);
  }

  #panelTabs{
    display:flex;gap:6px;flex-wrap:wrap;
    justify-content:flex-end;
  }
  .tab{
    font-size:11px;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid #dbeafe;
    background:#fff;
    color:#0f172a;
    cursor:pointer;
    user-select:none;
  }
  .tab.active{
    background:var(--accent);
    border-color:var(--accent);
    color:white;
    font-weight:700;
  }

  #panelBody{
    height:calc(100% - 64px);
    overflow:auto;
    padding:10px;
    background:linear-gradient(#ffffff,#f8fbff);
  }

  .card{
    background:#ffffff;
    border:1px solid #e2f0ff;
    border-radius:18px;
    padding:12px;
    box-shadow:0 10px 24px rgba(0,0,0,0.06);
    margin-bottom:10px;
  }
  .row{display:flex;gap:8px;flex-wrap:wrap;}
  .btn{
    border:none;
    padding:10px 12px;
    border-radius:14px;
    background:var(--accent);
    color:white;
    font-weight:800;
    cursor:pointer;
    user-select:none;
    box-shadow:0 10px 20px rgba(59,130,246,0.25);
    font-size:12px;
  }
  .btn.gray{
    background:#e2e8f0;color:#0f172a;
    box-shadow:none;
    border:1px solid #cbd5e1;
  }
  .btn.green{
    background:var(--accent2);
    box-shadow:0 10px 20px rgba(34,197,94,0.25);
  }
  .btn.gold{
    background:var(--gold);
    box-shadow:0 10px 20px rgba(245,158,11,0.25);
  }
  .btn.purple{
    background:var(--aeno);
    box-shadow:0 10px 20px rgba(139,92,246,0.25);
  }
  .btn.red{
    background:var(--danger);
    box-shadow:0 10px 20px rgba(239,68,68,0.25);
  }
  .label{
    font-size:12px;color:var(--muted);
    margin-bottom:6px;
  }
  .big{
    font-size:14px;font-weight:900;color:var(--text);
  }
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace;}
  input,select{
    width:100%;
    padding:10px;
    border-radius:14px;
    border:1px solid #dbeafe;
    background:#f8fbff;
    font-size:13px;
  }

  /* AI CHAT FLOAT */
  #chatFloat{
    position:absolute;
    right:12px;
    top:86px;
    width:220px;
    border-radius:18px;
    border:1px solid #dbeafe;
    background:#ffffffdd;
    backdrop-filter: blur(6px);
    box-shadow:0 12px 26px rgba(0,0,0,0.12);
    z-index:70;
    overflow:hidden;
    transition: transform .25s ease;
  }
  #chatFloat.min{
    transform: translateX(170px);
  }
  #chatHeader{
    padding:8px 10px;
    background:linear-gradient(#ffffff,#f1f8ff);
    border-bottom:1px solid #dbeafe;
    display:flex;align-items:center;justify-content:space-between;
    font-weight:900;font-size:12px;color:var(--text);
  }
  #chatBody{
    height:150px;
    overflow:auto;
    padding:8px;
    font-size:12px;
    color:#0f172a;
  }
  .msg{margin-bottom:8px;line-height:1.35;}
  .msg .who{font-weight:900;}
  .msg.ai .who{color:#2563eb;}
  .msg.me .who{color:#16a34a;}
  #chatInputWrap{
    display:flex;gap:6px;padding:8px;border-top:1px solid #dbeafe;
    background:#ffffff;
  }
  #chatInputWrap input{
    flex:1;
    padding:9px;
    border-radius:12px;
    font-size:12px;
  }
  #chatInputWrap button{
    padding:9px 10px;border-radius:12px;border:none;
    background:#2563eb;color:white;font-weight:900;font-size:12px;
  }

  /* SMALL INFO */
  #toast{
    position:absolute;
    left:50%;
    transform:translateX(-50%);
    top:62px;
    background:#0f172acc;
    color:white;
    font-size:12px;
    padding:8px 12px;
    border-radius:999px;
    z-index:200;
    display:none;
  }
  /* NEW: Fingerprint Unlock Button (Addition) */
  #fp_unlock {
    position: absolute; right: 20px; bottom: 85px; width: 50px; height: 50px;
    background: #ffffffaa; backdrop-filter: blur(5px); border: 2px solid var(--accent);
    border-radius: 50%; display: none; align-items: center; justify-content: center;
    font-size: 24px; z-index: 100; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
  }
</style>
</head>
<body>
<div id="wrap">
  <div id="game">
    <div id="topbar">
      <div class="chip" id="btnTogglePanel"><span class="dot"></span><b>å¸åœ‹é¢æ¿</b></div>
      <div class="chip" id="btnSave"><b>å­˜æª”</b></div>
      <div class="chip" id="btnReset"><b>é‡ç½®</b></div>
    </div>

    <div id="toast"></div>
    <div id="fp_unlock">â˜ï¸</div>

    <canvas id="cv"></canvas>

    <div id="chatFloat">
      <div id="chatHeader">
        <span>ğŸ¾ AIåŠ©æ‰‹ - Aenko</span>
        <span style="cursor:pointer;" id="btnChatMin">â–¸</span>
      </div>
      <div id="chatBody"></div>
      <div id="chatInputWrap">
        <input id="chatInput" placeholder="è¼¸å…¥ï¼šå·¡é‚ / æ”¶é›† / å»ºé€  è¾²ç”° / å‡ç´š å·¥å» ..." />
        <button id="chatSend">é€å‡º</button>
      </div>
    </div>

    <div id="panel" class="min">
      <div id="panelHeader">
        <div id="panelTitle">
          <div class="t">AENO å¸åœ‹æ§åˆ¶ä¸­å¿ƒ</div>
          <div class="s">è³‡æºãƒ»å»ºè¨­ãƒ»äº¤æ˜“æ‰€ãƒ»ç§‘æŠ€æ¨¹ãƒ»ç¸æ½®ãƒ»å»£å‘Šæ­Œãƒ»æ©Ÿå™¨äººäº‹ä»¶</div>
        </div>
        <div id="panelTabs">
          <div class="tab active" data-tab="home">ç¸½è¦½</div>
          <div class="tab" data-tab="build">å»ºè¨­</div>
          <div class="tab" data-tab="market">äº¤æ˜“æ‰€</div>
          <div class="tab" data-tab="stock">è‚¡å¸‚</div>
          <div class="tab" data-tab="tech">ç§‘æŠ€æ¨¹</div>
          <div class="tab" data-tab="event">äº‹ä»¶</div>
          <div class="tab" data-tab="ads">å»£å‘Š/æ­Œæ›²</div>
        </div>
      </div>
      <div id="panelBody"></div>
    </div>
  </div>
</div>

<script>
/* ===========================
   AENO V3 (Single File Demo)
   =========================== */

/* ---------- Helpers ---------- */
function clamp(v,a,b){return Math.max(a,Math.min(b,v));}
function rand(a,b){return a+Math.random()*(b-a);}
function irand(a,b){return Math.floor(rand(a,b+1));}

function now(){return Date.now();}
function fmt(n){
  if(n>=1e9) return (n/1e9).toFixed(2)+"B";
  if(n>=1e6) return (n/1e6).toFixed(2)+"M";
  if(n>=1e3) return (n/1e3).toFixed(2)+"K";
  return Math.floor(n).toString();
}

/* --- safe rounded rect --- */
function roundRectPath(ctx,x,y,w,h,r){
  r=Math.min(r,w/2,h/2);
  ctx.beginPath();
  ctx.moveTo(x+r,y);
  ctx.lineTo(x+w-r,y);
  ctx.quadraticCurveTo(x+w,y,x+w,y+r);
  ctx.lineTo(x+w,y+h-r);
  ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);
  ctx.lineTo(x+r,y+h);
  ctx.quadraticCurveTo(x,y+h,x,y+h-r);
  ctx.lineTo(x,y+r);
  ctx.quadraticCurveTo(x,y,x+r,y);
  ctx.closePath();
}

/* ---------- Canvas Setup ---------- */
const cv=document.getElementById("cv");
const ctx=cv.getContext("2d");

function resize(){
  const rect=cv.getBoundingClientRect();
  cv.width=Math.floor(rect.width*devicePixelRatio);
  cv.height=Math.floor(rect.height*devicePixelRatio);
  ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
}
window.addEventListener("resize",resize);

/* ---------- World Config ---------- */
const TILE=64;
const GRID_W=22;
const GRID_H=22;

const terrainTypes=["grass","forest","mountain","river","ore","plain"];
const buildingTypes=["none","farm","mine","factory","wall","tower","town"];

const terrainColor={
  grass:"#b9fbc0",
  forest:"#4ade80",
  mountain:"#94a3b8",
  river:"#60a5fa",
  ore:"#fbbf24",
  plain:"#dcfce7"
};

const buildingMeta={
  none:{name:"ç©ºåœ°"},
  farm:{name:"è¾²ç”°",cost:{wood:30,stone:10,gold:60},prod:{food:4}},
  mine:{name:"ç¤¦å ´",cost:{wood:25,stone:35,gold:90},prod:{stone:2,iron:2}},
  factory:{name:"å·¥å» ",cost:{wood:60,stone:60,iron:40,gold:200},prod:{gold:5}},
  wall:{name:"åŸç‰†",cost:{stone:80,gold:120},def:2},
  tower:{name:"å®ˆè¡›å¡”",cost:{wood:40,stone:80,iron:30,gold:160},def:5},
  town:{name:"åŸé®",cost:{wood:120,stone:120,iron:80,gold:600},prod:{gold:12},def:3}
};

/* ---------- Save / Load ---------- */
const SAVE_KEY="AENO_V3_SAVE_1";

function defaultState(){
  const map=[];
  for(let y=0;y<GRID_H;y++){
    const row=[];
    for(let x=0;x<GRID_W;x++){
      const t=genTerrain(x,y);
      row.push({
        terrain:t,
        building:"none",
        level:0
      });
    }
    map.push(row);
  }

  // start base
  map[11][11].building="town";
  map[11][11].level=1;

  return {
    ver:3,
    lastTick:now(),
    camera:{x:0,y:0,zoom:1},
    selected:{x:11,y:11},
    resources:{
      gold:500,
      aeno:50,
      wood:120,
      stone:80,
      iron:40,
      food:120
    },
    territoryRadius:4,
    map,
    ai:{
      name:"Aenko",
      x:11,y:11,
      px:0,py:0,
      mood:"ğŸ™‚",
      mode:"idle",
      adText:"AENO MUSIC",
      lastSpeak:0
    },
    robot:{
      active:false,
      x:0,y:0,
      stealTimer:0,
      adText:"AD"
    },
    beast:{
      timer: 90,
      wave:0,
      active:false
    },
    market:{
      prices:{
        wood:2,
        stone:3,
        iron:6,
        food:1
      }
    },
    stock:{
      planetIndex:0,
      lines:[]
    },
    tech:{
      points:0,
      unlocked:{
        farm:true,
        mine:true,
        factory:false,
        wall:false,
        tower:false
      }
    },
    ads:{
      cooldown:0,
      playing:false,
      lastReward:0
    },
    log:[],
    dev:{
      quantumKey: "Q-" + Math.random().toString(16).substr(2, 8).toUpperCase(),
      crystalCount: 0
    }
  };
}

function saveGame(){
  localStorage.setItem(SAVE_KEY, JSON.stringify(state));
  toast("âœ… å·²å­˜æª”");
}

function loadGame(){
  try{
    const raw=localStorage.getItem(SAVE_KEY);
    if(!raw) return null;
    const obj=JSON.parse(raw);
    if(!obj || !obj.map) return null;
    return obj;
  }catch(e){
    return null;
  }
}

function resetGame(){
  localStorage.removeItem(SAVE_KEY);
  state=defaultState();
  toast("âš ï¸ å·²é‡ç½®ä¸–ç•Œ");
  pushLog("ä¸–ç•Œé‡ç½®ã€‚");
}

/* ---------- Terrain Generation ---------- */
function genTerrain(x,y){
  // handmade terrain zones
  const dx=x-11, dy=y-11;
  const d=Math.sqrt(dx*dx+dy*dy);

  // river line
  if(Math.abs((x*0.8 + y*0.3) - 14) < 1.2) return "river";

  // mountains outer ring
  if(d>9 && Math.random()<0.55) return "mountain";

  // forest belt
  if(d>5 && d<9 && Math.random()<0.45) return "forest";

  // ore pockets
  if(Math.random()<0.08) return "ore";

  // plains
  if(Math.random()<0.25) return "plain";

  return "grass";
}

/* ---------- Global State ---------- */
let state = loadGame() || defaultState();

/* ---------- UI ---------- */
const panel=document.getElementById("panel");
const panelBody=document.getElementById("panelBody");
const btnTogglePanel=document.getElementById("btnTogglePanel");
const btnSave=document.getElementById("btnSave");
const btnReset=document.getElementById("btnReset");

const chatFloat=document.getElementById("chatFloat");
const chatBody=document.getElementById("chatBody");
const chatInput=document.getElementById("chatInput");
const chatSend=document.getElementById("chatSend");
const btnChatMin=document.getElementById("btnChatMin");

const toastBox=document.getElementById("toast");
const fpUnlock=document.getElementById("fp_unlock");

function toast(t){
  toastBox.innerText=t;
  toastBox.style.display="block";
  clearTimeout(toastBox._t);
  toastBox._t=setTimeout(()=>toastBox.style.display="none",1200);
}

btnTogglePanel.onclick=()=>{
  if(panel.style.display === "none"){
    panel.style.display = "block";
    fpUnlock.style.display = "none";
  } else {
    panel.classList.toggle("min");
    if(panel.classList.contains("min")){
        // Addition: Logic to hide completely for fingerprint recall if needed
    }
  }
};
// Addition: Long press or special close to show fingerprint recall
btnTogglePanel.oncontextmenu = (e) => {
    e.preventDefault();
    panel.style.display = "none";
    fpUnlock.style.display = "flex";
    toast("é¢æ¿å·²é–å®š");
};
fpUnlock.onclick = () => {
    panel.style.display = "block";
    fpUnlock.style.display = "none";
    toast("ğŸ” æŒ‡ç´‹èªè­‰æˆåŠŸ");
};

btnSave.onclick=saveGame;
btnReset.onclick=()=>{
  if(confirm("ç¢ºå®šé‡ç½®ï¼Ÿæ‰€æœ‰é›¢ç·šå­˜æª”æœƒæ¶ˆå¤±ã€‚")){
    resetGame();
    saveGame();
  }
};

btnChatMin.onclick=()=>{
  chatFloat.classList.toggle("min");
  btnChatMin.innerText=chatFloat.classList.contains("min")?"â—‚":"â–¸";
};

/* ---------- Logging ---------- */
function pushLog(msg){
  state.log.unshift({t:Date.now(),msg});
  state.log=state.log.slice(0,50);
}

/* ---------- Territory ---------- */
function isInsideTerritory(x,y){
  const cx=11, cy=11;
  const dx=x-cx, dy=y-cy;
  return (dx*dx+dy*dy) <= (state.territoryRadius*state.territoryRadius);
}

/* ---------- Economy ---------- */
function canAfford(cost){
  if(!cost) return true;
  for(const k in cost){
    if((state.resources[k]||0) < cost[k]) return false;
  }
  return true;
}
function pay(cost){
  for(const k in cost){
    state.resources[k]-=cost[k];
    if(state.resources[k]<0) state.resources[k]=0;
  }
}

function tryPayWithGoldOrAeno(extraGold){
  // allow player to use gold first, then optional aeno
  const need=extraGold;
  if(state.resources.gold>=need){
    state.resources.gold-=need;
    return true;
  }
  const missing=need-state.resources.gold;
  // conversion: 1 AENO = 100 gold (demo)
  const aenoNeed=Math.ceil(missing/100);
  if(state.resources.aeno>=aenoNeed){
    state.resources.gold=0;
    state.resources.aeno-=aenoNeed;
    return true;
  }
  return false;
}

/* ---------- Build / Upgrade ---------- */
function placeBuilding(type){
  const {x,y}=state.selected;
  if(!isInsideTerritory(x,y)){
    toast("âš ï¸ ä¸åœ¨é ˜åœŸå…§");
    return;
  }
  const tile=state.map[y][x];
  if(tile.building!=="none"){
    toast("âš ï¸ å·²æœ‰å»ºç¯‰");
    return;
  }
  if(type==="factory" && !state.tech.unlocked.factory){
    toast("ğŸ”’ æœªè§£é–å·¥å» ");
    return;
  }
  if(type==="wall" && !state.tech.unlocked.wall){
    toast("ğŸ”’ æœªè§£é–åŸç‰†");
    return;
  }
  if(type==="tower" && !state.tech.unlocked.tower){
    toast("ğŸ”’ æœªè§£é–å®ˆè¡›å¡”");
    return;
  }

  const meta=buildingMeta[type];
  if(!meta){toast("éŒ¯èª¤");return;}

  if(!canAfford(meta.cost)){
    toast("è³‡æºä¸è¶³ï¼Œå¯ç”¨äº¤æ˜“æ‰€è²·");
    return;
  }
  pay(meta.cost);
  tile.building=type;
  tile.level=1;

  pushLog(`å»ºè¨­ï¼š${meta.name} Lv1`);
  toast("ğŸ— å·²å»ºè¨­");
}

function upgradeBuilding(){
  const {x,y}=state.selected;
  const tile=state.map[y][x];
  if(tile.building==="none"){toast("âš ï¸ å†‡å»ºç¯‰");return;}
  const lv=tile.level||1;
  if(lv>=5){toast("å·²æ»¿ç´š");return;}

  const meta=buildingMeta[tile.building];
  const base=meta.cost||{};
  const upCost={};
  for(const k in base){
    upCost[k]=Math.ceil(base[k]*(0.65+lv*0.45));
  }

  if(!canAfford(upCost)){
    toast("å‡ç´šè³‡æºä¸è¶³");
    return;
  }

  pay(upCost);
  tile.level=lv+1;
  pushLog(`å‡ç´šï¼š${meta.name} Lv${tile.level}`);
  toast("â¬†ï¸ å·²å‡ç´š");
}

function demolishBuilding(){
  const {x,y}=state.selected;
  const tile=state.map[y][x];
  if(tile.building==="none"){toast("âš ï¸ å†‡å»ºç¯‰");return;}
  pushLog(`æ‹†é™¤ï¼š${buildingMeta[tile.building].name}`);
  tile.building="none";
  tile.level=0;
  toast("æƒ å·²æ‹†é™¤");
}

/* ---------- Expand Territory ---------- */
function expandTerritory(){
  // expansion cost increases
  const r=state.territoryRadius;
  const goldNeed = Math.floor(200 + r*r*120);
  const ok=tryPayWithGoldOrAeno(goldNeed);
  if(!ok){
    toast("é‡‘å¹£ä¸è¶³ï¼ˆå¯ç”¨AENOè£œï¼‰");
    return;
  }
  state.territoryRadius++;
  pushLog(`é ˜åœŸæ“´å¼µï¼šåŠå¾‘ ${state.territoryRadius}`);
  toast("ğŸŒ é ˜åœŸæ“´å¼µæˆåŠŸ");
}

/* ---------- Market ---------- */
function marketBuy(res,qty){
  qty=Math.max(1,Math.floor(qty));
  const price=state.market.prices[res]||1;
  const cost=qty*price;
  if(state.resources.gold<cost){
    toast("é‡‘å¹£ä¸è¶³");
    return;
  }
  state.resources.gold-=cost;
  state.resources[res]=(state.resources[res]||0)+qty;
  pushLog(`äº¤æ˜“æ‰€è²·å…¥ï¼š${res} x${qty} (-${cost}é‡‘å¹£)`);
  toast("ğŸ›’ å·²è²·å…¥");
}

function marketSell(res,qty){
  qty=Math.max(1,Math.floor(qty));
  if((state.resources[res]||0)<qty){
    toast("è³‡æºä¸è¶³");
    return;
  }
  const price=state.market.prices[res]||1;
  const gain=Math.floor(qty*price*0.85);
  state.resources[res]-=qty;
  state.resources.gold+=gain;
  pushLog(`äº¤æ˜“æ‰€è³£å‡ºï¼š${res} x${qty} (+${gain}é‡‘å¹£)`);
  toast("ğŸ’° å·²è³£å‡º");
}

/* ---------- Stock (simplified) ---------- */
function tickStock(){
  // update pseudo stock every 5 sec
  if(!state.stock.lines || state.stock.lines.length===0){
    state.stock.lines=[];
    for(let i=0;i<30;i++){
      state.stock.lines.push({
        wood:state.market.prices.wood,
        stone:state.market.prices.stone,
        iron:state.market.prices.iron,
        food:state.market.prices.food
      });
    }
  }

  const last=state.stock.lines[state.stock.lines.length-1];
  const next={...last};
  for(const k of ["wood","stone","iron","food"]){
    let v=next[k];
    v += rand(-0.6,0.6);
    v = clamp(v, 0.5, 30);
    next[k]=Math.round(v*10)/10;
    state.market.prices[k]=next[k];
  }
  state.stock.lines.push(next);
  state.stock.lines=state.stock.lines.slice(-60);
}

/* ---------- Tech Tree ---------- */
function gainTechPoints(n){
  state.tech.points += n;
}

function unlockTech(name,cost){
  if(state.tech.points<cost){
    toast("ç§‘æŠ€é»ä¸è¶³");
    return;
  }
  state.tech.points -= cost;

  if(name==="factory") state.tech.unlocked.factory=true;
  if(name==="wall") state.tech.unlocked.wall=true;
  if(name==="tower") state.tech.unlocked.tower=true;

  pushLog("ç§‘æŠ€è§£é–ï¼š"+name);
  toast("ğŸ§  å·²è§£é–ç§‘æŠ€");
}

/* ---------- Ads / Music ---------- */
function playAdSong(){
  if(state.ads.cooldown>0){
    toast("å†·å»ä¸­...");
    return;
  }
  state.ads.playing=true;
  state.ads.cooldown=45;
  pushLog("æ’­æ”¾è´ŠåŠ©æ­Œæ›²ä¸­...");
  toast("ğŸµ æ’­æ”¾ä¸­...");
  setTimeout(()=>{
    state.ads.playing=false;
    const reward=irand(60,140);
    state.resources.gold += reward;
    pushLog(`å»£å‘Šæ­Œæ›²å®Œæˆï¼š+${reward} é‡‘å¹£`);
    toast("ğŸ +"+reward+"é‡‘å¹£");
  }, 2500);
}

/* ---------- Robot Raid (steal 20%) ---------- */
function spawnRobot(){
  state.robot.active=true;
  state.robot.x=irand(0,GRID_W-1);
  state.robot.y=irand(0,GRID_H-1);
  state.robot.stealTimer=15;
  state.robot.adText="SPONSOR";
  pushLog("ğŸ¤– æ©Ÿå™¨äººé™è½ï¼šå¯èƒ½æ å¥ªè³‡æºï¼");
  toast("ğŸ¤– æ©Ÿå™¨äººå…¥ä¾µï¼");
}

function robotSteal(){
  // defense reduces steal
  let def=0;
  for(let y=0;y<GRID_H;y++){
    for(let x=0;x<GRID_W;x++){
      const t=state.map[y][x];
      if(t.building==="wall") def += 0.3*(t.level||1);
      if(t.building==="tower") def += 0.6*(t.level||1);
    }
  }
  def=clamp(def,0,10);

  let stealRate=0.20 - def*0.01;
  stealRate=clamp(stealRate,0.05,0.20);

  const stolen={};
  for(const k of ["wood","stone","iron","food","gold"]){
    const amount=state.resources[k]||0;
    const s=Math.floor(amount*stealRate);
    state.resources[k]-=s;
    stolen[k]=s;
  }

  pushLog(`ğŸ¤– æ©Ÿå™¨äººæ å¥ªæˆåŠŸï¼šå·èµ° ${Math.floor(stealRate*100)}% è³‡æº`);
  toast("ğŸ’€ è¢«å·èµ°è³‡æº "+Math.floor(stealRate*100)+"%");
  state.robot.active=false;
}

/* ---------- Beast Tide ---------- */
function spawnBeastWave(){
  state.beast.active=true;
  state.beast.wave++;
  pushLog("ğŸº ç¸æ½®çˆ†ç™¼ï¼ç¬¬ "+state.beast.wave+" æ³¢");
  toast("ğŸº ç¸æ½®ä¾†è¥²ï¼");
}

function resolveBeast(){
  // (Adding addition logic here to complete the unfinished function without deleting)
  let totalDef = 0;
  for(let y=0;y<GRID_H;y++){
    for(let x=0;x<GRID_W;x++){
      const b = buildingMeta[state.map[y][x].building];
      if(b && b.def) totalDef += b.def * (state.map[y][x].level || 1);
    }
  }
  const attackPower = state.beast.wave * 8;
  if(totalDef >= attackPower){
    pushLog("ğŸ›¡ï¸ æˆåŠŸé˜²ç¦¦ç¸æ½®ï¼ç²å¾— AENO çå‹µ");
    addGenesisCrystal(5); 
  } else {
    pushLog("ğŸ’” åŸç‰†å—æï¼Œæå¤±éƒ¨åˆ†è³‡æº");
    state.resources.gold = Math.floor(state.resources.gold * 0.9);
  }
  state.beast.active = false;
}

/* ---------- ADDITION: Genesis Crystal & Developer Logic ---------- */
function addGenesisCrystal(count){
    for(let i=0; i<count; i++){
        state.dev.crystalCount++;
        if(state.dev.crystalCount % 50 === 0){
            pushLog("ğŸ’ ç¬¬50é¡†å‰µä¸–æ™¶çŸ³å·²å‚³é€è‡³é–‹ç™¼è€…å¸³æˆ¶");
            // Developer's 50th crystal logic
        } else {
            state.resources.aeno++;
        }
    }
}

/* ---------- ADDITION: Auto Wood Production ---------- */
function autoResourceTick(){
    let forestCount = 0;
    for(let y=0; y<GRID_H; y++){
        for(let x=0; x<GRID_W; x++){
            if(state.map[y][x].terrain === "forest" && isInsideTerritory(x,y)){
                forestCount++;
            }
            // Other buildings prod
            const b = state.map[y][x].building;
            const meta = buildingMeta[b];
            if(meta && meta.prod){
                for(let res in meta.prod){
                    state.resources[res] += meta.prod[res] * (state.map[y][x].level || 1) * 0.1;
                }
            }
        }
    }
    // Auto Wood: 0.5 wood per forest in territory per tick
    state.resources.wood += forestCount * 0.5;
}

/* ---------- Render Panel ---------- */
function renderPanel(){
  const tab = document.querySelector(".tab.active").dataset.tab;
  let h = "";
  const r = state.resources;
  
  if(tab === "home"){
      h = `<div class="card">
            <div class="label">åœ‹å®¶è³‡æºå„²å‚™ (Quantum Key: ${state.dev.quantumKey})</div>
            <div class="row">
                <div class="chip">ğŸ’° ${fmt(r.gold)}</div>
                <div class="chip">ğŸ’ ${fmt(r.aeno)}</div>
                <div class="chip">ğŸªµ ${fmt(r.wood)}</div>
                <div class="chip">ğŸª¨ ${fmt(r.stone)}</div>
                <div class="chip">âš™ï¸ ${fmt(r.iron)}</div>
                <div class="chip">ğŸŒ¾ ${fmt(r.food)}</div>
            </div>
          </div>
          <div class="card">
            <div class="label">ç•¶å‰é¸æ“‡ï¼š(${state.selected.x}, ${state.selected.y})</div>
            <div class="big">${buildingMeta[state.map[state.selected.y][state.selected.x].building].name}</div>
            <div class="row" style="margin-top:10px">
                <button class="btn" onclick="upgradeBuilding()">å‡ç´šå»ºç¯‰</button>
                <button class="btn red" onclick="demolishBuilding()">æ‹†é™¤å»ºç¯‰</button>
                <button class="btn purple" onclick="expandTerritory()">æ“´å¼µé ˜åœŸ</button>
            </div>
          </div>`;
  } else if(tab === "market") {
      h = `<div class="card"><b>äº¤æ˜“æ‰€</b></div>`;
      ["wood", "stone", "iron", "food"].forEach(res => {
          h += `<div class="card">
                  <div class="row" style="justify-content:space-between">
                    <span>${res.toUpperCase()} (å–®åƒ¹: ${state.market.prices[res]})</span>
                    <div class="row">
                        <button class="btn" onclick="marketBuy('${res}', 10)">è²·å…¥ 10</button>
                        <button class="btn gold" onclick="marketSell('${res}', 10)">è³£å‡º 10</button>
                    </div>
                  </div>
                </div>`;
      });
  } else if(tab === "build") {
      h = `<div class="card"><b>å»ºè¨­æ¸…å–®</b></div>
           <div class="row">
             <button class="btn" onclick="placeBuilding('farm')">è¾²ç”°</button>
             <button class="btn" onclick="placeBuilding('mine')">ç¤¦å ´</button>
             <button class="btn" onclick="placeBuilding('factory')">å·¥å» </button>
             <button class="btn" onclick="placeBuilding('wall')">åŸç‰†</button>
             <button class="btn" onclick="placeBuilding('tower')">å®ˆè¡›å¡”</button>
           </div>`;
  } else if(tab === "event") {
      h = `<div class="card"><b>äº‹ä»¶ä¸­å¿ƒ</b></div>
           <div class="card">ğŸº ç¸æ½®å€’æ•¸: ${state.beast.timer}s</div>
           <div class="card">ğŸ¤– æ©Ÿå™¨äººç‹€æ…‹: ${state.robot.active ? "å…¥ä¾µä¸­" : "æƒæä¸­"}</div>
           <button class="btn purple" onclick="spawnRobot()">å¬å–šå»£å‘Šæ©Ÿå™¨äºº</button>`;
  } else if(tab === "ads") {
      h = `<div class="card"><b>å»£å‘Šè´ŠåŠ©èˆ‡æ­Œæ›²</b></div>
           <button class="btn gold" onclick="playAdSong()">æ’­æ”¾å»£å‘Šæ­Œ (+é‡‘å¹£)</button>
           <p style="font-size:10px; color:gray; margin-top:10px">å»£å‘Šä½æ‹›ç§Ÿï¼šæ‚¨çš„å»£å‘Šå¯ä»¥è²¼åœ¨æ©Ÿå™¨äººèº«ä¸Šï¼</p>`;
  }
  panelBody.innerHTML = h;
}

document.querySelectorAll(".tab").forEach(t => {
    t.onclick = () => {
        document.querySelectorAll(".tab").forEach(x => x.classList.remove("active"));
        t.classList.add("active");
        renderPanel();
    };
});

/* ---------- Core Game Loop ---------- */
function update(){
    const dt = (now() - state.lastTick) / 1000;
    state.lastTick = now();
    
    // Auto Production
    autoResourceTick();
    
    // Timers
    if(state.beast.timer > 0) state.beast.timer -= dt;
    else {
        state.beast.timer = 90;
        spawnBeastWave();
        setTimeout(resolveBeast, 5000);
    }
    
    if(state.ads.cooldown > 0) state.ads.cooldown -= dt;
    
    // Robot logic
    if(state.robot.active){
        state.robot.stealTimer -= dt;
        if(state.robot.stealTimer <= 0) robotSteal();
    }
}

/* ---------- Drawing (ä¿ç•™æ‰€æœ‰åŸç‰ˆé‚è¼¯) ---------- */
function drawTree(x,y,s){
  ctx.save(); ctx.translate(x,y); ctx.scale(s,s);
  ctx.fillStyle="#92400e"; ctx.fillRect(-4,6,8,16);
  ctx.fillStyle="#22c55e"; ctx.beginPath(); ctx.arc(0,0,12,0,Math.PI*2); ctx.arc(-10,4,10,0,Math.PI*2); ctx.arc(10,4,10,0,Math.PI*2); ctx.fill();
  ctx.restore();
}

function drawBuilding(tx,ty,x,y){
  const tile=state.map[ty][tx]; if(tile.building==="none") return;
  ctx.fillStyle="#334155";
  if(tile.building === "town") ctx.fillStyle="#8b5cf6";
  if(tile.building === "farm") ctx.fillStyle="#fbbf24";
  ctx.fillRect(x-15,y-25,30,25);
  ctx.fillStyle="white"; ctx.font="10px Arial"; ctx.fillText("Lv"+tile.level, x-10, y-10);
}

function draw(){
  const w=cv.width/devicePixelRatio, h=cv.height/devicePixelRatio;
  ctx.clearRect(0,0,w,h);
  ctx.save(); ctx.translate(w/2, h*0.25); ctx.translate(state.camera.x, state.camera.y); ctx.scale(state.camera.zoom, state.camera.zoom);

  for(let y=0;y<GRID_H;y++){
    for(let x=0;x<GRID_W;x++){
      const isoX = (x - y) * (TILE*0.5); const isoY = (x + y) * (TILE*0.28);
      ctx.beginPath();
      ctx.moveTo(isoX, isoY - TILE*0.28); ctx.lineTo(isoX + TILE*0.5, isoY);
      ctx.lineTo(isoX, isoY + TILE*0.28); ctx.lineTo(isoX - TILE*0.5, isoY);
      ctx.closePath();
      ctx.fillStyle = terrainColor[state.map[y][x].terrain];
      if(!isInsideTerritory(x,y)) ctx.globalAlpha = 0.4; else ctx.globalAlpha = 1;
      ctx.fill(); ctx.strokeStyle="#ffffff33"; ctx.stroke();

      if(state.map[y][x].terrain==="forest") drawTree(isoX, isoY, 0.6);
      drawBuilding(x,y,isoX,isoY);
      
      // Robot draw
      if(state.robot.active && state.robot.x === x && state.robot.y === y){
          ctx.fillStyle="red"; ctx.beginPath(); ctx.arc(isoX, isoY-30, 10, 0, Math.PI*2); ctx.fill();
          ctx.fillStyle="black"; ctx.font="10px Arial"; ctx.fillText(state.robot.adText, isoX-20, isoY-45);
      }

      if(x===state.selected.x && y===state.selected.y){
        ctx.strokeStyle="#2563eb"; ctx.lineWidth=3; ctx.stroke();
      }
    }
  }
  ctx.restore();
  update();
  renderPanel();
  requestAnimationFrame(draw);
}

cv.onpointerdown=(e)=>{
  const rect=cv.getBoundingClientRect();
  const x = (e.clientX - rect.left); const y = (e.clientY - rect.top);
  const wx = (x - rect.width/2 - state.camera.x)/state.camera.zoom;
  const wy = (y - rect.height*0.25 - state.camera.y)/state.camera.zoom;
  const tx = Math.round((wx/(TILE*0.5) + wy/(TILE*0.28))/2);
  const ty = Math.round((wy/(TILE*0.28) - wx/(TILE*0.5))/2);
  if(tx>=0 && tx<GRID_W && ty>=0 && ty<GRID_H){ state.selected={x:tx,y:ty}; }
};

resize(); draw();
</script>
</body>
</html>
