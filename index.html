

<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
<title>AENO V3 - Mobile Cartoon Civilization</title>
<style>
  html,body{margin:0;padding:0;width:100%;height:100%;overflow:hidden;background:#dff6ff;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans HK","PingFang HK",sans-serif;}
  #wrap{position:relative;width:100%;height:100%;}

  canvas{
    position:absolute;left:0;top:0;width:100%;height:100%;
    background:linear-gradient(#dff6ff,#f6fbff);
    touch-action:none;
  }

  /* æµ®å‹•æŒ‰éˆ• */
  .fab{
    position:absolute;right:14px;bottom:14px;
    width:54px;height:54px;border-radius:18px;
    background:rgba(255,255,255,0.92);
    box-shadow:0 10px 22px rgba(0,0,0,0.16);
    display:flex;align-items:center;justify-content:center;
    font-size:24px;font-weight:900;color:#2563eb;
    user-select:none;
  }
  .fab:active{transform:scale(0.96);}

  /* è³‡æºåˆ—ï¼ˆé ‚éƒ¨ï¼‰ */
  #topbar{
    position:absolute;left:10px;top:10px;right:10px;
    padding:10px 12px;border-radius:18px;
    background:rgba(255,255,255,0.80);
    box-shadow:0 8px 18px rgba(0,0,0,0.10);
    display:flex;gap:10px;flex-wrap:wrap;
    font-size:13px;
    backdrop-filter:blur(8px);
  }
  .chip{
    background:rgba(37,99,235,0.08);
    padding:6px 10px;border-radius:999px;
    display:flex;gap:6px;align-items:center;
    color:#0f172a;font-weight:700;
  }
  .chip span{opacity:0.7;font-weight:800;}

  /* åŠå±é¢æ¿ï¼ˆå¯æ‹–æ‹‰é«˜åº¦ï¼‰ */
  #panel{
    position:absolute;left:10px;right:10px;bottom:78px;
    height:38%;
    border-radius:22px;
    background:rgba(255,255,255,0.92);
    box-shadow:0 14px 28px rgba(0,0,0,0.16);
    backdrop-filter:blur(10px);
    display:none;
    overflow:hidden;
  }
  #panelHeader{
    height:40px;
    display:flex;align-items:center;justify-content:space-between;
    padding:0 14px;
    background:linear-gradient(90deg,rgba(37,99,235,0.10),rgba(16,185,129,0.10));
    border-bottom:1px solid rgba(0,0,0,0.06);
    font-weight:900;color:#0f172a;
    user-select:none;
  }
  #dragBar{
    width:50px;height:6px;border-radius:999px;
    background:rgba(0,0,0,0.18);
    margin:0 auto;
  }
  #panelBody{
    height:calc(100% - 40px);
    overflow:auto;
    padding:12px;
  }

  .row{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px;}
  .btn{
    border:none;border-radius:16px;
    padding:10px 12px;
    background:rgba(37,99,235,0.12);
    font-weight:900;
    color:#1e293b;
    box-shadow:0 6px 14px rgba(0,0,0,0.06);
    user-select:none;
  }
  .btn:active{transform:scale(0.98);}
  .btn.green{background:rgba(16,185,129,0.16);}
  .btn.orange{background:rgba(245,158,11,0.18);}
  .btn.red{background:rgba(239,68,68,0.18);}
  .btn.small{padding:8px 10px;font-size:12px;border-radius:14px;}

  /* å»ºç¯‰é¸å–®å½ˆçª— */
  #buildPopup{
    position:absolute;left:50%;top:50%;
    transform:translate(-50%,-50%);
    width:min(92vw,420px);
    background:rgba(255,255,255,0.96);
    border-radius:22px;
    box-shadow:0 20px 40px rgba(0,0,0,0.22);
    display:none;
    overflow:hidden;
    backdrop-filter:blur(12px);
  }
  #buildHeader{
    padding:12px 14px;
    font-weight:1000;
    background:linear-gradient(90deg,rgba(37,99,235,0.12),rgba(236,72,153,0.10));
    border-bottom:1px solid rgba(0,0,0,0.06);
    display:flex;justify-content:space-between;align-items:center;
  }
  #buildBody{padding:12px;max-height:55vh;overflow:auto;}
  .card{
    padding:12px;border-radius:18px;
    background:rgba(0,0,0,0.03);
    margin-bottom:10px;
  }
  .cardTitle{font-weight:1000;margin-bottom:6px;}
  .cost{font-size:12px;opacity:0.8;margin-bottom:8px;}
  .hint{font-size:12px;opacity:0.75;line-height:1.4;}

  /* å°é€šçŸ¥ */
  #toast{
    position:absolute;left:50%;bottom:150px;
    transform:translateX(-50%);
    background:rgba(15,23,42,0.88);
    color:white;
    padding:10px 14px;
    border-radius:999px;
    font-size:13px;
    font-weight:900;
    display:none;
    z-index:10;
  }
</style>
</head>
<body>
<div id="wrap">
  <canvas id="game"></canvas>

  <div id="topbar"></div>

  <div id="panel">
    <div id="panelHeader">
      <div>æ§åˆ¶ä¸­å¿ƒ</div>
      <div style="display:flex;gap:10px;align-items:center;">
        <div id="dragBar"></div>
        <button class="btn small red" id="closePanel">é—œé–‰</button>
      </div>
    </div>
    <div id="panelBody">
      <div class="row">
        <button class="btn green" id="btnAd">ğŸµ æ’­æ”¾å»£å‘Šæ­Œæ›²</button>
        <button class="btn orange" id="btnLearn">ğŸ—£ èªè¨€å­¸ç¿’</button>
        <button class="btn" id="btnExchange">ğŸ’± äº¤æ˜“æ‰€</button>
        <button class="btn" id="btnTech">ğŸ§  ç§‘æŠ€æ¨¹</button>
      </div>

      <div class="row">
        <button class="btn" id="btnRobot">ğŸ¤– æ´¾å‡ºæ©Ÿå™¨äººæ¢æ¸¬</button>
        <button class="btn" id="btnAuto">ğŸ§¸ AIåŠ©æ‰‹è‡ªå‹•æ¨¡å¼ï¼šON</button>
        <button class="btn" id="btnSave">ğŸ’¾ æ‰‹å‹•ä¿å­˜</button>
      </div>

      <div class="card">
        <div class="cardTitle">ğŸ“Œ å»ºç¯‰æç¤º</div>
        <div class="hint">
          ä½ å¯ä»¥ç›´æ¥é»åœ°åœ–ç©ºåœ° â†’ å½ˆå‡ºå»ºç¯‰é¸å–® â†’ æŒ‰ã€Œç¢ºèªå»ºé€ ã€ã€‚<br>
          AIåŠ©æ‰‹æœƒè‡ªå‹•å¹«ä½ å»ºä¼æœ¨å ´/æ¡çŸ³å ´/æˆ¿å±‹ï¼Œç¢ºä¿æ—©æœŸä¸æœƒå¡ä½ã€‚<br>
          é›¢ç·š/å¤–æ›è³‡æºæœ€å¤šåªè¨ˆ 24 å°æ™‚ã€‚
        </div>
      </div>

      <div class="card">
        <div class="cardTitle">ğŸª™ AENO ç”¢å‡ºè¦å‰‡ï¼ˆéš±è—ç®—æ³•ï¼‰</div>
        <div class="hint">
          AENO ä¸»è¦ä¾†è‡ªï¼šå»£å‘Šæ­Œæ›² + èªè¨€å­¸ç¿’ + æ–‡æ˜æˆæœ¬è²¢ç»ã€‚<br>
          4å¹´æ¸›åŠæ›²ç·šä¸Šé™ 20,000,000ã€‚<br>
          ï¼ˆæ ¸å¿ƒæ•¸å­—æ˜ å°„å·²åšæ··æ·†ï¼Œä¸æœƒç›´æ¥æš´éœ²ï¼‰
        </div>
      </div>

      <div class="card">
        <div class="cardTitle">âš”ï¸ ç¸æ½®</div>
        <div class="hint">
          åŸç‰†æœª 100% å®Œæˆ â†’ æ°¸é ä¸è§¸ç™¼ç¸æ½®ã€‚<br>
          å®Œæˆå¾Œæœƒæ‰è½ã€Œé‡è »ç¢ç‰‡ã€å¯æ›é‡‘å¹£èˆ‡AENOç¢ç‰‡ã€‚
        </div>
      </div>
    </div>
  </div>

  <div id="buildPopup">
    <div id="buildHeader">
      <div>ğŸ— å»ºç¯‰é¸å–®</div>
      <button class="btn small red" id="closeBuild">é—œé–‰</button>
    </div>
    <div id="buildBody"></div>
  </div>

  <div id="toast"></div>

  <div class="fab" id="fab">â˜°</div>
</div>

<script>
/* =========================================================
   AENO V3 - FULL SINGLE FILE GAME ENGINE (SAVE VERSION)
   - Portrait Mobile
   - Drag + Zoom
   - Tap empty tile => build popup
   - Workers + Animals moving
   - Auto build early game
   - Offline simulation capped 24 hours
   - AENO algorithm obfuscated
========================================================= */

const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

function resize(){
  const dpr = Math.max(1, window.devicePixelRatio || 1);
  canvas.width = Math.floor(innerWidth * dpr);
  canvas.height = Math.floor(innerHeight * dpr);
  ctx.setTransform(dpr,0,0,dpr,0,0);
}
window.addEventListener("resize", resize);
resize();

/* ---------- UI refs ---------- */
const topbar = document.getElementById("topbar");
const panel = document.getElementById("panel");
const fab = document.getElementById("fab");
const closePanel = document.getElementById("closePanel");
const toast = document.getElementById("toast");

const buildPopup = document.getElementById("buildPopup");
const buildBody = document.getElementById("buildBody");
const closeBuild = document.getElementById("closeBuild");

const btnAuto = document.getElementById("btnAuto");
const btnAd = document.getElementById("btnAd");
const btnLearn = document.getElementById("btnLearn");
const btnRobot = document.getElementById("btnRobot");
const btnSave = document.getElementById("btnSave");
const btnExchange = document.getElementById("btnExchange");
const btnTech = document.getElementById("btnTech");

/* ---------- Toast ---------- */
let toastTimer=null;
function showToast(msg){
  toast.textContent = msg;
  toast.style.display="block";
  clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>toast.style.display="none",1600);
}

/* =========================================================
   WORLD SETTINGS
========================================================= */
const TILE = 64;
const WORLD_W = 40;
const WORLD_H = 40;

/* camera */
let camX = -500;
let camY = -800;
let zoom = 1.0;
const ZMIN = 0.25;
const ZMAX = 4.5;

/* input */
let dragging=false;
let lastTouch=null;
let lastDist=0;
let pointerDown=false;
let downPos=null;

/* =========================================================
   GAME SAVE SYSTEM (localStorage)
========================================================= */
const SAVE_KEY="AENO_V3_SAVE_MAIN";

function nowSec(){ return Math.floor(Date.now()/1000); }

function defaultGame(){
  // åˆå§‹ 2æˆ¿ + 4å·¥äºº + åŸºæœ¬è³‡æºï¼ˆä½ è¦æ±‚ï¼‰
  return {
    ver: 3,
    lastSeen: nowSec(),
    offlineCapSec: 24*3600,

    autoAI: true,

    coins: 2200,
    aeno: 0,
    aenoShard: 0,

    wood: 180,
    stone: 120,
    iron: 60,
    food: 150,

    pop: 4,
    workers: [
      {id:"W1",x:20,y:20,tx:20,ty:20,phase:Math.random()},
      {id:"W2",x:21,y:20,tx:21,ty:20,phase:Math.random()},
      {id:"W3",x:20,y:21,tx:20,ty:21,phase:Math.random()},
      {id:"W4",x:21,y:21,tx:21,ty:21,phase:Math.random()},
    ],

    animals: [
      {type:"rabbit",x:18,y:18,tx:18,ty:18,phase:Math.random()},
      {type:"deer",x:26,y:18,tx:26,ty:18,phase:Math.random()},
    ],

    territory: {cx:20,cy:20,r:4},

    wallComplete: 0, // 0~100

    tiles: [],

    buildings: [
      {type:"house",x:20,y:20,lvl:1,progress:100},
      {type:"house",x:21,y:20,lvl:1,progress:100},
    ],

    logs: [],
    globalShare: 1000000, // dummy global pool denominator
    dayMintPool: 42, // dummy daily mint pool baseline
  };
}

function saveGame(){
  game.lastSeen = nowSec();
  localStorage.setItem(SAVE_KEY, JSON.stringify(game));
  showToast("å·²ä¿å­˜ âœ…");
}

function loadGame(){
  const raw = localStorage.getItem(SAVE_KEY);
  if(!raw) return defaultGame();
  try{
    const g = JSON.parse(raw);
    if(!g.ver) return defaultGame();
    return g;
  }catch(e){
    return defaultGame();
  }
}

let game = loadGame();

/* =========================================================
   OFFLINE SIMULATION (CAP 24H)
========================================================= */
function offlineSim(){
  const t = nowSec();
  let dt = t - (game.lastSeen||t);
  if(dt<=0) return;

  const cap = game.offlineCapSec || (24*3600);
  if(dt>cap){
    dt = cap;
  }

  simulate(dt,true);

  game.lastSeen = t;
  saveGame();
}
offlineSim();

/* =========================================================
   MAP / TERRAIN GENERATION (forest/stone/iron)
========================================================= */
function inTerritory(x,y){
  const dx=x-game.territory.cx;
  const dy=y-game.territory.cy;
  return (dx*dx+dy*dy) <= (game.territory.r*game.territory.r);
}

function ensureTiles(){
  if(game.tiles && game.tiles.length===WORLD_W*WORLD_H) return;

  game.tiles = new Array(WORLD_W*WORLD_H).fill(0).map((_,i)=>{
    const x=i%WORLD_W, y=Math.floor(i/WORLD_W);

    // 0 grass, 1 forest, 2 stone, 3 iron, 4 water
    let type=0;

    // water bands
    if(Math.abs(x-12)<2 && y>5 && y<35) type=4;

    // forest zones
    if(type===0 && (Math.random()<0.22)) type=1;

    // stone
    if(type===0 && (Math.random()<0.10)) type=2;

    // iron rarer
    if(type===0 && (Math.random()<0.06)) type=3;

    return {type};
  });

  // ç¢ºä¿ç©å®¶é™„è¿‘å¿…æœ‰è³‡æºï¼ˆé¿å…å¡æ­»ï¼‰
  for(let yy=16; yy<=26; yy++){
    for(let xx=16; xx<=26; xx++){
      const idx=yy*WORLD_W+xx;
      if(game.tiles[idx].type===4) continue;
      if(Math.random()<0.28) game.tiles[idx].type=1;
      if(Math.random()<0.12) game.tiles[idx].type=2;
      if(Math.random()<0.08) game.tiles[idx].type=3;
    }
  }
}
ensureTiles();

/* =========================================================
   BUILDINGS
========================================================= */
const BUILD_DEFS = {
  house: {name:"æˆ¿å±‹",cost:{wood:40,stone:20},desc:"å¢åŠ äººå£ä¸Šé™ (+2 pop)",baseTime:20},
  lumber: {name:"ä¼æœ¨å ´",cost:{wood:30},desc:"æ¯ç§’ç”¢æœ¨æ",baseTime:18},
  quarry: {name:"æ¡çŸ³å ´",cost:{wood:20,stone:10},desc:"æ¯ç§’ç”¢çŸ³é ­",baseTime:22},
  ironmine: {name:"éµç¤¦å ´",cost:{wood:30,stone:30},desc:"æ¯ç§’ç”¢éµ",baseTime:28},
  farm: {name:"è¾²ç”°",cost:{wood:20},desc:"æ¯ç§’ç”¢é£Ÿç‰©",baseTime:18},
  factory: {name:"å·¥å» ",cost:{wood:80,stone:60,iron:40},desc:"ç”¢é‡‘å¹£/æå‡æ•ˆç‡",baseTime:40},
  wall: {name:"åŸç‰†",cost:{wood:120,stone:180,iron:80},desc:"å®Œæˆå¾Œæ‰æœƒè§¸ç™¼ç¸æ½®",baseTime:80},
  market: {name:"äº¤æ˜“æ‰€",cost:{wood:80,stone:50},desc:"è³‡æºè²·è³£å…¥å£",baseTime:35},
};

function buildingAt(x,y){
  return game.buildings.find(b=>b.x===x && b.y===y);
}

function canAfford(cost){
  for(const k in cost){
    if((game[k]||0) < cost[k]) return false;
  }
  return true;
}

function payCost(cost){
  for(const k in cost){
    game[k]-=cost[k];
  }
}

function addBuilding(type,x,y){
  const def=BUILD_DEFS[type];
  if(!def) return false;
  if(!inTerritory(x,y)){ showToast("å””ä¿‚ä½ é ˜åœŸå…§ âŒ"); return false; }
  if(buildingAt(x,y)){ showToast("å‘¢æ ¼å·²ç¶“æœ‰å»ºç¯‰"); return false; }

  if(!canAfford(def.cost)){
    showToast("è³‡æºä¸è¶³ âŒ");
    return false;
  }

  payCost(def.cost);
  game.buildings.push({type,x,y,lvl:1,progress:0});
  showToast("é–‹å§‹å»ºé€ ï¼š" + def.name);
  return true;
}

/* =========================================================
   BUILD POPUP (tap empty tile)
========================================================= */
let selectedTile=null;

function openBuildPopup(tileX,tileY){
  selectedTile={x:tileX,y:tileY};

  buildBody.innerHTML="";
  Object.keys(BUILD_DEFS).forEach(type=>{
    const def=BUILD_DEFS[type];
    const costStr = Object.entries(def.cost).map(([k,v])=>`${k}:${v}`).join("  ");
    const card=document.createElement("div");
    card.className="card";
    card.innerHTML=`
      <div class="cardTitle">${def.name}</div>
      <div class="cost">æˆæœ¬ï¼š${costStr || "å…è²»"}</div>
      <div class="hint">${def.desc}</div>
      <div style="margin-top:10px;display:flex;gap:10px;">
        <button class="btn green" data-type="${type}">ç¢ºèªå»ºé€ </button>
      </div>
    `;
    buildBody.appendChild(card);
  });

  buildPopup.style.display="block";
}

buildBody.addEventListener("click",(e)=>{
  const btn=e.target.closest("button[data-type]");
  if(!btn) return;
  const type=btn.getAttribute("data-type");
  if(!selectedTile) return;

  const ok=addBuilding(type,selectedTile.x,selectedTile.y);
  if(ok){
    buildPopup.style.display="none";
    selectedTile=null;
    saveGame();
  }
});

closeBuild.onclick=()=>{
  buildPopup.style.display="none";
  selectedTile=null;
};

/* =========================================================
   PANEL UI
========================================================= */
fab.onclick=()=>{
  panel.style.display = (panel.style.display==="block") ? "none" : "block";
};

closePanel.onclick=()=>{
  panel.style.display="none";
};

btnAuto.onclick=()=>{
  game.autoAI = !game.autoAI;
  btnAuto.textContent = "ğŸ§¸ AIåŠ©æ‰‹è‡ªå‹•æ¨¡å¼ï¼š" + (game.autoAI?"ON":"OFF");
  saveGame();
};

btnSave.onclick=()=>saveGame();

btnExchange.onclick=()=>{
  showToast("äº¤æ˜“æ‰€ï¼šä¸‹ä¸€ç‰ˆæœƒåŠ å…¥è²·/è³£æŒ‰éˆ•");
};

btnTech.onclick=()=>{
  showToast("ç§‘æŠ€æ¨¹ï¼šä¸‹ä¸€ç‰ˆæœƒåŠ å…¥ç ”ç©¶ç³»çµ±");
};

/* =========================================================
   AD MUSIC SYSTEM (æº–å‚™å»£å‘Šå•†æ­Œæ›²)
========================================================= */
let audio=null;
btnAd.onclick=()=>{
  // å…ˆç”¨ç¤ºç¯„éŸ³æ•ˆï¼ˆç„¡å»£å‘Šå•†æ™‚äº¦å¯æ¸¬è©¦ï¼‰
  if(!audio){
    audio = new Audio();
    // é€™å€‹æ˜¯ç©ºä½ï¼Œæ­£å¼ç‰ˆå»£å‘Šå•†åªè¦æ› URL å°±å¯ä»¥ï¼Œä¸éœ€æ›´æ–°ç¨‹å¼
    audio.src = "data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA=";
    audio.loop=false;
  }
  audio.play().catch(()=>{});
  showToast("æ’­æ”¾å»£å‘Šæ­Œæ›² +1è²¢ç»");
  addAdScore(1);
};

btnLearn.onclick=()=>{
  showToast("èªè¨€å­¸ç¿’ +1è²¢ç»ï¼ˆæ¸¬è©¦ï¼‰");
  addLearnScore(1);
};

btnRobot.onclick=()=>{
  showToast("æ´¾å‡ºæ©Ÿå™¨äººæ¢æ¸¬ï¼ˆä½æ©Ÿç‡äº‹ä»¶ï¼‰");
  // åªä¿‚äº‹ä»¶æ¨¡æ“¬ï¼šå¯èƒ½å¸¶å›è³‡æº
  if(Math.random()<0.55){
    const w=20+Math.floor(Math.random()*40);
    const s=10+Math.floor(Math.random()*30);
    const i=5+Math.floor(Math.random()*15);
    game.wood+=w; game.stone+=s; game.iron+=i;
    showToast(`ğŸ¤– å¸¶å› æœ¨${w} çŸ³${s} éµ${i}`);
  }else{
    showToast("ğŸ¤– ä»€éº¼éƒ½æ‰¾ä¸åˆ°...");
  }
  saveGame();
};

/* =========================================================
   AENO HIDDEN ALGORITHM (OBFUSCATED)
   æ³¨æ„ï¼šå‰ç«¯æ°¸é å¯è¢«ç ´è§£ï¼Œä½†æ­¤ç‰ˆæœ¬åšåˆ°ã€Œæ™®é€šäººçœ‹ä¸åˆ°ã€
========================================================= */
let hiddenState = {
  a: 0,
  b: 0,
  c: 0,
  seed: Math.floor(Math.random()*9999999)
};

function _mix(n){
  n ^= (n << 13);
  n ^= (n >> 17);
  n ^= (n << 5);
  return n >>> 0;
}

function _salt(){
  const t = nowSec();
  const base = (t ^ hiddenState.seed ^ (game.pop*777)) >>> 0;
  return _mix(base);
}

// æ¨¡æ“¬ã€Œè‹±æ–‡å­—æ˜ å°„ã€æ¦‚å¿µï¼šä¸ç›´æ¥ç”¨0/1ï¼Œç”¨å­—æ¯åºåˆ—+hash
function _encBits(v){
  const alpha="QWERTYUIOPASDFGHJKLZXCVBNM";
  let out="";
  let x = (v ^ _salt())>>>0;
  for(let i=0;i<16;i++){
    const idx = (x + i*7) % alpha.length;
    out += alpha[idx];
    x = _mix(x + idx*1337);
  }
  return out;
}

function _scoreToMint(score){
  // score -> pseudo bits -> number
  const token=_encBits(score);
  let sum=0;
  for(let i=0;i<token.length;i++){
    const code=token.charCodeAt(i);
    // é€™è£¡å°±ä¿‚ä½ è¬›å˜…ã€Œç¬¬11å­—=1ã€ç¬¬20å­—=0ã€æ¦‚å¿µçš„æ··åˆç‰ˆ
    sum += ((code * (i+11)) ^ (i*19)) & 255;
  }
  // normalize
  const base = (sum % 1000) / 1000;
  return base;
}

function addAdScore(n){
  hiddenState.a += n;
  mintAeno();
}
function addLearnScore(n){
  hiddenState.b += n;
  mintAeno();
}
function addBuildScore(n){
  hiddenState.c += n;
  mintAeno();
}

function mintAeno(){
  // Daily pool concept (æ¸›åŠæ¦‚å¿µç°¡åŒ–)
  const dayPool = game.dayMintPool;

  const score =
    hiddenState.a*40 +
    hiddenState.b*25 +
    hiddenState.c*15 +
    (game.coins/100)*3 +
    (game.pop)*2;

  const ratio = _scoreToMint(score);
  let gain = Math.floor(dayPool * ratio * 0.08);

  if(gain<0) gain=0;
  if(gain>3) gain=3; // é˜²çˆ†ä¸Šé™ï¼ˆå‰ç«¯ç‰ˆï¼‰

  game.aenoShard += gain;

  if(game.aenoShard>=100){
    const add = Math.floor(game.aenoShard/100);
    game.aeno += add;
    game.aenoShard %= 100;
    showToast(`ğŸª™ AENO +${add}`);
  }
}

/* =========================================================
   AI AUTO BUILD SYSTEM (fix early stuck)
========================================================= */
function aiAutoLogic(dt){
  if(!game.autoAI) return;

  // å¦‚æœæœ¨æå¤ªå°‘ï¼Œè‡ªå‹•å„ªå…ˆèµ·ä¼æœ¨å ´
  const lumberCount = game.buildings.filter(b=>b.type==="lumber").length;
  const quarryCount = game.buildings.filter(b=>b.type==="quarry").length;
  const ironCount = game.buildings.filter(b=>b.type==="ironmine").length;
  const farmCount = game.buildings.filter(b=>b.type==="farm").length;

  // æ¯éš”ä¸€æ®µæ™‚é–“æ‰è§¸ç™¼ä¸€æ¬¡AIæ±ºç­–
  if(Math.random()>0.02) return;

  // AIåªæœƒåœ¨é ˜åœŸå…§ç©ºåœ°å»ºç¯‰
  const candidates=[];
  for(let y=0;y<WORLD_H;y++){
    for(let x=0;x<WORLD_W;x++){
      if(!inTerritory(x,y)) continue;
      if(buildingAt(x,y)) continue;
      const tile=game.tiles[y*WORLD_W+x];
      if(tile.type===4) continue;
      candidates.push({x,y,tile:tile.type});
    }
  }
  if(candidates.length===0) return;

  function pickTile(typeWanted){
    const list=candidates.filter(c=>c.tile===typeWanted);
    if(list.length===0) return candidates[Math.floor(Math.random()*candidates.length)];
    return list[Math.floor(Math.random()*list.length)];
  }

  // ä¼æœ¨å ´å¿…é ˆå»ºåœ¨æ£®æ—(1)
  if(lumberCount<1){
    const p=pickTile(1);
    if(p && canAfford(BUILD_DEFS.lumber.cost)){
      addBuilding("lumber",p.x,p.y);
      addBuildScore(2);
      return;
    }
  }

  // æ¡çŸ³å ´å»ºåœ¨çŸ³ç¤¦(2)
  if(quarryCount<1){
    const p=pickTile(2);
    if(p && canAfford(BUILD_DEFS.quarry.cost)){
      addBuilding("quarry",p.x,p.y);
      addBuildScore(2);
      return;
    }
  }

  // éµç¤¦å ´å»ºåœ¨éµç¤¦(3)
  if(ironCount<1){
    const p=pickTile(3);
    if(p && canAfford(BUILD_DEFS.ironmine.cost)){
      addBuilding("ironmine",p.x,p.y);
      addBuildScore(2);
      return;
    }
  }

  // é£Ÿç‰©ä¸è¶³èµ·è¾²ç”°
  if(game.food<120 && farmCount<2){
    const p=pickTile(0);
    if(p && canAfford(BUILD_DEFS.farm.cost)){
      addBuilding("farm",p.x,p.y);
      addBuildScore(1);
      return;
    }
  }

  // äººå£ä¸è¶³èµ·æˆ¿å±‹
  if(game.pop<10 && game.coins>400){
    const p=pickTile(0);
    if(p && canAfford(BUILD_DEFS.house.cost)){
      addBuilding("house",p.x,p.y);
      addBuildScore(2);
      return;
    }
  }
}

/* =========================================================
   SIMULATION ENGINE
========================================================= */
function simulate(dt,offline=false){
  // dt seconds

  // å»ºç¯‰å»ºé€ é€²åº¦
  for(const b of game.buildings){
    if(b.progress<100){
      const def=BUILD_DEFS[b.type];
      const speed = 100 / (def.baseTime || 20);
      b.progress += speed * dt;
      if(b.progress>=100){
        b.progress=100;
        // å®Œæˆæ™‚åŠ äººå£æˆ–æ•ˆæœ
        if(b.type==="house"){
          game.pop += 2;
        }
        if(b.type==="wall"){
          game.wallComplete = 100;
        }
        addBuildScore(3);
      }
    }
  }

  // ç”Ÿç”¢
  for(const b of game.buildings){
    if(b.progress<100) continue;
    if(b.type==="lumber") game.wood += 0.8*dt;
    if(b.type==="quarry") game.stone += 0.55*dt;
    if(b.type==="ironmine") game.iron += 0.35*dt;
    if(b.type==="farm") game.food += 0.7*dt;

    if(b.type==="factory"){
      game.coins += 0.18*dt;
    }
  }

  // äººå£æ¶ˆè€—é£Ÿç‰©
  game.food -= (game.pop * 0.01) * dt;
  if(game.food<0){
    game.food=0;
    // é£Ÿç‰©ä¸è¶³æœƒé™ä½ç”Ÿç”¢æ•ˆç‡ï¼ˆç°¡åŒ–ï¼‰
    game.wood *= 0.999;
    game.stone *= 0.999;
    game.iron *= 0.999;
  }

  // è‡ªå‹•æ“´å¼µé ˜åœŸï¼ˆä¼æœ¨/ç‹©çµ->é‡‘å¹£æ“´åœŸæ¦‚å¿µï¼‰
  if(game.coins>1200){
    const need = 1200 + (game.territory.r*game.territory.r*50);
    if(game.coins>=need){
      game.coins -= need*0.55;
      game.territory.r += 1;
      showToast("ğŸ• é ˜åœŸæ“´å¼µ +1");
      addBuildScore(5);
    }
  }

  // AI è‡ªå‹•å»ºç¯‰
  aiAutoLogic(dt);

  // åœ¨ç·šæ´»èºåº¦ï¼ˆä½æ¬Šé‡ï¼‰
  if(!offline){
    if(Math.random()<0.05){
      addBuildScore(1);
    }
  }

  // é™åˆ¶è³‡æºæ•¸å€¼æ•´æ½”
  ["wood","stone","iron","food","coins"].forEach(k=>{
    if(game[k]<0) game[k]=0;
    game[k]=Math.floor(game[k]);
  });
}

/* =========================================================
   WORKERS + ANIMALS MOVEMENT
========================================================= */
function randomStep(obj){
  if(Math.random()<0.02){
    const dx = Math.floor(Math.random()*7)-3;
    const dy = Math.floor(Math.random()*7)-3;
    let nx = obj.x + dx;
    let ny = obj.y + dy;
    nx = Math.max(0,Math.min(WORLD_W-1,nx));
    ny = Math.max(0,Math.min(WORLD_H-1,ny));
    obj.tx = nx; obj.ty = ny;
  }
}

function moveToward(obj,dt){
  const sp = 1.2; // tiles per second
  const dx = obj.tx - obj.x;
  const dy = obj.ty - obj.y;
  const dist = Math.sqrt(dx*dx+dy*dy);
  if(dist<0.01) return;
  const step = sp * dt;
  if(step>=dist){
    obj.x = obj.tx;
    obj.y = obj.ty;
  }else{
    obj.x += (dx/dist)*step;
    obj.y += (dy/dist)*step;
  }
}

function updateUnits(dt){
  for(const w of game.workers){
    randomStep(w);
    moveToward(w,dt);
  }
  for(const a of game.animals){
    randomStep(a);
    moveToward(a,dt*0.8);
  }
}

/* =========================================================
   INPUT: DRAG + ZOOM + TAP TILE
========================================================= */
function screenToWorld(px,py){
  const x = (px/zoom - camX);
  const y = (py/zoom - camY);
  return {x,y};
}
function worldToTile(wx,wy){
  return {tx:Math.floor(wx/TILE), ty:Math.floor(wy/TILE)};
}

canvas.addEventListener("pointerdown",(e)=>{
  pointerDown=true;
  downPos={x:e.clientX,y:e.clientY,t:Date.now()};
  dragging=false;
});

canvas.addEventListener("pointermove",(e)=>{
  if(!pointerDown) return;
  const dx=e.movementX;
  const dy=e.movementY;

  if(Math.abs(dx)+Math.abs(dy)>2){
    dragging=true;
    camX += dx/zoom;
    camY += dy/zoom;
  }
});

canvas.addEventListener("pointerup",(e)=>{
  pointerDown=false;

  if(!dragging && downPos){
    const dt=Date.now()-downPos.t;
    const dd=Math.abs(e.clientX-downPos.x)+Math.abs(e.clientY-downPos.y);

    if(dt<400 && dd<12){
      const w=screenToWorld(e.clientX,e.clientY);
      const t=worldToTile(w.x,w.y);

      if(t.tx>=0 && t.tx<WORLD_W && t.ty>=0 && t.ty<WORLD_H){
        const tile=game.tiles[t.ty*WORLD_W+t.tx];
        if(tile.type===4){
          showToast("æ°´é¢ä¸èƒ½å»ºé€ ");
          return;
        }

        if(!inTerritory(t.tx,t.ty)){
          showToast("å””ä¿‚ä½ é ˜åœŸå…§");
          return;
        }

        if(buildingAt(t.tx,t.ty)){
          showToast("å·²æœ‰å»ºç¯‰");
          return;
        }

        openBuildPopup(t.tx,t.ty);
      }
    }
  }
});

/* wheel zoom (desktop) */
canvas.addEventListener("wheel",(e)=>{
  e.preventDefault();
  const old=zoom;
  const factor = (e.deltaY>0) ? 0.92 : 1.08;
  zoom *= factor;
  zoom = Math.max(ZMIN,Math.min(ZMAX,zoom));

  // zoom towards cursor
  const mx=e.clientX, my=e.clientY;
  const before=screenToWorld(mx,my);
  const after=screenToWorld(mx,my);
  camX += (after.x-before.x);
  camY += (after.y-before.y);
},{passive:false});

/* touch pinch */
canvas.addEventListener("touchstart",(e)=>{
  if(e.touches.length===2){
    const dx=e.touches[0].clientX-e.touches[1].clientX;
    const dy=e.touches[0].clientY-e.touches[1].clientY;
    lastDist=Math.sqrt(dx*dx+dy*dy);
  }
},{passive:false});

canvas.addEventListener("touchmove",(e)=>{
  if(e.touches.length===2){
    e.preventDefault();
    const dx=e.touches[0].clientX-e.touches[1].clientX;
    const dy=e.touches[0].clientY-e.touches[1].clientY;
    const dist=Math.sqrt(dx*dx+dy*dy);
    const diff = dist-lastDist;

    zoom *= (1 + diff/350);
    zoom=Math.max(ZMIN,Math.min(ZMAX,zoom));
    lastDist=dist;
  }
},{passive:false});

/* =========================================================
   RENDERING
========================================================= */
function drawTile(x,y,type){
  const wx=x*TILE;
  const wy=y*TILE;

  // grass
  ctx.fillStyle="#d1fae5";
  ctx.fillRect(wx,wy,TILE,TILE);

  // grid line
  ctx.strokeStyle="rgba(0,0,0,0.06)";
  ctx.strokeRect(wx,wy,TILE,TILE);

  if(type===1){
    // forest
    ctx.fillStyle="#22c55e";
    ctx.beginPath();
    ctx.arc(wx+TILE*0.5,wy+TILE*0.55,18,0,Math.PI*2);
    ctx.fill();
    ctx.fillStyle="#16a34a";
    ctx.beginPath();
    ctx.arc(wx+TILE*0.35,wy+TILE*0.65,14,0,Math.PI*2);
    ctx.fill();
    ctx.fillStyle="#92400e";
    ctx.fillRect(wx+TILE*0.47,wy+TILE*0.70,8,16);
  }
  if(type===2){
    // stone
    ctx.fillStyle="#94a3b8";
    ctx.beginPath();
    ctx.roundRect(wx+12,wy+18,40,30,10);
    ctx.fill();
  }
  if(type===3){
    // iron
    ctx.fillStyle="#64748b";
    ctx.beginPath();
    ctx.roundRect(wx+14,wy+18,36,28,10);
    ctx.fill();
    ctx.fillStyle="#ef4444";
    ctx.beginPath();
    ctx.arc(wx+34,wy+34,6,0,Math.PI*2);
    ctx.fill();
  }
  if(type===4){
    // water
    ctx.fillStyle="#60a5fa";
    ctx.fillRect(wx,wy,TILE,TILE);
    ctx.fillStyle="rgba(255,255,255,0.25)";
    ctx.fillRect(wx,wy+10,TILE,10);
  }

  // territory highlight
  if(inTerritory(x,y)){
    ctx.fillStyle="rgba(37,99,235,0.06)";
    ctx.fillRect(wx,wy,TILE,TILE);
  }
}

function drawBuilding(b){
  const wx=b.x*TILE;
  const wy=b.y*TILE;

  // shadow
  ctx.fillStyle="rgba(0,0,0,0.12)";
  ctx.beginPath();
  ctx.ellipse(wx+TILE/2,wy+TILE*0.75,22,10,0,0,Math.PI*2);
  ctx.fill();

  const p = b.progress/100;

  function progressBar(){
    if(b.progress>=100) return;
    ctx.fillStyle="rgba(0,0,0,0.18)";
    ctx.fillRect(wx+10,wy+8,44,8);
    ctx.fillStyle="#22c55e";
    ctx.fillRect(wx+10,wy+8,44*p,8);
  }

  if(b.type==="house"){
    ctx.fillStyle="#fde68a";
    ctx.beginPath();
    ctx.roundRect(wx+14,wy+24,36,28,10);
    ctx.fill();
    ctx.fillStyle="#f59e0b";
    ctx.beginPath();
    ctx.moveTo(wx+12,wy+26);
    ctx.quadraticCurveTo(wx+32,wy+8,wx+52,wy+26);
    ctx.closePath();
    ctx.fill();
    ctx.fillStyle="#92400e";
    ctx.fillRect(wx+30,wy+38,10,14);
    progressBar();
  }

  if(b.type==="lumber"){
    ctx.fillStyle="#a16207";
    ctx.beginPath();
    ctx.roundRect(wx+14,wy+28,36,26,10);
    ctx.fill();
    ctx.fillStyle="#16a34a";
    ctx.beginPath();
    ctx.arc(wx+32,wy+24,14,0,Math.PI*2);
    ctx.fill();
    progressBar();
  }

  if(b.type==="quarry"){
    ctx.fillStyle="#94a3b8";
    ctx.beginPath();
    ctx.roundRect(wx+14,wy+28,36,26,10);
    ctx.fill();
    ctx.fillStyle="#475569";
    ctx.fillRect(wx+26,wy+22,12,10);
    progressBar();
  }

  if(b.type==="ironmine"){
    ctx.fillStyle="#64748b";
    ctx.beginPath();
    ctx.roundRect(wx+14,wy+28,36,26,10);
    ctx.fill();
    ctx.fillStyle="#ef4444";
    ctx.beginPath();
    ctx.arc(wx+40,wy+40,6,0,Math.PI*2);
    ctx.fill();
    progressBar();
  }

  if(b.type==="farm"){
    ctx.fillStyle="#86efac";
    ctx.beginPath();
    ctx.roundRect(wx+10,wy+28,44,26,12);
    ctx.fill();
    ctx.fillStyle="#16a34a";
    for(let i=0;i<4;i++){
      ctx.fillRect(wx+14+i*10,wy+34,6,16);
    }
    progressBar();
  }

  if(b.type==="factory"){
    ctx.fillStyle="#cbd5e1";
    ctx.beginPath();
    ctx.roundRect(wx+10,wy+24,44,30,10);
    ctx.fill();
    ctx.fillStyle="#64748b";
    ctx.fillRect(wx+18,wy+18,10,12);
    ctx.fillRect(wx+34,wy+18,10,12);
    progressBar();
  }

  if(b.type==="wall"){
    ctx.fillStyle="#9ca3af";
    ctx.fillRect(wx+8,wy+30,48,22);
    ctx.fillStyle="#6b7280";
    for(let i=0;i<6;i++){
      ctx.fillRect(wx+10+i*8,wy+26,6,10);
    }
    progressBar();
  }

  if(b.type==="market"){
    ctx.fillStyle="#fbcfe8";
    ctx.beginPath();
    ctx.roundRect(wx+10,wy+26,44,28,12);
    ctx.fill();
    ctx.fillStyle="#ec4899";
    ctx.beginPath();
    ctx.moveTo(wx+10,wy+28);
    ctx.quadraticCurveTo(wx+32,wy+8,wx+54,wy+28);
    ctx.fill();
    progressBar();
  }
}

function drawWorker(w){
  const wx=w.x*TILE + TILE*0.5;
  const wy=w.y*TILE + TILE*0.6;

  // shadow
  ctx.fillStyle="rgba(0,0,0,0.12)";
  ctx.beginPath();
  ctx.ellipse(wx,wy+12,12,6,0,0,Math.PI*2);
  ctx.fill();

  // body
  ctx.fillStyle="#fbbf24";
  ctx.beginPath();
  ctx.arc(wx,wy,10,0,Math.PI*2);
  ctx.fill();

  // helmet
  ctx.fillStyle="#fde68a";
  ctx.beginPath();
  ctx.arc(wx,wy-8,8,0,Math.PI*2);
  ctx.fill();

  // face
  ctx.fillStyle="#0f172a";
  ctx.beginPath();
  ctx.arc(wx-3,wy-2,2,0,Math.PI*2);
  ctx.arc(wx+3,wy-2,2,0,Math.PI*2);
  ctx.fill();
}

function drawAnimal(a){
  const wx=a.x*TILE + TILE*0.5;
  const wy=a.y*TILE + TILE*0.62;

  ctx.fillStyle="rgba(0,0,0,0.12)";
  ctx.beginPath();
  ctx.ellipse(wx,wy+12,12,6,0,0,Math.PI*2);
  ctx.fill();

  if(a.type==="rabbit"){
    ctx.fillStyle="#f8fafc";
    ctx.beginPath();
    ctx.arc(wx,wy,10,0,Math.PI*2);
    ctx.fill();
    ctx.fillStyle="#e2e8f0";
    ctx.fillRect(wx-6,wy-18,4,12);
    ctx.fillRect(wx+2,wy-18,4,12);
  }else{
    ctx.fillStyle="#c084fc";
    ctx.beginPath();
    ctx.arc(wx,wy,12,0,Math.PI*2);
    ctx.fill();
    ctx.fillStyle="#a855f7";
    ctx.fillRect(wx-14,wy-6,6,4);
    ctx.fillRect(wx+8,wy-6,6,4);
  }

  ctx.fillStyle="#0f172a";
  ctx.beginPath();
  ctx.arc(wx-4,wy-2,2,0,Math.PI*2);
  ctx.arc(wx+4,wy-2,2,0,Math.PI*2);
  ctx.fill();
}

function drawAssistant(){
  // AIåŠ©æ‰‹ï¼ˆå¡é€šå°å‹•ç‰©ï¼Œä¸è¦æ–¹æ¡†ï¼‰
  const ax = game.territory.cx*TILE + TILE*0.2;
  const ay = game.territory.cy*TILE - TILE*0.4;

  // shadow
  ctx.fillStyle="rgba(0,0,0,0.12)";
  ctx.beginPath();
  ctx.ellipse(ax+40,ay+78,22,10,0,0,Math.PI*2);
  ctx.fill();

  // body
  ctx.fillStyle="#fb7185";
  ctx.beginPath();
  ctx.arc(ax+40,ay+60,22,0,Math.PI*2);
  ctx.fill();

  // ears
  ctx.fillStyle="#fda4af";
  ctx.beginPath();
  ctx.roundRect(ax+22,ay+20,12,30,10);
  ctx.roundRect(ax+46,ay+20,12,30,10);
  ctx.fill();

  // face
  ctx.fillStyle="#0f172a";
  ctx.beginPath();
  ctx.arc(ax+32,ay+56,3,0,Math.PI*2);
  ctx.arc(ax+48,ay+56,3,0,Math.PI*2);
  ctx.fill();

  // mouth
  ctx.strokeStyle="#0f172a";
  ctx.lineWidth=2;
  ctx.beginPath();
  ctx.arc(ax+40,ay+64,6,0,Math.PI);
  ctx.stroke();

  // Ad Slot flag (é ­é ‚æ——å¹Ÿ)
  ctx.fillStyle="#2563eb";
  ctx.fillRect(ax+55,ay+18,3,22);
  ctx.fillStyle="#60a5fa";
  ctx.beginPath();
  ctx.moveTo(ax+58,ay+18);
  ctx.lineTo(ax+82,ay+24);
  ctx.lineTo(ax+58,ay+30);
  ctx.closePath();
  ctx.fill();

  ctx.fillStyle="#ffffff";
  ctx.font="bold 10px system-ui";
  ctx.fillText("AD",ax+64,ay+27);
}

/* =========================================================
   GAME LOOP
========================================================= */
let lastTime=performance.now();

function updateTopbar(){
  topbar.innerHTML = `
    <div class="chip"><span>ğŸª™</span>é‡‘å¹£ ${game.coins}</div>
    <div class="chip"><span>ğŸŒ²</span>æœ¨ ${game.wood}</div>
    <div class="chip"><span>ğŸª¨</span>çŸ³ ${game.stone}</div>
    <div class="chip"><span>â›“ï¸</span>éµ ${game.iron}</div>
    <div class="chip"><span>ğŸ</span>é£Ÿ ${game.food}</div>
    <div class="chip"><span>ğŸ‘¥</span>äººå£ ${game.pop}</div>
    <div class="chip"><span>ğŸŸ¡</span>AENO ${game.aeno}.${String(game.aenoShard).padStart(2,"0")}</div>
  `;
  btnAuto.textContent = "ğŸ§¸ AIåŠ©æ‰‹è‡ªå‹•æ¨¡å¼ï¼š" + (game.autoAI?"ON":"OFF");
}

function frame(t){
  const dt = Math.min(0.033,(t-lastTime)/1000);
  lastTime=t;

  simulate(dt,false);
  updateUnits(dt);

  // draw
  ctx.save();
  ctx.clearRect(0,0,innerWidth,innerHeight);

  ctx.translate(camX*zoom,camY*zoom);
  ctx.scale(zoom,zoom);

  // tiles
  for(let y=0;y<WORLD_H;y++){
    for(let x=0;x<WORLD_W;x++){
      const type=game.tiles[y*WORLD_W+x].type;
      drawTile(x,y,type);
    }
  }

  // buildings
  for(const b of game.buildings){
    drawBuilding(b);
  }

  // units
  for(const w of game.workers) drawWorker(w);
  for(const a of game.animals) drawAnimal(a);

  // assistant
  drawAssistant();

  ctx.restore();

  updateTopbar();

  requestAnimationFrame(frame);
}
requestAnimationFrame(frame);

/* autosave */
setInterval(()=>saveGame(), 15000);

/* prevent accidental scroll */
document.addEventListener("touchmove",(e)=>{
  if(e.target===canvas) e.preventDefault();
},{passive:false});
</script>
</body>
</html>
