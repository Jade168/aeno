<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
    <title>AENO é‡å­æ½›åŠ› - 3D æ——è‰¦é‚„åŸç‰ˆ</title>
    <style>
        :root { --primary: #3b82f6; --gold: #f59e0b; --grass: #7cfc00; }
        body { margin: 0; background: #ccefff; overflow: hidden; font-family: 'Segoe UI', sans-serif; touch-action: none; }
        
        /* é ‚éƒ¨æ•¸æ“šæ¬„ */
        #hud {
            position: absolute; top: 10px; left: 10px; right: 10px;
            display: flex; gap: 6px; z-index: 100;
        }
        .res-box {
            background: rgba(255,255,255,0.9); padding: 8px 12px; border-radius: 12px;
            font-weight: 900; box-shadow: 0 4px 10px rgba(0,0,0,0.1); font-size: 13px;
            display: flex; align-items: center; gap: 4px; border: 1px solid #fff;
        }

        canvas { display: block; width: 100vw; height: 100vh; }

        /* å»ºç¯‰é¢æ¿ - é‡æ–°è¨­è¨ˆï¼Œä¸é®æ“‹è¦–ç·š */
        #panel {
            position: absolute; bottom: 15px; left: 15px; right: 15px;
            background: rgba(255,255,255,0.85); backdrop-filter: blur(10px);
            border-radius: 20px; padding: 18px; z-index: 200;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); border: 1px solid #fff;
        }
        .grid-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .action-btn {
            border: none; padding: 14px; border-radius: 15px; color: white;
            font-weight: bold; cursor: pointer; transition: 0.2s; font-size: 14px;
        }
        .btn-harvest { background: #3b82f6; grid-column: span 2; }
        .btn-farm { background: #22c55e; }
        .btn-mine { background: #64748b; }
        
        #ai-status {
            position: absolute; top: 65px; left: 15px; right: 15px;
            background: rgba(255,255,255,0.7); padding: 10px; border-radius: 12px;
            font-size: 12px; font-weight: bold; color: #1e40af; z-index: 90;
        }
    </style>
</head>
<body>

<div id="hud">
    <div class="res-box">ğŸ’° <span id="gold">500</span></div>
    <div class="res-box">ğŸªµ <span id="wood">200</span></div>
    <div class="res-box">ğŸª¨ <span id="stone">100</span></div>
</div>

<div id="ai-status">Aenko: çˆ¸çˆ¸ï¼Œ3D æ·±åº¦å¼•æ“å·²ä¿®å¾©ï¼é»æ“Šåœ°åœ–é¸æ“‡åœ°å¡Šï¼Œå†æŒ‰æŒ‰éˆ•å»ºé€ ã€‚</div>

<canvas id="gameCanvas"></canvas>

<div id="panel">
    <div style="font-weight:bold; color:#334155;">ğŸ“ é¸ä¸­åº§æ¨™: <span id="coord">10, 10</span></div>
    <div class="grid-layout">
        <button class="action-btn btn-harvest" onclick="doHarvest()">â›ï¸ æ‰‹å‹•æ¡é›† (ç²å–é‡‘å¹£/æœ¨æ)</button>
        <button class="action-btn btn-farm" onclick="doBuild('farm')">ğŸŒ¾ è“‹è¾²ç”°<br><small>100é‡‘ | 50æœ¨</small></button>
        <button class="action-btn btn-mine" onclick="doBuild('mine')">âš’ï¸ è“‹ç¤¦å ´<br><small>200é‡‘ | 80çŸ³</small></button>
    </div>
</div>

<script>
const cvs = document.getElementById('gameCanvas');
const ctx = cvs.getContext('2d');
const TILE_W = 64; // å¯¬åº¦
const TILE_H = 32; // é«˜åº¦ (1:2 æ¯”ä¾‹æ˜¯ Isometric æ¨™æº–)
const MAP_SIZE = 15;

let state = {
    gold: 500, wood: 200, stone: 100,
    selected: { x: 7, y: 7 },
    buildings: [], // {x, y, type}
    map: []
};

// åˆå§‹åŒ–åœ°åœ–åœ°å½¢
function initMap() {
    for (let y = 0; y < MAP_SIZE; y++) {
        state.map[y] = [];
        for (let x = 0; x < MAP_SIZE; x++) {
            let type = 'grass';
            if (Math.random() > 0.8) type = 'forest';
            if (Math.random() > 0.92) type = 'rock';
            state.map[y][x] = type;
        }
    }
}

// åæ¨™è½‰æ›ï¼šåœ°åœ–(x,y) -> è¢å¹•(x,y)
function getPos(tx, ty) {
    return {
        x: (tx - ty) * (TILE_W / 2) + cvs.width / 2,
        y: (tx + ty) * (TILE_H / 2) + cvs.height / 4
    };
}

// ç¹ªè£½å¾ªç’°
function draw() {
    ctx.clearRect(0, 0, cvs.width, cvs.height);
    
    // æ¸²æŸ“åœ°å¡Š
    for (let y = 0; y < MAP_SIZE; y++) {
        for (let x = 0; x < MAP_SIZE; x++) {
            const p = getPos(x, y);
            const isSel = (state.selected.x === x && state.selected.y === y);
            
            drawTile(p.x, p.y, isSel ? '#3b82f6' : getTileColor(state.map[y][x]));
            
            // ç¹ªè£½è£é£¾ï¼ˆæ£®æ—/å²©çŸ³ï¼‰
            if (state.map[y][x] === 'forest') drawTree(p.x, p.y);
            if (state.map[y][x] === 'rock') drawRock(p.x, p.y);
            
            // ç¹ªè£½å»ºç¯‰
            const b = state.buildings.find(b => b.x === x && b.y === y);
            if (b) drawBuilding(p.x, p.y, b.type);
        }
    }
    requestAnimationFrame(draw);
}

function drawTile(x, y, color) {
    ctx.beginPath();
    ctx.moveTo(x, y);
    ctx.lineTo(x + TILE_W/2, y + TILE_H/2);
    ctx.lineTo(x, y + TILE_H);
    ctx.lineTo(x - TILE_W/2, y + TILE_H/2);
    ctx.closePath();
    ctx.fillStyle = color;
    ctx.fill();
    ctx.strokeStyle = 'rgba(255,255,255,0.3)';
    ctx.stroke();
}

function drawTree(x, y) {
    ctx.fillStyle = '#15803d';
    ctx.beginPath(); ctx.arc(x, y+5, 8, 0, Math.PI*2); ctx.fill();
    ctx.fillStyle = '#78350f'; ctx.fillRect(x-2, y+10, 4, 6);
}

function drawRock(x, y) {
    ctx.fillStyle = '#94a3b8';
    ctx.beginPath(); ctx.moveTo(x-10, y+10); ctx.lineTo(x, y-5); ctx.lineTo(x+10, y+10); ctx.fill();
}

function drawBuilding(x, y, type) {
    // ç¹ªè£½å…·æœ‰é«˜åº¦æ„Ÿçš„ç«‹é«”å»ºç¯‰
    ctx.fillStyle = type === 'farm' ? '#f59e0b' : '#475569';
    ctx.beginPath();
    ctx.moveTo(x-12, y+10); ctx.lineTo(x+12, y+10); 
    ctx.lineTo(x+12, y-10); ctx.lineTo(x-12, y-10);
    ctx.closePath(); ctx.fill();
    // å±‹é ‚
    ctx.fillStyle = type === 'farm' ? '#fbbf24' : '#1e293b';
    ctx.beginPath();
    ctx.moveTo(x-12, y-10); ctx.lineTo(x, y-22); ctx.lineTo(x+12, y-10);
    ctx.closePath(); ctx.fill();
}

// é»æ“Šåˆ¤å®šï¼šè¢å¹• -> åœ°åœ–åæ¨™
cvs.addEventListener('touchstart', (e) => {
    const rect = cvs.getBoundingClientRect();
    const mx = e.touches[0].clientX - rect.left - cvs.width / 2;
    const my = e.touches[0].clientY - rect.top - cvs.height / 4;
    
    // Isometric åå‘çŸ©é™£ç®—æ³•
    const tx = Math.floor((my / (TILE_H / 2) + mx / (TILE_W / 2)) / 2);
    const ty = Math.floor((my / (TILE_H / 2) - mx / (TILE_W / 2)) / 2);
    
    if (tx >= 0 && tx < MAP_SIZE && ty >= 0 && ty < MAP_SIZE) {
        state.selected = { x: tx, y: ty };
        document.getElementById('coord').innerText = `${tx}, ${ty}`;
    }
});

// éŠæˆ²åŠŸèƒ½
function doHarvest() {
    state.gold += 5;
    state.wood += 2;
    updateUI();
    msg("æ¡é›†æˆåŠŸï¼é‡‘å¹£+5, æœ¨æ+2");
}

function doBuild(type) {
    const cost = type === 'farm' ? {g:100, w:50} : {g:200, s:80};
    if (state.gold >= cost.g && (cost.w ? state.wood >= cost.w : true)) {
        if (state.buildings.some(b => b.x === state.selected.x && b.y === state.selected.y)) {
            msg("é€™è£¡å·²ç¶“æœ‰å»ºç¯‰äº†ï¼"); return;
        }
        state.gold -= cost.g; if(cost.w) state.wood -= cost.w;
        state.buildings.push({ x: state.selected.x, y: state.selected.y, type });
        updateUI();
        msg(`æˆåŠŸå»ºé€ äº† ${type === 'farm' ? 'è¾²ç”°' : 'ç¤¦å ´'}ï¼`);
    } else {
        msg("è³‡æºä¸è¶³ï¼Œç„¡æ³•å»ºé€ ï¼");
    }
}

// è‡ªå‹•ç”¢è³‡æºæ ¸å¿ƒ
setInterval(() => {
    state.buildings.forEach(b => {
        if (b.type === 'farm') state.gold += 1;
        if (b.type === 'mine') state.gold += 2;
    });
    updateUI();
}, 1000);

function getTileColor(t) {
    return t === 'forest' ? '#4ade80' : (t === 'rock' ? '#cbd5e1' : '#b9fbc0');
}
function updateUI() {
    document.getElementById('gold').innerText = Math.floor(state.gold);
    document.getElementById('wood').innerText = Math.floor(state.wood);
    document.getElementById('stone').innerText = Math.floor(state.stone);
}
function msg(m) { document.getElementById('ai-status').innerText = `Aenko: ${m}`; }

// åˆå§‹åŒ–ä¸¦åŸ·è¡Œ
cvs.width = window.innerWidth; cvs.height = window.innerHeight;
initMap();
updateUI();
draw();
</script>
</body>
</html>
