<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
  <title>AENO - Cartoon Empire Builder</title>
  <style>
    :root{
      --ui-bg: rgba(255,255,255,0.92);
      --ui-border: rgba(0,0,0,0.15);
      --ui-shadow: 0 8px 30px rgba(0,0,0,0.18);
      --text: #222;
      --soft: rgba(0,0,0,0.07);
      --btn: #ffffff;
      --btn2: #f4f6ff;
      --accent: #4c6fff;
      --danger: #ff4c4c;
      --good: #33c97a;
      --gold: #ffcc4d;
      --aeno: #8b5cf6;
    }

    *{box-sizing:border-box;}
    html, body{
      margin:0;
      padding:0;
      width:100%;
      height:100%;
      overflow:hidden;
      background: linear-gradient(180deg, #c9f0ff 0%, #d6ffdd 40%, #f2ffd0 100%);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      color:var(--text);
    }

    /* Full screen game container */
    #app{
      position:relative;
      width:100%;
      height:100%;
      overflow:hidden;
    }

    canvas{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      touch-action:none;
    }

    /* TOP HUD */
    #hud{
      position:absolute;
      top:10px;
      left:10px;
      right:10px;
      display:flex;
      gap:10px;
      z-index:20;
      align-items:flex-start;
      justify-content:space-between;
      pointer-events:none;
    }

    .hud-card{
      pointer-events:auto;
      background:var(--ui-bg);
      border:2px solid var(--ui-border);
      border-radius:18px;
      box-shadow:var(--ui-shadow);
      padding:10px 12px;
      backdrop-filter: blur(10px);
    }

    #resPanel{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      max-width:75%;
      align-items:center;
    }

    .res{
      display:flex;
      align-items:center;
      gap:6px;
      background: rgba(0,0,0,0.05);
      border-radius:14px;
      padding:6px 10px;
      font-weight:700;
      font-size:13px;
    }

    .dot{
      width:12px;
      height:12px;
      border-radius:50%;
      background:#999;
      border:2px solid rgba(0,0,0,0.15);
    }

    .dot.wood{background:#a16207;}
    .dot.stone{background:#6b7280;}
    .dot.food{background:#22c55e;}
    .dot.energy{background:#0ea5e9;}
    .dot.coin{background:var(--gold);}
    .dot.aeno{background:var(--aeno);}

    #statusPanel{
      min-width:160px;
      display:flex;
      flex-direction:column;
      gap:6px;
      font-weight:800;
      font-size:13px;
    }

    .bar{
      width:100%;
      height:10px;
      background:rgba(0,0,0,0.1);
      border-radius:999px;
      overflow:hidden;
      border:1px solid rgba(0,0,0,0.15);
    }
    .bar > div{
      height:100%;
      width:100%;
      background:linear-gradient(90deg, #34d399, #22c55e);
      border-radius:999px;
      transition: width 0.25s ease;
    }

    .bar.danger > div{
      background:linear-gradient(90deg, #ff6b6b, #ff2d2d);
    }

    /* Bottom Menu */
    #bottomMenu{
      position:absolute;
      left:12px;
      right:12px;
      bottom:12px;
      z-index:30;
      display:flex;
      gap:10px;
      justify-content:space-between;
      pointer-events:none;
    }

    .menuBtn{
      pointer-events:auto;
      flex:1;
      background:var(--ui-bg);
      border:2px solid var(--ui-border);
      border-radius:18px;
      box-shadow:var(--ui-shadow);
      padding:12px 10px;
      text-align:center;
      font-weight:900;
      font-size:14px;
      user-select:none;
      cursor:pointer;
      transition: transform .08s ease;
    }

    .menuBtn:active{
      transform: scale(0.97);
    }

    /* Side Panel */
    #panel{
      position:absolute;
      top:72px;
      left:12px;
      right:12px;
      bottom:90px;
      z-index:25;
      background:var(--ui-bg);
      border:2px solid var(--ui-border);
      border-radius:22px;
      box-shadow:var(--ui-shadow);
      padding:12px;
      overflow:auto;
      display:none;
      backdrop-filter: blur(10px);
    }

    #panel h2{
      margin:0 0 8px 0;
      font-size:18px;
      letter-spacing:0.3px;
    }

    .closeBtn{
      float:right;
      background:rgba(0,0,0,0.07);
      border:2px solid rgba(0,0,0,0.1);
      border-radius:14px;
      padding:6px 10px;
      font-weight:900;
      cursor:pointer;
      user-select:none;
    }

    .gridList{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }

    .card{
      background:rgba(255,255,255,0.8);
      border:2px solid rgba(0,0,0,0.12);
      border-radius:18px;
      padding:10px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.12);
    }

    .card .title{
      font-weight:1000;
      font-size:15px;
      margin-bottom:4px;
    }

    .card .desc{
      font-size:12px;
      opacity:0.8;
      line-height:1.25;
      margin-bottom:8px;
    }

    .row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      font-size:12px;
      font-weight:800;
      margin:4px 0;
    }

    .buyBtn{
      width:100%;
      padding:10px;
      border-radius:16px;
      border:2px solid rgba(0,0,0,0.12);
      background: linear-gradient(180deg, #ffffff, #f2f6ff);
      font-weight:1000;
      cursor:pointer;
      user-select:none;
    }

    .buyBtn:active{
      transform: scale(0.985);
    }

    .buyBtn.disabled{
      opacity:0.45;
      pointer-events:none;
    }

    /* Tooltip / Floating */
    .toast{
      position:absolute;
      z-index:50;
      left:50%;
      transform:translateX(-50%);
      bottom:120px;
      background:rgba(0,0,0,0.7);
      color:white;
      padding:10px 14px;
      border-radius:999px;
      font-weight:900;
      font-size:13px;
      opacity:0;
      transition: opacity 0.25s ease, transform 0.25s ease;
      pointer-events:none;
    }

    .toast.show{
      opacity:1;
      transform:translateX(-50%) translateY(-8px);
    }

    /* Cartoon assistant bubble */
    #assistant{
      position:absolute;
      right:12px;
      bottom:110px;
      width:90px;
      height:90px;
      z-index:40;
      pointer-events:auto;
      user-select:none;
      cursor:pointer;
    }

    #assistant .body{
      width:100%;
      height:100%;
      border-radius:26px;
      background:linear-gradient(180deg, #ffffff, #ffe8f5);
      border:3px solid rgba(0,0,0,0.15);
      box-shadow: 0 10px 30px rgba(0,0,0,0.22);
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
      overflow:hidden;
      animation: floaty 2.2s ease-in-out infinite;
    }

    @keyframes floaty{
      0%,100%{transform:translateY(0px);}
      50%{transform:translateY(-6px);}
    }

    .face{
      width:54px;
      height:54px;
      border-radius:50%;
      background:linear-gradient(180deg, #fffbeb, #ffd1f1);
      border:3px solid rgba(0,0,0,0.12);
      position:relative;
    }

    .eye{
      width:8px;
      height:10px;
      background:#222;
      border-radius:999px;
      position:absolute;
      top:18px;
      animation: blink 4s infinite;
    }
    .eye.left{left:14px;}
    .eye.right{right:14px;}

    @keyframes blink{
      0%,95%,100%{transform:scaleY(1);}
      96%,98%{transform:scaleY(0.1);}
    }

    .mouth{
      width:16px;
      height:10px;
      border-bottom:4px solid rgba(0,0,0,0.7);
      border-radius:0 0 999px 999px;
      position:absolute;
      left:50%;
      transform:translateX(-50%);
      top:30px;
    }

    #assistantName{
      position:absolute;
      top:-20px;
      right:0;
      background:rgba(255,255,255,0.9);
      border:2px solid rgba(0,0,0,0.12);
      padding:4px 8px;
      border-radius:999px;
      font-weight:1000;
      font-size:12px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.18);
    }

    /* small hint */
    #hint{
      position:absolute;
      left:12px;
      bottom:110px;
      z-index:40;
      background:rgba(255,255,255,0.9);
      border:2px solid rgba(0,0,0,0.12);
      border-radius:16px;
      padding:10px 12px;
      font-size:12px;
      font-weight:900;
      box-shadow:var(--ui-shadow);
      max-width:55%;
      line-height:1.25;
      opacity:0.95;
    }

    /* Responsive for small phones */
    @media (max-width:380px){
      .menuBtn{font-size:12px;padding:10px 8px;}
      #assistant{width:80px;height:80px;}
      #panel{top:66px;}
    }
  </style>
</head>
<body>
<div id="app">
  <canvas id="game"></canvas>

  <div id="hud">
    <div class="hud-card" id="resPanel">
      <div class="res"><span class="dot wood"></span>æœ¨ <span id="wood">0</span></div>
      <div class="res"><span class="dot stone"></span>çŸ³ <span id="stone">0</span></div>
      <div class="res"><span class="dot food"></span>é£Ÿ <span id="food">0</span></div>
      <div class="res"><span class="dot energy"></span>èƒ½ <span id="energy">0</span></div>
      <div class="res"><span class="dot coin"></span>é‡‘ <span id="coin">0</span></div>
      <div class="res"><span class="dot aeno"></span>AENO <span id="aeno">0</span></div>
    </div>

    <div class="hud-card" id="statusPanel">
      <div style="display:flex;justify-content:space-between;">
        <span>åŸç‰†</span>
        <span id="wallText">100%</span>
      </div>
      <div class="bar" id="wallBar"><div></div></div>

      <div style="display:flex;justify-content:space-between;margin-top:6px;">
        <span>äººå£</span>
        <span id="popText">0</span>
      </div>
    </div>
  </div>

  <div id="panel"></div>

  <div id="bottomMenu">
    <div class="menuBtn" id="btnBuild">ğŸ— å»ºè¨­</div>
    <div class="menuBtn" id="btnTech">ğŸ§  ç§‘æŠ€</div>
    <div class="menuBtn" id="btnRobot">ğŸ¤– æ©Ÿå™¨äºº</div>
    <div class="menuBtn" id="btnHunt">ğŸ¾ é‡å¤–</div>
  </div>

  <div id="assistant">
    <div id="assistantName">Lupinus</div>
    <div class="body">
      <div class="face">
        <div class="eye left"></div>
        <div class="eye right"></div>
        <div class="mouth"></div>
      </div>
    </div>
  </div>

  <div id="hint">
    ğŸ‘‰ æ‹–å‹•åœ°åœ–ç§»å‹•<br/>
    ğŸ‘‰ é›™æŒ‡ç¸®æ”¾ / æ»¾è¼ªç¸®æ”¾<br/>
    ğŸ‘‰ é»ã€Œå»ºè¨­ã€æ”¾ç½®å»ºç¯‰
  </div>

  <div class="toast" id="toast">OK</div>
</div>

<script>
/* ===========================================================
   AENO Cartoon Empire Builder Demo (Offline)
   - 30x30 tile world
   - Drag / zoom
   - Place buildings
   - Upgrade buildings
   - Resource generation
   - Beast tide event (wall drops to 60% then retreats)
   =========================================================== */

(() => {
  const canvas = document.getElementById("game");
  const ctx = canvas.getContext("2d");

  function resize(){
    canvas.width = window.innerWidth * devicePixelRatio;
    canvas.height = window.innerHeight * devicePixelRatio;
  }
  window.addEventListener("resize", resize);
  resize();

  // UI elements
  const uiWood = document.getElementById("wood");
  const uiStone = document.getElementById("stone");
  const uiFood = document.getElementById("food");
  const uiEnergy = document.getElementById("energy");
  const uiCoin = document.getElementById("coin");
  const uiAeno = document.getElementById("aeno");
  const uiWallText = document.getElementById("wallText");
  const uiWallBar = document.querySelector("#wallBar > div");
  const uiPopText = document.getElementById("popText");
  const toast = document.getElementById("toast");
  const panel = document.getElementById("panel");

  const GRID_SIZE = 30;
  const TILE = 42; // base tile size (before zoom)

  // Camera
  let camX = GRID_SIZE * TILE * 0.5;
  let camY = GRID_SIZE * TILE * 0.5;
  let zoom = 1.0;

  // Dragging
  let isDragging = false;
  let lastX = 0;
  let lastY = 0;

  // Pinch zoom
  let pinchDist = null;

  // Resources
  const state = {
    wood: 80,
    stone: 60,
    food: 40,
    energy: 20,
    coin: 50,
    aeno: 0,

    wall: 100, // %
    population: 0,

    beastTideActive: false,
    beastTideTimer: 0,

    selectedBuildType: null,
    placingMode: false,
    selectedTile: null,

    tick: 0,
  };

  // Tile map
  // type: grass, water, mountain, forest
  const world = [];
  for(let y=0;y<GRID_SIZE;y++){
    const row = [];
    for(let x=0;x<GRID_SIZE;x++){
      const r = Math.random();
      let type = "grass";
      if(r < 0.07) type = "water";
      else if(r < 0.12) type = "mountain";
      else if(r < 0.25) type = "forest";
      row.push({
        type,
        building: null
      });
    }
    world.push(row);
  }

  // Make a central safe zone
  for(let y=13;y<=16;y++){
    for(let x=13;x<=16;x++){
      world[y][x].type = "grass";
    }
  }

  // Building definitions
  const BUILDINGS = {
    lumber: {
      name: "ä¼æœ¨å ´",
      icon: "ğŸŒ²",
      desc: "æ¯ç§’ç”¢æœ¨æã€‚é©åˆæ£®æ—æ—ã€‚",
      cost: { wood: 15, stone: 5, coin: 5 },
      baseProduction: { wood: 2 },
      maxLevel: 10
    },
    quarry: {
      name: "æ¡çŸ³å ´",
      icon: "ğŸª¨",
      desc: "æ¯ç§’ç”¢çŸ³é ­ã€‚é©åˆå±±é™„è¿‘ã€‚",
      cost: { wood: 10, stone: 10, coin: 5 },
      baseProduction: { stone: 2 },
      maxLevel: 10
    },
    farm: {
      name: "è¾²ç”°",
      icon: "ğŸŒ¾",
      desc: "æ¯ç§’ç”¢é£Ÿç‰©ã€‚äººå£éœ€è¦é£Ÿç‰©ã€‚",
      cost: { wood: 12, stone: 4, coin: 4 },
      baseProduction: { food: 2 },
      maxLevel: 10
    },
    house: {
      name: "æ°‘æˆ¿",
      icon: "ğŸ ",
      desc: "å¢åŠ äººå£ä¸Šé™ï¼Œäººå£æœƒè‡ªå‹•æ…¢æ…¢å¢åŠ ã€‚",
      cost: { wood: 20, stone: 8, coin: 10 },
      baseProduction: { },
      maxLevel: 10
    },
    factory: {
      name: "å·¥å» ",
      icon: "ğŸ­",
      desc: "æ¶ˆè€—èƒ½é‡ï¼Œç”Ÿç”¢æ©Ÿå™¨äººï¼ˆæœªä¾†å¯æ´¾å»æ˜Ÿçƒï¼‰ã€‚",
      cost: { wood: 25, stone: 20, coin: 20 },
      baseProduction: { coin: 1 },
      maxLevel: 10
    },
    lab: {
      name: "ç§‘ç ”ä¸­å¿ƒ",
      icon: "ğŸ§ ",
      desc: "ç§‘æŠ€é»æ•¸ï¼ˆæš«æ™‚ç”¨èƒ½é‡+é‡‘å¹£æ¨¡æ“¬ï¼‰ã€‚",
      cost: { wood: 30, stone: 25, coin: 25 },
      baseProduction: { energy: 1 },
      maxLevel: 10
    },
    mine: {
      name: "æ™¶é«”ç¤¦å‘",
      icon: "ğŸ’",
      desc: "æ¥µä½æ©Ÿç‡ç”¢å‡º AENOï¼ˆDemoç‰ˆï¼‰ã€‚",
      cost: { wood: 35, stone: 30, coin: 30 },
      baseProduction: { stone: 1 },
      maxLevel: 10
    }
  };

  function showToast(msg){
    toast.textContent = msg;
    toast.classList.add("show");
    setTimeout(() => toast.classList.remove("show"), 1200);
  }

  function clamp(v, a, b){
    return Math.max(a, Math.min(b, v));
  }

  function format(n){
    if(n < 1000) return Math.floor(n);
    if(n < 1000000) return (n/1000).toFixed(1)+"K";
    return (n/1000000).toFixed(2)+"M";
  }

  function canAfford(cost){
    for(const k in cost){
      if(state[k] < cost[k]) return false;
    }
    return true;
  }

  function pay(cost){
    for(const k in cost){
      state[k] -= cost[k];
    }
  }

  function tileToWorld(x, y){
    return { wx: x*TILE, wy: y*TILE };
  }

  function screenToWorld(px, py){
    const x = (px*devicePixelRatio)/zoom + camX - (canvas.width/(2*zoom));
    const y = (py*devicePixelRatio)/zoom + camY - (canvas.height/(2*zoom));
    return { x, y };
  }

  function worldToTile(wx, wy){
    return {
      tx: Math.floor(wx / TILE),
      ty: Math.floor(wy / TILE)
    };
  }

  function isInside(tx, ty){
    return tx>=0 && ty>=0 && tx<GRID_SIZE && ty<GRID_SIZE;
  }

  // Build placement rule
  function canPlaceBuilding(tx, ty, type){
    if(!isInside(tx,ty)) return false;
    const tile = world[ty][tx];
    if(tile.building) return false;
    if(tile.type === "water") return false;

    // simple theme rules
    if(type === "lumber" && tile.type !== "forest") return false;
    if(type === "quarry" && tile.type !== "mountain") return false;
    if(type === "mine" && tile.type !== "mountain") return false;

    return true;
  }

  function placeBuilding(tx, ty, bType){
    const def = BUILDINGS[bType];
    if(!def) return;

    if(!canPlaceBuilding(tx, ty, bType)){
      showToast("âŒ ä¸èƒ½æ”¾ç½®ï¼ˆåœ°å½¢ä¸é©åˆï¼‰");
      return;
    }

    if(!canAfford(def.cost)){
      showToast("âŒ è³‡æºä¸è¶³");
      return;
    }

    pay(def.cost);

    world[ty][tx].building = {
      type: bType,
      level: 1,
      buildProgress: 0,
      built: false,
      hp: 100
    };

    showToast("ğŸ— é–‹å§‹å»ºé€  " + def.name);
  }

  function upgradeBuilding(tx, ty){
    const tile = world[ty][tx];
    if(!tile.building) return;

    const b = tile.building;
    const def = BUILDINGS[b.type];
    if(!def) return;

    if(!b.built){
      showToast("â³ å»ºç¯‰æœªå®Œæˆ");
      return;
    }

    if(b.level >= def.maxLevel){
      showToast("â­ å·²é”æœ€é«˜ç­‰ç´š");
      return;
    }

    const cost = {
      wood: Math.floor(def.cost.wood * (0.7 + b.level*0.35)),
      stone: Math.floor(def.cost.stone * (0.7 + b.level*0.35)),
      coin: Math.floor(def.cost.coin * (0.7 + b.level*0.35)),
    };

    if(!canAfford(cost)){
      showToast("âŒ å‡ç´šè³‡æºä¸è¶³");
      return;
    }

    pay(cost);
    b.level++;
    showToast("â¬† å‡ç´šæˆåŠŸ Lv." + b.level);
  }

  // Panel UI
  function openPanel(html){
    panel.innerHTML = html;
    panel.style.display = "block";
  }

  function closePanel(){
    panel.style.display = "none";
    panel.innerHTML = "";
  }

  function buildMenu(){
    const list = Object.keys(BUILDINGS).map(key => {
      const b = BUILDINGS[key];
      const afford = canAfford(b.cost);
      return `
        <div class="card">
          <div class="title">${b.icon} ${b.name}</div>
          <div class="desc">${b.desc}</div>
          <div class="row"><span>æˆæœ¬</span><span>æœ¨${b.cost.wood} çŸ³${b.cost.stone} é‡‘${b.cost.coin}</span></div>
          <button class="buyBtn ${afford ? "" : "disabled"}" data-build="${key}">
            ${afford ? "é¸æ“‡æ”¾ç½®" : "è³‡æºä¸è¶³"}
          </button>
        </div>
      `;
    }).join("");

    openPanel(`
      <div>
        <div class="closeBtn" id="closePanel">é—œé–‰ âœ–</div>
        <h2>ğŸ— å»ºè¨­æ¸…å–®</h2>
        <div style="font-size:12px;font-weight:900;opacity:0.85;">
          é¸æ“‡å»ºç¯‰å¾Œï¼Œé»åœ°åœ–æ”¾ç½®ã€‚<br/>
          ä¼æœ¨å ´å¿…é ˆæ”¾æ£®æ—ï¼Œæ¡çŸ³å ´å¿…é ˆæ”¾å±±ã€‚
        </div>
        <div class="gridList">${list}</div>
      </div>
    `);

    document.getElementById("closePanel").onclick = closePanel;
    document.querySelectorAll("[data-build]").forEach(btn => {
      btn.onclick = () => {
        state.selectedBuildType = btn.getAttribute("data-build");
        state.placingMode = true;
        closePanel();
        showToast("ğŸŸ© è«‹é»é¸åœ°åœ–æ”¾ç½®å»ºç¯‰");
      };
    });
  }

  function techMenu(){
    openPanel(`
      <div>
        <div class="closeBtn" id="closePanel">é—œé–‰ âœ–</div>
        <h2>ğŸ§  ç§‘æŠ€æ¨¹ï¼ˆDemoï¼‰</h2>

        <div class="card">
          <div class="title">âš¡ èƒ½é‡æ•ˆç‡ Lv.1</div>
          <div class="desc">æå‡èƒ½é‡ç”¢å‡ºé€Ÿåº¦ï¼ˆDemoå…ˆé¡¯ç¤ºUIï¼‰</div>
          <div class="row"><span>æˆæœ¬</span><span>é‡‘ 60</span></div>
          <button class="buyBtn" id="buyTech1">ç ”ç©¶</button>
        </div>

        <div class="card">
          <div class="title">ğŸ­ å·¥æ¥­åŒ– Lv.1</div>
          <div class="desc">å·¥å» æ•ˆç‡æå‡ï¼ˆDemoå…ˆé¡¯ç¤ºUIï¼‰</div>
          <div class="row"><span>æˆæœ¬</span><span>æœ¨ 80 çŸ³ 50 é‡‘ 80</span></div>
          <button class="buyBtn" id="buyTech2">ç ”ç©¶</button>
        </div>

        <div class="card">
          <div class="title">ğŸ’ æ™¶é«”æ¢æ¸¬ Lv.1</div>
          <div class="desc">æå‡ AENO å‡ºç¾æ©Ÿç‡ï¼ˆDemoå…ˆé¡¯ç¤ºUIï¼‰</div>
          <div class="row"><span>æˆæœ¬</span><span>é‡‘ 120</span></div>
          <button class="buyBtn" id="buyTech3">ç ”ç©¶</button>
        </div>
      </div>
    `);

    document.getElementById("closePanel").onclick = closePanel;

    document.getElementById("buyTech1").onclick = () => {
      if(state.coin < 60) return showToast("âŒ é‡‘å¹£ä¸è¶³");
      state.coin -= 60;
      showToast("âœ… ç§‘æŠ€å®Œæˆï¼šèƒ½é‡æ•ˆç‡");
    };

    document.getElementById("buyTech2").onclick = () => {
      if(state.wood < 80 || state.stone < 50 || state.coin < 80) return showToast("âŒ è³‡æºä¸è¶³");
      state.wood -= 80; state.stone -= 50; state.coin -= 80;
      showToast("âœ… ç§‘æŠ€å®Œæˆï¼šå·¥æ¥­åŒ–");
    };

    document.getElementById("buyTech3").onclick = () => {
      if(state.coin < 120) return showToast("âŒ é‡‘å¹£ä¸è¶³");
      state.coin -= 120;
      showToast("âœ… ç§‘æŠ€å®Œæˆï¼šæ™¶é«”æ¢æ¸¬");
    };
  }

  function robotMenu(){
    openPanel(`
      <div>
        <div class="closeBtn" id="closePanel">é—œé–‰ âœ–</div>
        <h2>ğŸ¤– æ©Ÿå™¨äººä¸­å¿ƒï¼ˆDemoï¼‰</h2>

        <div class="card">
          <div class="title">ğŸš€ æ´¾é£æ¢ç´¢</div>
          <div class="desc">
            ä½ å¯ä»¥æ´¾æ©Ÿå™¨äººå»å…¶ä»–æ˜Ÿçƒæ¡è³‡æºã€‚<br/>
            ï¼ˆDemo å…ˆé¡¯ç¤ºåŠŸèƒ½UIï¼‰
          </div>
          <div class="row"><span>æˆæœ¬</span><span>èƒ½ 10 é‡‘ 20</span></div>
          <button class="buyBtn" id="dispatchBot">æ´¾é£</button>
        </div>

        <div class="card">
          <div class="title">ğŸ›¡ é˜²å®ˆæ©Ÿå™¨äºº</div>
          <div class="desc">ç¸æ½®ä¾†è¥²æ™‚å¯æ¸›å°‘åŸç‰†æå¤±ï¼ˆDemoï¼‰</div>
          <div class="row"><span>æˆæœ¬</span><span>æœ¨ 30 çŸ³ 30 é‡‘ 40</span></div>
          <button class="buyBtn" id="defBot">è£½é€ </button>
        </div>
      </div>
    `);

    document.getElementById("closePanel").onclick = closePanel;

    document.getElementById("dispatchBot").onclick = () => {
      if(state.energy < 10 || state.coin < 20) return showToast("âŒ è³‡æºä¸è¶³");
      state.energy -= 10;
      state.coin -= 20;

      // reward
      const gainWood = 15 + Math.floor(Math.random()*20);
      const gainStone = 10 + Math.floor(Math.random()*15);
      const gainCoin = 5 + Math.floor(Math.random()*10);

      state.wood += gainWood;
      state.stone += gainStone;
      state.coin += gainCoin;

      // small chance aeno
      if(Math.random() < 0.04){
        state.aeno += 1;
        showToast("ğŸ’ æ©Ÿå™¨äººå¸¶å›ï¼šAENO +1");
      }else{
        showToast("ğŸ¤– æ¢ç´¢æˆåŠŸï¼šæœ¨+"+gainWood+" çŸ³+"+gainStone+" é‡‘+"+gainCoin);
      }
    };

    document.getElementById("defBot").onclick = () => {
      if(state.wood < 30 || state.stone < 30 || state.coin < 40) return showToast("âŒ è³‡æºä¸è¶³");
      state.wood -= 30;
      state.stone -= 30;
      state.coin -= 40;
      showToast("ğŸ›¡ é˜²å®ˆæ©Ÿå™¨äººå·²éƒ¨ç½²ï¼ˆDemoï¼‰");
    };
  }

  function huntMenu(){
    openPanel(`
      <div>
        <div class="closeBtn" id="closePanel">é—œé–‰ âœ–</div>
        <h2>ğŸ¾ é‡å¤–æ¢ç´¢ï¼ˆDemoï¼‰</h2>

        <div class="card">
          <div class="title">ğŸ— æ‰“é‡ç‹©çµ</div>
          <div class="desc">
            é»æ“Šå¾Œæœƒå‡ºç¾é‡ç¸å±é«”ã€‚<br/>
            ä½ å¿…é ˆæ‰‹å‹•æ”¶å–æ‰æœ‰æ‰è½ã€‚
          </div>
          <div class="row"><span>å†·å»</span><span>10 ç§’</span></div>
          <button class="buyBtn" id="huntBtn">å‡ºå‹•</button>
        </div>

        <div class="card">
          <div class="title">ğŸŒŠ ç¸æ½®äº‹ä»¶</div>
          <div class="desc">
            ç¸æ½®æœƒæ”»æ“ŠåŸç‰†ï¼Œä½†ä¸æœƒæ‘§æ¯€ã€‚<br/>
            ç•¶åŸç‰†é™åˆ°ç´„ 60% æœƒè‡ªå‹•é€€æ½®ã€‚
          </div>
          <div class="row"><span>è§¸ç™¼</span><span>ç«‹å³</span></div>
          <button class="buyBtn" id="tideBtn">å¼•ç™¼ç¸æ½®</button>
        </div>
      </div>
    `);

    document.getElementById("closePanel").onclick = closePanel;

    document.getElementById("huntBtn").onclick = () => {
      closePanel();
      spawnLoot("é‡ç¸å±é«”", 2);
      showToast("ğŸ¾ é‡ç¸å·²è¢«æ“Šå€’ï¼Œè«‹é»æ“Šæ”¶å–");
    };

    document.getElementById("tideBtn").onclick = () => {
      closePanel();
      startBeastTide();
    };
  }

  // Buttons
  document.getElementById("btnBuild").onclick = buildMenu;
  document.getElementById("btnTech").onclick = techMenu;
  document.getElementById("btnRobot").onclick = robotMenu;
  document.getElementById("btnHunt").onclick = huntMenu;

  document.getElementById("assistant").onclick = () => {
    const lines = [
      "æˆ‘ä¿‚ Lupinus ğŸ¾ ä½ çš„AIåŠ©æ‰‹ï¼",
      "å»ºè¨­è¶Šå¤šï¼Œè³‡æºè¶Šå¿«ï¼",
      "ç¸æ½®æœƒæ‰è½ç¨€æœ‰è³‡æºï¼",
      "ç¤¦å‘æœ‰æ©Ÿæœƒç”¢å‡º AENO ğŸ’",
      "æœªä¾†ä½ å¯ç§»æ°‘é»‘æ´ ğŸŒŒ"
    ];
    showToast(lines[Math.floor(Math.random()*lines.length)]);
  };

  // Loot objects
  const loots = [];

  function spawnLoot(label, tier){
    // spawn near center of camera
    const wx = camX + (Math.random()*300-150);
    const wy = camY + (Math.random()*300-150);

    loots.push({
      wx, wy,
      label,
      tier,
      life: 25,
      collected: false
    });
  }

  function collectLoot(loot){
    if(loot.collected) return;
    loot.collected = true;

    const base = 10 + loot.tier*10;
    const foodGain = base + Math.floor(Math.random()*20);
    const coinGain = 5 + Math.floor(Math.random()*10);

    state.food += foodGain;
    state.coin += coinGain;

    if(Math.random() < 0.05){
      state.aeno += 1;
      showToast("ğŸ’ æ”¶å–æˆåŠŸï¼šAENO +1");
    }else{
      showToast("ğŸ æ”¶å–æˆåŠŸï¼šé£Ÿç‰©+"+foodGain+" é‡‘å¹£+"+coinGain);
    }
  }

  // Beast tide
  function startBeastTide(){
    if(state.beastTideActive){
      showToast("âš ï¸ ç¸æ½®å·²ç¶“é€²è¡Œä¸­");
      return;
    }
    state.beastTideActive = true;
    state.beastTideTimer = 0;
    showToast("ğŸŒŠ ç¸æ½®ä¾†è¥²ï¼");
  }

  // Input handlers
  canvas.addEventListener("pointerdown", (e) => {
    isDragging = true;
    lastX = e.clientX;
    lastY = e.clientY;
  });

  canvas.addEventListener("pointermove", (e) => {
    if(!isDragging) return;
    const dx = e.clientX - lastX;
    const dy = e.clientY - lastY;
    lastX = e.clientX;
    lastY = e.clientY;

    camX -= dx * devicePixelRatio / zoom;
    camY -= dy * devicePixelRatio / zoom;
  });

  canvas.addEventListener("pointerup", () => {
    isDragging = false;
  });

  canvas.addEventListener("pointercancel", () => {
    isDragging = false;
  });

  // Mouse wheel zoom (I/O
  canvas.addEventListener("wheel", (e) => {
    e.preventDefault();
    const delta = -e.deltaY * 0.001;
    zoom = clamp(zoom + delta, 0.55, 2.4);
  }, { passive:false });

  // Touch pinch zoom
  canvas.addEventListener("touchmove", (e) => {
    if(e.touches.length === 2){
      const dx = e.touches[0].clientX - e.touches[1].clientX;
      const dy = e.touches[0].clientY - e.touches[1].clientY;
      const dist = Math.sqrt(dx*dx + dy*dy);

      if(pinchDist === null) pinchDist = dist;
      const diff = dist - pinchDist;
      zoom = clamp(zoom + diff*0.003, 0.55, 2.4);
      pinchDist = dist;
    }
  }, { passive:true });

  canvas.addEventListener("touchend", () => {
    pinchDist = null;
  });

  // Tap to place building / upgrade / collect loot
  canvas.addEventListener("click", (e) => {
    const w = screenToWorld(e.clientX, e.clientY);
    const t = worldToTile(w.x, w.y);

    // loot collection
    for(const loot of loots){
      if(loot.collected) continue;
      const dx = loot.wx - w.x;
      const dy = loot.wy - w.y;
      if(Math.sqrt(dx*dx + dy*dy) < 40){
        collectLoot(loot);
        return;
      }
    }

    if(!isInside(t.tx, t.ty)) return;

    const tile = world[t.ty][t.tx];

    // placing
    if(state.placingMode && state.selectedBuildType){
      placeBuilding(t.tx, t.ty, state.selectedBuildType);
      state.placingMode = false;
      state.selectedBuildType = null;
      return;
    }

    // upgrade
    if(tile.building){
      upgradeBuilding(t.tx, t.ty);
      return;
    }

    // show tile info
    showToast("ğŸ“ åœ°å½¢ï¼š" + tile.type);
  });

  // Draw helpers
  function drawRoundRect(x,y,w,h,r){
    ctx.beginPath();
    ctx.moveTo(x+r,y);
    ctx.arcTo(x+w,y,x+w,y+h,r);
    ctx.arcTo(x+w,y+h,x,y+h,r);
    ctx.arcTo(x,y+h,x,y,r);
    ctx.arcTo(x,y,x+w,y,r);
    ctx.closePath();
  }

  function drawTile(tx, ty, tile){
    const wx = tx*TILE;
    const wy = ty*TILE;

    // base color
    let c = "#8dff8d";
    if(tile.type === "water") c = "#46b7ff";
    if(tile.type === "forest") c = "#4ade80";
    if(tile.type === "mountain") c = "#cbd5e1";

    // soft shadow grid
    ctx.fillStyle = c;
    ctx.fillRect(wx, wy, TILE, TILE);

    ctx.strokeStyle = "rgba(0,0,0,0.08)";
    ctx.lineWidth = 2;
    ctx.strokeRect(wx, wy, TILE, TILE);

    // small details
    if(tile.type === "forest"){
      ctx.fillStyle = "rgba(0,0,0,0.15)";
      ctx.beginPath();
      ctx.arc(wx+TILE*0.35, wy+TILE*0.35, 4, 0, Math.PI*2);
      ctx.arc(wx+TILE*0.7, wy+TILE*0.6, 3, 0, Math.PI*2);
      ctx.fill();
    }

    if(tile.type === "mountain"){
      ctx.fillStyle = "rgba(0,0,0,0.12)";
      ctx.beginPath();
      ctx.moveTo(wx+10, wy+TILE-10);
      ctx.lineTo(wx+TILE*0.5, wy+10);
      ctx.lineTo(wx+TILE-10, wy+TILE-10);
      ctx.closePath();
      ctx.fill();
    }

    if(tile.type === "water"){
      ctx.fillStyle = "rgba(255,255,255,0.3)";
      ctx.beginPath();
      ctx.arc(wx+TILE*0.4, wy+TILE*0.55, 6, 0, Math.PI*2);
      ctx.arc(wx+TILE*0.7, wy+TILE*0.4, 4, 0, Math.PI*2);
      ctx.fill();
    }

    // placing highlight
    if(state.placingMode && state.selectedBuildType){
      const ok = canPlaceBuilding(tx, ty, state.selectedBuildType);
      ctx.fillStyle = ok ? "rgba(34,197,94,0.18)" : "rgba(255,0,0,0.15)";
      ctx.fillRect(wx, wy, TILE, TILE);
    }

    // building
    if(tile.building){
      drawBuilding(wx, wy, tile.building);
    }
  }

  function drawBuilding(wx, wy, b){
    const def = BUILDINGS[b.type];

    // base
    ctx.fillStyle = "rgba(0,0,0,0.15)";
    drawRoundRect(wx+5, wy+6, TILE-10, TILE-10, 10);
    ctx.fill();

    // body
    ctx.fillStyle = "rgba(255,255,255,0.85)";
    drawRoundRect(wx+6, wy+4, TILE-12, TILE-12, 12);
    ctx.fill();

    // icon
    ctx.font = "20px system-ui";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillStyle = "#111";
    ctx.fillText(def.icon, wx+TILE/2, wy+TILE/2 - 3);

    // level badge
    ctx.font = "10px system-ui";
    ctx.fillStyle = "rgba(0,0,0,0.65)";
    ctx.fillText("Lv."+b.level, wx+TILE/2, wy+TILE-10);

    // build progress bar
    if(!b.built){
      ctx.fillStyle = "rgba(0,0,0,0.2)";
      ctx.fillRect(wx+8, wy+TILE-8, TILE-16, 5);

      ctx.fillStyle = "rgba(34,197,94,0.9)";
      ctx.fillRect(wx+8, wy+TILE-8, (TILE-16)*(b.buildProgress/100), 5);
    }
  }

  function drawLoot(loot){
    if(loot.collected) return;

    ctx.fillStyle = "rgba(0,0,0,0.25)";
    ctx.beginPath();
    ctx.arc(loot.wx, loot.wy, 16, 0, Math.PI*2);
    ctx.fill();

    ctx.fillStyle = "rgba(255,255,255,0.95)";
    ctx.beginPath();
    ctx.arc(loot.wx, loot.wy-2, 16, 0, Math.PI*2);
    ctx.fill();

    ctx.fillStyle = "#111";
    ctx.font = "12px system-ui";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText("ğŸ¦´", loot.wx, loot.wy-2);

    ctx.font = "10px system-ui";
    ctx.fillStyle = "rgba(0,0,0,0.7)";
    ctx.fillText("é»æˆ‘æ”¶å–", loot.wx, loot.wy+18);
  }

  // Update loop
  let lastTime = performance.now();

  function update(dt){
    state.tick += dt;

    // building construction & production
    for(let y=0;y<GRID_SIZE;y++){
      for(let x=0;x<GRID_SIZE;x++){
        const tile = world[y][x];
        if(!tile.building) continue;

        const b = tile.building;
        const def = BUILDINGS[b.type];

        // build progress
        if(!b.built){
          b.buildProgress += dt * 8; // build speed
          if(b.buildProgress >= 100){
            b.buildProgress = 100;
            b.built = true;
            showToast("âœ… å»ºç¯‰å®Œæˆï¼š" + def.name);
          }
          continue;
        }

        // production per second
        const mult = 1 + (b.level-1)*0.35;

        if(def.baseProduction.wood) state.wood += def.baseProduction.wood * mult * dt;
        if(def.baseProduction.stone) state.stone += def.baseProduction.stone * mult * dt;
        if(def.baseProduction.food) state.food += def.baseProduction.food * mult * dt;
        if(def.baseProduction.energy) state.energy += def.baseProduction.energy * mult * dt;
        if(def.baseProduction.coin) state.coin += def.baseProduction.coin * mult * dt;

        // AENO mining chance (demo)
        if(b.type === "mine"){
          // low probability, but visible
          const chance = 0.0007 * mult * dt;
          if(Math.random() < chance){
            state.aeno += 1;
            showToast("ğŸ’ ä½ æŒ–åˆ° AENO +1");
          }
        }

        // house increases population slowly
        if(b.type === "house"){
          // population grows over time
          const popGain = 0.03 * mult * dt;
          state.population += popGain;
        }
      }
    }

    // clamp resources
    state.wood = clamp(state.wood, 0, 999999999);
    state.stone = clamp(state.stone, 0, 999999999);
    state.food = clamp(state.food, 0, 999999999);
    state.energy = clamp(state.energy, 0, 999999999);
    state.coin = clamp(state.coin, 0, 999999999);
    state.aeno = clamp(state.aeno, 0, 20000000);

    // Beast tide logic
    if(state.beastTideActive){
      state.beastTideTimer += dt;

      // reduce wall until around 60%
      if(state.wall > 60){
        state.wall -= dt * 3.5; // attack speed
      }else{
        // retreat
        if(state.beastTideTimer > 10){
          state.beastTideActive = false;
          showToast("ğŸŒŠ ç¸æ½®é€€å»ï¼");
          spawnLoot("ç¸æ½®å±é«”", 3);
        }
      }
    }else{
      // auto repair
      if(state.wall < 100){
        state.wall += dt * 2.2;
      }
    }

    state.wall = clamp(state.wall, 0, 100);

    // occasionally auto random tide
    if(!state.beastTideActive && Math.random() < 0.00003 * dt){
      startBeastTide();
    }

    // loot decay
    for(const loot of loots){
      if(loot.collected) continue;
      loot.life -= dt;
      if(loot.life <= 0){
        loot.collected = true;
      }
    }
  }

  function render(){
    ctx.setTransform(1,0,0,1,0,0);
    ctx.clearRect(0,0,canvas.width,canvas.height);

    // camera transform
    ctx.translate(canvas.width/2, canvas.height/2);
    ctx.scale(zoom, zoom);
    ctx.translate(-camX, -camY);

    // background soft cloud
    ctx.fillStyle = "rgba(255,255,255,0.15)";
    ctx.beginPath();
    ctx.arc(camX-400, camY-250, 180, 0, Math.PI*2);
    ctx.arc(camX+500, camY-300, 220, 0, Math.PI*2);
    ctx.fill();

    // draw map
    for(let y=0;y<GRID_SIZE;y++){
      for(let x=0;x<GRID_SIZE;x++){
        drawTile(x,y,world[y][x]);
      }
    }

    // draw loot
    for(const loot of loots){
      drawLoot(loot);
    }

    // center marker (player base)
    ctx.fillStyle = "rgba(0,0,0,0.12)";
    ctx.beginPath();
    ctx.arc(GRID_SIZE*TILE/2, GRID_SIZE*TILE/2, 12, 0, Math.PI*2);
    ctx.fill();

    // Beast tide effect overlay
    if(state.beastTideActive){
      ctx.fillStyle = "rgba(255,0,0,0.08)";
      ctx.fillRect(0,0,GRID_SIZE*TILE,GRID_SIZE*TILE);

      // beast tide waves
      ctx.fillStyle = "rgba(255,80,80,0.25)";
      ctx.font = "28px system-ui";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText("ğŸºğŸºğŸº", camX, camY-120);
    }

    // placing mode indicator
    if(state.placingMode && state.selectedBuildType){
      const def = BUILDINGS[state.selectedBuildType];
      ctx.fillStyle = "rgba(0,0,0,0.65)";
      ctx.font = "18px system-ui";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText("æ”¾ç½®ï¼š" + def.icon + " " + def.name, camX, camY+160);
    }
  }

  function syncUI(){
    uiWood.textContent = format(state.wood);
    uiStone.textContent = format(state.stone);
    uiFood.textContent = format(state.food);
    uiEnergy.textContent = format(state.energy);
    uiCoin.textContent = format(state.coin);
    uiAeno.textContent = format(state.aeno);

    uiWallText.textContent = Math.floor(state.wall) + "%";
    uiWallBar.style.width = state.wall + "%";

    if(state.wall < 70){
      document.getElementById("wallBar").classList.add("danger");
    }else{
      document.getElementById("wallBar").classList.remove("danger");
    }

    uiPopText.textContent = Math.floor(state.population);
  }

  function loop(now){
    const dt = Math.min(0.05, (now - lastTime)/1000);
    lastTime = now;

    update(dt);
    render();
    syncUI();

    requestAnimationFrame(loop);
  }

  // initial base buildings to feel alive
  placeBuilding(15, 15, "house");
  placeBuilding(14, 15, "farm");

  // Force finish those starter buildings quickly
  world[15][15].building.built = true;
  world[15][15].building.buildProgress = 100;

  world[15][14].building.built = true;
  world[15][14].building.buildProgress = 100;

  showToast("ğŸŒ AENO ä¸»åŸå·²å•Ÿå‹•ï¼");

  requestAnimationFrame(loop);

})();
</script>
</body>
</html>
