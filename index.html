<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>AENO V3 - Cartoon Mobile Vertical</title>
<style>
  :root{
    --bg:#e0f2fe;
    --card:#ffffff;
    --line:rgba(0,0,0,0.08);
    --shadow:0 12px 30px rgba(0,0,0,0.15);
    --btn:#38bdf8;
    --btn2:#22c55e;
    --btn3:#f97316;
    --txt:#0f172a;
    --muted:#64748b;
    --danger:#ef4444;
    --gold:#fbbf24;
  }

  *{box-sizing:border-box;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans HK","PingFang HK","Microsoft JhengHei",sans-serif;}
  body{
    margin:0;
    background:linear-gradient(180deg,#dbeafe,#e0f2fe,#f0f9ff);
    overflow:hidden;
    color:var(--txt);
  }

  #app{
    width:100vw;
    height:100vh;
    position:relative;
  }

  canvas{
    position:absolute;
    inset:0;
    width:100%;
    height:100%;
    background:transparent;
  }

  /* TOP BAR */
  .topbar{
    position:absolute;
    top:10px;
    left:10px;
    right:10px;
    height:54px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:8px 12px;
    border-radius:18px;
    background:rgba(255,255,255,0.85);
    border:1px solid var(--line);
    box-shadow:var(--shadow);
    backdrop-filter: blur(8px);
    z-index:50;
  }

  .brand{
    display:flex;
    gap:10px;
    align-items:center;
  }
  .logo{
    width:38px;height:38px;
    border-radius:14px;
    background:linear-gradient(135deg,#60a5fa,#22c55e);
    box-shadow:0 8px 16px rgba(0,0,0,0.12);
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:900;
    color:white;
  }
  .title{
    display:flex;
    flex-direction:column;
    line-height:1.1;
  }
  .title b{font-size:14px;}
  .title span{font-size:11px;color:var(--muted);}

  .topBtns{
    display:flex;
    gap:8px;
  }
  .btn{
    border:none;
    padding:8px 12px;
    border-radius:14px;
    font-weight:700;
    cursor:pointer;
    box-shadow:0 8px 16px rgba(0,0,0,0.10);
    transition: transform 0.12s ease;
    color:white;
    font-size:12px;
  }
  .btn:active{transform:scale(0.96);}
  .btn.blue{background:linear-gradient(135deg,#38bdf8,#2563eb);}
  .btn.green{background:linear-gradient(135deg,#22c55e,#16a34a);}
  .btn.orange{background:linear-gradient(135deg,#fb923c,#f97316);}

  /* PANELS */
  .panel{
    position:absolute;
    background:rgba(255,255,255,0.92);
    border:1px solid var(--line);
    box-shadow:var(--shadow);
    border-radius:22px;
    padding:12px;
    backdrop-filter: blur(10px);
    z-index:60;
  }

  .panelHeader{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    margin-bottom:10px;
  }

  .panelHeader b{
    font-size:14px;
  }

  .panelHeader .mini{
    font-size:11px;
    color:var(--muted);
    font-weight:700;
  }

  .collapseBtn{
    border:none;
    cursor:pointer;
    background:rgba(0,0,0,0.05);
    padding:6px 10px;
    border-radius:14px;
    font-weight:800;
    color:#0f172a;
  }

  /* Resource Panel */
  #resourcePanel{
    top:76px;
    left:10px;
    width:200px;
  }
  .resRow{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:6px 8px;
    border-radius:14px;
    background:rgba(0,0,0,0.03);
    margin-bottom:6px;
    font-size:12px;
  }
  .resRow span:first-child{color:var(--muted);font-weight:800;}
  .resRow span:last-child{font-weight:900;}

  /* Menu Panel */
  #menuPanel{
    top:76px;
    right:10px;
    width:220px;
  }

  .menuGrid{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:8px;
  }

  .menuItem{
    border:none;
    border-radius:18px;
    padding:10px;
    cursor:pointer;
    font-weight:900;
    font-size:12px;
    box-shadow:0 8px 14px rgba(0,0,0,0.10);
    transition:transform 0.12s ease;
    color:white;
    text-align:center;
  }
  .menuItem:active{transform:scale(0.96);}

  .m1{background:linear-gradient(135deg,#60a5fa,#2563eb);}
  .m2{background:linear-gradient(135deg,#22c55e,#16a34a);}
  .m3{background:linear-gradient(135deg,#fb923c,#f97316);}
  .m4{background:linear-gradient(135deg,#fbbf24,#f59e0b);}
  .m5{background:linear-gradient(135deg,#a78bfa,#7c3aed);}
  .m6{background:linear-gradient(135deg,#f472b6,#db2777);}

  /* Assistant Panel */
  #assistantPanel{
    bottom:10px;
    left:10px;
    right:10px;
    height:220px;
    display:flex;
    flex-direction:column;
    overflow:hidden;
  }

  .assistantTop{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:8px;
  }

  .assistantInfo{
    display:flex;
    align-items:center;
    gap:10px;
  }

  .assistantAvatar{
    width:44px;height:44px;
    border-radius:18px;
    background:linear-gradient(135deg,#fbbf24,#fb7185);
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:22px;
    box-shadow:0 10px 18px rgba(0,0,0,0.14);
  }

  .assistantName{
    display:flex;
    flex-direction:column;
    line-height:1.1;
  }
  .assistantName b{font-size:13px;}
  .assistantName span{font-size:11px;color:var(--muted);font-weight:800;}

  #chatLog{
    flex:1;
    overflow:auto;
    padding:8px;
    border-radius:18px;
    background:rgba(0,0,0,0.03);
    margin-top:10px;
    font-size:12px;
  }

  .msg{
    padding:8px 10px;
    border-radius:16px;
    margin-bottom:8px;
    max-width:92%;
    line-height:1.3;
    box-shadow:0 6px 14px rgba(0,0,0,0.06);
  }
  .msg.ai{
    background:white;
    border:1px solid rgba(0,0,0,0.06);
  }
  .msg.user{
    background:linear-gradient(135deg,#38bdf8,#2563eb);
    color:white;
    margin-left:auto;
  }

  .chatInput{
    display:flex;
    gap:8px;
    margin-top:10px;
  }
  .chatInput input{
    flex:1;
    border:none;
    outline:none;
    border-radius:18px;
    padding:12px 12px;
    background:rgba(255,255,255,0.95);
    border:1px solid rgba(0,0,0,0.08);
    font-size:13px;
    font-weight:700;
  }
  .chatInput button{
    border:none;
    border-radius:18px;
    padding:10px 14px;
    cursor:pointer;
    font-weight:900;
    color:white;
    background:linear-gradient(135deg,#22c55e,#16a34a);
    box-shadow:0 10px 18px rgba(0,0,0,0.12);
  }

  /* Floating quick open buttons (when panels collapsed) */
  .floatingBtn{
    position:absolute;
    z-index:90;
    width:52px;height:52px;
    border-radius:20px;
    border:none;
    cursor:pointer;
    box-shadow:0 12px 22px rgba(0,0,0,0.18);
    font-size:20px;
    font-weight:900;
    color:white;
    display:none;
  }

  #openRes{top:80px;left:10px;background:linear-gradient(135deg,#22c55e,#16a34a);}
  #openMenu{top:80px;right:10px;background:linear-gradient(135deg,#fb923c,#f97316);}
  #openAI{bottom:10px;right:10px;background:linear-gradient(135deg,#f472b6,#db2777);}

  /* Small build info */
  #toast{
    position:absolute;
    left:50%;
    transform:translateX(-50%);
    bottom:240px;
    background:rgba(0,0,0,0.78);
    color:white;
    padding:10px 14px;
    border-radius:18px;
    font-weight:800;
    font-size:12px;
    display:none;
    z-index:200;
  }
</style>
</head>

<body>
<div id="app">
  <canvas id="game"></canvas>

  <div class="topbar">
    <div class="brand">
      <div class="logo">A</div>
      <div class="title">
        <b>AENO V3 åŸé®é ˜åœ°</b>
        <span id="timeText">æ™‚é–“ï¼šè¼‰å…¥ä¸­...</span>
      </div>
    </div>
    <div class="topBtns">
      <button class="btn blue" id="btnCenter">ä¸­å¿ƒ</button>
      <button class="btn green" id="btnZoomIn">ï¼‹</button>
      <button class="btn orange" id="btnZoomOut">ï¼</button>
    </div>
  </div>

  <!-- Resource Panel -->
  <div class="panel" id="resourcePanel">
    <div class="panelHeader">
      <div>
        <b>è³‡æºåº«</b><div class="mini">è‡ªå‹•æ›´æ–°</div>
      </div>
      <button class="collapseBtn" id="collapseRes">æ”¶èµ·</button>
    </div>
    <div id="resList"></div>
  </div>

  <!-- Menu Panel -->
  <div class="panel" id="menuPanel">
    <div class="panelHeader">
      <div>
        <b>åŠŸèƒ½è¡¨</b><div class="mini">å»ºé€  / å‡ç´š</div>
      </div>
      <button class="collapseBtn" id="collapseMenu">æ”¶èµ·</button>
    </div>
    <div class="menuGrid">
      <button class="menuItem m1" id="btnBuildHouse">èµ·å±‹</button>
      <button class="menuItem m2" id="btnBuildDome">åœ“é ‚</button>
      <button class="menuItem m3" id="btnUpgrade">å‡ç´š</button>
      <button class="menuItem m4" id="btnExpand">æ“´åœ°</button>
      <button class="menuItem m5" id="btnRobot">æ´¾æ©Ÿæ¢°äºº</button>
      <button class="menuItem m6" id="btnMarket">å¸‚å ´</button>
    </div>
  </div>

  <!-- Assistant Panel -->
  <div class="panel" id="assistantPanel">
    <div class="assistantTop">
      <div class="assistantInfo">
        <div class="assistantAvatar">ğŸ¾</div>
        <div class="assistantName">
          <b>AI åŠ©æ‰‹ï¼šVulpes</b>
          <span id="aiState">ç‹€æ…‹ï¼šå·¡é‚é ˜åœ°ä¸­</span>
        </div>
      </div>
      <button class="collapseBtn" id="collapseAI">æ”¶èµ·</button>
    </div>

    <div id="chatLog"></div>

    <div class="chatInput">
      <input id="chatText" placeholder="è¼¸å…¥æŒ‡ä»¤ï¼šä¾‹å¦‚ã€æ”¶è³‡æºã€ã€èµ·å±‹ã€ã€å‡ç´šã€ã€æ“´åœ°ã€ã€æ´¾æ©Ÿæ¢°äººã€"/>
      <button id="sendChat">é€å‡º</button>
    </div>
  </div>

  <!-- floating open buttons -->
  <button class="floatingBtn" id="openRes">ğŸ“¦</button>
  <button class="floatingBtn" id="openMenu">ğŸ› ï¸</button>
  <button class="floatingBtn" id="openAI">ğŸ¾</button>

  <div id="toast"></div>
</div>

<script>
/* ===========================
   AENO V3 - Single HTML Game
   Canvas Isometric Cartoon Town
   =========================== */

const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

function resize(){
  canvas.width = window.innerWidth * devicePixelRatio;
  canvas.height = window.innerHeight * devicePixelRatio;
  ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
}
window.addEventListener("resize", resize);
resize();

/* ========= GAME STATE ========= */
const game = {
  grid: { rows: 14, cols: 14 },
  tileSize: 60,
  isoAngle: Math.PI / 6,
  cam: { x: 0, y: 0, zoom: 1 },
  dragging: false,
  dragStart: {x:0,y:0},
  camStart: {x:0,y:0},
  time: { year: 1000, day: 1 },
  resources: {
    AENO: 120,
    Wood: 40,
    Stone: 20,
    Food: 50,
    Crystal: 2
  },
  territory: { radius: 4 }, // expandable
  buildings: [],
  selectedBuildingId: null,
  clouds: [],
  lastTick: performance.now(),
  lastAI: performance.now()
};

const colors = {
  grass1: "#dcfce7",
  grass2: "#bbf7d0",
  border: "rgba(0,0,0,0.08)",
  shadow: "rgba(0,0,0,0.22)"
};

/* ========= HELPERS ========= */
function clamp(v,min,max){ return Math.max(min, Math.min(max,v)); }

function gridToScreen(r, c){
  const s = game.tileSize * game.cam.zoom;
  const ax = Math.cos(game.isoAngle) * s;
  const ay = Math.sin(game.isoAngle) * s;

  const x = (c - r) * ax + (window.innerWidth/2) + game.cam.x;
  const y = (c + r) * ay + 160 + game.cam.y;
  return {x,y};
}

function showToast(txt){
  const t = document.getElementById("toast");
  t.innerText = txt;
  t.style.display = "block";
  clearTimeout(showToast._timer);
  showToast._timer = setTimeout(()=>t.style.display="none",1200);
}

function insideTerritory(r,c){
  const centerR = Math.floor(game.grid.rows/2);
  const centerC = Math.floor(game.grid.cols/2);
  const dist = Math.abs(r-centerR) + Math.abs(c-centerC);
  return dist <= game.territory.radius;
}

/* ========= BUILDING ========= */
function addBuilding(type){
  // find empty tile inside territory
  for(let r=0;r<game.grid.rows;r++){
    for(let c=0;c<game.grid.cols;c++){
      if(!insideTerritory(r,c)) continue;
      const occupied = game.buildings.some(b=>b.r===r && b.c===c);
      if(!occupied){
        const id = crypto.randomUUID();
        game.buildings.push({
          id, type,
          r,c,
          level:1,
          bounce:0
        });
        showToast("âœ… å»ºç¯‰å®Œæˆï¼š" + type);
        aiSay(`æˆ‘å·²ç¶“å¹«ä½ èµ·å¥½ä¸€åº§ã€Œ${type}ã€å•¦ï½`);
        return;
      }
    }
  }
  showToast("âŒ ç„¡ç©ºåœ°ï¼Œè«‹å…ˆæ“´åœ°");
}

function upgradeSelected(){
  const b = game.buildings.find(x=>x.id===game.selectedBuildingId);
  if(!b){
    showToast("âŒ æœªé¸æ“‡å»ºç¯‰");
    return;
  }
  const costWood = 10 * b.level;
  const costStone = 6 * b.level;

  if(game.resources.Wood < costWood || game.resources.Stone < costStone){
    showToast("âŒ è³‡æºä¸è¶³");
    aiSay("å‡ç´šå¤±æ•—ï¼šæœ¨ææˆ–çŸ³é ­å””å¤ ã€‚å«æˆ‘æ”¶è³‡æºå…ˆå•¦ã€‚");
    return;
  }

  game.resources.Wood -= costWood;
  game.resources.Stone -= costStone;
  b.level++;
  b.bounce = 1;

  showToast("â¬†ï¸ å‡ç´šæˆåŠŸ Lv." + b.level);
  aiSay(`å‡ç´šå®Œæˆï¼å»ºç¯‰å·²æå‡åˆ° Lv.${b.level}ã€‚`);
}

function expandTerritory(){
  const cost = 60 + (game.territory.radius*40);
  if(game.resources.AENO < cost){
    showToast("âŒ AENOä¸è¶³");
    aiSay(`æ“´åœ°éœ€è¦ ${cost} AENOï¼Œä½ è€Œå®¶å¾— ${Math.floor(game.resources.AENO)}ã€‚`);
    return;
  }
  game.resources.AENO -= cost;
  game.territory.radius++;
  showToast("ğŸ—ºï¸ é ˜åœŸæ“´å¼µæˆåŠŸï¼");
  aiSay("é ˜åœŸå·²æ“´å¼µï¼æˆ‘æœƒå®‰æ’æ›´å¤šå»ºç¯‰ç©ºé–“ã€‚");
}

/* ========= AI CHAT ========= */
const chatLog = document.getElementById("chatLog");

function addMsg(type, text){
  const div = document.createElement("div");
  div.className = "msg " + type;
  div.innerText = text;
  chatLog.appendChild(div);
  chatLog.scrollTop = chatLog.scrollHeight;
}

function aiSay(text){
  addMsg("ai", "ğŸ¾ Vulpesï¼š " + text);
}

function userSay(text){
  addMsg("user", text);
}

aiSay("AENO V3 å·²å•Ÿå‹•ï¼æˆ‘æœƒè‡ªå‹•å¹«ä½ æ”¶è³‡æºåŒç®¡ç†é ˜åœ°ã€‚ä½ å¯ä»¥å«æˆ‘ï¼šæ”¶è³‡æº / èµ·å±‹ / åœ“é ‚ / å‡ç´š / æ“´åœ° / æ´¾æ©Ÿæ¢°äººã€‚");

/* ========= AI AUTO SYSTEM ========= */
function aiAutoTick(){
  // Auto collect
  const foodGain = 0.3 + (game.territory.radius * 0.05);
  const woodGain = 0.22 + (game.buildings.filter(b=>b.type==="å°å±‹").length * 0.18);
  const stoneGain = 0.12 + (game.buildings.filter(b=>b.type==="åœ“é ‚").length * 0.12);
  const crystalGain = (Math.random()<0.05) ? 0.1 : 0;

  game.resources.Food += foodGain;
  game.resources.Wood += woodGain;
  game.resources.Stone += stoneGain;
  game.resources.Crystal += crystalGain;

  // AENO slow mint (demo)
  game.resources.AENO += 0.06;

  // semi auto build if empty and enough resources
  if(game.buildings.length < 10 && game.resources.Wood > 30 && game.resources.Stone > 15){
    if(Math.random()<0.08){
      game.resources.Wood -= 18;
      game.resources.Stone -= 10;
      addBuilding("å°å±‹");
      aiSay("æˆ‘é †ä¾¿å¹«ä½ èµ·å¤šä¸€é–“å°å±‹ï¼Œæå‡ç”¢é‡ã€‚");
    }
  }

  // semi auto upgrade random building
  if(game.buildings.length > 0 && Math.random()<0.06){
    const b = game.buildings[Math.floor(Math.random()*game.buildings.length)];
    const costWood = 10*b.level;
    const costStone = 6*b.level;
    if(game.resources.Wood >= costWood && game.resources.Stone >= costStone){
      game.resources.Wood -= costWood;
      game.resources.Stone -= costStone;
      b.level++;
      b.bounce = 1;
      aiSay(`æˆ‘è‡ªå‹•å¹«ä½ å‡ç´šä¸€åº§å»ºç¯‰ï¼ˆ${b.type} Lv.${b.level}ï¼‰ã€‚`);
    }
  }
}

/* ========= UI UPDATE ========= */
function updateResourcePanel(){
  const list = document.getElementById("resList");
  list.innerHTML = "";

  const entries = [
    ["AENO", game.resources.AENO, "ğŸª™"],
    ["Wood", game.resources.Wood, "ğŸªµ"],
    ["Stone", game.resources.Stone, "ğŸª¨"],
    ["Food", game.resources.Food, "ğŸ–"],
    ["Crystal", game.resources.Crystal, "ğŸ’"]
  ];

  for(const [k,v,icon] of entries){
    const row = document.createElement("div");
    row.className = "resRow";
    row.innerHTML = `<span>${icon} ${k}</span><span>${Math.floor(v)}</span>`;
    list.appendChild(row);
  }
}

function updateTimeText(){
  document.getElementById("timeText").innerText =
    `Year ${game.time.year} Â· Day ${game.time.day} Â· é ˜åœŸR=${game.territory.radius}`;
}

/* ========= DRAW ========= */
function drawTile(r,c){
  const {x,y} = gridToScreen(r,c);
  const s = game.tileSize * game.cam.zoom;
  const ax = Math.cos(game.isoAngle) * s;
  const ay = Math.sin(game.isoAngle) * s;

  const inLand = insideTerritory(r,c);

  // base
  ctx.beginPath();
  ctx.moveTo(x, y);
  ctx.lineTo(x + ax, y + ay);
  ctx.lineTo(x, y + ay*2);
  ctx.lineTo(x - ax, y + ay);
  ctx.closePath();

  const grad = ctx.createLinearGradient(x-ax,y,x+ax,y+ay*2);
  grad.addColorStop(0, inLand ? colors.grass1 : "rgba(203,213,225,0.45)");
  grad.addColorStop(1, inLand ? colors.grass2 : "rgba(148,163,184,0.35)");
  ctx.fillStyle = grad;
  ctx.fill();

  ctx.strokeStyle = "rgba(0,0,0,0.06)";
  ctx.lineWidth = 1;
  ctx.stroke();

  // tile dots texture
  if(inLand){
    ctx.fillStyle = "rgba(0,0,0,0.03)";
    ctx.beginPath();
    ctx.arc(x-ax*0.3,y+ay*1.1,1.5,0,Math.PI*2);
    ctx.arc(x+ax*0.2,y+ay*0.7,1.2,0,Math.PI*2);
    ctx.fill();
  }
}

function drawBuilding(b){
  const {x,y} = gridToScreen(b.r,b.c);

  // bounce animation
  if(b.bounce>0){
    b.bounce -= 0.06;
    if(b.bounce<0) b.bounce = 0;
  }
  const bounceY = Math.sin(b.bounce*Math.PI) * 18;

  // shadow
  ctx.fillStyle = "rgba(0,0,0,0.20)";
  ctx.beginPath();
  ctx.ellipse(x, y + 62, 46, 18, 0, 0, Math.PI*2);
  ctx.fill();

  // selected highlight
  if(game.selectedBuildingId === b.id){
    ctx.strokeStyle = "rgba(59,130,246,0.9)";
    ctx.lineWidth = 4;
    ctx.beginPath();
    ctx.ellipse(x, y + 62, 54, 22, 0, 0, Math.PI*2);
    ctx.stroke();
  }

  // iso "fake depth"
  const baseY = y + bounceY;

  if(b.type==="å°å±‹"){
    // left wall
    ctx.fillStyle = "#fde68a";
    ctx.beginPath();
    ctx.moveTo(x-42, baseY+12);
    ctx.lineTo(x, baseY+32);
    ctx.lineTo(x, baseY+78);
    ctx.lineTo(x-42, baseY+56);
    ctx.closePath();
    ctx.fill();

    // right wall
    ctx.fillStyle = "#fef3c7";
    ctx.beginPath();
    ctx.moveTo(x+42, baseY+12);
    ctx.lineTo(x, baseY+32);
    ctx.lineTo(x, baseY+78);
    ctx.lineTo(x+42, baseY+56);
    ctx.closePath();
    ctx.fill();

    // roof
    const roofGrad = ctx.createLinearGradient(x,baseY-40,x,baseY+20);
    roofGrad.addColorStop(0,"#fcd34d");
    roofGrad.addColorStop(1,"#fbbf24");
    ctx.fillStyle = roofGrad;
    ctx.beginPath();
    ctx.moveTo(x, baseY-32);
    ctx.lineTo(x-52, baseY+8);
    ctx.lineTo(x, baseY+28);
    ctx.lineTo(x+52, baseY+8);
    ctx.closePath();
    ctx.fill();

    // door
    ctx.fillStyle = "#b45309";
    ctx.beginPath();
    ctx.roundRect(x-10, baseY+50, 20, 28, 6);
    ctx.fill();

    // windows
    ctx.fillStyle = "#bfdbfe";
    ctx.beginPath();
    ctx.arc(x-20, baseY+46, 7, 0, Math.PI*2);
    ctx.arc(x+20, baseY+46, 7, 0, Math.PI*2);
    ctx.fill();

  } else if(b.type==="åœ“é ‚"){
    // base body
    const bodyGrad = ctx.createRadialGradient(x,baseY+38,5,x,baseY+38,52);
    bodyGrad.addColorStop(0,"#fff7ed");
    bodyGrad.addColorStop(1,"#fde68a");
    ctx.fillStyle = bodyGrad;
    ctx.beginPath();
    ctx.arc(x, baseY+40, 48, 0, Math.PI*2);
    ctx.fill();

    // dome top
    const domeGrad = ctx.createRadialGradient(x,baseY-10,5,x,baseY-10,44);
    domeGrad.addColorStop(0,"#93c5fd");
    domeGrad.addColorStop(1,"#3b82f6");
    ctx.fillStyle = domeGrad;
    ctx.beginPath();
    ctx.arc(x, baseY-10, 40, 0, Math.PI*2);
    ctx.fill();

    // gold trim
    ctx.fillStyle = "#fbbf24";
    ctx.beginPath();
    ctx.arc(x, baseY-10, 10, 0, Math.PI*2);
    ctx.fill();

    // door
    ctx.fillStyle = "#92400e";
    ctx.beginPath();
    ctx.roundRect(x-14, baseY+55, 28, 30, 8);
    ctx.fill();
  }

  // level tag
  ctx.fillStyle = "rgba(0,0,0,0.65)";
  ctx.beginPath();
  ctx.roundRect(x-22, baseY-64, 44, 20, 8);
  ctx.fill();
  ctx.fillStyle = "white";
  ctx.font = "bold 12px system-ui";
  ctx.textAlign = "center";
  ctx.fillText("Lv."+b.level, x, baseY-49);
}

function drawCloud(cl){
  ctx.globalAlpha = cl.a;
  ctx.fillStyle = "white";
  ctx.beginPath();
  ctx.arc(cl.x, cl.y, cl.s*1.0, 0, Math.PI*2);
  ctx.arc(cl.x+cl.s*0.9, cl.y+cl.s*0.2, cl.s*0.8, 0, Math.PI*2);
  ctx.arc(cl.x-cl.s*0.8, cl.y+cl.s*0.2, cl.s*0.7, 0, Math.PI*2);
  ctx.fill();
  ctx.globalAlpha = 1;
}

function draw(){
  ctx.clearRect(0,0,window.innerWidth,window.innerHeight);

  // background sky gradient
  const g = ctx.createLinearGradient(0,0,0,window.innerHeight);
  g.addColorStop(0,"#bfdbfe");
  g.addColorStop(1,"#f0f9ff");
  ctx.fillStyle = g;
  ctx.fillRect(0,0,window.innerWidth,window.innerHeight);

  // clouds
  for(const cl of game.clouds){
    drawCloud(cl);
  }

  // tiles
  for(let r=0;r<game.grid.rows;r++){
    for(let c=0;c<game.grid.cols;c++){
      drawTile(r,c);
    }
  }

  // buildings sorted for depth
  const sorted = [...game.buildings].sort((a,b)=> (a.r+a.c)-(b.r+b.c));
  for(const b of sorted){
    drawBuilding(b);
  }

  // hint
  ctx.fillStyle = "rgba(0,0,0,0.55)";
  ctx.font = "bold 12px system-ui";
  ctx.textAlign = "center";
  ctx.fillText("æ‹–æ›³åœ°åœ–ï½œç¸®æ”¾ï¼‹ï¼ï½œé»å»ºç¯‰é¸æ“‡ï½œAIæœƒè‡ªå‹•æ”¶è³‡æº", window.innerWidth/2, window.innerHeight-240);
}

/* ========= INPUT (DRAG + CLICK) ========= */
canvas.addEventListener("pointerdown",(e)=>{
  game.dragging = true;
  game.dragStart.x = e.clientX;
  game.dragStart.y = e.clientY;
  game.camStart.x = game.cam.x;
  game.camStart.y = game.cam.y;
});

canvas.addEventListener("pointermove",(e)=>{
  if(!game.dragging) return;
  const dx = e.clientX - game.dragStart.x;
  const dy = e.clientY - game.dragStart.y;
  game.cam.x = game.camStart.x + dx;
  game.cam.y = game.camStart.y + dy;
});

canvas.addEventListener("pointerup",(e)=>{
  game.dragging = false;
});

canvas.addEventListener("click",(e)=>{
  // detect building clicked
  const mx = e.clientX;
  const my = e.clientY;

  let clicked = null;
  let bestDist = 999999;

  for(const b of game.buildings){
    const p = gridToScreen(b.r,b.c);
    const dx = mx - p.x;
    const dy = my - (p.y+40);
    const d = Math.sqrt(dx*dx+dy*dy);
    if(d < 70 && d < bestDist){
      bestDist = d;
      clicked = b;
    }
  }

  if(clicked){
    game.selectedBuildingId = clicked.id;
    clicked.bounce = 1;
    showToast("ğŸ  å·²é¸æ“‡ï¼š" + clicked.type + " Lv." + clicked.level);
    aiSay(`ä½ é¸ä¸­å’—ä¸€åº§ã€Œ${clicked.type} Lv.${clicked.level}ã€ã€‚è¦æˆ‘å¹«ä½ å‡ç´šå—ï¼Ÿ`);
  }
});

/* ========= BUTTONS ========= */
document.getElementById("btnCenter").onclick = ()=>{
  game.cam.x = 0;
  game.cam.y = 0;
  showToast("ğŸ“ å·²å›åˆ°ä¸­å¿ƒ");
};

document.getElementById("btnZoomIn").onclick = ()=>{
  game.cam.zoom = clamp(game.cam.zoom + 0.1, 0.6, 1.6);
  showToast("ğŸ” æ”¾å¤§");
};
document.getElementById("btnZoomOut").onclick = ()=>{
  game.cam.zoom = clamp(game.cam.zoom - 0.1, 0.6, 1.6);
  showToast("ğŸ” ç¸®å°");
};

document.getElementById("btnBuildHouse").onclick = ()=>{
  if(game.resources.Wood < 15){
    showToast("âŒ æœ¨æä¸è¶³");
    return;
  }
  game.resources.Wood -= 15;
  addBuilding("å°å±‹");
};

document.getElementById("btnBuildDome").onclick = ()=>{
  if(game.resources.Stone < 18){
    showToast("âŒ çŸ³é ­ä¸è¶³");
    return;
  }
  game.resources.Stone -= 18;
  addBuilding("åœ“é ‚");
};

document.getElementById("btnUpgrade").onclick = ()=> upgradeSelected();
document.getElementById("btnExpand").onclick = ()=> expandTerritory();

document.getElementById("btnRobot").onclick = ()=>{
  showToast("ğŸ¤– æ©Ÿæ¢°äººå·²æ´¾å‡º");
  aiSay("æ©Ÿæ¢°äººå·²æ´¾å» 20 æ˜Ÿçƒå…¶ä¸­ä¸€å€‹æ¡é›†è³‡æºï¼ˆDemoæ¨¡å¼ï¼‰ã€‚");
  // reward
  setTimeout(()=>{
    const gain = 30 + Math.random()*50;
    game.resources.Wood += gain;
    game.resources.Stone += gain*0.6;
    game.resources.AENO += 2 + Math.random()*4;
    aiSay(`æ©Ÿæ¢°äººå›å ±ï¼šå¸¶è¿”æœ¨æ +${Math.floor(gain)}ï¼ŒçŸ³é ­ +${Math.floor(gain*0.6)}ï¼ŒAENO +${Math.floor(2+Math.random()*4)}ã€‚`);
  }, 1500);
};

document.getElementById("btnMarket").onclick = ()=>{
  showToast("ğŸ“ˆ å¸‚å ´ï¼ˆDemoï¼‰");
  aiSay("å¸‚å ´ç³»çµ±å·²é ç•™å…¥å£ï¼ˆä¹‹å¾Œæ¥å…¥äº¤æ˜“æ‰€ã€è‚¡ç¥¨ã€è³‡æºäº¤æ›ï¼‰ã€‚");
};

/* ========= COLLAPSE SYSTEM ========= */
const resPanel = document.getElementById("resourcePanel");
const menuPanel = document.getElementById("menuPanel");
const aiPanel = document.getElementById("assistantPanel");

const openRes = document.getElementById("openRes");
const openMenu = document.getElementById("openMenu");
const openAI = document.getElementById("openAI");

document.getElementById("collapseRes").onclick = ()=>{
  resPanel.style.display="none";
  openRes.style.display="block";
};
document.getElementById("collapseMenu").onclick = ()=>{
  menuPanel.style.display="none";
  openMenu.style.display="block";
};
document.getElementById("collapseAI").onclick = ()=>{
  aiPanel.style.display="none";
  openAI.style.display="block";
};

openRes.onclick = ()=>{
  resPanel.style.display="block";
  openRes.style.display="none";
};
openMenu.onclick = ()=>{
  menuPanel.style.display="block";
  openMenu.style.display="none";
};
openAI.onclick = ()=>{
  aiPanel.style.display="flex";
  openAI.style.display="none";
};

/* ========= CHAT INPUT ========= */
document.getElementById("sendChat").onclick = ()=>{
  const input = document.getElementById("chatText");
  const txt = input.value.trim();
  if(!txt) return;
  input.value = "";
  userSay(txt);
  handleCommand(txt);
};

document.getElementById("chatText").addEventListener("keydown",(e)=>{
  if(e.key==="Enter"){
    document.getElementById("sendChat").click();
  }
});

function handleCommand(cmd){
  cmd = cmd.toLowerCase();

  if(cmd.includes("æ”¶") || cmd.includes("è³‡æº")){
    aiSay("æ”¶åˆ°ï¼Œæˆ‘å³åˆ»å¹«ä½ åŠ é€Ÿæ”¶è³‡æºã€‚");
    game.resources.Wood += 20;
    game.resources.Stone += 12;
    game.resources.Food += 25;
    game.resources.AENO += 2;
    showToast("ğŸ“¦ è³‡æºå·²æ”¶é›†");
    return;
  }

  if(cmd.includes("èµ·å±‹") || cmd.includes("å»ºå±‹")){
    aiSay("å¥½ï¼æˆ‘å¹«ä½ èµ·ä¸€é–“å°å±‹ã€‚");
    if(game.resources.Wood >= 15){
      game.resources.Wood -= 15;
      addBuilding("å°å±‹");
    }else{
      aiSay("ä½†æœ¨æå””å¤ ï¼Œæˆ‘å…ˆå¹«ä½ æ”¶æœ¨æã€‚");
      game.resources.Wood += 25;
    }
    return;
  }

  if(cmd.includes("åœ“é ‚") || cmd.includes("dome")){
    aiSay("æ”¶åˆ°ï¼Œæˆ‘å¹«ä½ èµ·åœ“é ‚å»ºç¯‰ã€‚");
    if(game.resources.Stone >= 18){
      game.resources.Stone -= 18;
      addBuilding("åœ“é ‚");
    }else{
      aiSay("çŸ³é ­å””å¤ ï¼Œæˆ‘å…ˆå»æ¡çŸ³ã€‚");
      game.resources.Stone += 25;
    }
    return;
  }

  if(cmd.includes("å‡ç´š")){
    aiSay("æ˜ç™½ï¼Œæˆ‘å¹«ä½ å‡ç´šå·²é¸æ“‡å»ºç¯‰ã€‚");
    upgradeSelected();
    return;
  }

  if(cmd.includes("æ“´") || cmd.includes("é ˜åœŸ")){
    aiSay("æ“´åœ°æŒ‡ä»¤æ”¶åˆ°ï¼æˆ‘å¹«ä½ ç”³è«‹æ–°åœŸåœ°ã€‚");
    expandTerritory();
    return;
  }

  if(cmd.includes("æ´¾") || cmd.includes("æ©Ÿæ¢°äºº") || cmd.includes("robot")){
    aiSay("å¥½ï¼Œæˆ‘ç«‹å³æ´¾æ©Ÿæ¢°äººå‡ºç™¼ã€‚");
    document.getElementById("btnRobot").click();
    return;
  }

  if(cmd.includes("ä½ å¥½") || cmd.includes("hi")){
    aiSay("ä½ å¥½å‘€ä¸»äººï½æˆ‘ä¿‚ä½ å˜…é ˜åœ°ç®¡å®¶ Vulpes ğŸ¾");
    return;
  }

  aiSay("æˆ‘æ˜ç™½ä½ è¬›ç·Šï¼šã€" + cmd + "ã€ã€‚ä¸éå‘¢å€‹æŒ‡ä»¤æš«æ™‚æœªåŠ å…¥å®Œæ•´ç‰ˆè¦å‰‡ï¼ˆæˆ‘å¯ä»¥ä¸‹ä¸€ç‰ˆåŠ ï¼‰ã€‚");
}

/* ========= CLOUDS INIT ========= */
function initClouds(){
  for(let i=0;i<6;i++){
    game.clouds.push({
      x: Math.random()*window.innerWidth,
      y: 60 + Math.random()*180,
      s: 22 + Math.random()*26,
      sp: 0.15 + Math.random()*0.25,
      a: 0.65 + Math.random()*0.25
    });
  }
}
initClouds();

/* ========= MAIN LOOP ========= */
function loop(now){
  const dt = now - game.lastTick;
  game.lastTick = now;

  // in-game time: 1 second = 1 day (demo)
  if(dt > 0){
    if(Math.random() < 0.04){
      game.time.day++;
      if(game.time.day > 365){
        game.time.day = 1;
        game.time.year += 1;
      }
    }
  }

  // cloud movement
  for(const cl of game.clouds){
    cl.x += cl.sp;
    if(cl.x > window.innerWidth + 100){
      cl.x = -120;
      cl.y = 60 + Math.random()*180;
    }
  }

  // AI auto tick every 1.2s
  if(now - game.lastAI > 1200){
    game.lastAI = now;
    aiAutoTick();
  }

  updateResourcePanel();
  updateTimeText();
  draw();

  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

/* ========= START BASE BUILDINGS ========= */
addBuilding("å°å±‹");
addBuilding("åœ“é ‚");
addBuilding("å°å±‹");

showToast("AENO V3 å·²è¼‰å…¥");
</script>
</body>
</html>
