<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>AENO V3 æ–‡æ˜å¸åœ‹ï¼ˆæœ€çµ‚å¯é‹è¡Œç‰ˆï¼‰</title>
<style>
* { margin:0; padding:0; box-sizing:border-box; font-family: system-ui, "Noto Sans HK", sans-serif; }
body { background:#000; color:#fff; overflow:hidden; }
#loginScreen { position:fixed; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:20px; z-index:9999; background:#000; }
#loginScreen input { padding:12px 20px; width:80%; max-width:300px; border:none; border-radius:8px; font-size:16px; }
#loginScreen button { padding:12px 30px; border:none; border-radius:8px; background:#0071e3; color:#fff; font-size:16px; cursor:pointer; }
#bootScreen { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:#000; color:#0f0; z-index:9998; }
#gameCanvas { display:block; width:100vw; height:100vh; }
#mainPanel { position:fixed; top:10px; left:10px; width:360px; height:560px; background:rgba(0,0,0,0.8); border:1px solid #444; border-radius:10px; padding:10px; z-index:999; }
.panelHeader { display:flex; justify-content:space-between; margin-bottom:10px; padding-bottom:8px; border-bottom:1px solid #444; }
.tabBar { display:flex; gap:6px; margin-bottom:10px; flex-wrap:wrap; }
.tabBtn { padding:6px 10px; background:#333; border:none; border-radius:6px; color:#fff; font-size:12px; cursor:pointer; }
.tabBtn.active { background:#0071e3; }
.tabPage { display:none; overflow:auto; height:380px; padding-right:6px; }
.tabPage.active { display:block; }
.row { display:flex; justify-content:space-between; padding:4px 0; font-size:14px; }
.btn { padding:8px; background:#0071e3; border:none; border-radius:6px; color:#fff; cursor:pointer; margin-top:4px; }
.btn.gray { background:#444; }
.btn.green { background:#10b981; }
#sysLog { height:80px; overflow:auto; font-size:12px; color:#ccc; margin-top:10px; }
#aiPet { position:fixed; top:20px; left:20px; width:120px; height:120px; cursor:pointer; z-index:999; }
#petHint { position:fixed; top:150px; left:20px; background:rgba(0,0,0,0.8); padding:8px; border-radius:6px; font-size:12px; display:none; }
.beastEffect { position:fixed; width:80px; height:80px; border-radius:50%; background:rgba(255,0,0,0.5); display:none; z-index:997; }
</style>
</head>
<body>
<!-- ç™»å…¥ç•Œé¢ -->
<div id="loginScreen">
  <h1>AENO V3 æ–‡æ˜å¸åœ‹</h1>
  <input type="text" id="userName" placeholder="è«‹è¼¸å…¥æš±ç¨±ï¼ˆéš¨æ„å¡«ï¼‰">
  <button onclick="loginGame()">ç™»å…¥éŠæˆ²</button>
  <button onclick="loginGame(true)">æ¸¸å®¢ç™»å…¥</button>
</div>

<!-- è¼‰å…¥ç•Œé¢ -->
<div id="bootScreen" style="display:none;">è¼‰å…¥ä¸­...</div>

<!-- éŠæˆ²ç•«å¸ƒ -->
<canvas id="gameCanvas"></canvas>

<!-- AIå°å‹•ç‰© -->
<canvas id="aiPet" width="120" height="120"></canvas>
<div id="petHint">é»æ“Šæ’­æ”¾å»£å‘Šï¼ŒAENOæ”¶ç›ŠÃ—2ï¼</div>

<!-- æ§åˆ¶é¢æ¿ -->
<div id="mainPanel">
  <div class="panelHeader">
    <b>æ–‡æ˜æ§åˆ¶é¢æ¿</b>
    <button onclick="panelMin()" class="gray btn">ç¸®</button>
  </div>
  <div class="tabBar">
    <button class="tabBtn active" onclick="switchTab('main')">ä¸»é </button>
    <button class="tabBtn" onclick="switchTab('build')">å»ºé€ </button>
    <button class="tabBtn" onclick="switchTab('market')">äº¤æ˜“æ‰€</button>
    <button class="tabBtn" onclick="switchTab('tech')">ç§‘æŠ€</button>
  </div>
  <div id="mainTab" class="tabPage active">
    <div class="row"><span>æš±ç¨±</span><span id="userName">æ¸¸å®¢</span></div>
    <div class="row"><span>é‡‘å¹£</span><span id="statGold">0</span></div>
    <div class="row"><span>AENO</span><span id="statAeno">0.000000</span></div>
    <div class="row"><span>æœ¨æ</span><span id="statWood">0</span></div>
    <div class="row"><span>çŸ³é ­</span><span id="statStone">0</span></div>
    <div class="row"><span>éµç¤¦</span><span id="statIron">0</span></div>
    <div class="row"><span>ç³§é£Ÿ</span><span id="statFood">0</span></div>
    <div class="row"><span>äººå£</span><span id="statPop">0</span></div>
    <div class="row"><span>é ˜åœŸ</span><span id="statTerritory">0</span></div>
    <div class="row"><span>æ–‡æ˜åº¦</span><span id="statCivil">0%</span></div>
    <div class="row"><span>ç¸æ½®</span><span id="statBeast">æœªå•Ÿå‹•</span></div>
    <button class="btn" onclick="expandTerritory()">æ“´å¼µé ˜åœŸ</button>
    <button class="btn" onclick="resetZoom()">é‡ç½®è¦–è§’</button>
    <button class="btn green" onclick="autoMode = !autoMode">è‡ªå‹•æ¨¡å¼ï¼š<span id="autoText">ON</span></button>
    <button class="btn gray" onclick="saveGame()">ä¿å­˜éŠæˆ²</button>
    <div id="sysLog"></div>
  </div>
  <div id="buildTab" class="tabPage">
    <button class="btn" onclick="build('house')">æˆ¿å±‹</button>
    <button class="btn" onclick="build('farm')">è¾²ç”°</button>
    <button class="btn" onclick="build('lumber')">ä¼æœ¨å ´</button>
    <button class="btn" onclick="build('quarry')">çŸ³å ´</button>
    <button class="btn" onclick="build('mine')">ç¤¦å ´</button>
    <button class="btn" onclick="build('factory')">å·¥å» </button>
    <button class="btn" onclick="build('wall')">åŸç‰†</button>
    <button class="btn" onclick="build('robot')">æ©Ÿå™¨äººä¸­å¿ƒ</button>
    <button class="btn green" onclick="upgradeAll()">ä¸€éµå‡ç´šï¼ˆç„¡ä¸Šé™ï¼‰</button>
  </div>
  <div id="marketTab" class="tabPage">
    <div class="row"><span>å•†å“</span><select id="marketItem" onchange="updateMarketHint()">
      <option value="wood">æœ¨æ</option>
      <option value="stone">çŸ³é ­</option>
      <option value="iron">éµç¤¦</option>
      <option value="food">ç³§é£Ÿ</option>
    </select></div>
    <div class="row"><span>æ•¸é‡</span><input type="number" id="marketQty" value="100" min="1"></div>
    <div class="row"><span>å–®åƒ¹</span><span id="marketPrice">0</span></div>
    <button class="btn" onclick="buy()">è²·å…¥</button>
    <button class="btn" onclick="sell()">è³£å‡º</button>
    <div id="marketHint"></div>
  </div>
  <div id="techTab" class="tabPage">
    <button class="btn" onclick="research('tools')">å·¥å…·ç§‘æŠ€</button>
    <button class="btn" onclick="research('agri')">è¾²æ¥­ç§‘æŠ€</button>
    <button class="btn" onclick="research('mining')">æ¡ç¤¦ç§‘æŠ€</button>
    <button class="btn" onclick="research('robotics')">æ©Ÿå™¨äººç§‘æŠ€</button>
    <button class="btn" onclick="research('economy')">ç¶“æ¿Ÿç§‘æŠ€</button>
  </div>
</div>

<!-- ç¸æ½®å‹•ç•« -->
<div class="beastEffect" id="beastEffect"></div>

<script>
// =========================
// æ ¸å¿ƒè®Šé‡ï¼ˆä¿®å¾©æ‰€æœ‰å‘½åéŒ¯èª¤ï¼‰
// =========================
let USER = { id: "", name: "" };
let GAME = null;
const STORAGE_KEY = "AENO_V3_SAVE_";
let autoMode = true;
let aenoMultiplier = 1;
let cameraX = 0, cameraY = 0, zoom = 0.5;
const MAP_W = 80, MAP_H = 80;
const TILE = 64;
const ISO_ANGLE = Math.PI / 6;
const COS = Math.cos(ISO_ANGLE);
const SIN = Math.sin(ISO_ANGLE);

// =========================
// é»˜èªå­˜æª”ï¼ˆåˆå§‹è³‡æºæŒ‰ä½ è¦æ±‚ï¼‰
// =========================
const DEFAULT_SAVE = () => ({
  seed: "AENO-" + Math.floor(Math.random() * 99999999),
  lastTick: Date.now(),
  resources: { gold:2000, aeno:0, wood:800, stone:800, iron:800, food:800 },
  stats: { population:4, territory:9, civil:15, wall:0 },
  buildings: { house:2, farm:1, lumber:1, quarry:0, mine:0, factory:0, wall:0, robot:0 },
  buildingLevels: { house:1, farm:1, lumber:1, quarry:1, mine:1, factory:1, wall:1, robot:1 },
  tech: { tools:0, agri:0, mining:0, robotics:0, economy:0 },
  market: { wood:5, stone:7, iron:15, food:4, lastUpdate:Date.now() },
  world: { beastsKilled:0, lootPending:0 },
  buildQueue: []
});

// =========================
// ç™»å…¥åŠŸèƒ½ï¼ˆä¿®å¾©æ ¸å¿ƒï¼šæ­£å¸¸åˆ‡æ›ç•Œé¢ï¼‰
// =========================
function loginGame(guest = false) {
  const name = guest ? "æ¸¸å®¢" : document.getElementById("userName").value.trim() || "æ¸¸å®¢";
  if(!name && !guest) { alert("è«‹è¼¸å…¥æš±ç¨±ï¼"); return; }
  USER.id = guest ? "guest_" + Date.now() : name + "_" + Date.now();
  USER.name = name;
  document.getElementById("loginScreen").style.display = "none";
  document.getElementById("bootScreen").style.display = "flex";
  initGame();
}

// =========================
// éŠæˆ²åˆå§‹åŒ–ï¼ˆå®Œæ•´ç„¡æˆªæ–·ï¼‰
// =========================
function initGame() {
  GAME = loadGame();
  document.getElementById("userName").textContent = USER.name;
  const canvas = document.getElementById("gameCanvas");
  canvas.width = window.innerWidth * window.devicePixelRatio;
  canvas.height = window.innerHeight * window.devicePixelRatio;
  ctx = canvas.getContext("2d");
  generateMap();
  rebuildBuildings();
  offlineProgress();
  updateUI();
  // å•Ÿå‹•ä¸»å¾ªç’°
  setInterval(gameTick, 1000);
  // éš±è—è¼‰å…¥ç•Œé¢
  setTimeout(() => {
    document.getElementById("bootScreen").style.display = "none";
    log("éŠæˆ²è¼‰å…¥å®Œæˆï¼AIåŠ©æ‰‹å·²å•Ÿå‹•ï¼ˆè‡ªå‹•å»ºé€ +è‡ªå‹•å‡ç´šï¼‰");
  }, 600);
  // ç¹ªåœ–å¾ªç’°
  requestAnimationFrame(draw);
  // AIå°å‹•ç‰©ç¹ªè£½
  initPet();
}

// =========================
// ä¿å­˜/è®€å–ï¼ˆç¶å®šç”¨æˆ¶IDï¼‰
// =========================
function saveGame() {
  GAME.lastTick = Date.now();
  localStorage.setItem(STORAGE_KEY + USER.id, JSON.stringify(GAME));
  log("å·²ä¿å­˜éŠæˆ²");
}
function loadGame() {
  const raw = localStorage.getItem(STORAGE_KEY + USER.id);
  if(!raw) return DEFAULT_SAVE();
  try { const data = JSON.parse(raw); return data; }
  catch { return DEFAULT_SAVE(); }
}

// =========================
// é›¢ç·šè£œç®—
// =========================
function offlineProgress() {
  const sec = Math.floor((Date.now() - GAME.lastTick)/1000);
  if(sec <= 2) return;
  const safeSec = Math.min(sec, 3600*8);
  for(let i=0; i<safeSec; i++) gameTick(1);
  log(`é›¢ç·šè£œç®—ï¼š${safeSec} ç§’`);
}

// =========================
// åœ°åœ–ç”Ÿæˆ
// =========================
let map = [];
function generateMap() {
  map = [];
  const rand = mulberry32(xmur3(GAME.seed)());
  for(let y=0; y<MAP_H; y++) {
    const row = [];
    for(let x=0; x<MAP_W; x++) {
      let t = 0; // 0=è‰åœ°,1=æ£®æ—,2=å±±è„ˆ,3=æ²³æµ
      const r = rand();
      if(r<0.18) t=1;
      else if(r<0.26) t=2;
      else if(r<0.30) t=3;
      row.push(t);
    }
    map.push(row);
  }
  // ä¸­å¿ƒè‰åœ°
  for(let y=35; y<45; y++) for(let x=35; x<45; x++) map[y][x] = 0;
  // 20æ˜Ÿçƒ+5é»‘æ´
  for(let i=0; i<20; i++) {
    const x = Math.floor(Math.random()*(MAP_W-20))+10;
    const y = Math.floor(Math.random()*(MAP_H-20))+10;
    map[y][x] = 4; // æ˜Ÿçƒ
  }
  for(let i=0; i<5; i++) {
    const x = Math.floor(Math.random()*(MAP_W-20))+10;
    const y = Math.floor(Math.random()*(MAP_H-20))+10;
    map[y][x] = 5; // é»‘æ´
  }
}

// =========================
// å»ºç¯‰ç”Ÿæˆ
// =========================
const townCenter = {x:40, y:40};
const placedBuildings = [];
function rebuildBuildings() {
  placedBuildings.length = 0;
  const add = (type, count) => {
    for(let i=0; i<count; i++) {
      placedBuildings.push({
        type,
        x: townCenter.x + (i%5 -2),
        y: townCenter.y + (Math.floor(i/5)-2),
        level: GAME.buildingLevels[type]
      });
    }
  };
  add("house", GAME.buildings.house);
  add("farm", GAME.buildings.farm);
  add("lumber", GAME.buildings.lumber);
  add("quarry", GAME.buildings.quarry);
  add("mine", GAME.buildings.mine);
  add("factory", GAME.buildings.factory);
  add("wall", GAME.buildings.wall);
  add("robot", GAME.buildings.robot);
}

// =========================
// åº§æ¨™è½‰æ›
// =========================
function gridToScreen(gx, gy) {
  const x = (gx - gy) * (TILE * COS) * zoom + cameraX;
  const y = (gx + gy) * (TILE * SIN) * zoom + cameraY;
  return {x, y};
}

// =========================
// éš¨æ©Ÿæ¼”ç®—æ³•ï¼ˆä¿®å¾©ï¼‰
// =========================
function xmur3(str) {
  let h = 1779033703 ^ str.length;
  for(let i=0; i<str.length; i++) h = Math.imul(h ^ str.charCodeAt(i), 3432918353);
  h = (h << 13) | (h >>> 19);
  return () => { h = Math.imul(h ^ (h>>>16), 2246822507); return (h ^= h>>>16) >>>0; };
}
function mulberry32(a) {
  return () => {
    a += 0x6D2B79F5;
    let t = a ^ (a >>> 15);
    t = Math.imul(t, t | 1);
    t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
    return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
  };
}

// =========================
// ç¹ªåœ–æ ¸å¿ƒï¼ˆä¿®å¾©å»ºç¯‰æ”¾å¤§ï¼‰
// =========================
function draw() {
  ctx.clearRect(0,0,ctx.canvas.width, ctx.canvas.height);
  // ç¹ªè£½åœ°åœ–
  for(let y=0; y<MAP_H; y++) {
    for(let x=0; x<MAP_W; x++) {
      drawTile(x, y, map[y][x]);
    }
  }
  // ç¹ªè£½å»ºç¯‰
  placedBuildings.forEach(b => drawBuilding(b));
  // ç¹ªè£½ä¸­å¿ƒæ¨™è¨˜
  const p = gridToScreen(townCenter.x, townCenter.y);
  ctx.fillStyle = "#fff";
  ctx.font = `${20*zoom}px bold`;
  ctx.fillText("ğŸ›ï¸ ä¸­å¤®åŸé®", p.x-50, p.y-30);
  requestAnimationFrame(draw);
}

function drawTile(x, y, type) {
  const p = gridToScreen(x, y);
  const w = TILE * zoom * COS;
  const h = TILE * zoom * SIN;
  // è‰åœ°/æ£®æ—/å±±è„ˆ/æ²³æµ/æ˜Ÿçƒ/é»‘æ´
  const color = ["#dcfce7", "#86efac", "#94a3b8", "#bfdbfe", "#fbbf24", "#000"][type];
  ctx.fillStyle = color;
  ctx.beginPath();
  ctx.moveTo(p.x, p.y);
  ctx.lineTo(p.x+w, p.y+h);
  ctx.lineTo(p.x, p.y+2*h);
  ctx.lineTo(p.x-w, p.y+h);
  ctx.closePath();
  ctx.fill();
  ctx.strokeStyle = "#333";
  ctx.stroke();
  // æ˜Ÿçƒ/é»‘æ´è£é£¾
  if(type===4) ctx.fillText("ğŸŒ", p.x-10, p.y+h);
  if(type===5) ctx.fillText("âš«", p.x-10, p.y+h);
}

function drawBuilding(b) {
  const p = gridToScreen(b.x, b.y);
  const size = 40 * zoom;
  ctx.fillStyle = ["#fde68a","#22c55e","#92400e","#94a3b8","#475569","#60a5fa","#cbd5e1","#0ea5e9"][
    ["house","farm","lumber","quarry","mine","factory","wall","robot"].indexOf(b.type)
  ];
  ctx.fillRect(p.x - size/2, p.y - size/2, size, size);
  ctx.fillStyle = "#fff";
  ctx.font = `${16*zoom}px bold`;
  ctx.fillText(`Lv${b.level}`, p.x-10, p.y+10);
}

// =========================
// AIå°å‹•ç‰©ï¼ˆå·¦å´åŠ©æ‰‹ï¼‰
// =========================
function initPet() {
  const petCtx = document.getElementById("aiPet").getContext("2d");
  petCtx.fillStyle = "#fbbf24";
  petCtx.beginPath();
  petCtx.arc(60,60,40,0,Math.PI*2);
  petCtx.fill();
  petCtx.fillStyle = "#fff";
  petCtx.arc(45,55,8,0,Math.PI*2);
  petCtx.arc(75,55,8,0,Math.PI*2);
  petCtx.fill();
  // é»æ“Šäº‹ä»¶
  document.getElementById("aiPet").onclick = () => {
    aenoMultiplier = 2;
    document.getElementById("petHint").style.display = "block";
    setTimeout(() => aenoMultiplier=1, 120000);
  };
}

// =========================
// éŠæˆ²é‚è¼¯ï¼ˆæ¯ç§’æ›´æ–°ï¼‰
// =========================
function gameTick() {
  // è³‡æºç”¢å‡ºï¼ˆæŒ‰ç­‰ç´šåŠ æˆï¼‰
  const farmBoost = 1 + GAME.tech.agri * 0.08;
  GAME.resources.food += GAME.buildings.farm * 0.12 * farmBoost * GAME.buildingLevels.farm;
  const lumberBoost = 1 + GAME.tech.tools * 0.06;
  GAME.resources.wood += GAME.buildings.lumber * 0.14 * lumberBoost * GAME.buildingLevels.lumber;
  const mineBoost = 1 + GAME.tech.mining * 0.07;
  GAME.resources.stone += GAME.buildings.quarry * 0.10 * mineBoost * GAME.buildingLevels.quarry;
  GAME.resources.iron += GAME.buildings.mine * 0.06 * mineBoost * GAME.buildingLevels.mine;
  const ecoBoost = 1 + GAME.tech.economy * 0.08;
  GAME.resources.gold += (GAME.stats.population * 0.04 + GAME.buildings.factory * 0.18) * ecoBoost * GAME.buildingLevels.factory;
  // AENOæ”¶ç›Šï¼ˆå¤–æ›ç´šAIåŠ æˆï¼‰
  GAME.resources.aeno += (GAME.ad.listeningSeconds * 0.0001 + GAME.world.beastsKilled * 0.0001) * aenoMultiplier;
  // æ–‡æ˜åº¦
  GAME.stats.civil = Math.min(100, GAME.stats.civil + (GAME.buildings.house * 0.0008 + GAME.buildings.factory * 0.0012));
  // äººå£å¢é•·
  if(GAME.resources.food > GAME.stats.population *4 && Math.random()<0.002) {
    GAME.stats.population +=1;
    log("äººå£+1");
  }
  // AIè‡ªå‹•å»ºé€ ï¼ˆå¤–æ›ç´šï¼‰
  if(autoMode) autoBuild();
  // ç¸æ½®ï¼ˆæ–‡æ˜åº¦100%å•Ÿå‹•ï¼‰
  if(GAME.stats.civil >=100 && Math.random()<0.0025) {
    GAME.world.beastsKilled +=1;
    GAME.world.lootPending += Math.floor(30+Math.random()*80);
    log("âš”ï¸ ç¸æ½®ä¾†è¥²ï¼Œæ“Šé€€æˆåŠŸï¼");
    // ç¸æ½®å‹•ç•«
    const p = gridToScreen(Math.floor(Math.random()*MAP_W), Math.floor(Math.random()*MAP_H));
    const effect = document.getElementById("beastEffect");
    effect.style.left = p.x + "px";
    effect.style.top = p.y + "px";
    effect.style.display = "block";
    setTimeout(() => effect.style.display = "none", 1000);
  }
  // æˆ°åˆ©å“æ”¶å–
  if(GAME.world.lootPending >0) {
    const take = Math.min(GAME.world.lootPending,4);
    GAME.world.lootPending -= take;
    GAME.resources.gold += take *0.6;
  }
  updateUI();
}

// =========================
// AIè‡ªå‹•å»ºé€ ï¼ˆå¤–æ›ç´šï¼šå¹³è¡¡å»ºé€ +è‡ªå‹•å‡ç´šï¼‰
// =========================
function autoBuild() {
  // å„ªå…ˆè¾²ç”°â†’ä¼æœ¨å ´â†’æˆ¿å±‹â†’çŸ³å ´â†’ç¤¦å ´â†’å·¥å» â†’åŸç‰†â†’æ©Ÿå™¨äºº
  if(GAME.buildings.farm <1) build("farm");
  else if(GAME.buildings.lumber <1) build("lumber");
  else if(GAME.buildings.house < Math.ceil(GAME.stats.population/2)) build("house");
  else if(GAME.buildings.quarry <1 && GAME.stats.territory>=9) build("quarry");
  else if(GAME.buildings.mine <1 && GAME.buildings.quarry>=1) build("mine");
  else if(GAME.buildings.factory <1 && GAME.buildings.mine>=1) build("factory");
  else if(GAME.buildings.wall <1 && GAME.stats.civil>60) build("wall");
  else if(GAME.buildings.robot <1 && GAME.tech.robotics>=1) build("robot");
  // è‡ªå‹•æ“´åœŸ
  else if(GAME.resources.gold >2000 && Math.random()<0.002) {
    GAME.resources.gold -=250;
    GAME.stats.territory +=2;
    log("ğŸï¸ AIè‡ªå‹•æ“´åœŸ+2");
  }
  // è‡ªå‹•å‡ç´šï¼ˆç„¡ä¸Šé™ï¼‰
  if(Math.random()<0.3) upgradeRandom();
}

// =========================
// å»ºé€ /å‡ç´šåŠŸèƒ½ï¼ˆç„¡ä¸Šé™ï¼‰
// =========================
function build(type) {
  const cost = getCost(type);
  if(!checkCost(cost)) { log("è³‡æºä¸è¶³ï¼Œç„¡æ³•å»ºé€ "); return; }
  subtractCost(cost);
  GAME.buildings[type] +=1;
  rebuildBuildings();
  log(`å»ºé€ æˆåŠŸï¼š${type}`);
}
function upgradeRandom() {
  const types = ["house","farm","lumber","quarry","mine","factory","wall","robot"];
  const t = types[Math.floor(Math.random()*types.length)];
  if(GAME.buildings[t]>0) GAME.buildingLevels[t] +=1;
  rebuildBuildings();
  log(`è‡ªå‹•å‡ç´šï¼š${t} Lv+1`);
}
function upgradeAll() {
  Object.keys(GAME.buildingLevels).forEach(k => GAME.buildingLevels[k] +=1);
  rebuildBuildings();
  log("ä¸€éµå‡ç´šæ‰€æœ‰å»ºç¯‰ï¼ˆç„¡ä¸Šé™ï¼‰");
}
function getCost(type) {
  const base = {
    house: {gold:120, wood:35, stone:10},
    farm: {gold:100, wood:20},
    lumber: {gold:120, wood:10, stone:10},
    quarry: {gold:180, wood:10, stone:20},
    mine: {gold:240, wood:20, stone:30},
    factory: {gold:350, wood:40, stone:50, iron:10},
    wall: {gold:300, wood:10, stone:80},
    robot: {gold:600, wood:50, stone:80, iron:40}
  }[type];
  const lv = GAME.buildings[type] ||0;
  return Object.fromEntries(Object.entries(base).map(([k,v]) => [k, Math.floor(v*(1+lv*0.18))]));
}
function checkCost(cost) {
  for(let k in cost) {
    if(GAME.resources[k] < cost[k]) return false;
  }
  return true;
}
function subtractCost(cost) {
  for(let k in cost) GAME.resources[k] -= cost[k];
}

// =========================
// ç§‘æŠ€ç ”ç©¶
// =========================
function research(tech) {
  const cost = 200 + GAME.tech[tech] *250;
  if(GAME.resources.gold < cost) { log("é‡‘å¹£ä¸è¶³ï¼Œç„¡æ³•ç ”ç©¶"); return; }
  GAME.resources.gold -= cost;
  GAME.tech[tech] +=1;
  log(`ç§‘æŠ€å‡ç´šï¼š${tech} Lv${GAME.tech[tech]}`);
}

// =========================
// äº¤æ˜“æ‰€åŠŸèƒ½ï¼ˆä¿®å¾©æ•¸é‡è¼¸å…¥ï¼‰
// =========================
function updateMarketHint() {
  const m = GAME.market;
  document.getElementById("marketPrice").textContent = m[document.getElementById("marketItem").value];
  document.getElementById("marketHint").textContent = `æœ¨:${m.wood} çŸ³:${m.stone} éµ:${m.iron} é£Ÿ:${m.food}`;
}
function buy() {
  const item = document.getElementById("marketItem").value;
  const qty = Math.max(1, Math.floor(Number(document.getElementById("marketQty").value)||1));
  const price = GAME.market[item] * qty;
  if(GAME.resources.gold < price) { log("é‡‘å¹£ä¸è¶³"); return; }
  GAME.resources.gold -= price;
  GAME.resources[item] += qty;
  log(`è²·å…¥ï¼š${item} x${qty}`);
}
function sell() {
  const item = document.getElementById("marketItem").value;
  const qty = Math.max(1, Math.floor(Number(document.getElementById("marketQty").value)||1));
  if(GAME.resources[item] < qty) { log("è³‡æºä¸è¶³"); return; }
  const price = GAME.market[item] * qty;
  GAME.resources[item] -= qty;
  GAME.resources.gold += price;
  log(`è³£å‡ºï¼š${item} x${qty}`);
}

// =========================
// ç•Œé¢æ›´æ–°
// =========================
function updateUI() {
  document.getElementById("statGold").textContent = Math.floor(GAME.resources.gold);
  document.getElementById("statAeno").textContent = GAME.resources.aeno.toFixed(6);
  document.getElementById("statWood").textContent = Math.floor(GAME.resources.wood);
  document.getElementById("statStone").textContent = Math.floor(GAME.resources.stone);
  document.getElementById("statIron").textContent = Math.floor(GAME.resources.iron);
  document.getElementById("statFood").textContent = Math.floor(GAME.resources.food);
  document.getElementById("statPop").textContent = GAME.stats.population;
  document.getElementById("statTerritory").textContent = GAME.stats.territory;
  document.getElementById("statCivil").textContent = Math.floor(GAME.stats.civil) + "%";
  const beastText = GAME.stats.civil >=100 ? `é€²è¡Œä¸­ï¼ˆæ“Šæ®º${GAME.world.beastsKilled}ï¼‰` : "æœªå•Ÿå‹•";
  document.getElementById("statBeast").textContent = beastText;
  document.getElementById("autoText").textContent = autoMode ? "ON" : "OFF";
}

// =========================
// åœ°åœ–æ“ä½œï¼ˆç¸®æ”¾/æ‹–å‹•ï¼‰
// =========================
let dragMap = false, lastX, lastY;
document.getElementById("gameCanvas").onpointerdown = (e) => {
  dragMap = true;
  lastX = e.clientX;
  lastY = e.clientY;
};
document.getElementById("gameCanvas").onpointermove = (e) => {
  if(!dragMap) return;
  cameraX += (e.clientX - lastX) * window.devicePixelRatio;
  cameraY += (e.clientY - lastY) * window.devicePixelRatio;
  lastX = e.clientX;
  lastY = e.clientY;
};
document.getElementById("gameCanvas").onpointerup = () => dragMap = false;

// ç¸®æ”¾ï¼ˆæ‰‹æ©Ÿé›™æŒ‡ï¼‰
let touchDist = 0;
document.getElementById("gameCanvas").ontouchstart = (e) => {
  if(e.touches.length===2) touchDist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
};
document.getElementById("gameCanvas").ontouchmove = (e) => {
  if(e.touches.length!==2) return;
  const dist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
  zoom += (dist - touchDist) * 0.002;
  zoom = Math.max(0.2, Math.min(1.5, zoom));
  touchDist = dist;
};

function resetZoom() {
  zoom = 0.5;
  cameraX = ctx.canvas.width/2;
  cameraY = ctx.canvas.height/2;
}
function expandTerritory() {
  const cost = 250 + GAME.stats.territory *18;
  if(GAME.resources.gold < cost) { log("é‡‘å¹£ä¸è¶³ï¼Œç„¡æ³•æ“´åœŸ"); return; }
  GAME.resources.gold -= cost;
  GAME.stats.territory +=2;
  log("é ˜åœŸæ“´å¼µ+2");
}

// =========================
// é¢æ¿æ“ä½œ
// =========================
function switchTab(tab) {
  document.querySelectorAll(".tabPage").forEach(p => p.classList.remove("active"));
  document.querySelectorAll(".tabBtn").forEach(b => b.classList.remove("active"));
  document.getElementById(tab+"Tab").classList.add("active");
  event.target.classList.add("active");
}
function panelMin() {
  document.getElementById("mainPanel").style.height = "120px";
}
function log(msg) {
  const time = new Date().toLocaleTimeString();
  document.getElementById("sysLog").innerHTML = `<div>ğŸ•’ ${time} - ${msg}</div>` + document.getElementById("sysLog").innerHTML;
}
</script>
</body>
</html>
